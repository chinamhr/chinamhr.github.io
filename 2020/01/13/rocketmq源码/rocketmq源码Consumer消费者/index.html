<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="demo12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public class PushConsumer &amp;"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="rocketmq源码Consumer消费者"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="demo12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public class PushConsumer &amp;"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>rocketmq源码Consumer消费者 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>rocketmq源码Consumer消费者</h1>
                    
                    <h2 class="post-subheading">
                        消费端启动、负载均衡、消费消息
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2020-01-13
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/rocketmq/">rocketmq</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public class PushConsumer &#123;</span><br><span class="line"> </span><br><span class="line">    /**</span><br><span class="line">     * 当前例子是PushConsumer用法，使用方式给用户感觉是消息从RocketMQ服务器推到了应用客户端。&lt;br&gt;</span><br><span class="line">     * 但是实际PushConsumer内部是使用长轮询Pull方式从Broker拉消息，然后再回调用户Listener方法&lt;br&gt;</span><br><span class="line">     * @throws MQClientException </span><br><span class="line">     */</span><br><span class="line">    public static void main(String[] args) throws InterruptedException, MQClientException &#123;</span><br><span class="line">        /**</span><br><span class="line">         * 一个应用创建一个Consumer，由应用来维护此对象，可以设置为全局对象或者单例&lt;br&gt;</span><br><span class="line">         * 注意：ConsumerGroupName需要由应用来保证唯一</span><br><span class="line">         */</span><br><span class="line">        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(&quot;testmerchantLeagueConsumerGroup&quot;);</span><br><span class="line">        consumer.setNamesrvAddr(&quot;ip:port&quot;);</span><br><span class="line">        </span><br><span class="line">        /**</span><br><span class="line">         * 订阅指定topic下tags分别等于TagA或TagB</span><br><span class="line">         */</span><br><span class="line">        consumer.subscribe(&quot;broker-a&quot;, &quot;TagB || TagA&quot;);</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">        /**</span><br><span class="line">         * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span><br><span class="line">         * 如果非第一次启动，那么按照上次消费的位置继续消费</span><br><span class="line">         */</span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"> </span><br><span class="line">        consumer.registerMessageListener(new MessageListenerConcurrently() &#123;</span><br><span class="line"> </span><br><span class="line">            /**</span><br><span class="line">             * 默认msgs里只有一条消息，可以通过设置consumeMessageBatchMaxSize参数来批量接收消息</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs,</span><br><span class="line">                    ConsumeConcurrentlyContext context) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + &quot; Receive New Messages: &quot; + msgs);</span><br><span class="line">                MessageExt msg = msgs.get(0);</span><br><span class="line">                if (msg.getTopic().equals(&quot;broker-a&quot;)) &#123;</span><br><span class="line">                    // 执行TopicTest1的消费逻辑</span><br><span class="line">                    if (msg.getTags() != null &amp;&amp; msg.getTags().equals(&quot;TagA&quot;)) &#123;</span><br><span class="line">                        // 执行TagA的消费</span><br><span class="line">                        String message = new String(msg.getBody());</span><br><span class="line">                        System.out.println(message);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else if (msg.getTags() != null &amp;&amp; msg.getTags().equals(&quot;TagB&quot;)) &#123;</span><br><span class="line">                        // 执行TagB的消费</span><br><span class="line">                        String message = new String(msg.getBody());</span><br><span class="line">                        System.out.println(message);</span><br><span class="line">                    &#125;</span><br><span class="line">                  </span><br><span class="line">                &#125;</span><br><span class="line">                //消费者向mq服务器返回消费成功的消息</span><br><span class="line">                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        /**</span><br><span class="line">         * Consumer对象在使用之前必须要调用start初始化，初始化一次即可&lt;br&gt;</span><br><span class="line">         */</span><br><span class="line">        consumer.start();</span><br><span class="line"> </span><br><span class="line">        System.out.println(&quot;Consumer Started.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一、Consumer启动过程"><a href="#一、Consumer启动过程" class="headerlink" title="一、Consumer启动过程"></a>一、Consumer启动过程</h3><h4 id="1、实例化DefaultMQPushConsumer"><a href="#1、实例化DefaultMQPushConsumer" class="headerlink" title="1、实例化DefaultMQPushConsumer"></a>1、实例化DefaultMQPushConsumer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public DefaultMQPushConsumer(final String consumerGroup) &#123;</span><br><span class="line">    this(consumerGroup, null, new AllocateMessageQueueAveragely());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public DefaultMQPushConsumer(final String consumerGroup, RPCHook rpcHook, AllocateMessageQueueStrategy allocateMessageQueueStrategy) &#123;</span><br><span class="line">    this.consumerGroup = consumerGroup;</span><br><span class="line">    this.allocateMessageQueueStrategy = allocateMessageQueueStrategy;</span><br><span class="line">    defaultMQPushConsumerImpl = new DefaultMQPushConsumerImpl(this, rpcHook);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DefaultMQPushConsumer的subscribe方法"><a href="#2、DefaultMQPushConsumer的subscribe方法" class="headerlink" title="2、DefaultMQPushConsumer的subscribe方法"></a>2、DefaultMQPushConsumer的subscribe方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void subscribe(String topic, String subExpression) throws MQClientException &#123;</span><br><span class="line">    this.defaultMQPushConsumerImpl.subscribe(topic, subExpression);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultMQPushConsumerImpl的subscribe方法"><a href="#3、DefaultMQPushConsumerImpl的subscribe方法" class="headerlink" title="3、DefaultMQPushConsumerImpl的subscribe方法"></a>3、DefaultMQPushConsumerImpl的subscribe方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void subscribe(String topic, String subExpression) throws MQClientException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //创建订阅数据</span><br><span class="line">        SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(this.defaultMQPushConsumer.getConsumerGroup(),</span><br><span class="line">            topic, subExpression);</span><br><span class="line">        //设置订阅数据</span><br><span class="line">        this.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</span><br><span class="line">        //通过心跳同步Consumer信息到Broker</span><br><span class="line">        if (this.mQClientFactory != null) &#123;</span><br><span class="line">            this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new MQClientException(&quot;subscription exception&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DefaultMQPushConsumer的registerMessageListener方法"><a href="#4、DefaultMQPushConsumer的registerMessageListener方法" class="headerlink" title="4、DefaultMQPushConsumer的registerMessageListener方法"></a>4、DefaultMQPushConsumer的registerMessageListener方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerMessageListener(MessageListenerConcurrently messageListener) &#123;</span><br><span class="line">    this.messageListener = messageListener;</span><br><span class="line">    this.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、DefaultMQPushConsumerImpl的registerMessageListener方法"><a href="#5、DefaultMQPushConsumerImpl的registerMessageListener方法" class="headerlink" title="5、DefaultMQPushConsumerImpl的registerMessageListener方法"></a>5、DefaultMQPushConsumerImpl的registerMessageListener方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerMessageListener(MessageListenerConcurrently messageListener) &#123;</span><br><span class="line">    this.messageListener = messageListener;</span><br><span class="line">    this.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、DefaultMQPushConsumer的start方法"><a href="#6、DefaultMQPushConsumer的start方法" class="headerlink" title="6、DefaultMQPushConsumer的start方法"></a>6、DefaultMQPushConsumer的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void start() throws MQClientException &#123;</span><br><span class="line">    this.defaultMQPushConsumerImpl.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、DefaultMQPushConsumerImpl的start方法"><a href="#7、DefaultMQPushConsumerImpl的start方法" class="headerlink" title="7、DefaultMQPushConsumerImpl的start方法"></a>7、DefaultMQPushConsumerImpl的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">public synchronized void start() throws MQClientException &#123;</span><br><span class="line">    switch (this.serviceState) &#123;</span><br><span class="line">        case CREATE_JUST:</span><br><span class="line">            log.info(&quot;the consumer [&#123;&#125;] start beginning. messageModel=&#123;&#125;, isUnitMode=&#123;&#125;&quot;, this.defaultMQPushConsumer.getConsumerGroup(),</span><br><span class="line">                this.defaultMQPushConsumer.getMessageModel(), this.defaultMQPushConsumer.isUnitMode());</span><br><span class="line">            //切换Consumer状态</span><br><span class="line">            this.serviceState = ServiceState.START_FAILED;</span><br><span class="line">            //检查消费者组名是否正确配置</span><br><span class="line">            this.checkConfig();</span><br><span class="line">            //处理订阅信息subscriptionData</span><br><span class="line">            this.copySubscription();</span><br><span class="line">            //jvm进程id作为Consumer的intancename名</span><br><span class="line">            if (this.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) &#123;</span><br><span class="line">                this.defaultMQPushConsumer.changeInstanceNameToPID();</span><br><span class="line">            &#125;</span><br><span class="line">            //初始化mQClientFactory为MQClientInstance，并将该实例加入factoryTable</span><br><span class="line">            this.mQClientFactory = MQClientManager.getInstance().getAndCreateMQClientInstance(this.defaultMQPushConsumer, this.rpcHook);</span><br><span class="line">            //负载均衡相关</span><br><span class="line">            this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">            this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());</span><br><span class="line">            this.rebalanceImpl.setAllocateMessageQueueStrategy(this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());</span><br><span class="line">            this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);</span><br><span class="line"></span><br><span class="line">            this.pullAPIWrapper = new PullAPIWrapper(</span><br><span class="line">                mQClientFactory,</span><br><span class="line">                this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());</span><br><span class="line">            this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);</span><br><span class="line">            //加载存储的消费进度</span><br><span class="line">            if (this.defaultMQPushConsumer.getOffsetStore() != null) &#123;</span><br><span class="line">                this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch (this.defaultMQPushConsumer.getMessageModel()) &#123;</span><br><span class="line">                    case BROADCASTING:</span><br><span class="line">                        //广播模式</span><br><span class="line">                        this.offsetStore = new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">                        break;</span><br><span class="line">                    case CLUSTERING:</span><br><span class="line">                        //集群模式</span><br><span class="line">                        this.offsetStore = new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">                this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);</span><br><span class="line">            &#125;</span><br><span class="line">            this.offsetStore.load();</span><br><span class="line">            //创建并启动消息消费器</span><br><span class="line">            if (this.getMessageListenerInner() instanceof MessageListenerOrderly) &#123;</span><br><span class="line">                this.consumeOrderly = true;</span><br><span class="line">                this.consumeMessageService = new ConsumeMessageOrderlyService(this, (MessageListenerOrderly) this.getMessageListenerInner());</span><br><span class="line">            &#125; else if (this.getMessageListenerInner() instanceof MessageListenerConcurrently) &#123;</span><br><span class="line">                this.consumeOrderly = false;</span><br><span class="line">                this.consumeMessageService = new ConsumeMessageConcurrentlyService(this, (MessageListenerConcurrently) this.getMessageListenerInner());</span><br><span class="line">            &#125;</span><br><span class="line">            this.consumeMessageService.start();</span><br><span class="line">            //消费者加入到MQClientInstance.consumerTable</span><br><span class="line">            boolean registerOK = mQClientFactory.registerConsumer(this.defaultMQPushConsumer.getConsumerGroup(), this);</span><br><span class="line">            if (!registerOK) &#123;</span><br><span class="line">                this.serviceState = ServiceState.CREATE_JUST;</span><br><span class="line">                this.consumeMessageService.shutdown();</span><br><span class="line">                throw new MQClientException(&quot;The consumer group[&quot; + this.defaultMQPushConsumer.getConsumerGroup()</span><br><span class="line">                    + &quot;] has been created before, specify another name please.&quot; + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br><span class="line">                    null);</span><br><span class="line">            &#125;</span><br><span class="line">            //启动消费者</span><br><span class="line">            mQClientFactory.start();</span><br><span class="line">            log.info(&quot;the consumer [&#123;&#125;] start OK.&quot;, this.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">            this.serviceState = ServiceState.RUNNING;</span><br><span class="line">            break;</span><br><span class="line">        case RUNNING:</span><br><span class="line">        case START_FAILED:</span><br><span class="line">        case SHUTDOWN_ALREADY:</span><br><span class="line">            throw new MQClientException(&quot;The PushConsumer service state not OK, maybe started once, &quot;</span><br><span class="line">                + this.serviceState</span><br><span class="line">                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),</span><br><span class="line">                null);</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    //更新订阅</span><br><span class="line">    this.updateTopicSubscribeInfoWhenSubscriptionChanged();</span><br><span class="line">    //检测broker状态</span><br><span class="line">    this.mQClientFactory.checkClientInBroker();</span><br><span class="line">    //发送心跳</span><br><span class="line">    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">    //重新负载</span><br><span class="line">    this.mQClientFactory.rebalanceImmediately();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、MQClientInstance的start方法"><a href="#8、MQClientInstance的start方法" class="headerlink" title="8、MQClientInstance的start方法"></a>8、MQClientInstance的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws MQClientException &#123;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        switch (this.serviceState) &#123;</span><br><span class="line">            case CREATE_JUST:</span><br><span class="line">                this.serviceState = ServiceState.START_FAILED;</span><br><span class="line">                // If not specified,looking address from name server</span><br><span class="line">                //获取注册中心地址</span><br><span class="line">                if (null == this.clientConfig.getNamesrvAddr()) &#123;</span><br><span class="line">                    this.mQClientAPIImpl.fetchNameServerAddr();</span><br><span class="line">                &#125;</span><br><span class="line">                // Start request-response channel</span><br><span class="line">                //启动client与注册中心的通讯,ClientRemotingProcessor处理请求</span><br><span class="line">                this.mQClientAPIImpl.start();</span><br><span class="line">                // Start various schedule tasks</span><br><span class="line">                //启动调度服务</span><br><span class="line">                this.startScheduledTask();</span><br><span class="line">                // Start pull service</span><br><span class="line">                //启动拉服务</span><br><span class="line">                this.pullMessageService.start();</span><br><span class="line">                // Start rebalance service</span><br><span class="line">                //启动负载均衡</span><br><span class="line">                this.rebalanceService.start();</span><br><span class="line">                // Start push service</span><br><span class="line">                //启动推服务</span><br><span class="line">                this.defaultMQProducer.getDefaultMQProducerImpl().start(false);</span><br><span class="line">                log.info(&quot;the client factory [&#123;&#125;] start OK&quot;, this.clientId);</span><br><span class="line">                this.serviceState = ServiceState.RUNNING;</span><br><span class="line">                break;</span><br><span class="line">            case RUNNING:</span><br><span class="line">                break;</span><br><span class="line">            case SHUTDOWN_ALREADY:</span><br><span class="line">                break;</span><br><span class="line">            case START_FAILED:</span><br><span class="line">                throw new MQClientException(&quot;The Factory object[&quot; + this.getClientId() + &quot;] has been created before, and failed.&quot;, null);</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、负载均衡"><a href="#二、负载均衡" class="headerlink" title="二、负载均衡"></a>二、负载均衡</h3><h4 id="1、RebalanceService的run方法"><a href="#1、RebalanceService的run方法" class="headerlink" title="1、RebalanceService的run方法"></a>1、RebalanceService的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">    while (!this.isStopped()) &#123;</span><br><span class="line">        //间隔20秒重新负载均衡</span><br><span class="line">        this.waitForRunning(waitInterval);</span><br><span class="line">        //负载均衡</span><br><span class="line">        this.mqClientFactory.doRebalance();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、MQClientInstance的doRebalance方法"><a href="#2、MQClientInstance的doRebalance方法" class="headerlink" title="2、MQClientInstance的doRebalance方法"></a>2、MQClientInstance的doRebalance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void doRebalance() &#123;</span><br><span class="line">    for (Map.Entry&lt;String, MQConsumerInner&gt; entry : this.consumerTable.entrySet()) &#123;</span><br><span class="line">        MQConsumerInner impl = entry.getValue();</span><br><span class="line">        if (impl != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //负载均衡</span><br><span class="line">                impl.doRebalance();</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                log.error(&quot;doRebalance exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultMQPushConsumerImpl的doRebalance方法"><a href="#3、DefaultMQPushConsumerImpl的doRebalance方法" class="headerlink" title="3、DefaultMQPushConsumerImpl的doRebalance方法"></a>3、DefaultMQPushConsumerImpl的doRebalance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void doRebalance() &#123;</span><br><span class="line">    if (!this.pause) &#123;</span><br><span class="line">        //负载均衡</span><br><span class="line">        this.rebalanceImpl.doRebalance(this.isConsumeOrderly());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、RebalanceImpl的doRebalance方法"><a href="#4、RebalanceImpl的doRebalance方法" class="headerlink" title="4、RebalanceImpl的doRebalance方法"></a>4、RebalanceImpl的doRebalance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public void doRebalance(final boolean isOrder) &#123;</span><br><span class="line">    //copySubscription中初始化了SubscriptionInner</span><br><span class="line">    Map&lt;String, SubscriptionData&gt; subTable = this.getSubscriptionInner();</span><br><span class="line">    if (subTable != null) &#123;</span><br><span class="line">        for (final Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</span><br><span class="line">            final String topic = entry.getKey();</span><br><span class="line">            try &#123;</span><br><span class="line">                //根据topic进行负载均衡</span><br><span class="line">                this.rebalanceByTopic(topic, isOrder);</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                    log.warn(&quot;rebalanceByTopic Exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //移除未订阅的topic对应的消息队列</span><br><span class="line">    this.truncateMessageQueueNotMyTopic();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、RebalanceImpl的rebalanceByTopic方法"><a href="#5、RebalanceImpl的rebalanceByTopic方法" class="headerlink" title="5、RebalanceImpl的rebalanceByTopic方法"></a>5、RebalanceImpl的rebalanceByTopic方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">private void rebalanceByTopic(final String topic, final boolean isOrder) &#123;</span><br><span class="line">    switch (messageModel) &#123;</span><br><span class="line">        case BROADCASTING: &#123;</span><br><span class="line">            //广播模式</span><br><span class="line">            Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic);</span><br><span class="line">            if (mqSet != null) &#123;</span><br><span class="line">                boolean changed = this.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</span><br><span class="line">                if (changed) &#123;</span><br><span class="line">                    this.messageQueueChanged(topic, mqSet, mqSet);</span><br><span class="line">                    log.info(&quot;messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&quot;,</span><br><span class="line">                        consumerGroup,</span><br><span class="line">                        topic,</span><br><span class="line">                        mqSet,</span><br><span class="line">                        mqSet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.warn(&quot;doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist.&quot;, consumerGroup, topic);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case CLUSTERING: &#123;</span><br><span class="line">            //集群模式</span><br><span class="line">            //从topicSubscribeInfoTable列表中获取与该topic相关的所有消息队列</span><br><span class="line">            Set&lt;MessageQueue&gt; mqSet = this.topicSubscribeInfoTable.get(topic);</span><br><span class="line">            //从broker端获取消费该消费组的所有客户端clientId</span><br><span class="line">            List&lt;String&gt; cidAll = this.mQClientFactory.findConsumerIdList(topic, consumerGroup);</span><br><span class="line">            if (null == mqSet) &#123;</span><br><span class="line">                if (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                    log.warn(&quot;doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist.&quot;, consumerGroup, topic);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (null == cidAll) &#123;</span><br><span class="line">                log.warn(&quot;doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed&quot;, consumerGroup, topic);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mqSet != null &amp;&amp; cidAll != null) &#123;</span><br><span class="line">                List&lt;MessageQueue&gt; mqAll = new ArrayList&lt;MessageQueue&gt;();</span><br><span class="line">                mqAll.addAll(mqSet);</span><br><span class="line"></span><br><span class="line">                Collections.sort(mqAll);</span><br><span class="line">                Collections.sort(cidAll);</span><br><span class="line">                //创建DefaultMQPushConsumer对象时默认设置为AllocateMessageQueueAveragely</span><br><span class="line">                AllocateMessageQueueStrategy strategy = this.allocateMessageQueueStrategy;</span><br><span class="line"></span><br><span class="line">                List&lt;MessageQueue&gt; allocateResult = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //为当前client分配消费队列</span><br><span class="line">                    allocateResult = strategy.allocate(</span><br><span class="line">                        this.consumerGroup,</span><br><span class="line">                        this.mQClientFactory.getClientId(),</span><br><span class="line">                        mqAll,</span><br><span class="line">                        cidAll);</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;&quot;, strategy.getName(),</span><br><span class="line">                        e);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                //将分配得到的allocateResult中的队列放入allocateResultSet 集合</span><br><span class="line">                Set&lt;MessageQueue&gt; allocateResultSet = new HashSet&lt;MessageQueue&gt;();</span><br><span class="line">                if (allocateResult != null) &#123;</span><br><span class="line">                    allocateResultSet.addAll(allocateResult);</span><br><span class="line">                &#125;</span><br><span class="line">                //更新updateProcessQueue</span><br><span class="line">                boolean changed = this.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</span><br><span class="line">                if (changed) &#123;</span><br><span class="line">                    log.info(</span><br><span class="line">                        &quot;rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;&quot;,</span><br><span class="line">                        strategy.getName(), consumerGroup, topic, this.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</span><br><span class="line">                        allocateResultSet.size(), allocateResultSet);</span><br><span class="line">                    this.messageQueueChanged(topic, mqSet, allocateResultSet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、RebalanceImpl的updateProcessQueueTableInRebalance方法"><a href="#6、RebalanceImpl的updateProcessQueueTableInRebalance方法" class="headerlink" title="6、RebalanceImpl的updateProcessQueueTableInRebalance方法"></a>6、RebalanceImpl的updateProcessQueueTableInRebalance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">private boolean updateProcessQueueTableInRebalance(final String topic, final Set&lt;MessageQueue&gt; mqSet,</span><br><span class="line">    final boolean isOrder) &#123;</span><br><span class="line">    boolean changed = false;</span><br><span class="line"></span><br><span class="line">    //去掉topic对应的无用MessageQueue（不包含在mqSet或者pullExpired）</span><br><span class="line">    Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = this.processQueueTable.entrySet().iterator();</span><br><span class="line">    while (it.hasNext()) &#123;</span><br><span class="line">        Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</span><br><span class="line">        MessageQueue mq = next.getKey();</span><br><span class="line">        ProcessQueue pq = next.getValue();</span><br><span class="line"></span><br><span class="line">        if (mq.getTopic().equals(topic)) &#123;</span><br><span class="line">            if (!mqSet.contains(mq)) &#123;</span><br><span class="line">                pq.setDropped(true);</span><br><span class="line">                if (this.removeUnnecessaryMessageQueue(mq, pq)) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                    changed = true;</span><br><span class="line">                    log.info(&quot;doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;&quot;, consumerGroup, mq);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (pq.isPullExpired()) &#123;</span><br><span class="line">                switch (this.consumeType()) &#123;</span><br><span class="line">                    case CONSUME_ACTIVELY:</span><br><span class="line">                        break;</span><br><span class="line">                    case CONSUME_PASSIVELY:</span><br><span class="line">                        pq.setDropped(true);</span><br><span class="line">                        if (this.removeUnnecessaryMessageQueue(mq, pq)) &#123;</span><br><span class="line">                            it.remove();</span><br><span class="line">                            changed = true;</span><br><span class="line">                            log.error(&quot;[BUG]doRebalance, &#123;&#125;, remove unnecessary mq, &#123;&#125;, because pull is pause, so try to fixed it&quot;,</span><br><span class="line">                                consumerGroup, mq);</span><br><span class="line">                        &#125;</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //为新队列创建pullRequest</span><br><span class="line">    List&lt;PullRequest&gt; pullRequestList = new ArrayList&lt;PullRequest&gt;();</span><br><span class="line">    for (MessageQueue mq : mqSet) &#123;</span><br><span class="line">        if (!this.processQueueTable.containsKey(mq)) &#123;</span><br><span class="line">            if (isOrder &amp;&amp; !this.lock(mq)) &#123;</span><br><span class="line">                log.warn(&quot;doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed&quot;, consumerGroup, mq);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            //去除脏数据</span><br><span class="line">            this.removeDirtyOffset(mq);</span><br><span class="line">            ProcessQueue pq = new ProcessQueue();</span><br><span class="line">            long nextOffset = this.computePullFromWhere(mq);</span><br><span class="line">            if (nextOffset &gt;= 0) &#123;</span><br><span class="line">                ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);</span><br><span class="line">                if (pre != null) &#123;</span><br><span class="line">                    log.info(&quot;doRebalance, &#123;&#125;, mq already exists, &#123;&#125;&quot;, consumerGroup, mq);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    log.info(&quot;doRebalance, &#123;&#125;, add a new mq, &#123;&#125;&quot;, consumerGroup, mq);</span><br><span class="line">                    //创建pull请求</span><br><span class="line">                    PullRequest pullRequest = new PullRequest();</span><br><span class="line">                    pullRequest.setConsumerGroup(consumerGroup);</span><br><span class="line">                    pullRequest.setNextOffset(nextOffset);</span><br><span class="line">                    pullRequest.setMessageQueue(mq);</span><br><span class="line">                    pullRequest.setProcessQueue(pq);</span><br><span class="line">                    pullRequestList.add(pullRequest);</span><br><span class="line">                    changed = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.warn(&quot;doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;&quot;, consumerGroup, mq);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //pullRequest请求加入PullMessageService.pullRequestQueue队列</span><br><span class="line">    this.dispatchPullRequest(pullRequestList);</span><br><span class="line"></span><br><span class="line">    return changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、消费消息"><a href="#三、消费消息" class="headerlink" title="三、消费消息"></a>三、消费消息</h3><h4 id="1、PullMessageService的run方法"><a href="#1、PullMessageService的run方法" class="headerlink" title="1、PullMessageService的run方法"></a>1、PullMessageService的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">    while (!this.isStopped()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            PullRequest pullRequest = this.pullRequestQueue.take();</span><br><span class="line">            if (pullRequest != null) &#123;</span><br><span class="line">                //获取消息</span><br><span class="line">                this.pullMessage(pullRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;Pull Message Service Run Method exception&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、PullMessageService的pullMessage方法"><a href="#2、PullMessageService的pullMessage方法" class="headerlink" title="2、PullMessageService的pullMessage方法"></a>2、PullMessageService的pullMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void pullMessage(final PullRequest pullRequest) &#123;</span><br><span class="line">    //获取该组消费者</span><br><span class="line">    final MQConsumerInner consumer = this.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</span><br><span class="line">    if (consumer != null) &#123;</span><br><span class="line">        DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</span><br><span class="line">        //获取消息</span><br><span class="line">        impl.pullMessage(pullRequest);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        log.warn(&quot;No matched consumer for the PullRequest &#123;&#125;, drop it&quot;, pullRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultMQPushConsumerImpl的pullMessage方法"><a href="#3、DefaultMQPushConsumerImpl的pullMessage方法" class="headerlink" title="3、DefaultMQPushConsumerImpl的pullMessage方法"></a>3、DefaultMQPushConsumerImpl的pullMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line">public void pullMessage(final PullRequest pullRequest) &#123;</span><br><span class="line">    //获取处理队列</span><br><span class="line">    final ProcessQueue processQueue = pullRequest.getProcessQueue();</span><br><span class="line">    if (processQueue.isDropped()) &#123;</span><br><span class="line">        log.info(&quot;the pull request[&#123;&#125;] is dropped.&quot;, pullRequest.toString());</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置队列最后拉取消息时间</span><br><span class="line">    pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</span><br><span class="line">    //判断consumer状态是否运行中。如果不是，则延迟拉取消息</span><br><span class="line">    try &#123;</span><br><span class="line">        this.makeSureStateOK();</span><br><span class="line">    &#125; catch (MQClientException e) &#123;</span><br><span class="line">        log.warn(&quot;pullMessage exception, consumer state not ok&quot;, e);</span><br><span class="line">        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //判断是否暂停中</span><br><span class="line">    if (this.isPause()) &#123;</span><br><span class="line">        log.warn(&quot;consumer was paused, execute pull request later. instanceName=&#123;&#125;, group=&#123;&#125;&quot;, this.defaultMQPushConsumer.getInstanceName(), this.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long cachedMessageCount = processQueue.getMsgCount().get();</span><br><span class="line">    long cachedMessageSizeInMiB = processQueue.getMsgSize().get() / (1024 * 1024);</span><br><span class="line">    //默认最大持有消息数量为1000</span><br><span class="line">    if (cachedMessageCount &gt; this.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</span><br><span class="line">        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);</span><br><span class="line">        if ((queueFlowControlTimes++ % 1000) == 0) &#123;</span><br><span class="line">            log.warn(</span><br><span class="line">                &quot;the cached message count exceeds the threshold &#123;&#125;, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, count=&#123;&#125;, size=&#123;&#125; MiB, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;&quot;,</span><br><span class="line">                this.defaultMQPushConsumer.getPullThresholdForQueue(), processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), cachedMessageCount, cachedMessageSizeInMiB, pullRequest, queueFlowControlTimes);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //默认最大持有消息大小为100m</span><br><span class="line">    if (cachedMessageSizeInMiB &gt; this.defaultMQPushConsumer.getPullThresholdSizeForQueue()) &#123;</span><br><span class="line">        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);</span><br><span class="line">        if ((queueFlowControlTimes++ % 1000) == 0) &#123;</span><br><span class="line">            log.warn(</span><br><span class="line">                &quot;the cached message size exceeds the threshold &#123;&#125; MiB, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, count=&#123;&#125;, size=&#123;&#125; MiB, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;&quot;,</span><br><span class="line">                this.defaultMQPushConsumer.getPullThresholdSizeForQueue(), processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), cachedMessageCount, cachedMessageSizeInMiB, pullRequest, queueFlowControlTimes);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.consumeOrderly) &#123;</span><br><span class="line">        //判断消息跨度是否过大，默认2000</span><br><span class="line">        if (processQueue.getMaxSpan() &gt; this.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</span><br><span class="line">            this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);</span><br><span class="line">            if ((queueMaxSpanFlowControlTimes++ % 1000) == 0) &#123;</span><br><span class="line">                log.warn(</span><br><span class="line">                    &quot;the queue&apos;s messages, span too long, so do flow control, minOffset=&#123;&#125;, maxOffset=&#123;&#125;, maxSpan=&#123;&#125;, pullRequest=&#123;&#125;, flowControlTimes=&#123;&#125;&quot;,</span><br><span class="line">                    processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</span><br><span class="line">                    pullRequest, queueMaxSpanFlowControlTimes);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //顺序消费,锁住队列</span><br><span class="line">        if (processQueue.isLocked()) &#123;</span><br><span class="line">            if (!pullRequest.isLockedFirst()) &#123;</span><br><span class="line">                final long offset = this.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</span><br><span class="line">                boolean brokerBusy = offset &lt; pullRequest.getNextOffset();</span><br><span class="line">                log.info(&quot;the first time to pull message, so fix offset from broker. pullRequest: &#123;&#125; NewOffset: &#123;&#125; brokerBusy: &#123;&#125;&quot;,</span><br><span class="line">                    pullRequest, offset, brokerBusy);</span><br><span class="line">                if (brokerBusy) &#123;</span><br><span class="line">                    log.info(&quot;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: &#123;&#125; NewOffset: &#123;&#125;&quot;,</span><br><span class="line">                        pullRequest, offset);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                pullRequest.setLockedFirst(true);</span><br><span class="line">                pullRequest.setNextOffset(offset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">            log.info(&quot;pull message later because not locked in broker, &#123;&#125;&quot;, pullRequest);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取Topic对应的订阅信息。若不存在，则延迟拉取消息</span><br><span class="line">    final SubscriptionData subscriptionData = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</span><br><span class="line">    if (null == subscriptionData) &#123;</span><br><span class="line">        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">        log.warn(&quot;find the consumer&apos;s subscription failed, &#123;&#125;&quot;, pullRequest);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final long beginTimestamp = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    PullCallback pullCallback = new PullCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onSuccess(PullResult pullResult) &#123;</span><br><span class="line">            if (pullResult != null) &#123;</span><br><span class="line">                //处理拉取结果</span><br><span class="line">                pullResult = DefaultMQPushConsumerImpl.this.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</span><br><span class="line">                    subscriptionData);</span><br><span class="line"></span><br><span class="line">                switch (pullResult.getPullStatus()) &#123;</span><br><span class="line">                    case FOUND:</span><br><span class="line">                        //设置下次拉取消息队列位置</span><br><span class="line">                        long prevRequestOffset = pullRequest.getNextOffset();</span><br><span class="line">                        pullRequest.setNextOffset(pullResult.getNextBeginOffset());</span><br><span class="line">                        //统计拉取消息时间</span><br><span class="line">                        long pullRT = System.currentTimeMillis() - beginTimestamp;</span><br><span class="line">                        DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</span><br><span class="line">                            pullRequest.getMessageQueue().getTopic(), pullRT);</span><br><span class="line"></span><br><span class="line">                        long firstMsgOffset = Long.MAX_VALUE;</span><br><span class="line">                        if (pullResult.getMsgFoundList() == null || pullResult.getMsgFoundList().isEmpty()) &#123;</span><br><span class="line">                            DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            firstMsgOffset = pullResult.getMsgFoundList().get(0).getQueueOffset();</span><br><span class="line">                            //统计</span><br><span class="line">                            DefaultMQPushConsumerImpl.this.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</span><br><span class="line">                                pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</span><br><span class="line">                            //提交拉取到的消息到消息处理队列</span><br><span class="line">                            boolean dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</span><br><span class="line">                            //提交消费请求</span><br><span class="line">                            DefaultMQPushConsumerImpl.this.consumeMessageService.submitConsumeRequest(</span><br><span class="line">                                pullResult.getMsgFoundList(),</span><br><span class="line">                                processQueue,</span><br><span class="line">                                pullRequest.getMessageQueue(),</span><br><span class="line">                                dispathToConsume);</span><br><span class="line">                            //提交下次拉取消息请求</span><br><span class="line">                            if (DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval() &gt; 0) &#123;</span><br><span class="line">                                DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest,</span><br><span class="line">                                    DefaultMQPushConsumerImpl.this.defaultMQPushConsumer.getPullInterval());</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //下次拉取消息队列位置小于上次拉取消息队列位置或第一条消息的消息队列位置小于上次拉取消息队列位置，则判定为BUG，输出log</span><br><span class="line">                        if (pullResult.getNextBeginOffset() &lt; prevRequestOffset</span><br><span class="line">                            || firstMsgOffset &lt; prevRequestOffset) &#123;</span><br><span class="line">                            log.warn(</span><br><span class="line">                                &quot;[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;&quot;,</span><br><span class="line">                                pullResult.getNextBeginOffset(),</span><br><span class="line">                                firstMsgOffset,</span><br><span class="line">                                prevRequestOffset);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        break;</span><br><span class="line">                    case NO_NEW_MSG:</span><br><span class="line">                        //设置下次拉取消息队列位置</span><br><span class="line">                        pullRequest.setNextOffset(pullResult.getNextBeginOffset());</span><br><span class="line">                        //持久化消费进度</span><br><span class="line">                        DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);</span><br><span class="line">                        //立即提交拉取消息请求</span><br><span class="line">                        DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);</span><br><span class="line">                        break;</span><br><span class="line">                    case NO_MATCHED_MSG:</span><br><span class="line">                        //设置下次拉取消息队列位置</span><br><span class="line">                        pullRequest.setNextOffset(pullResult.getNextBeginOffset());</span><br><span class="line">                        //持久化消费进度</span><br><span class="line">                        DefaultMQPushConsumerImpl.this.correctTagsOffset(pullRequest);</span><br><span class="line">                        //提交立即拉取消息请求</span><br><span class="line">                        DefaultMQPushConsumerImpl.this.executePullRequestImmediately(pullRequest);</span><br><span class="line">                        break;</span><br><span class="line">                    case OFFSET_ILLEGAL:</span><br><span class="line">                        log.warn(&quot;the pull request offset illegal, &#123;&#125; &#123;&#125;&quot;,</span><br><span class="line">                            pullRequest.toString(), pullResult.toString());</span><br><span class="line">                        //设置下次拉取消息队列位置</span><br><span class="line">                        pullRequest.setNextOffset(pullResult.getNextBeginOffset());</span><br><span class="line">                        //设置消息处理队列为dropped</span><br><span class="line">                        pullRequest.getProcessQueue().setDropped(true);</span><br><span class="line">                        //提交延迟任务，进行消费处理队列移除。不立即移除的原因：可能有地方正在使用，避免受到影响。</span><br><span class="line">                        DefaultMQPushConsumerImpl.this.executeTaskLater(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                            @Override</span><br><span class="line">                            public void run() &#123;</span><br><span class="line">                                try &#123;</span><br><span class="line">                                    //更新消费进度，同步消费进度到Broker</span><br><span class="line">                                    DefaultMQPushConsumerImpl.this.offsetStore.updateOffset(pullRequest.getMessageQueue(),</span><br><span class="line">                                        pullRequest.getNextOffset(), false);</span><br><span class="line"></span><br><span class="line">                                    DefaultMQPushConsumerImpl.this.offsetStore.persist(pullRequest.getMessageQueue());</span><br><span class="line">                                    //移除消费处理队列</span><br><span class="line">                                    DefaultMQPushConsumerImpl.this.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</span><br><span class="line"></span><br><span class="line">                                    log.warn(&quot;fix the pull request offset, &#123;&#125;&quot;, pullRequest);</span><br><span class="line">                                &#125; catch (Throwable e) &#123;</span><br><span class="line">                                    log.error(&quot;executeTaskLater Exception&quot;, e);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, 10000);</span><br><span class="line">                        break;</span><br><span class="line">                    default:</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onException(Throwable e) &#123;</span><br><span class="line">            if (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                log.warn(&quot;execute the pull request exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">            //提交延迟拉取消息请求</span><br><span class="line">            DefaultMQPushConsumerImpl.this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    //集群消息模型下，计算提交的消费进度</span><br><span class="line">    boolean commitOffsetEnable = false;</span><br><span class="line">    long commitOffsetValue = 0L;</span><br><span class="line">    if (MessageModel.CLUSTERING == this.defaultMQPushConsumer.getMessageModel()) &#123;</span><br><span class="line">        commitOffsetValue = this.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</span><br><span class="line">        if (commitOffsetValue &gt; 0) &#123;</span><br><span class="line">            commitOffsetEnable = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //计算请求的订阅表达式和是否进行filtersrv过滤消息</span><br><span class="line">    String subExpression = null;</span><br><span class="line">    boolean classFilter = false;</span><br><span class="line">    SubscriptionData sd = this.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</span><br><span class="line">    if (sd != null) &#123;</span><br><span class="line">        if (this.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) &#123;</span><br><span class="line">            subExpression = sd.getSubString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        classFilter = sd.isClassFilterMode();</span><br><span class="line">    &#125;</span><br><span class="line">    //拉取消息系统标识</span><br><span class="line">    int sysFlag = PullSysFlag.buildSysFlag(</span><br><span class="line">        commitOffsetEnable, // commitOffset</span><br><span class="line">        true, // suspend</span><br><span class="line">        subExpression != null, // subscription</span><br><span class="line">        classFilter // class filter</span><br><span class="line">    );</span><br><span class="line">    //执行拉取。如果拉取请求发生异常时，提交延迟拉取消息请求</span><br><span class="line">    try &#123;</span><br><span class="line">        this.pullAPIWrapper.pullKernelImpl(</span><br><span class="line">            pullRequest.getMessageQueue(),</span><br><span class="line">            subExpression,</span><br><span class="line">            subscriptionData.getExpressionType(),</span><br><span class="line">            subscriptionData.getSubVersion(),</span><br><span class="line">            pullRequest.getNextOffset(),</span><br><span class="line">            this.defaultMQPushConsumer.getPullBatchSize(),</span><br><span class="line">            sysFlag,</span><br><span class="line">            commitOffsetValue,</span><br><span class="line">            BROKER_SUSPEND_MAX_TIME_MILLIS,</span><br><span class="line">            CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND,</span><br><span class="line">            CommunicationMode.ASYNC,</span><br><span class="line">            pullCallback</span><br><span class="line">        );</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;pullKernelImpl exception&quot;, e);</span><br><span class="line">        this.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、PullAPIWrapper的pullKernelImpl方法"><a href="#4、PullAPIWrapper的pullKernelImpl方法" class="headerlink" title="4、PullAPIWrapper的pullKernelImpl方法"></a>4、PullAPIWrapper的pullKernelImpl方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public PullResult pullKernelImpl(</span><br><span class="line">    final MessageQueue mq,</span><br><span class="line">    final String subExpression,</span><br><span class="line">    final String expressionType,</span><br><span class="line">    final long subVersion,</span><br><span class="line">    final long offset,</span><br><span class="line">    final int maxNums,</span><br><span class="line">    final int sysFlag,</span><br><span class="line">    final long commitOffset,</span><br><span class="line">    final long brokerSuspendMaxTimeMillis,</span><br><span class="line">    final long timeoutMillis,</span><br><span class="line">    final CommunicationMode communicationMode,</span><br><span class="line">    final PullCallback pullCallback</span><br><span class="line">) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    //获取Broker信息</span><br><span class="line">    FindBrokerResult findBrokerResult =</span><br><span class="line">        this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</span><br><span class="line">            this.recalculatePullFromWhichNode(mq), false);</span><br><span class="line">    if (null == findBrokerResult) &#123;</span><br><span class="line">        this.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</span><br><span class="line">        findBrokerResult =</span><br><span class="line">            this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</span><br><span class="line">                this.recalculatePullFromWhichNode(mq), false);</span><br><span class="line">    &#125;</span><br><span class="line">    //请求拉取消息</span><br><span class="line">    if (findBrokerResult != null) &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            // check version</span><br><span class="line">            if (!ExpressionType.isTagType(expressionType)</span><br><span class="line">                &amp;&amp; findBrokerResult.getBrokerVersion() &lt; MQVersion.Version.V4_1_0_SNAPSHOT.ordinal()) &#123;</span><br><span class="line">                throw new MQClientException(&quot;The broker[&quot; + mq.getBrokerName() + &quot;, &quot;</span><br><span class="line">                    + findBrokerResult.getBrokerVersion() + &quot;] does not upgrade to support for filter message by &quot; + expressionType, null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        int sysFlagInner = sysFlag;</span><br><span class="line"></span><br><span class="line">        if (findBrokerResult.isSlave()) &#123;</span><br><span class="line">            sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PullMessageRequestHeader requestHeader = new PullMessageRequestHeader();</span><br><span class="line">        requestHeader.setConsumerGroup(this.consumerGroup);</span><br><span class="line">        requestHeader.setTopic(mq.getTopic());</span><br><span class="line">        requestHeader.setQueueId(mq.getQueueId());</span><br><span class="line">        requestHeader.setQueueOffset(offset);</span><br><span class="line">        requestHeader.setMaxMsgNums(maxNums);</span><br><span class="line">        requestHeader.setSysFlag(sysFlagInner);</span><br><span class="line">        requestHeader.setCommitOffset(commitOffset);</span><br><span class="line">        requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</span><br><span class="line">        requestHeader.setSubscription(subExpression);</span><br><span class="line">        requestHeader.setSubVersion(subVersion);</span><br><span class="line">        requestHeader.setExpressionType(expressionType);</span><br><span class="line"></span><br><span class="line">        String brokerAddr = findBrokerResult.getBrokerAddr();</span><br><span class="line">        if (PullSysFlag.hasClassFilterFlag(sysFlagInner)) &#123;</span><br><span class="line">            brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PullResult pullResult = this.mQClientFactory.getMQClientAPIImpl().pullMessage(</span><br><span class="line">            brokerAddr,</span><br><span class="line">            requestHeader,</span><br><span class="line">            timeoutMillis,</span><br><span class="line">            communicationMode,</span><br><span class="line">            pullCallback);</span><br><span class="line"></span><br><span class="line">        return pullResult;</span><br><span class="line">    &#125;</span><br><span class="line">    //Broker信息不存在，则抛出异常</span><br><span class="line">    throw new MQClientException(&quot;The broker[&quot; + mq.getBrokerName() + &quot;] not exist&quot;, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（三、3）PullAPIWrapper的processPullResult方法"><a href="#5、接（三、3）PullAPIWrapper的processPullResult方法" class="headerlink" title="5、接（三、3）PullAPIWrapper的processPullResult方法"></a>5、接（三、3）PullAPIWrapper的processPullResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public PullResult processPullResult(final MessageQueue mq, final PullResult pullResult,</span><br><span class="line">    final SubscriptionData subscriptionData) &#123;</span><br><span class="line">    PullResultExt pullResultExt = (PullResultExt) pullResult;</span><br><span class="line">    //更新消息队列拉取消息Broker编号的映射</span><br><span class="line">    this.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</span><br><span class="line">    //解析消息，并根据订阅信息消息tagCode匹配合适消息</span><br><span class="line">    if (PullStatus.FOUND == pullResult.getPullStatus()) &#123;</span><br><span class="line">        //解析消息</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</span><br><span class="line">        List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</span><br><span class="line">        //根据订阅信息消息tagCode匹配合适消息</span><br><span class="line">        List&lt;MessageExt&gt; msgListFilterAgain = msgList;</span><br><span class="line">        if (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) &#123;</span><br><span class="line">            msgListFilterAgain = new ArrayList&lt;MessageExt&gt;(msgList.size());</span><br><span class="line">            for (MessageExt msg : msgList) &#123;</span><br><span class="line">                if (msg.getTags() != null) &#123;</span><br><span class="line">                    if (subscriptionData.getTagsSet().contains(msg.getTags())) &#123;</span><br><span class="line">                        msgListFilterAgain.add(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (this.hasHook()) &#123;</span><br><span class="line">            FilterMessageContext filterMessageContext = new FilterMessageContext();</span><br><span class="line">            filterMessageContext.setUnitMode(unitMode);</span><br><span class="line">            filterMessageContext.setMsgList(msgListFilterAgain);</span><br><span class="line">            this.executeHook(filterMessageContext);</span><br><span class="line">        &#125;</span><br><span class="line">        //设置消息队列当前最小/最大位置到消息拓展字段</span><br><span class="line">        for (MessageExt msg : msgListFilterAgain) &#123;</span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</span><br><span class="line">                Long.toString(pullResult.getMinOffset()));</span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</span><br><span class="line">                Long.toString(pullResult.getMaxOffset()));</span><br><span class="line">        &#125;</span><br><span class="line">        //设置消息列表</span><br><span class="line">        pullResultExt.setMsgFoundList(msgListFilterAgain);</span><br><span class="line">    &#125;</span><br><span class="line">    //清空消息二进制数组</span><br><span class="line">    pullResultExt.setMessageBinary(null);</span><br><span class="line"></span><br><span class="line">    return pullResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（三、3）ProcessQueue的putMessage方法"><a href="#6、接（三、3）ProcessQueue的putMessage方法" class="headerlink" title="6、接（三、3）ProcessQueue的putMessage方法"></a>6、接（三、3）ProcessQueue的putMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    public boolean putMessage(final List&lt;MessageExt&gt; msgs) &#123;</span><br><span class="line">    boolean dispatchToConsume = false;</span><br><span class="line">    try &#123;</span><br><span class="line">        this.lockTreeMap.writeLock().lockInterruptibly();</span><br><span class="line">        try &#123;</span><br><span class="line">            //添加消息</span><br><span class="line">            int validMsgCnt = 0;</span><br><span class="line">            for (MessageExt msg : msgs) &#123;</span><br><span class="line">                MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</span><br><span class="line">                if (null == old) &#123;</span><br><span class="line">                    validMsgCnt++;</span><br><span class="line">                    this.queueOffsetMax = msg.getQueueOffset();</span><br><span class="line">                    msgSize.addAndGet(msg.getBody().length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msgCount.addAndGet(validMsgCnt);</span><br><span class="line">            //是否正在消费</span><br><span class="line">            if (!msgTreeMap.isEmpty() &amp;&amp; !this.consuming) &#123;</span><br><span class="line">                dispatchToConsume = true;</span><br><span class="line">                this.consuming = true;</span><br><span class="line">            &#125;</span><br><span class="line">            // broker累计消息数量</span><br><span class="line">            if (!msgs.isEmpty()) &#123;</span><br><span class="line">                MessageExt messageExt = msgs.get(msgs.size() - 1);</span><br><span class="line">                String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</span><br><span class="line">                if (property != null) &#123;</span><br><span class="line">                    long accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</span><br><span class="line">                    if (accTotal &gt; 0) &#123;</span><br><span class="line">                        this.msgAccCnt = accTotal;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.lockTreeMap.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        log.error(&quot;putMessage exception&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return dispatchToConsume;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（三、3）ConsumeMessageConcurrentlyService的submitConsumeRequest方法"><a href="#7、接（三、3）ConsumeMessageConcurrentlyService的submitConsumeRequest方法" class="headerlink" title="7、接（三、3）ConsumeMessageConcurrentlyService的submitConsumeRequest方法"></a>7、接（三、3）ConsumeMessageConcurrentlyService的submitConsumeRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void submitConsumeRequest(</span><br><span class="line">    final List&lt;MessageExt&gt; msgs,</span><br><span class="line">    final ProcessQueue processQueue,</span><br><span class="line">    final MessageQueue messageQueue,</span><br><span class="line">    final boolean dispatchToConsume) &#123;</span><br><span class="line">    final int consumeBatchSize = this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</span><br><span class="line">    //提交消息小于批量消息数，直接提交消费请求</span><br><span class="line">    if (msgs.size() &lt;= consumeBatchSize) &#123;</span><br><span class="line">        ConsumeRequest consumeRequest = new ConsumeRequest(msgs, processQueue, messageQueue);</span><br><span class="line">        try &#123;</span><br><span class="line">            this.consumeExecutor.submit(consumeRequest);</span><br><span class="line">        &#125; catch (RejectedExecutionException e) &#123;</span><br><span class="line">            this.submitConsumeRequestLater(consumeRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    //提交消息大于批量消息数，进行分拆成多个消费请求</span><br><span class="line">        for (int total = 0; total &lt; msgs.size(); ) &#123;</span><br><span class="line">            //计算当前拆分请求包含的消息</span><br><span class="line">            List&lt;MessageExt&gt; msgThis = new ArrayList&lt;MessageExt&gt;(consumeBatchSize);</span><br><span class="line">            for (int i = 0; i &lt; consumeBatchSize; i++, total++) &#123;</span><br><span class="line">                if (total &lt; msgs.size()) &#123;</span><br><span class="line">                    msgThis.add(msgs.get(total));</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //提交拆分消费请求</span><br><span class="line">            ConsumeRequest consumeRequest = new ConsumeRequest(msgThis, processQueue, messageQueue);</span><br><span class="line">            try &#123;</span><br><span class="line">                this.consumeExecutor.submit(consumeRequest);</span><br><span class="line">            &#125; catch (RejectedExecutionException e) &#123;</span><br><span class="line">                //如果被拒绝，则将当前拆分消息+剩余消息提交延迟消费请求。</span><br><span class="line">                for (; total &lt; msgs.size(); total++) &#123;</span><br><span class="line">                    msgThis.add(msgs.get(total));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                this.submitConsumeRequestLater(consumeRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、ConsumeRequest的run方法"><a href="#8、ConsumeRequest的run方法" class="headerlink" title="8、ConsumeRequest的run方法"></a>8、ConsumeRequest的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    //废弃队列不进行消费</span><br><span class="line">    if (this.processQueue.isDropped()) &#123;</span><br><span class="line">        log.info(&quot;the message queue not be able to consume, because it&apos;s dropped. group=&#123;&#125; &#123;&#125;&quot;, ConsumeMessageConcurrentlyService.this.consumerGroup, this.messageQueue);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //监听器</span><br><span class="line">    MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.this.messageListener;</span><br><span class="line">    //消费Context</span><br><span class="line">    ConsumeConcurrentlyContext context = new ConsumeConcurrentlyContext(messageQueue);</span><br><span class="line">    //消费结果状态</span><br><span class="line">    ConsumeConcurrentlyStatus status = null;</span><br><span class="line"></span><br><span class="line">    ConsumeMessageContext consumeMessageContext = null;</span><br><span class="line">    if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) &#123;</span><br><span class="line">        consumeMessageContext = new ConsumeMessageContext();</span><br><span class="line">        consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">        consumeMessageContext.setProps(new HashMap&lt;String, String&gt;());</span><br><span class="line">        consumeMessageContext.setMq(messageQueue);</span><br><span class="line">        consumeMessageContext.setMsgList(msgs);</span><br><span class="line">        consumeMessageContext.setSuccess(false);</span><br><span class="line">        ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long beginTimestamp = System.currentTimeMillis();</span><br><span class="line">    boolean hasException = false;</span><br><span class="line">    ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</span><br><span class="line">    try &#123;</span><br><span class="line">        //当消息为重试消息，设置Topic为原始Topic</span><br><span class="line">        ConsumeMessageConcurrentlyService.this.resetRetryTopic(msgs);</span><br><span class="line">        //设置开始消费时间</span><br><span class="line">        if (msgs != null &amp;&amp; !msgs.isEmpty()) &#123;</span><br><span class="line">            for (MessageExt msg : msgs) &#123;</span><br><span class="line">                MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //进行消费</span><br><span class="line">        status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        log.warn(&quot;consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;&quot;,</span><br><span class="line">            RemotingHelper.exceptionSimpleDesc(e),</span><br><span class="line">            ConsumeMessageConcurrentlyService.this.consumerGroup,</span><br><span class="line">            msgs,</span><br><span class="line">            messageQueue);</span><br><span class="line">        hasException = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long consumeRT = System.currentTimeMillis() - beginTimestamp;</span><br><span class="line">    //解析消费返回结果类型</span><br><span class="line">    if (null == status) &#123;</span><br><span class="line">        if (hasException) &#123;</span><br><span class="line">            returnType = ConsumeReturnType.EXCEPTION;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            returnType = ConsumeReturnType.RETURNNULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * 60 * 1000) &#123;</span><br><span class="line">        returnType = ConsumeReturnType.TIME_OUT;</span><br><span class="line">    &#125; else if (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</span><br><span class="line">        returnType = ConsumeReturnType.FAILED;</span><br><span class="line">    &#125; else if (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</span><br><span class="line">        returnType = ConsumeReturnType.SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) &#123;</span><br><span class="line">        consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</span><br><span class="line">    &#125;</span><br><span class="line">    //消费结果状态为空时，则设置为稍后重新消费</span><br><span class="line">    if (null == status) &#123;</span><br><span class="line">        log.warn(&quot;consumeMessage return null, Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;&quot;,</span><br><span class="line">            ConsumeMessageConcurrentlyService.this.consumerGroup,</span><br><span class="line">            msgs,</span><br><span class="line">            messageQueue);</span><br><span class="line">        status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.hasHook()) &#123;</span><br><span class="line">        consumeMessageContext.setStatus(status.toString());</span><br><span class="line">        consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</span><br><span class="line">        ConsumeMessageConcurrentlyService.this.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</span><br><span class="line">    &#125;</span><br><span class="line">    //统计</span><br><span class="line">    ConsumeMessageConcurrentlyService.this.getConsumerStatsManager()</span><br><span class="line">        .incConsumeRT(ConsumeMessageConcurrentlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);</span><br><span class="line">    //处理消费结果</span><br><span class="line">    if (!processQueue.isDropped()) &#123;</span><br><span class="line">        ConsumeMessageConcurrentlyService.this.processConsumeResult(status, context, this);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        log.warn(&quot;processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;&quot;, messageQueue, msgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、ConsumeMessageConcurrentlyService的processConsumeResult方法"><a href="#9、ConsumeMessageConcurrentlyService的processConsumeResult方法" class="headerlink" title="9、ConsumeMessageConcurrentlyService的processConsumeResult方法"></a>9、ConsumeMessageConcurrentlyService的processConsumeResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public void processConsumeResult(</span><br><span class="line">    final ConsumeConcurrentlyStatus status,</span><br><span class="line">    final ConsumeConcurrentlyContext context,</span><br><span class="line">    final ConsumeRequest consumeRequest</span><br><span class="line">) &#123;</span><br><span class="line">    int ackIndex = context.getAckIndex();</span><br><span class="line">    //消息为空，直接返回</span><br><span class="line">    if (consumeRequest.getMsgs().isEmpty())</span><br><span class="line">        return;</span><br><span class="line">    //计算从consumeRequest.msgs[0]到consumeRequest.msgs[ackIndex]的消息消费成功数量   </span><br><span class="line">    switch (status) &#123;</span><br><span class="line">        case CONSUME_SUCCESS:</span><br><span class="line">            if (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</span><br><span class="line">                ackIndex = consumeRequest.getMsgs().size() - 1;</span><br><span class="line">            &#125;</span><br><span class="line">            //统计成功/失败数量</span><br><span class="line">            int ok = ackIndex + 1;</span><br><span class="line">            int failed = consumeRequest.getMsgs().size() - ok;</span><br><span class="line">            this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</span><br><span class="line">            this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</span><br><span class="line">            break;</span><br><span class="line">        case RECONSUME_LATER:</span><br><span class="line">            ackIndex = -1;</span><br><span class="line">            //统计成功/失败数量</span><br><span class="line">            this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</span><br><span class="line">                consumeRequest.getMsgs().size());</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    //处理消费失败的消息</span><br><span class="line">    switch (this.defaultMQPushConsumer.getMessageModel()) &#123;</span><br><span class="line">        case BROADCASTING:</span><br><span class="line">            //广播模式，无论是否消费失败，不发回消息到Broker，只打印Log</span><br><span class="line">            for (int i = ackIndex + 1; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</span><br><span class="line">                MessageExt msg = consumeRequest.getMsgs().get(i);</span><br><span class="line">                log.warn(&quot;BROADCASTING, the message consume failed, drop it, &#123;&#125;&quot;, msg.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case CLUSTERING:</span><br><span class="line">            //发回消息失败到Broker</span><br><span class="line">            List&lt;MessageExt&gt; msgBackFailed = new ArrayList&lt;MessageExt&gt;(consumeRequest.getMsgs().size());</span><br><span class="line">            for (int i = ackIndex + 1; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</span><br><span class="line">                MessageExt msg = consumeRequest.getMsgs().get(i);</span><br><span class="line">                boolean result = this.sendMessageBack(msg, context);</span><br><span class="line">                if (!result) &#123;</span><br><span class="line">                    msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);</span><br><span class="line">                    msgBackFailed.add(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //发回Broker失败的消息，直接提交延迟重新消费</span><br><span class="line">            if (!msgBackFailed.isEmpty()) &#123;</span><br><span class="line">                consumeRequest.getMsgs().removeAll(msgBackFailed);</span><br><span class="line"></span><br><span class="line">                this.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    //移除消费成功消息，并更新最新消费进度</span><br><span class="line">    long offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</span><br><span class="line">    if (offset &gt;= 0 &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</span><br><span class="line">        this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>