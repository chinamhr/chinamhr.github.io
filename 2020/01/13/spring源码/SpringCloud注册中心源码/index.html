<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="1、EurekaServer启动过程通过自动配置类EurekaServerAutoConfiguration引入相关配置1234567891011121314151617181920212223242526272829303132333435363738394041424344@Configurat"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="SpringCloud注册中心源码"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="1、EurekaServer启动过程通过自动配置类EurekaServerAutoConfiguration引入相关配置1234567891011121314151617181920212223242526272829303132333435363738394041424344@Configurat"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>SpringCloud注册中心源码 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>SpringCloud注册中心源码</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2020-01-13
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/spring/">spring</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="1、EurekaServer启动过程"><a href="#1、EurekaServer启动过程" class="headerlink" title="1、EurekaServer启动过程"></a>1、EurekaServer启动过程</h3><p>通过自动配置类EurekaServerAutoConfiguration引入相关配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@Import(&#123;EurekaServerInitializerConfiguration.class&#125;)</span><br><span class="line">@ConditionalOnBean(&#123;Marker.class&#125;)</span><br><span class="line">@EnableConfigurationProperties(&#123;EurekaDashboardProperties.class, InstanceRegistryProperties.class&#125;)</span><br><span class="line">@PropertySource(&#123;&quot;classpath:/eureka/server.properties&quot;&#125;)</span><br><span class="line">public class EurekaServerAutoConfiguration extends WebMvcConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">	//用来从别的节点获取服务信息</span><br><span class="line">    @Autowired</span><br><span class="line">    private EurekaClient eurekaClient;</span><br><span class="line">	</span><br><span class="line">	//EurekaController, spring-cloud 提供了一些额外的接口，用来获取eurekaServer的信息</span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnProperty( prefix = &quot;eureka.dashboard&quot;, name = &#123;&quot;enabled&quot;&#125;, matchIfMissing = true)</span><br><span class="line">    public EurekaController eurekaController() &#123;</span><br><span class="line">        return new EurekaController(this.applicationInfoManager);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	//服务注册器</span><br><span class="line">	@Bean</span><br><span class="line">    public PeerAwareInstanceRegistry peerAwareInstanceRegistry(ServerCodecs serverCodecs) &#123;</span><br><span class="line">        this.eurekaClient.getApplications();</span><br><span class="line">        return new InstanceRegistry(this.eurekaServerConfig, this.eurekaClientConfig, serverCodecs, this.eurekaClient, this.instanceRegistryProperties.getExpectedNumberOfRenewsPerMin(), this.instanceRegistryProperties.getDefaultOpenForTrafficCount());</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	//服务节点信息</span><br><span class="line">	@Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    public PeerEurekaNodes peerEurekaNodes(PeerAwareInstanceRegistry registry, ServerCodecs serverCodecs) &#123;</span><br><span class="line">        return new PeerEurekaNodes(registry, this.eurekaServerConfig, this.eurekaClientConfig, serverCodecs, this.applicationInfoManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	//服务上下文</span><br><span class="line">	@Bean</span><br><span class="line">    public EurekaServerContext eurekaServerContext(ServerCodecs serverCodecs, PeerAwareInstanceRegistry registry, PeerEurekaNodes peerEurekaNodes) &#123;</span><br><span class="line">        return new DefaultEurekaServerContext(this.eurekaServerConfig, serverCodecs, registry, peerEurekaNodes, this.applicationInfoManager);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	//spring-cloud和原生eureka的胶水代码，通过这个类来启动EurekaSever</span><br><span class="line">	@Bean</span><br><span class="line">    public EurekaServerBootstrap eurekaServerBootstrap(PeerAwareInstanceRegistry registry, EurekaServerContext serverContext) &#123;</span><br><span class="line">        return new EurekaServerBootstrap(this.applicationInfoManager, this.eurekaClientConfig, this.eurekaServerConfig, registry, serverContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DefaultEurekaServerContext在创建时执行了初始化方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  @PostConstruct</span><br><span class="line">  public void initialize() throws Exception &#123;</span><br><span class="line">//启动一个线程，定时（默认10分钟）通过updatePeerEurekaNodes方法读取其他集群节点的信息</span><br><span class="line">      this.peerEurekaNodes.start();</span><br><span class="line">//每15分钟更新一次最小心跳次数及需要开启保护状态的心跳次数，默认心跳次数小于最小次数的0.85则开启保护</span><br><span class="line">      this.registry.init(this.peerEurekaNodes);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>该类还引入了EurekaServerInitializerConfiguration配置类，这个类实现了Lifecycle方法，因此在spring启动的过程中会执行start方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public void start() &#123;</span><br><span class="line">       (new Thread(new Runnable() &#123;</span><br><span class="line">           public void run() &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">				//初始化EurekaServer，同时启动Eureka Server</span><br><span class="line">                   EurekaServerInitializerConfiguration.this.eurekaServerBootstrap.contextInitialized(EurekaServerInitializerConfiguration.this.servletContext);</span><br><span class="line">                   EurekaServerInitializerConfiguration.log.info(&quot;Started Eureka Server&quot;);</span><br><span class="line">                   //发送Eureka注册事件</span><br><span class="line">				EurekaServerInitializerConfiguration.this.publish(new EurekaRegistryAvailableEvent(EurekaServerInitializerConfiguration.this.getEurekaServerConfig()));</span><br><span class="line">                   //设置状态</span><br><span class="line">				EurekaServerInitializerConfiguration.this.running = true;</span><br><span class="line">                   //发送Eureka启动事件</span><br><span class="line">				EurekaServerInitializerConfiguration.this.publish(new EurekaServerStartedEvent(EurekaServerInitializerConfiguration.this.getEurekaServerConfig()));</span><br><span class="line">               &#125; catch (Exception var2) &#123;</span><br><span class="line">                   EurekaServerInitializerConfiguration.log.error(&quot;Could not initialize Eureka servlet context&quot;, var2);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)).start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>EurekaServerBootstrap调用initEurekaServerContext方法初始化上下文<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  protected void initEurekaServerContext() throws Exception &#123;</span><br><span class="line">      JsonXStream.getInstance().registerConverter(new V1AwareInstanceInfoConverter(), 10000);</span><br><span class="line">      XmlXStream.getInstance().registerConverter(new V1AwareInstanceInfoConverter(), 10000);</span><br><span class="line">      if (this.isAws(this.applicationInfoManager.getInfo())) &#123;</span><br><span class="line">          this.awsBinder = new AwsBinderDelegate(this.eurekaServerConfig, this.eurekaClientConfig, this.registry, this.applicationInfoManager);</span><br><span class="line">          this.awsBinder.start();</span><br><span class="line">      &#125;</span><br><span class="line">//初始化eureka server上下文</span><br><span class="line">      EurekaServerContextHolder.initialize(this.serverContext);</span><br><span class="line">      log.info(&quot;Initialized server context&quot;);</span><br><span class="line">//从相邻的eureka节点复制注册表</span><br><span class="line">      int registryCount = this.registry.syncUp();</span><br><span class="line">// 修改eureka状态为up，并开启定时任务，清理60秒没有心跳的客户端</span><br><span class="line">      this.registry.openForTraffic(this.applicationInfoManager, registryCount);</span><br><span class="line">      EurekaMonitors.registerAllStats();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>openForTraffic方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void openForTraffic(ApplicationInfoManager applicationInfoManager, int count) &#123;</span><br><span class="line">       //预估心跳次数</span><br><span class="line">	this.expectedNumberOfRenewsPerMin = count * 2;</span><br><span class="line">	//预估开启保护心跳次数</span><br><span class="line">       this.numberOfRenewsPerMinThreshold = (int)((double)this.expectedNumberOfRenewsPerMin * this.serverConfig.getRenewalPercentThreshold());</span><br><span class="line">       </span><br><span class="line">       this.startupTime = System.currentTimeMillis();</span><br><span class="line">       if (count &gt; 0) &#123;</span><br><span class="line">           this.peerInstancesTransferEmptyOnStartup = false;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	...//省略代码</span><br><span class="line"></span><br><span class="line">	//设置实例的状态为UP</span><br><span class="line">       applicationInfoManager.setInstanceStatus(InstanceStatus.UP);</span><br><span class="line">	//开启定时任务，默认60秒执行一次，用于清理60秒之内没有心跳的实例</span><br><span class="line">       super.postInit();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2、服务注册"><a href="#2、服务注册" class="headerlink" title="2、服务注册"></a>2、服务注册</h3><p>ApplicationResource的addInstance方法对外提供注册服务的功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@POST</span><br><span class="line">   @Consumes(&#123;&quot;application/json&quot;, &quot;application/xml&quot;&#125;)</span><br><span class="line">   public Response addInstance(InstanceInfo info, @HeaderParam(&quot;x-netflix-discovery-replication&quot;) String isReplication) &#123;</span><br><span class="line">           //注册服务</span><br><span class="line">		this.registry.register(info, &quot;true&quot;.equals(isReplication));</span><br><span class="line">           return Response.status(204).build();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>PeerAwareInstanceRegistryImpl的register方法执行注册逻辑<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  public void register(InstanceInfo info, boolean isReplication) &#123;</span><br><span class="line">//默认90秒过期</span><br><span class="line">      int leaseDuration = 90;</span><br><span class="line">//客户端提供以客户端为准</span><br><span class="line">      if (info.getLeaseInfo() != null &amp;&amp; info.getLeaseInfo().getDurationInSecs() &gt; 0) &#123;</span><br><span class="line">          leaseDuration = info.getLeaseInfo().getDurationInSecs();</span><br><span class="line">      &#125;</span><br><span class="line">//注册服务</span><br><span class="line">      super.register(info, leaseDuration, isReplication);</span><br><span class="line">//复制到其他节点上去</span><br><span class="line">      this.replicateToPeers(PeerAwareInstanceRegistryImpl.Action.Register, info.getAppName(), info.getId(), info, (InstanceStatus)null, isReplication);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"> public void register(InstanceInfo registrant, int leaseDuration, boolean isReplication) &#123;</span><br><span class="line">     try &#123;</span><br><span class="line">   //读锁</span><br><span class="line">         this.read.lock();</span><br><span class="line">//由服务名获取实例集合</span><br><span class="line">         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = (Map)this.registry.get(registrant.getAppName());</span><br><span class="line">         //增加注册次数到监控信息里面去</span><br><span class="line">EurekaMonitors.REGISTER.increment(isReplication);</span><br><span class="line">//不存在该服务，则新建集合</span><br><span class="line">         if (gMap == null) &#123;</span><br><span class="line">             ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = new ConcurrentHashMap();</span><br><span class="line">             gMap = (Map)this.registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">             if (gMap == null) &#123;</span><br><span class="line">                 gMap = gNewMap;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">//从集合中根据instanceId获取实例对象包装类</span><br><span class="line">         Lease&lt;InstanceInfo&gt; existingLease = (Lease)((Map)gMap).get(registrant.getId());</span><br><span class="line">         if (existingLease != null &amp;&amp; existingLease.getHolder() != null) &#123;</span><br><span class="line">	//已存在则比较lastDirtyTimestamp时间，时间最新的为有效的</span><br><span class="line">             Long existingLastDirtyTimestamp = ((InstanceInfo)existingLease.getHolder()).getLastDirtyTimestamp();</span><br><span class="line">             Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp();</span><br><span class="line">             logger.debug(&quot;Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;&quot;, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">             if (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</span><br><span class="line">                 logger.warn(&quot;There is an existing lease and the existing lease&apos;s dirty timestamp &#123;&#125; is greater than the one that is being registered &#123;&#125;&quot;, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                 logger.warn(&quot;Using the existing instanceInfo instead of the new instanceInfo as the registrant&quot;);</span><br><span class="line">                 registrant = (InstanceInfo)existingLease.getHolder();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">	//增加预估心跳次数，和预估开启保护心跳次数</span><br><span class="line">             synchronized(this.lock) &#123;</span><br><span class="line">                 if (this.expectedNumberOfRenewsPerMin &gt; 0) &#123;</span><br><span class="line">                     this.expectedNumberOfRenewsPerMin += 2;</span><br><span class="line">                     this.numberOfRenewsPerMinThreshold = (int)((double)this.expectedNumberOfRenewsPerMin * this.serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             logger.debug(&quot;No previous lease information found; it is new registration&quot;);</span><br><span class="line">         &#125;</span><br><span class="line">//创建Lease对象</span><br><span class="line">         Lease&lt;InstanceInfo&gt; lease = new Lease(registrant, leaseDuration);</span><br><span class="line">         if (existingLease != null) &#123;</span><br><span class="line">	//lease已存在，设置serviceUpTimestamp, 保证服务开启的时间一直是第一次的那个</span><br><span class="line">             lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</span><br><span class="line">         &#125;</span><br><span class="line">//放入集合</span><br><span class="line">         ((Map)gMap).put(registrant.getId(), lease);</span><br><span class="line">//添加到最近的注册队列里面去，以时间戳作为Key，名称作为value</span><br><span class="line">         synchronized(this.recentRegisteredQueue) &#123;</span><br><span class="line">             this.recentRegisteredQueue.add(new Pair(System.currentTimeMillis(), registrant.getAppName() + &quot;(&quot; + registrant.getId() + &quot;)&quot;));</span><br><span class="line">         &#125;</span><br><span class="line">//是否有覆盖状态</span><br><span class="line">         if (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</span><br><span class="line">             logger.debug(&quot;Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the overrides&quot;, registrant.getOverriddenStatus(), registrant.getId());</span><br><span class="line">             if (!this.overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</span><br><span class="line">                 logger.info(&quot;Not found overridden id &#123;&#125; and hence adding it&quot;, registrant.getId());</span><br><span class="line">                 this.overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">InstanceStatus overriddenStatusFromMap = (InstanceStatus)this.overriddenInstanceStatusMap.get(registrant.getId());</span><br><span class="line">         if (overriddenStatusFromMap != null) &#123;</span><br><span class="line">             logger.info(&quot;Storing overridden status &#123;&#125; from map&quot;, overriddenStatusFromMap);</span><br><span class="line">             registrant.setOverriddenStatus(overriddenStatusFromMap);</span><br><span class="line">         &#125;</span><br><span class="line">//获取实例状态，如果为UP则开启服务</span><br><span class="line">         InstanceStatus overriddenInstanceStatus = this.getOverriddenInstanceStatus(registrant, existingLease, isReplication);</span><br><span class="line">         registrant.setStatusWithoutDirty(overriddenInstanceStatus);</span><br><span class="line">if (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</span><br><span class="line">             lease.serviceUp();</span><br><span class="line">         &#125;</span><br><span class="line">//设置注册类型为添加</span><br><span class="line">         registrant.setActionType(ActionType.ADDED);</span><br><span class="line">//服务变更记录队列，记录了实例的每次变化，用于注册信息的增量获取</span><br><span class="line">         this.recentlyChangedQueue.add(new AbstractInstanceRegistry.RecentlyChangedItem(lease));</span><br><span class="line">         registrant.setLastUpdatedTimestamp();</span><br><span class="line">         //清理缓存</span><br><span class="line">this.invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">         logger.info(&quot;Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)&quot;, new Object[]&#123;registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication&#125;);</span><br><span class="line">     &#125; finally &#123;</span><br><span class="line">         this.read.unlock();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>replicateToPeers方法发起同步<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void replicateToPeers(PeerAwareInstanceRegistryImpl.Action action, String appName, String id, InstanceInfo info, InstanceStatus newStatus, boolean isReplication) &#123;</span><br><span class="line">       Stopwatch tracer = action.getTimer().start();</span><br><span class="line"></span><br><span class="line">       try &#123;</span><br><span class="line">		//集群同步请求，则记录最后一分钟的同步次数</span><br><span class="line">           if (isReplication) &#123;</span><br><span class="line">               this.numberOfReplicationsLastMin.increment();</span><br><span class="line">           &#125;</span><br><span class="line">		//集群节点不为空且不是同步请求</span><br><span class="line">           if (this.peerEurekaNodes != Collections.EMPTY_LIST &amp;&amp; !isReplication) &#123;</span><br><span class="line">               Iterator var8 = this.peerEurekaNodes.getPeerEurekaNodes().iterator();</span><br><span class="line">			//遍历节点分别发起同步</span><br><span class="line">               while(var8.hasNext()) &#123;</span><br><span class="line">                   PeerEurekaNode node = (PeerEurekaNode)var8.next();</span><br><span class="line">				//判断url不是自己</span><br><span class="line">                   if (!this.peerEurekaNodes.isThisMyUrl(node.getServiceUrl())) &#123;</span><br><span class="line">                       //发起同步请求</span><br><span class="line">					this.replicateInstanceActionsToPeers(action, appName, id, info, newStatus, node);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">           tracer.stop();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>replicateInstanceActionsToPeers执行同步逻辑<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void replicateInstanceActionsToPeers(PeerAwareInstanceRegistryImpl.Action action, String appName, String id, InstanceInfo info, InstanceStatus newStatus, PeerEurekaNode node) &#123;</span><br><span class="line">       try &#123;</span><br><span class="line">           InstanceInfo infoFromRegistry = null;</span><br><span class="line">           CurrentRequestVersion.set(Version.V2);</span><br><span class="line">           switch(action) &#123;</span><br><span class="line">           case Cancel://下线</span><br><span class="line">               node.cancel(appName, id);</span><br><span class="line">               break;</span><br><span class="line">           case Heartbeat://心跳</span><br><span class="line">               InstanceStatus overriddenStatus = (InstanceStatus)this.overriddenInstanceStatusMap.get(id);</span><br><span class="line">               infoFromRegistry = this.getInstanceByAppAndId(appName, id, false);</span><br><span class="line">               node.heartbeat(appName, id, infoFromRegistry, overriddenStatus, false);</span><br><span class="line">               break;</span><br><span class="line">           case Register://注册</span><br><span class="line">               node.register(info);</span><br><span class="line">               break;</span><br><span class="line">           case StatusUpdate://设置覆盖状态</span><br><span class="line">               infoFromRegistry = this.getInstanceByAppAndId(appName, id, false);</span><br><span class="line">               node.statusUpdate(appName, id, newStatus, infoFromRegistry);</span><br><span class="line">               break;</span><br><span class="line">           case DeleteStatusOverride://删除覆盖状态</span><br><span class="line">               infoFromRegistry = this.getInstanceByAppAndId(appName, id, false);</span><br><span class="line">               node.deleteStatusOverride(appName, id, infoFromRegistry);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; catch (Throwable var9) &#123;</span><br><span class="line">           logger.error(&quot;Cannot replicate information to &#123;&#125; for action &#123;&#125;&quot;, new Object[]&#123;node.getServiceUrl(), action.name(), var9&#125;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="3、服务心跳"><a href="#3、服务心跳" class="headerlink" title="3、服务心跳"></a>3、服务心跳</h3><p>InstanceResource的renewLease方法接受心跳<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@PUT</span><br><span class="line">   public Response renewLease(@HeaderParam(&quot;x-netflix-discovery-replication&quot;) String isReplication, @QueryParam(&quot;overriddenstatus&quot;) String overriddenStatus, @QueryParam(&quot;status&quot;) String status, @QueryParam(&quot;lastDirtyTimestamp&quot;) String lastDirtyTimestamp) &#123;</span><br><span class="line">	//同步请求</span><br><span class="line">	boolean isFromReplicaNode = &quot;true&quot;.equals(isReplication);</span><br><span class="line">	//心跳</span><br><span class="line">       boolean isSuccess = this.registry.renew(this.app.getName(), this.id, isFromReplicaNode);</span><br><span class="line">	</span><br><span class="line">	if (!isSuccess) &#123;</span><br><span class="line">		//心跳失败，需重新发起注册</span><br><span class="line">           return Response.status(Status.NOT_FOUND).build();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           Response response = null;</span><br><span class="line">		//如果lastDirtyTimestamp不同需重新同步</span><br><span class="line">           if (lastDirtyTimestamp != null &amp;&amp; this.serverConfig.shouldSyncWhenTimestampDiffers()) &#123;</span><br><span class="line">               //比较lastDirtyTimestamp的大小，请求lastDirtyTimestamp&gt;本地的时间，则认为当前实例是无效的，返回404错误，需重新发起注册</span><br><span class="line">			response = this.validateDirtyTimestamp(Long.valueOf(lastDirtyTimestamp), isFromReplicaNode);</span><br><span class="line">               if (response.getStatus() == Status.NOT_FOUND.getStatusCode() &amp;&amp; overriddenStatus != null &amp;&amp; !InstanceStatus.UNKNOWN.name().equals(overriddenStatus) &amp;&amp; isFromReplicaNode) &#123;</span><br><span class="line">                   this.registry.storeOverriddenStatusIfRequired(this.app.getAppName(), this.id, InstanceStatus.valueOf(overriddenStatus));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               response = Response.ok().build();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           logger.debug(&quot;Found (Renew): &#123;&#125; - &#123;&#125;; reply status=&#123;&#125;&quot; + this.app.getName(), this.id, response.getStatus());</span><br><span class="line">           return response;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>renew方法执行心跳逻辑<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public boolean renew(String appName, String id, boolean isReplication) &#123;</span><br><span class="line">	//执行心跳</span><br><span class="line">       if (super.renew(appName, id, isReplication)) &#123;</span><br><span class="line">		//向其他节点同步心跳</span><br><span class="line">           this.replicateToPeers(PeerAwareInstanceRegistryImpl.Action.Heartbeat, appName, id, (InstanceInfo)null, (InstanceStatus)null, isReplication);</span><br><span class="line">           return true;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           return false;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public boolean renew(String appName, String id, boolean isReplication) &#123;</span><br><span class="line">	//统计心跳次数</span><br><span class="line">       EurekaMonitors.RENEW.increment(isReplication);</span><br><span class="line">	//获取实例</span><br><span class="line">       Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = (Map)this.registry.get(appName);</span><br><span class="line">       Lease&lt;InstanceInfo&gt; leaseToRenew = null;</span><br><span class="line">       if (gMap != null) &#123;</span><br><span class="line">           leaseToRenew = (Lease)gMap.get(id);</span><br><span class="line">       &#125;</span><br><span class="line">	</span><br><span class="line">       if (leaseToRenew == null) &#123;</span><br><span class="line">		//未发现该实例</span><br><span class="line">           EurekaMonitors.RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">           logger.warn(&quot;DS: Registry: lease doesn&apos;t exist, registering resource: &#123;&#125; - &#123;&#125;&quot;, appName, id);</span><br><span class="line">           return false;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">		//获取实例</span><br><span class="line">           InstanceInfo instanceInfo = (InstanceInfo)leaseToRenew.getHolder();</span><br><span class="line">           if (instanceInfo != null) &#123;</span><br><span class="line">               InstanceStatus overriddenInstanceStatus = this.getOverriddenInstanceStatus(instanceInfo, leaseToRenew, isReplication);</span><br><span class="line">               if (overriddenInstanceStatus == InstanceStatus.UNKNOWN) &#123;</span><br><span class="line">                   logger.info(&quot;Instance status UNKNOWN possibly due to deleted override for instance &#123;&#125;; re-register required&quot;, instanceInfo.getId());</span><br><span class="line">                   EurekaMonitors.RENEW_NOT_FOUND.increment(isReplication);</span><br><span class="line">                   return false;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               if (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) &#123;</span><br><span class="line">                   Object[] args = new Object[]&#123;instanceInfo.getStatus().name(), instanceInfo.getOverriddenStatus().name(), instanceInfo.getId()&#125;;</span><br><span class="line">                   logger.info(&quot;The instance status &#123;&#125; is different from overridden instance status &#123;&#125; for instance &#123;&#125;. Hence setting the status to overridden status&quot;, args);</span><br><span class="line">                   instanceInfo.setStatusWithoutDirty(overriddenInstanceStatus);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">		//心跳次数加1</span><br><span class="line">           this.renewsLastMin.increment();</span><br><span class="line">		//执行心跳（lastUpdateTimestamp = System.currentTimeMillis() + duration）</span><br><span class="line">           leaseToRenew.renew();</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4、获取服务信息"><a href="#4、获取服务信息" class="headerlink" title="4、获取服务信息"></a>4、获取服务信息</h3><p>ApplicationsResource的getContainers方法提供全量拉取<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@GET</span><br><span class="line">   public Response getContainers(@PathParam(&quot;version&quot;) String version, @HeaderParam(&quot;Accept&quot;) String acceptHeader, @HeaderParam(&quot;Accept-Encoding&quot;) String acceptEncoding, @HeaderParam(&quot;X-Eureka-Accept&quot;) String eurekaAccept, @Context UriInfo uriInfo, @Nullable @QueryParam(&quot;regions&quot;) String regionsStr) &#123;</span><br><span class="line">       //获取注册列表的区域</span><br><span class="line">	boolean isRemoteRegionRequested = null != regionsStr &amp;&amp; !regionsStr.isEmpty();</span><br><span class="line">       String[] regions = null;</span><br><span class="line">       if (!isRemoteRegionRequested) &#123;</span><br><span class="line">           EurekaMonitors.GET_ALL.increment();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           regions = regionsStr.toLowerCase().split(&quot;,&quot;);</span><br><span class="line">           Arrays.sort(regions);</span><br><span class="line">           EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();</span><br><span class="line">       &#125;</span><br><span class="line">	//是否可以访问</span><br><span class="line">       if (!this.registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</span><br><span class="line">           return Response.status(Status.FORBIDDEN).build();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">		//设置API版本</span><br><span class="line">           CurrentRequestVersion.set(Version.toEnum(version));</span><br><span class="line">		//key默认JSON类型</span><br><span class="line">           KeyType keyType = KeyType.JSON;</span><br><span class="line">		//默认返回类型为JSON</span><br><span class="line">           String returnMediaType = &quot;application/json&quot;;</span><br><span class="line">		//Accept为空，或者不包含JSON字符串,则设置返回XML类型的</span><br><span class="line">           if (acceptHeader == null || !acceptHeader.contains(&quot;json&quot;)) &#123;</span><br><span class="line">               keyType = KeyType.XML;</span><br><span class="line">               returnMediaType = &quot;application/xml&quot;;</span><br><span class="line">           &#125;</span><br><span class="line">		//构建缓存KEY </span><br><span class="line">           Key cacheKey = new Key(EntityType.Application, &quot;ALL_APPS&quot;, keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions);</span><br><span class="line">           Response response;</span><br><span class="line">           //获取缓存信息，返回给客户端</span><br><span class="line">		//判断请求接收类型是否是gzip ,如果是，则返回gzip的流出去</span><br><span class="line">		if (acceptEncoding != null &amp;&amp; acceptEncoding.contains(&quot;gzip&quot;)) &#123;</span><br><span class="line">               response = Response.ok(this.responseCache.getGZIP(cacheKey)).header(&quot;Content-Encoding&quot;, &quot;gzip&quot;).header(&quot;Content-Type&quot;, returnMediaType).build();</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               response = Response.ok(this.responseCache.get(cacheKey)).build();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           return response;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>getContainerDifferential方法进行增量获取<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Path(&quot;delta&quot;)</span><br><span class="line">   @GET</span><br><span class="line">   public Response getContainerDifferential(@PathParam(&quot;version&quot;) String version, @HeaderParam(&quot;Accept&quot;) String acceptHeader, @HeaderParam(&quot;Accept-Encoding&quot;) String acceptEncoding, @HeaderParam(&quot;X-Eureka-Accept&quot;) String eurekaAccept, @Context UriInfo uriInfo, @Nullable @QueryParam(&quot;regions&quot;) String regionsStr) &#123;</span><br><span class="line">       boolean isRemoteRegionRequested = null != regionsStr &amp;&amp; !regionsStr.isEmpty();</span><br><span class="line">       if (!this.serverConfig.shouldDisableDelta() &amp;&amp; this.registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</span><br><span class="line">           ...//省略代码</span><br><span class="line">		//从缓存中获取，除了key不同，其他与全量相同</span><br><span class="line">           Key cacheKey = new Key(EntityType.Application, &quot;ALL_APPS_DELTA&quot;, keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions);</span><br><span class="line">           return acceptEncoding != null &amp;&amp; acceptEncoding.contains(&quot;gzip&quot;) ? Response.ok(this.responseCache.getGZIP(cacheKey)).header(&quot;Content-Encoding&quot;, &quot;gzip&quot;).header(&quot;Content-Type&quot;, returnMediaType).build() : Response.ok(this.responseCache.get(cacheKey)).build();</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           return Response.status(Status.FORBIDDEN).build();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>缓存实现类为ResponseCacheImpl，当不存在缓存，则使用generatePayload方法获取数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">private ResponseCacheImpl.Value generatePayload(Key key) &#123;</span><br><span class="line">    Stopwatch tracer = null;</span><br><span class="line"></span><br><span class="line">    ResponseCacheImpl.Value var8;</span><br><span class="line">    try &#123;</span><br><span class="line">        String payload;</span><br><span class="line">        switch(key.getEntityType()) &#123;</span><br><span class="line">        case Application:</span><br><span class="line">            boolean isRemoteRegionRequested = key.hasRegions();</span><br><span class="line">//全量获取</span><br><span class="line">            if (&quot;ALL_APPS&quot;.equals(key.getName())) &#123;</span><br><span class="line">	//是否是分区域获取注册表信息</span><br><span class="line">                if (isRemoteRegionRequested) &#123;</span><br><span class="line">                    tracer = this.serializeAllAppsWithRemoteRegionTimer.start();</span><br><span class="line">		payload = this.getPayLoad(key, this.registry.getApplicationsFromMultipleRegions(key.getRegions()));</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    tracer = this.serializeAllAppsTimer.start();</span><br><span class="line">		//获取服务信息</span><br><span class="line">                    payload = this.getPayLoad(key, this.registry.getApplications());</span><br><span class="line">                &#125;</span><br><span class="line">//增量获取</span><br><span class="line">            &#125; else if (&quot;ALL_APPS_DELTA&quot;.equals(key.getName())) &#123;</span><br><span class="line">                if (isRemoteRegionRequested) &#123;</span><br><span class="line">                    tracer = this.serializeDeltaAppsWithRemoteRegionTimer.start();</span><br><span class="line">                    this.versionDeltaWithRegions.incrementAndGet();</span><br><span class="line">                    versionDeltaWithRegionsLegacy.incrementAndGet();</span><br><span class="line">                    payload = this.getPayLoad(key, this.registry.getApplicationDeltasFromMultipleRegions(key.getRegions()));</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    tracer = this.serializeDeltaAppsTimer.start();</span><br><span class="line">		//设置增量版本号</span><br><span class="line">                    this.versionDelta.incrementAndGet();</span><br><span class="line">                    versionDeltaLegacy.incrementAndGet();</span><br><span class="line">		//获取服务信息</span><br><span class="line">                    payload = this.getPayLoad(key, this.registry.getApplicationDeltas());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">	//根据key直接获取注册信息</span><br><span class="line">                tracer = this.serializeOneApptimer.start();</span><br><span class="line">                payload = this.getPayLoad(key, this.registry.getApplication(key.getName()));</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case VIP:</span><br><span class="line">        case SVIP:</span><br><span class="line">            tracer = this.serializeViptimer.start();</span><br><span class="line">            payload = this.getPayLoad(key, getApplicationsForVip(key, this.registry));</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            logger.error(&quot;Unidentified entity type: &quot; + key.getEntityType() + &quot; found in the cache key.&quot;);</span><br><span class="line">            payload = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var8 = new ResponseCacheImpl.Value(payload);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (tracer != null) &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return var8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>全量获取和增量获取分别为AbstractInstanceRegistry的getApplications和getApplicationDeltas方法<br>全量获取最终使用getApplicationsFromMultipleRegions方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">  public Applications getApplicationsFromMultipleRegions(String[] remoteRegions) &#123;</span><br><span class="line">      boolean includeRemoteRegion = null != remoteRegions &amp;&amp; remoteRegions.length != 0;</span><br><span class="line">      logger.debug(&quot;Fetching applications registry with remote regions: &#123;&#125;, Regions argument &#123;&#125;&quot;, includeRemoteRegion, Arrays.toString(remoteRegions));</span><br><span class="line">      //默认为false</span><br><span class="line">if (includeRemoteRegion) &#123;</span><br><span class="line">          EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS.increment();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          EurekaMonitors.GET_ALL_CACHE_MISS.increment();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Applications apps = new Applications();</span><br><span class="line">      apps.setVersion(1L);</span><br><span class="line">//registry为服务集合，key为服务名，value为服务实例集合</span><br><span class="line">      Iterator var4 = this.registry.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">      while(var4.hasNext()) &#123;</span><br><span class="line">          Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; entry = (Entry)var4.next();</span><br><span class="line">          Application app = null;</span><br><span class="line">          Lease lease;</span><br><span class="line">          if (entry.getValue() != null) &#123;</span><br><span class="line">              //遍历服务实例，添加到app中</span><br><span class="line">		for(Iterator var7 = ((Map)entry.getValue()).entrySet().iterator(); var7.hasNext(); app.addInstance(this.decorateInstanceInfo(lease))) &#123;</span><br><span class="line">                  Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; stringLeaseEntry = (Entry)var7.next();</span><br><span class="line">                  lease = (Lease)stringLeaseEntry.getValue();</span><br><span class="line">                  if (app == null) &#123;</span><br><span class="line">                      app = new Application(((InstanceInfo)lease.getHolder()).getAppName());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">	//服务信息加入注册表</span><br><span class="line">          if (app != null) &#123;</span><br><span class="line">              apps.addApplication(app);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">...//省略部分</span><br><span class="line">      apps.setAppsHashCode(apps.getReconcileHashCode());</span><br><span class="line">      return apps;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>增量获取方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  public Applications getApplicationDeltas() &#123;</span><br><span class="line">      EurekaMonitors.GET_ALL_CACHE_MISS_DELTA.increment();</span><br><span class="line"></span><br><span class="line">//注册表</span><br><span class="line">      Applications apps = new Applications();</span><br><span class="line">//增量获取的版本号</span><br><span class="line">      apps.setVersion(this.responseCache.getVersionDelta().get());</span><br><span class="line">      HashMap applicationInstancesMap = new HashMap();</span><br><span class="line"></span><br><span class="line">      Applications var18;</span><br><span class="line">      try &#123;</span><br><span class="line">	//写锁</span><br><span class="line">          this.write.lock();</span><br><span class="line">	//服务实例最近状态变化队列，这个队列默认30秒清理一次过期数据，数据3分钟过期</span><br><span class="line">          Iterator&lt;AbstractInstanceRegistry.RecentlyChangedItem&gt; iter = this.recentlyChangedQueue.iterator();</span><br><span class="line">          logger.debug(&quot;The number of elements in the delta queue is :&quot; + this.recentlyChangedQueue.size());</span><br><span class="line"></span><br><span class="line">          Lease lease;</span><br><span class="line">          Application app;</span><br><span class="line">	//循环队列</span><br><span class="line">          for(; iter.hasNext(); app.addInstance(this.decorateInstanceInfo(lease))) &#123;</span><br><span class="line">		//获取服务实例的封装类</span><br><span class="line">              lease = ((AbstractInstanceRegistry.RecentlyChangedItem)iter.next()).getLeaseInfo();</span><br><span class="line">              InstanceInfo instanceInfo = (InstanceInfo)lease.getHolder();</span><br><span class="line">              Object[] args = new Object[]&#123;instanceInfo.getId(), instanceInfo.getStatus().name(), instanceInfo.getActionType().name()&#125;;</span><br><span class="line">              logger.debug(&quot;The instance id %s is found with status %s and actiontype %s&quot;, args);</span><br><span class="line">              app = (Application)applicationInstancesMap.get(instanceInfo.getAppName());</span><br><span class="line">              if (app == null) &#123;</span><br><span class="line">			//实例放进服务的app中</span><br><span class="line">                  app = new Application(instanceInfo.getAppName());</span><br><span class="line">                  applicationInstancesMap.put(instanceInfo.getAppName(), app);</span><br><span class="line">			//app加入注册表</span><br><span class="line">                  apps.addApplication(app);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          。。。//省略代码</span><br><span class="line">	//设置appsHashCode，哈希码为每个应用实例状态+数量拼接而来 </span><br><span class="line">          allAppsInLocalRegion = this.getApplications(!disableTransparentFallback);</span><br><span class="line">          apps.setAppsHashCode(allAppsInLocalRegion.getReconcileHashCode());</span><br><span class="line">	</span><br><span class="line">          var18 = apps;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          this.write.unlock();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return var18;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="5、覆盖状态"><a href="#5、覆盖状态" class="headerlink" title="5、覆盖状态"></a>5、覆盖状态</h3><p>InstanceResource的statusUpdate方法提供修改服务实例状态的接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> @PUT</span><br><span class="line"> @Path(&quot;status&quot;)</span><br><span class="line"> public Response statusUpdate(@QueryParam(&quot;value&quot;) String newStatus, @HeaderParam(&quot;x-netflix-discovery-replication&quot;) String isReplication, @QueryParam(&quot;lastDirtyTimestamp&quot;) String lastDirtyTimestamp) &#123;</span><br><span class="line">     try &#123;</span><br><span class="line">//实力不存在，更新失败</span><br><span class="line">         if (this.registry.getInstanceByAppAndId(this.app.getName(), this.id) == null) &#123;</span><br><span class="line">             logger.warn(&quot;Instance not found: &#123;&#125;/&#123;&#125;&quot;, this.app.getName(), this.id);</span><br><span class="line">             return Response.status(Status.NOT_FOUND).build();</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">	//更新状态</span><br><span class="line">             boolean isSuccess = this.registry.statusUpdate(this.app.getName(), this.id, InstanceStatus.valueOf(newStatus), lastDirtyTimestamp, &quot;true&quot;.equals(isReplication));</span><br><span class="line">             if (isSuccess) &#123;</span><br><span class="line">                 logger.info(&quot;Status updated: &quot; + this.app.getName() + &quot; - &quot; + this.id + &quot; - &quot; + newStatus);</span><br><span class="line">                 return Response.ok().build();</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 logger.warn(&quot;Unable to update status: &quot; + this.app.getName() + &quot; - &quot; + this.id + &quot; - &quot; + newStatus);</span><br><span class="line">                 return Response.serverError().build();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; catch (Throwable var5) &#123;</span><br><span class="line">         logger.error(&quot;Error updating instance &#123;&#125; for status &#123;&#125;&quot;, this.id, newStatus);</span><br><span class="line">         return Response.serverError().build();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>PeerAwareInstanceRegistryImpl的statusUpdate方法更新状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  public boolean statusUpdate(String appName, String id, InstanceStatus newStatus, String lastDirtyTimestamp, boolean isReplication) &#123;</span><br><span class="line">      //更新状态</span><br><span class="line">if (super.statusUpdate(appName, id, newStatus, lastDirtyTimestamp, isReplication)) &#123;</span><br><span class="line">          //集群同步</span><br><span class="line">	this.replicateToPeers(PeerAwareInstanceRegistryImpl.Action.StatusUpdate, appName, id, (InstanceInfo)null, newStatus, isReplication);</span><br><span class="line">          return true;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          return false;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"> public boolean statusUpdate(String appName, String id, InstanceStatus newStatus, String lastDirtyTimestamp, boolean isReplication) &#123;</span><br><span class="line">     boolean var15;</span><br><span class="line">     try &#123;</span><br><span class="line">         this.read.lock();</span><br><span class="line">//更新状态的次数</span><br><span class="line">         EurekaMonitors.STATUS_UPDATE.increment(isReplication);</span><br><span class="line">//获取服务的实例集合</span><br><span class="line">         Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = (Map)this.registry.get(appName);</span><br><span class="line">         Lease&lt;InstanceInfo&gt; lease = null;</span><br><span class="line">         if (gMap != null) &#123;</span><br><span class="line">             lease = (Lease)gMap.get(id);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if (lease == null) &#123;</span><br><span class="line">             boolean var14 = false;</span><br><span class="line">             return var14;</span><br><span class="line">         &#125;</span><br><span class="line">//心跳，更新下lastUpdateTimestamp时间</span><br><span class="line">         lease.renew();</span><br><span class="line">//获取实例</span><br><span class="line">         InstanceInfo info = (InstanceInfo)lease.getHolder();</span><br><span class="line">         if (info == null) &#123;</span><br><span class="line">             logger.error(&quot;Found Lease without a holder for instance id &#123;&#125;&quot;, id);</span><br><span class="line">         &#125;</span><br><span class="line">//instance信息不为空</span><br><span class="line">         if (info != null &amp;&amp; !info.getStatus().equals(newStatus)) &#123;</span><br><span class="line">	//新状态是UP的状态，启动一下serviceUp()</span><br><span class="line">             if (InstanceStatus.UP.equals(newStatus)) &#123;</span><br><span class="line">                 lease.serviceUp();</span><br><span class="line">             &#125;</span><br><span class="line">	//将instanceId和这个状态的映射信息放入覆盖缓存MAP</span><br><span class="line">             this.overriddenInstanceStatusMap.put(id, newStatus);</span><br><span class="line">	//设置覆盖状态</span><br><span class="line">             info.setOverriddenStatus(newStatus);</span><br><span class="line">             long replicaDirtyTimestamp = 0L;</span><br><span class="line">             info.setStatusWithoutDirty(newStatus);</span><br><span class="line">             if (lastDirtyTimestamp != null) &#123;</span><br><span class="line">                 replicaDirtyTimestamp = Long.valueOf(lastDirtyTimestamp);</span><br><span class="line">             &#125;</span><br><span class="line">	//更新LastDirtyTimestamp</span><br><span class="line">             if (replicaDirtyTimestamp &gt; info.getLastDirtyTimestamp()) &#123;</span><br><span class="line">                 info.setLastDirtyTimestamp(replicaDirtyTimestamp);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             info.setActionType(ActionType.MODIFIED);</span><br><span class="line">	//将instance的变化放入变化队列，客户端增量获取注册信息从队列获取</span><br><span class="line">             this.recentlyChangedQueue.add(new AbstractInstanceRegistry.RecentlyChangedItem(lease));</span><br><span class="line">             info.setLastUpdatedTimestamp();</span><br><span class="line">             this.invalidateCache(appName, info.getVIPAddress(), info.getSecureVipAddress());</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         var15 = true;</span><br><span class="line">     &#125; finally &#123;</span><br><span class="line">         this.read.unlock();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     return var15;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>