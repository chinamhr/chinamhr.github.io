<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="一、项目部署1、HostConfig的lifecycleEvent方法HostConfig为StandardHost容器的监听器，1234567891011121314151617181920212223242526272829303132333435@Overridepublic void lif"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Tomcat源码项目部署"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="一、项目部署1、HostConfig的lifecycleEvent方法HostConfig为StandardHost容器的监听器，1234567891011121314151617181920212223242526272829303132333435@Overridepublic void lif"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>Tomcat源码项目部署 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Tomcat源码项目部署</h1>
                    
                    <h2 class="post-subheading">
                        容器启动时项目部署过程、后台线程及向Mapper中注册容器
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2020-01-13
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/tomcat/">tomcat</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="一、项目部署"><a href="#一、项目部署" class="headerlink" title="一、项目部署"></a>一、项目部署</h3><h4 id="1、HostConfig的lifecycleEvent方法"><a href="#1、HostConfig的lifecycleEvent方法" class="headerlink" title="1、HostConfig的lifecycleEvent方法"></a>1、HostConfig的lifecycleEvent方法</h4><p>HostConfig为StandardHost容器的监听器，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void lifecycleEvent(LifecycleEvent event) &#123;</span><br><span class="line"></span><br><span class="line">    // Identify the host we are associated with</span><br><span class="line">    try &#123;</span><br><span class="line">        host = (Host) event.getLifecycle();</span><br><span class="line">        if (host instanceof StandardHost) &#123;</span><br><span class="line">            //是否复制xml到$CATALINA_HOME/conf/[enginename]/[hostname]/，默认false</span><br><span class="line">            setCopyXML(((StandardHost) host).isCopyXML());</span><br><span class="line">            //是否部署context descriptor，只包含Context元素的xml格式的部署文件</span><br><span class="line">            setDeployXML(((StandardHost) host).isDeployXML());</span><br><span class="line">            //是否解压war包，默认true</span><br><span class="line">            setUnpackWARs(((StandardHost) host).isUnpackWARs());</span><br><span class="line">            //设置默认的Context为StandardContext</span><br><span class="line">            setContextClass(((StandardHost) host).getContextClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (ClassCastException e) &#123;</span><br><span class="line">        log.error(sm.getString(&quot;hostConfig.cce&quot;, event.getLifecycle()), e);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process the event that has occurred</span><br><span class="line">    if (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">        check();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123;</span><br><span class="line">        //校验appBaseFile、hostConfigBase文件夹</span><br><span class="line">        beforeStart();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.START_EVENT)) &#123;</span><br><span class="line">        //部署web项目</span><br><span class="line">        start();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.STOP_EVENT)) &#123;</span><br><span class="line">        //从MBeanServer中移除HostConfig</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、HostConfig的start方法"><a href="#2、HostConfig的start方法" class="headerlink" title="2、HostConfig的start方法"></a>2、HostConfig的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void start() &#123;</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(sm.getString(&quot;hostConfig.start&quot;));</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //向MBeanServer中注册HostConfig</span><br><span class="line">        ObjectName hostON = host.getObjectName();</span><br><span class="line">        oname = new ObjectName</span><br><span class="line">            (hostON.getDomain() + &quot;:type=Deployer,host=&quot; + host.getName());</span><br><span class="line">        Registry.getRegistry(null, null).registerComponent</span><br><span class="line">            (this, oname, this.getClass().getName());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(sm.getString(&quot;hostConfig.jmx.register&quot;, oname), e);</span><br><span class="line">    &#125;</span><br><span class="line">    //appBaseFile不为文件夹，则不立即部署</span><br><span class="line">    if (!host.getAppBaseFile().isDirectory()) &#123;</span><br><span class="line">        log.error(sm.getString(&quot;hostConfig.appBase&quot;, host.getName(),</span><br><span class="line">                host.getAppBaseFile().getPath()));</span><br><span class="line">        host.setDeployOnStartup(false);</span><br><span class="line">        host.setAutoDeploy(false);</span><br><span class="line">    &#125;</span><br><span class="line">    //是否启动时部署</span><br><span class="line">    if (host.getDeployOnStartup())</span><br><span class="line">        //部署web项目</span><br><span class="line">        deployApps();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、HostConfig的deployApps方法"><a href="#3、HostConfig的deployApps方法" class="headerlink" title="3、HostConfig的deployApps方法"></a>3、HostConfig的deployApps方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected void deployApps() &#123;</span><br><span class="line">    //项目文件夹，默认webapps</span><br><span class="line">    File appBase = host.getAppBaseFile();</span><br><span class="line">    //部署xml文件目录，默认$CATALINA_HOME/conf/[enginename]/[hostname]/</span><br><span class="line">    File configBase = host.getConfigBaseFile();</span><br><span class="line">    //获取webapps文件夹下的待部署项目</span><br><span class="line">    String[] filteredAppPaths = filterAppPaths(appBase.list());</span><br><span class="line">    // Deploy XML descriptors from configBase</span><br><span class="line">    //部署xml文件</span><br><span class="line">    deployDescriptors(configBase, configBase.list());</span><br><span class="line">    // Deploy WARs</span><br><span class="line">    //部署war包</span><br><span class="line">    deployWARs(appBase, filteredAppPaths);</span><br><span class="line">    // Deploy expanded folders</span><br><span class="line">    //部署项目文件夹</span><br><span class="line">    deployDirectories(appBase, filteredAppPaths);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、HostConfig的deployDirectories方法"><a href="#4、HostConfig的deployDirectories方法" class="headerlink" title="4、HostConfig的deployDirectories方法"></a>4、HostConfig的deployDirectories方法</h4><p>以部署文件夹项目为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">protected void deployDirectories(File appBase, String[] files) &#123;</span><br><span class="line"></span><br><span class="line">    if (files == null)</span><br><span class="line">        return;</span><br><span class="line">    //获取线程池</span><br><span class="line">    ExecutorService es = host.getStartStopExecutor();</span><br><span class="line">    List&lt;Future&lt;?&gt;&gt; results = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; files.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">        if (files[i].equalsIgnoreCase(&quot;META-INF&quot;))</span><br><span class="line">            continue;</span><br><span class="line">        if (files[i].equalsIgnoreCase(&quot;WEB-INF&quot;))</span><br><span class="line">            continue;</span><br><span class="line">        //创建文件的file引用</span><br><span class="line">        File dir = new File(appBase, files[i]);</span><br><span class="line">        if (dir.isDirectory()) &#123;</span><br><span class="line">            //根据文件夹的名字来设置context的名字</span><br><span class="line">            ContextName cn = new ContextName(files[i], false);</span><br><span class="line">            //已部署</span><br><span class="line">            if (isServiced(cn.getName()) || deploymentExists(cn.getName()))</span><br><span class="line">                continue;</span><br><span class="line">            //部署该项目</span><br><span class="line">            results.add(es.submit(new DeployDirectory(this, cn, dir)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Future&lt;?&gt; result : results) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //阻塞等待</span><br><span class="line">            result.get();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(</span><br><span class="line">                    &quot;hostConfig.deployDir.threaded.error&quot;), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5、DeployDirectory的run方法"><a href="#5、DeployDirectory的run方法" class="headerlink" title="5、DeployDirectory的run方法"></a>5、DeployDirectory的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    //部署项目</span><br><span class="line">    config.deployDirectory(cn, dir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、HostConfig的deployDirectory方法"><a href="#6、HostConfig的deployDirectory方法" class="headerlink" title="6、HostConfig的deployDirectory方法"></a>6、HostConfig的deployDirectory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">protected void deployDirectory(ContextName cn, File dir) &#123;</span><br><span class="line"></span><br><span class="line">    long startTime = 0;</span><br><span class="line">    // Deploy the application in this directory</span><br><span class="line">    if( log.isInfoEnabled() ) &#123;</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        //打印正在部署</span><br><span class="line">        log.info(sm.getString(&quot;hostConfig.deployDir&quot;,</span><br><span class="line">                dir.getAbsolutePath()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Context context = null;</span><br><span class="line">    //当前context的配置文件，&quot;META-INF/context.xml&quot;</span><br><span class="line">    File xml = new File(dir, Constants.ApplicationContextXml);</span><br><span class="line">    //获取host的配置文件夹里面当前context的配置</span><br><span class="line">    File xmlCopy = new File(host.getConfigBaseFile(), cn.getBaseName() + &quot;.xml&quot;);</span><br><span class="line">    //已经部署的app</span><br><span class="line">    DeployedApplication deployedApp;</span><br><span class="line">    //是否复制xml</span><br><span class="line">    boolean copyThisXml = isCopyXML();</span><br><span class="line">    //是否用dir下的xml部署</span><br><span class="line">    boolean deployThisXML = isDeployThisXML(dir, cn);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (deployThisXML &amp;&amp; xml.exists()) &#123;</span><br><span class="line">            synchronized (digesterLock) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //解析context.xml，默认返回StandardContext</span><br><span class="line">                    context = (Context) digester.parse(xml);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(sm.getString(</span><br><span class="line">                            &quot;hostConfig.deployDescriptor.error&quot;,</span><br><span class="line">                            xml), e);</span><br><span class="line">                    context = new FailedContext();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    digester.reset();</span><br><span class="line">                    if (context == null) &#123;</span><br><span class="line">                        context = new FailedContext();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //是否将context.xml复制到host的配置文件夹里</span><br><span class="line">            if (copyThisXml == false &amp;&amp; context instanceof StandardContext) &#123;</span><br><span class="line">                // Host is using default value. Context may override it.</span><br><span class="line">                copyThisXml = ((StandardContext) context).getCopyXML();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (copyThisXml) &#123;</span><br><span class="line">                Files.copy(xml.toPath(), xmlCopy.toPath());</span><br><span class="line">                context.setConfigFile(xmlCopy.toURI().toURL());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                context.setConfigFile(xml.toURI().toURL());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (!deployThisXML &amp;&amp; xml.exists()) &#123;</span><br><span class="line">            // Block deployment as META-INF/context.xml may contain security</span><br><span class="line">            // configuration necessary for a secure deployment.</span><br><span class="line">            log.error(sm.getString(&quot;hostConfig.deployDescriptor.blocked&quot;,</span><br><span class="line">                    cn.getPath(), xml, xmlCopy));</span><br><span class="line">            context = new FailedContext();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //未发现context.xml，直接实例化StandardContext</span><br><span class="line">            context = (Context) Class.forName(contextClass).getConstructor().newInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        //添加ContextConfig监听器</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(host.getConfigClass());</span><br><span class="line">        LifecycleListener listener = (LifecycleListener) clazz.getConstructor().newInstance();</span><br><span class="line">        context.addLifecycleListener(listener);</span><br><span class="line">        //设置当前context的名字</span><br><span class="line">        context.setName(cn.getName());</span><br><span class="line">        //应用所在的路径</span><br><span class="line">        context.setPath(cn.getPath());</span><br><span class="line">        //当前版本</span><br><span class="line">        context.setWebappVersion(cn.getVersion());</span><br><span class="line">        //设置自定义的项目路径</span><br><span class="line">        context.setDocBase(cn.getBaseName());</span><br><span class="line">        //在host添加context,并启动context</span><br><span class="line">        host.addChild(context);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        log.error(sm.getString(&quot;hostConfig.deployDir.error&quot;,</span><br><span class="line">                dir.getAbsolutePath()), t);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        deployedApp = new DeployedApplication(cn.getName(),</span><br><span class="line">                xml.exists() &amp;&amp; deployThisXML &amp;&amp; copyThisXml);</span><br><span class="line"></span><br><span class="line">        // Fake re-deploy resource to detect if a WAR is added at a later</span><br><span class="line">        // point</span><br><span class="line">        deployedApp.redeployResources.put(dir.getAbsolutePath() + &quot;.war&quot;,</span><br><span class="line">                Long.valueOf(0));</span><br><span class="line">        deployedApp.redeployResources.put(dir.getAbsolutePath(),</span><br><span class="line">                Long.valueOf(dir.lastModified()));</span><br><span class="line">        if (deployThisXML &amp;&amp; xml.exists()) &#123;</span><br><span class="line">            if (copyThisXml) &#123;</span><br><span class="line">                deployedApp.redeployResources.put(</span><br><span class="line">                        xmlCopy.getAbsolutePath(),</span><br><span class="line">                        Long.valueOf(xmlCopy.lastModified()));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                deployedApp.redeployResources.put(</span><br><span class="line">                        xml.getAbsolutePath(),</span><br><span class="line">                        Long.valueOf(xml.lastModified()));</span><br><span class="line">                // Fake re-deploy resource to detect if a context.xml file is</span><br><span class="line">                // added at a later point</span><br><span class="line">                deployedApp.redeployResources.put(</span><br><span class="line">                        xmlCopy.getAbsolutePath(),</span><br><span class="line">                        Long.valueOf(0));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // Fake re-deploy resource to detect if a context.xml file is</span><br><span class="line">            // added at a later point</span><br><span class="line">            deployedApp.redeployResources.put(</span><br><span class="line">                    xmlCopy.getAbsolutePath(),</span><br><span class="line">                    Long.valueOf(0));</span><br><span class="line">            if (!xml.exists()) &#123;</span><br><span class="line">                deployedApp.redeployResources.put(</span><br><span class="line">                        xml.getAbsolutePath(),</span><br><span class="line">                        Long.valueOf(0));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        addWatchedResources(deployedApp, dir.getAbsolutePath(), context);</span><br><span class="line">        // Add the global redeploy resources (which are never deleted) at</span><br><span class="line">        // the end so they don&apos;t interfere with the deletion process</span><br><span class="line">        addGlobalRedeployResources(deployedApp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    deployed.put(cn.getName(), deployedApp);</span><br><span class="line"></span><br><span class="line">    if( log.isInfoEnabled() ) &#123;</span><br><span class="line">        log.info(sm.getString(&quot;hostConfig.deployDir.finished&quot;,</span><br><span class="line">                dir.getAbsolutePath(), Long.valueOf(System.currentTimeMillis() - startTime)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、StandardContext的startInternal方法"><a href="#7、StandardContext的startInternal方法" class="headerlink" title="7、StandardContext的startInternal方法"></a>7、StandardContext的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    if(log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Starting &quot; + getBaseName());</span><br><span class="line"></span><br><span class="line">    // Send j2ee.state.starting notification</span><br><span class="line">    //广播启动的JMX通知</span><br><span class="line">    if (this.getObjectName() != null) &#123;</span><br><span class="line">        Notification notification = new Notification(&quot;j2ee.state.starting&quot;,</span><br><span class="line">                this.getObjectName(), sequenceNumber.getAndIncrement());</span><br><span class="line">        broadcaster.sendNotification(notification);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置配置标记为否</span><br><span class="line">    setConfigured(false);</span><br><span class="line">    boolean ok = true;</span><br><span class="line"></span><br><span class="line">    // Currently this is effectively a NO-OP but needs to be called to</span><br><span class="line">    // ensure the NamingResources follows the correct lifecycle</span><br><span class="line">    //启动当前维护的JNDI资源</span><br><span class="line">    if (namingResources != null) &#123;</span><br><span class="line">        namingResources.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Post work directory</span><br><span class="line">    //初始化临时工作目录workDir,默认为$CATALINA-BASE/work/&lt;Engine名称&gt;/&lt;Host名称&gt;/&lt;Context名称&gt;</span><br><span class="line">    postWorkDirectory();</span><br><span class="line"></span><br><span class="line">    // Add missing components as necessary</span><br><span class="line">    //初始化WebResouceRoot并启动,WebResouceRoot维护了Web应用的资源（Class文件、Jar包以及其他资源文件）</span><br><span class="line">    if (getResources() == null) &#123;   // (1) Required by Loader</span><br><span class="line">        if (log.isDebugEnabled())</span><br><span class="line">            log.debug(&quot;Configuring default Resources&quot;);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            setResources(new StandardRoot(this));</span><br><span class="line">        &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">            log.error(sm.getString(&quot;standardContext.resourcesInit&quot;), e);</span><br><span class="line">            ok = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        resourcesStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (getLoader() == null) &#123;</span><br><span class="line">        //创建Web应用类加载器webappLoader,启动后创建Web应用类加载器ParallelWebappClassLoader</span><br><span class="line">        WebappLoader webappLoader = new WebappLoader(getParentClassLoader());</span><br><span class="line">        webappLoader.setDelegate(getDelegate());</span><br><span class="line">        setLoader(webappLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // An explicit cookie processor hasn&apos;t been specified; use the default</span><br><span class="line">    // 创建Cookie处理器，默认为Rfc6265CookieProcessor。</span><br><span class="line">    if (cookieProcessor == null) &#123;</span><br><span class="line">        cookieProcessor = new Rfc6265CookieProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize character set mapper</span><br><span class="line">    // 设置字符集映射,默认CharsetMapper</span><br><span class="line">    getCharsetMapper();</span><br><span class="line"></span><br><span class="line">    // Validate required extensions</span><br><span class="line">    // 检测web应用依赖</span><br><span class="line">    boolean dependencyCheck = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        dependencyCheck = ExtensionValidator.validateApplication(getResources(), this);</span><br><span class="line">    &#125; catch (IOException ioe) &#123;</span><br><span class="line">        log.error(sm.getString(&quot;standardContext.extensionValidationError&quot;), ioe);</span><br><span class="line">        dependencyCheck = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!dependencyCheck) &#123;</span><br><span class="line">        // do not make application available if dependency check fails</span><br><span class="line">        ok = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Reading the &quot;catalina.useNaming&quot; environment variable</span><br><span class="line">    // 注册NamingContextListener</span><br><span class="line">    String useNamingProperty = System.getProperty(&quot;catalina.useNaming&quot;);</span><br><span class="line">    if ((useNamingProperty != null)</span><br><span class="line">        &amp;&amp; (useNamingProperty.equals(&quot;false&quot;))) &#123;</span><br><span class="line">        useNaming = false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (ok &amp;&amp; isUseNaming()) &#123;</span><br><span class="line">        if (getNamingContextListener() == null) &#123;</span><br><span class="line">            NamingContextListener ncl = new NamingContextListener();</span><br><span class="line">            ncl.setName(getNamingContextName());</span><br><span class="line">            ncl.setExceptionOnFailedWrite(getJndiExceptionOnFailedWrite());</span><br><span class="line">            addLifecycleListener(ncl);</span><br><span class="line">            setNamingContextListener(ncl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Standard container startup</span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Processing standard container startup&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // Binding thread</span><br><span class="line">    // ParallelWebappClassLoader绑定到当前线程</span><br><span class="line">    ClassLoader oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            // Start our subordinate components, if any</span><br><span class="line">            Loader loader = getLoader();</span><br><span class="line">            if (loader instanceof Lifecycle) &#123;</span><br><span class="line">                ((Lifecycle) loader).start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // since the loader just started, the webapp classloader is now</span><br><span class="line">            // created.</span><br><span class="line">            // 设置ParallelWebappClassLoader属性</span><br><span class="line">            setClassLoaderProperty(&quot;clearReferencesRmiTargets&quot;,</span><br><span class="line">                    getClearReferencesRmiTargets());</span><br><span class="line">            setClassLoaderProperty(&quot;clearReferencesStopThreads&quot;,</span><br><span class="line">                    getClearReferencesStopThreads());</span><br><span class="line">            setClassLoaderProperty(&quot;clearReferencesStopTimerThreads&quot;,</span><br><span class="line">                    getClearReferencesStopTimerThreads());</span><br><span class="line">            setClassLoaderProperty(&quot;clearReferencesHttpClientKeepAliveThread&quot;,</span><br><span class="line">                    getClearReferencesHttpClientKeepAliveThread());</span><br><span class="line">            setClassLoaderProperty(&quot;clearReferencesObjectStreamClassCaches&quot;,</span><br><span class="line">                    getClearReferencesObjectStreamClassCaches());</span><br><span class="line"></span><br><span class="line">            // By calling unbindThread and bindThread in a row, we setup the</span><br><span class="line">            // current Thread CCL to be the webapp classloader</span><br><span class="line">            unbindThread(oldCCL);</span><br><span class="line">            oldCCL = bindThread();</span><br><span class="line"></span><br><span class="line">            // Initialize logger again. Other components might have used it</span><br><span class="line">            // too early, so it should be reset.</span><br><span class="line">            logger = null;</span><br><span class="line">            getLogger();</span><br><span class="line">            //启动安全组件</span><br><span class="line">            Realm realm = getRealmInternal();</span><br><span class="line">            if(null != realm) &#123;</span><br><span class="line">                if (realm instanceof Lifecycle) &#123;</span><br><span class="line">                    ((Lifecycle) realm).start();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Place the CredentialHandler into the ServletContext so</span><br><span class="line">                // applications can have access to it. Wrap it in a &quot;safe&quot;</span><br><span class="line">                // handler so application&apos;s can&apos;t modify it.</span><br><span class="line">                CredentialHandler safeHandler = new CredentialHandler() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public boolean matches(String inputCredentials, String storedCredentials) &#123;</span><br><span class="line">                        return getRealmInternal().getCredentialHandler().matches(inputCredentials, storedCredentials);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public String mutate(String inputCredentials) &#123;</span><br><span class="line">                        return getRealmInternal().getCredentialHandler().mutate(inputCredentials);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                context.setAttribute(Globals.CREDENTIAL_HANDLER, safeHandler);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Notify our interested LifecycleListeners</span><br><span class="line">            // 广播&quot;configure_start&quot;事件</span><br><span class="line">            fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, null);</span><br><span class="line"></span><br><span class="line">            // Start our child containers, if not already started</span><br><span class="line">            // 启动子容器Wrapper</span><br><span class="line">            for (Container child : findChildren()) &#123;</span><br><span class="line">                if (!child.getState().isAvailable()) &#123;</span><br><span class="line">                    child.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Start the Valves in our pipeline (including the basic),</span><br><span class="line">            // if any</span><br><span class="line">            //启动pipeline</span><br><span class="line">            if (pipeline instanceof Lifecycle) &#123;</span><br><span class="line">                ((Lifecycle) pipeline).start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Acquire clustered manager</span><br><span class="line">            // 创建会话管理器</span><br><span class="line">            Manager contextManager = null;</span><br><span class="line">            Manager manager = getManager();</span><br><span class="line">            if (manager == null) &#123;</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(&quot;standardContext.cluster.noManager&quot;,</span><br><span class="line">                            Boolean.valueOf((getCluster() != null)),</span><br><span class="line">                            Boolean.valueOf(distributable)));</span><br><span class="line">                &#125;</span><br><span class="line">                if ( (getCluster() != null) &amp;&amp; distributable) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        contextManager = getCluster().createManager(getName());</span><br><span class="line">                    &#125; catch (Exception ex) &#123;</span><br><span class="line">                        log.error(&quot;standardContext.clusterFail&quot;, ex);</span><br><span class="line">                        ok = false;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    contextManager = new StandardManager();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Configure default manager if none was specified</span><br><span class="line">            if (contextManager != null) &#123;</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(&quot;standardContext.manager&quot;,</span><br><span class="line">                            contextManager.getClass().getName()));</span><br><span class="line">                &#125;</span><br><span class="line">                setManager(contextManager);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (manager!=null &amp;&amp; (getCluster() != null) &amp;&amp; distributable) &#123;</span><br><span class="line">                //let the cluster know that there is a context that is distributable</span><br><span class="line">                //and that it has its own manager</span><br><span class="line">                getCluster().registerManager(manager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!getConfigured()) &#123;</span><br><span class="line">            log.error(sm.getString(&quot;standardContext.configurationFail&quot;));</span><br><span class="line">            ok = false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // We put the resources into the servlet context</span><br><span class="line">        // 将Context的Web资源集合添加到ServletContext</span><br><span class="line">        if (ok)</span><br><span class="line">            getServletContext().setAttribute</span><br><span class="line">                (Globals.RESOURCES_ATTR, getResources());</span><br><span class="line">        //创建实例管理器instanceManager，用于创建对象实例，如Servlet、Filter等</span><br><span class="line">        if (ok ) &#123;</span><br><span class="line">            if (getInstanceManager() == null) &#123;</span><br><span class="line">                javax.naming.Context context = null;</span><br><span class="line">                if (isUseNaming() &amp;&amp; getNamingContextListener() != null) &#123;</span><br><span class="line">                    context = getNamingContextListener().getEnvContext();</span><br><span class="line">                &#125;</span><br><span class="line">                Map&lt;String, Map&lt;String, String&gt;&gt; injectionMap = buildInjectionMap(</span><br><span class="line">                        getIgnoreAnnotations() ? new NamingResourcesImpl(): getNamingResources());</span><br><span class="line">                setInstanceManager(new DefaultInstanceManager(context,</span><br><span class="line">                        injectionMap, this, this.getClass().getClassLoader()));</span><br><span class="line">            &#125;</span><br><span class="line">            getServletContext().setAttribute(</span><br><span class="line">                    InstanceManager.class.getName(), getInstanceManager());</span><br><span class="line">            InstanceManagerBindings.bind(getLoader().getClassLoader(), getInstanceManager());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Create context attributes that will be required</span><br><span class="line">        // 将Jar包扫描器添加到ServletContext</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            getServletContext().setAttribute(</span><br><span class="line">                    JarScanner.class.getName(), getJarScanner());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Set up the context init params</span><br><span class="line">        // 合并参数</span><br><span class="line">        mergeParameters();</span><br><span class="line"></span><br><span class="line">        // Call ServletContainerInitializers</span><br><span class="line">        // 启动添加到Context的ServletContainerInitializer</span><br><span class="line">        for (Map.Entry&lt;ServletContainerInitializer, Set&lt;Class&lt;?&gt;&gt;&gt; entry :</span><br><span class="line">            initializers.entrySet()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                entry.getKey().onStartup(entry.getValue(),</span><br><span class="line">                        getServletContext());</span><br><span class="line">            &#125; catch (ServletException e) &#123;</span><br><span class="line">                log.error(sm.getString(&quot;standardContext.sciFail&quot;), e);</span><br><span class="line">                ok = false;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Configure and call application event listeners</span><br><span class="line">        // 实例化应用类监听器ApplicationListener</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            if (!listenerStart()) &#123;</span><br><span class="line">                log.error(sm.getString(&quot;standardContext.listenerFail&quot;));</span><br><span class="line">                ok = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Check constraints for uncovered HTTP methods</span><br><span class="line">        // Needs to be after SCIs and listeners as they may programmatically</span><br><span class="line">        // change constraints</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            checkConstraintsForUncoveredMethods(findConstraints());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Start manager</span><br><span class="line">            // 启动会话管理器</span><br><span class="line">            Manager manager = getManager();</span><br><span class="line">            if (manager instanceof Lifecycle) &#123;</span><br><span class="line">                ((Lifecycle) manager).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch(Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(&quot;standardContext.managerFail&quot;), e);</span><br><span class="line">            ok = false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Configure and call application filters</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            // 实例化FilterConfig、Filter并调用Filter.init()</span><br><span class="line">            if (!filterStart()) &#123;</span><br><span class="line">                log.error(sm.getString(&quot;standardContext.filterFail&quot;));</span><br><span class="line">                ok = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Load and initialize all &quot;load on startup&quot; servlets</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            // 对于loadOnStartup大于等于0的Wrapper，调用Wrapper.load()，</span><br><span class="line">            // 该方法负责实例化Servlet，并调用Servlet.init()进行初始化</span><br><span class="line">            if (!loadOnStartup(findChildren()))&#123;</span><br><span class="line">                log.error(sm.getString(&quot;standardContext.servletFail&quot;));</span><br><span class="line">                ok = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Start ContainerBackgroundProcessor thread</span><br><span class="line">        // 启动后台线程</span><br><span class="line">        super.threadStart();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // Unbinding thread</span><br><span class="line">        unbindThread(oldCCL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Set available status depending upon startup success</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        if (log.isDebugEnabled())</span><br><span class="line">            log.debug(&quot;Starting completed&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        log.error(sm.getString(&quot;standardContext.startFailed&quot;, getName()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    startTime=System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    // Send j2ee.state.running notification</span><br><span class="line">    // 发布正在运行的JMX通知</span><br><span class="line">    if (ok &amp;&amp; (this.getObjectName() != null)) &#123;</span><br><span class="line">        Notification notification =</span><br><span class="line">            new Notification(&quot;j2ee.state.running&quot;, this.getObjectName(),</span><br><span class="line">                             sequenceNumber.getAndIncrement());</span><br><span class="line">        broadcaster.sendNotification(notification);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The WebResources implementation caches references to JAR files. On</span><br><span class="line">    // some platforms these references may lock the JAR files. Since web</span><br><span class="line">    // application start is likely to have read from lots of JARs, trigger</span><br><span class="line">    // a clean-up now.</span><br><span class="line">    // 释放资源，如关闭jar文件</span><br><span class="line">    getResources().gc();</span><br><span class="line"></span><br><span class="line">    // Reinitializing if something went wrong</span><br><span class="line">    // 设置Context状态</span><br><span class="line">    if (!ok) &#123;</span><br><span class="line">        setState(LifecycleState.FAILED);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、ContextConfig的lifecycleEvent方法"><a href="#7、ContextConfig的lifecycleEvent方法" class="headerlink" title="7、ContextConfig的lifecycleEvent方法"></a>7、ContextConfig的lifecycleEvent方法</h4><p>监听器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void lifecycleEvent(LifecycleEvent event) &#123;</span><br><span class="line"></span><br><span class="line">    // Identify the context we are associated with</span><br><span class="line">    try &#123;</span><br><span class="line">        context = (Context) event.getLifecycle();</span><br><span class="line">    &#125; catch (ClassCastException e) &#123;</span><br><span class="line">        log.error(sm.getString(&quot;contextConfig.cce&quot;, event.getLifecycle()), e);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process the event that has occurred</span><br><span class="line">    if (event.getType().equals(Lifecycle.CONFIGURE_START_EVENT)) &#123;</span><br><span class="line">        //解析web.xml</span><br><span class="line">        configureStart();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.BEFORE_START_EVENT)) &#123;</span><br><span class="line">        //如需要，解压war包将Context的docBase设置为解压后的路径，将Web应用目录复制到临时文件夹下防止对资源加锁</span><br><span class="line">        beforeStart();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.AFTER_START_EVENT)) &#123;</span><br><span class="line">        // Restore docBase for management tools</span><br><span class="line">        if (originalDocBase != null) &#123;</span><br><span class="line">            context.setDocBase(originalDocBase);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.CONFIGURE_STOP_EVENT)) &#123;</span><br><span class="line">        configureStop();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.AFTER_INIT_EVENT)) &#123;</span><br><span class="line">        //解析context.xml</span><br><span class="line">        init();</span><br><span class="line">    &#125; else if (event.getType().equals(Lifecycle.AFTER_DESTROY_EVENT)) &#123;</span><br><span class="line">        destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="8、ContextConfig的init方法"><a href="#8、ContextConfig的init方法" class="headerlink" title="8、ContextConfig的init方法"></a>8、ContextConfig的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected void init() &#123;</span><br><span class="line">    // Called from StandardContext.init()</span><br><span class="line">    // 创建解析规则</span><br><span class="line">    Digester contextDigester = createContextDigester();</span><br><span class="line">    contextDigester.getParser();</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(sm.getString(&quot;contextConfig.init&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    context.setConfigured(false);</span><br><span class="line">    ok = true;</span><br><span class="line">    //解析context.xml</span><br><span class="line">    contextConfig(contextDigester);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、ContextConfig的contextConfig方法"><a href="#9、ContextConfig的contextConfig方法" class="headerlink" title="9、ContextConfig的contextConfig方法"></a>9、ContextConfig的contextConfig方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">protected void contextConfig(Digester digester) &#123;</span><br><span class="line"></span><br><span class="line">    String defaultContextXml = null;</span><br><span class="line">    // Open the default context.xml file, if it exists</span><br><span class="line">    if (context instanceof StandardContext) &#123;</span><br><span class="line">        defaultContextXml = ((StandardContext)context).getDefaultContextXml();</span><br><span class="line">    &#125;</span><br><span class="line">    // set the default if we don&apos;t have any overrides</span><br><span class="line">    if (defaultContextXml == null) &#123;</span><br><span class="line">        //Catalina容器级默认配置文件,&quot;conf/context.xml&quot;</span><br><span class="line">        defaultContextXml = Constants.DefaultContextXml;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!context.getOverride()) &#123;</span><br><span class="line">        File defaultContextFile = new File(defaultContextXml);</span><br><span class="line">        if (!defaultContextFile.isAbsolute()) &#123;</span><br><span class="line">            defaultContextFile =</span><br><span class="line">                    new File(context.getCatalinaBase(), defaultContextXml);</span><br><span class="line">        &#125;</span><br><span class="line">        if (defaultContextFile.exists()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                URL defaultContextUrl = defaultContextFile.toURI().toURL();</span><br><span class="line">                //覆盖Context属性</span><br><span class="line">                processContextConfig(digester, defaultContextUrl);</span><br><span class="line">            &#125; catch (MalformedURLException e) &#123;</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                        &quot;contextConfig.badUrl&quot;, defaultContextFile), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //Host级的默认配置,context.xml.default</span><br><span class="line">        File hostContextFile = new File(getHostConfigBase(), Constants.HostContextXml);</span><br><span class="line">        if (hostContextFile.exists()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                URL hostContextUrl = hostContextFile.toURI().toURL();</span><br><span class="line">                //覆盖Context属性</span><br><span class="line">                processContextConfig(digester, hostContextUrl);</span><br><span class="line">            &#125; catch (MalformedURLException e) &#123;</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                        &quot;contextConfig.badUrl&quot;, hostContextFile), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //Web应用配置,context.xml</span><br><span class="line">    if (context.getConfigFile() != null) &#123;</span><br><span class="line">        //覆盖Context属性</span><br><span class="line">        processContextConfig(digester, context.getConfigFile());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（一、7）ContextConfig的configureStart方法"><a href="#10、接（一、7）ContextConfig的configureStart方法" class="headerlink" title="10、接（一、7）ContextConfig的configureStart方法"></a>10、接（一、7）ContextConfig的configureStart方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">protected synchronized void configureStart() &#123;</span><br><span class="line">    // Called from StandardContext.start()</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(sm.getString(&quot;contextConfig.start&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(sm.getString(&quot;contextConfig.xmlSettings&quot;,</span><br><span class="line">                context.getName(),</span><br><span class="line">                Boolean.valueOf(context.getXmlValidation()),</span><br><span class="line">                Boolean.valueOf(context.getXmlNamespaceAware())));</span><br><span class="line">    &#125;</span><br><span class="line">    //解析web.xml</span><br><span class="line">    webConfig();</span><br><span class="line"></span><br><span class="line">    if (!context.getIgnoreAnnotations()) &#123;</span><br><span class="line">        //处理Listener，Filter，Servet的class，field，method，  </span><br><span class="line">        //EJB,JSR 250类注解问题，@Resource等注解  </span><br><span class="line">        applicationAnnotationsConfig();</span><br><span class="line">    &#125;</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        //配置安全角色信息</span><br><span class="line">        validateSecurityRoles();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Configure an authenticator if we need one</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        authenticatorConfig();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Dump the contents of this pipeline if requested</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Pipeline Configuration:&quot;);</span><br><span class="line">        Pipeline pipeline = context.getPipeline();</span><br><span class="line">        Valve valves[] = null;</span><br><span class="line">        if (pipeline != null) &#123;</span><br><span class="line">            valves = pipeline.getValves();</span><br><span class="line">        &#125;</span><br><span class="line">        if (valves != null) &#123;</span><br><span class="line">            for (int i = 0; i &lt; valves.length; i++) &#123;</span><br><span class="line">                log.debug(&quot;  &quot; + valves[i].getClass().getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(&quot;======================&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Make our application available if no problems were encountered</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        context.setConfigured(true);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        log.error(sm.getString(&quot;contextConfig.unavailable&quot;));</span><br><span class="line">        context.setConfigured(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、ContextConfig的webConfig方法"><a href="#11、ContextConfig的webConfig方法" class="headerlink" title="11、ContextConfig的webConfig方法"></a>11、ContextConfig的webConfig方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">protected void webConfig() &#123;</span><br><span class="line">    /*</span><br><span class="line">     * Anything and everything can override the global and host defaults.</span><br><span class="line">     * This is implemented in two parts</span><br><span class="line">     * - Handle as a web fragment that gets added after everything else so</span><br><span class="line">     *   everything else takes priority</span><br><span class="line">     * - Mark Servlets as overridable so SCI configuration can replace</span><br><span class="line">     *   configuration from the defaults</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * The rules for annotation scanning are not as clear-cut as one might</span><br><span class="line">     * think. Tomcat implements the following process:</span><br><span class="line">     * - As per SRV.1.6.2, Tomcat will scan for annotations regardless of</span><br><span class="line">     *   which Servlet spec version is declared in web.xml. The EG has</span><br><span class="line">     *   confirmed this is the expected behaviour.</span><br><span class="line">     * - As per http://java.net/jira/browse/SERVLET_SPEC-36, if the main</span><br><span class="line">     *   web.xml is marked as metadata-complete, JARs are still processed</span><br><span class="line">     *   for SCIs.</span><br><span class="line">     * - If metadata-complete=true and an absolute ordering is specified,</span><br><span class="line">     *   JARs excluded from the ordering are also excluded from the SCI</span><br><span class="line">     *   processing.</span><br><span class="line">     * - If an SCI has a @HandlesType annotation then all classes (except</span><br><span class="line">     *   those in JARs excluded from an absolute ordering) need to be</span><br><span class="line">     *   scanned to check if they match.</span><br><span class="line">     */</span><br><span class="line">    // 创建web.xml解析器</span><br><span class="line">    WebXmlParser webXmlParser = new WebXmlParser(context.getXmlNamespaceAware(),</span><br><span class="line">            context.getXmlValidation(), context.getXmlBlockExternal());</span><br><span class="line"></span><br><span class="line">    Set&lt;WebXml&gt; defaults = new HashSet&lt;&gt;();</span><br><span class="line">    //从Catalina、Host获取默认WebXML（conf/web.xml、web.xml.default），通过Digester解析，添加到defaults</span><br><span class="line">    defaults.add(getDefaultWebXmlFragment(webXmlParser));</span><br><span class="line"></span><br><span class="line">    WebXml webXml = createWebXml();</span><br><span class="line"></span><br><span class="line">    // Parse context level web.xml</span><br><span class="line">    //解析WepApp的WebXML（/WEB-INF/web.xml）</span><br><span class="line">    InputSource contextWebXml = getContextWebXmlSource();</span><br><span class="line">    if (!webXmlParser.parseWebXml(contextWebXml, webXml, false)) &#123;</span><br><span class="line">        ok = false;</span><br><span class="line">    &#125;</span><br><span class="line">    // 初始化ApplicationContext并返回ApplicationContextFacade</span><br><span class="line">    ServletContext sContext = context.getServletContext();</span><br><span class="line"></span><br><span class="line">    // Ordering is important here</span><br><span class="line"></span><br><span class="line">    // Step 1. Identify all the JARs packaged with the application and those</span><br><span class="line">    // provided by the container. If any of the application JARs have a</span><br><span class="line">    // web-fragment.xml it will be parsed at this point. web-fragment.xml</span><br><span class="line">    // files are ignored for container provided JARs.</span><br><span class="line">    // 扫描应用打包的所有Jar,检索Jar包里面的web.xml配置并解析</span><br><span class="line">    Map&lt;String,WebXml&gt; fragments = processJarsForWebFragments(webXml, webXmlParser);</span><br><span class="line"></span><br><span class="line">    // Step 2. Order the fragments.</span><br><span class="line">    // 对web配置进行排序</span><br><span class="line">    Set&lt;WebXml&gt; orderedFragments = null;</span><br><span class="line">    orderedFragments = WebXml.orderWebFragments(webXml, fragments, sContext);</span><br><span class="line"></span><br><span class="line">    // Step 3. Look for ServletContainerInitializer implementations</span><br><span class="line">    // 基于SPI机制查找ServletContainerInitializer的实现</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        processServletContainerInitializers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if  (!webXml.isMetadataComplete() || typeInitializerMap.size() &gt; 0) &#123;</span><br><span class="line">        // Step 4. Process /WEB-INF/classes for annotations and</span><br><span class="line">        // @HandlesTypes matches</span><br><span class="line">        Map&lt;String,JavaClassCacheEntry&gt; javaClassCache = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        //处理/WEB-INF/classes下面的类的注解</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            WebResource[] webResources =</span><br><span class="line">                    context.getResources().listResources(&quot;/WEB-INF/classes&quot;);</span><br><span class="line"></span><br><span class="line">            for (WebResource webResource : webResources) &#123;</span><br><span class="line">                // Skip the META-INF directory from any JARs that have been</span><br><span class="line">                // expanded in to WEB-INF/classes (sometimes IDEs do this).</span><br><span class="line">                if (&quot;META-INF&quot;.equals(webResource.getName())) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                processAnnotationsWebResource(webResource, webXml,</span><br><span class="line">                        webXml.isMetadataComplete(), javaClassCache);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Step 5. Process JARs for annotations and</span><br><span class="line">        // @HandlesTypes matches - only need to process those fragments we</span><br><span class="line">        // are going to use (remember orderedFragments includes any</span><br><span class="line">        // container fragments)</span><br><span class="line">        // 处理Jar包中的注解类</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            processAnnotations(</span><br><span class="line">                    orderedFragments, webXml.isMetadataComplete(), javaClassCache);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Cache, if used, is no longer required so clear it</span><br><span class="line">        javaClassCache.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!webXml.isMetadataComplete()) &#123;</span><br><span class="line">        // Step 6. Merge web-fragment.xml files into the main web.xml</span><br><span class="line">        // file.</span><br><span class="line">        // 将jar包web配置合并</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            ok = webXml.merge(orderedFragments);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Step 7. Apply global defaults</span><br><span class="line">        // Have to merge defaults before JSP conversion since defaults</span><br><span class="line">        // provide JSP servlet definition.</span><br><span class="line">        // 将默认web配置合并</span><br><span class="line">        webXml.merge(defaults);</span><br><span class="line"></span><br><span class="line">        // Step 8. Convert explicitly mentioned jsps to servlets</span><br><span class="line">        // 将JSP转换为Servlet</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            convertJsps(webXml);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Step 9. Apply merged web.xml to Context</span><br><span class="line">        // 将web配置应用到Context容器</span><br><span class="line">        if (ok) &#123;</span><br><span class="line">            configureContext(webXml);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        webXml.merge(defaults);</span><br><span class="line">        convertJsps(webXml);</span><br><span class="line">        configureContext(webXml);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (context.getLogEffectiveWebXml()) &#123;</span><br><span class="line">        log.info(&quot;web.xml:\n&quot; + webXml.toXml());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Always need to look for static resources</span><br><span class="line">    // Step 10. Look for static resources packaged in JARs</span><br><span class="line">    // 检索Jar包中的静态资源</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        // Spec does not define an order.</span><br><span class="line">        // Use ordered JARs followed by remaining JARs</span><br><span class="line">        Set&lt;WebXml&gt; resourceJars = new LinkedHashSet&lt;&gt;();</span><br><span class="line">        for (WebXml fragment : orderedFragments) &#123;</span><br><span class="line">            resourceJars.add(fragment);</span><br><span class="line">        &#125;</span><br><span class="line">        for (WebXml fragment : fragments.values()) &#123;</span><br><span class="line">            if (!resourceJars.contains(fragment)) &#123;</span><br><span class="line">                resourceJars.add(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        processResourceJARs(resourceJars);</span><br><span class="line">        // See also StandardContext.resourcesStart() for</span><br><span class="line">        // WEB-INF/classes/META-INF/resources configuration</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Step 11. Apply the ServletContainerInitializer config to the</span><br><span class="line">    // context</span><br><span class="line">    // 将ServletContainerInitializer配置到上下文</span><br><span class="line">    if (ok) &#123;</span><br><span class="line">        for (Map.Entry&lt;ServletContainerInitializer,</span><br><span class="line">                Set&lt;Class&lt;?&gt;&gt;&gt; entry :</span><br><span class="line">                    initializerClassMap.entrySet()) &#123;</span><br><span class="line">            if (entry.getValue().isEmpty()) &#123;</span><br><span class="line">                context.addServletContainerInitializer(</span><br><span class="line">                        entry.getKey(), null);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                context.addServletContainerInitializer(</span><br><span class="line">                        entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、ContextConfig的configureContext方法"><a href="#12、ContextConfig的configureContext方法" class="headerlink" title="12、ContextConfig的configureContext方法"></a>12、ContextConfig的configureContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">private void configureContext(WebXml webxml) &#123;</span><br><span class="line">    // As far as possible, process in alphabetical order so it is easy to</span><br><span class="line">    // check everything is present</span><br><span class="line">    // Some validation depends on correct public ID</span><br><span class="line">    // 设置xml的publicId</span><br><span class="line">    context.setPublicId(webxml.getPublicId());</span><br><span class="line"></span><br><span class="line">    // Everything else in order</span><br><span class="line">    context.setEffectiveMajorVersion(webxml.getMajorVersion());</span><br><span class="line">    context.setEffectiveMinorVersion(webxml.getMinorVersion());</span><br><span class="line"></span><br><span class="line">    for (Entry&lt;String, String&gt; entry : webxml.getContextParams().entrySet()) &#123;</span><br><span class="line">        context.addParameter(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    context.setDenyUncoveredHttpMethods(</span><br><span class="line">            webxml.getDenyUncoveredHttpMethods());</span><br><span class="line">    context.setDisplayName(webxml.getDisplayName());</span><br><span class="line">    context.setDistributable(webxml.isDistributable());</span><br><span class="line">    for (ContextLocalEjb ejbLocalRef : webxml.getEjbLocalRefs().values()) &#123;</span><br><span class="line">        context.getNamingResources().addLocalEjb(ejbLocalRef);</span><br><span class="line">    &#125;</span><br><span class="line">    for (ContextEjb ejbRef : webxml.getEjbRefs().values()) &#123;</span><br><span class="line">        context.getNamingResources().addEjb(ejbRef);</span><br><span class="line">    &#125;</span><br><span class="line">    for (ContextEnvironment environment : webxml.getEnvEntries().values()) &#123;</span><br><span class="line">        context.getNamingResources().addEnvironment(environment);</span><br><span class="line">    &#125;</span><br><span class="line">    for (ErrorPage errorPage : webxml.getErrorPages().values()) &#123;</span><br><span class="line">        context.addErrorPage(errorPage);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置过滤器</span><br><span class="line">    for (FilterDef filter : webxml.getFilters().values()) &#123;</span><br><span class="line">        if (filter.getAsyncSupported() == null) &#123;</span><br><span class="line">            filter.setAsyncSupported(&quot;false&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        context.addFilterDef(filter);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置过滤器映射</span><br><span class="line">    for (FilterMap filterMap : webxml.getFilterMappings()) &#123;</span><br><span class="line">        context.addFilterMap(filterMap);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置JspConfigDescriptorImpl</span><br><span class="line">    context.setJspConfigDescriptor(webxml.getJspConfigDescriptor());</span><br><span class="line">    //设置web监听器</span><br><span class="line">    for (String listener : webxml.getListeners()) &#123;</span><br><span class="line">        context.addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    for (Entry&lt;String, String&gt; entry :</span><br><span class="line">            webxml.getLocaleEncodingMappings().entrySet()) &#123;</span><br><span class="line">        context.addLocaleEncodingMappingParameter(entry.getKey(),</span><br><span class="line">                entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    // Prevents IAE</span><br><span class="line">    if (webxml.getLoginConfig() != null) &#123;</span><br><span class="line">        context.setLoginConfig(webxml.getLoginConfig());</span><br><span class="line">    &#125;</span><br><span class="line">    for (MessageDestinationRef mdr :</span><br><span class="line">            webxml.getMessageDestinationRefs().values()) &#123;</span><br><span class="line">        context.getNamingResources().addMessageDestinationRef(mdr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // messageDestinations were ignored in Tomcat 6, so ignore here</span><br><span class="line"></span><br><span class="line">    context.setIgnoreAnnotations(webxml.isMetadataComplete());</span><br><span class="line">    for (Entry&lt;String, String&gt; entry :</span><br><span class="line">            webxml.getMimeMappings().entrySet()) &#123;</span><br><span class="line">        context.addMimeMapping(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    // Name is just used for ordering</span><br><span class="line">    for (ContextResourceEnvRef resource :</span><br><span class="line">            webxml.getResourceEnvRefs().values()) &#123;</span><br><span class="line">        context.getNamingResources().addResourceEnvRef(resource);</span><br><span class="line">    &#125;</span><br><span class="line">    for (ContextResource resource : webxml.getResourceRefs().values()) &#123;</span><br><span class="line">        context.getNamingResources().addResource(resource);</span><br><span class="line">    &#125;</span><br><span class="line">    boolean allAuthenticatedUsersIsAppRole =</span><br><span class="line">            webxml.getSecurityRoles().contains(</span><br><span class="line">                    SecurityConstraint.ROLE_ALL_AUTHENTICATED_USERS);</span><br><span class="line">    for (SecurityConstraint constraint : webxml.getSecurityConstraints()) &#123;</span><br><span class="line">        if (allAuthenticatedUsersIsAppRole) &#123;</span><br><span class="line">            constraint.treatAllAuthenticatedUsersAsApplicationRole();</span><br><span class="line">        &#125;</span><br><span class="line">        context.addConstraint(constraint);</span><br><span class="line">    &#125;</span><br><span class="line">    for (String role : webxml.getSecurityRoles()) &#123;</span><br><span class="line">        context.addSecurityRole(role);</span><br><span class="line">    &#125;</span><br><span class="line">    for (ContextService service : webxml.getServiceRefs().values()) &#123;</span><br><span class="line">        context.getNamingResources().addService(service);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置servlet</span><br><span class="line">    for (ServletDef servlet : webxml.getServlets().values()) &#123;</span><br><span class="line">        Wrapper wrapper = context.createWrapper();</span><br><span class="line">        // Description is ignored</span><br><span class="line">        // Display name is ignored</span><br><span class="line">        // Icons are ignored</span><br><span class="line"></span><br><span class="line">        // jsp-file gets passed to the JSP Servlet as an init-param</span><br><span class="line">        //设置LoadOnStartup值</span><br><span class="line">        if (servlet.getLoadOnStartup() != null) &#123;</span><br><span class="line">            wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        if (servlet.getEnabled() != null) &#123;</span><br><span class="line">            wrapper.setEnabled(servlet.getEnabled().booleanValue());</span><br><span class="line">        &#125;</span><br><span class="line">        wrapper.setName(servlet.getServletName());</span><br><span class="line">        Map&lt;String,String&gt; params = servlet.getParameterMap();</span><br><span class="line">        for (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">            wrapper.addInitParameter(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        wrapper.setRunAs(servlet.getRunAs());</span><br><span class="line">        Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();</span><br><span class="line">        for (SecurityRoleRef roleRef : roleRefs) &#123;</span><br><span class="line">            wrapper.addSecurityReference(</span><br><span class="line">                    roleRef.getName(), roleRef.getLink());</span><br><span class="line">        &#125;</span><br><span class="line">        //设置ServletClass</span><br><span class="line">        wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">        MultipartDef multipartdef = servlet.getMultipartDef();</span><br><span class="line">        if (multipartdef != null) &#123;</span><br><span class="line">            if (multipartdef.getMaxFileSize() != null &amp;&amp;</span><br><span class="line">                    multipartdef.getMaxRequestSize()!= null &amp;&amp;</span><br><span class="line">                    multipartdef.getFileSizeThreshold() != null) &#123;</span><br><span class="line">                wrapper.setMultipartConfigElement(new MultipartConfigElement(</span><br><span class="line">                        multipartdef.getLocation(),</span><br><span class="line">                        Long.parseLong(multipartdef.getMaxFileSize()),</span><br><span class="line">                        Long.parseLong(multipartdef.getMaxRequestSize()),</span><br><span class="line">                        Integer.parseInt(</span><br><span class="line">                                multipartdef.getFileSizeThreshold())));</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                wrapper.setMultipartConfigElement(new MultipartConfigElement(</span><br><span class="line">                        multipartdef.getLocation()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置是否支持异步任务</span><br><span class="line">        if (servlet.getAsyncSupported() != null) &#123;</span><br><span class="line">            wrapper.setAsyncSupported(</span><br><span class="line">                    servlet.getAsyncSupported().booleanValue());</span><br><span class="line">        &#125;</span><br><span class="line">        wrapper.setOverridable(servlet.isOverridable());</span><br><span class="line">        //context中添加子容器wrapper</span><br><span class="line">        context.addChild(wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">    for (Entry&lt;String, String&gt; entry :</span><br><span class="line">            webxml.getServletMappings().entrySet()) &#123;</span><br><span class="line">        context.addServletMappingDecoded(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    SessionConfig sessionConfig = webxml.getSessionConfig();</span><br><span class="line">    //设置Session相关属性</span><br><span class="line">    if (sessionConfig != null) &#123;</span><br><span class="line">        //设置session超时时间</span><br><span class="line">        if (sessionConfig.getSessionTimeout() != null) &#123;</span><br><span class="line">            context.setSessionTimeout(</span><br><span class="line">                    sessionConfig.getSessionTimeout().intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        SessionCookieConfig scc =</span><br><span class="line">            context.getServletContext().getSessionCookieConfig();</span><br><span class="line">        scc.setName(sessionConfig.getCookieName());</span><br><span class="line">        scc.setDomain(sessionConfig.getCookieDomain());</span><br><span class="line">        scc.setPath(sessionConfig.getCookiePath());</span><br><span class="line">        scc.setComment(sessionConfig.getCookieComment());</span><br><span class="line">        if (sessionConfig.getCookieHttpOnly() != null) &#123;</span><br><span class="line">            scc.setHttpOnly(sessionConfig.getCookieHttpOnly().booleanValue());</span><br><span class="line">        &#125;</span><br><span class="line">        if (sessionConfig.getCookieSecure() != null) &#123;</span><br><span class="line">            scc.setSecure(sessionConfig.getCookieSecure().booleanValue());</span><br><span class="line">        &#125;</span><br><span class="line">        if (sessionConfig.getCookieMaxAge() != null) &#123;</span><br><span class="line">            scc.setMaxAge(sessionConfig.getCookieMaxAge().intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        if (sessionConfig.getSessionTrackingModes().size() &gt; 0) &#123;</span><br><span class="line">            context.getServletContext().setSessionTrackingModes(</span><br><span class="line">                    sessionConfig.getSessionTrackingModes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Context doesn&apos;t use version directly</span><br><span class="line">    // 设置welcomeFile</span><br><span class="line">    for (String welcomeFile : webxml.getWelcomeFiles()) &#123;</span><br><span class="line">        /*</span><br><span class="line">         * The following will result in a welcome file of &quot;&quot; so don&apos;t add</span><br><span class="line">         * that to the context</span><br><span class="line">         * &lt;welcome-file-list&gt;</span><br><span class="line">         *   &lt;welcome-file/&gt;</span><br><span class="line">         * &lt;/welcome-file-list&gt;</span><br><span class="line">         */</span><br><span class="line">        if (welcomeFile != null &amp;&amp; welcomeFile.length() &gt; 0) &#123;</span><br><span class="line">            //添加welcomeFile，并广播该事件</span><br><span class="line">            context.addWelcomeFile(welcomeFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Do this last as it depends on servlets</span><br><span class="line">    // 添加jsp映射</span><br><span class="line">    for (JspPropertyGroup jspPropertyGroup :</span><br><span class="line">            webxml.getJspPropertyGroups()) &#123;</span><br><span class="line">        String jspServletName = context.findServletMapping(&quot;*.jsp&quot;);</span><br><span class="line">        if (jspServletName == null) &#123;</span><br><span class="line">            jspServletName = &quot;jsp&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        if (context.findChild(jspServletName) != null) &#123;</span><br><span class="line">            for (String urlPattern : jspPropertyGroup.getUrlPatterns()) &#123;</span><br><span class="line">                context.addServletMappingDecoded(urlPattern, jspServletName, true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if(log.isDebugEnabled()) &#123;</span><br><span class="line">                for (String urlPattern : jspPropertyGroup.getUrlPatterns()) &#123;</span><br><span class="line">                    log.debug(&quot;Skipping &quot; + urlPattern + &quot; , no servlet &quot; +</span><br><span class="line">                            jspServletName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Entry&lt;String, String&gt; entry :</span><br><span class="line">            webxml.getPostConstructMethods().entrySet()) &#123;</span><br><span class="line">        context.addPostConstructMethod(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (Entry&lt;String, String&gt; entry :</span><br><span class="line">        webxml.getPreDestroyMethods().entrySet()) &#123;</span><br><span class="line">        context.addPreDestroyMethod(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、接（一、7）StandardManager的startInternal方法"><a href="#13、接（一、7）StandardManager的startInternal方法" class="headerlink" title="13、接（一、7）StandardManager的startInternal方法"></a>13、接（一、7）StandardManager的startInternal方法</h4><p>启动会话管理器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line">    //父类启动方法，创建sessionIdGenerator</span><br><span class="line">    super.startInternal();</span><br><span class="line"></span><br><span class="line">    // Load unloaded sessions, if any</span><br><span class="line">    try &#123;</span><br><span class="line">        //加载磁盘中的sessions</span><br><span class="line">        load();</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        log.error(sm.getString(&quot;standardManager.managerLoad&quot;), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="14、StandardManager的doLoad方法"><a href="#14、StandardManager的doLoad方法" class="headerlink" title="14、StandardManager的doLoad方法"></a>14、StandardManager的doLoad方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">protected void doLoad() throws ClassNotFoundException, IOException &#123;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Start: Loading persisted sessions&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize our internal data structures</span><br><span class="line">    sessions.clear();</span><br><span class="line"></span><br><span class="line">    // Open an input stream to the specified pathname, if any</span><br><span class="line">    // 磁盘中的session文件，SESSIONS.ser</span><br><span class="line">    File file = file();</span><br><span class="line">    if (file == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(sm.getString(&quot;standardManager.loading&quot;, pathname));</span><br><span class="line">    &#125;</span><br><span class="line">    Loader loader = null;</span><br><span class="line">    ClassLoader classLoader = null;</span><br><span class="line">    Log logger = null;</span><br><span class="line">    try (FileInputStream fis = new FileInputStream(file.getAbsolutePath());</span><br><span class="line">            BufferedInputStream bis = new BufferedInputStream(fis)) &#123;</span><br><span class="line">        Context c = getContext();</span><br><span class="line">        loader = c.getLoader();</span><br><span class="line">        logger = c.getLogger();</span><br><span class="line">        if (loader != null) &#123;</span><br><span class="line">            classLoader = loader.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        if (classLoader == null) &#123;</span><br><span class="line">            classLoader = getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Load the previously unloaded active sessions</span><br><span class="line">        synchronized (sessions) &#123;</span><br><span class="line">            try (ObjectInputStream ois = new CustomObjectInputStream(bis, classLoader, logger,</span><br><span class="line">                    getSessionAttributeValueClassNamePattern(),</span><br><span class="line">                    getWarnOnSessionAttributeFilterFailure())) &#123;</span><br><span class="line">                //磁盘中的session数量</span><br><span class="line">                Integer count = (Integer) ois.readObject();</span><br><span class="line">                int n = count.intValue();</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;Loading &quot; + n + &quot; persisted sessions&quot;);</span><br><span class="line">                for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">                    //创建session</span><br><span class="line">                    StandardSession session = getNewSession();</span><br><span class="line">                    //读取磁盘中的session文件</span><br><span class="line">                    session.readObjectData(ois);</span><br><span class="line">                    session.setManager(this);</span><br><span class="line">                    sessions.put(session.getIdInternal(), session);</span><br><span class="line">                    session.activate();</span><br><span class="line">                    if (!session.isValidInternal()) &#123;</span><br><span class="line">                        // If session is already invalid,</span><br><span class="line">                        // expire session to prevent memory leak.</span><br><span class="line">                        session.setValid(true);</span><br><span class="line">                        session.expire();</span><br><span class="line">                    &#125;</span><br><span class="line">                    sessionCounter++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                // Delete the persistent storage file</span><br><span class="line">                if (file.exists()) &#123;</span><br><span class="line">                    file.delete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">        if (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(&quot;No persisted data file found&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Finish: Loading persisted sessions&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、后台线程"><a href="#二、后台线程" class="headerlink" title="二、后台线程"></a>二、后台线程</h3><h4 id="1、ContainerBackgroundProcessor的run方法"><a href="#1、ContainerBackgroundProcessor的run方法" class="headerlink" title="1、ContainerBackgroundProcessor的run方法"></a>1、ContainerBackgroundProcessor的run方法</h4><p>后台线程，实现热部署、管理过期session<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    Throwable t = null;</span><br><span class="line">    String unexpectedDeathMessage = sm.getString(</span><br><span class="line">            &quot;containerBase.backgroundProcess.unexpectedThreadDeath&quot;,</span><br><span class="line">            Thread.currentThread().getName());</span><br><span class="line">    try &#123;</span><br><span class="line">        while (!threadDone) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //后台线程执行间隔</span><br><span class="line">                Thread.sleep(backgroundProcessorDelay * 1000L);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                // Ignore</span><br><span class="line">            &#125;</span><br><span class="line">            if (!threadDone) &#123;</span><br><span class="line">                //部署容器</span><br><span class="line">                processChildren(ContainerBase.this);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (RuntimeException|Error e) &#123;</span><br><span class="line">        t = e;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (!threadDone) &#123;</span><br><span class="line">            log.error(unexpectedDeathMessage, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、ContainerBackgroundProcessor的processChildren方法"><a href="#2、ContainerBackgroundProcessor的processChildren方法" class="headerlink" title="2、ContainerBackgroundProcessor的processChildren方法"></a>2、ContainerBackgroundProcessor的processChildren方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected void processChildren(Container container) &#123;</span><br><span class="line">    ClassLoader originalClassLoader = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (container instanceof Context) &#123;</span><br><span class="line">            Loader loader = ((Context) container).getLoader();</span><br><span class="line">            // Loader will be null for FailedContext instances</span><br><span class="line">            if (loader == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Ensure background processing for Contexts and Wrappers</span><br><span class="line">            // is performed under the web app&apos;s class loader</span><br><span class="line">            // 设置类加载器，ParallelWebappClassLoader</span><br><span class="line">            originalClassLoader = ((Context) container).bind(false, null);</span><br><span class="line">        &#125;</span><br><span class="line">        //容器后台线程</span><br><span class="line">        container.backgroundProcess();</span><br><span class="line">        //子容器后台线程</span><br><span class="line">        Container[] children = container.findChildren();</span><br><span class="line">        for (int i = 0; i &lt; children.length; i++) &#123;</span><br><span class="line">            if (children[i].getBackgroundProcessorDelay() &lt;= 0) &#123;</span><br><span class="line">                processChildren(children[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        log.error(&quot;Exception invoking periodic operation: &quot;, t);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (container instanceof Context) &#123;</span><br><span class="line">            ((Context) container).unbind(false, originalClassLoader);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、StandardContext的backgroundProcess方法"><a href="#3、StandardContext的backgroundProcess方法" class="headerlink" title="3、StandardContext的backgroundProcess方法"></a>3、StandardContext的backgroundProcess方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void backgroundProcess() &#123;</span><br><span class="line"></span><br><span class="line">    if (!getState().isAvailable())</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    Loader loader = getLoader();</span><br><span class="line">    if (loader != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //重启context</span><br><span class="line">            loader.backgroundProcess();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(</span><br><span class="line">                    &quot;standardContext.backgroundProcess.loader&quot;, loader), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Manager manager = getManager();</span><br><span class="line">    if (manager != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //失效过期的session</span><br><span class="line">            manager.backgroundProcess();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(</span><br><span class="line">                    &quot;standardContext.backgroundProcess.manager&quot;, manager),</span><br><span class="line">                    e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    WebResourceRoot resources = getResources();</span><br><span class="line">    if (resources != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //清除过期的Web应用的资源缓存</span><br><span class="line">            resources.backgroundProcess();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(</span><br><span class="line">                    &quot;standardContext.backgroundProcess.resources&quot;,</span><br><span class="line">                    resources), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    InstanceManager instanceManager = getInstanceManager();</span><br><span class="line">    if (instanceManager instanceof DefaultInstanceManager) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //清除annotationCache中，过期的key</span><br><span class="line">            ((DefaultInstanceManager)instanceManager).backgroundProcess();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(</span><br><span class="line">                    &quot;standardContext.backgroundProcess.instanceManager&quot;,</span><br><span class="line">                    resources), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //执行cluster、realm、Valve的后台线程</span><br><span class="line">    super.backgroundProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、注册容器映射"><a href="#三、注册容器映射" class="headerlink" title="三、注册容器映射"></a>三、注册容器映射</h3><h4 id="1、MapperListener的containerEvent方法"><a href="#1、MapperListener的containerEvent方法" class="headerlink" title="1、MapperListener的containerEvent方法"></a>1、MapperListener的containerEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void containerEvent(ContainerEvent event) &#123;</span><br><span class="line">    //添加容器事件</span><br><span class="line">    if (Container.ADD_CHILD_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        Container child = (Container) event.getData();</span><br><span class="line">        //给子容器注册监听器</span><br><span class="line">        addListeners(child);</span><br><span class="line">        // If child is started then it is too late for life-cycle listener</span><br><span class="line">        // to register the child so register it here</span><br><span class="line">        if (child.getState().isAvailable()) &#123;</span><br><span class="line">            if (child instanceof Host) &#123;</span><br><span class="line">                //注册Host</span><br><span class="line">                registerHost((Host) child);</span><br><span class="line">            &#125; else if (child instanceof Context) &#123;</span><br><span class="line">                //注册Context</span><br><span class="line">                registerContext((Context) child);</span><br><span class="line">            &#125; else if (child instanceof Wrapper) &#123;</span><br><span class="line">                // Only if the Context has started. If it has not, then it</span><br><span class="line">                // will have its own &quot;after_start&quot; life-cycle event later.</span><br><span class="line">                if (child.getParent().getState().isAvailable()) &#123;</span><br><span class="line">                    //注册Wrapper</span><br><span class="line">                    registerWrapper((Wrapper) child);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    //移除容器事件</span><br><span class="line">    &#125; else if (Container.REMOVE_CHILD_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        Container child = (Container) event.getData();</span><br><span class="line">        removeListeners(child);</span><br><span class="line">        // No need to unregister - life-cycle listener will handle this when</span><br><span class="line">        // the child stops</span><br><span class="line">    //添加Host别名事件</span><br><span class="line">    &#125; else if (Host.ADD_ALIAS_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically adding host aliases</span><br><span class="line">        mapper.addHostAlias(((Host) event.getSource()).getName(),</span><br><span class="line">                event.getData().toString());</span><br><span class="line">    //移除Host别名事件</span><br><span class="line">    &#125; else if (Host.REMOVE_ALIAS_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically removing host aliases</span><br><span class="line">        mapper.removeHostAlias(event.getData().toString());</span><br><span class="line">    //warper添加mapping事件</span><br><span class="line">    &#125; else if (Wrapper.ADD_MAPPING_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically adding wrappers</span><br><span class="line">        //获取warpper对象</span><br><span class="line">        Wrapper wrapper = (Wrapper) event.getSource();</span><br><span class="line">        //获取warpper所属的context</span><br><span class="line">        Context context = (Context) wrapper.getParent();</span><br><span class="line">        //获取context的path</span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        String version = context.getWebappVersion();</span><br><span class="line">        String hostName = context.getParent().getName();</span><br><span class="line">        String wrapperName = wrapper.getName();</span><br><span class="line">        //要map的路径</span><br><span class="line">        String mapping = (String) event.getData();</span><br><span class="line">        boolean jspWildCard = (&quot;jsp&quot;.equals(wrapperName)</span><br><span class="line">                &amp;&amp; mapping.endsWith(&quot;/*&quot;));</span><br><span class="line">        //注册warpper</span><br><span class="line">        mapper.addWrapper(hostName, contextPath, version, mapping, wrapper,</span><br><span class="line">                jspWildCard, context.isResourceOnlyServlet(wrapperName));</span><br><span class="line">    //warper移除mapping事件</span><br><span class="line">    &#125; else if (Wrapper.REMOVE_MAPPING_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically removing wrappers</span><br><span class="line">        Wrapper wrapper = (Wrapper) event.getSource();</span><br><span class="line"></span><br><span class="line">        Context context = (Context) wrapper.getParent();</span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        String version = context.getWebappVersion();</span><br><span class="line">        String hostName = context.getParent().getName();</span><br><span class="line"></span><br><span class="line">        String mapping = (String) event.getData();</span><br><span class="line"></span><br><span class="line">        mapper.removeWrapper(hostName, contextPath, version, mapping);</span><br><span class="line">    //addWelcomeFile事件</span><br><span class="line">    &#125; else if (Context.ADD_WELCOME_FILE_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically adding welcome files</span><br><span class="line">        Context context = (Context) event.getSource();</span><br><span class="line"></span><br><span class="line">        String hostName = context.getParent().getName();</span><br><span class="line"></span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String welcomeFile = (String) event.getData();</span><br><span class="line"></span><br><span class="line">        mapper.addWelcomeFile(hostName, contextPath,</span><br><span class="line">                context.getWebappVersion(), welcomeFile);</span><br><span class="line">    &#125; else if (Context.REMOVE_WELCOME_FILE_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically removing welcome files</span><br><span class="line">        Context context = (Context) event.getSource();</span><br><span class="line"></span><br><span class="line">        String hostName = context.getParent().getName();</span><br><span class="line"></span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String welcomeFile = (String) event.getData();</span><br><span class="line"></span><br><span class="line">        mapper.removeWelcomeFile(hostName, contextPath,</span><br><span class="line">                context.getWebappVersion(), welcomeFile);</span><br><span class="line">    &#125; else if (Context.CLEAR_WELCOME_FILES_EVENT.equals(event.getType())) &#123;</span><br><span class="line">        // Handle dynamically clearing welcome files</span><br><span class="line">        Context context = (Context) event.getSource();</span><br><span class="line"></span><br><span class="line">        String hostName = context.getParent().getName();</span><br><span class="line"></span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mapper.clearWelcomeFiles(hostName, contextPath,</span><br><span class="line">                context.getWebappVersion());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、MapperListener的registerContext方法"><a href="#2、MapperListener的registerContext方法" class="headerlink" title="2、MapperListener的registerContext方法"></a>2、MapperListener的registerContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void registerContext(Context context) &#123;</span><br><span class="line">    //获取context的path</span><br><span class="line">    String contextPath = context.getPath();</span><br><span class="line">    if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">        contextPath = &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取host</span><br><span class="line">    Host host = (Host)context.getParent();</span><br><span class="line">    //获取root</span><br><span class="line">    WebResourceRoot resources = context.getResources();</span><br><span class="line">    //获取welcomeFile</span><br><span class="line">    String[] welcomeFiles = context.findWelcomeFiles();</span><br><span class="line">    List&lt;WrapperMappingInfo&gt; wrappers = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    //获取warpper中的mapping信息</span><br><span class="line">    for (Container container : context.findChildren()) &#123;</span><br><span class="line">        prepareWrapperMappingInfo(context, (Wrapper) container, wrappers);</span><br><span class="line"></span><br><span class="line">        if(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(&quot;mapperListener.registerWrapper&quot;,</span><br><span class="line">                    container.getName(), contextPath, service));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加context的map，容器按name排序存放在Mapper中</span><br><span class="line">    mapper.addContextVersion(host.getName(), host, contextPath,</span><br><span class="line">            context.getWebappVersion(), context, welcomeFiles, resources,</span><br><span class="line">            wrappers);</span><br><span class="line"></span><br><span class="line">    if(log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(sm.getString(&quot;mapperListener.registerContext&quot;,</span><br><span class="line">                contextPath, service));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、MapperListener的registerContext方法"><a href="#3、MapperListener的registerContext方法" class="headerlink" title="3、MapperListener的registerContext方法"></a>3、MapperListener的registerContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private void registerWrapper(Wrapper wrapper) &#123;</span><br><span class="line">    //获取所属的context对象</span><br><span class="line">    Context context = (Context) wrapper.getParent();</span><br><span class="line">    //获取context的path</span><br><span class="line">    String contextPath = context.getPath();</span><br><span class="line">    if (&quot;/&quot;.equals(contextPath)) &#123;</span><br><span class="line">        contextPath = &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    //webapp的版本</span><br><span class="line">    String version = context.getWebappVersion();</span><br><span class="line">    String hostName = context.getParent().getName();</span><br><span class="line"></span><br><span class="line">    List&lt;WrapperMappingInfo&gt; wrappers = new ArrayList&lt;&gt;();</span><br><span class="line">    //获取warpper中的mapping信息</span><br><span class="line">    prepareWrapperMappingInfo(context, wrapper, wrappers);</span><br><span class="line">    //添加warpper的map，容器按name排序存放在Mapper中</span><br><span class="line">    mapper.addWrappers(hostName, contextPath, version, wrappers);</span><br><span class="line"></span><br><span class="line">    if(log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(sm.getString(&quot;mapperListener.registerWrapper&quot;,</span><br><span class="line">                wrapper.getName(), contextPath, service));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>