<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="demo12345@FeignClientpublic interface DemoClient &amp;#123;	@RequestMapping(value = &amp;quot;/findUser/&amp;#123;name&amp;#125;&amp;quot;, method = RequestMethod.GET)	pu"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="SpringCloud服务端"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="demo12345@FeignClientpublic interface DemoClient &amp;#123;	@RequestMapping(value = &amp;quot;/findUser/&amp;#123;name&amp;#125;&amp;quot;, method = RequestMethod.GET)	pu"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>SpringCloud服务端 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>SpringCloud服务端</h1>
                    
                    <h2 class="post-subheading">
                        服务发现、FeignClient、负载均衡及服务容错
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2019-01-03
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/springcloud/">springcloud</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient</span><br><span class="line">public interface DemoClient &#123;</span><br><span class="line">	@RequestMapping(value = &quot;/findUser/&#123;name&#125;&quot;, method = RequestMethod.GET)</span><br><span class="line">	public List&lt;User&gt; findAll(@PathVariable(&quot;name&quot;) String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1、服务发现"><a href="#1、服务发现" class="headerlink" title="1、服务发现"></a>1、服务发现</h4><p>启动类添加注解@EnableDiscoveryClient，由spring-cloud-netflix-eureka-client.jar包下spring.factories文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.cloud.client.discovery.EnableDiscoveryClient=\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration</span><br></pre></td></tr></table></figure></p>
<p>Spring继续加载EurekaDiscoveryClientConfiguration配置类，该类中通过@Autowired方式注入了DiscoveryClient的代理类。<br>容器refresh刷新时DefaultLifecycleProcessor会执行EurekaDiscoveryClientConfiguration的start方法，创建DiscoveryClient。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, DiscoveryClientOptionalArgs args,</span><br><span class="line">                Provider&lt;BackupRegistry&gt; backupRegistryProvider) &#123;</span><br><span class="line">    if (args != null) &#123;</span><br><span class="line">        this.healthCheckHandlerProvider = args.healthCheckHandlerProvider;</span><br><span class="line">        this.healthCheckCallbackProvider = args.healthCheckCallbackProvider;</span><br><span class="line">        this.eventListeners.addAll(args.getEventListeners());</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.healthCheckCallbackProvider = null;</span><br><span class="line">        this.healthCheckHandlerProvider = null;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    this.applicationInfoManager = applicationInfoManager;</span><br><span class="line">    //本服务的InstanceInfo</span><br><span class="line">    InstanceInfo myInfo = applicationInfoManager.getInfo();</span><br><span class="line"></span><br><span class="line">    clientConfig = config;</span><br><span class="line">    staticClientConfig = clientConfig;</span><br><span class="line">    transportConfig = config.getTransportConfig();</span><br><span class="line">    instanceInfo = myInfo;</span><br><span class="line">    if (myInfo != null) &#123;</span><br><span class="line">        appPathIdentifier = instanceInfo.getAppName() + &quot;/&quot; + instanceInfo.getId();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        logger.warn(&quot;Setting instanceInfo to a passed in null value&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.backupRegistryProvider = backupRegistryProvider;</span><br><span class="line"></span><br><span class="line">    this.urlRandomizer = new EndpointUtils.InstanceInfoBasedUrlRandomizer(instanceInfo);</span><br><span class="line">    localRegionApps.set(new Applications());</span><br><span class="line"></span><br><span class="line">    fetchRegistryGeneration = new AtomicLong(0);</span><br><span class="line"></span><br><span class="line">    remoteRegionsToFetch = new AtomicReference&lt;String&gt;(clientConfig.fetchRegistryForRemoteRegions());</span><br><span class="line">    remoteRegionsRef = new AtomicReference&lt;&gt;(remoteRegionsToFetch.get() == null ? null : remoteRegionsToFetch.get().split(&quot;,&quot;));</span><br><span class="line"></span><br><span class="line">    if (config.shouldFetchRegistry()) &#123;</span><br><span class="line">        this.registryStalenessMonitor = new ThresholdLevelsMetric(this, METRIC_REGISTRY_PREFIX + &quot;lastUpdateSec_&quot;, new long[]&#123;15L, 30L, 60L, 120L, 240L, 480L&#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.registryStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (config.shouldRegisterWithEureka()) &#123;</span><br><span class="line">        this.heartbeatStalenessMonitor = new ThresholdLevelsMetric(this, METRIC_REGISTRATION_PREFIX + &quot;lastHeartbeatSec_&quot;, new long[]&#123;15L, 30L, 60L, 120L, 240L, 480L&#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.heartbeatStalenessMonitor = ThresholdLevelsMetric.NO_OP_METRIC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!config.shouldRegisterWithEureka() &amp;&amp; !config.shouldFetchRegistry()) &#123;</span><br><span class="line">        logger.info(&quot;Client configured to neither register nor query for data.&quot;);</span><br><span class="line">        scheduler = null;</span><br><span class="line">        heartbeatExecutor = null;</span><br><span class="line">        cacheRefreshExecutor = null;</span><br><span class="line">        eurekaTransport = null;</span><br><span class="line">        instanceRegionChecker = new InstanceRegionChecker(new PropertyBasedAzToRegionMapper(config), clientConfig.getRegion());</span><br><span class="line"></span><br><span class="line">        // This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span><br><span class="line">        // to work with DI&apos;d DiscoveryClient</span><br><span class="line">        DiscoveryManager.getInstance().setDiscoveryClient(this);</span><br><span class="line">        DiscoveryManager.getInstance().setEurekaClientConfig(config);</span><br><span class="line"></span><br><span class="line">        initTimestampMs = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        logger.info(&quot;Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;&quot;,</span><br><span class="line">                initTimestampMs, this.getApplications().size());</span><br><span class="line">        return;  // no need to setup up an network tasks and we are done</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //线程池</span><br><span class="line">        scheduler = Executors.newScheduledThreadPool(3,</span><br><span class="line">                new ThreadFactoryBuilder()</span><br><span class="line">                        .setNameFormat(&quot;DiscoveryClient-%d&quot;)</span><br><span class="line">                        .setDaemon(true)</span><br><span class="line">                        .build());</span><br><span class="line">        //心跳检测线程池</span><br><span class="line">        heartbeatExecutor = new ThreadPoolExecutor(</span><br><span class="line">                1, clientConfig.getHeartbeatExecutorThreadPoolSize(), 0, TimeUnit.SECONDS,</span><br><span class="line">                new SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">                new ThreadFactoryBuilder()</span><br><span class="line">                        .setNameFormat(&quot;DiscoveryClient-HeartbeatExecutor-%d&quot;)</span><br><span class="line">                        .setDaemon(true)</span><br><span class="line">                        .build()</span><br><span class="line">        );  // use direct handoff</span><br><span class="line">        //刷新缓存线程池</span><br><span class="line">        cacheRefreshExecutor = new ThreadPoolExecutor(</span><br><span class="line">                1, clientConfig.getCacheRefreshExecutorThreadPoolSize(), 0, TimeUnit.SECONDS,</span><br><span class="line">                new SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">                new ThreadFactoryBuilder()</span><br><span class="line">                        .setNameFormat(&quot;DiscoveryClient-CacheRefreshExecutor-%d&quot;)</span><br><span class="line">                        .setDaemon(true)</span><br><span class="line">                        .build()</span><br><span class="line">        );  // use direct handoff</span><br><span class="line">        //创建与Sever通信工具</span><br><span class="line">        eurekaTransport = new EurekaTransport();</span><br><span class="line">        scheduleServerEndpointTask(eurekaTransport, args);</span><br><span class="line"></span><br><span class="line">        AzToRegionMapper azToRegionMapper;</span><br><span class="line">        if (clientConfig.shouldUseDnsForFetchingServiceUrls()) &#123;</span><br><span class="line">            azToRegionMapper = new DNSBasedAzToRegionMapper(clientConfig);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            azToRegionMapper = new PropertyBasedAzToRegionMapper(clientConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        if (null != remoteRegionsToFetch.get()) &#123;</span><br><span class="line">            azToRegionMapper.setRegionsToFetch(remoteRegionsToFetch.get().split(&quot;,&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        instanceRegionChecker = new InstanceRegionChecker(azToRegionMapper, clientConfig.getRegion());</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Failed to initialize DiscoveryClient!&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">    //通过fetchRegistry方法首次从远程Server端拉取服务信息缓存到客户端本地，默认选择增量拉取</span><br><span class="line">    if (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(false)) &#123;</span><br><span class="line">        fetchRegistryFromBackup();</span><br><span class="line">    &#125;</span><br><span class="line">    //初始化线程池任务</span><br><span class="line">    initScheduledTasks();</span><br><span class="line">    try &#123;</span><br><span class="line">        Monitors.registerObject(this);</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        logger.warn(&quot;Cannot register timers&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This is a bit of hack to allow for existing code using DiscoveryManager.getInstance()</span><br><span class="line">    // to work with DI&apos;d DiscoveryClient</span><br><span class="line">    DiscoveryManager.getInstance().setDiscoveryClient(this);</span><br><span class="line">    DiscoveryManager.getInstance().setEurekaClientConfig(config);</span><br><span class="line"></span><br><span class="line">    initTimestampMs = System.currentTimeMillis();</span><br><span class="line">    logger.info(&quot;Discovery Client initialized at timestamp &#123;&#125; with initial instances count: &#123;&#125;&quot;,</span><br><span class="line">            initTimestampMs, this.getApplications().size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">private void initScheduledTasks() &#123;</span><br><span class="line">    //是否从注册中心获取服务</span><br><span class="line">    if (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">        // registry cache refresh timer</span><br><span class="line">        int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">        int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">        //定时任务定时执行客户端远程拉取服务来更新客户端本地缓存</span><br><span class="line">        scheduler.schedule(</span><br><span class="line">                new TimedSupervisorTask(</span><br><span class="line">                        &quot;cacheRefresh&quot;,</span><br><span class="line">                        scheduler,</span><br><span class="line">                        cacheRefreshExecutor,</span><br><span class="line">                        registryFetchIntervalSeconds,</span><br><span class="line">                        TimeUnit.SECONDS,</span><br><span class="line">                        expBackOffBound,</span><br><span class="line">                        new CacheRefreshThread()</span><br><span class="line">                ),</span><br><span class="line">                registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    //是否向注册中心注册服务</span><br><span class="line">    if (clientConfig.shouldRegisterWithEureka()) &#123;</span><br><span class="line">        int renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">        int expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">        logger.info(&quot;Starting heartbeat executor: &quot; + &quot;renew interval is: &quot; + renewalIntervalInSecs);</span><br><span class="line"></span><br><span class="line">        // Heartbeat timer</span><br><span class="line">        scheduler.schedule(</span><br><span class="line">                new TimedSupervisorTask(</span><br><span class="line">                        &quot;heartbeat&quot;,</span><br><span class="line">                        scheduler,</span><br><span class="line">                        heartbeatExecutor,</span><br><span class="line">                        renewalIntervalInSecs,</span><br><span class="line">                        TimeUnit.SECONDS,</span><br><span class="line">                        expBackOffBound,</span><br><span class="line">                        new HeartbeatThread()</span><br><span class="line">                ),</span><br><span class="line">                renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        // InstanceInfo replicator</span><br><span class="line">        instanceInfoReplicator = new InstanceInfoReplicator(</span><br><span class="line">                this,</span><br><span class="line">                instanceInfo,</span><br><span class="line">                clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">                2); // burstSize</span><br><span class="line"></span><br><span class="line">        statusChangeListener = new ApplicationInfoManager.StatusChangeListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public String getId() &#123;</span><br><span class="line">                return &quot;statusChangeListener&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void notify(StatusChangeEvent statusChangeEvent) &#123;</span><br><span class="line">                if (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">                        InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) &#123;</span><br><span class="line">                    // log at warn level if DOWN was involved</span><br><span class="line">                    logger.warn(&quot;Saw local status change event &#123;&#125;&quot;, statusChangeEvent);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    logger.info(&quot;Saw local status change event &#123;&#125;&quot;, statusChangeEvent);</span><br><span class="line">                &#125;</span><br><span class="line">                instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        if (clientConfig.shouldOnDemandUpdateStatusChange()) &#123;</span><br><span class="line">            applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        logger.info(&quot;Not registering with Eureka server per configuration&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CacheRefreshThread线程中通过fetchRegistry方法来拉取服务信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">private boolean fetchRegistry(boolean forceFullRegistryFetch) &#123;</span><br><span class="line">    Stopwatch tracer = FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // If the delta is disabled or if it is the first time, get all</span><br><span class="line">        // applications</span><br><span class="line">        //本地缓存中获取服务信息，其中维护来一个Application的队列，Application为一个服务，</span><br><span class="line">        //每个Application又维护来一个InstanceInfo无序集合，InstanceInfo为一个服务实例</span><br><span class="line">        Applications applications = getApplications();</span><br><span class="line"></span><br><span class="line">        if (clientConfig.shouldDisableDelta()</span><br><span class="line">                || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</span><br><span class="line">                || forceFullRegistryFetch</span><br><span class="line">                || (applications == null)</span><br><span class="line">                || (applications.getRegisteredApplications().size() == 0)</span><br><span class="line">                || (applications.getVersion() == -1)) //Client application does not have latest library supporting delta</span><br><span class="line">        &#123;</span><br><span class="line">            //全量拉取服务信息</span><br><span class="line">            getAndStoreFullRegistry();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //增量拉取服务信息</span><br><span class="line">            getAndUpdateDelta(applications);</span><br><span class="line">        &#125;</span><br><span class="line">        //更新hashCode，根据hashCode判断服务信息是否变化</span><br><span class="line">        applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">        logTotalInstances();</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        logger.error(PREFIX + appPathIdentifier + &quot; - was unable to refresh its cache! status = &quot; + e.getMessage(), e);</span><br><span class="line">        return false;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (tracer != null) &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Notify about cache refresh before updating the instance remote status</span><br><span class="line">    //通知缓存刷新事件</span><br><span class="line">    onCacheRefreshed();</span><br><span class="line"></span><br><span class="line">    // Update remote status based on refreshed data held in the cache</span><br><span class="line">    //更新实例的远程状态</span><br><span class="line">    updateInstanceRemoteStatus();</span><br><span class="line"></span><br><span class="line">    // registry was fetched successfully, so return true</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、FeignClient的创建"><a href="#2、FeignClient的创建" class="headerlink" title="2、FeignClient的创建"></a>2、FeignClient的创建</h4><p>在SpringBoot启动类添加@EnableFeignClients注解，开启FeignClient功能。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Import(FeignClientsRegistrar.class)</span><br><span class="line">public @interface EnableFeignClients &#123;</span><br><span class="line">    ...</span><br><span class="line">｝</span><br></pre></td></tr></table></figure></p>
<p>通过Import添加FeignClientsRegistrar Bean,<br>Spring的ConfigurationClassPostProcessor处理器解析配置类时，会执行FeignClientsRegistrar的registerBeanDefinitions方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   @Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata metadata,</span><br><span class="line">		BeanDefinitionRegistry registry) &#123;</span><br><span class="line">	//加载配置文件</span><br><span class="line">	registerDefaultConfiguration(metadata, registry);</span><br><span class="line">	//加载Client客户端</span><br><span class="line">	registerFeignClients(metadata, registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加载Client客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">   public void registerFeignClients(AnnotationMetadata metadata,</span><br><span class="line">		BeanDefinitionRegistry registry) &#123;</span><br><span class="line">	//扫描器</span><br><span class="line">	ClassPathScanningCandidateComponentProvider scanner = getScanner();</span><br><span class="line">	scanner.setResourceLoader(this.resourceLoader);</span><br><span class="line">	Set&lt;String&gt; basePackages;</span><br><span class="line"></span><br><span class="line">	Map&lt;String, Object&gt; attrs = metadata</span><br><span class="line">			.getAnnotationAttributes(EnableFeignClients.class.getName());</span><br><span class="line">	//注解过FeignClient的类的过滤器</span><br><span class="line">	AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(</span><br><span class="line">			FeignClient.class);</span><br><span class="line">	final Class&lt;?&gt;[] clients = attrs == null ? null</span><br><span class="line">			: (Class&lt;?&gt;[]) attrs.get(&quot;clients&quot;);</span><br><span class="line">	if (clients == null || clients.length == 0) &#123;</span><br><span class="line">		scanner.addIncludeFilter(annotationTypeFilter);</span><br><span class="line">		//从EnableFeignClients中获取扫描的包路径</span><br><span class="line">		basePackages = getBasePackages(metadata);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		final Set&lt;String&gt; clientClasses = new HashSet&lt;&gt;();</span><br><span class="line">		basePackages = new HashSet&lt;&gt;();</span><br><span class="line">		for (Class&lt;?&gt; clazz : clients) &#123;</span><br><span class="line">			basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">			clientClasses.add(clazz.getCanonicalName());</span><br><span class="line">		&#125;</span><br><span class="line">		AbstractClassTestingTypeFilter filter = new AbstractClassTestingTypeFilter() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			protected boolean match(ClassMetadata metadata) &#123;</span><br><span class="line">				String cleaned = metadata.getClassName().replaceAll(&quot;\\$&quot;, &quot;.&quot;);</span><br><span class="line">				return clientClasses.contains(cleaned);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		scanner.addIncludeFilter(</span><br><span class="line">				new AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for (String basePackage : basePackages) &#123;</span><br><span class="line">		Set&lt;BeanDefinition&gt; candidateComponents = scanner</span><br><span class="line">				.findCandidateComponents(basePackage);</span><br><span class="line">		for (BeanDefinition candidateComponent : candidateComponents) &#123;</span><br><span class="line">			if (candidateComponent instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">				// verify annotated class is an interface</span><br><span class="line">				AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;</span><br><span class="line">				AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();</span><br><span class="line">				Assert.isTrue(annotationMetadata.isInterface(),</span><br><span class="line">						&quot;@FeignClient can only be specified on an interface&quot;);</span><br><span class="line"></span><br><span class="line">				Map&lt;String, Object&gt; attributes = annotationMetadata</span><br><span class="line">						.getAnnotationAttributes(</span><br><span class="line">								FeignClient.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line">				String name = getClientName(attributes);</span><br><span class="line">				registerClientConfiguration(registry, name,</span><br><span class="line">						attributes.get(&quot;configuration&quot;));</span><br><span class="line">                   //创建Client</span><br><span class="line">				registerFeignClient(registry, annotationMetadata, attributes);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private void registerFeignClient(BeanDefinitionRegistry registry,</span><br><span class="line">		AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) &#123;</span><br><span class="line">	String className = annotationMetadata.getClassName();</span><br><span class="line">	//通过FeignClientFactoryBean创建bean，创建bean时会调用FeignClientFactoryBean的getObject()方法</span><br><span class="line">	BeanDefinitionBuilder definition = BeanDefinitionBuilder</span><br><span class="line">			.genericBeanDefinition(FeignClientFactoryBean.class);</span><br><span class="line">	validate(attributes);</span><br><span class="line">	definition.addPropertyValue(&quot;url&quot;, getUrl(attributes));</span><br><span class="line">	definition.addPropertyValue(&quot;path&quot;, getPath(attributes));</span><br><span class="line">	String name = getName(attributes);</span><br><span class="line">	definition.addPropertyValue(&quot;name&quot;, name);</span><br><span class="line">	definition.addPropertyValue(&quot;type&quot;, className);</span><br><span class="line">	definition.addPropertyValue(&quot;decode404&quot;, attributes.get(&quot;decode404&quot;));</span><br><span class="line">	definition.addPropertyValue(&quot;fallback&quot;, attributes.get(&quot;fallback&quot;));</span><br><span class="line">	definition.addPropertyValue(&quot;fallbackFactory&quot;, attributes.get(&quot;fallbackFactory&quot;));</span><br><span class="line">	definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line"></span><br><span class="line">	String alias = name + &quot;FeignClient&quot;;</span><br><span class="line">	AbstractBeanDefinition beanDefinition = definition.getBeanDefinition();</span><br><span class="line">	beanDefinition.setPrimary(true);</span><br><span class="line"></span><br><span class="line">	String qualifier = getQualifier(attributes);</span><br><span class="line">	if (StringUtils.hasText(qualifier)) &#123;</span><br><span class="line">		alias = qualifier;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className,</span><br><span class="line">			new String[] &#123; alias &#125;);</span><br><span class="line">	BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring容器在创建Bean时执行FeignClientFactoryBean的getObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	public Object getObject() throws Exception &#123;</span><br><span class="line">		FeignContext context = applicationContext.getBean(FeignContext.class);</span><br><span class="line">		Feign.Builder builder = feign(context);</span><br><span class="line">        //未发现url配置则使用负载均衡Client</span><br><span class="line">		if (!StringUtils.hasText(this.url)) &#123;</span><br><span class="line">			String url;</span><br><span class="line">			if (!this.name.startsWith(&quot;http&quot;)) &#123;</span><br><span class="line">				url = &quot;http://&quot; + this.name;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				url = this.name;</span><br><span class="line">			&#125;</span><br><span class="line">			url += cleanPath();</span><br><span class="line">			return loadBalance(builder, context, new HardCodedTarget&lt;&gt;(this.type,</span><br><span class="line">					this.name, url));</span><br><span class="line">		&#125;</span><br><span class="line">		if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith(&quot;http&quot;)) &#123;</span><br><span class="line">			this.url = &quot;http://&quot; + this.url;</span><br><span class="line">		&#125;</span><br><span class="line">		String url = this.url + cleanPath();</span><br><span class="line">		Client client = getOptional(context, Client.class);</span><br><span class="line">		//不使用负载均衡Client，如果是则取出被代理的client</span><br><span class="line">		if (client != null) &#123;</span><br><span class="line">			if (client instanceof LoadBalancerFeignClient) &#123;</span><br><span class="line">				// not lod balancing because we have a url,</span><br><span class="line">				// but ribbon is on the classpath, so unwrap</span><br><span class="line">				client = ((LoadBalancerFeignClient)client).getDelegate();</span><br><span class="line">			&#125;</span><br><span class="line">			builder.client(client);</span><br><span class="line">		&#125;</span><br><span class="line">		Targeter targeter = get(context, Targeter.class);</span><br><span class="line">		return targeter.target(this, builder, context, new HardCodedTarget&lt;&gt;(</span><br><span class="line">				this.type, this.name, url));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、负载均衡"><a href="#3、负载均衡" class="headerlink" title="3、负载均衡"></a>3、负载均衡</h4><p>如果FeignClient注解未配置url，则使用客户端负载均衡，使用LoadBalancerFeignClient代理client<br>LoadBalancerFeignClient的execute方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   @Override</span><br><span class="line">public Response execute(Request request, Request.Options options) throws IOException &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		URI asUri = URI.create(request.url());</span><br><span class="line">		//@FeignClient中的name值即service-id</span><br><span class="line">		String clientName = asUri.getHost();</span><br><span class="line">		URI uriWithoutHost = cleanUrl(request.url(), clientName);</span><br><span class="line">		FeignLoadBalancer.RibbonRequest ribbonRequest = new FeignLoadBalancer.RibbonRequest(</span><br><span class="line">				this.delegate, request, uriWithoutHost);</span><br><span class="line"></span><br><span class="line">		IClientConfig requestConfig = getClientConfig(options, clientName);</span><br><span class="line">		//创建FeignLoadBalancer并通过负载均衡调用服务</span><br><span class="line">		return lbClient(clientName).executeWithLoadBalancer(ribbonRequest,</span><br><span class="line">				requestConfig).toResponse();</span><br><span class="line">	&#125;</span><br><span class="line">	catch (ClientException e) &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>FeignLoadBalancer中负载均衡器ILoadBalancer为DynamicServerListLoadBalancer，通过chooseServer获取服务。<br>每个service-id一个ILoadBalancer.DynamicServerListLoadBalancer父类BaseLoadBalancer中实现了chooseServer方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public Server chooseServer(Object key) &#123;</span><br><span class="line">    if (counter == null) &#123;</span><br><span class="line">        counter = createCounter();</span><br><span class="line">    &#125;</span><br><span class="line">    counter.increment();</span><br><span class="line">    if (rule == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //负载均衡策略，默认RoundRobinRule轮询策略</span><br><span class="line">            return rule.choose(key);</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>RoundRobinRule的choose方法，选择一个可用的Server<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public Server choose(ILoadBalancer lb, Object key) &#123;</span><br><span class="line">    if (lb == null) &#123;</span><br><span class="line">        log.warn(&quot;no load balancer&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Server server = null;</span><br><span class="line">    int count = 0;</span><br><span class="line">    //最多尝试10次</span><br><span class="line">    while (server == null &amp;&amp; count++ &lt; 10) &#123;</span><br><span class="line">        //获取可用的Server集合</span><br><span class="line">        List&lt;Server&gt; reachableServers = lb.getReachableServers();</span><br><span class="line">        //全部Server集合</span><br><span class="line">        List&lt;Server&gt; allServers = lb.getAllServers();</span><br><span class="line">        int upCount = reachableServers.size();</span><br><span class="line">        int serverCount = allServers.size();</span><br><span class="line"></span><br><span class="line">        if ((upCount == 0) || (serverCount == 0)) &#123;</span><br><span class="line">            log.warn(&quot;No up servers available from load balancer: &quot; + lb);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        //通过CAS方式，获取Server下标</span><br><span class="line">        int nextServerIndex = incrementAndGetModulo(serverCount);</span><br><span class="line">        server = allServers.get(nextServerIndex);</span><br><span class="line"></span><br><span class="line">        if (server == null) &#123;</span><br><span class="line">            /* Transient. */</span><br><span class="line">            Thread.yield();</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">            return (server);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Next.</span><br><span class="line">        server = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (count &gt;= 10) &#123;</span><br><span class="line">        log.warn(&quot;No available alive servers after 10 tries from load balancer: &quot;</span><br><span class="line">                + lb);</span><br><span class="line">    &#125;</span><br><span class="line">    return server;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>启动后会将updateAction加入PollingServerListUpdater的定时线程池，定时从eurekaClient中更新ServerList<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected final ServerListUpdater.UpdateAction updateAction = new ServerListUpdater.UpdateAction() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void doUpdate() &#123;</span><br><span class="line">        updateListOfServers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、服务容错"><a href="#4、服务容错" class="headerlink" title="4、服务容错"></a>4、服务容错</h4><p>Client的代理拦截器HystrixInvocationHandler的dispatch中维护了Client中的方法列表，fallbackMethodMap中维护了降级方法列表。<br>拦截器的invoke方法中创建了一个HystrixCommand对象，重载了run方法及getFallback方法，并执行了该对象的execute方法。<br>HystrixCommand的父类AbstractCommand的构造器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">protected AbstractCommand(HystrixCommandGroupKey group, HystrixCommandKey key, HystrixThreadPoolKey threadPoolKey, HystrixCircuitBreaker circuitBreaker, HystrixThreadPool threadPool,</span><br><span class="line">            HystrixCommandProperties.Setter commandPropertiesDefaults, HystrixThreadPoolProperties.Setter threadPoolPropertiesDefaults,</span><br><span class="line">            HystrixCommandMetrics metrics, TryableSemaphore fallbackSemaphore, TryableSemaphore executionSemaphore,</span><br><span class="line">            HystrixPropertiesStrategy propertiesStrategy, HystrixCommandExecutionHook executionHook) &#123;</span><br><span class="line">        //command所属分组默认为服务id</span><br><span class="line">        this.commandGroup = initGroupKey(group);</span><br><span class="line">        //默认为类名+方法名+参数类型</span><br><span class="line">        this.commandKey = initCommandKey(key, getClass());</span><br><span class="line">        this.properties = initCommandProperties(this.commandKey, propertiesStrategy, commandPropertiesDefaults);</span><br><span class="line">        //默认为服务id</span><br><span class="line">        this.threadPoolKey = initThreadPoolKey(threadPoolKey, this.commandGroup, this.properties.executionIsolationThreadPoolKeyOverride().get());</span><br><span class="line">        //创建HystrixCommandMetrics，一个commandKey一个，用来统计请求成功率</span><br><span class="line">        this.metrics = initMetrics(metrics, this.commandGroup, this.threadPoolKey, this.commandKey, this.properties);</span><br><span class="line">        //熔断器默认使用HystrixCircuitBreakerImpl，一个commandKey使用一个熔断器</span><br><span class="line">        this.circuitBreaker = initCircuitBreaker(this.properties.circuitBreakerEnabled().get(), circuitBreaker, this.commandGroup, this.commandKey, this.properties, this.metrics);</span><br><span class="line">        //服务线程池，默认使用HystrixThreadPoolDefault，一个threadPoolKey使用一个线程池</span><br><span class="line">        this.threadPool = initThreadPool(threadPool, this.threadPoolKey, threadPoolPropertiesDefaults);</span><br><span class="line"></span><br><span class="line">        //Strategies from plugins</span><br><span class="line">        this.eventNotifier = HystrixPlugins.getInstance().getEventNotifier();</span><br><span class="line">        this.concurrencyStrategy = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br><span class="line">        HystrixMetricsPublisherFactory.createOrRetrievePublisherForCommand(this.commandKey, this.commandGroup, this.metrics, this.circuitBreaker, this.properties);</span><br><span class="line">        this.executionHook = initExecutionHook(executionHook);</span><br><span class="line">        //缓存</span><br><span class="line">        this.requestCache = HystrixRequestCache.getInstance(this.commandKey, this.concurrencyStrategy);</span><br><span class="line">        this.currentRequestLog = initRequestLog(this.properties.requestLogEnabled().get(), this.concurrencyStrategy);</span><br><span class="line"></span><br><span class="line">        /* fallback semaphore override if applicable */</span><br><span class="line">        this.fallbackSemaphoreOverride = fallbackSemaphore;</span><br><span class="line"></span><br><span class="line">        /* execution semaphore override if applicable */</span><br><span class="line">        this.executionSemaphoreOverride = executionSemaphore;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>HystrixCommand的execute方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public R execute() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        return queue().get();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw decomposeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Future&lt;R&gt; queue() &#123;</span><br><span class="line">        //toObservable创建一个事件源</span><br><span class="line">        //toFuture订阅事件源并返回一个Future</span><br><span class="line">        final Future&lt;R&gt; delegate = toObservable().toBlocking().toFuture();</span><br><span class="line">    	...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>toObservable方法中的applyHystrixSemantics进一步执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">private Observable&lt;R&gt; applyHystrixSemantics(final AbstractCommand&lt;R&gt; _cmd) &#123;</span><br><span class="line">    // mark that we&apos;re starting execution on the ExecutionHook</span><br><span class="line">    // if this hook throws an exception, then a fast-fail occurs with no fallback.  No state is left inconsistent</span><br><span class="line">    executionHook.onStart(_cmd);</span><br><span class="line"></span><br><span class="line">    /* determine if we&apos;re allowed to execute */</span><br><span class="line">    //熔断器判断是否允许访问</span><br><span class="line">    if (circuitBreaker.allowRequest()) &#123;</span><br><span class="line">        //获取信号量隔离，一个commandKey一个TryableSemaphore</span><br><span class="line">        final TryableSemaphore executionSemaphore = getExecutionSemaphore();</span><br><span class="line">        final AtomicBoolean semaphoreHasBeenReleased = new AtomicBoolean(false);</span><br><span class="line">        final Action0 singleSemaphoreRelease = new Action0() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void call() &#123;</span><br><span class="line">                if (semaphoreHasBeenReleased.compareAndSet(false, true)) &#123;</span><br><span class="line">                    executionSemaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        final Action1&lt;Throwable&gt; markExceptionThrown = new Action1&lt;Throwable&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void call(Throwable t) &#123;</span><br><span class="line">                eventNotifier.markEvent(HystrixEventType.EXCEPTION_THROWN, commandKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //获取信号量</span><br><span class="line">        if (executionSemaphore.tryAcquire()) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                /* used to track userThreadExecutionTime */</span><br><span class="line">                executionResult = executionResult.setInvocationStartTime(System.currentTimeMillis());</span><br><span class="line">                //进一步执行</span><br><span class="line">                return executeCommandAndObserve(_cmd)</span><br><span class="line">                        .doOnError(markExceptionThrown)</span><br><span class="line">                        .doOnTerminate(singleSemaphoreRelease)</span><br><span class="line">                        .doOnUnsubscribe(singleSemaphoreRelease);</span><br><span class="line">            &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                return Observable.error(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //调用降级方法或抛出异常</span><br><span class="line">            return handleSemaphoreRejectionViaFallback();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //调用降级方法或抛出异常</span><br><span class="line">        return handleShortCircuitViaFallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private Observable&lt;R&gt; executeCommandAndObserve(final AbstractCommand&lt;R&gt; _cmd) &#123;</span><br><span class="line">    final HystrixRequestContext currentRequestContext = HystrixRequestContext.getContextForCurrentThread();</span><br><span class="line">        ...</span><br><span class="line">    //服务调用成功回调</span><br><span class="line">    final Action0 markOnCompleted = new Action0() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void call() &#123;</span><br><span class="line">            if (!commandIsScalar()) &#123;</span><br><span class="line">                long latency = System.currentTimeMillis() - executionResult.getStartTimestamp();</span><br><span class="line">                eventNotifier.markCommandExecution(getCommandKey(), properties.executionIsolationStrategy().get(), (int) latency, executionResult.getOrderedList());</span><br><span class="line">                eventNotifier.markEvent(HystrixEventType.SUCCESS, commandKey);</span><br><span class="line">                executionResult = executionResult.addEvent((int) latency, HystrixEventType.SUCCESS);</span><br><span class="line">                //关闭熔断器,metrics重新开始统计</span><br><span class="line">                circuitBreaker.markSuccess();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">        ...</span><br><span class="line">    Observable&lt;R&gt; execution;</span><br><span class="line">    //是否设置超时</span><br><span class="line">    if (properties.executionTimeoutEnabled().get()) &#123;</span><br><span class="line">        execution = executeCommandWithSpecifiedIsolation(_cmd)</span><br><span class="line">                //HystrixObservableTimeoutOperator内部通过一个定时器，当达到timeout时间时，将命令状态设置成timeout，</span><br><span class="line">                //向eventNotifier发送timeout事件，取消监听，返回一个HystrixTimeoutException的onError</span><br><span class="line">                .lift(new HystrixObservableTimeoutOperator&lt;R&gt;(_cmd));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        execution = executeCommandWithSpecifiedIsolation(_cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return execution.doOnNext(markEmits)</span><br><span class="line">            .doOnCompleted(markOnCompleted)</span><br><span class="line">            .onErrorResumeNext(handleFallback)</span><br><span class="line">            .doOnEach(setRequestContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">private Observable&lt;R&gt; executeCommandWithSpecifiedIsolation(final AbstractCommand&lt;R&gt; _cmd) &#123;</span><br><span class="line">    //是否使用线程池隔离</span><br><span class="line">    if (properties.executionIsolationStrategy().get() == ExecutionIsolationStrategy.THREAD) &#123;</span><br><span class="line">        // mark that we are executing in a thread (even if we end up being rejected we still were a THREAD execution and not SEMAPHORE)</span><br><span class="line">        //创建事件源</span><br><span class="line">        return Observable.defer(new Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Observable&lt;R&gt; call() &#123;</span><br><span class="line">                executionResult = executionResult.setExecutionOccurred();</span><br><span class="line">                if (!commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.USER_CODE_EXECUTED)) &#123;</span><br><span class="line">                    return Observable.error(new IllegalStateException(&quot;execution attempted while in state : &quot; + commandState.get().name()));</span><br><span class="line">                &#125;</span><br><span class="line">                metrics.markCommandStart(commandKey, threadPoolKey, ExecutionIsolationStrategy.THREAD);</span><br><span class="line"></span><br><span class="line">                if (isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT) &#123;</span><br><span class="line">                    // the command timed out in the wrapping thread so we will return immediately</span><br><span class="line">                    // and not increment any of the counters below or other such logic</span><br><span class="line">                    return Observable.error(new RuntimeException(&quot;timed out before executing run()&quot;));</span><br><span class="line">                &#125;</span><br><span class="line">                if (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.STARTED)) &#123;</span><br><span class="line">                    //we have not been unsubscribed, so should proceed</span><br><span class="line">                    HystrixCounters.incrementGlobalConcurrentThreads();</span><br><span class="line">                    threadPool.markThreadExecution();</span><br><span class="line">                    // store the command that is being run</span><br><span class="line">                    endCurrentThreadExecutingCommand = Hystrix.startCurrentThreadExecutingCommand(getCommandKey());</span><br><span class="line">                    executionResult = executionResult.setExecutedInThread();</span><br><span class="line">                    /**</span><br><span class="line">                     * If any of these hooks throw an exception, then it appears as if the actual execution threw an error</span><br><span class="line">                     */</span><br><span class="line">                    try &#123;</span><br><span class="line">                        executionHook.onThreadStart(_cmd);</span><br><span class="line">                        executionHook.onRunStart(_cmd);</span><br><span class="line">                        executionHook.onExecutionStart(_cmd);</span><br><span class="line">                        return getUserExecutionObservable(_cmd);</span><br><span class="line">                    &#125; catch (Throwable ex) &#123;</span><br><span class="line">                        return Observable.error(ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //command has already been unsubscribed, so return immediately</span><br><span class="line">                    return Observable.error(new RuntimeException(&quot;unsubscribed before executing run()&quot;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).doOnTerminate(new Action0() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void call() &#123;</span><br><span class="line">                if (threadState.compareAndSet(ThreadState.STARTED, ThreadState.TERMINAL)) &#123;</span><br><span class="line">                    handleThreadEnd(_cmd);</span><br><span class="line">                &#125;</span><br><span class="line">                if (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.TERMINAL)) &#123;</span><br><span class="line">                    //if it was never started and received terminal, then no need to clean up (I don&apos;t think this is possible)</span><br><span class="line">                &#125;</span><br><span class="line">                //if it was unsubscribed, then other cleanup handled it</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).doOnUnsubscribe(new Action0() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void call() &#123;</span><br><span class="line">                if (threadState.compareAndSet(ThreadState.STARTED, ThreadState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                    handleThreadEnd(_cmd);</span><br><span class="line">                &#125;</span><br><span class="line">                if (threadState.compareAndSet(ThreadState.NOT_USING_THREAD, ThreadState.UNSUBSCRIBED)) &#123;</span><br><span class="line">                    //if it was never started and was cancelled, then no need to clean up</span><br><span class="line">                &#125;</span><br><span class="line">                //if it was terminal, then other cleanup handled it</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribeOn(threadPool.getScheduler(new Func0&lt;Boolean&gt;() &#123;//指定执行线程</span><br><span class="line">            @Override</span><br><span class="line">            public Boolean call() &#123;</span><br><span class="line">                return properties.executionIsolationThreadInterruptOnTimeout().get() &amp;&amp; _cmd.isCommandTimedOut.get() == TimedOutStatus.TIMED_OUT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //创建事件源，使用默认线程池执行</span><br><span class="line">        return Observable.defer(new Func0&lt;Observable&lt;R&gt;&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Observable&lt;R&gt; call() &#123;</span><br><span class="line">                executionResult = executionResult.setExecutionOccurred();</span><br><span class="line">                if (!commandState.compareAndSet(CommandState.OBSERVABLE_CHAIN_CREATED, CommandState.USER_CODE_EXECUTED)) &#123;</span><br><span class="line">                    return Observable.error(new IllegalStateException(&quot;execution attempted while in state : &quot; + commandState.get().name()));</span><br><span class="line">                &#125;</span><br><span class="line">                metrics.markCommandStart(commandKey, threadPoolKey, ExecutionIsolationStrategy.SEMAPHORE);</span><br><span class="line">                // semaphore isolated</span><br><span class="line">                // store the command that is being run</span><br><span class="line">                endCurrentThreadExecutingCommand = Hystrix.startCurrentThreadExecutingCommand(getCommandKey());</span><br><span class="line">                try &#123;</span><br><span class="line">                    executionHook.onRunStart(_cmd);</span><br><span class="line">                    executionHook.onExecutionStart(_cmd);</span><br><span class="line">                    return getUserExecutionObservable(_cmd);  //the getUserExecutionObservable method already wraps sync exceptions, so this shouldn&apos;t throw</span><br><span class="line">                &#125; catch (Throwable ex) &#123;</span><br><span class="line">                    //If the above hooks throw, then use that as the result of the run method</span><br><span class="line">                    return Observable.error(ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>熔断器默认实现HystrixCircuitBreakerImpl，熔断器在请求数大于最小请求数时，通过最近一段时间内服务调用失败的比率（默认50%）判断是否熔断<br>熔断时设置熔断时间，经过一定时间后，熔断器为半打开状态，允许一个请求，如果请求成功熔断器关闭，否则重新打开。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean isOpen() &#123;</span><br><span class="line">    if (circuitOpen.get()) &#123;</span><br><span class="line">        // if we&apos;re open we immediately return true and don&apos;t bother attempting to &apos;close&apos; ourself as that is left to allowSingleTest and a subsequent successful test to close</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // we&apos;re closed, so let&apos;s see if errors have made us so we should trip the circuit open</span><br><span class="line">    //获取请求统计信息</span><br><span class="line">    HealthCounts health = metrics.getHealthCounts();</span><br><span class="line"></span><br><span class="line">    // check if we are past the statisticalWindowVolumeThreshold</span><br><span class="line">    //判断是否总请求数是否大于最小请求数</span><br><span class="line">    if (health.getTotalRequests() &lt; properties.circuitBreakerRequestVolumeThreshold().get()) &#123;</span><br><span class="line">        // we are not past the minimum volume threshold for the statisticalWindow so we&apos;ll return false immediately and not calculate anything</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    //通过失败率判断是否熔断</span><br><span class="line">    if (health.getErrorPercentage() &lt; properties.circuitBreakerErrorThresholdPercentage().get()) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // our failure rate is too high, trip the circuit</span><br><span class="line">        if (circuitOpen.compareAndSet(false, true)) &#123;</span><br><span class="line">            // if the previousValue was false then we want to set the currentTime</span><br><span class="line">            circuitOpenedOrLastTestedTime.set(System.currentTimeMillis());</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // How could previousValue be true? If another thread was going through this code at the same time a race-condition could have</span><br><span class="line">            // caused another thread to set it to true already even though we were in the process of doing the same</span><br><span class="line">            // In this case, we know the circuit is open, so let the other thread set the currentTime and report back that the circuit is open</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>HystrixCommandMetrics通过HealthCountsStream来管理调用成功率<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public static HealthCountsStream getInstance(HystrixCommandKey commandKey, HystrixCommandProperties properties) &#123;</span><br><span class="line">    //每个统计单元的时间</span><br><span class="line">    final int healthCountBucketSizeInMs = properties.metricsHealthSnapshotIntervalInMilliseconds().get();</span><br><span class="line">    if (healthCountBucketSizeInMs == 0) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;You have set the bucket size to 0ms.  Please set a positive number, so that the metric stream can be properly consumed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    // 总的统计时间/每个统计单元的时间=统计单元的个数</span><br><span class="line">    final int numHealthCountBuckets = properties.metricsRollingStatisticalWindowInMilliseconds().get() / healthCountBucketSizeInMs;</span><br><span class="line"></span><br><span class="line">    return getInstance(commandKey, numHealthCountBuckets, healthCountBucketSizeInMs);</span><br><span class="line">&#125;</span><br><span class="line">public static HealthCountsStream getInstance(HystrixCommandKey commandKey, int numBuckets, int bucketSizeInMs) &#123;</span><br><span class="line">    HealthCountsStream initialStream = streams.get(commandKey.name());</span><br><span class="line">    if (initialStream != null) &#123;</span><br><span class="line">        return initialStream;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        synchronized (HealthCountsStream.class) &#123;</span><br><span class="line">            HealthCountsStream existingStream = streams.get(commandKey.name());</span><br><span class="line">            if (existingStream == null) &#123;</span><br><span class="line">                HealthCountsStream newStream = new HealthCountsStream(commandKey, numBuckets, bucketSizeInMs,</span><br><span class="line">                         //appendEventToBucket将Hystrix各个事件汇总到一个统计单元里</span><br><span class="line">                        HystrixCommandMetrics.appendEventToBucket);</span><br><span class="line">                newStream.startCachingStreamValuesIfUnstarted();</span><br><span class="line">                streams.putIfAbsent(commandKey.name(), newStream);</span><br><span class="line">                return newStream;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return existingStream;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>HealthCountsStream的父类BucketedCounterStream、BucketedRollingCounterStream的构造方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">protected BucketedCounterStream(final HystrixEventStream&lt;Event&gt; inputEventStream, final int numBuckets, final int bucketSizeInMs,</span><br><span class="line">                                final Func2&lt;Bucket, Event, Bucket&gt; appendRawEventToBucket) &#123;</span><br><span class="line">    this.numBuckets = numBuckets;</span><br><span class="line">    // 将Hystrix事件汇总成Bucket的方法，传入Event类型的数据源,汇总成Bucket类型的数据</span><br><span class="line">    this.reduceBucketToSummary = new Func1&lt;Observable&lt;Event&gt;, Observable&lt;Bucket&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Observable&lt;Bucket&gt; call(Observable&lt;Event&gt; eventBucket) &#123;</span><br><span class="line">            return eventBucket.reduce(getEmptyBucketSummary(), appendRawEventToBucket);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">        ...</span><br><span class="line">    this.bucketedStream = Observable.defer(new Func0&lt;Observable&lt;Bucket&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Observable&lt;Bucket&gt; call() &#123;</span><br><span class="line">            //inputEventStream为HystrixCommandCompletionStream, 通过observe()来获取数据源</span><br><span class="line">            return inputEventStream</span><br><span class="line">                    .observe()</span><br><span class="line">                    //利用窗口函数,收集一个Bucket时间内的数据</span><br><span class="line">                    .window(bucketSizeInMs, TimeUnit.MILLISECONDS) //bucket it by the counter window so we can emit to the next operator in time chunks, not on every OnNext</span><br><span class="line">                    // 将数据汇总成一个Bucket</span><br><span class="line">                    .flatMap(reduceBucketToSummary)                //for a given bucket, turn it into a long array containing counts of event types</span><br><span class="line">                    .startWith(emptyEventCountsToStart);           //start it with empty arrays to make consumer logic as generic as possible (windows are always full)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">protected BucketedRollingCounterStream(HystrixEventStream&lt;Event&gt; stream, final int numBuckets, int bucketSizeInMs,</span><br><span class="line">                                       final Func2&lt;Bucket, Event, Bucket&gt; appendRawEventToBucket,</span><br><span class="line">                                       final Func2&lt;Output, Bucket, Output&gt; reduceBucket) &#123;</span><br><span class="line">    super(stream, numBuckets, bucketSizeInMs, appendRawEventToBucket);</span><br><span class="line">    //Bucket汇总方法</span><br><span class="line">    Func1&lt;Observable&lt;Bucket&gt;, Observable&lt;Output&gt;&gt; reduceWindowToSummary = new Func1&lt;Observable&lt;Bucket&gt;, Observable&lt;Output&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Observable&lt;Output&gt; call(Observable&lt;Bucket&gt; window) &#123;</span><br><span class="line">            return window.scan(getEmptyOutputValue(), reduceBucket).skip(numBuckets);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    // 基于父类BucketedCounterStream已经汇总的bucketedStream</span><br><span class="line">    this.sourceStream = bucketedStream      //stream broken up into buckets</span><br><span class="line">            // 将N个Bucket进行汇总</span><br><span class="line">            .window(numBuckets, 1)          //emit overlapping windows of buckets</span><br><span class="line">            // 汇总成一个窗口</span><br><span class="line">            .flatMap(reduceWindowToSummary) //convert a window of bucket-summaries into a single summary</span><br><span class="line">            .doOnSubscribe(new Action0() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void call() &#123;</span><br><span class="line">                    isSourceCurrentlySubscribed.set(true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .doOnUnsubscribe(new Action0() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void call() &#123;</span><br><span class="line">                    isSourceCurrentlySubscribed.set(false);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .share()                        //multiple subscribers should get same data</span><br><span class="line">            .onBackpressureDrop();          //if there are slow consumers, data should not buffer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考资料<a href="https://yq.aliyun.com/articles/679217" target="_blank" rel="noopener">https://yq.aliyun.com/articles/679217</a></p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2019 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>