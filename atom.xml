<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-06-28T15:01:12.423Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>小远</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>spring源码</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81%E6%95%B4%E5%90%88MyBatis/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码整合MyBatis/</id>
    <published>2018-06-27T13:10:29.035Z</published>
    <updated>2018-06-28T15:01:12.423Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>spring配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans  </span><br><span class="line">    xmlns=&quot;http://www.springframework.org/schema/beans&quot;  </span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  </span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd&quot;&gt;  </span><br><span class="line"></span><br><span class="line">    &lt;!-- 1.配置数据源：DriverManagerDataSource --&gt;  </span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;&gt;  </span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;oracle.jdbc.OracleDriver&quot;/&gt;  </span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;jdbc:oracle:thin:@localhost:1521:orcl&quot;/&gt;  </span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;scott&quot;/&gt;  </span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;tiger&quot;/&gt;  </span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;mapperLocations&quot; value=&quot;classpath:com/**/sql/*.xml&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;mapperscanner&quot; class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;basePackage&quot; value=&quot;com.**.mapper&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><h3 id="一、创建SqlSessionFactory"><a href="#一、创建SqlSessionFactory" class="headerlink" title="一、创建SqlSessionFactory"></a>一、创建SqlSessionFactory</h3><h4 id="1、SqlSessionFactoryBean的afterPropertiesSet方法"><a href="#1、SqlSessionFactoryBean的afterPropertiesSet方法" class="headerlink" title="1、SqlSessionFactoryBean的afterPropertiesSet方法"></a>1、SqlSessionFactoryBean的afterPropertiesSet方法</h4><p>SqlSessionFactoryBean实现了InitializingBean接口，创建完bean执行自定义初始化方法afterPropertiesSet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">    notNull(dataSource, &quot;Property &apos;dataSource&apos; is required&quot;);</span><br><span class="line">    notNull(sqlSessionFactoryBuilder, &quot;Property &apos;sqlSessionFactoryBuilder&apos; is required&quot;);</span><br><span class="line">    //创建sqlSessionFactory</span><br><span class="line">    this.sqlSessionFactory = buildSqlSessionFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、SqlSessionFactoryBean的buildSqlSessionFactory方法"><a href="#2、SqlSessionFactoryBean的buildSqlSessionFactory方法" class="headerlink" title="2、SqlSessionFactoryBean的buildSqlSessionFactory方法"></a>2、SqlSessionFactoryBean的buildSqlSessionFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">protected SqlSessionFactory buildSqlSessionFactory() throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    Configuration configuration;</span><br><span class="line"></span><br><span class="line">    XMLConfigBuilder xmlConfigBuilder = null;</span><br><span class="line">    if (this.configLocation != null) &#123;</span><br><span class="line">        //如果spring配置中configLocation属性不为空，则加载指定的Mybatis配置</span><br><span class="line">        xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, </span><br><span class="line">              this.configurationProperties);</span><br><span class="line">        configuration = xmlConfigBuilder.getConfiguration();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Property &apos;configLocation&apos; not specified, using default MyBatis Configuration&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //否则则采用默认的Mybatis配置</span><br><span class="line">        configuration = new Configuration();</span><br><span class="line">        configuration.setVariables(this.configurationProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.objectFactory != null) &#123;</span><br><span class="line">        configuration.setObjectFactory(this.objectFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.objectWrapperFactory != null) &#123;</span><br><span class="line">        configuration.setObjectWrapperFactory(this.objectWrapperFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    //对包下的类注册别民</span><br><span class="line">    if (hasLength(this.typeAliasesPackage)) &#123;</span><br><span class="line">        String[] typeAliasPackageArray = tokenizeToStringArray(this.typeAliasesPackage,</span><br><span class="line">                ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">        for (String packageToScan : typeAliasPackageArray) &#123;</span><br><span class="line">            //对应方法的目的是通过扫描包得到其包以及子包目录下的typeAliasesSuperType的子类Class</span><br><span class="line">            //然后为每个class注册别名,别名为类名</span><br><span class="line">            configuration.getTypeAliasRegistry().registerAliases(packageToScan,</span><br><span class="line">                typeAliasesSuperType == null ? Object.class : typeAliasesSuperType);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Scanned package: &apos;&quot; + packageToScan + &quot;&apos; for aliases&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //对类注册别名</span><br><span class="line">    if (!isEmpty(this.typeAliases)) &#123;</span><br><span class="line">        for (Class&lt;?&gt; typeAlias : this.typeAliases) &#123;</span><br><span class="line">            configuration.getTypeAliasRegistry().registerAlias(typeAlias);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Registered type alias: &apos;&quot; + typeAlias + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加插件</span><br><span class="line">    if (!isEmpty(this.plugins)) &#123;</span><br><span class="line">        for (Interceptor plugin : this.plugins) &#123;</span><br><span class="line">            configuration.addInterceptor(plugin);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Registered plugin: &apos;&quot; + plugin + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (hasLength(this.typeHandlersPackage)) &#123;</span><br><span class="line">        String[] typeHandlersPackageArray = tokenizeToStringArray(this.typeHandlersPackage,</span><br><span class="line">            ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">        for (String packageToScan : typeHandlersPackageArray) &#123;</span><br><span class="line">            configuration.getTypeHandlerRegistry().register(packageToScan);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Scanned package: &apos;&quot; + packageToScan + &quot;&apos; for type handlers&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">        for (TypeHandler&lt;?&gt; typeHandler : this.typeHandlers) &#123;</span><br><span class="line">            configuration.getTypeHandlerRegistry().register(typeHandler);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Registered type handler: &apos;&quot; + typeHandler + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (xmlConfigBuilder != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //解析配置文件</span><br><span class="line">            xmlConfigBuilder.parse();</span><br><span class="line"></span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Parsed configuration file: &apos;&quot; + this.configLocation + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            throw new NestedIOException(&quot;Failed to parse config resource: &quot; + this.configLocation, ex);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            ErrorContext.instance().reset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.transactionFactory == null) &#123;</span><br><span class="line">        //创建事务管理器</span><br><span class="line">        this.transactionFactory = new SpringManagedTransactionFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    //设置环境</span><br><span class="line">    Environment environment = new Environment(this.environment, this.transactionFactory, this.dataSource);</span><br><span class="line">    configuration.setEnvironment(environment);</span><br><span class="line"></span><br><span class="line">    if (this.databaseIdProvider != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            configuration.setDatabaseId(this.databaseIdProvider.getDatabaseId(this.dataSource));</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            throw new NestedIOException(&quot;Failed getting a databaseId&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!isEmpty(this.mapperLocations)) &#123;</span><br><span class="line">        for (Resource mapperLocation : this.mapperLocations) &#123;</span><br><span class="line">            if (mapperLocation == null) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">                    configuration, mapperLocation.toString(), configuration.getSqlFragments());</span><br><span class="line">                //解析mapper文件</span><br><span class="line">                xmlMapperBuilder.parse();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                throw new NestedIOException(&quot;Failed to parse mapping resource: &apos;&quot; + mapperLocation + &quot;&apos;&quot;, e);</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                ErrorContext.instance().reset();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Parsed mapper file: &apos;&quot; + mapperLocation + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Property &apos;mapperLocations&apos; was not specified or no matching resources found&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this.sqlSessionFactoryBuilder.build(configuration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、SqlSessionFactoryBean的getObject方法"><a href="#3、SqlSessionFactoryBean的getObject方法" class="headerlink" title="3、SqlSessionFactoryBean的getObject方法"></a>3、SqlSessionFactoryBean的getObject方法</h4><p>获取SqlSessionFactory对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory getObject() throws Exception &#123;</span><br><span class="line">    if (this.sqlSessionFactory == null) &#123;</span><br><span class="line">        afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">    return this.sqlSessionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="二、扫描mapper接口"><a href="#二、扫描mapper接口" class="headerlink" title="二、扫描mapper接口"></a>二、扫描mapper接口</h3><h4 id="1、MapperScannerConfigurer的postProcessBeanDefinitionRegistry方法"><a href="#1、MapperScannerConfigurer的postProcessBeanDefinitionRegistry方法" class="headerlink" title="1、MapperScannerConfigurer的postProcessBeanDefinitionRegistry方法"></a>1、MapperScannerConfigurer的postProcessBeanDefinitionRegistry方法</h4><p>BeanFactoryPostProcessor首先会执行postProcessBeanDefinitionRegistry方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    //若属性配置文件配置存在表达式$&#123;basePackage&#125;,此时尚未执行PropertyResourceConfigurer的postProcessBeanFactory加载Properties</span><br><span class="line">    //因此方法中创建一个容器，预先执行获取该属性</span><br><span class="line">    if (this.processPropertyPlaceHolders) &#123;</span><br><span class="line">      processPropertyPlaceHolders();</span><br><span class="line">    &#125;</span><br><span class="line">    //扫描器</span><br><span class="line">    ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);</span><br><span class="line">    scanner.setAddToConfig(this.addToConfig);</span><br><span class="line">    scanner.setAnnotationClass(this.annotationClass);</span><br><span class="line">    scanner.setMarkerInterface(this.markerInterface);</span><br><span class="line">    //sqlSessionFactory</span><br><span class="line">    scanner.setSqlSessionFactory(this.sqlSessionFactory);</span><br><span class="line">    scanner.setSqlSessionTemplate(this.sqlSessionTemplate);</span><br><span class="line">    scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);</span><br><span class="line">    scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);</span><br><span class="line">    scanner.setResourceLoader(this.applicationContext);</span><br><span class="line">    scanner.setBeanNameGenerator(this.nameGenerator);</span><br><span class="line">    //注册过滤器</span><br><span class="line">    scanner.registerFilters();</span><br><span class="line">    //扫描包路径</span><br><span class="line">    scanner.scan(StringUtils.tokenizeToStringArray(this.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、ClassPathMapperScanner的registerFilters方法"><a href="#2、ClassPathMapperScanner的registerFilters方法" class="headerlink" title="2、ClassPathMapperScanner的registerFilters方法"></a>2、ClassPathMapperScanner的registerFilters方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public void registerFilters() &#123;</span><br><span class="line">    boolean acceptAllInterfaces = true;</span><br><span class="line"></span><br><span class="line">    // if specified, use the given annotation and / or marker interface</span><br><span class="line">    //添加注解类型过滤器</span><br><span class="line">    if (this.annotationClass != null) &#123;</span><br><span class="line">        addIncludeFilter(new AnnotationTypeFilter(this.annotationClass));</span><br><span class="line">        acceptAllInterfaces = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // override AssignableTypeFilter to ignore matches on the actual marker interface</span><br><span class="line">    //添加接口类型过滤器，获取实现了该接口的类或接口，但忽略本接口</span><br><span class="line">    if (this.markerInterface != null) &#123;</span><br><span class="line">        addIncludeFilter(new AssignableTypeFilter(this.markerInterface) &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected boolean matchClassName(String className) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        acceptAllInterfaces = false;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取所有接口</span><br><span class="line">    if (acceptAllInterfaces) &#123;</span><br><span class="line">        // default include filter that accepts all classes</span><br><span class="line">        addIncludeFilter(new TypeFilter() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // exclude package-info.java</span><br><span class="line">    //排除package-info.java</span><br><span class="line">    addExcludeFilter(new TypeFilter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">            String className = metadataReader.getClassMetadata().getClassName();</span><br><span class="line">            return className.endsWith(&quot;package-info&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ClassPathMapperScanner的doScan方法"><a href="#3、ClassPathMapperScanner的doScan方法" class="headerlink" title="3、ClassPathMapperScanner的doScan方法"></a>3、ClassPathMapperScanner的doScan方法</h4><p>ClassPathMapperScanner继承了ClassPathBeanDefinitionScanner，重写了doScan方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) &#123;</span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = super.doScan(basePackages);</span><br><span class="line"></span><br><span class="line">    if (beanDefinitions.isEmpty()) &#123;</span><br><span class="line">        logger.warn(&quot;No MyBatis mapper was found in &apos;&quot; + Arrays.toString(basePackages) + &quot;&apos; package. Please check your configuration.&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        processBeanDefinitions(beanDefinitions);</span><br><span class="line">    &#125;</span><br><span class="line">    return beanDefinitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、ClassPathMapperScanner的isCandidateComponent方法"><a href="#4、ClassPathMapperScanner的isCandidateComponent方法" class="headerlink" title="4、ClassPathMapperScanner的isCandidateComponent方法"></a>4、ClassPathMapperScanner的isCandidateComponent方法</h4><p>ClassPathMapperScanner继承了ClassPathScanningCandidateComponentProvider，重写了isCandidateComponent方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected boolean isCandidateComponent(AnnotatedBeanDefinition beanDefinition) &#123;</span><br><span class="line">    //只获取接口</span><br><span class="line">    return beanDefinition.getMetadata().isInterface() &amp;&amp; beanDefinition.getMetadata().isIndependent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、接（二、3）ClassPathMapperScanner的processBeanDefinitions方法"><a href="#5、接（二、3）ClassPathMapperScanner的processBeanDefinitions方法" class="headerlink" title="5、接（二、3）ClassPathMapperScanner的processBeanDefinitions方法"></a>5、接（二、3）ClassPathMapperScanner的processBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">private void processBeanDefinitions(Set&lt;BeanDefinitionHolder&gt; beanDefinitions) &#123;</span><br><span class="line">    GenericBeanDefinition definition;</span><br><span class="line">    for (BeanDefinitionHolder holder : beanDefinitions) &#123;</span><br><span class="line">        definition = (GenericBeanDefinition) holder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Creating MapperFactoryBean with name &apos;&quot; + holder.getBeanName() </span><br><span class="line">              + &quot;&apos; and &apos;&quot; + definition.getBeanClassName() + &quot;&apos; mapperInterface&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // the mapper interface is the original class of the bean</span><br><span class="line">        // but, the actual class of the bean is MapperFactoryBean</span><br><span class="line">        //设置构造器参数</span><br><span class="line">        definition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); // issue #59</span><br><span class="line">        //设置mapper代理类的工厂</span><br><span class="line">        definition.setBeanClass(this.mapperFactoryBean.getClass());</span><br><span class="line"></span><br><span class="line">        definition.getPropertyValues().add(&quot;addToConfig&quot;, this.addToConfig);</span><br><span class="line"></span><br><span class="line">        boolean explicitFactoryUsed = false;</span><br><span class="line">        //设置sqlSessionFactory</span><br><span class="line">        if (StringUtils.hasText(this.sqlSessionFactoryBeanName)) &#123;</span><br><span class="line">            definition.getPropertyValues().add(&quot;sqlSessionFactory&quot;, new RuntimeBeanReference(this.sqlSessionFactoryBeanName));</span><br><span class="line">            explicitFactoryUsed = true;</span><br><span class="line">        &#125; else if (this.sqlSessionFactory != null) &#123;</span><br><span class="line">            definition.getPropertyValues().add(&quot;sqlSessionFactory&quot;, this.sqlSessionFactory);</span><br><span class="line">            explicitFactoryUsed = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (StringUtils.hasText(this.sqlSessionTemplateBeanName)) &#123;</span><br><span class="line">            if (explicitFactoryUsed) &#123;</span><br><span class="line">                logger.warn(&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            definition.getPropertyValues().add(&quot;sqlSessionTemplate&quot;, new RuntimeBeanReference(this.sqlSessionTemplateBeanName));</span><br><span class="line">            explicitFactoryUsed = true;</span><br><span class="line">        &#125; else if (this.sqlSessionTemplate != null) &#123;</span><br><span class="line">            if (explicitFactoryUsed) &#123;</span><br><span class="line">                logger.warn(&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            definition.getPropertyValues().add(&quot;sqlSessionTemplate&quot;, this.sqlSessionTemplate);</span><br><span class="line">            explicitFactoryUsed = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!explicitFactoryUsed) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Enabling autowire by type for MapperFactoryBean with name &apos;&quot; + holder.getBeanName() + &quot;&apos;.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //设置自动注入byType</span><br><span class="line">            definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、创建mapper代理对象"><a href="#三、创建mapper代理对象" class="headerlink" title="三、创建mapper代理对象"></a>三、创建mapper代理对象</h3><h4 id="1、实例化MapperFactoryBean"><a href="#1、实例化MapperFactoryBean" class="headerlink" title="1、实例化MapperFactoryBean"></a>1、实例化MapperFactoryBean</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public MapperFactoryBean(Class&lt;T&gt; mapperInterface) &#123;</span><br><span class="line">    this.mapperInterface = mapperInterface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、SqlSessionDaoSupport的setSqlSessionFactory方法"><a href="#2、SqlSessionDaoSupport的setSqlSessionFactory方法" class="headerlink" title="2、SqlSessionDaoSupport的setSqlSessionFactory方法"></a>2、SqlSessionDaoSupport的setSqlSessionFactory方法</h4><p>注入sqlSessionFactory属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void setSqlSessionFactory(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">    if (!this.externalSqlSession) &#123;</span><br><span class="line">        this.sqlSession = new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、实例化SqlSessionTemplate"><a href="#3、实例化SqlSessionTemplate" class="headerlink" title="3、实例化SqlSessionTemplate"></a>3、实例化SqlSessionTemplate</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">    this(sqlSessionFactory, sqlSessionFactory.getConfiguration().getDefaultExecutorType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType) &#123;</span><br><span class="line">    this(sqlSessionFactory, executorType,</span><br><span class="line">        new MyBatisExceptionTranslator(</span><br><span class="line">            sqlSessionFactory.getConfiguration().getEnvironment().getDataSource(), true));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line"></span><br><span class="line">    notNull(sqlSessionFactory, &quot;Property &apos;sqlSessionFactory&apos; is required&quot;);</span><br><span class="line">    notNull(executorType, &quot;Property &apos;executorType&apos; is required&quot;);</span><br><span class="line"></span><br><span class="line">    this.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">    //ExecutorType.SIMPLE</span><br><span class="line">    this.executorType = executorType;</span><br><span class="line">    this.exceptionTranslator = exceptionTranslator;</span><br><span class="line">    //sqlSession代理</span><br><span class="line">    this.sqlSessionProxy = (SqlSession) newProxyInstance(</span><br><span class="line">        SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">        new Class[] &#123; SqlSession.class &#125;,</span><br><span class="line">        new SqlSessionInterceptor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、MapperFactoryBean的getObject方法"><a href="#4、MapperFactoryBean的getObject方法" class="headerlink" title="4、MapperFactoryBean的getObject方法"></a>4、MapperFactoryBean的getObject方法</h4><p>获取bean<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public T getObject() throws Exception &#123;</span><br><span class="line">    //SqlSessionTemplate获取代理对象</span><br><span class="line">    return getSqlSession().getMapper(this.mapperInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、SqlSessionTemplate的getMapper方法"><a href="#5、SqlSessionTemplate的getMapper方法" class="headerlink" title="5、SqlSessionTemplate的getMapper方法"></a>5、SqlSessionTemplate的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type) &#123;</span><br><span class="line">    //获取代理对象与mybatis中相同，传入的参数为SqlSessionTemplate，spring只创建这一个SqlSession</span><br><span class="line">    return getConfiguration().getMapper(type, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、拦截器SqlSessionInterceptor"><a href="#三、拦截器SqlSessionInterceptor" class="headerlink" title="三、拦截器SqlSessionInterceptor"></a>三、拦截器SqlSessionInterceptor</h3><h4 id="1、SqlSessionInterceptor的invoke方法"><a href="#1、SqlSessionInterceptor的invoke方法" class="headerlink" title="1、SqlSessionInterceptor的invoke方法"></a>1、SqlSessionInterceptor的invoke方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    //创建一个sqlSession</span><br><span class="line">    final SqlSession sqlSession = getSqlSession(</span><br><span class="line">        SqlSessionTemplate.this.sqlSessionFactory,</span><br><span class="line">        SqlSessionTemplate.this.executorType,</span><br><span class="line">        SqlSessionTemplate.this.exceptionTranslator);</span><br><span class="line">    try &#123;</span><br><span class="line">        //执行</span><br><span class="line">        Object result = method.invoke(sqlSession, args);</span><br><span class="line">        //没有使用事务，直接提交</span><br><span class="line">        if (!isSqlSessionTransactional(sqlSession, SqlSessionTemplate.this.sqlSessionFactory)) &#123;</span><br><span class="line">            // force commit even on non-dirty sessions because some databases require</span><br><span class="line">            // a commit/rollback before calling close()</span><br><span class="line">            sqlSession.commit(true);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        Throwable unwrapped = unwrapThrowable(t);</span><br><span class="line">        if (SqlSessionTemplate.this.exceptionTranslator != null &amp;&amp; unwrapped instanceof PersistenceException) &#123;</span><br><span class="line">            Throwable translated = SqlSessionTemplate.this.exceptionTranslator.translateExceptionIfPossible((PersistenceException) unwrapped);</span><br><span class="line">            if (translated != null) &#123;</span><br><span class="line">                unwrapped = translated;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        throw unwrapped;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、SqlSessionInterceptor的getSqlSession方法"><a href="#2、SqlSessionInterceptor的getSqlSession方法" class="headerlink" title="2、SqlSessionInterceptor的getSqlSession方法"></a>2、SqlSessionInterceptor的getSqlSession方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">public static SqlSession getSqlSession(SqlSessionFactory sessionFactory, ExecutorType executorType, </span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line"></span><br><span class="line">    notNull(sessionFactory, &quot;No SqlSessionFactory specified&quot;);</span><br><span class="line">    notNull(executorType, &quot;No ExecutorType specified&quot;);</span><br><span class="line">    //获取本线程的SqlSession容器</span><br><span class="line">    SqlSessionHolder holder = (SqlSessionHolder) getResource(sessionFactory);</span><br><span class="line">    //holder已被事务获取</span><br><span class="line">    if (holder != null &amp;&amp; holder.isSynchronizedWithTransaction()) &#123;</span><br><span class="line">        if (holder.getExecutorType() != executorType) &#123;</span><br><span class="line">            throw new TransientDataAccessResourceException(&quot;Cannot change the ExecutorType when there is an existing transaction&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //正在使用次数加一</span><br><span class="line">        holder.requested();</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Fetched SqlSession [&quot; + holder.getSqlSession() + &quot;] from current transaction&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return holder.getSqlSession();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Creating a new SqlSession&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建SqlSession</span><br><span class="line">    SqlSession session = sessionFactory.openSession(executorType);</span><br><span class="line"></span><br><span class="line">    // Register session holder if synchronization is active (i.e. a Spring TX is active)</span><br><span class="line">    //</span><br><span class="line">    // Note: The DataSource used by the Environment should be synchronized with the</span><br><span class="line">    // transaction either through DataSourceTxMgr or another tx synchronization.</span><br><span class="line">    // Further assume that if an exception is thrown, whatever started the transaction will</span><br><span class="line">    // handle closing / rolling back the Connection associated with the SqlSession.</span><br><span class="line">    //当前线程是否激活事务</span><br><span class="line">    if (isSynchronizationActive()) &#123;</span><br><span class="line">        //获取环境</span><br><span class="line">        Environment environment = sessionFactory.getConfiguration().getEnvironment();</span><br><span class="line">        //事务管理器为是spring事务管理器</span><br><span class="line">        if (environment.getTransactionFactory() instanceof SpringManagedTransactionFactory) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">              logger.debug(&quot;Registering transaction synchronization for SqlSession [&quot; + session + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //创建本线程SqlSession容器</span><br><span class="line">            holder = new SqlSessionHolder(session, executorType, exceptionTranslator);</span><br><span class="line">            //holder注册到本线程</span><br><span class="line">            bindResource(sessionFactory, holder);</span><br><span class="line">            //设置回调函数释放资源</span><br><span class="line">            registerSynchronization(new SqlSessionSynchronization(holder, sessionFactory));</span><br><span class="line">            //设置holder已被事务获取</span><br><span class="line">            holder.setSynchronizedWithTransaction(true);</span><br><span class="line">            //SqlSession正在使用加一</span><br><span class="line">            holder.requested();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (getResource(environment.getDataSource()) == null) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;SqlSession [&quot; + session + &quot;] was not registered for synchronization because DataSource is not transactional&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                throw new TransientDataAccessResourceException(</span><br><span class="line">                  &quot;SqlSessionFactory must be using a SpringManagedTransactionFactory in order to use Spring transaction synchronization&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;SqlSession [&quot; + session + &quot;] was not registered for synchronization because synchronization is not active&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、接（三、1）SqlSessionInterceptor的closeSqlSession方法"><a href="#3、接（三、1）SqlSessionInterceptor的closeSqlSession方法" class="headerlink" title="3、接（三、1）SqlSessionInterceptor的closeSqlSession方法"></a>3、接（三、1）SqlSessionInterceptor的closeSqlSession方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static void closeSqlSession(SqlSession session, SqlSessionFactory sessionFactory) &#123;</span><br><span class="line"></span><br><span class="line">    notNull(session, &quot;No SqlSession specified&quot;);</span><br><span class="line">    notNull(sessionFactory, &quot;No SqlSessionFactory specified&quot;);</span><br><span class="line">    //获取本线程SqlSession容器</span><br><span class="line">    SqlSessionHolder holder = (SqlSessionHolder) getResource(sessionFactory);</span><br><span class="line">    if ((holder != null) &amp;&amp; (holder.getSqlSession() == session)) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Releasing transactional SqlSession [&quot; + session + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //正在使用减一</span><br><span class="line">        holder.released();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Closing non transactional SqlSession [&quot; + session + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //没有事务，关闭SqlSession</span><br><span class="line">        session.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;p&gt;spring配置文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td c
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码XmlBeanFactory(2)</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81XmlBeanFactory(2)%20/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码XmlBeanFactory(2) /</id>
    <published>2018-06-27T13:10:29.033Z</published>
    <updated>2018-06-28T14:09:14.391Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、bean加载"><a href="#一、bean加载" class="headerlink" title="一、bean加载"></a>一、bean加载</h3><h4 id="1、AbstractBeanFactory的getBean方法"><a href="#1、AbstractBeanFactory的getBean方法" class="headerlink" title="1、AbstractBeanFactory的getBean方法"></a>1、AbstractBeanFactory的getBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getBean(String name) throws BeansException &#123;</span><br><span class="line">    return doGetBean(name, null, null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AbstractBeanFactory的doGetBean方法"><a href="#2、AbstractBeanFactory的doGetBean方法" class="headerlink" title="2、AbstractBeanFactory的doGetBean方法"></a>2、AbstractBeanFactory的doGetBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected &lt;T&gt; T doGetBean(</span><br><span class="line">        final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line">    //FactoryBean以&quot;&amp;&quot;开头，去除该符号，别名转换为beanName</span><br><span class="line">    final String beanName = transformedBeanName(name);</span><br><span class="line">    Object bean;</span><br><span class="line"></span><br><span class="line">    // Eagerly check singleton cache for manually registered singletons.</span><br><span class="line">    //从缓存中获取</span><br><span class="line">    Object sharedInstance = getSingleton(beanName);</span><br><span class="line">    if (sharedInstance != null &amp;&amp; args == null) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            if (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">                logger.debug(&quot;Returning eagerly cached instance of singleton bean &apos;&quot; + beanName +</span><br><span class="line">                        &quot;&apos; that is not fully initialized yet - a consequence of a circular reference&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                logger.debug(&quot;Returning cached instance of singleton bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //如果是FactoryBean，则从FactoryBean中获取对象</span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else &#123;</span><br><span class="line">        // Fail if we&apos;re already creating this bean instance:</span><br><span class="line">        // We&apos;re assumably within a circular reference.</span><br><span class="line">        //该bean正在创建，发生循环依赖</span><br><span class="line">        if (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            throw new BeanCurrentlyInCreationException(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Check if bean definition exists in this factory.</span><br><span class="line">        //获取父容器，</span><br><span class="line">        BeanFactory parentBeanFactory = getParentBeanFactory();</span><br><span class="line">        //当前容器不存在该bean，则从父容器中获取该bean</span><br><span class="line">        if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            // Not found -&gt; check parent.</span><br><span class="line">            String nameToLookup = originalBeanName(name);</span><br><span class="line">            if (args != null) &#123;</span><br><span class="line">                // Delegation to parent with explicit args.</span><br><span class="line">                return (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // No args -&gt; delegate to standard getBean method.</span><br><span class="line">                return parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //标记bean正在创建</span><br><span class="line">        if (!typeCheckOnly) &#123;</span><br><span class="line">            markBeanAsCreated(beanName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //将储存xml配置的GernericBeanDefinition转换为RootBeanDefinition</span><br><span class="line">            final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">            checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">            // Guarantee initialization of beans that the current bean depends on.</span><br><span class="line">            //指定依赖</span><br><span class="line">            String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">            if (dependsOn != null) &#123;</span><br><span class="line">                for (String dependsOnBean : dependsOn) &#123;</span><br><span class="line">                    //dependOn依赖关系已注册，出现循环依赖</span><br><span class="line">                    if (isDependent(beanName, dependsOnBean)) &#123;</span><br><span class="line">                        throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                &quot;Circular depends-on relationship between &apos;&quot; + beanName + &quot;&apos; and &apos;&quot; + dependsOnBean + &quot;&apos;&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //注册dependOn依赖关系</span><br><span class="line">                    registerDependentBean(dependsOnBean, beanName);</span><br><span class="line">                    //先加载依赖bean</span><br><span class="line">                    getBean(dependsOnBean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Create bean instance.</span><br><span class="line">            //bean为单例模式</span><br><span class="line">            if (mbd.isSingleton()) &#123;</span><br><span class="line">                //获取该单例bean</span><br><span class="line">                sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public Object getObject() throws BeansException &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            //创建该bean</span><br><span class="line">                            return createBean(beanName, mbd, args);</span><br><span class="line">                        &#125;</span><br><span class="line">                        catch (BeansException ex) &#123;</span><br><span class="line">                            // Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="line">                            // eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="line">                            // Also remove any beans that received a temporary reference to the bean.</span><br><span class="line">                            destroySingleton(beanName);</span><br><span class="line">                            throw ex;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                //如果是FactoryBean，则从FactoryBean中获取对象</span><br><span class="line">                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line">            //bean为prototype模式</span><br><span class="line">            else if (mbd.isPrototype()) &#123;</span><br><span class="line">                // It&apos;s a prototype -&gt; create a new instance.</span><br><span class="line">                Object prototypeInstance = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //标记该bean正在创建</span><br><span class="line">                    beforePrototypeCreation(beanName);</span><br><span class="line">                    //创建该prototype模式的bean</span><br><span class="line">                    prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">                &#125;</span><br><span class="line">                finally &#123;</span><br><span class="line">                    //删除正在创建标记</span><br><span class="line">                    afterPrototypeCreation(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">            &#125;</span><br><span class="line">            //bean为另外的scope</span><br><span class="line">            else &#123;</span><br><span class="line">                String scopeName = mbd.getScope();</span><br><span class="line">                final Scope scope = this.scopes.get(scopeName);</span><br><span class="line">                if (scope == null) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;No Scope registered for scope &apos;&quot; + scopeName + &quot;&apos;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Object scopedInstance = scope.get(beanName, new ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public Object getObject() throws BeansException &#123;</span><br><span class="line">                            beforePrototypeCreation(beanName);</span><br><span class="line">                            try &#123;</span><br><span class="line">                                return createBean(beanName, mbd, args);</span><br><span class="line">                            &#125;</span><br><span class="line">                            finally &#123;</span><br><span class="line">                                afterPrototypeCreation(beanName);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (IllegalStateException ex) &#123;</span><br><span class="line">                    throw new BeanCreationException(beanName,</span><br><span class="line">                            &quot;Scope &apos;&quot; + scopeName + &quot;&apos; is not active for the current thread; &quot; +</span><br><span class="line">                            &quot;consider defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;,</span><br><span class="line">                            ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check if required type matches the type of the actual bean instance.</span><br><span class="line">    if (requiredType != null &amp;&amp; bean != null &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (TypeMismatchException ex) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Failed to convert bean &apos;&quot; + name + &quot;&apos; to required type [&quot; +</span><br><span class="line">                        ClassUtils.getQualifiedName(requiredType) + &quot;]&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AbstractBeanFactory的getSingleton方法"><a href="#3、AbstractBeanFactory的getSingleton方法" class="headerlink" title="3、AbstractBeanFactory的getSingleton方法"></a>3、AbstractBeanFactory的getSingleton方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getSingleton(String beanName) &#123;</span><br><span class="line">    return getSingleton(beanName, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">protected Object getSingleton(String beanName, boolean allowEarlyReference) &#123;</span><br><span class="line">    //从缓存中获取</span><br><span class="line">    Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        synchronized (this.singletonObjects) &#123;</span><br><span class="line">            //从早期bean缓存中获取暴露的早期bean，解决循环依赖</span><br><span class="line">            singletonObject = this.earlySingletonObjects.get(beanName);</span><br><span class="line">            //允许获取早期bean</span><br><span class="line">            if (singletonObject == null &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                //获取singletonFactory</span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span><br><span class="line">                if (singletonFactory != null) &#123;</span><br><span class="line">                    //从singletonFactoy中，获取早期bean</span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    //放入早期bean缓存</span><br><span class="line">                    this.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    this.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return (singletonObject != NULL_OBJECT ? singletonObject : null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、接（一、2）AbstractBeanFactory的getObjectForBeanInstance方法"><a href="#4、接（一、2）AbstractBeanFactory的getObjectForBeanInstance方法" class="headerlink" title="4、接（一、2）AbstractBeanFactory的getObjectForBeanInstance方法"></a>4、接（一、2）AbstractBeanFactory的getObjectForBeanInstance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">protected Object getObjectForBeanInstance(</span><br><span class="line">        Object beanInstance, String name, String beanName, RootBeanDefinition mbd) &#123;</span><br><span class="line"></span><br><span class="line">    // Don&apos;t let calling code try to dereference the factory if the bean isn&apos;t a factory.</span><br><span class="line">    //name是工厂类型即“&amp;”开头，但实例并非FactoryBean</span><br><span class="line">    if (BeanFactoryUtils.isFactoryDereference(name) &amp;&amp; !(beanInstance instanceof FactoryBean)) &#123;</span><br><span class="line">        throw new BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Now we have the bean instance, which may be a normal bean or a FactoryBean.</span><br><span class="line">    // If it&apos;s a FactoryBean, we use it to create a bean instance, unless the</span><br><span class="line">    // caller actually wants a reference to the factory.</span><br><span class="line">    //name是工厂或实例并非FactoryBean，直接返回</span><br><span class="line">    if (!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) &#123;</span><br><span class="line">        return beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object object = null;</span><br><span class="line">    if (mbd == null) &#123;</span><br><span class="line">        //从缓存中获取FactoryBean</span><br><span class="line">        object = getCachedObjectForFactoryBean(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    if (object == null) &#123;</span><br><span class="line">        // Return bean instance from factory.</span><br><span class="line">        FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) beanInstance;</span><br><span class="line">        // Caches object obtained from FactoryBean if it is a singleton.</span><br><span class="line">        if (mbd == null &amp;&amp; containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            //将储存xml配置的GernericBeanDefinition转换为RootBeanDefinition</span><br><span class="line">            mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        boolean synthetic = (mbd != null &amp;&amp; mbd.isSynthetic());</span><br><span class="line">        //从FactoryBean中获取bean</span><br><span class="line">        object = getObjectFromFactoryBean(factory, beanName, !synthetic);</span><br><span class="line">    &#125;</span><br><span class="line">    return object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、AbstractBeanFactory的getObjectFromFactoryBean方法"><a href="#5、AbstractBeanFactory的getObjectFromFactoryBean方法" class="headerlink" title="5、AbstractBeanFactory的getObjectFromFactoryBean方法"></a>5、AbstractBeanFactory的getObjectFromFactoryBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">protected Object getObjectFromFactoryBean(FactoryBean&lt;?&gt; factory, String beanName, boolean shouldPostProcess) &#123;</span><br><span class="line">    //单例模式</span><br><span class="line">    if (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</span><br><span class="line">        synchronized (getSingletonMutex()) &#123;</span><br><span class="line">            Object object = this.factoryBeanObjectCache.get(beanName);</span><br><span class="line">            if (object == null) &#123;</span><br><span class="line">                //获取bean，执行factory的getObject方法</span><br><span class="line">                object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">                // Only post-process and store if not put there already during getObject() call above</span><br><span class="line">                // (e.g. because of circular reference processing triggered by custom getBean calls)</span><br><span class="line">                //从缓存中获取</span><br><span class="line">                Object alreadyThere = this.factoryBeanObjectCache.get(beanName);</span><br><span class="line">                if (alreadyThere != null) &#123;</span><br><span class="line">                    object = alreadyThere;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    if (object != null &amp;&amp; shouldPostProcess) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            //从FactoryBean中获取对象的后处理器</span><br><span class="line">                            object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">                        &#125;</span><br><span class="line">                        catch (Throwable ex) &#123;</span><br><span class="line">                            throw new BeanCreationException(beanName,</span><br><span class="line">                                    &quot;Post-processing of FactoryBean&apos;s singleton object failed&quot;, ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //添加缓存</span><br><span class="line">                    this.factoryBeanObjectCache.put(beanName, (object != null ? object : NULL_OBJECT));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return (object != NULL_OBJECT ? object : null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Object object = doGetObjectFromFactoryBean(factory, beanName);</span><br><span class="line">        if (object != null &amp;&amp; shouldPostProcess) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                object = postProcessObjectFromFactoryBean(object, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                throw new BeanCreationException(beanName, &quot;Post-processing of FactoryBean&apos;s object failed&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AbstractBeanFactory的postProcessObjectFromFactoryBean方法"><a href="#6、AbstractBeanFactory的postProcessObjectFromFactoryBean方法" class="headerlink" title="6、AbstractBeanFactory的postProcessObjectFromFactoryBean方法"></a>6、AbstractBeanFactory的postProcessObjectFromFactoryBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object postProcessObjectFromFactoryBean(Object object, String beanName) &#123;</span><br><span class="line">    return applyBeanPostProcessorsAfterInitialization(object, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、AbstractBeanFactory的applyBeanPostProcessorsAfterInitialization方法"><a href="#7、AbstractBeanFactory的applyBeanPostProcessorsAfterInitialization方法" class="headerlink" title="7、AbstractBeanFactory的applyBeanPostProcessorsAfterInitialization方法"></a>7、AbstractBeanFactory的applyBeanPostProcessorsAfterInitialization方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">    Object result = existingBean;</span><br><span class="line">    //执行bean初始化后处理器</span><br><span class="line">    for (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">        result = beanProcessor.postProcessAfterInitialization(result, beanName);</span><br><span class="line">        if (result == null) &#123;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（一、2）AbstractBeanFactory的getSingleton方法"><a href="#8、接（一、2）AbstractBeanFactory的getSingleton方法" class="headerlink" title="8、接（一、2）AbstractBeanFactory的getSingleton方法"></a>8、接（一、2）AbstractBeanFactory的getSingleton方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</span><br><span class="line">    Assert.notNull(beanName, &quot;&apos;beanName&apos; must not be null&quot;);</span><br><span class="line">    synchronized (this.singletonObjects) &#123;</span><br><span class="line">        //从缓存里获取</span><br><span class="line">        Object singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">        if (singletonObject == null) &#123;</span><br><span class="line">            if (this.singletonsCurrentlyInDestruction) &#123;</span><br><span class="line">                throw new BeanCreationNotAllowedException(beanName,</span><br><span class="line">                        &quot;Singleton bean creation not allowed while the singletons of this factory are in destruction &quot; +</span><br><span class="line">                        &quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Creating shared instance of singleton bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //检查该bean是否正在创建</span><br><span class="line">            beforeSingletonCreation(beanName);</span><br><span class="line">            boolean newSingleton = false;</span><br><span class="line">            boolean recordSuppressedExceptions = (this.suppressedExceptions == null);</span><br><span class="line">            if (recordSuppressedExceptions) &#123;</span><br><span class="line">                this.suppressedExceptions = new LinkedHashSet&lt;Exception&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                //创建bean</span><br><span class="line">                singletonObject = singletonFactory.getObject();</span><br><span class="line">                newSingleton = true;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (IllegalStateException ex) &#123;</span><br><span class="line">                // Has the singleton object implicitly appeared in the meantime -&gt;</span><br><span class="line">                // if yes, proceed with it since the exception indicates that state.</span><br><span class="line">                singletonObject = this.singletonObjects.get(beanName);</span><br><span class="line">                if (singletonObject == null) &#123;</span><br><span class="line">                    throw ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (BeanCreationException ex) &#123;</span><br><span class="line">                if (recordSuppressedExceptions) &#123;</span><br><span class="line">                    for (Exception suppressedException : this.suppressedExceptions) &#123;</span><br><span class="line">                        ex.addRelatedCause(suppressedException);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">            finally &#123;</span><br><span class="line">                if (recordSuppressedExceptions) &#123;</span><br><span class="line">                    this.suppressedExceptions = null;</span><br><span class="line">                &#125;</span><br><span class="line">                //删除正在创建标记</span><br><span class="line">                afterSingletonCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            if (newSingleton) &#123;</span><br><span class="line">                //添加缓存，删除为解决循环依赖而提早暴露的bean</span><br><span class="line">                addSingleton(beanName, singletonObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return (singletonObject != NULL_OBJECT ? singletonObject : null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、AbstractAutowireCapableBeanFactory的createBean方法"><a href="#9、AbstractAutowireCapableBeanFactory的createBean方法" class="headerlink" title="9、AbstractAutowireCapableBeanFactory的createBean方法"></a>9、AbstractAutowireCapableBeanFactory的createBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object createBean(final String beanName, final RootBeanDefinition mbd, final Object[] args)</span><br><span class="line">        throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    // Make sure bean class is actually resolved at this point.</span><br><span class="line">    //获取bean的class</span><br><span class="line">    resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">    // Prepare method overrides.</span><br><span class="line">    try &#123;</span><br><span class="line">        //预处理准备覆盖的方法</span><br><span class="line">        mbd.prepareMethodOverrides();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(mbd.getResourceDescription(),</span><br><span class="line">                beanName, &quot;Validation of method overrides failed&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><br><span class="line">        // 给BeanPostProcessors一个机会返回代理，来替代真正的实例</span><br><span class="line">        Object bean = resolveBeforeInstantiation(beanName, mbd);</span><br><span class="line">        if (bean != null) &#123;</span><br><span class="line">            return bean;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                &quot;BeanPostProcessor before instantiation of bean failed&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建bean</span><br><span class="line">    Object beanInstance = doCreateBean(beanName, mbd, args);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Finished creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return beanInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、AbstractAutowireCapableBeanFactory的resolveBeforeInstantiation方法"><a href="#10、AbstractAutowireCapableBeanFactory的resolveBeforeInstantiation方法" class="headerlink" title="10、AbstractAutowireCapableBeanFactory的resolveBeforeInstantiation方法"></a>10、AbstractAutowireCapableBeanFactory的resolveBeforeInstantiation方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected Object resolveBeforeInstantiation(String beanName, RootBeanDefinition mbd) &#123;</span><br><span class="line">    Object bean = null;</span><br><span class="line">    //尚未被解析</span><br><span class="line">    if (!Boolean.FALSE.equals(mbd.beforeInstantiationResolved)) &#123;</span><br><span class="line">        // Make sure bean class is actually resolved at this point.</span><br><span class="line">        if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">            Class&lt;?&gt; targetType = determineTargetType(beanName, mbd);</span><br><span class="line">            if (targetType != null) &#123;</span><br><span class="line">                //实例化bean前处理器，这里可以在创建BeanWrapper之前更改BeanDefinition，并可能会创建一个代理bean返回</span><br><span class="line">                bean = applyBeanPostProcessorsBeforeInstantiation(targetType, beanName);</span><br><span class="line">                if (bean != null) &#123;</span><br><span class="line">                    //如果bean已经创建，调用实例化bean后处理器</span><br><span class="line">                    bean = applyBeanPostProcessorsAfterInitialization(bean, beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mbd.beforeInstantiationResolved = (bean != null);</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、接（一、9）AbstractAutowireCapableBeanFactory的doCreateBean方法"><a href="#11、接（一、9）AbstractAutowireCapableBeanFactory的doCreateBean方法" class="headerlink" title="11、接（一、9）AbstractAutowireCapableBeanFactory的doCreateBean方法"></a>11、接（一、9）AbstractAutowireCapableBeanFactory的doCreateBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args) &#123;</span><br><span class="line">    // Instantiate the bean.</span><br><span class="line">    BeanWrapper instanceWrapper = null;</span><br><span class="line">    if (mbd.isSingleton()) &#123;</span><br><span class="line">        //单例模式，删除原有的beanWrapper</span><br><span class="line">        instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    if (instanceWrapper == null) &#123;</span><br><span class="line">        //创建beanWrapper，里面存放了bean对象</span><br><span class="line">        instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    final Object bean = (instanceWrapper != null ? instanceWrapper.getWrappedInstance() : null);</span><br><span class="line">    Class&lt;?&gt; beanType = (instanceWrapper != null ? instanceWrapper.getWrappedClass() : null);</span><br><span class="line"></span><br><span class="line">    // Allow post-processors to modify the merged bean definition.</span><br><span class="line">    synchronized (mbd.postProcessingLock) &#123;</span><br><span class="line">        if (!mbd.postProcessed) &#123;</span><br><span class="line">            //应用MergedBeanDefinitionPostProcessor</span><br><span class="line">            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">            mbd.postProcessed = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Eagerly cache singletons to be able to resolve circular references</span><br><span class="line">    // even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="line">    //单例&amp;允许循环依赖&amp;该bean正在创建，则提早曝光</span><br><span class="line">    boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;</span><br><span class="line">            isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">    if (earlySingletonExposure) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Eagerly caching bean &apos;&quot; + beanName +</span><br><span class="line">                    &quot;&apos; to allow for resolving potential circular references&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //singletonFactories中添加ObjectFactory</span><br><span class="line">        addSingletonFactory(beanName, new ObjectFactory&lt;Object&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Object getObject() throws BeansException &#123;</span><br><span class="line">                //应用SmartInstantiationAwareBeanPostProcessor，没有直接返回</span><br><span class="line">                //AOP在此处将advice动态织入bean中</span><br><span class="line">                return getEarlyBeanReference(beanName, mbd, bean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize the bean instance.</span><br><span class="line">    Object exposedObject = bean;</span><br><span class="line">    try &#123;</span><br><span class="line">        //将各个属性值注入bean中，依赖其他bean，则递归初始化bean</span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        if (exposedObject != null) &#123;</span><br><span class="line">            //调用初始化方法，比如init-method</span><br><span class="line">            exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">            throw (BeanCreationException) ex;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (earlySingletonExposure) &#123;</span><br><span class="line">        Object earlySingletonReference = getSingleton(beanName, false);</span><br><span class="line">        //出现循环依赖的情况下，该值不为空</span><br><span class="line">        if (earlySingletonReference != null) &#123;</span><br><span class="line">            if (exposedObject == bean) &#123;</span><br><span class="line">                exposedObject = earlySingletonReference;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">                String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">                Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;String&gt;(dependentBeans.length);</span><br><span class="line">                for (String dependentBean : dependentBeans) &#123;</span><br><span class="line">                    if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">                        actualDependentBeans.add(dependentBean);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //检查依赖的bean是否都已经创建</span><br><span class="line">                if (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">                    throw new BeanCurrentlyInCreationException(beanName,</span><br><span class="line">                            &quot;Bean with name &apos;&quot; + beanName + &quot;&apos; has been injected into other beans [&quot; +</span><br><span class="line">                            StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">                            &quot;] in its raw version as part of a circular reference, but has eventually been &quot; +</span><br><span class="line">                            &quot;wrapped. This means that said other beans do not use the final version of the &quot; +</span><br><span class="line">                            &quot;bean. This is often the result of over-eager type matching - consider using &quot; +</span><br><span class="line">                            &quot;&apos;getBeanNamesOfType&apos; with the &apos;allowEagerInit&apos; flag turned off, for example.&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Register bean as disposable.</span><br><span class="line">    try &#123;</span><br><span class="line">        //根据scope注册bean</span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">        throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、AbstractAutowireCapableBeanFactory的createBeanInstance方法"><a href="#12、AbstractAutowireCapableBeanFactory的createBeanInstance方法" class="headerlink" title="12、AbstractAutowireCapableBeanFactory的createBeanInstance方法"></a>12、AbstractAutowireCapableBeanFactory的createBeanInstance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, Object[] args) &#123;</span><br><span class="line">    // Make sure bean class is actually resolved at this point.</span><br><span class="line">    //获取class</span><br><span class="line">    Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">    if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">        throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">                &quot;Bean class isn&apos;t public, and non-public access not allowed: &quot; + beanClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    //存在工厂方法，用工厂方法创建bean</span><br><span class="line">    if (mbd.getFactoryMethodName() != null)  &#123;</span><br><span class="line">        return instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Shortcut when re-creating the same bean...</span><br><span class="line">    boolean resolved = false;</span><br><span class="line">    boolean autowireNecessary = false;</span><br><span class="line">    //没有参数，不需解析</span><br><span class="line">    if (args == null) &#123;</span><br><span class="line">        synchronized (mbd.constructorArgumentLock) &#123;</span><br><span class="line">            if (mbd.resolvedConstructorOrFactoryMethod != null) &#123;</span><br><span class="line">                resolved = true;</span><br><span class="line">                autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //已经解析</span><br><span class="line">    if (resolved) &#123;</span><br><span class="line">        if (autowireNecessary) &#123;</span><br><span class="line">            //构造函数或工厂方法创建对象</span><br><span class="line">            return autowireConstructor(beanName, mbd, null, null);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //默认构造函数创建</span><br><span class="line">            return instantiateBean(beanName, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Need to determine the constructor...</span><br><span class="line">    //由参数解析构造函数或工厂方法</span><br><span class="line">    Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">    if (ctors != null ||</span><br><span class="line">            mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">            mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line">        return autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">    &#125;</span><br><span class="line">    //默认构造函数创建</span><br><span class="line">    // No special handling: simply use no-arg constructor.</span><br><span class="line">    return instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、AbstractAutowireCapableBeanFactory的instantiateBean方法"><a href="#13、AbstractAutowireCapableBeanFactory的instantiateBean方法" class="headerlink" title="13、AbstractAutowireCapableBeanFactory的instantiateBean方法"></a>13、AbstractAutowireCapableBeanFactory的instantiateBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">protected BeanWrapper instantiateBean(final String beanName, final RootBeanDefinition mbd) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Object beanInstance;</span><br><span class="line">        final BeanFactory parent = this;</span><br><span class="line">        if (System.getSecurityManager() != null) &#123;</span><br><span class="line">            beanInstance = AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Object run() &#123;</span><br><span class="line">                    return getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, getAccessControlContext());</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //创建bean</span><br><span class="line">            beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">        &#125;</span><br><span class="line">        BeanWrapper bw = new BeanWrapperImpl(beanInstance);</span><br><span class="line">        initBeanWrapper(bw);</span><br><span class="line">        return bw;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        throw new BeanCreationException(mbd.getResourceDescription(), beanName, &quot;Instantiation of bean failed&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、SimpleInstantiationStrategy的instantiate方法"><a href="#14、SimpleInstantiationStrategy的instantiate方法" class="headerlink" title="14、SimpleInstantiationStrategy的instantiate方法"></a>14、SimpleInstantiationStrategy的instantiate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object instantiate(RootBeanDefinition bd, String beanName, BeanFactory owner) &#123;</span><br><span class="line">    // Don&apos;t override the class with CGLIB if no overrides.</span><br><span class="line">    //</span><br><span class="line">    if (bd.getMethodOverrides().isEmpty()) &#123;</span><br><span class="line">        Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">        synchronized (bd.constructorArgumentLock) &#123;</span><br><span class="line">            constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">            if (constructorToUse == null) &#123;</span><br><span class="line">                final Class&lt;?&gt; clazz = bd.getBeanClass();</span><br><span class="line">                if (clazz.isInterface()) &#123;</span><br><span class="line">                    throw new BeanInstantiationException(clazz, &quot;Specified class is an interface&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (System.getSecurityManager() != null) &#123;</span><br><span class="line">                        constructorToUse = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;() &#123;</span><br><span class="line">                            @Override</span><br><span class="line">                            public Constructor&lt;?&gt; run() throws Exception &#123;</span><br><span class="line">                                return clazz.getDeclaredConstructor((Class[]) null);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        constructorToUse =  clazz.getDeclaredConstructor((Class[]) null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    bd.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception ex) &#123;</span><br><span class="line">                    throw new BeanInstantiationException(clazz, &quot;No default constructor found&quot;, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //直接通过反射创建</span><br><span class="line">        return BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Must generate CGLIB subclass.</span><br><span class="line">        //有需要覆盖或动态替换的方法，则使用CGLIB创建代理对象并将方法织入</span><br><span class="line">        return instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、CglibSubclassingInstantiationStrategy的instantiateWithMethodInjection方法"><a href="#15、CglibSubclassingInstantiationStrategy的instantiateWithMethodInjection方法" class="headerlink" title="15、CglibSubclassingInstantiationStrategy的instantiateWithMethodInjection方法"></a>15、CglibSubclassingInstantiationStrategy的instantiateWithMethodInjection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object instantiateWithMethodInjection(RootBeanDefinition bd, String beanName, BeanFactory owner) &#123;</span><br><span class="line">    return instantiateWithMethodInjection(bd, beanName, owner, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object instantiateWithMethodInjection(RootBeanDefinition bd, String beanName, BeanFactory owner,</span><br><span class="line">        Constructor&lt;?&gt; ctor, Object... args) &#123;</span><br><span class="line"></span><br><span class="line">    // Must generate CGLIB subclass...</span><br><span class="line">    return new CglibSubclassCreator(bd, owner).instantiate(ctor, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、CglibSubclassingInstantiationStrategy的instantiate方法"><a href="#16、CglibSubclassingInstantiationStrategy的instantiate方法" class="headerlink" title="16、CglibSubclassingInstantiationStrategy的instantiate方法"></a>16、CglibSubclassingInstantiationStrategy的instantiate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public Object instantiate(Constructor&lt;?&gt; ctor, Object... args) &#123;</span><br><span class="line">    Class&lt;?&gt; subclass = createEnhancedSubclass(this.beanDefinition);</span><br><span class="line">    Object instance;</span><br><span class="line">    if (ctor == null) &#123;</span><br><span class="line">        instance = BeanUtils.instantiate(subclass);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes());</span><br><span class="line">            instance = enhancedSubclassConstructor.newInstance(args);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex) &#123;</span><br><span class="line">            throw new BeanInstantiationException(this.beanDefinition.getBeanClass(),</span><br><span class="line">                    &quot;Failed to invoke constructor for CGLIB enhanced subclass [&quot; + subclass.getName() + &quot;]&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // SPR-10785: set callbacks directly on the instance instead of in the</span><br><span class="line">    // enhanced class (via the Enhancer) in order to avoid memory leaks.</span><br><span class="line">    Factory factory = (Factory) instance;</span><br><span class="line">    //拦截器，拦截对应的方法</span><br><span class="line">    factory.setCallbacks(new Callback[] &#123;NoOp.INSTANCE,</span><br><span class="line">            new LookupOverrideMethodInterceptor(this.beanDefinition, this.owner),</span><br><span class="line">            new ReplaceOverrideMethodInterceptor(this.beanDefinition, this.owner)&#125;);</span><br><span class="line">    return instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、CglibSubclassingInstantiationStrategy的createEnhancedSubclass方法"><a href="#17、CglibSubclassingInstantiationStrategy的createEnhancedSubclass方法" class="headerlink" title="17、CglibSubclassingInstantiationStrategy的createEnhancedSubclass方法"></a>17、CglibSubclassingInstantiationStrategy的createEnhancedSubclass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private Class&lt;?&gt; createEnhancedSubclass(RootBeanDefinition beanDefinition) &#123;</span><br><span class="line">    Enhancer enhancer = new Enhancer();</span><br><span class="line">    enhancer.setSuperclass(beanDefinition.getBeanClass());</span><br><span class="line">    enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">    /过滤器，accept方法返回的数字，代表了Callback数组中的索引位置</span><br><span class="line">    enhancer.setCallbackFilter(new MethodOverrideCallbackFilter(beanDefinition));</span><br><span class="line">    enhancer.setCallbackTypes(CALLBACK_TYPES);</span><br><span class="line">    return enhancer.createClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（一、11）AbstractAutowireCapableBeanFactory的populateBean方法"><a href="#18、接（一、11）AbstractAutowireCapableBeanFactory的populateBean方法" class="headerlink" title="18、接（一、11）AbstractAutowireCapableBeanFactory的populateBean方法"></a>18、接（一、11）AbstractAutowireCapableBeanFactory的populateBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) &#123;</span><br><span class="line">    //获取属性</span><br><span class="line">    PropertyValues pvs = mbd.getPropertyValues();</span><br><span class="line"></span><br><span class="line">    if (bw == null) &#123;</span><br><span class="line">        if (!pvs.isEmpty()) &#123;</span><br><span class="line">            throw new BeanCreationException(</span><br><span class="line">                    mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Skip property population phase for null instance.</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span><br><span class="line">    // state of the bean before properties are set. This can be used, for example,</span><br><span class="line">    // to support styles of field injection.</span><br><span class="line">    boolean continueWithPropertyPopulation = true;</span><br><span class="line">    //应用InstantiationAwareBeanPostProcessor</span><br><span class="line">    if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">        for (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">            if (bp instanceof InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">                if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">                    continueWithPropertyPopulation = false;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!continueWithPropertyPopulation) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</span><br><span class="line">            mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">        MutablePropertyValues newPvs = new MutablePropertyValues(pvs);</span><br><span class="line"></span><br><span class="line">        // Add property values based on autowire by name if applicable.</span><br><span class="line">        //根据名称自动注入</span><br><span class="line">        if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">            autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Add property values based on autowire by type if applicable.</span><br><span class="line">        //根据类型自动注入</span><br><span class="line">        if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">            autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pvs = newPvs;</span><br><span class="line">    &#125;</span><br><span class="line">    //后处理器已经初始化</span><br><span class="line">    boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">    //需要检查依赖</span><br><span class="line">    boolean needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">    if (hasInstAwareBpps || needsDepCheck) &#123;</span><br><span class="line">        PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">        if (hasInstAwareBpps) &#123;</span><br><span class="line">            for (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">                if (bp instanceof InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">                    InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">                    //对需要检查依赖的属性,进行后处理</span><br><span class="line">                    pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">                    if (pvs == null) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (needsDepCheck) &#123;</span><br><span class="line">            //检查依赖</span><br><span class="line">            checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //将属性应用到bean中</span><br><span class="line">    applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、AbstractAutowireCapableBeanFactory的autowireByName方法"><a href="#19、AbstractAutowireCapableBeanFactory的autowireByName方法" class="headerlink" title="19、AbstractAutowireCapableBeanFactory的autowireByName方法"></a>19、AbstractAutowireCapableBeanFactory的autowireByName方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">protected void autowireByName(</span><br><span class="line">        String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123;</span><br><span class="line">    //寻找依赖注入的属性</span><br><span class="line">    String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);</span><br><span class="line">    for (String propertyName : propertyNames) &#123;</span><br><span class="line">        if (containsBean(propertyName)) &#123;</span><br><span class="line">            //递归初始化相关的bean</span><br><span class="line">            Object bean = getBean(propertyName);</span><br><span class="line">            pvs.add(propertyName, bean);</span><br><span class="line">            //注册依赖</span><br><span class="line">            registerDependentBean(propertyName, beanName);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Added autowiring by name from bean name &apos;&quot; + beanName +</span><br><span class="line">                        &quot;&apos; via property &apos;&quot; + propertyName + &quot;&apos; to bean named &apos;&quot; + propertyName + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(&quot;Not autowiring property &apos;&quot; + propertyName + &quot;&apos; of bean &apos;&quot; + beanName +</span><br><span class="line">                        &quot;&apos; by name: no matching bean found&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、接（一、18）AbstractAutowireCapableBeanFactory的autowireByType方法"><a href="#20、接（一、18）AbstractAutowireCapableBeanFactory的autowireByType方法" class="headerlink" title="20、接（一、18）AbstractAutowireCapableBeanFactory的autowireByType方法"></a>20、接（一、18）AbstractAutowireCapableBeanFactory的autowireByType方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">protected void autowireByType(</span><br><span class="line">        String beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123;</span><br><span class="line"></span><br><span class="line">    TypeConverter converter = getCustomTypeConverter();</span><br><span class="line">    if (converter == null) &#123;</span><br><span class="line">        converter = bw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;String&gt;(4);</span><br><span class="line">    //获取需要依赖注入的属性</span><br><span class="line">    String[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);</span><br><span class="line">    for (String propertyName : propertyNames) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName);</span><br><span class="line">            // Don&apos;t try autowiring by type for type Object: never makes sense,</span><br><span class="line">            // even if it technically is a unsatisfied, non-simple property.</span><br><span class="line">            if (!Object.class.equals(pd.getPropertyType())) &#123;</span><br><span class="line">                MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd);</span><br><span class="line">                // Do not allow eager init for type matching in case of a prioritized post-processor.</span><br><span class="line">                boolean eager = !PriorityOrdered.class.isAssignableFrom(bw.getWrappedClass());</span><br><span class="line">                DependencyDescriptor desc = new AutowireByTypeDependencyDescriptor(methodParam, eager);</span><br><span class="line">                //解析该propertyName所对应的属性值</span><br><span class="line">                Object autowiredArgument = resolveDependency(desc, beanName, autowiredBeanNames, converter);</span><br><span class="line">                if (autowiredArgument != null) &#123;</span><br><span class="line">                    pvs.add(propertyName, autowiredArgument);</span><br><span class="line">                &#125;</span><br><span class="line">                for (String autowiredBeanName : autowiredBeanNames) &#123;</span><br><span class="line">                    registerDependentBean(autowiredBeanName, beanName);</span><br><span class="line">                    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(&quot;Autowiring by type from bean name &apos;&quot; + beanName + &quot;&apos; via property &apos;&quot; +</span><br><span class="line">                                propertyName + &quot;&apos; to bean named &apos;&quot; + autowiredBeanName + &quot;&apos;&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                autowiredBeanNames.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            throw new UnsatisfiedDependencyException(mbd.getResourceDescription(), beanName, propertyName, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、DefaultListableBeanFactory的resolveDependency方法"><a href="#21、DefaultListableBeanFactory的resolveDependency方法" class="headerlink" title="21、DefaultListableBeanFactory的resolveDependency方法"></a>21、DefaultListableBeanFactory的resolveDependency方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object resolveDependency(DependencyDescriptor descriptor, String beanName,</span><br><span class="line">        Set&lt;String&gt; autowiredBeanNames, TypeConverter typeConverter) throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">    descriptor.initParameterNameDiscovery(getParameterNameDiscoverer());</span><br><span class="line">    //javaUtilOptionalClass类注入特殊处理</span><br><span class="line">    if (descriptor.getDependencyType().equals(javaUtilOptionalClass)) &#123;</span><br><span class="line">        return new OptionalDependencyFactory().createOptionalDependency(descriptor, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    //ObjectFactory类注入特殊处理</span><br><span class="line">    else if (descriptor.getDependencyType().equals(ObjectFactory.class)) &#123;</span><br><span class="line">        return new DependencyObjectFactory(descriptor, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    //javaxInjectProviderClass类注入特殊处理</span><br><span class="line">    else if (descriptor.getDependencyType().equals(javaxInjectProviderClass)) &#123;</span><br><span class="line">        return new DependencyProviderFactory().createDependencyProvider(descriptor, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //懒加载，获取代理对象</span><br><span class="line">        Object result = getAutowireCandidateResolver().getLazyResolutionProxyIfNecessary(descriptor, beanName);</span><br><span class="line">        if (result == null) &#123;</span><br><span class="line">            //通用处理逻辑</span><br><span class="line">            result = doResolveDependency(descriptor, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、DefaultListableBeanFactory的doResolveDependency方法"><a href="#22、DefaultListableBeanFactory的doResolveDependency方法" class="headerlink" title="22、DefaultListableBeanFactory的doResolveDependency方法"></a>22、DefaultListableBeanFactory的doResolveDependency方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">public Object doResolveDependency(DependencyDescriptor descriptor, String beanName,</span><br><span class="line">        Set&lt;String&gt; autowiredBeanNames, TypeConverter typeConverter) throws BeansException &#123;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; type = descriptor.getDependencyType();</span><br><span class="line">    //解析注解@value</span><br><span class="line">    Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);</span><br><span class="line">    if (value != null) &#123;</span><br><span class="line">        if (value instanceof String) &#123;</span><br><span class="line">            //处理placeholder类型的value</span><br><span class="line">            String strVal = resolveEmbeddedValue((String) value);</span><br><span class="line">            BeanDefinition bd = (beanName != null &amp;&amp; containsBean(beanName) ? getMergedBeanDefinition(beanName) : null);</span><br><span class="line">            // 处理EL表达式  </span><br><span class="line">            value = evaluateBeanDefinitionString(strVal, bd);</span><br><span class="line">        &#125;</span><br><span class="line">        TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());</span><br><span class="line">        //类型转换</span><br><span class="line">        return (descriptor.getField() != null ?</span><br><span class="line">                converter.convertIfNecessary(value, type, descriptor.getField()) :</span><br><span class="line">                converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));</span><br><span class="line">    &#125;</span><br><span class="line">    //属性为数组类型</span><br><span class="line">    if (type.isArray()) &#123;</span><br><span class="line">        Class&lt;?&gt; componentType = type.getComponentType();</span><br><span class="line">        DependencyDescriptor targetDesc = new DependencyDescriptor(descriptor);</span><br><span class="line">        targetDesc.increaseNestingLevel();</span><br><span class="line">        //获取所有符合要求的类型的bean和类对象</span><br><span class="line">        Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, componentType, targetDesc);</span><br><span class="line">        if (matchingBeans.isEmpty()) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                raiseNoSuchBeanDefinitionException(componentType, &quot;array of &quot; + componentType.getName(), descriptor);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (autowiredBeanNames != null) &#123;</span><br><span class="line">            autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">        &#125;</span><br><span class="line">        TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());</span><br><span class="line">        Object result = converter.convertIfNecessary(matchingBeans.values(), type);</span><br><span class="line">        //将所有符合类型的类对象和bean，放入数组</span><br><span class="line">        if (getDependencyComparator() != null &amp;&amp; result instanceof Object[]) &#123;</span><br><span class="line">            Arrays.sort((Object[]) result, adaptDependencyComparator(matchingBeans));</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    //属性为Collection类型</span><br><span class="line">    else if (Collection.class.isAssignableFrom(type) &amp;&amp; type.isInterface()) &#123;</span><br><span class="line">        Class&lt;?&gt; elementType = descriptor.getCollectionType();</span><br><span class="line">        if (elementType == null) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                throw new FatalBeanException(&quot;No element type declared for collection [&quot; + type.getName() + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        DependencyDescriptor targetDesc = new DependencyDescriptor(descriptor);</span><br><span class="line">        targetDesc.increaseNestingLevel();</span><br><span class="line">        Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, elementType, targetDesc);</span><br><span class="line">        if (matchingBeans.isEmpty()) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                raiseNoSuchBeanDefinitionException(elementType, &quot;collection of &quot; + elementType.getName(), descriptor);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (autowiredBeanNames != null) &#123;</span><br><span class="line">            autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">        &#125;</span><br><span class="line">        TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());</span><br><span class="line">        Object result = converter.convertIfNecessary(matchingBeans.values(), type);</span><br><span class="line">        //将所有符合类型的类对象和bean，放入List</span><br><span class="line">        if (getDependencyComparator() != null &amp;&amp; result instanceof List) &#123;</span><br><span class="line">            Collections.sort((List&lt;?&gt;) result, adaptDependencyComparator(matchingBeans));</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    //属性为Map类型</span><br><span class="line">    else if (Map.class.isAssignableFrom(type) &amp;&amp; type.isInterface()) &#123;</span><br><span class="line">        Class&lt;?&gt; keyType = descriptor.getMapKeyType();</span><br><span class="line">        if (keyType == null || !String.class.isAssignableFrom(keyType)) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                throw new FatalBeanException(&quot;Key type [&quot; + keyType + &quot;] of map [&quot; + type.getName() +</span><br><span class="line">                        &quot;] must be assignable to [java.lang.String]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; valueType = descriptor.getMapValueType();</span><br><span class="line">        if (valueType == null) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                throw new FatalBeanException(&quot;No value type declared for map [&quot; + type.getName() + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        DependencyDescriptor targetDesc = new DependencyDescriptor(descriptor);</span><br><span class="line">        targetDesc.increaseNestingLevel();</span><br><span class="line">        Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, valueType, targetDesc);</span><br><span class="line">        if (matchingBeans.isEmpty()) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                raiseNoSuchBeanDefinitionException(valueType, &quot;map with value type &quot; + valueType.getName(), descriptor);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (autowiredBeanNames != null) &#123;</span><br><span class="line">            autowiredBeanNames.addAll(matchingBeans.keySet());</span><br><span class="line">        &#125;</span><br><span class="line">        //返回符合条件的bean和类对象</span><br><span class="line">        return matchingBeans;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);</span><br><span class="line">        if (matchingBeans.isEmpty()) &#123;</span><br><span class="line">            if (descriptor.isRequired()) &#123;</span><br><span class="line">                raiseNoSuchBeanDefinitionException(type, &quot;&quot;, descriptor);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        //多个bean符合类型要求</span><br><span class="line">        if (matchingBeans.size() &gt; 1) &#123;</span><br><span class="line">            //依次根据Primary属性、priority属性、bean的名字去确定唯一的bean</span><br><span class="line">            String primaryBeanName = determineAutowireCandidate(matchingBeans, descriptor);</span><br><span class="line">            if (primaryBeanName == null) &#123;</span><br><span class="line">                throw new NoUniqueBeanDefinitionException(type, matchingBeans.keySet());</span><br><span class="line">            &#125;</span><br><span class="line">            if (autowiredBeanNames != null) &#123;</span><br><span class="line">                autowiredBeanNames.add(primaryBeanName);</span><br><span class="line">            &#125;</span><br><span class="line">            //返回匹配的bean</span><br><span class="line">            return matchingBeans.get(primaryBeanName);</span><br><span class="line">        &#125;</span><br><span class="line">        // We have exactly one match.</span><br><span class="line">        Map.Entry&lt;String, Object&gt; entry = matchingBeans.entrySet().iterator().next();</span><br><span class="line">        if (autowiredBeanNames != null) &#123;</span><br><span class="line">            autowiredBeanNames.add(entry.getKey());</span><br><span class="line">        &#125;</span><br><span class="line">        //返回唯一的bean</span><br><span class="line">        return entry.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、接（一、18）AbstractAutowireCapableBeanFactory的applyPropertyValues方法"><a href="#23、接（一、18）AbstractAutowireCapableBeanFactory的applyPropertyValues方法" class="headerlink" title="23、接（一、18）AbstractAutowireCapableBeanFactory的applyPropertyValues方法"></a>23、接（一、18）AbstractAutowireCapableBeanFactory的applyPropertyValues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">protected void applyPropertyValues(String beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) &#123;</span><br><span class="line">    if (pvs == null || pvs.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MutablePropertyValues mpvs = null;</span><br><span class="line">    List&lt;PropertyValue&gt; original;</span><br><span class="line"></span><br><span class="line">    if (System.getSecurityManager() != null) &#123;</span><br><span class="line">        if (bw instanceof BeanWrapperImpl) &#123;</span><br><span class="line">            ((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pvs instanceof MutablePropertyValues) &#123;</span><br><span class="line">        mpvs = (MutablePropertyValues) pvs;</span><br><span class="line">        //mpvs中的值已被转换为对应的类型</span><br><span class="line">        if (mpvs.isConverted()) &#123;</span><br><span class="line">            // Shortcut: use the pre-converted values as-is.</span><br><span class="line">            try &#123;</span><br><span class="line">                //属性值设置到bean中</span><br><span class="line">                bw.setPropertyValues(mpvs);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (BeansException ex) &#123;</span><br><span class="line">                throw new BeanCreationException(</span><br><span class="line">                        mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //原始属性</span><br><span class="line">        original = mpvs.getPropertyValueList();</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //原始属性</span><br><span class="line">        original = Arrays.asList(pvs.getPropertyValues());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TypeConverter converter = getCustomTypeConverter();</span><br><span class="line">    if (converter == null) &#123;</span><br><span class="line">        converter = bw;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取对应的解析器</span><br><span class="line">    BeanDefinitionValueResolver valueResolver = new BeanDefinitionValueResolver(this, beanName, mbd, converter);</span><br><span class="line"></span><br><span class="line">    // Create a deep copy, resolving any references for values.</span><br><span class="line">    List&lt;PropertyValue&gt; deepCopy = new ArrayList&lt;PropertyValue&gt;(original.size());</span><br><span class="line">    boolean resolveNecessary = false;</span><br><span class="line">    //将属性转换为对应的属性类型</span><br><span class="line">    for (PropertyValue pv : original) &#123;</span><br><span class="line">        if (pv.isConverted()) &#123;</span><br><span class="line">            deepCopy.add(pv);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            String propertyName = pv.getName();</span><br><span class="line">            Object originalValue = pv.getValue();</span><br><span class="line">            //解析属性值</span><br><span class="line">            Object resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</span><br><span class="line">            Object convertedValue = resolvedValue;</span><br><span class="line">            boolean convertible = bw.isWritableProperty(propertyName) &amp;&amp;</span><br><span class="line">                    !PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);</span><br><span class="line">            if (convertible) &#123;</span><br><span class="line">                convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter);</span><br><span class="line">            &#125;</span><br><span class="line">            // Possibly store converted value in merged bean definition,</span><br><span class="line">            // in order to avoid re-conversion for every created bean instance.</span><br><span class="line">            if (resolvedValue == originalValue) &#123;</span><br><span class="line">                if (convertible) &#123;</span><br><span class="line">                    pv.setConvertedValue(convertedValue);</span><br><span class="line">                &#125;</span><br><span class="line">                deepCopy.add(pv);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (convertible &amp;&amp; originalValue instanceof TypedStringValue &amp;&amp;</span><br><span class="line">                    !((TypedStringValue) originalValue).isDynamic() &amp;&amp;</span><br><span class="line">                    !(convertedValue instanceof Collection || ObjectUtils.isArray(convertedValue))) &#123;</span><br><span class="line">                pv.setConvertedValue(convertedValue);</span><br><span class="line">                deepCopy.add(pv);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                resolveNecessary = true;</span><br><span class="line">                deepCopy.add(new PropertyValue(pv, convertedValue));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (mpvs != null &amp;&amp; !resolveNecessary) &#123;</span><br><span class="line">        mpvs.setConverted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Set our (possibly massaged) deep copy.</span><br><span class="line">    try &#123;</span><br><span class="line">        //设置属性值</span><br><span class="line">        bw.setPropertyValues(new MutablePropertyValues(deepCopy));</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeansException ex) &#123;</span><br><span class="line">        throw new BeanCreationException(</span><br><span class="line">                mbd.getResourceDescription(), beanName, &quot;Error setting property values&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="24、接（一、11）AbstractAutowireCapableBeanFactory的initializeBean方法"><a href="#24、接（一、11）AbstractAutowireCapableBeanFactory的initializeBean方法" class="headerlink" title="24、接（一、11）AbstractAutowireCapableBeanFactory的initializeBean方法"></a>24、接（一、11）AbstractAutowireCapableBeanFactory的initializeBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">protected Object initializeBean(final String beanName, final Object bean, RootBeanDefinition mbd) &#123;</span><br><span class="line">    if (System.getSecurityManager() != null) &#123;</span><br><span class="line">        AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Object run() &#123;</span><br><span class="line">                invokeAwareMethods(beanName, bean);</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, getAccessControlContext());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //处理特殊的bean，BeanNameAware、BeanClassLoaderAware、BeanFactoryAware</span><br><span class="line">        invokeAwareMethods(beanName, bean);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object wrappedBean = bean;</span><br><span class="line">    if (mbd == null || !mbd.isSynthetic()) &#123;</span><br><span class="line">        //应用初始化前处理器</span><br><span class="line">        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //用户自定义初始化方法，如InitializingBean接口afterPropertiesSet方法、init-method方法</span><br><span class="line">        invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        throw new BeanCreationException(</span><br><span class="line">                (mbd != null ? mbd.getResourceDescription() : null),</span><br><span class="line">                beanName, &quot;Invocation of init method failed&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mbd == null || !mbd.isSynthetic()) &#123;</span><br><span class="line">        //应用初始化后处理器</span><br><span class="line">        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    return wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25、接（一、11）AbstractAutowireCapableBeanFactory的registerDisposableBeanIfNecessary方法"><a href="#25、接（一、11）AbstractAutowireCapableBeanFactory的registerDisposableBeanIfNecessary方法" class="headerlink" title="25、接（一、11）AbstractAutowireCapableBeanFactory的registerDisposableBeanIfNecessary方法"></a>25、接（一、11）AbstractAutowireCapableBeanFactory的registerDisposableBeanIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) &#123;</span><br><span class="line">    AccessControlContext acc = (System.getSecurityManager() != null ? getAccessControlContext() : null);</span><br><span class="line">    if (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) &#123;</span><br><span class="line">        if (mbd.isSingleton()) &#123;</span><br><span class="line">            // Register a DisposableBean implementation that performs all destruction</span><br><span class="line">            // work for the given bean: DestructionAwareBeanPostProcessors,</span><br><span class="line">            // DisposableBean interface, custom destroy method.</span><br><span class="line">            //单例模式，注册bean销毁时的回调</span><br><span class="line">            //销毁时会调用DestructionAwareBeanPostProcessor的postProcessBeforeDestruction方法</span><br><span class="line">            //DisposableBean的destroy方法、destory-method方法</span><br><span class="line">            registerDisposableBean(beanName,</span><br><span class="line">                    new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // A bean with a custom scope...</span><br><span class="line">            Scope scope = this.scopes.get(mbd.getScope());</span><br><span class="line">            if (scope == null) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;No Scope registered for scope &apos;&quot; + mbd.getScope() + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //在scope中，注册bean销毁时的回调</span><br><span class="line">            //销毁时会调用DestructionAwareBeanPostProcessor的postProcessBeforeDestruction方法</span><br><span class="line">            //DisposableBean的destroy方法、destory-method方法</span><br><span class="line">            scope.registerDestructionCallback(beanName,</span><br><span class="line">                    new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、bean销毁"><a href="#二、bean销毁" class="headerlink" title="二、bean销毁"></a>二、bean销毁</h3><h4 id="1、DefaultListableBeanFactory的destroySingletons方法"><a href="#1、DefaultListableBeanFactory的destroySingletons方法" class="headerlink" title="1、DefaultListableBeanFactory的destroySingletons方法"></a>1、DefaultListableBeanFactory的destroySingletons方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void destroySingletons() &#123;</span><br><span class="line">    super.destroySingletons();</span><br><span class="line">    //清除注册bean</span><br><span class="line">    this.manualSingletonNames.clear();</span><br><span class="line">    //清除缓存</span><br><span class="line">    clearByTypeCache();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、DefaultSingletonBeanRegistry的destroySingletons方法"><a href="#2、DefaultSingletonBeanRegistry的destroySingletons方法" class="headerlink" title="2、DefaultSingletonBeanRegistry的destroySingletons方法"></a>2、DefaultSingletonBeanRegistry的destroySingletons方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public void destroySingletons() &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Destroying singletons in &quot; + this);</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized (this.singletonObjects) &#123;</span><br><span class="line">        this.singletonsCurrentlyInDestruction = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] disposableBeanNames;</span><br><span class="line">    synchronized (this.disposableBeans) &#123;</span><br><span class="line">        //待销毁的beanName</span><br><span class="line">        disposableBeanNames = StringUtils.toStringArray(this.disposableBeans.keySet());</span><br><span class="line">    &#125;</span><br><span class="line">    for (int i = disposableBeanNames.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">        //销毁bean</span><br><span class="line">        destroySingleton(disposableBeanNames[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    //清除</span><br><span class="line">    this.containedBeanMap.clear();</span><br><span class="line">    this.dependentBeanMap.clear();</span><br><span class="line">    this.dependenciesForBeanMap.clear();</span><br><span class="line"></span><br><span class="line">    synchronized (this.singletonObjects) &#123;</span><br><span class="line">        this.singletonObjects.clear();</span><br><span class="line">        this.singletonFactories.clear();</span><br><span class="line">        this.earlySingletonObjects.clear();</span><br><span class="line">        this.registeredSingletons.clear();</span><br><span class="line">        this.singletonsCurrentlyInDestruction = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、DefaultSingletonBeanRegistry的destroySingleton方法"><a href="#3、DefaultSingletonBeanRegistry的destroySingleton方法" class="headerlink" title="3、DefaultSingletonBeanRegistry的destroySingleton方法"></a>3、DefaultSingletonBeanRegistry的destroySingleton方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public void destroySingleton(String beanName) &#123;</span><br><span class="line">    // Remove a registered singleton of the given name, if any.</span><br><span class="line">    //删除该bean</span><br><span class="line">    removeSingleton(beanName);</span><br><span class="line"></span><br><span class="line">    // Destroy the corresponding DisposableBean instance.</span><br><span class="line">    DisposableBean disposableBean;</span><br><span class="line">    synchronized (this.disposableBeans) &#123;</span><br><span class="line">        //删除该bean的销毁回调函数</span><br><span class="line">        disposableBean = (DisposableBean) this.disposableBeans.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    //执行销毁方法</span><br><span class="line">    destroyBean(beanName, disposableBean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DefaultSingletonBeanRegistry的destroyBean方法"><a href="#4、DefaultSingletonBeanRegistry的destroyBean方法" class="headerlink" title="4、DefaultSingletonBeanRegistry的destroyBean方法"></a>4、DefaultSingletonBeanRegistry的destroyBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">protected void destroyBean(String beanName, DisposableBean bean) &#123;</span><br><span class="line">    // Trigger destruction of dependent beans first...</span><br><span class="line">    //销毁依赖该bean的bean</span><br><span class="line">    Set&lt;String&gt; dependencies = this.dependentBeanMap.remove(beanName);</span><br><span class="line">    if (dependencies != null) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Retrieved dependent beans for bean &apos;&quot; + beanName + &quot;&apos;: &quot; + dependencies);</span><br><span class="line">        &#125;</span><br><span class="line">        for (String dependentBeanName : dependencies) &#123;</span><br><span class="line">            destroySingleton(dependentBeanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Actually destroy the bean now...</span><br><span class="line">    if (bean != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //销毁bean</span><br><span class="line">            bean.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            logger.error(&quot;Destroy method on bean with name &apos;&quot; + beanName + &quot;&apos; threw an exception&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Trigger destruction of contained beans...</span><br><span class="line">    //销毁该bean拥有的bean</span><br><span class="line">    Set&lt;String&gt; containedBeans = this.containedBeanMap.remove(beanName);</span><br><span class="line">    if (containedBeans != null) &#123;</span><br><span class="line">        for (String containedBeanName : containedBeans) &#123;</span><br><span class="line">            destroySingleton(containedBeanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Remove destroyed bean from other beans&apos; dependencies.</span><br><span class="line">    //删除注册的依赖</span><br><span class="line">    synchronized (this.dependentBeanMap) &#123;</span><br><span class="line">        for (Iterator&lt;Map.Entry&lt;String, Set&lt;String&gt;&gt;&gt; it = this.dependentBeanMap.entrySet().iterator(); it.hasNext();) &#123;</span><br><span class="line">            Map.Entry&lt;String, Set&lt;String&gt;&gt; entry = it.next();</span><br><span class="line">            Set&lt;String&gt; dependenciesToClean = entry.getValue();</span><br><span class="line">            dependenciesToClean.remove(beanName);</span><br><span class="line">            if (dependenciesToClean.isEmpty()) &#123;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Remove destroyed bean&apos;s prepared dependency information.</span><br><span class="line">    this.dependenciesForBeanMap.remove(beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DisposableBeanAdapter的destroy方法"><a href="#5、DisposableBeanAdapter的destroy方法" class="headerlink" title="5、DisposableBeanAdapter的destroy方法"></a>5、DisposableBeanAdapter的destroy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void destroy() &#123;</span><br><span class="line">    //应用DestructionAwareBeanPostProcessor</span><br><span class="line">    if (this.beanPostProcessors != null &amp;&amp; !this.beanPostProcessors.isEmpty()) &#123;</span><br><span class="line">        for (DestructionAwareBeanPostProcessor processor : this.beanPostProcessors) &#123;</span><br><span class="line">            processor.postProcessBeforeDestruction(this.bean, this.beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.invokeDisposableBean) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Invoking destroy() on bean with name &apos;&quot; + this.beanName + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (System.getSecurityManager() != null) &#123;</span><br><span class="line">                AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public Object run() throws Exception &#123;</span><br><span class="line">                        ((DisposableBean) bean).destroy();</span><br><span class="line">                        return null;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, acc);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                //执行destroy方法</span><br><span class="line">                ((DisposableBean) bean).destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            String msg = &quot;Invocation of destroy method failed on bean with name &apos;&quot; + this.beanName + &quot;&apos;&quot;;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.warn(msg, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                logger.warn(msg + &quot;: &quot; + ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //自定义的destory-method方法</span><br><span class="line">    if (this.destroyMethod != null) &#123;</span><br><span class="line">        invokeCustomDestroyMethod(this.destroyMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (this.destroyMethodName != null) &#123;</span><br><span class="line">        Method methodToCall = determineDestroyMethod();</span><br><span class="line">        if (methodToCall != null) &#123;</span><br><span class="line">            invokeCustomDestroyMethod(methodToCall);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、bean加载&quot;&gt;&lt;a href=&quot;#一、bean加载&quot; class=&quot;headerlink&quot; title=&quot;一、bean加载&quot;&gt;&lt;/a&gt;一、bean加载&lt;/h3&gt;&lt;h4 id=&quot;1、AbstractBeanFactory的getBean方法&quot;&gt;&lt;a href=
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码XmlBeanFactory(1)</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81XmlBeanFactory(1)/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码XmlBeanFactory(1)/</id>
    <published>2018-06-27T13:10:29.031Z</published>
    <updated>2018-06-28T14:09:03.301Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Demo &#123;</span><br><span class="line">   </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //step1: 读取spring的xml   （spring核心的是BeanFactory）</span><br><span class="line">        // 把资源文件封装为Spring的Resource</span><br><span class="line">        // spring把资源文件封装成统一的Resource进行管理，和提供一些基本的方法。</span><br><span class="line">        Resource resource = new ClassPathResource(&quot;spring-demo.xml&quot;);</span><br><span class="line"></span><br><span class="line">        // 加载资源文件，把xml中的bean definition注册到：1.把Resource再次封装为EncodedResource</span><br><span class="line">        XmlBeanFactory factory = new XmlBeanFactory(resource);</span><br><span class="line">        Demo0102Bean bean = (Demo) factory.getBean(&quot;demo&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一、xml文件读取"><a href="#一、xml文件读取" class="headerlink" title="一、xml文件读取"></a>一、xml文件读取</h3><h4 id="1、实例化XmlBeanFactory"><a href="#1、实例化XmlBeanFactory" class="headerlink" title="1、实例化XmlBeanFactory"></a>1、实例化XmlBeanFactory</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public XmlBeanFactory(Resource resource) throws BeansException &#123;</span><br><span class="line">    this(resource, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public XmlBeanFactory(Resource resource, BeanFactory parentBeanFactory) throws BeansException &#123;</span><br><span class="line">    super(parentBeanFactory);</span><br><span class="line">    this.reader.loadBeanDefinitions(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、XmlBeanDefinitionReader的loadBeanDefinitions方法"><a href="#2、XmlBeanDefinitionReader的loadBeanDefinitions方法" class="headerlink" title="2、XmlBeanDefinitionReader的loadBeanDefinitions方法"></a>2、XmlBeanDefinitionReader的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int loadBeanDefinitions(Resource resource) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    return loadBeanDefinitions(new EncodedResource(resource));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public int loadBeanDefinitions(EncodedResource encodedResource) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    Assert.notNull(encodedResource, &quot;EncodedResource must not be null&quot;);</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Loading XML bean definitions from &quot; + encodedResource.getResource());</span><br><span class="line">    &#125;</span><br><span class="line">    //记录已加载的资源</span><br><span class="line">    Set&lt;EncodedResource&gt; currentResources = this.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">    if (currentResources == null) &#123;</span><br><span class="line">        currentResources = new HashSet&lt;EncodedResource&gt;(4);</span><br><span class="line">        this.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(</span><br><span class="line">                &quot;Detected cyclic loading of &quot; + encodedResource + &quot; - check your import definitions!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取输入流</span><br><span class="line">        InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">        try &#123;</span><br><span class="line">            InputSource inputSource = new InputSource(inputStream);</span><br><span class="line">            if (encodedResource.getEncoding() != null) &#123;</span><br><span class="line">                inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">            &#125;</span><br><span class="line">            //读取xml</span><br><span class="line">            return doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(</span><br><span class="line">                &quot;IOException parsing XML document from &quot; + encodedResource.getResource(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        currentResources.remove(encodedResource);</span><br><span class="line">        if (currentResources.isEmpty()) &#123;</span><br><span class="line">            this.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、XmlBeanDefinitionReader的doLoadBeanDefinitions方法"><a href="#3、XmlBeanDefinitionReader的doLoadBeanDefinitions方法" class="headerlink" title="3、XmlBeanDefinitionReader的doLoadBeanDefinitions方法"></a>3、XmlBeanDefinitionReader的doLoadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource)</span><br><span class="line">        throws BeanDefinitionStoreException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //xml读取为Document</span><br><span class="line">        Document doc = doLoadDocument(inputSource, resource);</span><br><span class="line">        //解析配置文件</span><br><span class="line">        return registerBeanDefinitions(doc, resource);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (SAXParseException ex) &#123;</span><br><span class="line">        throw new XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                &quot;Line &quot; + ex.getLineNumber() + &quot; in XML document from &quot; + resource + &quot; is invalid&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (SAXException ex) &#123;</span><br><span class="line">        throw new XmlBeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                &quot;XML document from &quot; + resource + &quot; is invalid&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ParserConfigurationException ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                &quot;Parser configuration exception parsing XML from &quot; + resource, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                &quot;IOException parsing XML document from &quot; + resource, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(resource.getDescription(),</span><br><span class="line">                &quot;Unexpected exception parsing XML document from &quot; + resource, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、XmlBeanDefinitionReader的doLoadDocument方法"><a href="#4、XmlBeanDefinitionReader的doLoadDocument方法" class="headerlink" title="4、XmlBeanDefinitionReader的doLoadDocument方法"></a>4、XmlBeanDefinitionReader的doLoadDocument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected Document doLoadDocument(InputSource inputSource, Resource resource) throws Exception &#123;</span><br><span class="line">    return this.documentLoader.loadDocument(inputSource, getEntityResolver(), this.errorHandler,</span><br><span class="line">            getValidationModeForResource(resource), isNamespaceAware());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、XmlBeanDefinitionReader的getValidationModeForResource方法"><a href="#5、XmlBeanDefinitionReader的getValidationModeForResource方法" class="headerlink" title="5、XmlBeanDefinitionReader的getValidationModeForResource方法"></a>5、XmlBeanDefinitionReader的getValidationModeForResource方法</h4><p>获取xml验证模式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected int getValidationModeForResource(Resource resource) &#123;</span><br><span class="line">    int validationModeToUse = getValidationMode();</span><br><span class="line">    //优先使用指定的验证模式</span><br><span class="line">    if (validationModeToUse != VALIDATION_AUTO) &#123;</span><br><span class="line">        return validationModeToUse;</span><br><span class="line">    &#125;</span><br><span class="line">    //自动检测，查看配置文件是否包含DOCTYPE，包含则为DTD，不包含则为XSD</span><br><span class="line">    int detectedMode = detectValidationMode(resource);</span><br><span class="line">    if (detectedMode != VALIDATION_AUTO) &#123;</span><br><span class="line">        return detectedMode;</span><br><span class="line">    &#125;</span><br><span class="line">    //默认XSD</span><br><span class="line">    return VALIDATION_XSD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、接（一、4）XmlBeanDefinitionReader的getEntityResolver方法"><a href="#6、接（一、4）XmlBeanDefinitionReader的getEntityResolver方法" class="headerlink" title="6、接（一、4）XmlBeanDefinitionReader的getEntityResolver方法"></a>6、接（一、4）XmlBeanDefinitionReader的getEntityResolver方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected EntityResolver getEntityResolver() &#123;</span><br><span class="line">    if (this.entityResolver == null) &#123;</span><br><span class="line">        // Determine default EntityResolver to use.</span><br><span class="line">        ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">        if (resourceLoader != null) &#123;</span><br><span class="line">            this.entityResolver = new ResourceEntityResolver(resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //默认的EntityResolver</span><br><span class="line">            this.entityResolver = new DelegatingEntityResolver(getBeanClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return this.entityResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、XmlBeanDefinitionReader的resolveEntity方法"><a href="#7、XmlBeanDefinitionReader的resolveEntity方法" class="headerlink" title="7、XmlBeanDefinitionReader的resolveEntity方法"></a>7、XmlBeanDefinitionReader的resolveEntity方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public InputSource resolveEntity(String publicId, String systemId) throws SAXException, IOException &#123;</span><br><span class="line">    if (systemId != null) &#123;</span><br><span class="line">        if (systemId.endsWith(DTD_SUFFIX)) &#123;</span><br><span class="line">            //解析dtd</span><br><span class="line">            return this.dtdResolver.resolveEntity(publicId, systemId);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (systemId.endsWith(XSD_SUFFIX)) &#123;</span><br><span class="line">            //解析xsd</span><br><span class="line">            return this.schemaResolver.resolveEntity(publicId, systemId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、BeansDtdResolver的resolveEntity方法"><a href="#8、BeansDtdResolver的resolveEntity方法" class="headerlink" title="8、BeansDtdResolver的resolveEntity方法"></a>8、BeansDtdResolver的resolveEntity方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//publicId -//SPRING//DTD BEAN//EN</span><br><span class="line">//systemId http://www.springframework.org/dtd/spring-beans.dtd</span><br><span class="line">@Override</span><br><span class="line">public InputSource resolveEntity(String publicId, String systemId) throws IOException &#123;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Trying to resolve XML entity with public ID [&quot; + publicId +</span><br><span class="line">                &quot;] and system ID [&quot; + systemId + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (systemId != null &amp;&amp; systemId.endsWith(DTD_EXTENSION)) &#123;</span><br><span class="line">        int lastPathSeparator = systemId.lastIndexOf(&quot;/&quot;);</span><br><span class="line">        int dtdNameStart = systemId.indexOf(DTD_NAME);</span><br><span class="line">        if (dtdNameStart &gt; lastPathSeparator) &#123;</span><br><span class="line">            //spring-beans-2.0.dtd</span><br><span class="line">            String dtdFile = DTD_FILENAME + DTD_EXTENSION;</span><br><span class="line">            if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                logger.trace(&quot;Trying to locate [&quot; + dtdFile + &quot;] in Spring jar on classpath&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                Resource resource = new ClassPathResource(dtdFile, getClass());</span><br><span class="line">                InputSource source = new InputSource(resource.getInputStream());</span><br><span class="line">                source.setPublicId(publicId);</span><br><span class="line">                source.setSystemId(systemId);</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Found beans DTD [&quot; + systemId + &quot;] in classpath: &quot; + dtdFile);</span><br><span class="line">                &#125;</span><br><span class="line">                return source;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (IOException ex) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Could not resolve beans DTD [&quot; + systemId + &quot;]: not found in classpath&quot;, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Use the default behavior -&gt; download from website or wherever.</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（一、6）PluggableSchemaResolver的resolveEntity方法"><a href="#9、接（一、6）PluggableSchemaResolver的resolveEntity方法" class="headerlink" title="9、接（一、6）PluggableSchemaResolver的resolveEntity方法"></a>9、接（一、6）PluggableSchemaResolver的resolveEntity方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">//publicId null</span><br><span class="line">//systemId http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span><br><span class="line">@Override</span><br><span class="line">public InputSource resolveEntity(String publicId, String systemId) throws IOException &#123;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Trying to resolve XML entity with public id [&quot; + publicId +</span><br><span class="line">                &quot;] and system id [&quot; + systemId + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (systemId != null) &#123;</span><br><span class="line">        //从META-INF/spring.schemas中获取验证文件位置,org/springframework/beans/factory/xml/spring-beans-4.0.xsd</span><br><span class="line">        String resourceLocation = getSchemaMappings().get(systemId);</span><br><span class="line">        if (resourceLocation != null) &#123;</span><br><span class="line">            Resource resource = new ClassPathResource(resourceLocation, this.classLoader);</span><br><span class="line">            try &#123;</span><br><span class="line">                InputSource source = new InputSource(resource.getInputStream());</span><br><span class="line">                source.setPublicId(publicId);</span><br><span class="line">                source.setSystemId(systemId);</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Found XML schema [&quot; + systemId + &quot;] in classpath: &quot; + resourceLocation);</span><br><span class="line">                &#125;</span><br><span class="line">                return source;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (FileNotFoundException ex) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Couldn&apos;t find XML schema [&quot; + systemId + &quot;]: &quot; + resource, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、默认标签解析"><a href="#二、默认标签解析" class="headerlink" title="二、默认标签解析"></a>二、默认标签解析</h3><h4 id="1、接（一、3）XmlBeanDefinitionReader的registerBeanDefinitions方法"><a href="#1、接（一、3）XmlBeanDefinitionReader的registerBeanDefinitions方法" class="headerlink" title="1、接（一、3）XmlBeanDefinitionReader的registerBeanDefinitions方法"></a>1、接（一、3）XmlBeanDefinitionReader的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;deprecation&quot;)</span><br><span class="line">public int registerBeanDefinitions(Document doc, Resource resource) throws BeanDefinitionStoreException &#123;</span><br><span class="line">    //获取解析器默认DefaultBeanDefinitionDocumentReader</span><br><span class="line">    BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line">    documentReader.setEnvironment(getEnvironment());</span><br><span class="line">    int countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line">    //解析xml</span><br><span class="line">    documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">    return getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法"><a href="#2、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法" class="headerlink" title="2、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法"></a>2、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(Document doc, XmlReaderContext readerContext) &#123;</span><br><span class="line">    this.readerContext = readerContext;</span><br><span class="line">    logger.debug(&quot;Loading bean definitions&quot;);</span><br><span class="line">    Element root = doc.getDocumentElement();</span><br><span class="line">    //解析xml</span><br><span class="line">    doRegisterBeanDefinitions(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法"><a href="#3、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法" class="headerlink" title="3、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法"></a>3、DefaultBeanDefinitionDocumentReader的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected void doRegisterBeanDefinitions(Element root) &#123;</span><br><span class="line">    //标签的处理器</span><br><span class="line">    BeanDefinitionParserDelegate parent = this.delegate;</span><br><span class="line">    //默认为BeanDefinitionParserDelegate</span><br><span class="line">    this.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line">    //处理profile属性，只能是默认标签</span><br><span class="line">    if (this.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">        String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">        //当前beans为profile文件</span><br><span class="line">        if (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">            String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">                    profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">            //profile不是激活文件，则不处理该beans</span><br><span class="line">            if (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //解析前处理，留给子类实现</span><br><span class="line">    preProcessXml(root);</span><br><span class="line">    //处理当前beans</span><br><span class="line">    parseBeanDefinitions(root, this.delegate);</span><br><span class="line">    //解析后处理，留给子类实现</span><br><span class="line">    postProcessXml(root);</span><br><span class="line"></span><br><span class="line">    this.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法"><a href="#4、DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法" class="headerlink" title="4、DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法"></a>4、DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">protected void parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123;</span><br><span class="line">    //根标签为默认标签</span><br><span class="line">    if (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">        NodeList nl = root.getChildNodes();</span><br><span class="line">        for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">            Node node = nl.item(i);</span><br><span class="line">            if (node instanceof Element) &#123;</span><br><span class="line">                Element ele = (Element) node;</span><br><span class="line">                if (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">                    //解析默认标签</span><br><span class="line">                    parseDefaultElement(ele, delegate);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    //解析自定义标签</span><br><span class="line">                    delegate.parseCustomElement(ele);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //解析自定义标签</span><br><span class="line">        delegate.parseCustomElement(root);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DefaultBeanDefinitionDocumentReader的parseDefaultElement方法"><a href="#5、DefaultBeanDefinitionDocumentReader的parseDefaultElement方法" class="headerlink" title="5、DefaultBeanDefinitionDocumentReader的parseDefaultElement方法"></a>5、DefaultBeanDefinitionDocumentReader的parseDefaultElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private void parseDefaultElement(Element ele, BeanDefinitionParserDelegate delegate) &#123;</span><br><span class="line">    //处理import标签</span><br><span class="line">    if (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">        importBeanDefinitionResource(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    //处理alias标签</span><br><span class="line">    else if (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">        processAliasRegistration(ele);</span><br><span class="line">    &#125;</span><br><span class="line">    //处理bean标签</span><br><span class="line">    else if (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">        processBeanDefinition(ele, delegate);</span><br><span class="line">    &#125;</span><br><span class="line">    //处理beans标签,递归调用(二、4)</span><br><span class="line">    else if (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">        // recurse</span><br><span class="line">        doRegisterBeanDefinitions(ele);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、DefaultBeanDefinitionDocumentReader的processBeanDefinition方法"><a href="#6、DefaultBeanDefinitionDocumentReader的processBeanDefinition方法" class="headerlink" title="6、DefaultBeanDefinitionDocumentReader的processBeanDefinition方法"></a>6、DefaultBeanDefinitionDocumentReader的processBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected void processBeanDefinition(Element ele, BeanDefinitionParserDelegate delegate) &#123;</span><br><span class="line">    //解析元素</span><br><span class="line">    BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">    if (bdHolder != null) &#123;</span><br><span class="line">        //解析子节点下的自定义属性和标签</span><br><span class="line">        bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">        try &#123;</span><br><span class="line">            //注册bdHolder</span><br><span class="line">            BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(&quot;Failed to register bean definition with name &apos;&quot; +</span><br><span class="line">                    bdHolder.getBeanName() + &quot;&apos;&quot;, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        // Send registration event.</span><br><span class="line">        //向监听器发送，该bean注册完成事件</span><br><span class="line">        getReaderContext().fireComponentRegistered(new BeanComponentDefinition(bdHolder));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法"><a href="#7、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法" class="headerlink" title="7、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法"></a>7、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public BeanDefinitionHolder parseBeanDefinitionElement(Element ele) &#123;</span><br><span class="line">    return parseBeanDefinitionElement(ele, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">public BeanDefinitionHolder parseBeanDefinitionElement(Element ele, BeanDefinition containingBean) &#123;</span><br><span class="line">    //获取id属性</span><br><span class="line">    String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">    //获取name属性</span><br><span class="line">    String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    //处理别名</span><br><span class="line">    List&lt;String&gt; aliases = new ArrayList&lt;String&gt;();</span><br><span class="line">    if (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">        String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">        aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">    &#125;</span><br><span class="line">    //beanName默认为id</span><br><span class="line">    String beanName = id;</span><br><span class="line">    if (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">        beanName = aliases.remove(0);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;No XML &apos;id&apos; specified - using &apos;&quot; + beanName +</span><br><span class="line">                    &quot;&apos; as bean name and &quot; + aliases + &quot; as aliases&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //不是嵌套bean，检查是否重名</span><br><span class="line">    if (containingBean == null) &#123;</span><br><span class="line">        checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析bean的子标签</span><br><span class="line">    AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">    if (beanDefinition != null) &#123;</span><br><span class="line">        //没有beanName则生成一个，不是嵌套bean，默认获取全类名。与注解容器中不同。</span><br><span class="line">        if (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (containingBean != null) &#123;</span><br><span class="line">                    beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                            beanDefinition, this.readerContext.getRegistry(), true);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    beanName = this.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">                    // Register an alias for the plain bean class name, if still possible,</span><br><span class="line">                    // if the generator returned the class name plus a suffix.</span><br><span class="line">                    // This is expected for Spring 1.2/2.0 backwards compatibility.</span><br><span class="line">                    String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">                    if (beanClassName != null &amp;&amp;</span><br><span class="line">                            beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                            !this.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                        aliases.add(beanClassName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Neither XML &apos;id&apos; nor &apos;name&apos; specified - &quot; +</span><br><span class="line">                            &quot;using generated bean name [&quot; + beanName + &quot;]&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex) &#123;</span><br><span class="line">                error(ex.getMessage(), ele);</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">        //beanDefinition放入BeanDefinitionHolder中，并返回</span><br><span class="line">        return new BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法"><a href="#8、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法" class="headerlink" title="8、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法"></a>8、BeanDefinitionParserDelegate的parseBeanDefinitionElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public AbstractBeanDefinition parseBeanDefinitionElement(</span><br><span class="line">        Element ele, String beanName, BeanDefinition containingBean) &#123;</span><br><span class="line"></span><br><span class="line">    this.parseState.push(new BeanEntry(beanName));</span><br><span class="line">    //解析class属性</span><br><span class="line">    String className = null;</span><br><span class="line">    if (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">        className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //解析parent属性</span><br><span class="line">        String parent = null;</span><br><span class="line">        if (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">            parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建用于存放属性的AbstractBeanDefinition，默认为GenericBeanDefinition</span><br><span class="line">        AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line">        //解析bean的各个属性</span><br><span class="line">        parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">        //设置描述</span><br><span class="line">        bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line">        //解析元数据</span><br><span class="line">        parseMetaElements(ele, bd);</span><br><span class="line">        //解析lookup-method属性</span><br><span class="line">        parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">        //解析replaced-method属性</span><br><span class="line">        parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">        //解析构造函数参数</span><br><span class="line">        parseConstructorArgElements(ele, bd);</span><br><span class="line">        //解析property子元素</span><br><span class="line">        parsePropertyElements(ele, bd);</span><br><span class="line">        //解析qualifier子元素</span><br><span class="line">        parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">        bd.setResource(this.readerContext.getResource());</span><br><span class="line">        bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">        return bd;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        error(&quot;Bean class [&quot; + className + &quot;] not found&quot;, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoClassDefFoundError err) &#123;</span><br><span class="line">        error(&quot;Class that bean class [&quot; + className + &quot;] depends on not found&quot;, ele, err);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        error(&quot;Unexpected failure during bean definition parsing&quot;, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、BeanDefinitionParserDelegate的parseBeanDefinitionAttributes方法"><a href="#9、BeanDefinitionParserDelegate的parseBeanDefinitionAttributes方法" class="headerlink" title="9、BeanDefinitionParserDelegate的parseBeanDefinitionAttributes方法"></a>9、BeanDefinitionParserDelegate的parseBeanDefinitionAttributes方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">public AbstractBeanDefinition parseBeanDefinitionAttributes(Element ele, String beanName,</span><br><span class="line">        BeanDefinition containingBean, AbstractBeanDefinition bd) &#123;</span><br><span class="line">    //不支持singleton属性</span><br><span class="line">    if (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123;</span><br><span class="line">        error(&quot;Old 1.x &apos;singleton&apos; attribute in use - upgrade to &apos;scope&apos; declaration&quot;, ele);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析scope属性</span><br><span class="line">    else if (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE));</span><br><span class="line">    &#125;</span><br><span class="line">    //嵌套bean，使用外部类的scope</span><br><span class="line">    else if (containingBean != null) &#123;</span><br><span class="line">        // Take default from containing bean in case of an inner bean definition.</span><br><span class="line">        bd.setScope(containingBean.getScope());</span><br><span class="line">    &#125;</span><br><span class="line">    //解析abstract属性</span><br><span class="line">    if (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE)));</span><br><span class="line">    &#125;</span><br><span class="line">    //解析lazy-init属性</span><br><span class="line">    String lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE);</span><br><span class="line">    if (DEFAULT_VALUE.equals(lazyInit)) &#123;</span><br><span class="line">        lazyInit = this.defaults.getLazyInit();</span><br><span class="line">    &#125;</span><br><span class="line">    bd.setLazyInit(TRUE_VALUE.equals(lazyInit));</span><br><span class="line">    //解析autowire属性</span><br><span class="line">    String autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE);</span><br><span class="line">    bd.setAutowireMode(getAutowireMode(autowire));</span><br><span class="line">    //解析dependency-check属性</span><br><span class="line">    String dependencyCheck = ele.getAttribute(DEPENDENCY_CHECK_ATTRIBUTE);</span><br><span class="line">    bd.setDependencyCheck(getDependencyCheck(dependencyCheck));</span><br><span class="line">    //解析depends-on属性</span><br><span class="line">    if (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123;</span><br><span class="line">        String dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE);</span><br><span class="line">        bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, MULTI_VALUE_ATTRIBUTE_DELIMITERS));</span><br><span class="line">    &#125;</span><br><span class="line">    //解析autowire-candidate属性</span><br><span class="line">    String autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE);</span><br><span class="line">    if (&quot;&quot;.equals(autowireCandidate) || DEFAULT_VALUE.equals(autowireCandidate)) &#123;</span><br><span class="line">        String candidatePattern = this.defaults.getAutowireCandidates();</span><br><span class="line">        if (candidatePattern != null) &#123;</span><br><span class="line">            String[] patterns = StringUtils.commaDelimitedListToStringArray(candidatePattern);</span><br><span class="line">            bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate));</span><br><span class="line">    &#125;</span><br><span class="line">    //解析primary属性</span><br><span class="line">    if (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE)));</span><br><span class="line">    &#125;</span><br><span class="line">    //解析init-method属性</span><br><span class="line">    if (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        String initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE);</span><br><span class="line">        if (!&quot;&quot;.equals(initMethodName)) &#123;</span><br><span class="line">            bd.setInitMethodName(initMethodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if (this.defaults.getInitMethod() != null) &#123;</span><br><span class="line">            bd.setInitMethodName(this.defaults.getInitMethod());</span><br><span class="line">            bd.setEnforceInitMethod(false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //解析destroy-method属性</span><br><span class="line">    if (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        String destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE);</span><br><span class="line">        if (!&quot;&quot;.equals(destroyMethodName)) &#123;</span><br><span class="line">            bd.setDestroyMethodName(destroyMethodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if (this.defaults.getDestroyMethod() != null) &#123;</span><br><span class="line">            bd.setDestroyMethodName(this.defaults.getDestroyMethod());</span><br><span class="line">            bd.setEnforceDestroyMethod(false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //解析factory-method属性</span><br><span class="line">    if (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE));</span><br><span class="line">    &#125;</span><br><span class="line">    //解析factory-bean属性</span><br><span class="line">    if (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（二、8）BeanDefinitionParserDelegate的parseMetaElements方法"><a href="#10、接（二、8）BeanDefinitionParserDelegate的parseMetaElements方法" class="headerlink" title="10、接（二、8）BeanDefinitionParserDelegate的parseMetaElements方法"></a>10、接（二、8）BeanDefinitionParserDelegate的parseMetaElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void parseMetaElements(Element ele, BeanMetadataAttributeAccessor attributeAccessor) &#123;</span><br><span class="line">    NodeList nl = ele.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        //该元素为meta</span><br><span class="line">        if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">            Element metaElement = (Element) node;</span><br><span class="line">            String key = metaElement.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">            String value = metaElement.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">            BeanMetadataAttribute attribute = new BeanMetadataAttribute(key, value);</span><br><span class="line">            attribute.setSource(extractSource(metaElement));</span><br><span class="line">            //放入父类AttributeAccessorSupport的attributes中</span><br><span class="line">            attributeAccessor.addMetadataAttribute(attribute);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>元数据配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;demo&quot; class=&quot;com.demo.Demo&quot;&gt;</span><br><span class="line">    &lt;meta key=&quot;testStr&quot; value=&quot;123456&quot; /&gt; </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><h4 id="11、接（二、8）BeanDefinitionParserDelegate的parseLookupOverrideSubElements方法"><a href="#11、接（二、8）BeanDefinitionParserDelegate的parseLookupOverrideSubElements方法" class="headerlink" title="11、接（二、8）BeanDefinitionParserDelegate的parseLookupOverrideSubElements方法"></a>11、接（二、8）BeanDefinitionParserDelegate的parseLookupOverrideSubElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void parseLookupOverrideSubElements(Element beanEle, MethodOverrides overrides) &#123;</span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        //元素为lookup-method</span><br><span class="line">        if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, LOOKUP_METHOD_ELEMENT)) &#123;</span><br><span class="line">            Element ele = (Element) node;</span><br><span class="line">            String methodName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">            String beanRef = ele.getAttribute(BEAN_ELEMENT);</span><br><span class="line">            //创建一个LookupOverride加入AbstractBeanDefinition的methodOverrides中</span><br><span class="line">            LookupOverride override = new LookupOverride(methodName, beanRef);</span><br><span class="line">            override.setSource(extractSource(ele));</span><br><span class="line">            overrides.addOverride(override);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lookup-method配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">// 定义一个水果类</span><br><span class="line">public class Fruit &#123;</span><br><span class="line">    public Fruit() &#123;</span><br><span class="line">        System.out.println(&quot;I got Fruit&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 苹果</span><br><span class="line">public class Apple extends Fruit &#123;</span><br><span class="line">    public Apple() &#123;</span><br><span class="line">        System.out.println(&quot;I got a fresh apple&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 香蕉</span><br><span class="line">public class Bananer extends Fruit &#123;</span><br><span class="line">    public Bananer () &#123;</span><br><span class="line">        System.out.println(&quot;I got a  fresh bananer&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 水果盘，可以拿到水果</span><br><span class="line">public abstract class FruitPlate&#123;</span><br><span class="line">    // 抽象方法获取新鲜水果</span><br><span class="line">    protected abstract Fruit getFruit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;apple&quot; class=&quot;cn.com.willchen.test.di.Apple&quot; scope=&quot;prototype&quot;/&gt;</span><br><span class="line">&lt;bean id=&quot;bananer&quot; class=&quot;cn.com.willchen.test.di.Bananer &quot; scope=&quot;prototype&quot;/&gt;</span><br><span class="line">&lt;!-- getFruit方法返回apple --&gt;</span><br><span class="line">&lt;bean id=&quot;fruitPlate1&quot; class=&quot;cn.com.willchen.test.di.FruitPlate&quot;&gt;</span><br><span class="line">    &lt;lookup-method name=&quot;getFruit&quot; bean=&quot;apple&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">&lt;!-- getFruit方法返回bananer --&gt;</span><br><span class="line">&lt;bean id=&quot;fruitPlate2&quot; class=&quot;cn.com.willchen.test.di.FruitPlate&quot;&gt;</span><br><span class="line">    &lt;lookup-method name=&quot;getFruit&quot; bean=&quot;bananer&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><h4 id="12、接（二、8）BeanDefinitionParserDelegate的parseReplacedMethodSubElements方法"><a href="#12、接（二、8）BeanDefinitionParserDelegate的parseReplacedMethodSubElements方法" class="headerlink" title="12、接（二、8）BeanDefinitionParserDelegate的parseReplacedMethodSubElements方法"></a>12、接（二、8）BeanDefinitionParserDelegate的parseReplacedMethodSubElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void parseReplacedMethodSubElements(Element beanEle, MethodOverrides overrides) &#123;</span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        //元素为replaced-method</span><br><span class="line">        if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, REPLACED_METHOD_ELEMENT)) &#123;</span><br><span class="line">            Element replacedMethodEle = (Element) node;</span><br><span class="line">            //要替换的旧的方法</span><br><span class="line">            String name = replacedMethodEle.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">            //替代该方法的类</span><br><span class="line">            String callback = replacedMethodEle.getAttribute(REPLACER_ATTRIBUTE);</span><br><span class="line">            ReplaceOverride replaceOverride = new ReplaceOverride(name, callback);</span><br><span class="line">            // Look for arg-type match elements.</span><br><span class="line">            //记录参数</span><br><span class="line">            List&lt;Element&gt; argTypeEles = DomUtils.getChildElementsByTagName(replacedMethodEle, ARG_TYPE_ELEMENT);</span><br><span class="line">            for (Element argTypeEle : argTypeEles) &#123;</span><br><span class="line">                String match = argTypeEle.getAttribute(ARG_TYPE_MATCH_ATTRIBUTE);</span><br><span class="line">                match = (StringUtils.hasText(match) ? match : DomUtils.getTextValue(argTypeEle));</span><br><span class="line">                if (StringUtils.hasText(match)) &#123;</span><br><span class="line">                    replaceOverride.addTypeIdentifier(match);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            replaceOverride.setSource(extractSource(replacedMethodEle));</span><br><span class="line">            //添加到AbstractBeanDefinition的methodOverrides中</span><br><span class="line">            overrides.addOverride(replaceOverride);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>replaced-method配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class TestChangMethod&#123;</span><br><span class="line">    public void changMe()&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line">public class TestMethodReplacer implements MethodReplacer&#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Object reimplements(Object obj,Method method,Object[] args) throws Throwable&#123;</span><br><span class="line">        System.out.println(&quot;我替换了原有的方法&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;testChangeMethod&quot; class=&quot;com.demo3.TestChangeMethod&quot;&gt;&lt;</span><br><span class="line">    &lt;replaced-method name=&quot;changeMe&quot; replacer=&quot;replacer&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;replacer&quot; class=&quot;com.demo3.TestMethodReplacer&quot;&gt;&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><h4 id="13、接（二、8）BeanDefinitionParserDelegate的parseConstructorArgElements方法"><a href="#13、接（二、8）BeanDefinitionParserDelegate的parseConstructorArgElements方法" class="headerlink" title="13、接（二、8）BeanDefinitionParserDelegate的parseConstructorArgElements方法"></a>13、接（二、8）BeanDefinitionParserDelegate的parseConstructorArgElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void parseConstructorArgElements(Element beanEle, BeanDefinition bd) &#123;</span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, CONSTRUCTOR_ARG_ELEMENT)) &#123;</span><br><span class="line">            //解析constructor-arg</span><br><span class="line">            parseConstructorArgElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">public void parseConstructorArgElement(Element ele, BeanDefinition bd) &#123;</span><br><span class="line">    //index属性</span><br><span class="line">    String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE);</span><br><span class="line">    //type属性</span><br><span class="line">    String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE);</span><br><span class="line">    //name属性</span><br><span class="line">    String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    if (StringUtils.hasLength(indexAttr)) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            int index = Integer.parseInt(indexAttr);</span><br><span class="line">            if (index &lt; 0) &#123;</span><br><span class="line">                error(&quot;&apos;index&apos; cannot be lower than 0&quot;, ele);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    this.parseState.push(new ConstructorArgumentEntry(index));</span><br><span class="line">                    //解析属性元素</span><br><span class="line">                    Object value = parsePropertyValue(ele, bd, null);</span><br><span class="line">                    ConstructorArgumentValues.ValueHolder valueHolder = new ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">                    if (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">                        valueHolder.setType(typeAttr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">                        valueHolder.setName(nameAttr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    valueHolder.setSource(extractSource(ele));</span><br><span class="line">                    //不允许重复指定参数</span><br><span class="line">                    if (bd.getConstructorArgumentValues().hasIndexedArgumentValue(index)) &#123;</span><br><span class="line">                        error(&quot;Ambiguous constructor-arg entries for index &quot; + index, ele);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        //添加构造器属性值</span><br><span class="line">                        bd.getConstructorArgumentValues().addIndexedArgumentValue(index, valueHolder);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                finally &#123;</span><br><span class="line">                    this.parseState.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (NumberFormatException ex) &#123;</span><br><span class="line">            error(&quot;Attribute &apos;index&apos; of tag &apos;constructor-arg&apos; must be an integer&quot;, ele);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.parseState.push(new ConstructorArgumentEntry());</span><br><span class="line">            //解析属性元素</span><br><span class="line">            Object value = parsePropertyValue(ele, bd, null);</span><br><span class="line">            ConstructorArgumentValues.ValueHolder valueHolder = new ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">            if (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">                valueHolder.setType(typeAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            if (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">                valueHolder.setName(nameAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            valueHolder.setSource(extractSource(ele));</span><br><span class="line">            //添加构造器属性值</span><br><span class="line">            bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            this.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>constructor-arg配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;student&quot; class=&quot;com.rc.sp.Student&quot;&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;id&quot; value=&quot;1&quot;/&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;name&quot; value=&quot;student&quot;/&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;dream&quot;&gt;  </span><br><span class="line">        &lt;list&gt;  </span><br><span class="line">            &lt;value&gt;soldier&lt;/value&gt;  </span><br><span class="line">            &lt;value&gt;scientist&lt;/value&gt;  </span><br><span class="line">            &lt;value&gt;pilot&lt;/value&gt;  </span><br><span class="line">        &lt;/list&gt;  </span><br><span class="line">    &lt;/constructor-arg&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;score&quot;&gt;  </span><br><span class="line">        &lt;map&gt;  </span><br><span class="line">            &lt;entry key=&quot;math&quot; value=&quot;90&quot;/&gt;  </span><br><span class="line">            &lt;entry key=&quot;english&quot; value=&quot;85&quot;/&gt;  </span><br><span class="line">        &lt;/map&gt;  </span><br><span class="line">    &lt;/constructor-arg&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;graduation&quot; value=&quot;false&quot;/&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><h4 id="14、BeanDefinitionParserDelegate的parsePropertyValue方法"><a href="#14、BeanDefinitionParserDelegate的parsePropertyValue方法" class="headerlink" title="14、BeanDefinitionParserDelegate的parsePropertyValue方法"></a>14、BeanDefinitionParserDelegate的parsePropertyValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">public Object parsePropertyValue(Element ele, BeanDefinition bd, String propertyName) &#123;</span><br><span class="line">    String elementName = (propertyName != null) ?</span><br><span class="line">                    &quot;&lt;property&gt; element for property &apos;&quot; + propertyName + &quot;&apos;&quot; :</span><br><span class="line">                    &quot;&lt;constructor-arg&gt; element&quot;;</span><br><span class="line"></span><br><span class="line">    // Should only have one child element: ref, value, list, etc.</span><br><span class="line">    NodeList nl = ele.getChildNodes();</span><br><span class="line">    Element subElement = null;</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        //description和meta不处理</span><br><span class="line">        if (node instanceof Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp;</span><br><span class="line">                !nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">            // Child element is what we&apos;re looking for.</span><br><span class="line">            if (subElement != null) &#123;</span><br><span class="line">                error(elementName + &quot; must not contain more than one sub-element&quot;, ele);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                //子元素</span><br><span class="line">                subElement = (Element) node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //解析constructor-arg的ref属性</span><br><span class="line">    boolean hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</span><br><span class="line">    //解析constructor-arg的value属性</span><br><span class="line">    boolean hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">    //不能同时有ref和value</span><br><span class="line">    if ((hasRefAttribute &amp;&amp; hasValueAttribute) ||</span><br><span class="line">            ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != null)) &#123;</span><br><span class="line">        error(elementName +</span><br><span class="line">                &quot; is only allowed to contain either &apos;ref&apos; attribute OR &apos;value&apos; attribute OR sub-element&quot;, ele);</span><br><span class="line">    &#125;</span><br><span class="line">    //ref属性</span><br><span class="line">    if (hasRefAttribute) &#123;</span><br><span class="line">        String refName = ele.getAttribute(REF_ATTRIBUTE);</span><br><span class="line">        if (!StringUtils.hasText(refName)) &#123;</span><br><span class="line">            error(elementName + &quot; contains empty &apos;ref&apos; attribute&quot;, ele);</span><br><span class="line">        &#125;</span><br><span class="line">        RuntimeBeanReference ref = new RuntimeBeanReference(refName);</span><br><span class="line">        ref.setSource(extractSource(ele));</span><br><span class="line">        return ref;</span><br><span class="line">    &#125;</span><br><span class="line">    //value属性</span><br><span class="line">    else if (hasValueAttribute) &#123;</span><br><span class="line">        TypedStringValue valueHolder = new TypedStringValue(ele.getAttribute(VALUE_ATTRIBUTE));</span><br><span class="line">        valueHolder.setSource(extractSource(ele));</span><br><span class="line">        return valueHolder;</span><br><span class="line">    &#125;</span><br><span class="line">    //解析子元素</span><br><span class="line">    else if (subElement != null) &#123;</span><br><span class="line">        return parsePropertySubElement(subElement, bd);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Neither child element nor &quot;ref&quot; or &quot;value&quot; attribute found.</span><br><span class="line">        error(elementName + &quot; must specify a ref or value&quot;, ele);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法"><a href="#15、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法" class="headerlink" title="15、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法"></a>15、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void parsePropertyElements(Element beanEle, BeanDefinition bd) &#123;</span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123;</span><br><span class="line">            parsePropertyElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void parsePropertyElement(Element ele, BeanDefinition bd) &#123;</span><br><span class="line">    //获取name属性</span><br><span class="line">    String propertyName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    if (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">        error(&quot;Tag &apos;property&apos; must have a &apos;name&apos; attribute&quot;, ele);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    this.parseState.push(new PropertyEntry(propertyName));</span><br><span class="line">    try &#123;</span><br><span class="line">        if (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">            error(&quot;Multiple &apos;property&apos; definitions for property &apos;&quot; + propertyName + &quot;&apos;&quot;, ele);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //解析属性元素，与(一、14)相同</span><br><span class="line">        Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">        PropertyValue pv = new PropertyValue(propertyName, val);</span><br><span class="line">        parseMetaElements(ele, pv);</span><br><span class="line">        pv.setSource(extractSource(ele));</span><br><span class="line">        bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>property配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;user&quot; class=&quot;cn.itcast.c_property.User&quot; scope=&quot;prototype&quot;&gt;  </span><br><span class="line">    &lt;property name=&quot;id&quot; value=&quot;101&quot;&gt;&lt;/property&gt;  </span><br><span class="line">    &lt;property name=&quot;name&quot; value=&quot;Jack&quot;&gt;&lt;/property&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><h4 id="16、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法"><a href="#16、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法" class="headerlink" title="16、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法"></a>16、接（二、8）BeanDefinitionParserDelegate的parsePropertyElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void parseQualifierElements(Element beanEle, AbstractBeanDefinition bd) &#123;</span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, QUALIFIER_ELEMENT)) &#123;</span><br><span class="line">            parseQualifierElement((Element) node, bd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public void parseQualifierElement(Element ele, AbstractBeanDefinition bd) &#123;</span><br><span class="line">    //type属性</span><br><span class="line">    String typeName = ele.getAttribute(TYPE_ATTRIBUTE);</span><br><span class="line">    if (!StringUtils.hasLength(typeName)) &#123;</span><br><span class="line">        error(&quot;Tag &apos;qualifier&apos; must have a &apos;type&apos; attribute&quot;, ele);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    this.parseState.push(new QualifierEntry(typeName));</span><br><span class="line">    try &#123;</span><br><span class="line">        AutowireCandidateQualifier qualifier = new AutowireCandidateQualifier(typeName);</span><br><span class="line">        qualifier.setSource(extractSource(ele));</span><br><span class="line">        String value = ele.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">        if (StringUtils.hasLength(value)) &#123;</span><br><span class="line">            qualifier.setAttribute(AutowireCandidateQualifier.VALUE_KEY, value);</span><br><span class="line">        &#125;</span><br><span class="line">        NodeList nl = ele.getChildNodes();</span><br><span class="line">        for (int i = 0; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">            Node node = nl.item(i);</span><br><span class="line">            if (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, QUALIFIER_ATTRIBUTE_ELEMENT)) &#123;</span><br><span class="line">                Element attributeEle = (Element) node;</span><br><span class="line">                String attributeName = attributeEle.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">                String attributeValue = attributeEle.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">                if (StringUtils.hasLength(attributeName) &amp;&amp; StringUtils.hasLength(attributeValue)) &#123;</span><br><span class="line">                    BeanMetadataAttribute attribute = new BeanMetadataAttribute(attributeName, attributeValue);</span><br><span class="line">                    attribute.setSource(extractSource(attributeEle));</span><br><span class="line">                    qualifier.addMetadataAttribute(attribute);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    error(&quot;Qualifier &apos;attribute&apos; tag must have a &apos;name&apos; and &apos;value&apos;&quot;, attributeEle);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //添加限定标识符</span><br><span class="line">        bd.addQualifier(qualifier);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>qualifier配置示例，限定标识符<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class TestBean &#123;  </span><br><span class="line">      </span><br><span class="line">    private DataSource dataSource;  </span><br><span class="line">      </span><br><span class="line">    @Autowired  </span><br><span class="line">    public void initDataSource(@Qualifier(&quot;oracleDataSource&quot;) DataSource dataSource)&#123;  </span><br><span class="line">        this.dataSource = dataSource;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    public DataSource getDataSource() &#123;  </span><br><span class="line">        return dataSource;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;mysqlDataSourceBean&quot; class=&quot;com.bean.MysqlDriveManagerDataSource&quot;&gt;  </span><br><span class="line">    &lt;qualifier value=&quot;mysqlDataSource&quot;/&gt;  </span><br><span class="line">&lt;/bean&gt;  </span><br><span class="line">  </span><br><span class="line">&lt;bean id=&quot;oracleDataSourceBean&quot; class=&quot;com.bean.OracleDriveManagerDataSource&quot;&gt;  </span><br><span class="line">    &lt;qualifier value=&quot;oracleDataSource&quot;/&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><h4 id="16、接（二、6）BeanDefinitionReaderUtils的registerBeanDefinition方法"><a href="#16、接（二、6）BeanDefinitionReaderUtils的registerBeanDefinition方法" class="headerlink" title="16、接（二、6）BeanDefinitionReaderUtils的registerBeanDefinition方法"></a>16、接（二、6）BeanDefinitionReaderUtils的registerBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static void registerBeanDefinition(</span><br><span class="line">        BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span><br><span class="line">        throws BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">    // Register bean definition under primary name.</span><br><span class="line">    String beanName = definitionHolder.getBeanName();</span><br><span class="line">    //使用beanName注册</span><br><span class="line">    registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</span><br><span class="line">    //注册别名</span><br><span class="line">    // Register aliases for bean name, if any.</span><br><span class="line">    String[] aliases = definitionHolder.getAliases();</span><br><span class="line">    if (aliases != null) &#123;</span><br><span class="line">        for (String alias : aliases) &#123;</span><br><span class="line">            registry.registerAlias(beanName, alias);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、DefaultListableBeanFactory的registerBeanDefinition方法"><a href="#17、DefaultListableBeanFactory的registerBeanDefinition方法" class="headerlink" title="17、DefaultListableBeanFactory的registerBeanDefinition方法"></a>17、DefaultListableBeanFactory的registerBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</span><br><span class="line">        throws BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">    Assert.hasText(beanName, &quot;Bean name must not be empty&quot;);</span><br><span class="line">    Assert.notNull(beanDefinition, &quot;BeanDefinition must not be null&quot;);</span><br><span class="line">    //校验methodOverrides不能与工厂方法并存，或者methodOverrides对应的方法不存在</span><br><span class="line">    if (beanDefinition instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                    &quot;Validation of bean definition failed&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BeanDefinition oldBeanDefinition;</span><br><span class="line"></span><br><span class="line">    oldBeanDefinition = this.beanDefinitionMap.get(beanName);</span><br><span class="line">    if (oldBeanDefinition != null) &#123;</span><br><span class="line">        //已存在且不允许被覆盖，抛出异常</span><br><span class="line">        if (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                    &quot;Cannot register bean definition [&quot; + beanDefinition + &quot;] for bean &apos;&quot; + beanName +</span><br><span class="line">                    &quot;&apos;: There is already [&quot; + oldBeanDefinition + &quot;] bound.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">            // e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span><br><span class="line">            if (this.logger.isWarnEnabled()) &#123;</span><br><span class="line">                this.logger.warn(&quot;Overriding user-defined bean definition for bean &apos;&quot; + beanName +</span><br><span class="line">                        &quot;&apos; with a framework-generated bean definition: replacing [&quot; +</span><br><span class="line">                        oldBeanDefinition + &quot;] with [&quot; + beanDefinition + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (this.logger.isInfoEnabled()) &#123;</span><br><span class="line">                this.logger.info(&quot;Overriding bean definition for bean &apos;&quot; + beanName +</span><br><span class="line">                        &quot;&apos;: replacing [&quot; + oldBeanDefinition + &quot;] with [&quot; + beanDefinition + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //记录beanName</span><br><span class="line">        this.beanDefinitionNames.add(beanName);</span><br><span class="line">        this.manualSingletonNames.remove(beanName);</span><br><span class="line">        this.frozenBeanDefinitionNames = null;</span><br><span class="line">    &#125;</span><br><span class="line">    //注册beanDefinition</span><br><span class="line">    this.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line"></span><br><span class="line">    if (oldBeanDefinition != null || containsSingleton(beanName)) &#123;</span><br><span class="line">        //重置缓存</span><br><span class="line">        resetBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（二、16）SimpleAliasRegistry的registerAlias方法"><a href="#18、接（二、16）SimpleAliasRegistry的registerAlias方法" class="headerlink" title="18、接（二、16）SimpleAliasRegistry的registerAlias方法"></a>18、接（二、16）SimpleAliasRegistry的registerAlias方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerAlias(String name, String alias) &#123;</span><br><span class="line">    Assert.hasText(name, &quot;&apos;name&apos; must not be empty&quot;);</span><br><span class="line">    Assert.hasText(alias, &quot;&apos;alias&apos; must not be empty&quot;);</span><br><span class="line">    //别名与beanName相同，则删除该别名</span><br><span class="line">    if (alias.equals(name)) &#123;</span><br><span class="line">        this.aliasMap.remove(alias);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //检验别名是否重复</span><br><span class="line">        if (!allowAliasOverriding()) &#123;</span><br><span class="line">            String registeredName = this.aliasMap.get(alias);</span><br><span class="line">            if (registeredName != null &amp;&amp; !registeredName.equals(name)) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;Cannot register alias &apos;&quot; + alias + &quot;&apos; for name &apos;&quot; +</span><br><span class="line">                        name + &quot;&apos;: It is already registered for name &apos;&quot; + registeredName + &quot;&apos;.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //A-B存在的情况下，不能存在B-A以及B-C-A</span><br><span class="line">        checkForAliasCircle(name, alias);</span><br><span class="line">        //注册别名</span><br><span class="line">        this.aliasMap.put(alias, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、接（二、5）DefaultBeanDefinitionDocumentReader的processAliasRegistration方法"><a href="#19、接（二、5）DefaultBeanDefinitionDocumentReader的processAliasRegistration方法" class="headerlink" title="19、接（二、5）DefaultBeanDefinitionDocumentReader的processAliasRegistration方法"></a>19、接（二、5）DefaultBeanDefinitionDocumentReader的processAliasRegistration方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">protected void processAliasRegistration(Element ele) &#123;</span><br><span class="line">    String name = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    String alias = ele.getAttribute(ALIAS_ATTRIBUTE);</span><br><span class="line">    boolean valid = true;</span><br><span class="line">    if (!StringUtils.hasText(name)) &#123;</span><br><span class="line">        getReaderContext().error(&quot;Name must not be empty&quot;, ele);</span><br><span class="line">        valid = false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!StringUtils.hasText(alias)) &#123;</span><br><span class="line">        getReaderContext().error(&quot;Alias must not be empty&quot;, ele);</span><br><span class="line">        valid = false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (valid) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //注册别名</span><br><span class="line">            getReaderContext().getRegistry().registerAlias(name, alias);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex) &#123;</span><br><span class="line">            getReaderContext().error(&quot;Failed to register alias &apos;&quot; + alias +</span><br><span class="line">                    &quot;&apos; for bean with name &apos;&quot; + name + &quot;&apos;&quot;, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        //通知监听器，别名注册完成事件</span><br><span class="line">        getReaderContext().fireAliasRegistered(name, alias, extractSource(ele));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>alias标签配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;some&quot; class=&quot;src.com.Some&quot;/&gt;</span><br><span class="line">&lt;alias name=&quot;some&quot; alias=&quot;someJava,oneBean,twoBean&quot;/&gt;</span><br></pre></td></tr></table></figure></p><h4 id="20、接（二、5）DefaultBeanDefinitionDocumentReader的importBeanDefinitionResource方法"><a href="#20、接（二、5）DefaultBeanDefinitionDocumentReader的importBeanDefinitionResource方法" class="headerlink" title="20、接（二、5）DefaultBeanDefinitionDocumentReader的importBeanDefinitionResource方法"></a>20、接（二、5）DefaultBeanDefinitionDocumentReader的importBeanDefinitionResource方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">protected void importBeanDefinitionResource(Element ele) &#123;</span><br><span class="line">    //获取resource属性</span><br><span class="line">    String location = ele.getAttribute(RESOURCE_ATTRIBUTE);</span><br><span class="line">    if (!StringUtils.hasText(location)) &#123;</span><br><span class="line">        getReaderContext().error(&quot;Resource location must not be empty&quot;, ele);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Resolve system properties: e.g. &quot;$&#123;user.dir&#125;&quot;</span><br><span class="line">    //解析系统属性，如&quot;$&#123;user.dir&#125;&quot;</span><br><span class="line">    location = getReaderContext().getEnvironment().resolveRequiredPlaceholders(location);</span><br><span class="line"></span><br><span class="line">    Set&lt;Resource&gt; actualResources = new LinkedHashSet&lt;Resource&gt;(4);</span><br><span class="line"></span><br><span class="line">    // Discover whether the location is an absolute or relative URI</span><br><span class="line">    boolean absoluteLocation = false;</span><br><span class="line">    try &#123;</span><br><span class="line">        //判断location，是绝对uri还是相对uri</span><br><span class="line">        absoluteLocation = ResourcePatternUtils.isUrl(location) || ResourceUtils.toURI(location).isAbsolute();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (URISyntaxException ex) &#123;</span><br><span class="line">        // cannot convert to an URI, considering the location relative</span><br><span class="line">        // unless it is the well-known Spring prefix &quot;classpath*:&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Absolute or relative?</span><br><span class="line">    //绝对uri直接加载配置文件</span><br><span class="line">    if (absoluteLocation) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            int importCount = getReaderContext().getReader().loadBeanDefinitions(location, actualResources);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Imported &quot; + importCount + &quot; bean definitions from URL location [&quot; + location + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(</span><br><span class="line">                    &quot;Failed to import bean definitions from URL location [&quot; + location + &quot;]&quot;, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //相对地址加载</span><br><span class="line">    else &#123;</span><br><span class="line">        // No URL -&gt; considering resource location as relative to the current file.</span><br><span class="line">        try &#123;</span><br><span class="line">            int importCount;</span><br><span class="line">            Resource relativeResource = getReaderContext().getResource().createRelative(location);</span><br><span class="line">            if (relativeResource.exists()) &#123;</span><br><span class="line">                importCount = getReaderContext().getReader().loadBeanDefinitions(relativeResource);</span><br><span class="line">                actualResources.add(relativeResource);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                String baseLocation = getReaderContext().getResource().getURL().toString();</span><br><span class="line">                importCount = getReaderContext().getReader().loadBeanDefinitions(</span><br><span class="line">                        StringUtils.applyRelativePath(baseLocation, location), actualResources);</span><br><span class="line">            &#125;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Imported &quot; + importCount + &quot; bean definitions from relative location [&quot; + location + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IOException ex) &#123;</span><br><span class="line">            getReaderContext().error(&quot;Failed to resolve current resource location&quot;, ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            getReaderContext().error(&quot;Failed to import bean definitions from relative location [&quot; + location + &quot;]&quot;,</span><br><span class="line">                    ele, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //监听器处理加载的文件</span><br><span class="line">    Resource[] actResArray = actualResources.toArray(new Resource[actualResources.size()]);</span><br><span class="line">    getReaderContext().fireImportProcessed(location, actResArray, extractSource(ele));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>import标签配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;import resource=&quot;systemContext.xml&quot; /&gt;</span><br></pre></td></tr></table></figure></p><h3 id="三、自定义标签解析"><a href="#三、自定义标签解析" class="headerlink" title="三、自定义标签解析"></a>三、自定义标签解析</h3><h4 id="1、自定义标签示例"><a href="#1、自定义标签示例" class="headerlink" title="1、自定义标签示例"></a>1、自定义标签示例</h4><p>一个普通的javaBean<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class User &#123;    </span><br><span class="line">    private String id;    </span><br><span class="line">    private String userName;    </span><br><span class="line">    private String email;    </span><br><span class="line">    public String getId() &#123;    </span><br><span class="line">        return id;    </span><br><span class="line">    &#125;    </span><br><span class="line">    public void setId(String id) &#123;    </span><br><span class="line">        this.id = id;    </span><br><span class="line">    &#125;    </span><br><span class="line">    public String getUserName() &#123;    </span><br><span class="line">        return userName;    </span><br><span class="line">    &#125;    </span><br><span class="line">    public void setUserName(String userName) &#123;    </span><br><span class="line">        this.userName = userName;    </span><br><span class="line">    &#125;    </span><br><span class="line">    public String getEmail() &#123;    </span><br><span class="line">        return email;    </span><br><span class="line">    &#125;    </span><br><span class="line">    public void setEmail(String email) &#123;    </span><br><span class="line">        this.email = email;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>解析器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class UserBeanDefinitionParser extends AbstractSingleBeanDefinitionParser &#123;    </span><br><span class="line">    @Override    </span><br><span class="line">    protected Class&lt;?&gt; getBeanClass(Element element) &#123;    </span><br><span class="line">        return User.class;    </span><br><span class="line">    &#125;    </span><br><span class="line">    @Override    </span><br><span class="line">    protected void doParse(Element element, BeanDefinitionBuilder builder) &#123;    </span><br><span class="line">        String userName=element.getAttribute(&quot;userName&quot;);    </span><br><span class="line">        String email=element.getAttribute(&quot;email&quot;);    </span><br><span class="line">        if(StringUtils.hasText(userName))&#123;    </span><br><span class="line">            builder.addPropertyValue(&quot;userName&quot;, userName);    </span><br><span class="line">        &#125;    </span><br><span class="line">        if(StringUtils.hasText(email))&#123;    </span><br><span class="line">            builder.addPropertyValue(&quot;email&quot;, email);    </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注册解析器的Handler<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class MyUserNamespaceHandler extends NamespaceHandlerSupport &#123;    </span><br><span class="line">    </span><br><span class="line">    @Override    </span><br><span class="line">    public void init() &#123;    </span><br><span class="line">        registerBeanDefinitionParser(&quot;user&quot;,new UserBeanDefinitionParser());    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>xml  schema definition  (xsd)文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;    </span><br><span class="line">&lt;xsd:schema xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;    </span><br><span class="line">    xmlns=&quot;http://www.wjs.com/schema/user&quot; targetNamespace=&quot;http://www.wjs.com/schema/user&quot;    </span><br><span class="line">    elementFormDefault=&quot;qualified&quot;&gt;    </span><br><span class="line">    &lt;xsd:element name=&quot;user&quot;&gt;    </span><br><span class="line">        &lt;xsd:complexType&gt;    </span><br><span class="line">            &lt;xsd:attribute name=&quot;id&quot; type=&quot;xsd:string&quot; /&gt;    </span><br><span class="line">            &lt;xsd:attribute name=&quot;userName&quot; type=&quot;xsd:string&quot; /&gt;    </span><br><span class="line">            &lt;xsd:attribute name=&quot;email&quot; type=&quot;xsd:string&quot; /&gt;    </span><br><span class="line">        &lt;/xsd:complexType&gt;    </span><br><span class="line">    &lt;/xsd:element&gt;    </span><br><span class="line">&lt;/xsd:schema&gt;</span><br></pre></td></tr></table></figure></p><p>spring.handlers中添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://www.wjs.com/schema/user=com.wjs.cosumertag.MyUserNamespaceHandler</span><br></pre></td></tr></table></figure></p><p>spring.schemas中添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://www.wjs.com/schema/user.xsd=META-INF/spring-user.xsd</span><br></pre></td></tr></table></figure></p><p>spring 配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;    </span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;    </span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;    </span><br><span class="line">    xmlns:context=&quot;http://www.springframework.org/schema/context&quot;    </span><br><span class="line">    xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;    </span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; </span><br><span class="line">    &lt;!-- 自定义标签的命名空间 --&gt;   </span><br><span class="line">    xmlns:myTag=&quot;http://www.wjs.com/schema/user&quot;   </span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd    </span><br><span class="line">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd    </span><br><span class="line">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd    </span><br><span class="line">        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd    </span><br><span class="line">        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd </span><br><span class="line">        &lt;!--指定了命名空间对应的Schema文档--&gt;   </span><br><span class="line">        http://www.wjs.com/schema/user http://www.wjs.com/schema/user.xsd&quot;&gt;    </span><br><span class="line">     </span><br><span class="line">    &lt;myTag:user id=&quot;testBean&quot; userName=&quot;name&quot; email=&quot;wjs@163.com&quot;/&gt;    </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><h4 id="2、接（二、4）BeanDefinitionParserDelegate的parseCustomElement方法"><a href="#2、接（二、4）BeanDefinitionParserDelegate的parseCustomElement方法" class="headerlink" title="2、接（二、4）BeanDefinitionParserDelegate的parseCustomElement方法"></a>2、接（二、4）BeanDefinitionParserDelegate的parseCustomElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public BeanDefinition parseCustomElement(Element ele) &#123;</span><br><span class="line">    return parseCustomElement(ele, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd) &#123;</span><br><span class="line">    //获取命名空间</span><br><span class="line">    String namespaceUri = getNamespaceURI(ele);</span><br><span class="line">    //根据命名空间获取对应处理器</span><br><span class="line">    NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</span><br><span class="line">    if (handler == null) &#123;</span><br><span class="line">        error(&quot;Unable to locate Spring NamespaceHandler for XML schema namespace [&quot; + namespaceUri + &quot;]&quot;, ele);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //用自定义的处理器解析</span><br><span class="line">    return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、DefaultNamespaceHandlerResolver的resolve方法"><a href="#3、DefaultNamespaceHandlerResolver的resolve方法" class="headerlink" title="3、DefaultNamespaceHandlerResolver的resolve方法"></a>3、DefaultNamespaceHandlerResolver的resolve方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public NamespaceHandler resolve(String namespaceUri) &#123;</span><br><span class="line">    //获取handler映射</span><br><span class="line">    Map&lt;String, Object&gt; handlerMappings = getHandlerMappings();</span><br><span class="line">    //根据命名空间找到对应的信息</span><br><span class="line">    Object handlerOrClassName = handlerMappings.get(namespaceUri);</span><br><span class="line">    if (handlerOrClassName == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (handlerOrClassName instanceof NamespaceHandler) &#123;</span><br><span class="line">        return (NamespaceHandler) handlerOrClassName;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        String className = (String) handlerOrClassName;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class&lt;?&gt; handlerClass = ClassUtils.forName(className, this.classLoader);</span><br><span class="line">            if (!NamespaceHandler.class.isAssignableFrom(handlerClass)) &#123;</span><br><span class="line">                throw new FatalBeanException(&quot;Class [&quot; + className + &quot;] for namespace [&quot; + namespaceUri +</span><br><span class="line">                        &quot;] does not implement the [&quot; + NamespaceHandler.class.getName() + &quot;] interface&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //初始化类</span><br><span class="line">            NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass);</span><br><span class="line">            //初始化方法，注册解析器</span><br><span class="line">            namespaceHandler.init();</span><br><span class="line">            //记录缓存</span><br><span class="line">            handlerMappings.put(namespaceUri, namespaceHandler);</span><br><span class="line">            return namespaceHandler;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ClassNotFoundException ex) &#123;</span><br><span class="line">            throw new FatalBeanException(&quot;NamespaceHandler class [&quot; + className + &quot;] for namespace [&quot; +</span><br><span class="line">                    namespaceUri + &quot;] not found&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (LinkageError err) &#123;</span><br><span class="line">            throw new FatalBeanException(&quot;Invalid NamespaceHandler class [&quot; + className + &quot;] for namespace [&quot; +</span><br><span class="line">                    namespaceUri + &quot;]: problem with handler class file or dependent class&quot;, err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DefaultNamespaceHandlerResolver的getHandlerMappings方法"><a href="#4、DefaultNamespaceHandlerResolver的getHandlerMappings方法" class="headerlink" title="4、DefaultNamespaceHandlerResolver的getHandlerMappings方法"></a>4、DefaultNamespaceHandlerResolver的getHandlerMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">private Map&lt;String, Object&gt; getHandlerMappings() &#123;</span><br><span class="line">    if (this.handlerMappings == null) &#123;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            if (this.handlerMappings == null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //从&quot;META-INF/spring.handlers&quot;中加载命名空间和Handler的映射</span><br><span class="line">                    Properties mappings =Handler的映射</span><br><span class="line">                            PropertiesLoaderUtils.loadAllProperties(this.handlerMappingsLocation, this.classLoader);</span><br><span class="line">                    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                        logger.debug(&quot;Loaded NamespaceHandler mappings: &quot; + mappings);</span><br><span class="line">                    &#125;</span><br><span class="line">                    Map&lt;String, Object&gt; handlerMappings = new ConcurrentHashMap&lt;String, Object&gt;(mappings.size());</span><br><span class="line">                    CollectionUtils.mergePropertiesIntoMap(mappings, handlerMappings);</span><br><span class="line">                    this.handlerMappings = handlerMappings;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (IOException ex) &#123;</span><br><span class="line">                    throw new IllegalStateException(</span><br><span class="line">                            &quot;Unable to load NamespaceHandler mappings from location [&quot; + this.handlerMappingsLocation + &quot;]&quot;, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return this.handlerMappings;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、NamespaceHandlerSupport的parse方法"><a href="#5、NamespaceHandlerSupport的parse方法" class="headerlink" title="5、NamespaceHandlerSupport的parse方法"></a>5、NamespaceHandlerSupport的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //获取解析器，并解析</span><br><span class="line">    return findParserForElement(element, parserContext).parse(element, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、NamespaceHandlerSupport的findParserForElement方法"><a href="#6、NamespaceHandlerSupport的findParserForElement方法" class="headerlink" title="6、NamespaceHandlerSupport的findParserForElement方法"></a>6、NamespaceHandlerSupport的findParserForElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private BeanDefinitionParser findParserForElement(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //元素名 myTag:user 中为 user</span><br><span class="line">    String localName = parserContext.getDelegate().getLocalName(element);</span><br><span class="line">    //获取user的解析器</span><br><span class="line">    BeanDefinitionParser parser = this.parsers.get(localName);</span><br><span class="line">    if (parser == null) &#123;</span><br><span class="line">        parserContext.getReaderContext().fatal(</span><br><span class="line">                &quot;Cannot locate BeanDefinitionParser for element [&quot; + localName + &quot;]&quot;, element);</span><br><span class="line">    &#125;</span><br><span class="line">    return parser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（三、2）AbstractBeanDefinitionParser的parse方法"><a href="#7、接（三、2）AbstractBeanDefinitionParser的parse方法" class="headerlink" title="7、接（三、2）AbstractBeanDefinitionParser的parse方法"></a>7、接（三、2）AbstractBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">p@Override</span><br><span class="line">public final BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //解析bean</span><br><span class="line">    AbstractBeanDefinition definition = parseInternal(element, parserContext);</span><br><span class="line">    if (definition != null &amp;&amp; !parserContext.isNested()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            String id = resolveId(element, definition, parserContext);</span><br><span class="line">            if (!StringUtils.hasText(id)) &#123;</span><br><span class="line">                parserContext.getReaderContext().error(</span><br><span class="line">                        &quot;Id is required for element &apos;&quot; + parserContext.getDelegate().getLocalName(element)</span><br><span class="line">                                + &quot;&apos; when used as a top-level tag&quot;, element);</span><br><span class="line">            &#125;</span><br><span class="line">            String[] aliases = null;</span><br><span class="line">            if (shouldParseNameAsAliases()) &#123;</span><br><span class="line">                String name = element.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">                if (StringUtils.hasLength(name)) &#123;</span><br><span class="line">                    aliases = StringUtils.trimArrayElements(StringUtils.commaDelimitedListToStringArray(name));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            BeanDefinitionHolder holder = new BeanDefinitionHolder(definition, id, aliases);</span><br><span class="line">            registerBeanDefinition(holder, parserContext.getRegistry());</span><br><span class="line">            if (shouldFireEvents()) &#123;</span><br><span class="line">                BeanComponentDefinition componentDefinition = new BeanComponentDefinition(holder);</span><br><span class="line">                postProcessComponentDefinition(componentDefinition);</span><br><span class="line">                parserContext.registerComponent(componentDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            parserContext.getReaderContext().error(ex.getMessage(), element);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（三、2）AbstractBeanDefinitionParser的parse方法"><a href="#8、接（三、2）AbstractBeanDefinitionParser的parse方法" class="headerlink" title="8、接（三、2）AbstractBeanDefinitionParser的parse方法"></a>8、接（三、2）AbstractBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">p@Override</span><br><span class="line">public final BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //解析bean</span><br><span class="line">    AbstractBeanDefinition definition = parseInternal(element, parserContext);</span><br><span class="line">    if (definition != null &amp;&amp; !parserContext.isNested()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取beanName</span><br><span class="line">            String id = resolveId(element, definition, parserContext);</span><br><span class="line">            if (!StringUtils.hasText(id)) &#123;</span><br><span class="line">                parserContext.getReaderContext().error(</span><br><span class="line">                        &quot;Id is required for element &apos;&quot; + parserContext.getDelegate().getLocalName(element)</span><br><span class="line">                                + &quot;&apos; when used as a top-level tag&quot;, element);</span><br><span class="line">            &#125;</span><br><span class="line">            String[] aliases = null;</span><br><span class="line">            if (shouldParseNameAsAliases()) &#123;</span><br><span class="line">                String name = element.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">                if (StringUtils.hasLength(name)) &#123;</span><br><span class="line">                    aliases = StringUtils.trimArrayElements(StringUtils.commaDelimitedListToStringArray(name));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //注册BeanDefinition</span><br><span class="line">            BeanDefinitionHolder holder = new BeanDefinitionHolder(definition, id, aliases);</span><br><span class="line">            registerBeanDefinition(holder, parserContext.getRegistry());</span><br><span class="line">            if (shouldFireEvents()) &#123;</span><br><span class="line">                BeanComponentDefinition componentDefinition = new BeanComponentDefinition(holder);</span><br><span class="line">                //钩子函数，在解析完自定义bean之后执行</span><br><span class="line">                postProcessComponentDefinition(componentDefinition);</span><br><span class="line">                //通知监听器，自定义bean注册完成事件</span><br><span class="line">                parserContext.registerComponent(componentDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            parserContext.getReaderContext().error(ex.getMessage(), element);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、AbstractSingleBeanDefinitionParser的parseInternal方法"><a href="#9、AbstractSingleBeanDefinitionParser的parseInternal方法" class="headerlink" title="9、AbstractSingleBeanDefinitionParser的parseInternal方法"></a>9、AbstractSingleBeanDefinitionParser的parseInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final AbstractBeanDefinition parseInternal(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line">    String parentName = getParentName(element);</span><br><span class="line">    if (parentName != null) &#123;</span><br><span class="line">        builder.getRawBeanDefinition().setParentName(parentName);</span><br><span class="line">    &#125;</span><br><span class="line">    //该方法被自定义解析器重写</span><br><span class="line">    Class&lt;?&gt; beanClass = getBeanClass(element);</span><br><span class="line">    if (beanClass != null) &#123;</span><br><span class="line">        builder.getRawBeanDefinition().setBeanClass(beanClass);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //若没有beanClass，检查自定义解析器是否重写getBeanClassName</span><br><span class="line">        String beanClassName = getBeanClassName(element);</span><br><span class="line">        if (beanClassName != null) &#123;</span><br><span class="line">            builder.getRawBeanDefinition().setBeanClassName(beanClassName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</span><br><span class="line">    if (parserContext.isNested()) &#123;</span><br><span class="line">        // Inner bean definition must receive same scope as containing bean.</span><br><span class="line">        //若存在外部类，使用外部类的scope</span><br><span class="line">        builder.setScope(parserContext.getContainingBeanDefinition().getScope());</span><br><span class="line">    &#125;</span><br><span class="line">    if (parserContext.isDefaultLazyInit()) &#123;</span><br><span class="line">        // Default-lazy-init applies to custom bean definitions as well.</span><br><span class="line">        //配置延迟加载</span><br><span class="line">        builder.setLazyInit(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //子类重写了该方法</span><br><span class="line">    doParse(element, parserContext, builder);</span><br><span class="line">    return builder.getBeanDefinition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码Transaction</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81Transaction/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码Transaction/</id>
    <published>2018-06-27T13:10:29.029Z</published>
    <updated>2018-06-28T14:08:50.829Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>spring配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 配置事务管理器 --&gt;  </span><br><span class="line">&lt;bean id=&quot;txManager&quot;  </span><br><span class="line">        class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;  </span><br><span class="line">        p:dataSource-ref=&quot;dataSource&quot;&gt;  </span><br><span class="line">&lt;/bean&gt;  </span><br><span class="line">&lt;tx:annotation-driven transaction-manager=&quot;txManager&quot; /&gt;</span><br></pre></td></tr></table></figure></p><h3 id="一、解析配置文件"><a href="#一、解析配置文件" class="headerlink" title="一、解析配置文件"></a>一、解析配置文件</h3><h4 id="1、TxNamespaceHandler的init方法"><a href="#1、TxNamespaceHandler的init方法" class="headerlink" title="1、TxNamespaceHandler的init方法"></a>1、TxNamespaceHandler的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    registerBeanDefinitionParser(&quot;advice&quot;, new TxAdviceBeanDefinitionParser());</span><br><span class="line">    //标签解析器</span><br><span class="line">    registerBeanDefinitionParser(&quot;annotation-driven&quot;, new AnnotationDrivenBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;jta-transaction-manager&quot;, new JtaTransactionManagerBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AnnotationDrivenBeanDefinitionParser的parse方法"><a href="#2、AnnotationDrivenBeanDefinitionParser的parse方法" class="headerlink" title="2、AnnotationDrivenBeanDefinitionParser的parse方法"></a>2、AnnotationDrivenBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    registerTransactionalEventListenerFactory(parserContext);</span><br><span class="line">    String mode = element.getAttribute(&quot;mode&quot;);</span><br><span class="line">    //使用aspectj方式进行事务切入</span><br><span class="line">    if (&quot;aspectj&quot;.equals(mode)) &#123;</span><br><span class="line">        // mode=&quot;aspectj&quot;</span><br><span class="line">        registerTransactionAspect(element, parserContext);</span><br><span class="line">    &#125;</span><br><span class="line">    //使用动态代理方式进行事务切入</span><br><span class="line">    else &#123;</span><br><span class="line">        // mode=&quot;proxy&quot;</span><br><span class="line">        AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AnnotationDrivenBeanDefinitionParser的parse方法-1"><a href="#2、AnnotationDrivenBeanDefinitionParser的parse方法-1" class="headerlink" title="2、AnnotationDrivenBeanDefinitionParser的parse方法"></a>2、AnnotationDrivenBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //注册事务监听器工厂TransactionalEventListenerFactory</span><br><span class="line">    registerTransactionalEventListenerFactory(parserContext);</span><br><span class="line">    String mode = element.getAttribute(&quot;mode&quot;);</span><br><span class="line">    //使用aspectj方式进行事务切入</span><br><span class="line">    if (&quot;aspectj&quot;.equals(mode)) &#123;</span><br><span class="line">        // mode=&quot;aspectj&quot;</span><br><span class="line">        registerTransactionAspect(element, parserContext);</span><br><span class="line">    &#125;</span><br><span class="line">    //使用动态代理方式进行事务切入</span><br><span class="line">    else &#123;</span><br><span class="line">        // mode=&quot;proxy&quot;</span><br><span class="line">        AopAutoProxyConfigurer.configureAutoProxyCreator(element, parserContext);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AopAutoProxyConfigurer的configureAutoProxyCreator方法"><a href="#3、AopAutoProxyConfigurer的configureAutoProxyCreator方法" class="headerlink" title="3、AopAutoProxyConfigurer的configureAutoProxyCreator方法"></a>3、AopAutoProxyConfigurer的configureAutoProxyCreator方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public static void configureAutoProxyCreator(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //注册InfrastructureAdvisorAutoProxyCreator的bean</span><br><span class="line">    AopNamespaceUtils.registerAutoProxyCreatorIfNecessary(parserContext, element);</span><br><span class="line"></span><br><span class="line">    String txAdvisorBeanName = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME;</span><br><span class="line">    if (!parserContext.getRegistry().containsBeanDefinition(txAdvisorBeanName)) &#123;</span><br><span class="line">        Object eleSource = parserContext.extractSource(element);</span><br><span class="line"></span><br><span class="line">        // Create the TransactionAttributeSource definition.</span><br><span class="line">        //创建TransactionAttributeSource的bean</span><br><span class="line">        RootBeanDefinition sourceDef = new RootBeanDefinition(</span><br><span class="line">                &quot;org.springframework.transaction.annotation.AnnotationTransactionAttributeSource&quot;);</span><br><span class="line">        sourceDef.setSource(eleSource);</span><br><span class="line">        //基础设施</span><br><span class="line">        sourceDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        //注册sourceDef</span><br><span class="line">        String sourceName = parserContext.getReaderContext().registerWithGeneratedName(sourceDef);</span><br><span class="line"></span><br><span class="line">        // Create the TransactionInterceptor definition.</span><br><span class="line">        //创建TransactionInterceptor的bean</span><br><span class="line">        RootBeanDefinition interceptorDef = new RootBeanDefinition(TransactionInterceptor.class);</span><br><span class="line">        interceptorDef.setSource(eleSource);</span><br><span class="line">        interceptorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        //往interceptorDef中注入TransactionManager</span><br><span class="line">        registerTransactionManager(element, interceptorDef);</span><br><span class="line">        //注入sourceDef</span><br><span class="line">        interceptorDef.getPropertyValues().add(&quot;transactionAttributeSource&quot;, new RuntimeBeanReference(sourceName));</span><br><span class="line">        //注册interceptorDef</span><br><span class="line">        String interceptorName = parserContext.getReaderContext().registerWithGeneratedName(interceptorDef);</span><br><span class="line"></span><br><span class="line">        // Create the TransactionAttributeSourceAdvisor definition.</span><br><span class="line">        //创建BeanFactoryTransactionAttributeSourceAdvisor的bean，通知器</span><br><span class="line">        RootBeanDefinition advisorDef = new RootBeanDefinition(BeanFactoryTransactionAttributeSourceAdvisor.class);</span><br><span class="line">        advisorDef.setSource(eleSource);</span><br><span class="line">        advisorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        //注入TransactionAttributeSource的bean</span><br><span class="line">        advisorDef.getPropertyValues().add(&quot;transactionAttributeSource&quot;, new RuntimeBeanReference(sourceName));</span><br><span class="line">        //注入TransactionInterceptor的bean</span><br><span class="line">        advisorDef.getPropertyValues().add(&quot;adviceBeanName&quot;, interceptorName);</span><br><span class="line">        if (element.hasAttribute(&quot;order&quot;)) &#123;</span><br><span class="line">            advisorDef.getPropertyValues().add(&quot;order&quot;, element.getAttribute(&quot;order&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        //注册advisorDef</span><br><span class="line">        parserContext.getRegistry().registerBeanDefinition(txAdvisorBeanName, advisorDef);</span><br><span class="line">        //注册组件并广播</span><br><span class="line">        CompositeComponentDefinition compositeDef = new CompositeComponentDefinition(element.getTagName(), eleSource);</span><br><span class="line">        compositeDef.addNestedComponent(new BeanComponentDefinition(sourceDef, sourceName));</span><br><span class="line">        compositeDef.addNestedComponent(new BeanComponentDefinition(interceptorDef, interceptorName));</span><br><span class="line">        compositeDef.addNestedComponent(new BeanComponentDefinition(advisorDef, txAdvisorBeanName));</span><br><span class="line">        parserContext.registerComponent(compositeDef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAspectJAutoProxyCreatorIfNecessary(</span><br><span class="line">        ParserContext parserContext, Element sourceElement) &#123;</span><br><span class="line">    //注册AspectJAwareAdvisorAutoProxyCreator的bean</span><br><span class="line">    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary(</span><br><span class="line">            parserContext.getRegistry(), parserContext.extractSource(sourceElement));</span><br><span class="line">    //设置使用JDK动态代理或CGLIB动态代理，设置是否支持内部调用</span><br><span class="line">    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</span><br><span class="line">    //注册组件并广播</span><br><span class="line">    registerComponentIfNecessary(beanDefinition, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、创建代理对象"><a href="#二、创建代理对象" class="headerlink" title="二、创建代理对象"></a>二、创建代理对象</h3><h4 id="1、AbstractAutoProxyCreator的postProcessAfterInitialization方法"><a href="#1、AbstractAutoProxyCreator的postProcessAfterInitialization方法" class="headerlink" title="1、AbstractAutoProxyCreator的postProcessAfterInitialization方法"></a>1、AbstractAutoProxyCreator的postProcessAfterInitialization方法</h4><p>InfrastructureAdvisorAutoProxyCreator的父类AbstractAutoProxyCreator<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    if (bean != null) &#123;</span><br><span class="line">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        //检测循环依赖</span><br><span class="line">        if (!this.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">            //创建代理对象</span><br><span class="line">            return wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、AbstractAutoProxyCreator的wrapIfNecessary方法"><a href="#2、AbstractAutoProxyCreator的wrapIfNecessary方法" class="headerlink" title="2、AbstractAutoProxyCreator的wrapIfNecessary方法"></a>2、AbstractAutoProxyCreator的wrapIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">    //已经处理过</span><br><span class="line">    if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类不创建代理</span><br><span class="line">    if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy if we have advice.</span><br><span class="line">    //获取增强</span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">    if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">        //创建代理对象</span><br><span class="line">        Object proxy = createProxy(</span><br><span class="line">                bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">        this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        return proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、InfrastructureAdvisorAutoProxyCreator的isEligibleAdvisorBean方法"><a href="#3、InfrastructureAdvisorAutoProxyCreator的isEligibleAdvisorBean方法" class="headerlink" title="3、InfrastructureAdvisorAutoProxyCreator的isEligibleAdvisorBean方法"></a>3、InfrastructureAdvisorAutoProxyCreator的isEligibleAdvisorBean方法</h4><p>覆盖该方法，只取基础设施类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected boolean isEligibleAdvisorBean(String beanName) &#123;</span><br><span class="line">    return (this.beanFactory != null &amp;&amp; this.beanFactory.containsBeanDefinition(beanName) &amp;&amp;</span><br><span class="line">            this.beanFactory.getBeanDefinition(beanName).getRole() == BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、AopUtils的canApply方法"><a href="#4、AopUtils的canApply方法" class="headerlink" title="4、AopUtils的canApply方法"></a>4、AopUtils的canApply方法</h4><p>中间过程与AOP相同，此处的Pointcut为TransactionAttributeSourcePointcut<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;</span><br><span class="line">    Assert.notNull(pc, &quot;Pointcut must not be null&quot;);</span><br><span class="line">    if (!pc.getClassFilter().matches(targetClass)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回自身</span><br><span class="line">    MethodMatcher methodMatcher = pc.getMethodMatcher();</span><br><span class="line">    if (methodMatcher == MethodMatcher.TRUE) &#123;</span><br><span class="line">        // No need to iterate the methods if we&apos;re matching any method anyway...</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null;</span><br><span class="line">    if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123;</span><br><span class="line">        introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;&gt;();</span><br><span class="line">    //获取用户定义的类</span><br><span class="line">    if (!Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line">        classes.add(ClassUtils.getUserClass(targetClass));</span><br><span class="line">    &#125;</span><br><span class="line">    classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass));</span><br><span class="line"></span><br><span class="line">    for (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">        Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz);</span><br><span class="line">        //有一个方法匹配,即认为匹配</span><br><span class="line">        for (Method method : methods) &#123;</span><br><span class="line">            if (introductionAwareMethodMatcher != null ?</span><br><span class="line">                    introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) :</span><br><span class="line">                    methodMatcher.matches(method, targetClass)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、TransactionAttributeSourcePointcut的matches方法"><a href="#5、TransactionAttributeSourcePointcut的matches方法" class="headerlink" title="5、TransactionAttributeSourcePointcut的matches方法"></a>5、TransactionAttributeSourcePointcut的matches方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean matches(Method method, @Nullable Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">    //已经是该代理类</span><br><span class="line">    if (targetClass != null &amp;&amp; TransactionalProxy.class.isAssignableFrom(targetClass)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取AnnotationTransactionAttributeSource的bean</span><br><span class="line">    TransactionAttributeSource tas = getTransactionAttributeSource();</span><br><span class="line">    return (tas == null || tas.getTransactionAttribute(method, targetClass) != null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、实例化AnnotationTransactionAttributeSource"><a href="#6、实例化AnnotationTransactionAttributeSource" class="headerlink" title="6、实例化AnnotationTransactionAttributeSource"></a>6、实例化AnnotationTransactionAttributeSource</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationTransactionAttributeSource() &#123;</span><br><span class="line">    this(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationTransactionAttributeSource(boolean publicMethodsOnly) &#123;</span><br><span class="line">    this.publicMethodsOnly = publicMethodsOnly;</span><br><span class="line">    this.annotationParsers = new LinkedHashSet&lt;&gt;(2);</span><br><span class="line">    //@Transactional注解解析器</span><br><span class="line">    this.annotationParsers.add(new SpringTransactionAnnotationParser());</span><br><span class="line">    if (jta12Present) &#123;</span><br><span class="line">        //javax.transaction.Transactional注解</span><br><span class="line">        this.annotationParsers.add(new JtaTransactionAnnotationParser());</span><br><span class="line">    &#125;</span><br><span class="line">    if (ejb3Present) &#123;</span><br><span class="line">        //javax.ejb.TransactionAttribute注解</span><br><span class="line">        this.annotationParsers.add(new Ejb3TransactionAnnotationParser());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、AbstractFallbackTransactionAttributeSource的getTransactionAttribute方法"><a href="#7、AbstractFallbackTransactionAttributeSource的getTransactionAttribute方法" class="headerlink" title="7、AbstractFallbackTransactionAttributeSource的getTransactionAttribute方法"></a>7、AbstractFallbackTransactionAttributeSource的getTransactionAttribute方法</h4><p>AnnotationTransactionAttributeSource的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">public TransactionAttribute getTransactionAttribute(Method method, @Nullable Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">    //Object的方法不用代理</span><br><span class="line">    if (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // First, see if we have a cached value.</span><br><span class="line">    Object cacheKey = getCacheKey(method, targetClass);</span><br><span class="line">    Object cached = this.attributeCache.get(cacheKey);</span><br><span class="line">    if (cached != null) &#123;</span><br><span class="line">        // Value will either be canonical value indicating there is no transaction attribute,</span><br><span class="line">        // or an actual transaction attribute.</span><br><span class="line">        if (cached == NULL_TRANSACTION_ATTRIBUTE) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            return (TransactionAttribute) cached;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // We need to work it out.</span><br><span class="line">        //提取事务属性</span><br><span class="line">        TransactionAttribute txAttr = computeTransactionAttribute(method, targetClass);</span><br><span class="line">        // Put it in the cache.</span><br><span class="line">        //添加缓存</span><br><span class="line">        if (txAttr == null) &#123;</span><br><span class="line">            this.attributeCache.put(cacheKey, NULL_TRANSACTION_ATTRIBUTE);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //获取方法标识，默认类名加方法名</span><br><span class="line">            String methodIdentification = ClassUtils.getQualifiedMethodName(method, targetClass);</span><br><span class="line">            if (txAttr instanceof DefaultTransactionAttribute) &#123;</span><br><span class="line">                ((DefaultTransactionAttribute) txAttr).setDescriptor(methodIdentification);</span><br><span class="line">            &#125;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Adding transactional method &apos;&quot; + methodIdentification + &quot;&apos; with attribute: &quot; + txAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            this.attributeCache.put(cacheKey, txAttr);</span><br><span class="line">        &#125;</span><br><span class="line">        return txAttr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、AbstractFallbackTransactionAttributeSource的computeTransactionAttribute方法"><a href="#8、AbstractFallbackTransactionAttributeSource的computeTransactionAttribute方法" class="headerlink" title="8、AbstractFallbackTransactionAttributeSource的computeTransactionAttribute方法"></a>8、AbstractFallbackTransactionAttributeSource的computeTransactionAttribute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">protected TransactionAttribute computeTransactionAttribute(Method method, @Nullable Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">    // Don&apos;t allow no-public methods as required.</span><br><span class="line">    //只有public方法可创建事务</span><br><span class="line">    if (allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The method may be on an interface, but we need attributes from the target class.</span><br><span class="line">    // If the target class is null, the method will be unchanged.</span><br><span class="line">    //获取实现类的该方法</span><br><span class="line">    Method specificMethod = AopUtils.getMostSpecificMethod(method, targetClass);</span><br><span class="line"></span><br><span class="line">    // First try is the method in the target class.</span><br><span class="line">    //查找方法上的事务注解属性</span><br><span class="line">    TransactionAttribute txAttr = findTransactionAttribute(specificMethod);</span><br><span class="line">    if (txAttr != null) &#123;</span><br><span class="line">        return txAttr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Second try is the transaction attribute on the target class.</span><br><span class="line">    //查找方法所在类上的事务注解属性</span><br><span class="line">    txAttr = findTransactionAttribute(specificMethod.getDeclaringClass());</span><br><span class="line">    if (txAttr != null &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">        return txAttr;</span><br><span class="line">    &#125;</span><br><span class="line">    //存在接口</span><br><span class="line">    if (specificMethod != method) &#123;</span><br><span class="line">        // Fallback is to look at the original method.</span><br><span class="line">        //查找接口方法</span><br><span class="line">        txAttr = findTransactionAttribute(method);</span><br><span class="line">        if (txAttr != null) &#123;</span><br><span class="line">            return txAttr;</span><br><span class="line">        &#125;</span><br><span class="line">        // Last fallback is the class of the original method.</span><br><span class="line">        //查找接口</span><br><span class="line">        txAttr = findTransactionAttribute(method.getDeclaringClass());</span><br><span class="line">        if (txAttr != null &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">            return txAttr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、AnnotationTransactionAttributeSource的findTransactionAttribute方法"><a href="#9、AnnotationTransactionAttributeSource的findTransactionAttribute方法" class="headerlink" title="9、AnnotationTransactionAttributeSource的findTransactionAttribute方法"></a>9、AnnotationTransactionAttributeSource的findTransactionAttribute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">protected TransactionAttribute findTransactionAttribute(Method method) &#123;</span><br><span class="line">    return determineTransactionAttribute(method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、AnnotationTransactionAttributeSource的determineTransactionAttribute方法"><a href="#10、AnnotationTransactionAttributeSource的determineTransactionAttribute方法" class="headerlink" title="10、AnnotationTransactionAttributeSource的determineTransactionAttribute方法"></a>10、AnnotationTransactionAttributeSource的determineTransactionAttribute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">protected TransactionAttribute determineTransactionAttribute(AnnotatedElement ae) &#123;</span><br><span class="line">    for (TransactionAnnotationParser annotationParser : this.annotationParsers) &#123;</span><br><span class="line">        //解析注解</span><br><span class="line">        TransactionAttribute attr = annotationParser.parseTransactionAnnotation(ae);</span><br><span class="line">        if (attr != null) &#123;</span><br><span class="line">            return attr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、SpringTransactionAnnotationParser的parseTransactionAnnotation方法"><a href="#11、SpringTransactionAnnotationParser的parseTransactionAnnotation方法" class="headerlink" title="11、SpringTransactionAnnotationParser的parseTransactionAnnotation方法"></a>11、SpringTransactionAnnotationParser的parseTransactionAnnotation方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">public TransactionAttribute parseTransactionAnnotation(AnnotatedElement ae) &#123;</span><br><span class="line">    //获取方法、方法类、父类的注解和元注解属性</span><br><span class="line">    AnnotationAttributes attributes = AnnotatedElementUtils.findMergedAnnotationAttributes(</span><br><span class="line">            ae, Transactional.class, false, false);</span><br><span class="line">    if (attributes != null) &#123;</span><br><span class="line">        //解析注解属性</span><br><span class="line">        return parseTransactionAnnotation(attributes);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">protected TransactionAttribute parseTransactionAnnotation(AnnotationAttributes attributes) &#123;</span><br><span class="line">    RuleBasedTransactionAttribute rbta = new RuleBasedTransactionAttribute();</span><br><span class="line">    //解析propagation</span><br><span class="line">    Propagation propagation = attributes.getEnum(&quot;propagation&quot;);</span><br><span class="line">    rbta.setPropagationBehavior(propagation.value());</span><br><span class="line">    //解析isolation</span><br><span class="line">    Isolation isolation = attributes.getEnum(&quot;isolation&quot;);</span><br><span class="line">    rbta.setIsolationLevel(isolation.value());</span><br><span class="line">    //解析timeout</span><br><span class="line">    rbta.setTimeout(attributes.getNumber(&quot;timeout&quot;).intValue());</span><br><span class="line">    //解析readOnly</span><br><span class="line">    rbta.setReadOnly(attributes.getBoolean(&quot;readOnly&quot;));</span><br><span class="line">    //解析value</span><br><span class="line">    rbta.setQualifier(attributes.getString(&quot;value&quot;));</span><br><span class="line">    ArrayList&lt;RollbackRuleAttribute&gt; rollBackRules = new ArrayList&lt;&gt;();</span><br><span class="line">    //解析rollbackFor</span><br><span class="line">    Class&lt;?&gt;[] rbf = attributes.getClassArray(&quot;rollbackFor&quot;);</span><br><span class="line">    for (Class&lt;?&gt; rbRule : rbf) &#123;</span><br><span class="line">        RollbackRuleAttribute rule = new RollbackRuleAttribute(rbRule);</span><br><span class="line">        rollBackRules.add(rule);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析rollbackForClassName</span><br><span class="line">    String[] rbfc = attributes.getStringArray(&quot;rollbackForClassName&quot;);</span><br><span class="line">    for (String rbRule : rbfc) &#123;</span><br><span class="line">        RollbackRuleAttribute rule = new RollbackRuleAttribute(rbRule);</span><br><span class="line">        rollBackRules.add(rule);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析noRollbackFor</span><br><span class="line">    Class&lt;?&gt;[] nrbf = attributes.getClassArray(&quot;noRollbackFor&quot;);</span><br><span class="line">    for (Class&lt;?&gt; rbRule : nrbf) &#123;</span><br><span class="line">        NoRollbackRuleAttribute rule = new NoRollbackRuleAttribute(rbRule);</span><br><span class="line">        rollBackRules.add(rule);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析noRollbackForClassName</span><br><span class="line">    String[] nrbfc = attributes.getStringArray(&quot;noRollbackForClassName&quot;);</span><br><span class="line">    for (String rbRule : nrbfc) &#123;</span><br><span class="line">        NoRollbackRuleAttribute rule = new NoRollbackRuleAttribute(rbRule);</span><br><span class="line">        rollBackRules.add(rule);</span><br><span class="line">    &#125;</span><br><span class="line">    rbta.getRollbackRules().addAll(rollBackRules);</span><br><span class="line">    return rbta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、事务增强器"><a href="#三、事务增强器" class="headerlink" title="三、事务增强器"></a>三、事务增强器</h3><h4 id="1、TransactionInterceptor的invoke方法"><a href="#1、TransactionInterceptor的invoke方法" class="headerlink" title="1、TransactionInterceptor的invoke方法"></a>1、TransactionInterceptor的invoke方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@Nullable</span><br><span class="line">public Object invoke(final MethodInvocation invocation) throws Throwable &#123;</span><br><span class="line">    // Work out the target class: may be &#123;@code null&#125;.</span><br><span class="line">    // The TransactionAttributeSource should be passed the target class</span><br><span class="line">    // as well as the method, which may be from an interface.</span><br><span class="line">    //获取被代理的类</span><br><span class="line">    Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);</span><br><span class="line"></span><br><span class="line">    // Adapt to TransactionAspectSupport&apos;s invokeWithinTransaction...</span><br><span class="line">    //执行事务及方法</span><br><span class="line">    return invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、TransactionInterceptor的invokeWithinTransaction方法"><a href="#2、TransactionInterceptor的invokeWithinTransaction方法" class="headerlink" title="2、TransactionInterceptor的invokeWithinTransaction方法"></a>2、TransactionInterceptor的invokeWithinTransaction方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">protected Object invokeWithinTransaction(Method method, @Nullable Class&lt;?&gt; targetClass,</span><br><span class="line">        final InvocationCallback invocation) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">    // If the transaction attribute is null, the method is non-transactional.</span><br><span class="line">    TransactionAttributeSource tas = getTransactionAttributeSource();</span><br><span class="line">    //获取事务属性</span><br><span class="line">    final TransactionAttribute txAttr = (tas != null ? tas.getTransactionAttribute(method, targetClass) : null);</span><br><span class="line">    //获取注册的事务管理器,DataSourceTransactionManager</span><br><span class="line">    final PlatformTransactionManager tm = determineTransactionManager(txAttr);</span><br><span class="line">    //获取方法唯一标识，类名加方法名</span><br><span class="line">    final String joinpointIdentification = methodIdentification(method, targetClass, txAttr);</span><br><span class="line">    //声明式事务处理</span><br><span class="line">    if (txAttr == null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">        // Standard transaction demarcation with getTransaction and commit/rollback calls.</span><br><span class="line">        //创建TransactionInfo</span><br><span class="line">        TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">        Object retVal = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // This is an around advice: Invoke the next interceptor in the chain.</span><br><span class="line">            // This will normally result in a target object being invoked.</span><br><span class="line">            //执行被增强方法</span><br><span class="line">            retVal = invocation.proceedWithInvocation();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            // target invocation exception</span><br><span class="line">            //异常回滚</span><br><span class="line">            completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            //清除本事务信息，并恢复上一个事务信息</span><br><span class="line">            cleanupTransactionInfo(txInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        //提交事务</span><br><span class="line">        commitTransactionAfterReturning(txInfo);</span><br><span class="line">        return retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    //编程式事务处理</span><br><span class="line">    else &#123;</span><br><span class="line">        final ThrowableHolder throwableHolder = new ThrowableHolder();</span><br><span class="line"></span><br><span class="line">        // It&apos;s a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span><br><span class="line">        try &#123;</span><br><span class="line">            Object result = ((CallbackPreferringPlatformTransactionManager) tm).execute(txAttr, status -&gt; &#123;</span><br><span class="line">                //事务信息注册到本地线程</span><br><span class="line">                TransactionInfo txInfo = prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">                try &#123;</span><br><span class="line">                    return invocation.proceedWithInvocation();</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Throwable ex) &#123;</span><br><span class="line">                    if (txAttr.rollbackOn(ex)) &#123;</span><br><span class="line">                        // A RuntimeException: will lead to a rollback.</span><br><span class="line">                        if (ex instanceof RuntimeException) &#123;</span><br><span class="line">                            throw (RuntimeException) ex;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else &#123;</span><br><span class="line">                            throw new ThrowableHolderException(ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        // A normal return value: will lead to a commit.</span><br><span class="line">                        throwableHolder.throwable = ex;</span><br><span class="line">                        return null;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                finally &#123;</span><br><span class="line">                    cleanupTransactionInfo(txInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            // Check result state: It might indicate a Throwable to rethrow.</span><br><span class="line">            if (throwableHolder.throwable != null) &#123;</span><br><span class="line">                throw throwableHolder.throwable;</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ThrowableHolderException ex) &#123;</span><br><span class="line">            throw ex.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (TransactionSystemException ex2) &#123;</span><br><span class="line">            if (throwableHolder.throwable != null) &#123;</span><br><span class="line">                logger.error(&quot;Application exception overridden by commit exception&quot;, throwableHolder.throwable);</span><br><span class="line">                ex2.initApplicationException(throwableHolder.throwable);</span><br><span class="line">            &#125;</span><br><span class="line">            throw ex2;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex2) &#123;</span><br><span class="line">            if (throwableHolder.throwable != null) &#123;</span><br><span class="line">                logger.error(&quot;Application exception overridden by commit exception&quot;, throwableHolder.throwable);</span><br><span class="line">            &#125;</span><br><span class="line">            throw ex2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、TransactionInterceptor的createTransactionIfNecessary方法"><a href="#3、TransactionInterceptor的createTransactionIfNecessary方法" class="headerlink" title="3、TransactionInterceptor的createTransactionIfNecessary方法"></a>3、TransactionInterceptor的createTransactionIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;serial&quot;)</span><br><span class="line">protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm,</span><br><span class="line">        @Nullable TransactionAttribute txAttr, final String joinpointIdentification) &#123;</span><br><span class="line"></span><br><span class="line">    // If no name specified, apply method identification as transaction name.</span><br><span class="line">    if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123;</span><br><span class="line">        txAttr = new DelegatingTransactionAttribute(txAttr) &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public String getName() &#123;</span><br><span class="line">                return joinpointIdentification;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TransactionStatus status = null;</span><br><span class="line">    if (txAttr != null) &#123;</span><br><span class="line">        if (tm != null) &#123;</span><br><span class="line">            //获取TransactionStatus</span><br><span class="line">            status = tm.getTransaction(txAttr);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Skipping transactional joinpoint [&quot; + joinpointIdentification +</span><br><span class="line">                        &quot;] because no transaction manager has been configured&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //为TransactionStatus创建一个TransactionInfo,并存入线程变量，并挂起老的TransactionStatus</span><br><span class="line">    return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AbstractPlatformTransactionManager的getTransaction方法"><a href="#4、AbstractPlatformTransactionManager的getTransaction方法" class="headerlink" title="4、AbstractPlatformTransactionManager的getTransaction方法"></a>4、AbstractPlatformTransactionManager的getTransaction方法</h4><p>DataSourceTransactionManager的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException &#123;</span><br><span class="line">    //获取当前线程的事务</span><br><span class="line">    Object transaction = doGetTransaction();</span><br><span class="line"></span><br><span class="line">    // Cache debug flag to avoid repeated checks.</span><br><span class="line">    boolean debugEnabled = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">    if (definition == null) &#123;</span><br><span class="line">        // Use defaults if no transaction definition given.</span><br><span class="line">        definition = new DefaultTransactionDefinition();</span><br><span class="line">    &#125;</span><br><span class="line">    //是否存在事务，通过ConnectionHolder的transactionActive属性判断</span><br><span class="line">    if (isExistingTransaction(transaction)) &#123;</span><br><span class="line">        // Existing transaction found -&gt; check propagation behavior to find out how to behave.</span><br><span class="line">        //处理新事务</span><br><span class="line">        return handleExistingTransaction(definition, transaction, debugEnabled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check definition settings for new transaction.</span><br><span class="line">    //事务超时属性验证</span><br><span class="line">    if (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">        throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, definition.getTimeout());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span><br><span class="line">    //属性值mandatory，要求存在事务</span><br><span class="line">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</span><br><span class="line">        throw new IllegalTransactionStateException(</span><br><span class="line">                &quot;No existing transaction found for transaction marked with propagation &apos;mandatory&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //需要新建事务</span><br><span class="line">    else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br><span class="line">            definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br><span class="line">            definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">        //空挂起</span><br><span class="line">        SuspendedResourcesHolder suspendedResources = suspend(null);</span><br><span class="line">        if (debugEnabled) &#123;</span><br><span class="line">            logger.debug(&quot;Creating new transaction with name [&quot; + definition.getName() + &quot;]: &quot; + definition);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //是否能够创建新事务</span><br><span class="line">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">            //创建新TransactionStatus</span><br><span class="line">            DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">                    definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">            //设置事务属性</span><br><span class="line">            doBegin(transaction, definition);</span><br><span class="line">            //绑定事务到当前线程</span><br><span class="line">            prepareSynchronization(status, definition);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (RuntimeException | Error ex) &#123;</span><br><span class="line">            resume(null, suspendedResources);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建空事务</span><br><span class="line">    else &#123;</span><br><span class="line">        // Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span><br><span class="line">        if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">            logger.warn(&quot;Custom isolation level specified but no actual transaction initiated; &quot; +</span><br><span class="line">                    &quot;isolation level will effectively be ignored: &quot; + definition);</span><br><span class="line">        &#125;</span><br><span class="line">        boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">        return prepareTransactionStatus(definition, null, true, newSynchronization, debugEnabled, null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、DataSourceTransactionManager的doGetTransaction方法"><a href="#5、DataSourceTransactionManager的doGetTransaction方法" class="headerlink" title="5、DataSourceTransactionManager的doGetTransaction方法"></a>5、DataSourceTransactionManager的doGetTransaction方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object doGetTransaction() &#123;</span><br><span class="line">    //创建事务</span><br><span class="line">    DataSourceTransactionObject txObject = new DataSourceTransactionObject();</span><br><span class="line">    //设置是否允许保存点</span><br><span class="line">    txObject.setSavepointAllowed(isNestedTransactionAllowed());</span><br><span class="line">    //获取事务数据库连接容器，不存在返回null</span><br><span class="line">    ConnectionHolder conHolder =</span><br><span class="line">            (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource());</span><br><span class="line">    //事务中设置连接容器，false表示旧，不存在返回null事务</span><br><span class="line">    txObject.setConnectionHolder(conHolder, false);</span><br><span class="line">    return txObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（三、4）DataSourceTransactionManager的doBegin方法"><a href="#6、接（三、4）DataSourceTransactionManager的doBegin方法" class="headerlink" title="6、接（三、4）DataSourceTransactionManager的doBegin方法"></a>6、接（三、4）DataSourceTransactionManager的doBegin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void doBegin(Object transaction, TransactionDefinition definition) &#123;</span><br><span class="line">    //事务</span><br><span class="line">    DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;</span><br><span class="line">    Connection con = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //事务中未设置连接容器</span><br><span class="line">        if (!txObject.hasConnectionHolder() ||</span><br><span class="line">                txObject.getConnectionHolder().isSynchronizedWithTransaction()) &#123;</span><br><span class="line">            //从数据源中获取连接</span><br><span class="line">            Connection newCon = obtainDataSource().getConnection();</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Acquired Connection [&quot; + newCon + &quot;] for JDBC transaction&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //设置连接容器</span><br><span class="line">            txObject.setConnectionHolder(new ConnectionHolder(newCon), true);</span><br><span class="line">        &#125;</span><br><span class="line">        //设置连接容器已被事务获取</span><br><span class="line">        txObject.getConnectionHolder().setSynchronizedWithTransaction(true);</span><br><span class="line">        con = txObject.getConnectionHolder().getConnection();</span><br><span class="line">        //设置只读、隔离级别属性</span><br><span class="line">        Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition);</span><br><span class="line">        //设置隔离级别</span><br><span class="line">        txObject.setPreviousIsolationLevel(previousIsolationLevel);</span><br><span class="line"></span><br><span class="line">        // Switch to manual commit if necessary. This is very expensive in some JDBC drivers,</span><br><span class="line">        // so we don&apos;t want to do it unnecessarily (for example if we&apos;ve explicitly</span><br><span class="line">        // configured the connection pool to set it already).</span><br><span class="line">        //改变自动提交</span><br><span class="line">        if (con.getAutoCommit()) &#123;</span><br><span class="line">            txObject.setMustRestoreAutoCommit(true);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Switching JDBC Connection [&quot; + con + &quot;] to manual commit&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            con.setAutoCommit(false);</span><br><span class="line">        &#125;</span><br><span class="line">        //待子类实现</span><br><span class="line">        prepareTransactionalConnection(con, definition);</span><br><span class="line">        //设置当前连接存在事务</span><br><span class="line">        txObject.getConnectionHolder().setTransactionActive(true);</span><br><span class="line">        //设置超时时间</span><br><span class="line">        int timeout = determineTimeout(definition);</span><br><span class="line">        if (timeout != TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">            txObject.getConnectionHolder().setTimeoutInSeconds(timeout);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Bind the connection holder to the thread.</span><br><span class="line">        //新事务，连接容器绑定到当前线程</span><br><span class="line">        if (txObject.isNewConnectionHolder()) &#123;</span><br><span class="line">            TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        if (txObject.isNewConnectionHolder()) &#123;</span><br><span class="line">            DataSourceUtils.releaseConnection(con, obtainDataSource());</span><br><span class="line">            txObject.setConnectionHolder(null, false);</span><br><span class="line">        &#125;</span><br><span class="line">        throw new CannotCreateTransactionException(&quot;Could not open JDBC Connection for transaction&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（三、4）AbstractPlatformTransactionManager的prepareSynchronization方法"><a href="#7、接（三、4）AbstractPlatformTransactionManager的prepareSynchronization方法" class="headerlink" title="7、接（三、4）AbstractPlatformTransactionManager的prepareSynchronization方法"></a>7、接（三、4）AbstractPlatformTransactionManager的prepareSynchronization方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected void prepareSynchronization(DefaultTransactionStatus status, TransactionDefinition definition) &#123;</span><br><span class="line">    //新的事务</span><br><span class="line">    if (status.isNewSynchronization()) &#123;</span><br><span class="line">        //事务绑定到当前线程</span><br><span class="line">        TransactionSynchronizationManager.setActualTransactionActive(status.hasTransaction());</span><br><span class="line">        //隔离级别绑定到当前线程</span><br><span class="line">        TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(</span><br><span class="line">                definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT ?</span><br><span class="line">                        definition.getIsolationLevel() : null);</span><br><span class="line">        //只读属性绑定到当前线程</span><br><span class="line">        TransactionSynchronizationManager.setCurrentTransactionReadOnly(definition.isReadOnly());</span><br><span class="line">        //事务名称绑定到当前线程</span><br><span class="line">        TransactionSynchronizationManager.setCurrentTransactionName(definition.getName());</span><br><span class="line">        //回调函数集合绑定到当前线程</span><br><span class="line">        TransactionSynchronizationManager.initSynchronization();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（三、4）AbstractPlatformTransactionManager的handleExistingTransaction方法"><a href="#8、接（三、4）AbstractPlatformTransactionManager的handleExistingTransaction方法" class="headerlink" title="8、接（三、4）AbstractPlatformTransactionManager的handleExistingTransaction方法"></a>8、接（三、4）AbstractPlatformTransactionManager的handleExistingTransaction方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">private TransactionStatus handleExistingTransaction(</span><br><span class="line">        TransactionDefinition definition, Object transaction, boolean debugEnabled)</span><br><span class="line">        throws TransactionException &#123;</span><br><span class="line">    //以非事务方式执行，如果当前存在事务，则抛出异常</span><br><span class="line">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123;</span><br><span class="line">        throw new IllegalTransactionStateException(</span><br><span class="line">                &quot;Existing transaction found for transaction marked with propagation &apos;never&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //以非事务方式执行操作，如果当前存在事务，就把当前事务挂起</span><br><span class="line">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123;</span><br><span class="line">        if (debugEnabled) &#123;</span><br><span class="line">            logger.debug(&quot;Suspending current transaction&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //挂起当前事务</span><br><span class="line">        Object suspendedResources = suspend(transaction);</span><br><span class="line">        boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">        //创建空事务</span><br><span class="line">        return prepareTransactionStatus(</span><br><span class="line">                definition, null, false, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">    &#125;</span><br><span class="line">    //新建事务，如果当前存在事务，把当前事务挂起</span><br><span class="line">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123;</span><br><span class="line">        if (debugEnabled) &#123;</span><br><span class="line">            logger.debug(&quot;Suspending current transaction, creating new transaction with name [&quot; +</span><br><span class="line">                    definition.getName() + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //挂起当前事务</span><br><span class="line">        SuspendedResourcesHolder suspendedResources = suspend(transaction);</span><br><span class="line">        try &#123;</span><br><span class="line">            //创建新事务</span><br><span class="line">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">            DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">                    definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">            doBegin(transaction, definition);</span><br><span class="line">            prepareSynchronization(status, definition);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (RuntimeException | Error beginEx) &#123;</span><br><span class="line">            resumeAfterBeginException(transaction, suspendedResources, beginEx);</span><br><span class="line">            throw beginEx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //嵌套事务</span><br><span class="line">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">        //是否允许嵌套事务</span><br><span class="line">        if (!isNestedTransactionAllowed()) &#123;</span><br><span class="line">            throw new NestedTransactionNotSupportedException(</span><br><span class="line">                    &quot;Transaction manager does not allow nested transactions by default - &quot; +</span><br><span class="line">                    &quot;specify &apos;nestedTransactionAllowed&apos; property with value &apos;true&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (debugEnabled) &#123;</span><br><span class="line">            logger.debug(&quot;Creating nested transaction with name [&quot; + definition.getName() + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //嵌套事务使用保存点</span><br><span class="line">        if (useSavepointForNestedTransaction()) &#123;</span><br><span class="line">            // Create savepoint within existing Spring-managed transaction,</span><br><span class="line">            // through the SavepointManager API implemented by TransactionStatus.</span><br><span class="line">            // Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</span><br><span class="line">            //用原来的transaction创建新的TransactionStatus</span><br><span class="line">            DefaultTransactionStatus status =</span><br><span class="line">                    prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null);</span><br><span class="line">            //创建保存点</span><br><span class="line">            status.createAndHoldSavepoint();</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //不能使用的保存点，如JTA，创建新事务</span><br><span class="line">            // Nested transaction through nested begin and commit/rollback calls.</span><br><span class="line">            // Usually only for JTA: Spring synchronization might get activated here</span><br><span class="line">            // in case of a pre-existing JTA transaction.</span><br><span class="line">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">            DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">                    definition, transaction, true, newSynchronization, debugEnabled, null);</span><br><span class="line">            doBegin(transaction, definition);</span><br><span class="line">            prepareSynchronization(status, definition);</span><br><span class="line">            return status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</span><br><span class="line">    if (debugEnabled) &#123;</span><br><span class="line">        logger.debug(&quot;Participating in existing transaction&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (isValidateExistingTransaction()) &#123;</span><br><span class="line">        if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123;</span><br><span class="line">            Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</span><br><span class="line">            if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123;</span><br><span class="line">                Constants isoConstants = DefaultTransactionDefinition.constants;</span><br><span class="line">                throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; +</span><br><span class="line">                        definition + &quot;] specifies isolation level which is incompatible with existing transaction: &quot; +</span><br><span class="line">                        (currentIsolationLevel != null ?</span><br><span class="line">                                isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) :</span><br><span class="line">                                &quot;(unknown)&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!definition.isReadOnly()) &#123;</span><br><span class="line">            if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123;</span><br><span class="line">                throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; +</span><br><span class="line">                        definition + &quot;] is not marked as read-only but existing transaction is&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建空事务</span><br><span class="line">    boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">    return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、AbstractPlatformTransactionManager的suspend方法"><a href="#9、AbstractPlatformTransactionManager的suspend方法" class="headerlink" title="9、AbstractPlatformTransactionManager的suspend方法"></a>9、AbstractPlatformTransactionManager的suspend方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">protected final SuspendedResourcesHolder suspend(@Nullable Object transaction) throws TransactionException &#123;</span><br><span class="line">    //事务信息已经绑定到当前线程</span><br><span class="line">    if (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</span><br><span class="line">        //事务回调函数</span><br><span class="line">        List&lt;TransactionSynchronization&gt; suspendedSynchronizations = doSuspendSynchronization();</span><br><span class="line">        try &#123;</span><br><span class="line">            Object suspendedResources = null;</span><br><span class="line">            if (transaction != null) &#123;</span><br><span class="line">                //挂起事务，ConnectionHolder取消绑定当前线程，并返回</span><br><span class="line">                suspendedResources = doSuspend(transaction);</span><br><span class="line">            &#125;</span><br><span class="line">            //清除当前线程绑定的事务信息</span><br><span class="line">            String name = TransactionSynchronizationManager.getCurrentTransactionName();</span><br><span class="line">            TransactionSynchronizationManager.setCurrentTransactionName(null);</span><br><span class="line">            boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">            TransactionSynchronizationManager.setCurrentTransactionReadOnly(false);</span><br><span class="line">            Integer isolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</span><br><span class="line">            TransactionSynchronizationManager.setCurrentTransactionIsolationLevel(null);</span><br><span class="line">            boolean wasActive = TransactionSynchronizationManager.isActualTransactionActive();</span><br><span class="line">            TransactionSynchronizationManager.setActualTransactionActive(false);</span><br><span class="line">            //创建挂起事务信息</span><br><span class="line">            return new SuspendedResourcesHolder(</span><br><span class="line">                    suspendedResources, suspendedSynchronizations, name, readOnly, isolationLevel, wasActive);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (RuntimeException | Error ex) &#123;</span><br><span class="line">            // doSuspend failed - original transaction is still active...</span><br><span class="line">            //挂起失败，恢复当前事务</span><br><span class="line">            doResumeSynchronization(suspendedSynchronizations);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (transaction != null) &#123;</span><br><span class="line">        // Transaction active but no synchronization active.</span><br><span class="line">        //挂起事务</span><br><span class="line">        Object suspendedResources = doSuspend(transaction);</span><br><span class="line">        //创建挂起事务信息</span><br><span class="line">        return new SuspendedResourcesHolder(suspendedResources);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Neither transaction nor synchronization active.</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（三、2）TransactionInterceptor的completeTransactionAfterThrowing方法"><a href="#10、接（三、2）TransactionInterceptor的completeTransactionAfterThrowing方法" class="headerlink" title="10、接（三、2）TransactionInterceptor的completeTransactionAfterThrowing方法"></a>10、接（三、2）TransactionInterceptor的completeTransactionAfterThrowing方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">protected void completeTransactionAfterThrowing(@Nullable TransactionInfo txInfo, Throwable ex) &#123;</span><br><span class="line">    //存在事务</span><br><span class="line">    if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() +</span><br><span class="line">                    &quot;] after exception: &quot; + ex);</span><br><span class="line">        &#125;</span><br><span class="line">        //捕获到须回滚的异常</span><br><span class="line">        if (txInfo.transactionAttribute != null &amp;&amp; txInfo.transactionAttribute.rollbackOn(ex)) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //回滚</span><br><span class="line">                txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            catch (TransactionSystemException ex2) &#123;</span><br><span class="line">                logger.error(&quot;Application exception overridden by rollback exception&quot;, ex);</span><br><span class="line">                ex2.initApplicationException(ex);</span><br><span class="line">                throw ex2;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (RuntimeException | Error ex2) &#123;</span><br><span class="line">                logger.error(&quot;Application exception overridden by rollback exception&quot;, ex);</span><br><span class="line">                throw ex2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //捕获到不须回滚的异常</span><br><span class="line">        else &#123;</span><br><span class="line">            // We don&apos;t roll back on this exception.</span><br><span class="line">            // Will still roll back if TransactionStatus.isRollbackOnly() is true.</span><br><span class="line">            try &#123;</span><br><span class="line">                //提交事务，任然有可能回滚TransactionStatus.isRollbackOnly()</span><br><span class="line">                txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            catch (TransactionSystemException ex2) &#123;</span><br><span class="line">                logger.error(&quot;Application exception overridden by commit exception&quot;, ex);</span><br><span class="line">                ex2.initApplicationException(ex);</span><br><span class="line">                throw ex2;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (RuntimeException | Error ex2) &#123;</span><br><span class="line">                logger.error(&quot;Application exception overridden by commit exception&quot;, ex);</span><br><span class="line">                throw ex2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、AbstractPlatformTransactionManager的rollback方法"><a href="#11、AbstractPlatformTransactionManager的rollback方法" class="headerlink" title="11、AbstractPlatformTransactionManager的rollback方法"></a>11、AbstractPlatformTransactionManager的rollback方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void rollback(TransactionStatus status) throws TransactionException &#123;</span><br><span class="line">    //已被提交或回滚</span><br><span class="line">    if (status.isCompleted()) &#123;</span><br><span class="line">        throw new IllegalTransactionStateException(</span><br><span class="line">                &quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status;</span><br><span class="line">    //回滚</span><br><span class="line">    processRollback(defStatus, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、AbstractPlatformTransactionManager的processRollback方法"><a href="#12、AbstractPlatformTransactionManager的processRollback方法" class="headerlink" title="12、AbstractPlatformTransactionManager的processRollback方法"></a>12、AbstractPlatformTransactionManager的processRollback方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">private void processRollback(DefaultTransactionStatus status, boolean unexpected) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        boolean unexpectedRollback = unexpected;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //调用回调函数的beforeCompletion方法</span><br><span class="line">            triggerBeforeCompletion(status);</span><br><span class="line"></span><br><span class="line">            if (status.hasSavepoint()) &#123;</span><br><span class="line">                if (status.isDebug()) &#123;</span><br><span class="line">                    logger.debug(&quot;Rolling back transaction to savepoint&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //回滚到保存点</span><br><span class="line">                status.rollbackToHeldSavepoint();</span><br><span class="line">            &#125;</span><br><span class="line">            else if (status.isNewTransaction()) &#123;</span><br><span class="line">                if (status.isDebug()) &#123;</span><br><span class="line">                    logger.debug(&quot;Initiating transaction rollback&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //回滚</span><br><span class="line">                doRollback(status);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // Participating in larger transaction</span><br><span class="line">                //全局事务的部份</span><br><span class="line">                if (status.hasTransaction()) &#123;</span><br><span class="line">                    //TransactionStatus中回滚属性设置为true,设置全局事务回滚</span><br><span class="line">                    if (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) &#123;</span><br><span class="line">                        if (status.isDebug()) &#123;</span><br><span class="line">                            logger.debug(&quot;Participating transaction failed - marking existing transaction as rollback-only&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        //设置transaction中回滚属性为true</span><br><span class="line">                        doSetRollbackOnly(status);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        if (status.isDebug()) &#123;</span><br><span class="line">                            logger.debug(&quot;Participating transaction failed - letting transaction originator decide on rollback&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    //打印错误日志</span><br><span class="line">                    logger.debug(&quot;Should roll back transaction but cannot - no transaction available&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                // Unexpected rollback only matters here if we&apos;re asked to fail early</span><br><span class="line">                if (!isFailEarlyOnGlobalRollbackOnly()) &#123;</span><br><span class="line">                    unexpectedRollback = false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (RuntimeException | Error ex) &#123;</span><br><span class="line">            triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        //回调函数的afterCompletion方法</span><br><span class="line">        triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</span><br><span class="line"></span><br><span class="line">        // Raise UnexpectedRollbackException if we had a global rollback-only marker</span><br><span class="line">        if (unexpectedRollback) &#123;</span><br><span class="line">            throw new UnexpectedRollbackException(</span><br><span class="line">                    &quot;Transaction rolled back because it has been marked as rollback-only&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        //清空当前事务，并恢复挂起的事务</span><br><span class="line">        cleanupAfterCompletion(status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、接（三、2）TransactionInterceptor的commitTransactionAfterReturning方法"><a href="#13、接（三、2）TransactionInterceptor的commitTransactionAfterReturning方法" class="headerlink" title="13、接（三、2）TransactionInterceptor的commitTransactionAfterReturning方法"></a>13、接（三、2）TransactionInterceptor的commitTransactionAfterReturning方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected void commitTransactionAfterReturning(@Nullable TransactionInfo txInfo) &#123;</span><br><span class="line">    if (txInfo != null &amp;&amp; txInfo.getTransactionStatus() != null) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //提交事务</span><br><span class="line">        txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、AbstractPlatformTransactionManager的commit方法"><a href="#14、AbstractPlatformTransactionManager的commit方法" class="headerlink" title="14、AbstractPlatformTransactionManager的commit方法"></a>14、AbstractPlatformTransactionManager的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void commit(TransactionStatus status) throws TransactionException &#123;</span><br><span class="line">    //已提交或回滚</span><br><span class="line">    if (status.isCompleted()) &#123;</span><br><span class="line">        throw new IllegalTransactionStateException(</span><br><span class="line">                &quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DefaultTransactionStatus defStatus = (DefaultTransactionStatus) status;</span><br><span class="line">    //TransactionStatus中回滚属性设置为true</span><br><span class="line">    if (defStatus.isLocalRollbackOnly()) &#123;</span><br><span class="line">        if (defStatus.isDebug()) &#123;</span><br><span class="line">            logger.debug(&quot;Transactional code has requested rollback&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //回滚事务</span><br><span class="line">        processRollback(defStatus, false);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //Transaction中回滚属性设置为true</span><br><span class="line">    if (!shouldCommitOnGlobalRollbackOnly() &amp;&amp; defStatus.isGlobalRollbackOnly()) &#123;</span><br><span class="line">        if (defStatus.isDebug()) &#123;</span><br><span class="line">            logger.debug(&quot;Global transaction is marked as rollback-only but transactional code requested commit&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        processRollback(defStatus, true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //提交事务</span><br><span class="line">    processCommit(defStatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、AbstractPlatformTransactionManager的processCommit方法"><a href="#15、AbstractPlatformTransactionManager的processCommit方法" class="headerlink" title="15、AbstractPlatformTransactionManager的processCommit方法"></a>15、AbstractPlatformTransactionManager的processCommit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">private void processCommit(DefaultTransactionStatus status) throws TransactionException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        boolean beforeCompletionInvoked = false;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            boolean unexpectedRollback = false;</span><br><span class="line">            //待子类覆盖</span><br><span class="line">            prepareForCommit(status);</span><br><span class="line">            //调用回调函数的beforeCommit方法</span><br><span class="line">            triggerBeforeCommit(status);</span><br><span class="line">            //调用回调函数的beforeCompletion方法</span><br><span class="line">            triggerBeforeCompletion(status);</span><br><span class="line">            beforeCompletionInvoked = true;</span><br><span class="line"></span><br><span class="line">            if (status.hasSavepoint()) &#123;</span><br><span class="line">                if (status.isDebug()) &#123;</span><br><span class="line">                    logger.debug(&quot;Releasing transaction savepoint&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                unexpectedRollback = status.isGlobalRollbackOnly();</span><br><span class="line">                //释放保存点</span><br><span class="line">                status.releaseHeldSavepoint();</span><br><span class="line">            &#125;</span><br><span class="line">            else if (status.isNewTransaction()) &#123;</span><br><span class="line">                if (status.isDebug()) &#123;</span><br><span class="line">                    logger.debug(&quot;Initiating transaction commit&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                unexpectedRollback = status.isGlobalRollbackOnly();</span><br><span class="line">                //提交事务</span><br><span class="line">                doCommit(status);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (isFailEarlyOnGlobalRollbackOnly()) &#123;</span><br><span class="line">                unexpectedRollback = status.isGlobalRollbackOnly();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Throw UnexpectedRollbackException if we have a global rollback-only</span><br><span class="line">            // marker but still didn&apos;t get a corresponding exception from commit.</span><br><span class="line">            if (unexpectedRollback) &#123;</span><br><span class="line">                throw new UnexpectedRollbackException(</span><br><span class="line">                        &quot;Transaction silently rolled back because it has been marked as rollback-only&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (UnexpectedRollbackException ex) &#123;</span><br><span class="line">            // can only be caused by doCommit</span><br><span class="line">            triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (TransactionException ex) &#123;</span><br><span class="line">            // can only be caused by doCommit</span><br><span class="line">            if (isRollbackOnCommitFailure()) &#123;</span><br><span class="line">                doRollbackOnCommitException(status, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">            &#125;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (RuntimeException | Error ex) &#123;</span><br><span class="line">            if (!beforeCompletionInvoked) &#123;</span><br><span class="line">                triggerBeforeCompletion(status);</span><br><span class="line">            &#125;</span><br><span class="line">            doRollbackOnCommitException(status, ex);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Trigger afterCommit callbacks, with an exception thrown there</span><br><span class="line">        // propagated to callers but the transaction still considered as committed.</span><br><span class="line">        try &#123;</span><br><span class="line">            //调用回调函数的afterCommit方法</span><br><span class="line">            triggerAfterCommit(status);</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            //调用回调函数的afterCompletion方法</span><br><span class="line">            triggerAfterCompletion(status, TransactionSynchronization.STATUS_COMMITTED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        //清空当前事务，并恢复挂起的事务</span><br><span class="line">        cleanupAfterCompletion(status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;p&gt;spring配置文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td c
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码SpringMVC</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81SpringMVC/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码SpringMVC/</id>
    <published>2018-06-27T13:10:29.026Z</published>
    <updated>2018-06-28T14:08:33.603Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>web.xml配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;context-param&gt;  </span><br><span class="line">    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;  </span><br><span class="line">    &lt;param-value&gt;  </span><br><span class="line">        classpath:applicationContext.xml  </span><br><span class="line">    &lt;/param-value&gt;  </span><br><span class="line">&lt;/context-param&gt;  </span><br><span class="line">&lt;listener&gt;  </span><br><span class="line">    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;  </span><br><span class="line">&lt;/listener&gt;</span><br><span class="line"></span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure></p><p>applicationContext.xml配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans:beans xmlns:beans=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd</span><br><span class="line">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd &quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mvc:annotation-driven /&gt;</span><br><span class="line">    &lt;!--对web包中的所有类进行扫描，以完成Bean创建和自动依赖注入的功能 --&gt;</span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.zjn&quot; /</span><br><span class="line"></span><br><span class="line">    &lt;!-- 这个类用于Spring MVC视图解析 --&gt;</span><br><span class="line">    &lt;beans:bean id=&quot;viewResolver&quot;</span><br><span class="line">        class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span><br><span class="line">        &lt;beans:property name=&quot;prefix&quot; value=&quot;/WEB-INF/pages/&quot; /&gt;</span><br><span class="line">        &lt;beans:property name=&quot;suffix&quot; value=&quot;.jsp&quot; /&gt;</span><br><span class="line">    &lt;/beans:bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 定义文件上传解析器 --&gt;</span><br><span class="line">    &lt;bean id=&quot;multipartResolver&quot; class=&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;&gt;</span><br><span class="line">        &lt;!-- 设定默认编码 --&gt;</span><br><span class="line">        &lt;property name=&quot;defaultEncoding&quot; value=&quot;UTF-8&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 设定文件上传的最大值为5MB，5*1024*1024 --&gt;</span><br><span class="line">        &lt;property name=&quot;maxUploadSize&quot; value=&quot;5242880&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 设定文件上传时写入内存的最大值，如果小于这个参数不会生成临时文件，默认为10240 --&gt;</span><br><span class="line">        &lt;property name=&quot;maxInMemorySize&quot; value=&quot;40960&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 上传文件的临时路径 --&gt;</span><br><span class="line">        &lt;property name=&quot;uploadTempDir&quot; value=&quot;fileUpload/temp&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 延迟文件解析 --&gt;</span><br><span class="line">        &lt;property name=&quot;resolveLazily&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans:beans&gt;</span><br></pre></td></tr></table></figure></p><h3 id="一、启动容器"><a href="#一、启动容器" class="headerlink" title="一、启动容器"></a>一、启动容器</h3><h4 id="1、ContextLoaderListener的contextInitialized方法"><a href="#1、ContextLoaderListener的contextInitialized方法" class="headerlink" title="1、ContextLoaderListener的contextInitialized方法"></a>1、ContextLoaderListener的contextInitialized方法</h4><p>tomcat启动时会初始化一个Servlet容器，这样ContextLoaderListener会监听到Servlet的初始化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override  </span><br><span class="line">public void contextInitialized(ServletContextEvent event) &#123;  </span><br><span class="line">    //初始化ioc容器 </span><br><span class="line">    initWebApplicationContext(event.getServletContext());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、ContextLoader的initWebApplicationContext方法"><a href="#2、ContextLoader的initWebApplicationContext方法" class="headerlink" title="2、ContextLoader的initWebApplicationContext方法"></a>2、ContextLoader的initWebApplicationContext方法</h4><p>ContextLoaderListener的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public WebApplicationContext initWebApplicationContext(ServletContext servletContext) &#123;</span><br><span class="line">    //servlet容器中已存在一个ioc容器</span><br><span class="line">    if (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;Cannot initialize context because there is already a root application context present - &quot; +</span><br><span class="line">                &quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log logger = LogFactory.getLog(ContextLoader.class);</span><br><span class="line">    servletContext.log(&quot;Initializing Spring root WebApplicationContext&quot;);</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Root WebApplicationContext: initialization started&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Store context in local instance variable, to guarantee that</span><br><span class="line">        // it is available on ServletContext shutdown.</span><br><span class="line">        if (this.context == null) &#123;</span><br><span class="line">            //创建WebApplicationContext，默认为ContextLoader.properties中配置的XmlWebApplicationContext容器</span><br><span class="line">            this.context = createWebApplicationContext(servletContext);</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.context instanceof ConfigurableWebApplicationContext) &#123;</span><br><span class="line">            ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context;</span><br><span class="line">            //容器未激活或已关闭</span><br><span class="line">            if (!cwac.isActive()) &#123;</span><br><span class="line">                // The context has not yet been refreshed -&gt; provide services such as</span><br><span class="line">                // setting the parent context, setting the application context id, etc</span><br><span class="line">                if (cwac.getParent() == null) &#123;</span><br><span class="line">                    // The context instance was injected without an explicit parent -&gt;</span><br><span class="line">                    // determine parent for root web application context, if any.</span><br><span class="line">                    //从servlet容器中获取父容器，没有则返回null</span><br><span class="line">                    ApplicationContext parent = loadParentContext(servletContext);</span><br><span class="line">                    cwac.setParent(parent);</span><br><span class="line">                &#125;</span><br><span class="line">                //设置并刷新WebApplicationContext容器</span><br><span class="line">                configureAndRefreshWebApplicationContext(cwac, servletContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //将初始化的WebApplicationContext设置到servletContext中</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);</span><br><span class="line"></span><br><span class="line">        ClassLoader ccl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        if (ccl == ContextLoader.class.getClassLoader()) &#123;</span><br><span class="line">            currentContext = this.context;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ccl != null) &#123;</span><br><span class="line">            currentContextPerThread.put(ccl, this.context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Published root WebApplicationContext as ServletContext attribute with name [&quot; +</span><br><span class="line">                    WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            long elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">            logger.info(&quot;Root WebApplicationContext: initialization completed in &quot; + elapsedTime + &quot; ms&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return this.context;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (RuntimeException ex) &#123;</span><br><span class="line">        logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Error err) &#123;</span><br><span class="line">        logger.error(&quot;Context initialization failed&quot;, err);</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, err);</span><br><span class="line">        throw err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、ContextLoader的configureAndRefreshWebApplicationContext方法"><a href="#3、ContextLoader的configureAndRefreshWebApplicationContext方法" class="headerlink" title="3、ContextLoader的configureAndRefreshWebApplicationContext方法"></a>3、ContextLoader的configureAndRefreshWebApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc) &#123;</span><br><span class="line">    if (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123;</span><br><span class="line">        // The application context id is still set to its original default value</span><br><span class="line">        // -&gt; assign a more useful id based on available information</span><br><span class="line">        //设置容器id</span><br><span class="line">        String idParam = sc.getInitParameter(CONTEXT_ID_PARAM);</span><br><span class="line">        if (idParam != null) &#123;</span><br><span class="line">            wac.setId(idParam);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Generate default id...</span><br><span class="line">            wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +</span><br><span class="line">                    ObjectUtils.getDisplayString(sc.getContextPath()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置ServletContext到容器中</span><br><span class="line">    wac.setServletContext(sc);</span><br><span class="line">    //获得web.xml中配置的contextConfigLocation的值，一般是classpath:applicationContext.xml</span><br><span class="line">    String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM);</span><br><span class="line">    if (configLocationParam != null) &#123;</span><br><span class="line">        wac.setConfigLocation(configLocationParam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The wac environment&apos;s #initPropertySources will be called in any case when the context</span><br><span class="line">    // is refreshed; do it eagerly here to ensure servlet property sources are in place for</span><br><span class="line">    // use in any post-processing or initialization that occurs below prior to #refresh</span><br><span class="line">    ConfigurableEnvironment env = wac.getEnvironment();</span><br><span class="line">    if (env instanceof ConfigurableWebEnvironment) &#123;</span><br><span class="line">        ((ConfigurableWebEnvironment) env).initPropertySources(sc, null);</span><br><span class="line">    &#125;</span><br><span class="line">    //执行容器初始化器</span><br><span class="line">    customizeContext(sc, wac);</span><br><span class="line">    //刷新容器上下文</span><br><span class="line">    wac.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、MvcNamespaceHandler的init方法"><a href="#4、MvcNamespaceHandler的init方法" class="headerlink" title="4、MvcNamespaceHandler的init方法"></a>4、MvcNamespaceHandler的init方法</h4><p>自定义标签解析器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    registerBeanDefinitionParser(&quot;annotation-driven&quot;, new AnnotationDrivenBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;default-servlet-handler&quot;, new DefaultServletHandlerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;interceptors&quot;, new InterceptorsBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;resources&quot;, new ResourcesBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;view-controller&quot;, new ViewControllerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;redirect-view-controller&quot;, new ViewControllerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;status-controller&quot;, new ViewControllerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;view-resolvers&quot;, new ViewResolversBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;tiles-configurer&quot;, new TilesConfigurerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;freemarker-configurer&quot;, new FreeMarkerConfigurerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;velocity-configurer&quot;, new VelocityConfigurerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;groovy-configurer&quot;, new GroovyMarkupConfigurerBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、AnnotationDrivenBeanDefinitionParser的parse方法"><a href="#5、AnnotationDrivenBeanDefinitionParser的parse方法" class="headerlink" title="5、AnnotationDrivenBeanDefinitionParser的parse方法"></a>5、AnnotationDrivenBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    Object source = parserContext.extractSource(element);</span><br><span class="line">    </span><br><span class="line">    CompositeComponentDefinition compDefinition = new CompositeComponentDefinition(element.getTagName(), source);</span><br><span class="line">    parserContext.pushContainingComponent(compDefinition);</span><br><span class="line"></span><br><span class="line">    //处理&quot;content-negotiation-manager&quot;属性,默认注册ContentNegotiationManagerFactoryBean</span><br><span class="line">    //ContentNegotiationStrategy为request和mediatypes解析的策略类</span><br><span class="line">    RuntimeBeanReference contentNegotiationManager = getContentNegotiationManager(element, source, parserContext);</span><br><span class="line"></span><br><span class="line">    RootBeanDefinition handlerMappingDef = new RootBeanDefinition(RequestMappingHandlerMapping.class);</span><br><span class="line">    handlerMappingDef.setSource(source);</span><br><span class="line">    handlerMappingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //优先级设置为最高</span><br><span class="line">    handlerMappingDef.getPropertyValues().add(&quot;order&quot;, 0);</span><br><span class="line">    //添加contentNegotiationManager属性，处理MediaType </span><br><span class="line">    handlerMappingDef.getPropertyValues().add(&quot;contentNegotiationManager&quot;, contentNegotiationManager);</span><br><span class="line">    //注册RequestMappingHandlerMapping的bean</span><br><span class="line">    String methodMappingName = parserContext.getReaderContext().registerWithGeneratedName(handlerMappingDef);</span><br><span class="line">    //表示是否开启多变量映射</span><br><span class="line">    if (element.hasAttribute(&quot;enable-matrix-variables&quot;)) &#123;</span><br><span class="line">        Boolean enableMatrixVariables = Boolean.valueOf(element.getAttribute(&quot;enable-matrix-variables&quot;));</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;removeSemicolonContent&quot;, !enableMatrixVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(&quot;enableMatrixVariables&quot;)) &#123;</span><br><span class="line">        Boolean enableMatrixVariables = Boolean.valueOf(element.getAttribute(&quot;enableMatrixVariables&quot;));</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;removeSemicolonContent&quot;, !enableMatrixVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    //配置路径匹配解析器等属性</span><br><span class="line">    configurePathMatchingProperties(handlerMappingDef, element, parserContext);</span><br><span class="line"></span><br><span class="line">    //处理&quot;conversion-service&quot;属性，默认注册FormattingConversionServiceFactoryBean</span><br><span class="line">    //处理一些基本类的格式与转换，比如时间、数字等</span><br><span class="line">    RuntimeBeanReference conversionService = getConversionService(element, source, parserContext);</span><br><span class="line">    //处理&quot;validator&quot;属性,默认注册OptionalValidatorFactoryBean</span><br><span class="line">    //用于javabean的参数校验等</span><br><span class="line">    RuntimeBeanReference validator = getValidator(element, source, parserContext);</span><br><span class="line">    //处理&quot;message-codes-resolver&quot;属性，默认为null</span><br><span class="line">    RuntimeBeanReference messageCodesResolver = getMessageCodesResolver(element);</span><br><span class="line">    //注册ConfigurableWebBindingInitializer的bean，用于数据绑定</span><br><span class="line">    RootBeanDefinition bindingDef = new RootBeanDefinition(ConfigurableWebBindingInitializer.class);</span><br><span class="line">    bindingDef.setSource(source);</span><br><span class="line">    bindingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    bindingDef.getPropertyValues().add(&quot;conversionService&quot;, conversionService);</span><br><span class="line">    bindingDef.getPropertyValues().add(&quot;validator&quot;, validator);</span><br><span class="line">    bindingDef.getPropertyValues().add(&quot;messageCodesResolver&quot;, messageCodesResolver);</span><br><span class="line"></span><br><span class="line">    //处理&quot;message-converters&quot;子节点，消息转换器，可用于向前端发送数据再次自定义组装</span><br><span class="line">    //比如MappingJackson2HttpMessageConverter json转字符串</span><br><span class="line">    ManagedList&lt;?&gt; messageConverters = getMessageConverters(element, source, parserContext);</span><br><span class="line">    //处理&quot;argument-resolvers&quot;子节点,用于参数解析</span><br><span class="line">    ManagedList&lt;?&gt; argumentResolvers = getArgumentResolvers(element, parserContext);</span><br><span class="line">    //处理&quot;return-value-handlers&quot;子节点</span><br><span class="line">    ManagedList&lt;?&gt; returnValueHandlers = getReturnValueHandlers(element, parserContext);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;default-timeout&quot;属性，作为异步处理超时时间，默认null</span><br><span class="line">    String asyncTimeout = getAsyncTimeout(element);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;task-executor&quot;属性。异步任务线程池</span><br><span class="line">    RuntimeBeanReference asyncExecutor = getAsyncExecutor(element);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;callable-interceptors&quot;节点。异步处理callable类型拦截器，默认为空</span><br><span class="line">    ManagedList&lt;?&gt; callableInterceptors = getCallableInterceptors(element, source, parserContext);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;deferred-result-interceptors&quot;节点。拦截器，默认为空</span><br><span class="line">    ManagedList&lt;?&gt; deferredResultInterceptors = getDeferredResultInterceptors(element, source, parserContext);</span><br><span class="line">    //将上述的属性添加到RequestMappingHandlerAdapter中</span><br><span class="line">    RootBeanDefinition handlerAdapterDef = new RootBeanDefinition(RequestMappingHandlerAdapter.class);</span><br><span class="line">    handlerAdapterDef.setSource(source);</span><br><span class="line">    handlerAdapterDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;contentNegotiationManager&quot;, contentNegotiationManager);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;webBindingInitializer&quot;, bindingDef);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;messageConverters&quot;, messageConverters);</span><br><span class="line">    addResponseBodyAdvice(handlerAdapterDef);</span><br><span class="line">    //解析&quot;ignoreDefaultModelOnRedirect&quot;属性</span><br><span class="line">    if (element.hasAttribute(&quot;ignore-default-model-on-redirect&quot;)) &#123;</span><br><span class="line">        Boolean ignoreDefaultModel = Boolean.valueOf(element.getAttribute(&quot;ignore-default-model-on-redirect&quot;));</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;ignoreDefaultModelOnRedirect&quot;, ignoreDefaultModel);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(&quot;ignoreDefaultModelOnRedirect&quot;)) &#123;</span><br><span class="line">        // &quot;ignoreDefaultModelOnRedirect&quot; spelling is deprecated</span><br><span class="line">        Boolean ignoreDefaultModel = Boolean.valueOf(element.getAttribute(&quot;ignoreDefaultModelOnRedirect&quot;));</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;ignoreDefaultModelOnRedirect&quot;, ignoreDefaultModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (argumentResolvers != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;customArgumentResolvers&quot;, argumentResolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    if (returnValueHandlers != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;customReturnValueHandlers&quot;, returnValueHandlers);</span><br><span class="line">    &#125;</span><br><span class="line">    if (asyncTimeout != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;asyncRequestTimeout&quot;, asyncTimeout);</span><br><span class="line">    &#125;</span><br><span class="line">    if (asyncExecutor != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;taskExecutor&quot;, asyncExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;callableInterceptors&quot;, callableInterceptors);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;deferredResultInterceptors&quot;, deferredResultInterceptors);</span><br><span class="line">    //注册RequestMappingHandlerAdapter的bean</span><br><span class="line">    String handlerAdapterName = parserContext.getReaderContext().registerWithGeneratedName(handlerAdapterDef);</span><br><span class="line"></span><br><span class="line">    String uriCompContribName = MvcUriComponentsBuilder.MVC_URI_COMPONENTS_CONTRIBUTOR_BEAN_NAME;</span><br><span class="line">    RootBeanDefinition uriCompContribDef = new RootBeanDefinition(CompositeUriComponentsContributorFactoryBean.class);</span><br><span class="line">    uriCompContribDef.setSource(source);</span><br><span class="line">    uriCompContribDef.getPropertyValues().addPropertyValue(&quot;handlerAdapter&quot;, handlerAdapterDef);</span><br><span class="line">    uriCompContribDef.getPropertyValues().addPropertyValue(&quot;conversionService&quot;, conversionService);</span><br><span class="line">    parserContext.getReaderContext().getRegistry().registerBeanDefinition(uriCompContribName, uriCompContribDef);</span><br><span class="line"></span><br><span class="line">    //注册ConversionServiceExposingInterceptor的bean</span><br><span class="line">    RootBeanDefinition csInterceptorDef = new RootBeanDefinition(ConversionServiceExposingInterceptor.class);</span><br><span class="line">    csInterceptorDef.setSource(source);</span><br><span class="line">    csInterceptorDef.getConstructorArgumentValues().addIndexedArgumentValue(0, conversionService);</span><br><span class="line"></span><br><span class="line">    //注册MappedInterceptor的bean</span><br><span class="line">    RootBeanDefinition mappedCsInterceptorDef = new RootBeanDefinition(MappedInterceptor.class);</span><br><span class="line">    mappedCsInterceptorDef.setSource(source);</span><br><span class="line">    mappedCsInterceptorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    mappedCsInterceptorDef.getConstructorArgumentValues().addIndexedArgumentValue(0, (Object) null);</span><br><span class="line">    mappedCsInterceptorDef.getConstructorArgumentValues().addIndexedArgumentValue(1, csInterceptorDef);</span><br><span class="line">    String mappedInterceptorName = parserContext.getReaderContext().registerWithGeneratedName(mappedCsInterceptorDef);</span><br><span class="line"></span><br><span class="line">    //注册ExceptionHandlerExceptionResolver的bean，处理@ExceptionHandler注解</span><br><span class="line">    RootBeanDefinition exceptionHandlerExceptionResolver = new RootBeanDefinition(ExceptionHandlerExceptionResolver.class);</span><br><span class="line">    exceptionHandlerExceptionResolver.setSource(source);</span><br><span class="line">    exceptionHandlerExceptionResolver.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    exceptionHandlerExceptionResolver.getPropertyValues().add(&quot;contentNegotiationManager&quot;, contentNegotiationManager);</span><br><span class="line">    exceptionHandlerExceptionResolver.getPropertyValues().add(&quot;messageConverters&quot;, messageConverters);</span><br><span class="line">    exceptionHandlerExceptionResolver.getPropertyValues().add(&quot;order&quot;, 0);</span><br><span class="line">    addResponseBodyAdvice(exceptionHandlerExceptionResolver);</span><br><span class="line">    String methodExceptionResolverName =</span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(exceptionHandlerExceptionResolver);</span><br><span class="line"></span><br><span class="line">    //注册ResponseStatusExceptionResolver的bean，处理异常类上的@ResponseStatus注解</span><br><span class="line">    RootBeanDefinition responseStatusExceptionResolver = new RootBeanDefinition(ResponseStatusExceptionResolver.class);</span><br><span class="line">    responseStatusExceptionResolver.setSource(source);</span><br><span class="line">    responseStatusExceptionResolver.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    responseStatusExceptionResolver.getPropertyValues().add(&quot;order&quot;, 1);</span><br><span class="line">    String responseStatusExceptionResolverName =</span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(responseStatusExceptionResolver);</span><br><span class="line"></span><br><span class="line">    //注册DefaultHandlerExceptionResolver的bean，异常处理器</span><br><span class="line">    RootBeanDefinition defaultExceptionResolver = new RootBeanDefinition(DefaultHandlerExceptionResolver.class);</span><br><span class="line">    defaultExceptionResolver.setSource(source);</span><br><span class="line">    defaultExceptionResolver.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    defaultExceptionResolver.getPropertyValues().add(&quot;order&quot;, 2);</span><br><span class="line">    String defaultExceptionResolverName =</span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(defaultExceptionResolver);</span><br><span class="line">    //注册组件并广播</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(handlerMappingDef, methodMappingName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(handlerAdapterDef, handlerAdapterName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(uriCompContribDef, uriCompContribName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(exceptionHandlerExceptionResolver, methodExceptionResolverName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(responseStatusExceptionResolver, responseStatusExceptionResolverName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(defaultExceptionResolver, defaultExceptionResolverName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(mappedCsInterceptorDef, mappedInterceptorName));</span><br><span class="line"></span><br><span class="line">    // Ensure BeanNameUrlHandlerMapping (SPR-8289) and default HandlerAdapters are not &quot;turned off&quot;</span><br><span class="line">    //注册BeanNameUrlHandlerMapping的bean</span><br><span class="line">    MvcNamespaceUtils.registerDefaultComponents(parserContext, source);</span><br><span class="line"></span><br><span class="line">    parserContext.popAndRegisterContainingComponent();</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"><a href="#6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法" class="headerlink" title="6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"></a>6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private void configurePathMatchingProperties(RootBeanDefinition handlerMappingDef,</span><br><span class="line">                                             Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //获取&quot;mvc:annotation-driven&quot;下子节点&quot;mvc:path-matching&quot;                                           </span><br><span class="line">    Element pathMatchingElement = DomUtils.getChildElementByTagName(element, &quot;path-matching&quot;);</span><br><span class="line">    if (pathMatchingElement != null) &#123;</span><br><span class="line">        //是否采用suffix-pattern，即.*,比如/user也匹配/user.*。默认为true</span><br><span class="line">        Object source = parserContext.extractSource(element);</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;suffix-pattern&quot;)) &#123;</span><br><span class="line">            Boolean useSuffixPatternMatch = Boolean.valueOf(pathMatchingElement.getAttribute(&quot;suffix-pattern&quot;));</span><br><span class="line">            handlerMappingDef.getPropertyValues().add(&quot;useSuffixPatternMatch&quot;, useSuffixPatternMatch);</span><br><span class="line">        &#125;</span><br><span class="line">        //是否采用分隔符，特指/，比如/user也匹配/user/。默认为true</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;trailing-slash&quot;)) &#123;</span><br><span class="line">            Boolean useTrailingSlashMatch = Boolean.valueOf(pathMatchingElement.getAttribute(&quot;trailing-slash&quot;));</span><br><span class="line">            handlerMappingDef.getPropertyValues().add(&quot;useTrailingSlashMatch&quot;, useTrailingSlashMatch);</span><br><span class="line">        &#125;</span><br><span class="line">        //是否采用contentNegotiationManager中的格式，比如*.json/*.xml。默认为false</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;registered-suffixes-only&quot;)) &#123;</span><br><span class="line">            Boolean useRegisteredSuffixPatternMatch = Boolean.valueOf(pathMatchingElement.getAttribute(&quot;registered-suffixes-only&quot;));</span><br><span class="line">            handlerMappingDef.getPropertyValues().add(&quot;useRegisteredSuffixPatternMatch&quot;, useRegisteredSuffixPatternMatch);</span><br><span class="line">        &#125;</span><br><span class="line">        RuntimeBeanReference pathHelperRef = null;</span><br><span class="line">        //路径解析帮助类，可指定，默认为UrlPathHelper</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;path-helper&quot;)) &#123;</span><br><span class="line">            pathHelperRef = new RuntimeBeanReference(pathMatchingElement.getAttribute(&quot;path-helper&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        pathHelperRef = MvcNamespaceUtils.registerUrlPathHelper(pathHelperRef, parserContext, source);</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;urlPathHelper&quot;, pathHelperRef);</span><br><span class="line"></span><br><span class="line">        RuntimeBeanReference pathMatcherRef = null;</span><br><span class="line">        //路径解析器，默认为AntPathMatcher解析器</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;path-matcher&quot;)) &#123;</span><br><span class="line">            pathMatcherRef = new RuntimeBeanReference(pathMatchingElement.getAttribute(&quot;path-matcher&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        pathMatcherRef = MvcNamespaceUtils.registerPathMatcher(pathMatcherRef, parserContext, source);</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;pathMatcher&quot;, pathMatcherRef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"><a href="#7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法" class="headerlink" title="7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"></a>7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">private ManagedList&lt;?&gt; getMessageConverters(Element element, Object source, ParserContext parserContext) &#123;</span><br><span class="line">    Element convertersElement = DomUtils.getChildElementByTagName(element, &quot;message-converters&quot;);</span><br><span class="line">    ManagedList&lt;? super Object&gt; messageConverters = new ManagedList&lt;Object&gt;();</span><br><span class="line">    if (convertersElement != null) &#123;</span><br><span class="line">        messageConverters.setSource(source);</span><br><span class="line">        for (Element beanElement : DomUtils.getChildElementsByTagName(convertersElement, &quot;bean&quot;, &quot;ref&quot;)) &#123;</span><br><span class="line">            Object object = parserContext.getDelegate().parsePropertySubElement(beanElement, null);</span><br><span class="line">            messageConverters.add(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (convertersElement == null || Boolean.valueOf(convertersElement.getAttribute(&quot;register-defaults&quot;))) &#123;</span><br><span class="line">        messageConverters.setSource(source);</span><br><span class="line">        //读写二进制数据</span><br><span class="line">        messageConverters.add(createConverterDefinition(ByteArrayHttpMessageConverter.class, source));</span><br><span class="line"></span><br><span class="line">        //转换器,将请求信息转换为字符串</span><br><span class="line">        RootBeanDefinition stringConverterDef = createConverterDefinition(StringHttpMessageConverter.class, source);</span><br><span class="line">        stringConverterDef.getPropertyValues().add(&quot;writeAcceptCharset&quot;, false);</span><br><span class="line">        messageConverters.add(stringConverterDef);</span><br><span class="line">        //</span><br><span class="line">        messageConverters.add(createConverterDefinition(ResourceHttpMessageConverter.class, source));</span><br><span class="line">        messageConverters.add(createConverterDefinition(SourceHttpMessageConverter.class, source));</span><br><span class="line">        messageConverters.add(createConverterDefinition(AllEncompassingFormHttpMessageConverter.class, source));</span><br><span class="line"></span><br><span class="line">        if (romePresent) &#123;</span><br><span class="line">            messageConverters.add(createConverterDefinition(AtomFeedHttpMessageConverter.class, source));</span><br><span class="line">            messageConverters.add(createConverterDefinition(RssChannelHttpMessageConverter.class, source));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (jackson2XmlPresent) &#123;</span><br><span class="line">            RootBeanDefinition jacksonConverterDef = createConverterDefinition(MappingJackson2XmlHttpMessageConverter.class, source);</span><br><span class="line">            GenericBeanDefinition jacksonFactoryDef = createObjectMapperFactoryDefinition(source);</span><br><span class="line">            jacksonFactoryDef.getPropertyValues().add(&quot;createXmlMapper&quot;, true);</span><br><span class="line">            jacksonConverterDef.getConstructorArgumentValues().addIndexedArgumentValue(0, jacksonFactoryDef);</span><br><span class="line">            messageConverters.add(jacksonConverterDef);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (jaxb2Present) &#123;</span><br><span class="line">            messageConverters.add(createConverterDefinition(Jaxb2RootElementHttpMessageConverter.class, source));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (jackson2Present) &#123;</span><br><span class="line">            RootBeanDefinition jacksonConverterDef = createConverterDefinition(MappingJackson2HttpMessageConverter.class, source);</span><br><span class="line">            GenericBeanDefinition jacksonFactoryDef = createObjectMapperFactoryDefinition(source);</span><br><span class="line">            jacksonConverterDef.getConstructorArgumentValues().addIndexedArgumentValue(0, jacksonFactoryDef);</span><br><span class="line">            messageConverters.add(jacksonConverterDef);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (gsonPresent) &#123;</span><br><span class="line">            messageConverters.add(createConverterDefinition(GsonHttpMessageConverter.class, source));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return messageConverters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、初始化DispatcherServlet"><a href="#二、初始化DispatcherServlet" class="headerlink" title="二、初始化DispatcherServlet"></a>二、初始化DispatcherServlet</h3><h4 id="1、HttpServletBean的init方法"><a href="#1、HttpServletBean的init方法" class="headerlink" title="1、HttpServletBean的init方法"></a>1、HttpServletBean的init方法</h4><p>Servlet被装载后，Servlet容器创建一个Servlet实例并且调用Servlet的init()方法进行初始化。DispatcherServlet父类HttpServletBean。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void init() throws ServletException &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Initializing servlet &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Set bean properties from init parameters.</span><br><span class="line">    try &#123;</span><br><span class="line">        //获得web.xml中的contextConfigLocation配置属性，就是spring MVC的配置文件</span><br><span class="line">        PropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);</span><br><span class="line">        BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);</span><br><span class="line">        //获取服务器的各种信息</span><br><span class="line">        ResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());</span><br><span class="line">        bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));</span><br><span class="line">        //待子类覆盖</span><br><span class="line">        initBeanWrapper(bw);</span><br><span class="line">        //将配置的初始化值设置到DispatcherServlet中</span><br><span class="line">        bw.setPropertyValues(pvs, true);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeansException ex) &#123;</span><br><span class="line">        logger.error(&quot;Failed to set bean properties on servlet &apos;&quot; + getServletName() + &quot;&apos;&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Let subclasses do whatever initialization they like.</span><br><span class="line">    //初始化ioc容器</span><br><span class="line">    initServletBean();</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Servlet &apos;&quot; + getServletName() + &quot;&apos; configured successfully&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、FrameworkServlet的initServletBean方法"><a href="#2、FrameworkServlet的initServletBean方法" class="headerlink" title="2、FrameworkServlet的initServletBean方法"></a>2、FrameworkServlet的initServletBean方法</h4><p>DispatcherServlet的父类FrameworkServlet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void initServletBean() throws ServletException &#123;</span><br><span class="line">    getServletContext().log(&quot;Initializing Spring FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">    if (this.logger.isInfoEnabled()) &#123;</span><br><span class="line">        this.logger.info(&quot;FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;: initialization started&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //初始化IOC容器</span><br><span class="line">        this.webApplicationContext = initWebApplicationContext();</span><br><span class="line">        //带子类实现</span><br><span class="line">        initFrameworkServlet();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ServletException ex) &#123;</span><br><span class="line">        this.logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (RuntimeException ex) &#123;</span><br><span class="line">        this.logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.logger.isInfoEnabled()) &#123;</span><br><span class="line">        long elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">        this.logger.info(&quot;FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;: initialization completed in &quot; +</span><br><span class="line">                elapsedTime + &quot; ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、FrameworkServlet的initWebApplicationContext方法"><a href="#3、FrameworkServlet的initWebApplicationContext方法" class="headerlink" title="3、FrameworkServlet的initWebApplicationContext方法"></a>3、FrameworkServlet的initWebApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">protected WebApplicationContext initWebApplicationContext() &#123;</span><br><span class="line">    //获取由ContextLoaderListener初始化并注册在ServletContext中的根IOC容器</span><br><span class="line">    WebApplicationContext rootContext =</span><br><span class="line">            WebApplicationContextUtils.getWebApplicationContext(getServletContext());</span><br><span class="line">    WebApplicationContext wac = null;</span><br><span class="line"></span><br><span class="line">    if (this.webApplicationContext != null) &#123;</span><br><span class="line">        // A context instance was injected at construction time -&gt; use it</span><br><span class="line">        wac = this.webApplicationContext;</span><br><span class="line">        if (wac instanceof ConfigurableWebApplicationContext) &#123;</span><br><span class="line">            ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) wac;</span><br><span class="line">            if (!cwac.isActive()) &#123;</span><br><span class="line">                // The context has not yet been refreshed -&gt; provide services such as</span><br><span class="line">                // setting the parent context, setting the application context id, etc</span><br><span class="line">                if (cwac.getParent() == null) &#123;</span><br><span class="line">                    // The context instance was injected without an explicit parent -&gt; set</span><br><span class="line">                    // the root application context (if any; may be null) as the parent</span><br><span class="line">                    cwac.setParent(rootContext);</span><br><span class="line">                &#125;</span><br><span class="line">                configureAndRefreshWebApplicationContext(cwac);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (wac == null) &#123;</span><br><span class="line">        // No context instance was injected at construction time -&gt; see if one</span><br><span class="line">        // has been registered in the servlet context. If one exists, it is assumed</span><br><span class="line">        // that the parent context (if any) has already been set and that the</span><br><span class="line">        // user has performed any initialization such as setting the context id</span><br><span class="line">        //如果为空，说明该Servlet不是由编程式注册到容器中的，在ServletContext中查找上下文，查找得到  </span><br><span class="line">        //说明上下文已经以别的方式初始化并注册在contextAttribute下，直接使用 </span><br><span class="line">        wac = findWebApplicationContext();</span><br><span class="line">    &#125;</span><br><span class="line">    if (wac == null) &#123;</span><br><span class="line">        // No context instance is defined for this servlet -&gt; create a local one</span><br><span class="line">        //创建ioc容器</span><br><span class="line">        wac = createWebApplicationContext(rootContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.refreshEventReceived) &#123;</span><br><span class="line">        // Either the context is not a ConfigurableApplicationContext with refresh</span><br><span class="line">        // support or the context injected at construction time had already been</span><br><span class="line">        // refreshed -&gt; trigger initial onRefresh manually here.</span><br><span class="line">        //初始化相关属性</span><br><span class="line">        onRefresh(wac);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.publishContext) &#123;</span><br><span class="line">        // Publish the context as a servlet context attribute.</span><br><span class="line">        //IOC容器设置为ServletContext的一个属性</span><br><span class="line">        String attrName = getServletContextAttributeName();</span><br><span class="line">        getServletContext().setAttribute(attrName, wac);</span><br><span class="line">        if (this.logger.isDebugEnabled()) &#123;</span><br><span class="line">            this.logger.debug(&quot;Published WebApplicationContext of servlet &apos;&quot; + getServletName() +</span><br><span class="line">                    &quot;&apos; as ServletContext attribute with name [&quot; + attrName + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return wac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DispatcherServlet的onRefresh方法"><a href="#4、DispatcherServlet的onRefresh方法" class="headerlink" title="4、DispatcherServlet的onRefresh方法"></a>4、DispatcherServlet的onRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onRefresh(ApplicationContext context) &#123;</span><br><span class="line">    initStrategies(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DispatcherServlet的initStrategies方法"><a href="#5、DispatcherServlet的initStrategies方法" class="headerlink" title="5、DispatcherServlet的initStrategies方法"></a>5、DispatcherServlet的initStrategies方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void initStrategies(ApplicationContext context) &#123;</span><br><span class="line">    //文件上传解析器,配置文件中CommonsMultipartResolver</span><br><span class="line">    initMultipartResolver(context);</span><br><span class="line">    //本地化解析器,默认AcceptHeaderLocaleResolver</span><br><span class="line">    initLocaleResolver(context);</span><br><span class="line">    //主题解析器,默认FixedThemeResolver</span><br><span class="line">    initThemeResolver(context);</span><br><span class="line">    //HandlerMapping，将请求映射到处理器 </span><br><span class="line">    initHandlerMappings(context);</span><br><span class="line">    //HandlerAdapter支持多种类型的处理器 </span><br><span class="line">    initHandlerAdapters(context);</span><br><span class="line">    //HandlerExceptionResolver来解析执行过程中的遇到异常</span><br><span class="line">    initHandlerExceptionResolvers(context);</span><br><span class="line">    //解析请求到视图名,默认DefaultRequestToViewNameTranslator  </span><br><span class="line">    initRequestToViewNameTranslator(context);</span><br><span class="line">    //viewResolver解析逻辑视图到具体视图,默认InternalResourceViewResolver</span><br><span class="line">    initViewResolvers(context);</span><br><span class="line">    //flash映射管理器,默认SessionFlashMapManager</span><br><span class="line">    initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从配置文件DispatcherServlet.properties中获取默认的处理器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.servlet.LocaleResolver=org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ThemeResolver=org.springframework.web.servlet.theme.FixedThemeResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerMapping=org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping,\</span><br><span class="line">    org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerAdapter=org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter,\</span><br><span class="line">    org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter,\</span><br><span class="line">    org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerExceptionResolver=org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerExceptionResolver,\</span><br><span class="line">    org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver,\</span><br><span class="line">    org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.RequestToViewNameTranslator=org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ViewResolver=org.springframework.web.servlet.view.InternalResourceViewResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.FlashMapManager=org.springframework.web.servlet.support.SessionFlashMapManager</span><br></pre></td></tr></table></figure></p><h4 id="6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法"><a href="#6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法" class="headerlink" title="6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法"></a>6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法</h4><p>ContentNegotiationManagerFactoryBean实现了InitializingBean接口，加载bean会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    List&lt;ContentNegotiationStrategy&gt; strategies = new ArrayList&lt;ContentNegotiationStrategy&gt;();</span><br><span class="line"></span><br><span class="line">    if (this.favorPathExtension) &#123;</span><br><span class="line">        PathExtensionContentNegotiationStrategy strategy;</span><br><span class="line">        if (this.servletContext != null) &#123;</span><br><span class="line">            //使用ServletContext.getMIMEType来匹配MediaType</span><br><span class="line">            strategy = new ServletPathExtensionContentNegotiationStrategy(this.servletContext, this.mediaTypes);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //根据请求路径的后缀名来判断用哪种MediaType</span><br><span class="line">            //常见的xx.html，xx.json,里的.html,.json都是已知的路径扩展名</span><br><span class="line">            strategy = new PathExtensionContentNegotiationStrategy(this.mediaTypes);</span><br><span class="line">        &#125;</span><br><span class="line">        //默认忽略未知的路径扩展名</span><br><span class="line">        strategy.setIgnoreUnknownExtensions(this.ignoreUnknownPathExtensions);</span><br><span class="line">        if (this.useJaf != null) &#123;</span><br><span class="line">            strategy.setUseJaf(this.useJaf);</span><br><span class="line">        &#125;</span><br><span class="line">        strategies.add(strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.favorParameter) &#123;</span><br><span class="line">        //根据request中的参数来判断mediaType的类型</span><br><span class="line">        //示例http://xxx.xxx.com/xx?format=json</span><br><span class="line">        ParameterContentNegotiationStrategy strategy = new ParameterContentNegotiationStrategy(this.mediaTypes);</span><br><span class="line">        //默认的参数名为format</span><br><span class="line">        strategy.setParameterName(this.parameterName);</span><br><span class="line">        strategies.add(strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.ignoreAcceptHeader) &#123;</span><br><span class="line">        //从request中取出Accept对应的字段，将其解析包装成MeidaType</span><br><span class="line">        strategies.add(new HeaderContentNegotiationStrategy());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(this.defaultNegotiationStrategy != null) &#123;</span><br><span class="line">        strategies.add(defaultNegotiationStrategy);</span><br><span class="line">    &#125;</span><br><span class="line">    this.contentNegotiationManager = new ContentNegotiationManager(strategies);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、接（二、5）ApplicationObjectSupport的setApplicationContext方法"><a href="#7、接（二、5）ApplicationObjectSupport的setApplicationContext方法" class="headerlink" title="7、接（二、5）ApplicationObjectSupport的setApplicationContext方法"></a>7、接（二、5）ApplicationObjectSupport的setApplicationContext方法</h4><p>RequestMappingHandlerMapping的父类，实现了ApplicationContextAware,加载bean时会执行setApplicationContext方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void setApplicationContext(ApplicationContext context) throws BeansException &#123;</span><br><span class="line">    if (context == null &amp;&amp; !isContextRequired()) &#123;</span><br><span class="line">        // Reset internal context state.</span><br><span class="line">        this.applicationContext = null;</span><br><span class="line">        this.messageSourceAccessor = null;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (this.applicationContext == null) &#123;</span><br><span class="line">        // Initialize with passed-in context.</span><br><span class="line">        if (!requiredContextClass().isInstance(context)) &#123;</span><br><span class="line">            throw new ApplicationContextException(</span><br><span class="line">                    &quot;Invalid application context: needs to be of type [&quot; + requiredContextClass().getName() + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        this.applicationContext = context;</span><br><span class="line">        this.messageSourceAccessor = new MessageSourceAccessor(context);</span><br><span class="line">        //初始化</span><br><span class="line">        initApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Ignore reinitialization if same context passed in.</span><br><span class="line">        if (this.applicationContext != context) &#123;</span><br><span class="line">            throw new ApplicationContextException(</span><br><span class="line">                    &quot;Cannot reinitialize with different application context: current one is [&quot; +</span><br><span class="line">                    this.applicationContext + &quot;], passed-in one is [&quot; + context + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、AbstractHandlerMapping的initApplicationContext方法"><a href="#8、AbstractHandlerMapping的initApplicationContext方法" class="headerlink" title="8、AbstractHandlerMapping的initApplicationContext方法"></a>8、AbstractHandlerMapping的initApplicationContext方法</h4><p>RequestMappingHandlerMapping的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initApplicationContext() throws BeansException &#123;</span><br><span class="line">    //待子类实现</span><br><span class="line">    extendInterceptors(this.interceptors);</span><br><span class="line">    //获取ioc容器中注册的MappedInterceptor拦截器，加入mappedInterceptors集合</span><br><span class="line">    detectMappedInterceptors(this.mappedInterceptors);</span><br><span class="line">    //分类interceptors并加入集合</span><br><span class="line">    initInterceptors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="9、RequestMappingHandlerMapping的afterPropertiesSet方法"><a href="#9、RequestMappingHandlerMapping的afterPropertiesSet方法" class="headerlink" title="9、RequestMappingHandlerMapping的afterPropertiesSet方法"></a>9、RequestMappingHandlerMapping的afterPropertiesSet方法</h4><p>RequestMappingHandlerMapping实现了InitializingBean接口，加载bean会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    if (this.useRegisteredSuffixPatternMatch) &#123;</span><br><span class="line">        //默认为PathExtensionContentNegotiationStrategy</span><br><span class="line">        this.fileExtensions.addAll(this.contentNegotiationManager.getAllFileExtensions());</span><br><span class="line">    &#125;</span><br><span class="line">    super.afterPropertiesSet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="10、AbstractHandlerMethodMapping的afterPropertiesSet方法"><a href="#10、AbstractHandlerMethodMapping的afterPropertiesSet方法" class="headerlink" title="10、AbstractHandlerMethodMapping的afterPropertiesSet方法"></a>10、AbstractHandlerMethodMapping的afterPropertiesSet方法</h4><p>RequestMappingHandlerMapping的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    initHandlerMethods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="11、AbstractHandlerMethodMapping的initHandlerMethods方法"><a href="#11、AbstractHandlerMethodMapping的initHandlerMethods方法" class="headerlink" title="11、AbstractHandlerMethodMapping的initHandlerMethods方法"></a>11、AbstractHandlerMethodMapping的initHandlerMethods方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void initHandlerMethods() &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Looking for request mappings in application context: &quot; + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    //获取容器中注册的所有的beanName</span><br><span class="line">    String[] beanNames = (this.detectHandlerMethodsInAncestorContexts ?</span><br><span class="line">            BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :</span><br><span class="line">            getApplicationContext().getBeanNamesForType(Object.class));</span><br><span class="line"></span><br><span class="line">    for (String beanName : beanNames) &#123;</span><br><span class="line">        //该类不是scoped代理且有@Controller或@RequestMapping注解</span><br><span class="line">        if (!beanName.startsWith(SCOPED_TARGET_NAME_PREFIX) &amp;&amp;</span><br><span class="line">                isHandler(getApplicationContext().getType(beanName)))&#123;</span><br><span class="line">            //查找并注册类中注解了@RequestMapping的方法</span><br><span class="line">            detectHandlerMethods(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //待子类实现</span><br><span class="line">    handlerMethodsInitialized(getHandlerMethods());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、AbstractHandlerMethodMapping的initHandlerMethods方法"><a href="#12、AbstractHandlerMethodMapping的initHandlerMethods方法" class="headerlink" title="12、AbstractHandlerMethodMapping的initHandlerMethods方法"></a>12、AbstractHandlerMethodMapping的initHandlerMethods方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">protected void detectHandlerMethods(final Object handler) &#123;</span><br><span class="line">    //获取类</span><br><span class="line">    Class&lt;?&gt; handlerType =</span><br><span class="line">            (handler instanceof String ? getApplicationContext().getType((String) handler) : handler.getClass());</span><br><span class="line"></span><br><span class="line">    // Avoid repeated calls to getMappingForMethod which would rebuild RequestMappingInfo instances</span><br><span class="line">    //该集合key可以相等，但不能为同一对象</span><br><span class="line">    final Map&lt;Method, T&gt; mappings = new IdentityHashMap&lt;Method, T&gt;();</span><br><span class="line"></span><br><span class="line">    //如果是CGLIB代理类，获取父类</span><br><span class="line">    final Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line">    //查找类中注解了@RequestMapping的方法</span><br><span class="line">    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, new MethodFilter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean matches(Method method) &#123;</span><br><span class="line">            //获取方法的@RequestMapping相关信息</span><br><span class="line">            T mapping = getMappingForMethod(method, userType);</span><br><span class="line">            if (mapping != null) &#123;</span><br><span class="line">                //加入集合</span><br><span class="line">                mappings.put(method, mapping);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    for (Method method : methods) &#123;</span><br><span class="line">        //</span><br><span class="line">        registerHandlerMethod(handler, method, mappings.get(method));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、AbstractHandlerMethodMapping的initHandlerMethods方法"><a href="#13、AbstractHandlerMethodMapping的initHandlerMethods方法" class="headerlink" title="13、AbstractHandlerMethodMapping的initHandlerMethods方法"></a>13、AbstractHandlerMethodMapping的initHandlerMethods方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">protected void detectHandlerMethods(final Object handler) &#123;</span><br><span class="line">    //获取类</span><br><span class="line">    Class&lt;?&gt; handlerType =</span><br><span class="line">            (handler instanceof String ? getApplicationContext().getType((String) handler) : handler.getClass());</span><br><span class="line"></span><br><span class="line">    // Avoid repeated calls to getMappingForMethod which would rebuild RequestMappingInfo instances</span><br><span class="line">    //该集合key可以相等，但不能为同一对象</span><br><span class="line">    final Map&lt;Method, T&gt; mappings = new IdentityHashMap&lt;Method, T&gt;();</span><br><span class="line"></span><br><span class="line">    //如果是CGLIB代理类，获取父类</span><br><span class="line">    final Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line">    //查找类及其接口中注解了@RequestMapping的方法</span><br><span class="line">    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, new MethodFilter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean matches(Method method) &#123;</span><br><span class="line">            //获取方法的@RequestMapping相关信息</span><br><span class="line">            T mapping = getMappingForMethod(method, userType);</span><br><span class="line">            if (mapping != null) &#123;</span><br><span class="line">                //加入集合</span><br><span class="line">                mappings.put(method, mapping);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    for (Method method : methods) &#123;</span><br><span class="line">        //注册方法及路径</span><br><span class="line">        registerHandlerMethod(handler, method, mappings.get(method));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、AbstractHandlerMethodMapping的registerHandlerMethod方法"><a href="#14、AbstractHandlerMethodMapping的registerHandlerMethod方法" class="headerlink" title="14、AbstractHandlerMethodMapping的registerHandlerMethod方法"></a>14、AbstractHandlerMethodMapping的registerHandlerMethod方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected void registerHandlerMethod(Object handler, Method method, T mapping) &#123;</span><br><span class="line">    //该对象存放处理该路径的bean及方法</span><br><span class="line">    HandlerMethod newHandlerMethod = createHandlerMethod(handler, method);</span><br><span class="line">    HandlerMethod oldHandlerMethod = this.handlerMethods.get(mapping);</span><br><span class="line">    //已注册</span><br><span class="line">    if (oldHandlerMethod != null &amp;&amp; !oldHandlerMethod.equals(newHandlerMethod)) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Ambiguous mapping found. Cannot map &apos;&quot; + newHandlerMethod.getBean() +</span><br><span class="line">                &quot;&apos; bean method \n&quot; + newHandlerMethod + &quot;\nto &quot; + mapping + &quot;: There is already &apos;&quot; +</span><br><span class="line">                oldHandlerMethod.getBean() + &quot;&apos; bean method\n&quot; + oldHandlerMethod + &quot; mapped.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //注册注解信息与方法映射</span><br><span class="line">    this.handlerMethods.put(mapping, newHandlerMethod);</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Mapped \&quot;&quot; + mapping + &quot;\&quot; onto &quot; + newHandlerMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取注解的路径</span><br><span class="line">    Set&lt;String&gt; patterns = getMappingPathPatterns(mapping);</span><br><span class="line">    for (String pattern : patterns) &#123;</span><br><span class="line">        //路径不是表达式</span><br><span class="line">        if (!getPathMatcher().isPattern(pattern)) &#123;</span><br><span class="line">            //添加路径与注解映射</span><br><span class="line">            this.urlMap.add(pattern, mapping);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建方法明与方法映射</span><br><span class="line">    if (this.namingStrategy != null) &#123;</span><br><span class="line">        String name = this.namingStrategy.getName(newHandlerMethod, mapping);</span><br><span class="line">        updateNameMap(name, newHandlerMethod);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法"><a href="#15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法" class="headerlink" title="15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法"></a>15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法</h4><p>RequestMappingHandlerAdapter实现了InitializingBean接口,加载bean时会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    // Do this first, it may add ResponseBody advice beans</span><br><span class="line">    //处理@ControllerAdvice注解的类</span><br><span class="line">    initControllerAdviceCache();</span><br><span class="line">    //添加默认的参数解析器</span><br><span class="line">    if (this.argumentResolvers == null) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">        this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    //添加默认的initbinder方法参数解析器</span><br><span class="line">    if (this.initBinderArgumentResolvers == null) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();</span><br><span class="line">        this.initBinderArgumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    //添加默认返回值解析器</span><br><span class="line">    if (this.returnValueHandlers == null) &#123;</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">        this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="16、RequestMappingHandlerAdapter的initControllerAdviceCache方法"><a href="#16、RequestMappingHandlerAdapter的initControllerAdviceCache方法" class="headerlink" title="16、RequestMappingHandlerAdapter的initControllerAdviceCache方法"></a>16、RequestMappingHandlerAdapter的initControllerAdviceCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private void initControllerAdviceCache() &#123;</span><br><span class="line">    if (getApplicationContext() == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Looking for @ControllerAdvice: &quot; + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    //查找容器中@ControllerAdvice注解的bean</span><br><span class="line">    List&lt;ControllerAdviceBean&gt; beans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">    OrderComparator.sort(beans);</span><br><span class="line"></span><br><span class="line">    List&lt;Object&gt; responseBodyAdviceBeans = new ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">    for (ControllerAdviceBean bean : beans) &#123;</span><br><span class="line">        //查找类中注解了@ModelAttribut的方法，不能同时注解@RequestMapping</span><br><span class="line">        Set&lt;Method&gt; attrMethods = HandlerMethodSelector.selectMethods(bean.getBeanType(), MODEL_ATTRIBUTE_METHODS);</span><br><span class="line">        if (!attrMethods.isEmpty()) &#123;</span><br><span class="line">            //加入缓存</span><br><span class="line">            this.modelAttributeAdviceCache.put(bean, attrMethods);</span><br><span class="line">            logger.info(&quot;Detected @ModelAttribute methods in &quot; + bean);</span><br><span class="line">        &#125;</span><br><span class="line">        //查找类中注解了@InitBinder的方法</span><br><span class="line">        Set&lt;Method&gt; binderMethods = HandlerMethodSelector.selectMethods(bean.getBeanType(), INIT_BINDER_METHODS);</span><br><span class="line">        if (!binderMethods.isEmpty()) &#123;</span><br><span class="line">            //加入缓存</span><br><span class="line">            this.initBinderAdviceCache.put(bean, binderMethods);</span><br><span class="line">            logger.info(&quot;Detected @InitBinder methods in &quot; + bean);</span><br><span class="line">        &#125;</span><br><span class="line">        //查找类中实现了ResponseBodyAdvice接口的</span><br><span class="line">        if (ResponseBodyAdvice.class.isAssignableFrom(bean.getBeanType())) &#123;</span><br><span class="line">            //加入缓存</span><br><span class="line">            responseBodyAdviceBeans.add(bean);</span><br><span class="line">            logger.info(&quot;Detected ResponseBodyAdvice bean in &quot; + bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!responseBodyAdviceBeans.isEmpty()) &#123;</span><br><span class="line">        this.responseBodyAdvice.addAll(0, responseBodyAdviceBeans);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法"><a href="#17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法" class="headerlink" title="17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法"></a>17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法</h4><p>ExceptionHandlerExceptionResolver实现了InitializingBean接口,加载bean时会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    // Do this first, it may add ResponseBodyAdvice beans</span><br><span class="line">    //处理@ControllerAdvice注解的类</span><br><span class="line">    initExceptionHandlerAdviceCache();</span><br><span class="line"></span><br><span class="line">    if (this.argumentResolvers == null) &#123;</span><br><span class="line">        //获取默认的参数解析器</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">        this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    if (this.returnValueHandlers == null) &#123;</span><br><span class="line">        //获取默认的返回值解析器</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">        this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法"><a href="#18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法" class="headerlink" title="18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法"></a>18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void initExceptionHandlerAdviceCache() &#123;</span><br><span class="line">    if (getApplicationContext() == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Looking for exception mappings: &quot; + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    //查找容器中@ControllerAdvice注解的bean</span><br><span class="line">    List&lt;ControllerAdviceBean&gt; adviceBeans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">    OrderComparator.sort(adviceBeans);</span><br><span class="line"></span><br><span class="line">    for (ControllerAdviceBean adviceBean : adviceBeans) &#123;</span><br><span class="line">        //获取bean中注解了@ExceptionHandler的方法，并建立该方法处理的异常类和该方法的映射</span><br><span class="line">        ExceptionHandlerMethodResolver resolver = new ExceptionHandlerMethodResolver(adviceBean.getBeanType());</span><br><span class="line">        if (resolver.hasExceptionMappings()) &#123;</span><br><span class="line">            this.exceptionHandlerAdviceCache.put(adviceBean, resolver);</span><br><span class="line">            logger.info(&quot;Detected @ExceptionHandler methods in &quot; + adviceBean);</span><br><span class="line">        &#125;</span><br><span class="line">        //查找类中实现了ResponseBodyAdvice接口的</span><br><span class="line">        if (ResponseBodyAdvice.class.isAssignableFrom(adviceBean.getBeanType())) &#123;</span><br><span class="line">            this.responseBodyAdvice.add(adviceBean);</span><br><span class="line">            logger.info(&quot;Detected ResponseBodyAdvice implementation in &quot; + adviceBean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、DispatcherServlet处理逻辑"><a href="#三、DispatcherServlet处理逻辑" class="headerlink" title="三、DispatcherServlet处理逻辑"></a>三、DispatcherServlet处理逻辑</h3><h4 id="1、FrameworkServlet的doGet、doPost方法"><a href="#1、FrameworkServlet的doGet、doPost方法" class="headerlink" title="1、FrameworkServlet的doGet、doPost方法"></a>1、FrameworkServlet的doGet、doPost方法</h4><p>常用的post和get请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void doGet(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">        throws ServletException, IOException &#123;</span><br><span class="line">    //处理请求</span><br><span class="line">    processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void doPost(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">        throws ServletException, IOException &#123;</span><br><span class="line">    //处理请求</span><br><span class="line">    processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、FrameworkServlet的processRequest方法"><a href="#2、FrameworkServlet的processRequest方法" class="headerlink" title="2、FrameworkServlet的processRequest方法"></a>2、FrameworkServlet的processRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">protected final void processRequest(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">        throws ServletException, IOException &#123;</span><br><span class="line">    //处理web请求开始时间</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line">    Throwable failureCause = null;</span><br><span class="line">    //获取当前线程中的LocaleContext </span><br><span class="line">    LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();</span><br><span class="line">    //创建本次request的LocaleContext</span><br><span class="line">    LocaleContext localeContext = buildLocaleContext(request);</span><br><span class="line">    //获取当前线程中的RequestAttributes</span><br><span class="line">    RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">    //创建本次request的ServletRequestAttributes</span><br><span class="line">    ServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);</span><br><span class="line">    //获取request的异步任务管理器WebAsyncManager,不存在则创建一个存入该request</span><br><span class="line">    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    //往asyncManager中添加一个RequestBindingInterceptor</span><br><span class="line">    asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), new RequestBindingInterceptor());</span><br><span class="line">    //localeContext和requestAttributes,绑定到当前线程</span><br><span class="line">    initContextHolders(request, localeContext, requestAttributes);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //进一步处理</span><br><span class="line">        doService(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ServletException ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        throw new NestedServletException(&quot;Request processing failed&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    finally &#123;</span><br><span class="line">        //把原先的previousLocaleContext、previousAttributes重新绑定当前线程</span><br><span class="line">        resetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class="line">        if (requestAttributes != null) &#123;</span><br><span class="line">            //标记请求处理结束</span><br><span class="line">            requestAttributes.requestCompleted();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            if (failureCause != null) &#123;</span><br><span class="line">                this.logger.debug(&quot;Could not complete request&quot;, failureCause);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                    logger.debug(&quot;Leaving response open for concurrent processing&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    this.logger.debug(&quot;Successfully completed request&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //广播请求完成事件</span><br><span class="line">        publishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、DispatcherServlet的doService方法"><a href="#3、DispatcherServlet的doService方法" class="headerlink" title="3、DispatcherServlet的doService方法"></a>3、DispatcherServlet的doService方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void doService(HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        String resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? &quot; resumed&quot; : &quot;&quot;;</span><br><span class="line">        logger.debug(&quot;DispatcherServlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot; + resumed +</span><br><span class="line">                &quot; processing &quot; + request.getMethod() + &quot; request for [&quot; + getRequestUri(request) + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Keep a snapshot of the request attributes in case of an include,</span><br><span class="line">    // to be able to restore the original attributes after the include.</span><br><span class="line">    //对于IncludeRequest，创建request属性快照</span><br><span class="line">    Map&lt;String, Object&gt; attributesSnapshot = null;</span><br><span class="line">    if (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">        attributesSnapshot = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">        while (attrNames.hasMoreElements()) &#123;</span><br><span class="line">            String attrName = (String) attrNames.nextElement();</span><br><span class="line">            if (this.cleanupAfterInclude || attrName.startsWith(&quot;org.springframework.web.servlet&quot;)) &#123;</span><br><span class="line">                attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Make framework objects available to handlers and view objects.</span><br><span class="line">    //设置web容器</span><br><span class="line">    request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">    //设置本地化解析器</span><br><span class="line">    request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);</span><br><span class="line">    //设置样式解析器</span><br><span class="line">    request.setAttribute(THEME_RESOLVER_ATTRIBUTE, this.themeResolver);</span><br><span class="line">    //设置样式资源 </span><br><span class="line">    request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line">    //默认SessionFlashMapManager从Session中取出当前request对应的FlashMap，即重定向的参数</span><br><span class="line">    FlashMap inputFlashMap = this.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">    //添加到request</span><br><span class="line">    if (inputFlashMap != null) &#123;</span><br><span class="line">        request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">    &#125;</span><br><span class="line">    //Flash attributes 在对请求的重定向生效之前被临时存储（通常是在session)中，并且在重定向之后被立即移除</span><br><span class="line">    request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, new FlashMap());</span><br><span class="line">    //FlashMap 被用来管理 flash attributes 而 FlashMapManager 则被用来存储，获取和管理 FlashMap 实体</span><br><span class="line">    request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, this.flashMapManager);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //进一步处理请求</span><br><span class="line">        doDispatch(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        //没有正在处理的异步任务</span><br><span class="line">        if (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            // Restore the original attribute snapshot, in case of an include.</span><br><span class="line">            if (attributesSnapshot != null) &#123;</span><br><span class="line">                //更新request的属性值</span><br><span class="line">                restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DispatcherServlet的doDispatch方法"><a href="#4、DispatcherServlet的doDispatch方法" class="headerlink" title="4、DispatcherServlet的doDispatch方法"></a>4、DispatcherServlet的doDispatch方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    HttpServletRequest processedRequest = request;</span><br><span class="line">    HandlerExecutionChain mappedHandler = null;</span><br><span class="line">    boolean multipartRequestParsed = false;</span><br><span class="line">    //获取request的asyncManager</span><br><span class="line">    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        ModelAndView mv = null;</span><br><span class="line">        Exception dispatchException = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //判断是否有文件上传,有文件上传request转换为MultipartHttpServletRequest</span><br><span class="line">            processedRequest = checkMultipart(request);</span><br><span class="line">            multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">            // Determine handler for the current request.</span><br><span class="line">            //根据request获取对应的处理器链</span><br><span class="line">            mappedHandler = getHandler(processedRequest);</span><br><span class="line">            if (mappedHandler == null || mappedHandler.getHandler() == null) &#123;</span><br><span class="line">                //没有对应的Handler，通过response返回错误信息</span><br><span class="line">                noHandlerFound(processedRequest, response);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Determine handler adapter for the current request.</span><br><span class="line">            //根据request获取对应的HandlerAdapter</span><br><span class="line">            HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            // Process last-modified header, if supported by the handler.</span><br><span class="line">            //获得HTTP请求方法</span><br><span class="line">            String method = request.getMethod();</span><br><span class="line">            boolean isGet = &quot;GET&quot;.equals(method);</span><br><span class="line">            if (isGet || &quot;HEAD&quot;.equals(method)) &#123;</span><br><span class="line">                long lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Last-Modified value for [&quot; + getRequestUri(request) + &quot;] is: &quot; + lastModified);</span><br><span class="line">                &#125;</span><br><span class="line">                if (new ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //如果有拦截器的话，会执行拦截器的preHandler方法 </span><br><span class="line">            //如ConversionServiceExposingInterceptor拦截器，会将conversionService对象添加到request中</span><br><span class="line">            if (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Actually invoke the handler.</span><br><span class="line">            //返回ModelAndView  </span><br><span class="line">            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            //当view为空时，根据request的path设置默认view  </span><br><span class="line">            applyDefaultViewName(request, mv);</span><br><span class="line">            //执行拦截器的postHandle</span><br><span class="line">            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex) &#123;</span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        //处理异常、渲染视图</span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        //调用拦截器的afterCompletion方法</span><br><span class="line">        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Error err) &#123;</span><br><span class="line">        //调用拦截器的afterCompletion方法</span><br><span class="line">        triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        //判断是否正在处理异步请求  </span><br><span class="line">        if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            // Instead of postHandle and afterCompletion</span><br><span class="line">            //调用拦截器的afterConcurrentHandlingStarted方法</span><br><span class="line">            if (mappedHandler != null) &#123;</span><br><span class="line">                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Clean up any resources used by a multipart request.</span><br><span class="line">            //删除上传资源</span><br><span class="line">            if (multipartRequestParsed) &#123;</span><br><span class="line">                cleanupMultipart(processedRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DispatcherServlet的checkMultipart方法"><a href="#5、DispatcherServlet的checkMultipart方法" class="headerlink" title="5、DispatcherServlet的checkMultipart方法"></a>5、DispatcherServlet的checkMultipart方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected HttpServletRequest checkMultipart(HttpServletRequest request) throws MultipartException &#123;</span><br><span class="line">    //有multipartResolver解析器,且request为POST请求、contentType以&quot;multipart/&quot;开头</span><br><span class="line">    if (this.multipartResolver != null &amp;&amp; this.multipartResolver.isMultipart(request)) &#123;</span><br><span class="line">        //request已经转换为MultipartHttpServletRequest</span><br><span class="line">        if (WebUtils.getNativeRequest(request, MultipartHttpServletRequest.class) != null) &#123;</span><br><span class="line">            logger.debug(&quot;Request is already a MultipartHttpServletRequest - if not in a forward, &quot; +</span><br><span class="line">                    &quot;this typically results from an additional MultipartFilter in web.xml&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //request转换MultipartHttpServletRequest出错</span><br><span class="line">        else if (request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) instanceof MultipartException) &#123;</span><br><span class="line">            logger.debug(&quot;Multipart resolution failed for current request before - &quot; +</span><br><span class="line">                    &quot;skipping re-resolution for undisturbed error rendering&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //处理request,转换为MultipartHttpServletRequest</span><br><span class="line">            return this.multipartResolver.resolveMultipart(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // If not returned before: return original request.</span><br><span class="line">    return request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、CommonsMultipartResolver的resolveMultipart方法"><a href="#6、CommonsMultipartResolver的resolveMultipart方法" class="headerlink" title="6、CommonsMultipartResolver的resolveMultipart方法"></a>6、CommonsMultipartResolver的resolveMultipart方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public MultipartHttpServletRequest resolveMultipart(final HttpServletRequest request) throws MultipartException &#123;</span><br><span class="line">    Assert.notNull(request, &quot;Request must not be null&quot;);</span><br><span class="line">    //待用到再解析</span><br><span class="line">    if (this.resolveLazily) &#123;</span><br><span class="line">        return new DefaultMultipartHttpServletRequest(request) &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void initializeMultipart() &#123;</span><br><span class="line">                MultipartParsingResult parsingResult = parseRequest(request);</span><br><span class="line">                setMultipartFiles(parsingResult.getMultipartFiles());</span><br><span class="line">                setMultipartParameters(parsingResult.getMultipartParameters());</span><br><span class="line">                setMultipartParameterContentTypes(parsingResult.getMultipartParameterContentTypes());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //解析request</span><br><span class="line">        MultipartParsingResult parsingResult = parseRequest(request);</span><br><span class="line">        return new DefaultMultipartHttpServletRequest(request, parsingResult.getMultipartFiles(),</span><br><span class="line">                parsingResult.getMultipartParameters(), parsingResult.getMultipartParameterContentTypes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、CommonsMultipartResolver的parseRequest方法"><a href="#7、CommonsMultipartResolver的parseRequest方法" class="headerlink" title="7、CommonsMultipartResolver的parseRequest方法"></a>7、CommonsMultipartResolver的parseRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected MultipartParsingResult parseRequest(HttpServletRequest request) throws MultipartException &#123;</span><br><span class="line">    //获取编码方式,配置中UTF-8</span><br><span class="line">    String encoding = determineEncoding(request);</span><br><span class="line">    //获取文件上载器，默认ServletFileUpload</span><br><span class="line">    FileUpload fileUpload = prepareFileUpload(encoding);</span><br><span class="line">    try &#123;</span><br><span class="line">        //将multipart/form-data的文件按boundary分割,分别创建FileItem对象</span><br><span class="line">        List&lt;FileItem&gt; fileItems = ((ServletFileUpload) fileUpload).parseRequest(request);</span><br><span class="line">        return parseFileItems(fileItems, encoding);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (FileUploadBase.SizeLimitExceededException ex) &#123;</span><br><span class="line">        throw new MaxUploadSizeExceededException(fileUpload.getSizeMax(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (FileUploadException ex) &#123;</span><br><span class="line">        throw new MultipartException(&quot;Could not parse multipart servlet request&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、CommonsFileUploadSupport的parseFileItems方法"><a href="#8、CommonsFileUploadSupport的parseFileItems方法" class="headerlink" title="8、CommonsFileUploadSupport的parseFileItems方法"></a>8、CommonsFileUploadSupport的parseFileItems方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">protected MultipartParsingResult parseFileItems(List&lt;FileItem&gt; fileItems, String encoding) &#123;</span><br><span class="line">    MultiValueMap&lt;String, MultipartFile&gt; multipartFiles = new LinkedMultiValueMap&lt;String, MultipartFile&gt;();</span><br><span class="line">    Map&lt;String, String[]&gt; multipartParameters = new HashMap&lt;String, String[]&gt;();</span><br><span class="line">    Map&lt;String, String&gt; multipartParameterContentTypes = new HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    // Extract multipart files and multipart parameters.</span><br><span class="line">    for (FileItem fileItem : fileItems) &#123;</span><br><span class="line">        //form字段</span><br><span class="line">        if (fileItem.isFormField()) &#123;</span><br><span class="line">            String value;</span><br><span class="line">            String partEncoding = determineEncoding(fileItem.getContentType(), encoding);</span><br><span class="line">            if (partEncoding != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //获取字段值</span><br><span class="line">                    value = fileItem.getString(partEncoding);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (UnsupportedEncodingException ex) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Could not decode multipart item &apos;&quot; + fileItem.getFieldName() +</span><br><span class="line">                                &quot;&apos; with encoding &apos;&quot; + partEncoding + &quot;&apos;: using platform default&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    value = fileItem.getString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                value = fileItem.getString();</span><br><span class="line">            &#125;</span><br><span class="line">            //字段集合</span><br><span class="line">            String[] curParam = multipartParameters.get(fileItem.getFieldName());</span><br><span class="line">            if (curParam == null) &#123;</span><br><span class="line">                // simple form field</span><br><span class="line">                multipartParameters.put(fileItem.getFieldName(), new String[] &#123;value&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // array of simple form fields</span><br><span class="line">                String[] newParam = StringUtils.addStringToArray(curParam, value);</span><br><span class="line">                multipartParameters.put(fileItem.getFieldName(), newParam);</span><br><span class="line">            &#125;</span><br><span class="line">            //字段类型集合</span><br><span class="line">            multipartParameterContentTypes.put(fileItem.getFieldName(), fileItem.getContentType());</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // multipart file field</span><br><span class="line">            //上传文件</span><br><span class="line">            CommonsMultipartFile file = new CommonsMultipartFile(fileItem);</span><br><span class="line">            //上传文件集合</span><br><span class="line">            multipartFiles.add(file.getName(), file);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Found multipart file [&quot; + file.getName() + &quot;] of size &quot; + file.getSize() +</span><br><span class="line">                        &quot; bytes with original filename [&quot; + file.getOriginalFilename() + &quot;], stored &quot; +</span><br><span class="line">                        file.getStorageDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return new MultipartParsingResult(multipartFiles, multipartParameters, multipartParameterContentTypes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（三、4）DispatcherServlet的getHandler方法"><a href="#9、接（三、4）DispatcherServlet的getHandler方法" class="headerlink" title="9、接（三、4）DispatcherServlet的getHandler方法"></a>9、接（三、4）DispatcherServlet的getHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //配置为RequestMappingHandlerMapping</span><br><span class="line">    for (HandlerMapping hm : this.handlerMappings) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(</span><br><span class="line">                    &quot;Testing handler map [&quot; + hm + &quot;] in DispatcherServlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取处理器链</span><br><span class="line">        HandlerExecutionChain handler = hm.getHandler(request);</span><br><span class="line">        if (handler != null) &#123;</span><br><span class="line">            return handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、AbstractHandlerMapping的getHandler方法"><a href="#10、AbstractHandlerMapping的getHandler方法" class="headerlink" title="10、AbstractHandlerMapping的getHandler方法"></a>10、AbstractHandlerMapping的getHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //获取处理器</span><br><span class="line">    Object handler = getHandlerInternal(request);</span><br><span class="line">    if (handler == null) &#123;</span><br><span class="line">        handler = getDefaultHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    if (handler == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // Bean name or resolved handler?</span><br><span class="line">    if (handler instanceof String) &#123;</span><br><span class="line">        String handlerName = (String) handler;</span><br><span class="line">        handler = getApplicationContext().getBean(handlerName);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建处理器链</span><br><span class="line">    return getHandlerExecutionChain(handler, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、AbstractHandlerMethodMapping的getHandlerInternal方法"><a href="#11、AbstractHandlerMethodMapping的getHandlerInternal方法" class="headerlink" title="11、AbstractHandlerMethodMapping的getHandlerInternal方法"></a>11、AbstractHandlerMethodMapping的getHandlerInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected HandlerMethod getHandlerInternal(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //获取request的path</span><br><span class="line">    String lookupPath = getUrlPathHelper().getLookupPathForRequest(request);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Looking up handler method for path &quot; + lookupPath);</span><br><span class="line">    &#125;</span><br><span class="line">    //由path查找handlerMethod</span><br><span class="line">    HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        if (handlerMethod != null) &#123;</span><br><span class="line">            logger.debug(&quot;Returning handler method [&quot; + handlerMethod + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            logger.debug(&quot;Did not find handler method for [&quot; + lookupPath + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建含有bean的handlerMethod</span><br><span class="line">    return (handlerMethod != null ? handlerMethod.createWithResolvedBean() : null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、AbstractHandlerMethodMapping的lookupHandler方法"><a href="#12、AbstractHandlerMethodMapping的lookupHandler方法" class="headerlink" title="12、AbstractHandlerMethodMapping的lookupHandler方法"></a>12、AbstractHandlerMethodMapping的lookupHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerMethod lookupHandlerMethod(String lookupPath, HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    List&lt;Match&gt; matches = new ArrayList&lt;Match&gt;();</span><br><span class="line">    //由path查找注解信息</span><br><span class="line">    List&lt;T&gt; directPathMatches = this.urlMap.get(lookupPath);</span><br><span class="line">    //通过path直接匹配</span><br><span class="line">    if (directPathMatches != null) &#123;</span><br><span class="line">        addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">    &#125;</span><br><span class="line">    if (matches.isEmpty()) &#123;</span><br><span class="line">        // No choice but to go through all mappings...</span><br><span class="line">        //通过表达式模糊匹配</span><br><span class="line">        addMatchingMappings(this.handlerMethods.keySet(), matches, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!matches.isEmpty()) &#123;</span><br><span class="line">        //比较器</span><br><span class="line">        Comparator&lt;Match&gt; comparator = new MatchComparator(getMappingComparator(request));</span><br><span class="line">        //匹配多个时，排序</span><br><span class="line">        Collections.sort(matches, comparator);</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(&quot;Found &quot; + matches.size() + &quot; matching mapping(s) for [&quot; + lookupPath + &quot;] : &quot; + matches);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取最匹配的</span><br><span class="line">        Match bestMatch = matches.get(0);</span><br><span class="line">        //匹配程度相等</span><br><span class="line">        if (matches.size() &gt; 1) &#123;</span><br><span class="line">            Match secondBestMatch = matches.get(1);</span><br><span class="line">            if (comparator.compare(bestMatch, secondBestMatch) == 0) &#123;</span><br><span class="line">                Method m1 = bestMatch.handlerMethod.getMethod();</span><br><span class="line">                Method m2 = secondBestMatch.handlerMethod.getMethod();</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Ambiguous handler methods mapped for HTTP path &apos;&quot; + request.getRequestURL() + &quot;&apos;: &#123;&quot; +</span><br><span class="line">                        m1 + &quot;, &quot; + m2 + &quot;&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //匹配相关信息设置到request中，包括解析后的@pathvariable参数集合</span><br><span class="line">        handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">        //返回最匹配的处理方法</span><br><span class="line">        return bestMatch.handlerMethod;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return handleNoMatch(handlerMethods.keySet(), lookupPath, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、AbstractHandlerMethodMapping的addMatchingMappings方法"><a href="#13、AbstractHandlerMethodMapping的addMatchingMappings方法" class="headerlink" title="13、AbstractHandlerMethodMapping的addMatchingMappings方法"></a>13、AbstractHandlerMethodMapping的addMatchingMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void addMatchingMappings(Collection&lt;T&gt; mappings, List&lt;Match&gt; matches, HttpServletRequest request) &#123;</span><br><span class="line">    for (T mapping : mappings) &#123;</span><br><span class="line">        //验证注解的条件与请求是否匹配，比如method、patterns等</span><br><span class="line">        T match = getMatchingMapping(mapping, request);</span><br><span class="line">        if (match != null) &#123;</span><br><span class="line">            //创建注解信息与方法的配对</span><br><span class="line">            matches.add(new Match(match, this.handlerMethods.get(mapping)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法"><a href="#14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法" class="headerlink" title="14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法"></a>14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerExecutionChain getHandlerExecutionChain(Object handler, HttpServletRequest request) &#123;</span><br><span class="line">    HandlerExecutionChain chain = (handler instanceof HandlerExecutionChain ?</span><br><span class="line">            (HandlerExecutionChain) handler : new HandlerExecutionChain(handler));</span><br><span class="line">    //添加拦截器</span><br><span class="line">    chain.addInterceptors(getAdaptedInterceptors());</span><br><span class="line"></span><br><span class="line">    String lookupPath = this.urlPathHelper.getLookupPathForRequest(request);</span><br><span class="line">    //由路径添加拦截器</span><br><span class="line">    for (MappedInterceptor mappedInterceptor : this.mappedInterceptors) &#123;</span><br><span class="line">        if (mappedInterceptor.matches(lookupPath, this.pathMatcher)) &#123;</span><br><span class="line">            //默认注册ConversionServiceExposingInterceptor拦截器</span><br><span class="line">            chain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、MappedInterceptor的matches方法"><a href="#15、MappedInterceptor的matches方法" class="headerlink" title="15、MappedInterceptor的matches方法"></a>15、MappedInterceptor的matches方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public boolean matches(String lookupPath, PathMatcher pathMatcher) &#123;</span><br><span class="line">    PathMatcher pathMatcherToUse = (this.pathMatcher != null) ? this.pathMatcher : pathMatcher;</span><br><span class="line">    //排除的path表达式</span><br><span class="line">    if (this.excludePatterns != null) &#123;</span><br><span class="line">        for (String pattern : this.excludePatterns) &#123;</span><br><span class="line">            if (pathMatcherToUse.match(pattern, lookupPath)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //包含的path表达式</span><br><span class="line">    if (this.includePatterns == null) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        for (String pattern : this.includePatterns) &#123;</span><br><span class="line">            if (pathMatcherToUse.match(pattern, lookupPath)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、接（三、4）DispatcherServlet的getHandlerAdapter方法"><a href="#16、接（三、4）DispatcherServlet的getHandlerAdapter方法" class="headerlink" title="16、接（三、4）DispatcherServlet的getHandlerAdapter方法"></a>16、接（三、4）DispatcherServlet的getHandlerAdapter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException &#123;</span><br><span class="line">    //默认配置了RequestMappingHandlerAdapter</span><br><span class="line">    for (HandlerAdapter ha : this.handlerAdapters) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(&quot;Testing handler adapter [&quot; + ha + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //RequestMappingHandlerAdapter处理HandlerMethod类型的handler</span><br><span class="line">        if (ha.supports(handler)) &#123;</span><br><span class="line">            return ha;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    throw new ServletException(&quot;No adapter for handler [&quot; + handler +</span><br><span class="line">            &quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、AbstractHandlerMethodAdapter的supports方法"><a href="#17、AbstractHandlerMethodAdapter的supports方法" class="headerlink" title="17、AbstractHandlerMethodAdapter的supports方法"></a>17、AbstractHandlerMethodAdapter的supports方法</h4><p>RequestMappingHandlerAdapter的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final boolean supports(Object handler) &#123;</span><br><span class="line">    return (handler instanceof HandlerMethod &amp;&amp; supportsInternal((HandlerMethod) handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="18、接（三、4）AbstractHandlerMethodAdapter的handle方法"><a href="#18、接（三、4）AbstractHandlerMethodAdapter的handle方法" class="headerlink" title="18、接（三、4）AbstractHandlerMethodAdapter的handle方法"></a>18、接（三、4）AbstractHandlerMethodAdapter的handle方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">    return handleInternal(request, response, (HandlerMethod) handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、RequestMappingHandlerAdapter的handleInternal方法"><a href="#19、RequestMappingHandlerAdapter的handleInternal方法" class="headerlink" title="19、RequestMappingHandlerAdapter的handleInternal方法"></a>19、RequestMappingHandlerAdapter的handleInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView handleInternal(HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123;</span><br><span class="line">    //获取该类的@SessionAttributes注解处理器,并且判断有无该注解信息</span><br><span class="line">    if (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;</span><br><span class="line">        // Always prevent caching in case of session attribute management.</span><br><span class="line">        //通过设置http头，指定过期时间</span><br><span class="line">        checkAndPrepare(request, response, this.cacheSecondsForSessionAttributeHandlers, true);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Uses configured default cacheSeconds setting.</span><br><span class="line">        checkAndPrepare(request, response, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Execute invokeHandlerMethod in synchronized block if required.</span><br><span class="line">    //执行invokeHandlerMethod时，是否获取session锁</span><br><span class="line">    if (this.synchronizeOnSession) &#123;</span><br><span class="line">        HttpSession session = request.getSession(false);</span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            Object mutex = WebUtils.getSessionMutex(session);</span><br><span class="line">            synchronized (mutex) &#123;</span><br><span class="line">                return invokeHandleMethod(request, response, handlerMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //进一步处理request</span><br><span class="line">    return invokeHandleMethod(request, response, handlerMethod);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、RequestMappingHandlerAdapter的invokeHandleMethod方法"><a href="#20、RequestMappingHandlerAdapter的invokeHandleMethod方法" class="headerlink" title="20、RequestMappingHandlerAdapter的invokeHandleMethod方法"></a>20、RequestMappingHandlerAdapter的invokeHandleMethod方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">private ModelAndView invokeHandleMethod(HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    ServletWebRequest webRequest = new ServletWebRequest(request, response);</span><br><span class="line">    //获取适用于当前handler的类的@InitBinder注解的方法，创建ServletRequestDataBinderFactory</span><br><span class="line">    WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">    //获取适用于当前handler的类的@ModelAttribute注解的方法，获取缓存的sessionAttributes，创建ModelFactory</span><br><span class="line">    ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class="line">    //创建ServletInvocableHandlerMethod</span><br><span class="line">    ServletInvocableHandlerMethod requestMappingMethod = createRequestMappingMethod(handlerMethod, binderFactory);</span><br><span class="line">    //ModelAndView容器</span><br><span class="line">    ModelAndViewContainer mavContainer = new ModelAndViewContainer();</span><br><span class="line">    //获取request中的FlashMap，加入mavContainer</span><br><span class="line">    mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">    //初始化Model</span><br><span class="line">    modelFactory.initModel(webRequest, mavContainer, requestMappingMethod);</span><br><span class="line">    //请求重定向时忽略model参数</span><br><span class="line">    mavContainer.setIgnoreDefaultModelOnRedirect(this.ignoreDefaultModelOnRedirect);</span><br><span class="line">    //Servlet容器是否支持异步处理请求，返回StandardServletAsyncWebRequest或NoSupportAsyncWebRequest</span><br><span class="line">    AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">    asyncWebRequest.setTimeout(this.asyncRequestTimeout);</span><br><span class="line">    //获取request的asyncManager</span><br><span class="line">    final WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    //设置异步处理线程池</span><br><span class="line">    asyncManager.setTaskExecutor(this.taskExecutor);</span><br><span class="line">    //设置请求</span><br><span class="line">    asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">    //设置拦截器</span><br><span class="line">    asyncManager.registerCallableInterceptors(this.callableInterceptors);</span><br><span class="line">    asyncManager.registerDeferredResultInterceptors(this.deferredResultInterceptors);</span><br><span class="line">    //有异步请求处理完成</span><br><span class="line">    if (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">        //获取处理结果</span><br><span class="line">        Object result = asyncManager.getConcurrentResult();</span><br><span class="line">        //获取处理返回的mavContainer</span><br><span class="line">        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0];</span><br><span class="line">        //清除ConcurrentResult与ConcurrentResultContext</span><br><span class="line">        asyncManager.clearConcurrentResult();</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Found concurrent result value [&quot; + result + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建ConcurrentResultHandlerMethod</span><br><span class="line">        requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</span><br><span class="line">    &#125;</span><br><span class="line">    //处理请求</span><br><span class="line">    requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">    //正在异步处理请求</span><br><span class="line">    if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //处理并返回ModelAndView</span><br><span class="line">    return getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、ModelFactory的initModel方法"><a href="#21、ModelFactory的initModel方法" class="headerlink" title="21、ModelFactory的initModel方法"></a>21、ModelFactory的initModel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void initModel(NativeWebRequest request, ModelAndViewContainer mavContainer, HandlerMethod handlerMethod)</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">    //从request中获取该类的@SessionAttributes注解的且作用域为session属性</span><br><span class="line">    Map&lt;String, ?&gt; sessionAttributes = this.sessionAttributesHandler.retrieveAttributes(request);</span><br><span class="line">    mavContainer.mergeAttributes(sessionAttributes);</span><br><span class="line">    //执行@ModelAttribute注解的方法,将返回值加入model中</span><br><span class="line">    invokeModelAttributeMethods(request, mavContainer);</span><br><span class="line">    //从request中获取方法注解@ModelAttribute的参数,将返回值加入model中</span><br><span class="line">    for (String name : findSessionAttributeArguments(handlerMethod)) &#123;</span><br><span class="line">        if (!mavContainer.containsAttribute(name)) &#123;</span><br><span class="line">            Object value = this.sessionAttributesHandler.retrieveAttribute(request, name);</span><br><span class="line">            if (value == null) &#123;</span><br><span class="line">                throw new HttpSessionRequiredException(&quot;Expected session attribute &apos;&quot; + name + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            mavContainer.addAttribute(name, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法"><a href="#22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法" class="headerlink" title="22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法"></a>22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public void invokeAndHandle(ServletWebRequest webRequest,</span><br><span class="line">        ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123;</span><br><span class="line">    //处理请求</span><br><span class="line">    Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">    //如方法上有@ResponseStatus注解，将注解值放入request或response</span><br><span class="line">    setResponseStatus(webRequest);</span><br><span class="line">    //没有返回值</span><br><span class="line">    if (returnValue == null) &#123;</span><br><span class="line">        if (isRequestNotModified(webRequest) || hasResponseStatus() || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">            //设置请求已被处理完</span><br><span class="line">            mavContainer.setRequestHandled(true);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (StringUtils.hasText(this.responseReason)) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(false);</span><br><span class="line">    try &#123;</span><br><span class="line">        //处理器处理返回值</span><br><span class="line">        this.returnValueHandlers.handleReturnValue(</span><br><span class="line">                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(getReturnValueHandlingErrorMessage(&quot;Error handling return value&quot;, returnValue), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、InvocableHandlerMethod的invokeForRequest方法"><a href="#23、InvocableHandlerMethod的invokeForRequest方法" class="headerlink" title="23、InvocableHandlerMethod的invokeForRequest方法"></a>23、InvocableHandlerMethod的invokeForRequest方法</h4><p>ServletInvocableHandlerMethod的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Object invokeForRequest(NativeWebRequest request, ModelAndViewContainer mavContainer,</span><br><span class="line">        Object... providedArgs) throws Exception &#123;</span><br><span class="line">    //获取并处理方法参数，即Controller方法中的参数  </span><br><span class="line">    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder(&quot;Invoking [&quot;);</span><br><span class="line">        sb.append(getBeanType().getSimpleName()).append(&quot;.&quot;);</span><br><span class="line">        sb.append(getMethod().getName()).append(&quot;] method with arguments &quot;);</span><br><span class="line">        sb.append(Arrays.asList(args));</span><br><span class="line">        logger.trace(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    //执行Controller中的方法</span><br><span class="line">    Object returnValue = doInvoke(args);</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Method [&quot; + getMethod().getName() + &quot;] returned [&quot; + returnValue + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法"><a href="#24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法" class="headerlink" title="24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法"></a>24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private ModelAndView getModelAndView(ModelAndViewContainer mavContainer,</span><br><span class="line">        ModelFactory modelFactory, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    //将model中的属性,设置到request中，作用域session，如不存在则往model中添加绑定后的属性值</span><br><span class="line">    modelFactory.updateModel(webRequest, mavContainer);</span><br><span class="line">    if (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    ModelMap model = mavContainer.getModel();</span><br><span class="line">    ModelAndView mav = new ModelAndView(mavContainer.getViewName(), model);</span><br><span class="line">    //设置view</span><br><span class="line">    if (!mavContainer.isViewReference()) &#123;</span><br><span class="line">        mav.setView((View) mavContainer.getView());</span><br><span class="line">    &#125;</span><br><span class="line">    //重定向参数</span><br><span class="line">    if (model instanceof RedirectAttributes) &#123;</span><br><span class="line">        Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br><span class="line">        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        //flashAttributes存入request</span><br><span class="line">        RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">    &#125;</span><br><span class="line">    return mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25、接（三、4）DispatcherServlet的processDispatchResult方法"><a href="#25、接（三、4）DispatcherServlet的processDispatchResult方法" class="headerlink" title="25、接（三、4）DispatcherServlet的processDispatchResult方法"></a>25、接（三、4）DispatcherServlet的processDispatchResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">private void processDispatchResult(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    boolean errorView = false;</span><br><span class="line">    //存在异常</span><br><span class="line">    if (exception != null) &#123;</span><br><span class="line">        //处理ModelAndViewDefiningException</span><br><span class="line">        if (exception instanceof ModelAndViewDefiningException) &#123;</span><br><span class="line">            logger.debug(&quot;ModelAndViewDefiningException encountered&quot;, exception);</span><br><span class="line">            mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            Object handler = (mappedHandler != null ? mappedHandler.getHandler() : null);</span><br><span class="line">            //处理其他异常</span><br><span class="line">            mv = processHandlerException(request, response, handler, exception);</span><br><span class="line">            errorView = (mv != null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Did the handler return a view to render?</span><br><span class="line">    if (mv != null &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class="line">        //渲染视图</span><br><span class="line">        render(mv, request, response);</span><br><span class="line">        if (errorView) &#123;</span><br><span class="line">            WebUtils.clearErrorRequestAttributes(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Null ModelAndView returned to DispatcherServlet with name &apos;&quot; + getServletName() +</span><br><span class="line">                    &quot;&apos;: assuming HandlerAdapter completed request handling&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        // Concurrent handling started during a forward</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mappedHandler != null) &#123;</span><br><span class="line">        //</span><br><span class="line">        mappedHandler.triggerAfterCompletion(request, response, null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、参数解析器"><a href="#四、参数解析器" class="headerlink" title="四、参数解析器"></a>四、参数解析器</h3><h4 id="1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法"><a href="#1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法" class="headerlink" title="1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法"></a>1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() &#123;</span><br><span class="line">    List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;HandlerMethodArgumentResolver&gt;();</span><br><span class="line"></span><br><span class="line">    // Annotation-based argument resolution</span><br><span class="line">    //处理注解了@RequestParam的参数或者没有注解的MultipartFile类型的参数</span><br><span class="line">    resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false));</span><br><span class="line">    //处理注解了@RequestParam的参数</span><br><span class="line">    resolvers.add(new RequestParamMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@PathVariable的参数</span><br><span class="line">    resolvers.add(new PathVariableMethodArgumentResolver());</span><br><span class="line">    //处理注解了@PathVariable的Map类型的参数</span><br><span class="line">    resolvers.add(new PathVariableMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@MatrixVariable的参数</span><br><span class="line">    resolvers.add(new MatrixVariableMethodArgumentResolver());</span><br><span class="line">    //处理注解了@MatrixVariable的Map类型参数</span><br><span class="line">    resolvers.add(new MatrixVariableMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@ModelAttribute的参数</span><br><span class="line">    resolvers.add(new ServletModelAttributeMethodProcessor(false));</span><br><span class="line">    //处理注解了@RequestBody的参数</span><br><span class="line">    resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters()));</span><br><span class="line">    //处理注解了@RequestPart的参数或者没有注解的MultipartFile类型的参数或者没有注解的&quot;javax.servlet.http.Part&quot;类型的参数</span><br><span class="line">    resolvers.add(new RequestPartMethodArgumentResolver(getMessageConverters()));</span><br><span class="line">    //处理注解了@RequestHeader的非Map类型的参数</span><br><span class="line">    resolvers.add(new RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">    //处理注解了@RequestHeader的Map类型的参数</span><br><span class="line">    resolvers.add(new RequestHeaderMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@CookieValue的参数</span><br><span class="line">    resolvers.add(new ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">    //处理注解了@Value的参数</span><br><span class="line">    resolvers.add(new ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line"></span><br><span class="line">    // Type-based argument resolution</span><br><span class="line">    //处理以下类型的参数，如WebRequest、ServletRequest、MultipartRequest、HttpSession、Principal</span><br><span class="line">    //Locale、TimeZone、&quot;java.time.ZoneId&quot;、InputStream、Reader、HttpMethod</span><br><span class="line">    resolvers.add(new ServletRequestMethodArgumentResolver());</span><br><span class="line">    //处理以下类型的参数,如ServletResponse、OutputStream、Writer</span><br><span class="line">    resolvers.add(new ServletResponseMethodArgumentResolver());</span><br><span class="line">    //处理HttpEntity、RequestEntity类型的参数</span><br><span class="line">    resolvers.add(new HttpEntityMethodProcessor(getMessageConverters()));</span><br><span class="line">    //处理RedirectAttributes类型的参数</span><br><span class="line">    resolvers.add(new RedirectAttributesMethodArgumentResolver());</span><br><span class="line">    //处理Model类型的参数</span><br><span class="line">    resolvers.add(new ModelMethodProcessor());</span><br><span class="line">    //处理Map类型的参数</span><br><span class="line">    resolvers.add(new MapMethodProcessor());</span><br><span class="line">    //处理Errors类型的参数</span><br><span class="line">    resolvers.add(new ErrorsMethodArgumentResolver());</span><br><span class="line">    //处理SessionStatus类型的参数</span><br><span class="line">    resolvers.add(new SessionStatusMethodArgumentResolver());</span><br><span class="line">    //处理UriComponentsBuilder类型的参数</span><br><span class="line">    resolvers.add(new UriComponentsBuilderMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">    // Custom arguments</span><br><span class="line">    //自定义的参数处理器</span><br><span class="line">    if (getCustomArgumentResolvers() != null) &#123;</span><br><span class="line">        resolvers.addAll(getCustomArgumentResolvers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Catch-all</span><br><span class="line">    //处理以下类型的参数，如基本数据类型及包装类、枚举类、CharSequence、Number、Date、</span><br><span class="line">    //URI、URL、Locale、Class</span><br><span class="line">    resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), true));</span><br><span class="line">    //处理不是以下类型的参数，如基本数据类型及包装类、枚举类、CharSequence、Number、Date、</span><br><span class="line">    //URI、URL、Locale、Class</span><br><span class="line">    resolvers.add(new ServletModelAttributeMethodProcessor(true));</span><br><span class="line"></span><br><span class="line">    return resolvers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法"><a href="#2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法" class="headerlink" title="2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法"></a>2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private Object[] getMethodArgumentValues(NativeWebRequest request, ModelAndViewContainer mavContainer,</span><br><span class="line">        Object... providedArgs) throws Exception &#123;</span><br><span class="line">    //获取方法参数</span><br><span class="line">    MethodParameter[] parameters = getMethodParameters();</span><br><span class="line">    Object[] args = new Object[parameters.length];</span><br><span class="line">    for (int i = 0; i &lt; parameters.length; i++) &#123;</span><br><span class="line">        MethodParameter parameter = parameters[i];</span><br><span class="line">        parameter.initParameterNameDiscovery(this.parameterNameDiscoverer);</span><br><span class="line">        //获取参数类型</span><br><span class="line">        GenericTypeResolver.resolveParameterType(parameter, getBean().getClass());</span><br><span class="line">        args[i] = resolveProvidedArgument(parameter, providedArgs);</span><br><span class="line">        if (args[i] != null) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //获取参数解析器</span><br><span class="line">        if (this.argumentResolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //解析参数</span><br><span class="line">                args[i] = this.argumentResolvers.resolveArgument(</span><br><span class="line">                        parameter, mavContainer, request, this.dataBinderFactory);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(getArgumentResolutionErrorMessage(&quot;Error resolving argument&quot;, i), ex);</span><br><span class="line">                &#125;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (args[i] == null) &#123;</span><br><span class="line">            String msg = getArgumentResolutionErrorMessage(&quot;No suitable resolver for argument&quot;, i);</span><br><span class="line">            throw new IllegalStateException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法"><a href="#3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法" class="headerlink" title="3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法"></a>3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法</h4><p>RequestParamMethodArgumentResolver、PathVariableMethodArgumentResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123;</span><br><span class="line">    //获取参数类型</span><br><span class="line">    Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line">    //获取参数名</span><br><span class="line">    NamedValueInfo namedValueInfo = getNamedValueInfo(parameter);</span><br><span class="line">    //获取参数值</span><br><span class="line">    Object arg = resolveName(namedValueInfo.name, parameter, webRequest);</span><br><span class="line">    if (arg == null) &#123;</span><br><span class="line">        //未获取到值，获取注解中的默认值</span><br><span class="line">        if (namedValueInfo.defaultValue != null) &#123;</span><br><span class="line">            arg = resolveDefaultValue(namedValueInfo.defaultValue);</span><br><span class="line">        &#125;</span><br><span class="line">        //Optional允许为null</span><br><span class="line">        else if (namedValueInfo.required &amp;&amp; !parameter.getParameterType().getName().equals(&quot;java.util.Optional&quot;)) &#123;</span><br><span class="line">            handleMissingValue(namedValueInfo.name, parameter);</span><br><span class="line">        &#125;</span><br><span class="line">        //参数值为null</span><br><span class="line">        arg = handleNullValue(namedValueInfo.name, arg, paramType);</span><br><span class="line">    &#125;</span><br><span class="line">    //空字符串,使用默认值</span><br><span class="line">    else if (&quot;&quot;.equals(arg) &amp;&amp; namedValueInfo.defaultValue != null) &#123;</span><br><span class="line">        arg = resolveDefaultValue(namedValueInfo.defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (binderFactory != null) &#123;</span><br><span class="line">        WebDataBinder binder = binderFactory.createBinder(webRequest, null, namedValueInfo.name);</span><br><span class="line">        arg = binder.convertIfNecessary(arg, paramType, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    //空方法，只有PathVariableMethodArgumentResolver覆盖了该方法</span><br><span class="line">    handleResolvedValue(arg, namedValueInfo.name, parameter, mavContainer, webRequest);</span><br><span class="line"></span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法"><a href="#4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法" class="headerlink" title="4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法"></a>4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    private NamedValueInfo getNamedValueInfo(MethodParameter parameter) &#123;</span><br><span class="line">    NamedValueInfo namedValueInfo = this.namedValueInfoCache.get(parameter);</span><br><span class="line">    if (namedValueInfo == null) &#123;</span><br><span class="line">        //从注解中获取参数名</span><br><span class="line">        namedValueInfo = createNamedValueInfo(parameter);</span><br><span class="line">        //注解中参数名不存在，从参数中获取参数名</span><br><span class="line">        namedValueInfo = updateNamedValueInfo(parameter, namedValueInfo);</span><br><span class="line">        this.namedValueInfoCache.put(parameter, namedValueInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    return namedValueInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法"><a href="#5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法" class="headerlink" title="5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法"></a>5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object resolveName(String name, MethodParameter parameter, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    HttpServletRequest servletRequest = webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">    MultipartHttpServletRequest multipartRequest =</span><br><span class="line">            WebUtils.getNativeRequest(servletRequest, MultipartHttpServletRequest.class);</span><br><span class="line">    Object arg;</span><br><span class="line">    //MultipartFile类型的参数</span><br><span class="line">    if (MultipartFile.class.equals(parameter.getParameterType())) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        Assert.notNull(multipartRequest, &quot;Expected MultipartHttpServletRequest: is a MultipartResolver configured?&quot;);</span><br><span class="line">        //从request中获取参数值</span><br><span class="line">        arg = multipartRequest.getFile(name);</span><br><span class="line">    &#125;</span><br><span class="line">    //MultipartFile集合类型的参数</span><br><span class="line">    else if (isMultipartFileCollection(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        Assert.notNull(multipartRequest, &quot;Expected MultipartHttpServletRequest: is a MultipartResolver configured?&quot;);</span><br><span class="line">        //从request中获取参数值</span><br><span class="line">        arg = multipartRequest.getFiles(name);</span><br><span class="line">    &#125;</span><br><span class="line">    //MultipartFile数组类型的参数</span><br><span class="line">    else if (isMultipartFileArray(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        Assert.notNull(multipartRequest, &quot;Expected MultipartHttpServletRequest: is a MultipartResolver configured?&quot;);</span><br><span class="line">        //从request中获取参数值</span><br><span class="line">        List&lt;MultipartFile&gt; multipartFiles = multipartRequest.getFiles(name);</span><br><span class="line">        arg = multipartFiles.toArray(new MultipartFile[multipartFiles.size()]);</span><br><span class="line">    &#125;</span><br><span class="line">    //Part类型的参数</span><br><span class="line">    else if (&quot;javax.servlet.http.Part&quot;.equals(parameter.getParameterType().getName())) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        arg = servletRequest.getPart(name);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (isPartCollection(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        arg = new ArrayList&lt;Object&gt;(servletRequest.getParts());</span><br><span class="line">    &#125;</span><br><span class="line">    else if (isPartArray(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        arg = RequestPartResolver.resolvePart(servletRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        arg = null;</span><br><span class="line">        //上传文件</span><br><span class="line">        if (multipartRequest != null) &#123;</span><br><span class="line">            List&lt;MultipartFile&gt; files = multipartRequest.getFiles(name);</span><br><span class="line">            if (!files.isEmpty()) &#123;</span><br><span class="line">                arg = (files.size() == 1 ? files.get(0) : files);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (arg == null) &#123;</span><br><span class="line">            //获取参数值</span><br><span class="line">            String[] paramValues = webRequest.getParameterValues(name);</span><br><span class="line">            if (paramValues != null) &#123;</span><br><span class="line">                arg = (paramValues.length == 1 ? paramValues[0] : paramValues);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法"><a href="#6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法" class="headerlink" title="6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法"></a>6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected Object resolveName(String name, MethodParameter parameter, NativeWebRequest request) throws Exception &#123;</span><br><span class="line">    //获取path中的参数</span><br><span class="line">    Map&lt;String, String&gt; uriTemplateVars =</span><br><span class="line">        (Map&lt;String, String&gt;) request.getAttribute(</span><br><span class="line">                HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">    return (uriTemplateVars != null) ? uriTemplateVars.get(name) : null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法"><a href="#7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法" class="headerlink" title="7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法"></a>7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123;</span><br><span class="line">    //使用消息转换器读取数据</span><br><span class="line">    Object arg = readWithMessageConverters(webRequest, parameter, parameter.getGenericParameterType());</span><br><span class="line">    //获取参数类名，参数为集合则获取集合内类名</span><br><span class="line">    String name = Conventions.getVariableNameForParameter(parameter);</span><br><span class="line">    //创建数据绑定器</span><br><span class="line">    WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line">    if (arg != null) &#123;</span><br><span class="line">        //处理@Validated注解</span><br><span class="line">        validateIfApplicable(binder, parameter);</span><br><span class="line">        if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">            throw new MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加绑定结果</span><br><span class="line">    mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法"><a href="#8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法" class="headerlink" title="8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法"></a>8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法</h4><p>ServletModelAttributeMethodProcessor的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123;</span><br><span class="line">    //获取参数名</span><br><span class="line">    String name = ModelFactory.getNameForParameter(parameter);</span><br><span class="line">    //获取参数值</span><br><span class="line">    Object attribute = (mavContainer.containsAttribute(name) ?</span><br><span class="line">            mavContainer.getModel().get(name) : createAttribute(name, parameter, binderFactory, webRequest));</span><br><span class="line">    //创建数据绑定器</span><br><span class="line">    WebDataBinder binder = binderFactory.createBinder(webRequest, attribute, name);</span><br><span class="line">    if (binder.getTarget() != null) &#123;</span><br><span class="line">        //将request的请求中的参数值，存入attribute对象中</span><br><span class="line">        bindRequestParameters(binder, webRequest);</span><br><span class="line">        //处理@Validated注解</span><br><span class="line">        validateIfApplicable(binder, parameter);</span><br><span class="line">        if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">            throw new BindException(binder.getBindingResult());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Add resolved attribute and BindingResult at the end of the model</span><br><span class="line">    //获取绑定后的参数值对象</span><br><span class="line">    Map&lt;String, Object&gt; bindingResultModel = binder.getBindingResult().getModel();</span><br><span class="line">    //清空model</span><br><span class="line">    mavContainer.removeAttributes(bindingResultModel);</span><br><span class="line">    //对象加入model中</span><br><span class="line">    mavContainer.addAllAttributes(bindingResultModel);</span><br><span class="line">    //对象类型转换为参数所需类型</span><br><span class="line">    return binder.convertIfNecessary(binder.getTarget(), parameter.getParameterType(), parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="五、返回值解析器"><a href="#五、返回值解析器" class="headerlink" title="五、返回值解析器"></a>五、返回值解析器</h3><h4 id="1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法"><a href="#1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法" class="headerlink" title="1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法"></a>1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() &#123;</span><br><span class="line">    List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;HandlerMethodReturnValueHandler&gt;();</span><br><span class="line"></span><br><span class="line">    // Single-purpose return value types</span><br><span class="line">    //处理ModelAndView类型的返回值</span><br><span class="line">    handlers.add(new ModelAndViewMethodReturnValueHandler());</span><br><span class="line">    //处理Model类型的返回值</span><br><span class="line">    handlers.add(new ModelMethodProcessor());</span><br><span class="line">    //处理View类型的返回值</span><br><span class="line">    handlers.add(new ViewMethodReturnValueHandler());</span><br><span class="line">    //处理HttpEntity类型且不是RequestEntity类型的返回值</span><br><span class="line">    handlers.add(new HttpEntityMethodProcessor(</span><br><span class="line">            getMessageConverters(), this.contentNegotiationManager, this.responseBodyAdvice));</span><br><span class="line">    //处理HttpEntity类型的返回值</span><br><span class="line">    handlers.add(new HttpHeadersReturnValueHandler());</span><br><span class="line">    //处理Callable类型的返回值</span><br><span class="line">    handlers.add(new CallableMethodReturnValueHandler());</span><br><span class="line">    //处理DeferredResult类型的返回值</span><br><span class="line">    handlers.add(new DeferredResultMethodReturnValueHandler());</span><br><span class="line">    //处理WebAsyncTask类型的返回值</span><br><span class="line">    handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory));</span><br><span class="line">    //处理ListenableFuture类型的返回值</span><br><span class="line">    handlers.add(new ListenableFutureReturnValueHandler());</span><br><span class="line"></span><br><span class="line">    // Annotation-based return value types</span><br><span class="line">    //处理注解了@ModelAttribute方法的返回值</span><br><span class="line">    handlers.add(new ModelAttributeMethodProcessor(false));</span><br><span class="line">    //处理注解了@ResponseBody方法或注解了@ResponseBody类的方法的返回值</span><br><span class="line">    handlers.add(new RequestResponseBodyMethodProcessor(</span><br><span class="line">            getMessageConverters(), this.contentNegotiationManager, this.responseBodyAdvice));</span><br><span class="line"></span><br><span class="line">    // Multi-purpose return value types</span><br><span class="line">    //处理void及string类型的返回值</span><br><span class="line">    handlers.add(new ViewNameMethodReturnValueHandler());</span><br><span class="line">    //处理Map类型的返回值</span><br><span class="line">    handlers.add(new MapMethodProcessor());</span><br><span class="line"></span><br><span class="line">    // Custom return value types</span><br><span class="line">    //添加自定义处理器</span><br><span class="line">    if (getCustomReturnValueHandlers() != null) &#123;</span><br><span class="line">        handlers.addAll(getCustomReturnValueHandlers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Catch-all</span><br><span class="line">    if (!CollectionUtils.isEmpty(getModelAndViewResolvers())) &#123;</span><br><span class="line">        handlers.add(new ModelAndViewResolverMethodReturnValueHandler(getModelAndViewResolvers()));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //处理不是以下类型的返回值，如基本数据类型及包装类、枚举类、CharSequence、Number、Date、</span><br><span class="line">        //URI、URL、Locale、Class</span><br><span class="line">        handlers.add(new ModelAttributeMethodProcessor(true));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return handlers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法"><a href="#2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法" class="headerlink" title="2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法"></a>2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    //获取处理器</span><br><span class="line">    HandlerMethodReturnValueHandler handler = getReturnValueHandler(returnType);</span><br><span class="line">    Assert.notNull(handler, &quot;Unknown return value type [&quot; + returnType.getParameterType().getName() + &quot;]&quot;);</span><br><span class="line">    //处理返回值</span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ModelAttributeMethodProcessor的handleReturnValue方法"><a href="#3、ModelAttributeMethodProcessor的handleReturnValue方法" class="headerlink" title="3、ModelAttributeMethodProcessor的handleReturnValue方法"></a>3、ModelAttributeMethodProcessor的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    if (returnValue != null) &#123;</span><br><span class="line">        //从@ModelAttribute注解中获取参数名，注解中没有则从类中获取</span><br><span class="line">        String name = ModelFactory.getNameForReturnValue(returnValue, returnType);</span><br><span class="line">        //返回值添加到model中</span><br><span class="line">        mavContainer.addAttribute(name, returnValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法"><a href="#4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法" class="headerlink" title="4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法"></a>4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    //无返回值，设置处理完成</span><br><span class="line">    if (returnValue == null) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ModelAndView mav = (ModelAndView) returnValue;</span><br><span class="line">    //view为String,view为视图名</span><br><span class="line">    if (mav.isReference()) &#123;</span><br><span class="line">        String viewName = mav.getViewName();</span><br><span class="line">        //添加返回的视图</span><br><span class="line">        mavContainer.setViewName(viewName);</span><br><span class="line">        //是否是重定向</span><br><span class="line">        if (viewName != null &amp;&amp; isRedirectViewName(viewName)) &#123;</span><br><span class="line">            mavContainer.setRedirectModelScenario(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        View view = mav.getView();</span><br><span class="line">        //添加返回的视图</span><br><span class="line">        mavContainer.setView(view);</span><br><span class="line">        //是否是重定向</span><br><span class="line">        if (view instanceof SmartView) &#123;</span><br><span class="line">            if (((SmartView) view).isRedirectView()) &#123;</span><br><span class="line">                mavContainer.setRedirectModelScenario(true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加返回的model</span><br><span class="line">    mavContainer.addAllAttributes(mav.getModel());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、RequestResponseBodyMethodProcessor的handleReturnValue方法"><a href="#5、RequestResponseBodyMethodProcessor的handleReturnValue方法" class="headerlink" title="5、RequestResponseBodyMethodProcessor的handleReturnValue方法"></a>5、RequestResponseBodyMethodProcessor的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span><br><span class="line">        throws IOException, HttpMediaTypeNotAcceptableException &#123;</span><br><span class="line">    //设置处理完成</span><br><span class="line">    mavContainer.setRequestHandled(true);</span><br><span class="line"></span><br><span class="line">    // Try even with null return value. ResponseBodyAdvice could get involved.</span><br><span class="line">    //调用消息转换器，将返回值写入webRequest</span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="六、处理异常"><a href="#六、处理异常" class="headerlink" title="六、处理异常"></a>六、处理异常</h3><h4 id="1、接（三、25）DispatcherServlet的processHandlerException方法"><a href="#1、接（三、25）DispatcherServlet的processHandlerException方法" class="headerlink" title="1、接（三、25）DispatcherServlet的processHandlerException方法"></a>1、接（三、25）DispatcherServlet的processHandlerException方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected ModelAndView processHandlerException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    // Check registered HandlerExceptionResolvers...</span><br><span class="line">    ModelAndView exMv = null;</span><br><span class="line">    //异常处理器为ExceptionHandlerExceptionResolver、ResponseStatusExceptionResolver、DefaultHandlerExceptionResolver</span><br><span class="line">    for (HandlerExceptionResolver handlerExceptionResolver : this.handlerExceptionResolvers) &#123;</span><br><span class="line">        //处理异常</span><br><span class="line">        exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);</span><br><span class="line">        if (exMv != null) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (exMv != null) &#123;</span><br><span class="line">        //异常处理返回结果为空</span><br><span class="line">        if (exMv.isEmpty()) &#123;</span><br><span class="line">            //直接将异常信息添加到request中</span><br><span class="line">            request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        // We might still need view name translation for a plain error model...</span><br><span class="line">        //设置默认的view</span><br><span class="line">        if (!exMv.hasView()) &#123;</span><br><span class="line">            exMv.setViewName(getDefaultViewName(request));</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Handler execution resulted in exception - forwarding to resolved error view: &quot; + exMv, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        //将异常相关信息添加到request</span><br><span class="line">        WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class="line">        return exMv;</span><br><span class="line">    &#125;</span><br><span class="line">    throw ex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AbstractHandlerExceptionResolver的resolveException方法"><a href="#2、AbstractHandlerExceptionResolver的resolveException方法" class="headerlink" title="2、AbstractHandlerExceptionResolver的resolveException方法"></a>2、AbstractHandlerExceptionResolver的resolveException方法</h4><p>ExceptionHandlerExceptionResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line">    //处理器是否使用于该handler</span><br><span class="line">    if (shouldApplyTo(request, handler)) &#123;</span><br><span class="line">        // Log exception, both at debug log level and at warn level, if desired.</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Resolving exception from handler [&quot; + handler + &quot;]: &quot; + ex);</span><br><span class="line">        &#125;</span><br><span class="line">        //打印异常信息</span><br><span class="line">        logException(ex, request);</span><br><span class="line">        //处理response缓存</span><br><span class="line">        prepareResponse(ex, response);</span><br><span class="line">        //处理异常</span><br><span class="line">        return doResolveException(request, response, handler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、AbstractHandlerMethodExceptionResolver的doResolveException方法"><a href="#3、AbstractHandlerMethodExceptionResolver的doResolveException方法" class="headerlink" title="3、AbstractHandlerMethodExceptionResolver的doResolveException方法"></a>3、AbstractHandlerMethodExceptionResolver的doResolveException方法</h4><p>ExceptionHandlerExceptionResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final ModelAndView doResolveException(</span><br><span class="line">        HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">    return doResolveHandlerMethodException(request, response, (HandlerMethod) handler, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法"><a href="#4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法" class="headerlink" title="4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法"></a>4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView doResolveHandlerMethodException(HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, HandlerMethod handlerMethod, Exception exception) &#123;</span><br><span class="line">    //获取处理异常的方法</span><br><span class="line">    ServletInvocableHandlerMethod exceptionHandlerMethod = getExceptionHandlerMethod(handlerMethod, exception);</span><br><span class="line">    if (exceptionHandlerMethod == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置参数解析器</span><br><span class="line">    exceptionHandlerMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);</span><br><span class="line">    //设置返回值解析器</span><br><span class="line">    exceptionHandlerMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers);</span><br><span class="line">    //创建请求</span><br><span class="line">    ServletWebRequest webRequest = new ServletWebRequest(request, response);</span><br><span class="line">    //ModelAndView容器</span><br><span class="line">    ModelAndViewContainer mavContainer = new ModelAndViewContainer();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Invoking @ExceptionHandler method: &quot; + exceptionHandlerMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        //执行异常处理方法</span><br><span class="line">        exceptionHandlerMethod.invokeAndHandle(webRequest, mavContainer, exception);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception invocationEx) &#123;</span><br><span class="line">        if (logger.isErrorEnabled()) &#123;</span><br><span class="line">            logger.error(&quot;Failed to invoke @ExceptionHandler method: &quot; + exceptionHandlerMethod, invocationEx);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //已处理完成，返回空ModelAndView</span><br><span class="line">    if (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        return new ModelAndView();</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        ModelAndView mav = new ModelAndView().addAllObjects(mavContainer.getModel());</span><br><span class="line">        mav.setViewName(mavContainer.getViewName());</span><br><span class="line">        if (!mavContainer.isViewReference()) &#123;</span><br><span class="line">            mav.setView((View) mavContainer.getView());</span><br><span class="line">        &#125;</span><br><span class="line">        //返回处理后的ModelAndView</span><br><span class="line">        return mav;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、ResponseStatusExceptionResolver的doResolveException方法"><a href="#5、ResponseStatusExceptionResolver的doResolveException方法" class="headerlink" title="5、ResponseStatusExceptionResolver的doResolveException方法"></a>5、ResponseStatusExceptionResolver的doResolveException方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line">    //获取异常类上的@ResponseStatus注解</span><br><span class="line">    ResponseStatus responseStatus = AnnotationUtils.findAnnotation(ex.getClass(), ResponseStatus.class);</span><br><span class="line">    if (responseStatus != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return resolveResponseStatus(responseStatus, request, response, handler, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception resolveEx) &#123;</span><br><span class="line">            logger.warn(&quot;Handling of @ResponseStatus resulted in Exception&quot;, resolveEx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、ResponseStatusExceptionResolver的resolveResponseStatus方法"><a href="#6、ResponseStatusExceptionResolver的resolveResponseStatus方法" class="headerlink" title="6、ResponseStatusExceptionResolver的resolveResponseStatus方法"></a>6、ResponseStatusExceptionResolver的resolveResponseStatus方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected ModelAndView resolveResponseStatus(ResponseStatus responseStatus, HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;</span><br><span class="line">    //获取http状态码</span><br><span class="line">    int statusCode = responseStatus.value().value();</span><br><span class="line">    //获取reason</span><br><span class="line">    String reason = responseStatus.reason();</span><br><span class="line">    if (this.messageSource != null) &#123;</span><br><span class="line">        reason = this.messageSource.getMessage(reason, null, reason, LocaleContextHolder.getLocale());</span><br><span class="line">    &#125;</span><br><span class="line">    //信息添加到response中</span><br><span class="line">    if (!StringUtils.hasLength(reason)) &#123;</span><br><span class="line">        response.sendError(statusCode);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        response.sendError(statusCode, reason);</span><br><span class="line">    &#125;</span><br><span class="line">    //返回空ModelAndView</span><br><span class="line">    return new ModelAndView();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、DefaultHandlerExceptionResolver的resolveResponseStatus方法"><a href="#7、DefaultHandlerExceptionResolver的resolveResponseStatus方法" class="headerlink" title="7、DefaultHandlerExceptionResolver的resolveResponseStatus方法"></a>7、DefaultHandlerExceptionResolver的resolveResponseStatus方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line">    //异常信息存入request、response中</span><br><span class="line">    try &#123;</span><br><span class="line">        if (ex instanceof NoSuchRequestHandlingMethodException) &#123;</span><br><span class="line">            return handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpRequestMethodNotSupportedException) &#123;</span><br><span class="line">            return handleHttpRequestMethodNotSupported((HttpRequestMethodNotSupportedException) ex, request,</span><br><span class="line">                    response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMediaTypeNotSupportedException) &#123;</span><br><span class="line">            return handleHttpMediaTypeNotSupported((HttpMediaTypeNotSupportedException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMediaTypeNotAcceptableException) &#123;</span><br><span class="line">            return handleHttpMediaTypeNotAcceptable((HttpMediaTypeNotAcceptableException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof MissingServletRequestParameterException) &#123;</span><br><span class="line">            return handleMissingServletRequestParameter((MissingServletRequestParameterException) ex, request,</span><br><span class="line">                    response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof ServletRequestBindingException) &#123;</span><br><span class="line">            return handleServletRequestBindingException((ServletRequestBindingException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof ConversionNotSupportedException) &#123;</span><br><span class="line">            return handleConversionNotSupported((ConversionNotSupportedException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof TypeMismatchException) &#123;</span><br><span class="line">            return handleTypeMismatch((TypeMismatchException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMessageNotReadableException) &#123;</span><br><span class="line">            return handleHttpMessageNotReadable((HttpMessageNotReadableException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMessageNotWritableException) &#123;</span><br><span class="line">            return handleHttpMessageNotWritable((HttpMessageNotWritableException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof MethodArgumentNotValidException) &#123;</span><br><span class="line">            return handleMethodArgumentNotValidException((MethodArgumentNotValidException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof MissingServletRequestPartException) &#123;</span><br><span class="line">            return handleMissingServletRequestPartException((MissingServletRequestPartException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof BindException) &#123;</span><br><span class="line">            return handleBindException((BindException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof NoHandlerFoundException) &#123;</span><br><span class="line">            return handleNoHandlerFoundException((NoHandlerFoundException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception handlerException) &#123;</span><br><span class="line">        logger.warn(&quot;Handling of [&quot; + ex.getClass().getName() + &quot;] resulted in Exception&quot;, handlerException);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="七、视图渲染"><a href="#七、视图渲染" class="headerlink" title="七、视图渲染"></a>七、视图渲染</h3><h4 id="1、接（三、25）DispatcherServlet的render方法"><a href="#1、接（三、25）DispatcherServlet的render方法" class="headerlink" title="1、接（三、25）DispatcherServlet的render方法"></a>1、接（三、25）DispatcherServlet的render方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">protected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    // Determine locale for request and apply it to the response.</span><br><span class="line">    //获取locale</span><br><span class="line">    Locale locale = this.localeResolver.resolveLocale(request);</span><br><span class="line">    response.setLocale(locale);</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    if (mv.isReference()) &#123;</span><br><span class="line">        // We need to resolve the view name.</span><br><span class="line">        //根据视图名创建视图</span><br><span class="line">        view = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);</span><br><span class="line">        if (view == null) &#123;</span><br><span class="line">            throw new ServletException(&quot;Could not resolve view with name &apos;&quot; + mv.getViewName() +</span><br><span class="line">                    &quot;&apos; in servlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // No need to lookup: the ModelAndView object contains the actual View object.</span><br><span class="line">        view = mv.getView();</span><br><span class="line">        if (view == null) &#123;</span><br><span class="line">            throw new ServletException(&quot;ModelAndView [&quot; + mv + &quot;] neither contains a view name nor a &quot; +</span><br><span class="line">                    &quot;View object in servlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Delegate to the View object for rendering.</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Rendering view [&quot; + view + &quot;] in DispatcherServlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //渲染视图</span><br><span class="line">        view.render(mv.getModelInternal(), request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Error rendering view [&quot; + view + &quot;] in DispatcherServlet with name &apos;&quot; +</span><br><span class="line">                    getServletName() + &quot;&apos;&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、DispatcherServlet的render方法"><a href="#2、DispatcherServlet的render方法" class="headerlink" title="2、DispatcherServlet的render方法"></a>2、DispatcherServlet的render方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected View resolveViewName(String viewName, Map&lt;String, Object&gt; model, Locale locale,</span><br><span class="line">        HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //配置的视图解析器InternalResourceViewResolver</span><br><span class="line">    for (ViewResolver viewResolver : this.viewResolvers) &#123;</span><br><span class="line">        //解析视图</span><br><span class="line">        View view = viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">        if (view != null) &#123;</span><br><span class="line">            return view;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AbstractCachingViewResolver的resolveViewName方法"><a href="#3、AbstractCachingViewResolver的resolveViewName方法" class="headerlink" title="3、AbstractCachingViewResolver的resolveViewName方法"></a>3、AbstractCachingViewResolver的resolveViewName方法</h4><p>InternalResourceViewResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public View resolveViewName(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    //没有缓存</span><br><span class="line">    if (!isCache()) &#123;</span><br><span class="line">        //创建视图</span><br><span class="line">        return createView(viewName, locale);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">        View view = this.viewAccessCache.get(cacheKey);</span><br><span class="line">        if (view == null) &#123;</span><br><span class="line">            synchronized (this.viewCreationCache) &#123;</span><br><span class="line">                view = this.viewCreationCache.get(cacheKey);</span><br><span class="line">                if (view == null) &#123;</span><br><span class="line">                    // Ask the subclass to create the View object.</span><br><span class="line">                    view = createView(viewName, locale);</span><br><span class="line">                    if (view == null &amp;&amp; this.cacheUnresolved) &#123;</span><br><span class="line">                        view = UNRESOLVED_VIEW;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (view != null) &#123;</span><br><span class="line">                        this.viewAccessCache.put(cacheKey, view);</span><br><span class="line">                        this.viewCreationCache.put(cacheKey, view);</span><br><span class="line">                        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                            logger.trace(&quot;Cached view [&quot; + cacheKey + &quot;]&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return (view != UNRESOLVED_VIEW ? view : null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、UrlBasedViewResolver的createView方法"><a href="#4、UrlBasedViewResolver的createView方法" class="headerlink" title="4、UrlBasedViewResolver的createView方法"></a>4、UrlBasedViewResolver的createView方法</h4><p>InternalResourceViewResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected View createView(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    // If this resolver is not supposed to handle the given view,</span><br><span class="line">    // return null to pass on to the next resolver in the chain.</span><br><span class="line">    //是否查找到该视图</span><br><span class="line">    if (!canHandle(viewName, locale)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // Check for special &quot;redirect:&quot; prefix.</span><br><span class="line">    //请求重定向</span><br><span class="line">    if (viewName.startsWith(REDIRECT_URL_PREFIX)) &#123;</span><br><span class="line">        //获取重定向地址</span><br><span class="line">        String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length());</span><br><span class="line">        //创建重定向视图</span><br><span class="line">        RedirectView view = new RedirectView(redirectUrl, isRedirectContextRelative(), isRedirectHttp10Compatible());</span><br><span class="line">        //使用容器初始化该视图，并返回</span><br><span class="line">        return applyLifecycleMethods(viewName, view);</span><br><span class="line">    &#125;</span><br><span class="line">    // Check for special &quot;forward:&quot; prefix.</span><br><span class="line">    //请求转发</span><br><span class="line">    if (viewName.startsWith(FORWARD_URL_PREFIX)) &#123;</span><br><span class="line">        String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length());</span><br><span class="line">        //创建转发视图</span><br><span class="line">        return new InternalResourceView(forwardUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    // Else fall back to superclass implementation: calling loadView.</span><br><span class="line">    return super.createView(viewName, locale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、AbstractCachingViewResolver的createView方法"><a href="#5、AbstractCachingViewResolver的createView方法" class="headerlink" title="5、AbstractCachingViewResolver的createView方法"></a>5、AbstractCachingViewResolver的createView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected View createView(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    return loadView(viewName, locale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、UrlBasedViewResolver的loadView方法"><a href="#6、UrlBasedViewResolver的loadView方法" class="headerlink" title="6、UrlBasedViewResolver的loadView方法"></a>6、UrlBasedViewResolver的loadView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected View loadView(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    //创建视图</span><br><span class="line">    AbstractUrlBasedView view = buildView(viewName);</span><br><span class="line">    //使用容器初始化视图</span><br><span class="line">    View result = applyLifecycleMethods(viewName, view);</span><br><span class="line">    return (view.checkResource(locale) ? result : null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、InternalResourceViewResolver的buildView方法"><a href="#7、InternalResourceViewResolver的buildView方法" class="headerlink" title="7、InternalResourceViewResolver的buildView方法"></a>7、InternalResourceViewResolver的buildView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected AbstractUrlBasedView buildView(String viewName) throws Exception &#123;</span><br><span class="line">    InternalResourceView view = (InternalResourceView) super.buildView(viewName);</span><br><span class="line">    //该属性为true，则一致以include方式获取资源</span><br><span class="line">    if (this.alwaysInclude != null) &#123;</span><br><span class="line">        view.setAlwaysInclude(this.alwaysInclude);</span><br><span class="line">    &#125;</span><br><span class="line">    //不允许循环转发</span><br><span class="line">    view.setPreventDispatchLoop(true);</span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、UrlBasedViewResolver的buildView方法"><a href="#8、UrlBasedViewResolver的buildView方法" class="headerlink" title="8、UrlBasedViewResolver的buildView方法"></a>8、UrlBasedViewResolver的buildView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected AbstractUrlBasedView buildView(String viewName) throws Exception &#123;</span><br><span class="line">    //创建InternalResourceView对象</span><br><span class="line">    AbstractUrlBasedView view = (AbstractUrlBasedView) BeanUtils.instantiateClass(getViewClass());</span><br><span class="line">    //设置视图的路径</span><br><span class="line">    view.setUrl(getPrefix() + viewName + getSuffix());</span><br><span class="line"></span><br><span class="line">    String contentType = getContentType();</span><br><span class="line">    if (contentType != null) &#123;</span><br><span class="line">        view.setContentType(contentType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    view.setRequestContextAttribute(getRequestContextAttribute());</span><br><span class="line">    view.setAttributesMap(getAttributesMap());</span><br><span class="line"></span><br><span class="line">    Boolean exposePathVariables = getExposePathVariables();</span><br><span class="line">    if (exposePathVariables != null) &#123;</span><br><span class="line">        view.setExposePathVariables(exposePathVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    Boolean exposeContextBeansAsAttributes = getExposeContextBeansAsAttributes();</span><br><span class="line">    if (exposeContextBeansAsAttributes != null) &#123;</span><br><span class="line">        view.setExposeContextBeansAsAttributes(exposeContextBeansAsAttributes);</span><br><span class="line">    &#125;</span><br><span class="line">    String[] exposedContextBeanNames = getExposedContextBeanNames();</span><br><span class="line">    if (exposedContextBeanNames != null) &#123;</span><br><span class="line">        view.setExposedContextBeanNames(exposedContextBeanNames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（七、1）AbstractView的render方法"><a href="#9、接（七、1）AbstractView的render方法" class="headerlink" title="9、接（七、1）AbstractView的render方法"></a>9、接（七、1）AbstractView的render方法</h4><p>InternalResourceView、RedirectView的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void render(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Rendering view with name &apos;&quot; + this.beanName + &quot;&apos; with model &quot; + model +</span><br><span class="line">            &quot; and static attributes &quot; + this.staticAttributes);</span><br><span class="line">    &#125;</span><br><span class="line">    //合并exposePathVariables、staticAttributes以及model</span><br><span class="line">    Map&lt;String, Object&gt; mergedModel = createMergedOutputModel(model, request, response);</span><br><span class="line">    //设置response头,解决IE bug</span><br><span class="line">    prepareResponse(request, response);</span><br><span class="line">    //</span><br><span class="line">    renderMergedOutputModel(mergedModel, getRequestToExpose(request), response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="10、InternalResourceView的renderMergedOutputModel方法"><a href="#10、InternalResourceView的renderMergedOutputModel方法" class="headerlink" title="10、InternalResourceView的renderMergedOutputModel方法"></a>10、InternalResourceView的renderMergedOutputModel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void renderMergedOutputModel(</span><br><span class="line">        Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    // Expose the model object as request attributes.</span><br><span class="line">    //将model的值添加到request中</span><br><span class="line">    exposeModelAsRequestAttributes(model, request);</span><br><span class="line"></span><br><span class="line">    // Expose helpers as request attributes, if any.</span><br><span class="line">    //空方法待子类实现</span><br><span class="line">    exposeHelpers(request);</span><br><span class="line"></span><br><span class="line">    // Determine the path for the request dispatcher.</span><br><span class="line">    //获取视图的url</span><br><span class="line">    String dispatcherPath = prepareForRendering(request, response);</span><br><span class="line"></span><br><span class="line">    // Obtain a RequestDispatcher for the target resource (typically a JSP).</span><br><span class="line">    //获取请求调度器</span><br><span class="line">    RequestDispatcher rd = getRequestDispatcher(request, dispatcherPath);</span><br><span class="line">    if (rd == null) &#123;</span><br><span class="line">        throw new ServletException(&quot;Could not get RequestDispatcher for [&quot; + getUrl() +</span><br><span class="line">                &quot;]: Check that the corresponding file exists within your web application archive!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If already included or response already committed, perform include, else forward.</span><br><span class="line">    if (useInclude(request, response)) &#123;</span><br><span class="line">        //设置视图的ContentType默认&quot;text/html;charset=ISO-8859-1&quot;</span><br><span class="line">        response.setContentType(getContentType());</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Including resource [&quot; + getUrl() + &quot;] in InternalResourceView &apos;&quot; + getBeanName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取包含资源</span><br><span class="line">        rd.include(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else &#123;</span><br><span class="line">        // Note: The forwarded resource is supposed to determine the content type itself.</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Forwarding to resource [&quot; + getUrl() + &quot;] in InternalResourceView &apos;&quot; + getBeanName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //转发请求</span><br><span class="line">        rd.forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、RedirectView的renderMergedOutputModel方法"><a href="#11、RedirectView的renderMergedOutputModel方法" class="headerlink" title="11、RedirectView的renderMergedOutputModel方法"></a>11、RedirectView的renderMergedOutputModel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void renderMergedOutputModel(Map&lt;String, Object&gt; model, HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response) throws IOException &#123;</span><br><span class="line">    //获取转发url及参数</span><br><span class="line">    String targetUrl = createTargetUrl(model, request);</span><br><span class="line">    //处理路径中的参数</span><br><span class="line">    targetUrl = updateTargetUrl(targetUrl, model, request, response);</span><br><span class="line">    //获取request中的重定向的参数，即flashAttributes</span><br><span class="line">    FlashMap flashMap = RequestContextUtils.getOutputFlashMap(request);</span><br><span class="line">    if (!CollectionUtils.isEmpty(flashMap)) &#123;</span><br><span class="line">        UriComponents uriComponents = UriComponentsBuilder.fromUriString(targetUrl).build();</span><br><span class="line">        //设置重定向url</span><br><span class="line">        flashMap.setTargetRequestPath(uriComponents.getPath());</span><br><span class="line">        //设置url中的参数</span><br><span class="line">        flashMap.addTargetRequestParams(uriComponents.getQueryParams());</span><br><span class="line">        FlashMapManager flashMapManager = RequestContextUtils.getFlashMapManager(request);</span><br><span class="line">        if (flashMapManager == null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;FlashMapManager not found despite output FlashMap having been set&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //默认flashMap存入session中</span><br><span class="line">        flashMapManager.saveOutputFlashMap(flashMap, request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    //发送重定向请求</span><br><span class="line">    sendRedirect(request, response, targetUrl, this.http10Compatible);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="八、异步任务"><a href="#八、异步任务" class="headerlink" title="八、异步任务"></a>八、异步任务</h3><h4 id="1、接（三、20）WebAsyncManager的setAsyncWebRequest方法"><a href="#1、接（三、20）WebAsyncManager的setAsyncWebRequest方法" class="headerlink" title="1、接（三、20）WebAsyncManager的setAsyncWebRequest方法"></a>1、接（三、20）WebAsyncManager的setAsyncWebRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void setAsyncWebRequest(final AsyncWebRequest asyncWebRequest) &#123;</span><br><span class="line">    Assert.notNull(asyncWebRequest, &quot;AsyncWebRequest must not be null&quot;);</span><br><span class="line">    Assert.state(!isConcurrentHandlingStarted(), &quot;Can&apos;t set AsyncWebRequest with concurrent handling in progress&quot;);</span><br><span class="line">    this.asyncWebRequest = asyncWebRequest;</span><br><span class="line">    //请求处理完成回调函数，移除request中WebAsyncManager</span><br><span class="line">    this.asyncWebRequest.addCompletionHandler(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            asyncWebRequest.removeAttribute(WebAsyncUtils.WEB_ASYNC_MANAGER_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、接（三-、22）CallableMethodReturnValueHandler的handleReturnValue方法"><a href="#2、接（三-、22）CallableMethodReturnValueHandler的handleReturnValue方法" class="headerlink" title="2、接（三 、22）CallableMethodReturnValueHandler的handleReturnValue方法"></a>2、接（三 、22）CallableMethodReturnValueHandler的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    if (returnValue == null) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Callable&lt;?&gt; callable = (Callable&lt;?&gt;) returnValue;</span><br><span class="line">    //处理异步任务</span><br><span class="line">    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、WebAsyncManager的startCallableProcessing方法"><a href="#3、WebAsyncManager的startCallableProcessing方法" class="headerlink" title="3、WebAsyncManager的startCallableProcessing方法"></a>3、WebAsyncManager的startCallableProcessing方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span><br><span class="line">public void startCallableProcessing(Callable&lt;?&gt; callable, Object... processingContext) throws Exception &#123;</span><br><span class="line">    Assert.notNull(callable, &quot;Callable must not be null&quot;);</span><br><span class="line">    //处理异步任务</span><br><span class="line">    startCallableProcessing(new WebAsyncTask(callable), processingContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public void startCallableProcessing(final WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext) throws Exception &#123;</span><br><span class="line">    Assert.notNull(webAsyncTask, &quot;WebAsyncTask must not be null&quot;);</span><br><span class="line">    Assert.state(this.asyncWebRequest != null, &quot;AsyncWebRequest must not be null&quot;);</span><br><span class="line">    //设置超时时间</span><br><span class="line">    Long timeout = webAsyncTask.getTimeout();</span><br><span class="line">    if (timeout != null) &#123;</span><br><span class="line">        this.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取异步处理线程池</span><br><span class="line">    AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class="line">    if (executor != null) &#123;</span><br><span class="line">        this.taskExecutor = executor;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加拦截器</span><br><span class="line">    List&lt;CallableProcessingInterceptor&gt; interceptors = new ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class="line">    interceptors.add(webAsyncTask.getInterceptor());</span><br><span class="line">    interceptors.addAll(this.callableInterceptors.values());</span><br><span class="line">    interceptors.add(timeoutCallableInterceptor);</span><br><span class="line"></span><br><span class="line">    final Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class="line">    //创建拦截器链</span><br><span class="line">    final CallableInterceptorChain interceptorChain = new CallableInterceptorChain(interceptors);</span><br><span class="line">    //添加超时回调函数</span><br><span class="line">    this.asyncWebRequest.addTimeoutHandler(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            logger.debug(&quot;Processing timeout&quot;);</span><br><span class="line">            Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class="line">            if (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class="line">                setConcurrentResultAndDispatch(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //添加请求处理完成回调函数</span><br><span class="line">    this.asyncWebRequest.addCompletionHandler(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //执行拦截器的beforeConcurrentHandling方法</span><br><span class="line">    interceptorChain.applyBeforeConcurrentHandling(this.asyncWebRequest, callable);</span><br><span class="line">    //设置开始处理异步任务标识</span><br><span class="line">    startAsyncProcessing(processingContext);</span><br><span class="line"></span><br><span class="line">    this.taskExecutor.submit(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            Object result = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                //执行拦截器preProcess方法</span><br><span class="line">                //如RequestBindingInterceptor，将request的Locale及requestAttributes绑定到当前线程</span><br><span class="line">                interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class="line">                //执行异步任务</span><br><span class="line">                result = callable.call();</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                result = ex;</span><br><span class="line">            &#125;</span><br><span class="line">            finally &#123;</span><br><span class="line">                //执行拦截器postProcess方法</span><br><span class="line">                //如RequestBindingInterceptor，从当前线程将移除request的Locale及requestAttributes</span><br><span class="line">                result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class="line">            &#125;</span><br><span class="line">            //设置处理结果</span><br><span class="line">            setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、WebAsyncManager的startCallableProcessing方法"><a href="#4、WebAsyncManager的startCallableProcessing方法" class="headerlink" title="4、WebAsyncManager的startCallableProcessing方法"></a>4、WebAsyncManager的startCallableProcessing方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void startAsyncProcessing(Object[] processingContext) &#123;</span><br><span class="line">    //清除处理结果</span><br><span class="line">    clearConcurrentResult();</span><br><span class="line">    this.concurrentResultContext = processingContext;</span><br><span class="line">    //设置开始处理异步任务标识</span><br><span class="line">    this.asyncWebRequest.startAsync();</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        HttpServletRequest request = this.asyncWebRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        String requestUri = urlPathHelper.getRequestUri(request);</span><br><span class="line">        logger.debug(&quot;Concurrent handling starting for &quot; + request.getMethod() + &quot; [&quot; + requestUri + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、StandardServletAsyncWebRequest的startAsync方法"><a href="#5、StandardServletAsyncWebRequest的startAsync方法" class="headerlink" title="5、StandardServletAsyncWebRequest的startAsync方法"></a>5、StandardServletAsyncWebRequest的startAsync方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void startAsync() &#123;</span><br><span class="line">    Assert.state(getRequest().isAsyncSupported(),</span><br><span class="line">            &quot;Async support must be enabled on a servlet and for all filters involved &quot; +</span><br><span class="line">            &quot;in async request processing. This is done in Java code using the Servlet API &quot; +</span><br><span class="line">            &quot;or by adding \&quot;&lt;async-supported&gt;true&lt;/async-supported&gt;\&quot; to servlet and &quot; +</span><br><span class="line">            &quot;filter declarations in web.xml.&quot;);</span><br><span class="line">    Assert.state(!isAsyncComplete(), &quot;Async processing has already completed&quot;);</span><br><span class="line"></span><br><span class="line">    if (isAsyncStarted()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建AsyncContextImpl</span><br><span class="line">    this.asyncContext = getRequest().startAsync(getRequest(), getResponse());</span><br><span class="line">    //将StandardServletAsyncWebRequest自身注册为监听器</span><br><span class="line">    this.asyncContext.addListener(this);</span><br><span class="line">    if (this.timeout != null) &#123;</span><br><span class="line">        this.asyncContext.setTimeout(this.timeout);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、WebAsyncManager的setConcurrentResultAndDispatch方法"><a href="#6、WebAsyncManager的setConcurrentResultAndDispatch方法" class="headerlink" title="6、WebAsyncManager的setConcurrentResultAndDispatch方法"></a>6、WebAsyncManager的setConcurrentResultAndDispatch方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private void setConcurrentResultAndDispatch(Object result) &#123;</span><br><span class="line">    synchronized (WebAsyncManager.this) &#123;</span><br><span class="line">        //已处理完成</span><br><span class="line">        if (hasConcurrentResult()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置处理结果</span><br><span class="line">        this.concurrentResult = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.asyncWebRequest.isAsyncComplete()) &#123;</span><br><span class="line">        logger.error(&quot;Could not complete async processing due to timeout or network error&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Concurrent result value [&quot; + this.concurrentResult +</span><br><span class="line">                &quot;] - dispatching request to resume processing&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //再次发起该请求</span><br><span class="line">    this.asyncWebRequest.dispatch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法"><a href="#7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法" class="headerlink" title="7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法"></a>7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ServletInvocableHandlerMethod wrapConcurrentResult(Object result) &#123;</span><br><span class="line">    return new ConcurrentResultHandlerMethod(result, new ConcurrentResultMethodParameter(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、实例化ConcurrentResultHandlerMethod"><a href="#8、实例化ConcurrentResultHandlerMethod" class="headerlink" title="8、实例化ConcurrentResultHandlerMethod"></a>8、实例化ConcurrentResultHandlerMethod</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentResultHandlerMethod(final Object result, ConcurrentResultMethodParameter returnType) &#123;</span><br><span class="line">    //父类构造器</span><br><span class="line">    super(new Callable&lt;Object&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Object call() throws Exception &#123;</span><br><span class="line">            if (result instanceof Exception) &#123;</span><br><span class="line">                throw (Exception) result;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (result instanceof Throwable) &#123;</span><br><span class="line">                throw new NestedServletException(&quot;Async processing failed&quot;, (Throwable) result);</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, CALLABLE_METHOD);</span><br><span class="line">    //设置返回值处理器</span><br><span class="line">    setHandlerMethodReturnValueHandlers(ServletInvocableHandlerMethod.this.returnValueHandlers);</span><br><span class="line">    this.returnType = returnType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public ServletInvocableHandlerMethod(Object handler, Method method) &#123;</span><br><span class="line">    //父类构造器</span><br><span class="line">    super(handler, method);</span><br><span class="line">    //获取method的@ResponseStatus注解</span><br><span class="line">    initResponseStatus();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后的invokeAndHandle方法调用的是call()方法</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;p&gt;web.xml配置文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td 
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码JdbcTemplate</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81JdbcTemplate/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码JdbcTemplate/</id>
    <published>2018-06-27T13:10:29.023Z</published>
    <updated>2018-06-28T14:08:09.844Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>spring配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;  </span><br><span class="line">&lt;beans  </span><br><span class="line">    xmlns=&quot;http://www.springframework.org/schema/beans&quot;  </span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  </span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd&quot;&gt;  </span><br><span class="line">      </span><br><span class="line">    &lt;!-- 1.配置数据源：DriverManagerDataSource --&gt;  </span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;&gt;  </span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;oracle.jdbc.OracleDriver&quot;/&gt;  </span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;jdbc:oracle:thin:@localhost:1521:orcl&quot;/&gt;  </span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;scott&quot;/&gt;  </span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;tiger&quot;/&gt;  </span><br><span class="line">    &lt;/bean&gt;  </span><br><span class="line">    &lt;!--2.配置JdbcTemplate --&gt;  </span><br><span class="line">    &lt;bean id=&quot;jdbcTemplate&quot; class=&quot;org.springframework.jdbc.core.JdbcTemplate&quot;&gt;  </span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;  </span><br><span class="line">    &lt;/bean&gt;  </span><br><span class="line">    &lt;!-- 3.为dao接口注入jdbcTemplate属性 --&gt;  </span><br><span class="line">    &lt;bean id=&quot;userDao&quot; class=&quot;com.wzj.dao.impl.UserDaoImpl&quot;&gt;  </span><br><span class="line">        &lt;property name=&quot;jdbcTemplate&quot; ref=&quot;jdbcTemplate&quot;/&gt;  </span><br><span class="line">    &lt;/bean&gt;  </span><br><span class="line">      </span><br><span class="line">    &lt;!-- 业务层 、Struts2、事务等同往常一样配置--&gt;  </span><br><span class="line">  </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><p>使用示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class UserDaoImpl implements UserDao&#123;  </span><br><span class="line">    //定义JdbcTemplate属性  </span><br><span class="line">    private JdbcTemplate jdbcTemplate;  </span><br><span class="line">    //省略get、set方法  </span><br><span class="line">    @Override  </span><br><span class="line">    public User selectUserByName(String name) &#123;  </span><br><span class="line">        //定义RowMapper的对象，可以将数据中的每一行数据封装成用户定义的类.  </span><br><span class="line">        //RowMapper是接口，这里创建了一个匿名类并实现了其中的方法  </span><br><span class="line">        RowMapper&lt;User&gt; row=new RowMapper&lt;User&gt;() &#123;  </span><br><span class="line">            @Override  </span><br><span class="line">            public User mapRow(ResultSet rs, int arg1) throws SQLException &#123;  </span><br><span class="line">                User user=new User();  </span><br><span class="line">                user.setUserId(Integer.parseInt(rs.getString(&quot;USERID&quot;)));  </span><br><span class="line">                user.setName(rs.getString(&quot;USERNAME&quot;));  </span><br><span class="line">                user.setPassword(rs.getString(&quot;USERPWD&quot;));  </span><br><span class="line">                return user;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;;   </span><br><span class="line">        String sql=&quot;select * from myuser1 where username=?&quot;;  </span><br><span class="line">        //执行查询  </span><br><span class="line">        User user=jdbcTemplate.queryForObject(sql, new Object[]&#123;name&#125;, row);  </span><br><span class="line">        return user;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public int insert(User user) &#123;  </span><br><span class="line">        String sql=&quot;insert into myuser1 values(user_sequence.nextVal,?,?)&quot;;  </span><br><span class="line">        //执行插入  </span><br><span class="line">        int result=jdbcTemplate.update(sql, new Object[]&#123;user.getName(),user.getPassword()&#125;);  </span><br><span class="line">        return result;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public int delete(int userId) &#123;  </span><br><span class="line">        String sql=&quot;delete from myuser1 where userid=?&quot;;  </span><br><span class="line">        //执行修改  </span><br><span class="line">        int result=jdbcTemplate.update(sql, new Object[]&#123;userId&#125;);  </span><br><span class="line">        return result;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public int update(User user) &#123;  </span><br><span class="line">        String sql=&quot;update myuser1 set username=?,userpwd=? where userid=?&quot;;  </span><br><span class="line">        //执行删除  </span><br><span class="line">        int result=jdbcTemplate.update(sql, new Object[]&#123;user.getName(),user.getPassword(),user.getUserId()&#125;);  </span><br><span class="line">        return result;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="一、select执行过程"><a href="#一、select执行过程" class="headerlink" title="一、select执行过程"></a>一、select执行过程</h3><h4 id="1、JdbcTemplate的queryForObject方法"><a href="#1、JdbcTemplate的queryForObject方法" class="headerlink" title="1、JdbcTemplate的queryForObject方法"></a>1、JdbcTemplate的queryForObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;T&gt; T queryForObject(String sql, Object[] args, RowMapper&lt;T&gt; rowMapper) throws DataAccessException &#123;</span><br><span class="line">    List&lt;T&gt; results = query(sql, args, new RowMapperResultSetExtractor&lt;T&gt;(rowMapper, 1));</span><br><span class="line">    //返回第一对象</span><br><span class="line">    return DataAccessUtils.requiredSingleResult(results);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;T&gt; T query(String sql, Object[] args, ResultSetExtractor&lt;T&gt; rse) throws DataAccessException &#123;</span><br><span class="line">    return query(sql, newArgPreparedStatementSetter(args), rse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、JdbcTemplate的query方法"><a href="#2、JdbcTemplate的query方法" class="headerlink" title="2、JdbcTemplate的query方法"></a>2、JdbcTemplate的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;T&gt; T query(String sql, PreparedStatementSetter pss, ResultSetExtractor&lt;T&gt; rse) throws DataAccessException &#123;</span><br><span class="line">    return query(new SimplePreparedStatementCreator(sql), pss, rse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T query(</span><br><span class="line">        PreparedStatementCreator psc, final PreparedStatementSetter pss, final ResultSetExtractor&lt;T&gt; rse)</span><br><span class="line">        throws DataAccessException &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(rse, &quot;ResultSetExtractor must not be null&quot;);</span><br><span class="line">    logger.debug(&quot;Executing prepared SQL query&quot;);</span><br><span class="line"></span><br><span class="line">    return execute(psc, new PreparedStatementCallback&lt;T&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public T doInPreparedStatement(PreparedStatement ps) throws SQLException &#123;</span><br><span class="line">            ResultSet rs = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (pss != null) &#123;</span><br><span class="line">                    //设置参数</span><br><span class="line">                    pss.setValues(ps);</span><br><span class="line">                &#125;</span><br><span class="line">                //执行sql</span><br><span class="line">                rs = ps.executeQuery();</span><br><span class="line">                ResultSet rsToUse = rs;</span><br><span class="line">                //转换器，对数据库clob、 blob数据型进行操作</span><br><span class="line">                if (nativeJdbcExtractor != null) &#123;</span><br><span class="line">                    rsToUse = nativeJdbcExtractor.getNativeResultSet(rs);</span><br><span class="line">                &#125;</span><br><span class="line">                //解析结果集</span><br><span class="line">                return rse.extractData(rsToUse);</span><br><span class="line">            &#125;</span><br><span class="line">            finally &#123;</span><br><span class="line">                JdbcUtils.closeResultSet(rs);</span><br><span class="line">                if (pss instanceof ParameterDisposer) &#123;</span><br><span class="line">                    ((ParameterDisposer) pss).cleanupParameters();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、JdbcTemplate的execute方法"><a href="#3、JdbcTemplate的execute方法" class="headerlink" title="3、JdbcTemplate的execute方法"></a>3、JdbcTemplate的execute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;T&gt; T execute(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action)</span><br><span class="line">        throws DataAccessException &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(psc, &quot;PreparedStatementCreator must not be null&quot;);</span><br><span class="line">    Assert.notNull(action, &quot;Callback object must not be null&quot;);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        String sql = getSql(psc);</span><br><span class="line">        logger.debug(&quot;Executing prepared SQL statement&quot; + (sql != null ? &quot; [&quot; + sql + &quot;]&quot; : &quot;&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    //获取连接</span><br><span class="line">    Connection con = DataSourceUtils.getConnection(getDataSource());</span><br><span class="line">    PreparedStatement ps = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Connection conToUse = con;</span><br><span class="line">        if (this.nativeJdbcExtractor != null &amp;&amp;</span><br><span class="line">                this.nativeJdbcExtractor.isNativeConnectionNecessaryForNativePreparedStatements()) &#123;</span><br><span class="line">            //获取原始的JDBC连接</span><br><span class="line">            conToUse = this.nativeJdbcExtractor.getNativeConnection(con);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建一个PreparedStatement</span><br><span class="line">        ps = psc.createPreparedStatement(conToUse);</span><br><span class="line">        //设置默认查询边界及超时时间</span><br><span class="line">        applyStatementSettings(ps);</span><br><span class="line">        PreparedStatement psToUse = ps;</span><br><span class="line">        if (this.nativeJdbcExtractor != null) &#123;</span><br><span class="line">            //获取原始的JDBC的PreparedStatement</span><br><span class="line">            psToUse = this.nativeJdbcExtractor.getNativePreparedStatement(ps);</span><br><span class="line">        &#125;</span><br><span class="line">        //执行sql</span><br><span class="line">        T result = action.doInPreparedStatement(psToUse);</span><br><span class="line">        //处理警告,如数据截断异常</span><br><span class="line">        handleWarnings(ps);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (SQLException ex) &#123;</span><br><span class="line">        // Release Connection early, to avoid potential connection pool deadlock</span><br><span class="line">        // in the case when the exception translator hasn&apos;t been initialized yet.</span><br><span class="line">        if (psc instanceof ParameterDisposer) &#123;</span><br><span class="line">            ((ParameterDisposer) psc).cleanupParameters();</span><br><span class="line">        &#125;</span><br><span class="line">        String sql = getSql(psc);</span><br><span class="line">        psc = null;</span><br><span class="line">        JdbcUtils.closeStatement(ps);</span><br><span class="line">        ps = null;</span><br><span class="line">        DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">        con = null;</span><br><span class="line">        throw getExceptionTranslator().translate(&quot;PreparedStatementCallback&quot;, sql, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        if (psc instanceof ParameterDisposer) &#123;</span><br><span class="line">            ((ParameterDisposer) psc).cleanupParameters();</span><br><span class="line">        &#125;</span><br><span class="line">        JdbcUtils.closeStatement(ps);</span><br><span class="line">        DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DataSourceUtils的getConnection方法"><a href="#4、DataSourceUtils的getConnection方法" class="headerlink" title="4、DataSourceUtils的getConnection方法"></a>4、DataSourceUtils的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static Connection getConnection(DataSource dataSource) throws CannotGetJdbcConnectionException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取连接</span><br><span class="line">        return doGetConnection(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (SQLException ex) &#123;</span><br><span class="line">        throw new CannotGetJdbcConnectionException(&quot;Could not get JDBC Connection&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DataSourceUtils的doGetConnection方法"><a href="#5、DataSourceUtils的doGetConnection方法" class="headerlink" title="5、DataSourceUtils的doGetConnection方法"></a>5、DataSourceUtils的doGetConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public static Connection doGetConnection(DataSource dataSource) throws SQLException &#123;</span><br><span class="line">    Assert.notNull(dataSource, &quot;No DataSource specified&quot;);</span><br><span class="line">    //获取本线程Connection容器</span><br><span class="line">    ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);</span><br><span class="line">    //本线程是否激活事务</span><br><span class="line">    if (conHolder != null &amp;&amp; (conHolder.hasConnection() || conHolder.isSynchronizedWithTransaction())) &#123;</span><br><span class="line">        //当前获取次数加一</span><br><span class="line">        conHolder.requested();</span><br><span class="line">        //没有连接获取新连接</span><br><span class="line">        if (!conHolder.hasConnection()) &#123;</span><br><span class="line">            logger.debug(&quot;Fetching resumed JDBC Connection from DataSource&quot;);</span><br><span class="line">            conHolder.setConnection(dataSource.getConnection());</span><br><span class="line">        &#125;</span><br><span class="line">        //获取容器中的连接，同一事务中使用同一个连接</span><br><span class="line">        return conHolder.getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    // Else we either got no holder or an empty thread-bound holder here.</span><br><span class="line"></span><br><span class="line">    logger.debug(&quot;Fetching JDBC Connection from DataSource&quot;);</span><br><span class="line">    //获取连接</span><br><span class="line">    Connection con = dataSource.getConnection();</span><br><span class="line">    //事务已开启</span><br><span class="line">    if (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</span><br><span class="line">        logger.debug(&quot;Registering transaction synchronization for JDBC Connection&quot;);</span><br><span class="line">        // Use same Connection for further JDBC actions within the transaction.</span><br><span class="line">        // Thread-bound object will get removed by synchronization at transaction completion.</span><br><span class="line">        ConnectionHolder holderToUse = conHolder;</span><br><span class="line">        if (holderToUse == null) &#123;</span><br><span class="line">            holderToUse = new ConnectionHolder(con);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            holderToUse.setConnection(con);</span><br><span class="line">        &#125;</span><br><span class="line">        holderToUse.requested();</span><br><span class="line">        //添加回调函数释放资源</span><br><span class="line">        TransactionSynchronizationManager.registerSynchronization(</span><br><span class="line">                new ConnectionSynchronization(holderToUse, dataSource));</span><br><span class="line">        //设置该连接已被事务获取</span><br><span class="line">        holderToUse.setSynchronizedWithTransaction(true);</span><br><span class="line">        //新增的连接容器</span><br><span class="line">        if (holderToUse != conHolder) &#123;</span><br><span class="line">            //连接容器加入本线程变量</span><br><span class="line">            TransactionSynchronizationManager.bindResource(dataSource, holderToUse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return con;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（一、3）DataSourceUtils的releaseConnection方法"><a href="#6、接（一、3）DataSourceUtils的releaseConnection方法" class="headerlink" title="6、接（一、3）DataSourceUtils的releaseConnection方法"></a>6、接（一、3）DataSourceUtils的releaseConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public static void releaseConnection(Connection con, DataSource dataSource) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //关闭连接</span><br><span class="line">        doReleaseConnection(con, dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (SQLException ex) &#123;</span><br><span class="line">        logger.debug(&quot;Could not close JDBC Connection&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        logger.debug(&quot;Unexpected exception on closing JDBC Connection&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、DataSourceUtils的doReleaseConnection方法"><a href="#7、DataSourceUtils的doReleaseConnection方法" class="headerlink" title="7、DataSourceUtils的doReleaseConnection方法"></a>7、DataSourceUtils的doReleaseConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static void doReleaseConnection(Connection con, DataSource dataSource) throws SQLException &#123;</span><br><span class="line">    if (con == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (dataSource != null) &#123;</span><br><span class="line">        //当前线程存在事务，该线程目前要用同一个连接，释放则获取次数减一</span><br><span class="line">        ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);</span><br><span class="line">        if (conHolder != null &amp;&amp; connectionEquals(conHolder, con)) &#123;</span><br><span class="line">            // It&apos;s the transactional Connection: Don&apos;t close it.</span><br><span class="line">            conHolder.released();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.debug(&quot;Returning JDBC Connection to DataSource&quot;);</span><br><span class="line">    //关闭连接</span><br><span class="line">    doCloseConnection(con, dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（一、2）ArgumentPreparedStatementSetter的setValues方法"><a href="#6、接（一、2）ArgumentPreparedStatementSetter的setValues方法" class="headerlink" title="6、接（一、2）ArgumentPreparedStatementSetter的setValues方法"></a>6、接（一、2）ArgumentPreparedStatementSetter的setValues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setValues(PreparedStatement ps) throws SQLException &#123;</span><br><span class="line">    if (this.args != null) &#123;</span><br><span class="line">        for (int i = 0; i &lt; this.args.length; i++) &#123;</span><br><span class="line">            Object arg = this.args[i];</span><br><span class="line">            //设置参数</span><br><span class="line">            doSetValue(ps, i + 1, arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ArgumentPreparedStatementSetter的doSetValue方法"><a href="#7、ArgumentPreparedStatementSetter的doSetValue方法" class="headerlink" title="7、ArgumentPreparedStatementSetter的doSetValue方法"></a>7、ArgumentPreparedStatementSetter的doSetValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected void doSetValue(PreparedStatement ps, int parameterPosition, Object argValue) throws SQLException &#123;</span><br><span class="line">    //设置参数</span><br><span class="line">    if (argValue instanceof SqlParameterValue) &#123;</span><br><span class="line">        SqlParameterValue paramValue = (SqlParameterValue) argValue;</span><br><span class="line">        StatementCreatorUtils.setParameterValue(ps, parameterPosition, paramValue, paramValue.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        StatementCreatorUtils.setParameterValue(ps, parameterPosition, SqlTypeValue.TYPE_UNKNOWN, argValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（一、2）RowMapperResultSetExtractor的extractData方法"><a href="#8、接（一、2）RowMapperResultSetExtractor的extractData方法" class="headerlink" title="8、接（一、2）RowMapperResultSetExtractor的extractData方法"></a>8、接（一、2）RowMapperResultSetExtractor的extractData方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public List&lt;T&gt; extractData(ResultSet rs) throws SQLException &#123;</span><br><span class="line">    List&lt;T&gt; results = (this.rowsExpected &gt; 0 ? new ArrayList&lt;T&gt;(this.rowsExpected) : new ArrayList&lt;T&gt;());</span><br><span class="line">    int rowNum = 0;</span><br><span class="line">    while (rs.next()) &#123;</span><br><span class="line">        //解析结果</span><br><span class="line">        results.add(this.rowMapper.mapRow(rs, rowNum++));</span><br><span class="line">    &#125;</span><br><span class="line">    return results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、RowMapper的mapRow方法"><a href="#9、RowMapper的mapRow方法" class="headerlink" title="9、RowMapper的mapRow方法"></a>9、RowMapper的mapRow方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override  </span><br><span class="line">public User mapRow(ResultSet rs, int arg1) throws SQLException &#123;  </span><br><span class="line">    User user=new User();  </span><br><span class="line">    user.setUserId(Integer.parseInt(rs.getString(&quot;USERID&quot;)));  </span><br><span class="line">    user.setName(rs.getString(&quot;USERNAME&quot;));  </span><br><span class="line">    user.setPassword(rs.getString(&quot;USERPWD&quot;));  </span><br><span class="line">    return user;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、update执行过程"><a href="#二、update执行过程" class="headerlink" title="二、update执行过程"></a>二、update执行过程</h3><h4 id="1、JdbcTemplate的update方法"><a href="#1、JdbcTemplate的update方法" class="headerlink" title="1、JdbcTemplate的update方法"></a>1、JdbcTemplate的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int update(String sql, Object... args) throws DataAccessException &#123;</span><br><span class="line">    return update(sql, newArgPreparedStatementSetter(args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int update(String sql, PreparedStatementSetter pss) throws DataAccessException &#123;</span><br><span class="line">    return update(new SimplePreparedStatementCreator(sql), pss);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected int update(final PreparedStatementCreator psc, final PreparedStatementSetter pss)</span><br><span class="line">        throws DataAccessException &#123;</span><br><span class="line"></span><br><span class="line">    logger.debug(&quot;Executing prepared SQL update&quot;);</span><br><span class="line">    return execute(psc, new PreparedStatementCallback&lt;Integer&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Integer doInPreparedStatement(PreparedStatement ps) throws SQLException &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (pss != null) &#123;</span><br><span class="line">                    //设置参数</span><br><span class="line">                    pss.setValues(ps);</span><br><span class="line">                &#125;</span><br><span class="line">                //执行sql</span><br><span class="line">                int rows = ps.executeUpdate();</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;SQL update affected &quot; + rows + &quot; rows&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                return rows;</span><br><span class="line">            &#125;</span><br><span class="line">            finally &#123;</span><br><span class="line">                if (pss instanceof ParameterDisposer) &#123;</span><br><span class="line">                    ((ParameterDisposer) pss).cleanupParameters();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、JdbcTemplate的execute方法"><a href="#2、JdbcTemplate的execute方法" class="headerlink" title="2、JdbcTemplate的execute方法"></a>2、JdbcTemplate的execute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;T&gt; T execute(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action)</span><br><span class="line">        throws DataAccessException &#123;</span><br><span class="line"></span><br><span class="line">    Assert.notNull(psc, &quot;PreparedStatementCreator must not be null&quot;);</span><br><span class="line">    Assert.notNull(action, &quot;Callback object must not be null&quot;);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        String sql = getSql(psc);</span><br><span class="line">        logger.debug(&quot;Executing prepared SQL statement&quot; + (sql != null ? &quot; [&quot; + sql + &quot;]&quot; : &quot;&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    //获取连接</span><br><span class="line">    Connection con = DataSourceUtils.getConnection(getDataSource());</span><br><span class="line">    PreparedStatement ps = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Connection conToUse = con;</span><br><span class="line">        if (this.nativeJdbcExtractor != null &amp;&amp;</span><br><span class="line">                this.nativeJdbcExtractor.isNativeConnectionNecessaryForNativePreparedStatements()) &#123;</span><br><span class="line">            conToUse = this.nativeJdbcExtractor.getNativeConnection(con);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建PreparedStatement</span><br><span class="line">        ps = psc.createPreparedStatement(conToUse);</span><br><span class="line">        applyStatementSettings(ps);</span><br><span class="line">        PreparedStatement psToUse = ps;</span><br><span class="line">        if (this.nativeJdbcExtractor != null) &#123;</span><br><span class="line">            psToUse = this.nativeJdbcExtractor.getNativePreparedStatement(ps);</span><br><span class="line">        &#125;</span><br><span class="line">        //执行sql</span><br><span class="line">        T result = action.doInPreparedStatement(psToUse);</span><br><span class="line">        handleWarnings(ps);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (SQLException ex) &#123;</span><br><span class="line">        // Release Connection early, to avoid potential connection pool deadlock</span><br><span class="line">        // in the case when the exception translator hasn&apos;t been initialized yet.</span><br><span class="line">        if (psc instanceof ParameterDisposer) &#123;</span><br><span class="line">            ((ParameterDisposer) psc).cleanupParameters();</span><br><span class="line">        &#125;</span><br><span class="line">        String sql = getSql(psc);</span><br><span class="line">        psc = null;</span><br><span class="line">        JdbcUtils.closeStatement(ps);</span><br><span class="line">        ps = null;</span><br><span class="line">        DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">        con = null;</span><br><span class="line">        throw getExceptionTranslator().translate(&quot;PreparedStatementCallback&quot;, sql, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        if (psc instanceof ParameterDisposer) &#123;</span><br><span class="line">            ((ParameterDisposer) psc).cleanupParameters();</span><br><span class="line">        &#125;</span><br><span class="line">        JdbcUtils.closeStatement(ps);</span><br><span class="line">        DataSourceUtils.releaseConnection(con, getDataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;p&gt;spring配置文件&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td c
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码ClassPathXmlApplicationContext、AnnotationConfigApplicationContext</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81ClassPathXmlApplicationContext%E5%92%8CAnnotationConfigApplicationContext/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码ClassPathXmlApplicationContext和AnnotationConfigApplicationContext/</id>
    <published>2018-06-27T13:10:29.018Z</published>
    <updated>2018-06-28T14:07:59.622Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、ClassPathXmlApplicationContext容器启动"><a href="#一、ClassPathXmlApplicationContext容器启动" class="headerlink" title="一、ClassPathXmlApplicationContext容器启动"></a>一、ClassPathXmlApplicationContext容器启动</h3><h4 id="1、实例化ClassPathXmlApplicationContext"><a href="#1、实例化ClassPathXmlApplicationContext" class="headerlink" title="1、实例化ClassPathXmlApplicationContext"></a>1、实例化ClassPathXmlApplicationContext</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathXmlApplicationContext(String configLocation) throws BeansException &#123;</span><br><span class="line">    this(new String[] &#123;configLocation&#125;, true, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathXmlApplicationContext(String... configLocations) throws BeansException &#123;</span><br><span class="line">    this(configLocations, true, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line">    super(parent);</span><br><span class="line">    //获取配置文件</span><br><span class="line">    setConfigLocations(configLocations);</span><br><span class="line">    if (refresh) &#123;</span><br><span class="line">        //启动容器</span><br><span class="line">        refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法"><a href="#2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法" class="headerlink" title="2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法"></a>2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void setConfigLocations(String... locations) &#123;</span><br><span class="line">    if (locations != null) &#123;</span><br><span class="line">        Assert.noNullElements(locations, &quot;Config locations must not be null&quot;);</span><br><span class="line">        this.configLocations = new String[locations.length];</span><br><span class="line">        //获取配置文件</span><br><span class="line">        for (int i = 0; i &lt; locations.length; i++) &#123;</span><br><span class="line">            this.configLocations[i] = resolvePath(locations[i]).trim();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        this.configLocations = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、接（一、1）AbstractApplicationContext的refresh方法"><a href="#3、接（一、1）AbstractApplicationContext的refresh方法" class="headerlink" title="3、接（一、1）AbstractApplicationContext的refresh方法"></a>3、接（一、1）AbstractApplicationContext的refresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        // Prepare this context for refreshing.</span><br><span class="line">        //准备刷新上下文环境</span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        // Tell the subclass to refresh the internal bean factory.</span><br><span class="line">        //初始化BeanFactory，并读取配置文件</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        // Prepare the bean factory for use in this context.</span><br><span class="line">        //对BeanFactory进行功能填充</span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Allows post-processing of the bean factory in context subclasses.</span><br><span class="line">            //空方法待子类实现</span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Invoke factory processors registered as beans in the context.</span><br><span class="line">            //激活BeanFactory处理器</span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Register bean processors that intercept bean creation.</span><br><span class="line">            //注册拦截bean的处理器</span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Initialize message source for this context.</span><br><span class="line">            //初始化国际化处理</span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            // Initialize event multicaster for this context.</span><br><span class="line">            //初始化应用消息广播器</span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            // Initialize other special beans in specific context subclasses.</span><br><span class="line">            //初始化其他特殊bean，留待子类实现</span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            // Check for listener beans and register them.</span><br><span class="line">            //注册监听器</span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            // Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">            //初始化剩下的单例（非懒加载的）</span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Last step: publish corresponding event.</span><br><span class="line">            //完成刷新过程</span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt&quot;, ex);</span><br><span class="line"></span><br><span class="line">            // Destroy already created singletons to avoid dangling resources.</span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            // Reset &apos;active&apos; flag.</span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            // Propagate exception to caller.</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AbstractApplicationContext的prepareRefresh方法"><a href="#4、AbstractApplicationContext的prepareRefresh方法" class="headerlink" title="4、AbstractApplicationContext的prepareRefresh方法"></a>4、AbstractApplicationContext的prepareRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">protected void prepareRefresh() &#123;</span><br><span class="line">    this.startupDate = System.currentTimeMillis();</span><br><span class="line">    //容器激活</span><br><span class="line">    this.active.set(true);</span><br><span class="line"></span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Refreshing &quot; + this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize any placeholder property sources in the context environment</span><br><span class="line">    //待子类实现，处理个性化的属性</span><br><span class="line">    initPropertySources();</span><br><span class="line"></span><br><span class="line">    // Validate that all properties marked as required are resolvable</span><br><span class="line">    // see ConfigurablePropertyResolver#setRequiredProperties</span><br><span class="line">    //验证需要的属性文件是否都已放入环境中</span><br><span class="line">    getEnvironment().validateRequiredProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法"><a href="#5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法" class="headerlink" title="5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法"></a>5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">    refreshBeanFactory();</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    return beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AbstractRefreshableApplicationContext的refreshBeanFactory方法"><a href="#6、AbstractRefreshableApplicationContext的refreshBeanFactory方法" class="headerlink" title="6、AbstractRefreshableApplicationContext的refreshBeanFactory方法"></a>6、AbstractRefreshableApplicationContext的refreshBeanFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">    //关闭已有的BeanFactory</span><br><span class="line">    if (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //创建DefaultListableBeanFactory</span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        //设置序列化id</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        //设置是否允许循环依赖、覆盖</span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        //加载配置文件，</span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">            this.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、AbstractXmlApplicationContext的loadBeanDefinitions方法"><a href="#7、AbstractXmlApplicationContext的loadBeanDefinitions方法" class="headerlink" title="7、AbstractXmlApplicationContext的loadBeanDefinitions方法"></a>7、AbstractXmlApplicationContext的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">    //关闭已有的BeanFactory</span><br><span class="line">    if (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //创建DefaultListableBeanFactory</span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        //设置序列化id</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        //设置是否允许循环依赖、覆盖</span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        //加载配置文件，</span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">            this.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、AbstractXmlApplicationContext的loadBeanDefinitions方法"><a href="#8、AbstractXmlApplicationContext的loadBeanDefinitions方法" class="headerlink" title="8、AbstractXmlApplicationContext的loadBeanDefinitions方法"></a>8、AbstractXmlApplicationContext的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123;</span><br><span class="line">    // Create a new XmlBeanDefinitionReader for the given BeanFactory.</span><br><span class="line">    //创建xml加载器</span><br><span class="line">    XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">    // Configure the bean definition reader with this context&apos;s</span><br><span class="line">    // resource loading environment.</span><br><span class="line">    beanDefinitionReader.setEnvironment(this.getEnvironment());</span><br><span class="line">    beanDefinitionReader.setResourceLoader(this);</span><br><span class="line">    beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this));</span><br><span class="line"></span><br><span class="line">    // Allow a subclass to provide custom initialization of the reader,</span><br><span class="line">    // then proceed with actually loading the bean definitions.</span><br><span class="line">    //初始化加载器，该方法可以被子类覆盖</span><br><span class="line">    initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">    //读取xml配置文件</span><br><span class="line">    loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法"><a href="#9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法" class="headerlink" title="9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法"></a>9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    // Tell the internal bean factory to use the context&apos;s class loader etc.</span><br><span class="line">    //设置context的类加载器为beanFactory的加载器</span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    //设置SPEL表达式语言处理器，例如#｛bean.xxx｝，</span><br><span class="line">    //加载bean的过程中如(DefaultListableBeanFactory的evaluateBeanDefinitionString方法)，</span><br><span class="line">    //会调用StandardBeanExpressionResolver的evaluate方法</span><br><span class="line">    beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">    //属性设置管理工具,</span><br><span class="line">    //bean加载过程中AbstractBeanFactory的initBeanWrapper方法会调用ResourceEditorRegistrar的registerCustomEditors方法</span><br><span class="line">    //注册自定义属性编辑器，覆盖PropertyEditorRegistrySupport中默认属性编辑器</span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    // Configure the bean factory with context callbacks.</span><br><span class="line">    //添加BeanPostProcessor，该处理器为实现了特殊接口的bean提供处理</span><br><span class="line">    beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));</span><br><span class="line">    //忽略自动装配的接口</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line"></span><br><span class="line">    // BeanFactory interface not registered as resolvable type in a plain factory.</span><br><span class="line">    // MessageSource registered (and found for autowiring) as a bean.</span><br><span class="line">    //设置特殊接口的注入对象</span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, this);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, this);</span><br><span class="line"></span><br><span class="line">    // Detect a LoadTimeWeaver and prepare for weaving, if found.</span><br><span class="line">    //增加对AspectJ的支持</span><br><span class="line">    if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">        // Set a temporary ClassLoader for type matching.</span><br><span class="line">        beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Register default environment beans.</span><br><span class="line">    注册默认的bean</span><br><span class="line">    if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法"><a href="#10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法" class="headerlink" title="10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法"></a>10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法"><a href="#11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法" class="headerlink" title="11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法"></a>11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">public static void invokeBeanFactoryPostProcessors(</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123;</span><br><span class="line"></span><br><span class="line">    // Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br><span class="line">    Set&lt;String&gt; processedBeans = new HashSet&lt;String&gt;();</span><br><span class="line">    //对BeanDefinitionRegistry类型的处理</span><br><span class="line">    if (beanFactory instanceof BeanDefinitionRegistry) &#123;</span><br><span class="line">        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new LinkedList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryPostProcessors =</span><br><span class="line">                new LinkedList&lt;BeanDefinitionRegistryPostProcessor&gt;();</span><br><span class="line">        //硬编码注册的处理器</span><br><span class="line">        for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            //该类型，在BeanFactoryPostProcessor的基础上还有自己定义的方法需要先调用</span><br><span class="line">            if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">                BeanDefinitionRegistryPostProcessor registryPostProcessor =</span><br><span class="line">                        (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">                //调用自己定义的方法</span><br><span class="line">                registryPostProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryPostProcessors.add(registryPostProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            //常规BeanFactoryPostProcessor</span><br><span class="line">            else &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">        // uninitialized to let the bean factory post-processors apply to them!</span><br><span class="line">        // Separate between BeanDefinitionRegistryPostProcessors that implement</span><br><span class="line">        // PriorityOrdered, Ordered, and the rest.</span><br><span class="line">        //配置注册的BeanDefinitionRegistryPostProcessor</span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">        // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanDefinitionRegistryPostProcessor&gt;();</span><br><span class="line">        for (String ppName : postProcessorNames) &#123;</span><br><span class="line">            if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //排序</span><br><span class="line">        OrderComparator.sort(priorityOrderedPostProcessors);</span><br><span class="line">        //加入处理器集合</span><br><span class="line">        registryPostProcessors.addAll(priorityOrderedPostProcessors);</span><br><span class="line">        //调用自己定义的方法</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(priorityOrderedPostProcessors, registry);</span><br><span class="line"></span><br><span class="line">        // Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanDefinitionRegistryPostProcessor&gt;();</span><br><span class="line">        for (String ppName : postProcessorNames) &#123;</span><br><span class="line">            if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                orderedPostProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //排序</span><br><span class="line">        OrderComparator.sort(orderedPostProcessors);</span><br><span class="line">        //加入处理器集合</span><br><span class="line">        registryPostProcessors.addAll(orderedPostProcessors);</span><br><span class="line">        //调用自己定义的方法</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(orderedPostProcessors, registry);</span><br><span class="line"></span><br><span class="line">        // Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><br><span class="line">        //调用其他处理器的自己定义的方法</span><br><span class="line">        boolean reiterate = true;</span><br><span class="line">        while (reiterate) &#123;</span><br><span class="line">            reiterate = false;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);</span><br><span class="line">            for (String ppName : postProcessorNames) &#123;</span><br><span class="line">                if (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    BeanDefinitionRegistryPostProcessor pp = beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class);</span><br><span class="line">                    registryPostProcessors.add(pp);</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    pp.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                    reiterate = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><br><span class="line">        //应用处理器</span><br><span class="line">        invokeBeanFactoryPostProcessors(registryPostProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else &#123;</span><br><span class="line">        // Invoke factory processors registered with the context instance.</span><br><span class="line">        //直接应用处理器</span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">    // uninitialized to let the bean factory post-processors apply to them!</span><br><span class="line">    //配置注册的BeanFactoryPostProcessor</span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">    // Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><br><span class="line">    // Ordered, and the rest.</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    //对后处理器分类</span><br><span class="line">    for (String ppName : postProcessorNames) &#123;</span><br><span class="line">        if (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            // skip - already processed in first phase above</span><br><span class="line">        &#125;</span><br><span class="line">        else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><br><span class="line">    //排序并应用后处理器</span><br><span class="line">    OrderComparator.sort(priorityOrderedPostProcessors);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    // Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">    for (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">     //排序并应用后处理器</span><br><span class="line">    OrderComparator.sort(orderedPostProcessors);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    // Finally, invoke all other BeanFactoryPostProcessors.</span><br><span class="line">    //应用不用排序的后处理器</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">    for (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法"><a href="#12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法" class="headerlink" title="12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法"></a>12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法"><a href="#13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法" class="headerlink" title="13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法"></a>13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public static void registerBeanPostProcessors(</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123;</span><br><span class="line">    //获取配置注册的BeanPostProcessor</span><br><span class="line">    String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">    // Register BeanPostProcessorChecker that logs an info message when</span><br><span class="line">    // a bean is created during BeanPostProcessor instantiation, i.e. when</span><br><span class="line">    // a bean is not eligible for getting processed by all BeanPostProcessors.</span><br><span class="line">    int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length;</span><br><span class="line">    //该处理器，在bean初始化时，检测到后处理器未注册完，打印日志</span><br><span class="line">    beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">    // Separate between BeanPostProcessors that implement PriorityOrdered,</span><br><span class="line">    // Ordered, and the rest.</span><br><span class="line">    List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    //分类bean处理器</span><br><span class="line">    for (String ppName : postProcessorNames) &#123;</span><br><span class="line">        if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">            priorityOrderedPostProcessors.add(pp);</span><br><span class="line">            if (pp instanceof MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">                internalPostProcessors.add(pp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // First, register the BeanPostProcessors that implement PriorityOrdered.</span><br><span class="line">    //排序并注册处理器</span><br><span class="line">    OrderComparator.sort(priorityOrderedPostProcessors);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    // Next, register the BeanPostProcessors that implement Ordered.</span><br><span class="line">    List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    for (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        orderedPostProcessors.add(pp);</span><br><span class="line">        if (pp instanceof MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //排序并注册处理器</span><br><span class="line">    OrderComparator.sort(orderedPostProcessors);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    // Now, register all regular BeanPostProcessors.</span><br><span class="line">    //注册无序处理器</span><br><span class="line">    List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    for (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        nonOrderedPostProcessors.add(pp);</span><br><span class="line">        if (pp instanceof MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    // Finally, re-register all internal BeanPostProcessors.</span><br><span class="line">    //注册MergedBeanDefinitionPostProcessor处理器，不会重复注册，会先删除</span><br><span class="line">    OrderComparator.sort(internalPostProcessors);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">    beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（一、3）AbstractApplicationContext的initMessageSource方法"><a href="#14、接（一、3）AbstractApplicationContext的initMessageSource方法" class="headerlink" title="14、接（一、3）AbstractApplicationContext的initMessageSource方法"></a>14、接（一、3）AbstractApplicationContext的initMessageSource方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected void initMessageSource() &#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">        //获取配置的messageSource记录在容器中</span><br><span class="line">        this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">        // Make MessageSource aware of parent MessageSource.</span><br><span class="line">        if (this.parent != null &amp;&amp; this.messageSource instanceof HierarchicalMessageSource) &#123;</span><br><span class="line">            HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource;</span><br><span class="line">            if (hms.getParentMessageSource() == null) &#123;</span><br><span class="line">                // Only set parent context as parent MessageSource if no parent MessageSource</span><br><span class="line">                // registered already.</span><br><span class="line">                hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Using MessageSource [&quot; + this.messageSource + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Use empty MessageSource to be able to accept getMessage calls.</span><br><span class="line">        DelegatingMessageSource dms = new DelegatingMessageSource();</span><br><span class="line">        dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">        this.messageSource = dms;</span><br><span class="line">        beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Unable to locate MessageSource with name &apos;&quot; + MESSAGE_SOURCE_BEAN_NAME +</span><br><span class="line">                    &quot;&apos;: using default [&quot; + this.messageSource + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法"><a href="#15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法" class="headerlink" title="15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法"></a>15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected void initApplicationEventMulticaster() &#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    //使用自定义广播器</span><br><span class="line">    if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">        this.applicationEventMulticaster =</span><br><span class="line">                beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //默认广播器</span><br><span class="line">    else &#123;</span><br><span class="line">        this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Unable to locate ApplicationEventMulticaster with name &apos;&quot; +</span><br><span class="line">                    APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">                    &quot;&apos;: using default [&quot; + this.applicationEventMulticaster + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、接（一、3）AbstractApplicationContext的registerListeners方法"><a href="#16、接（一、3）AbstractApplicationContext的registerListeners方法" class="headerlink" title="16、接（一、3）AbstractApplicationContext的registerListeners方法"></a>16、接（一、3）AbstractApplicationContext的registerListeners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected void registerListeners() &#123;</span><br><span class="line">    // Register statically specified listeners first.</span><br><span class="line">    //注册硬编码的监听器到广播器</span><br><span class="line">    for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">    // uninitialized to let post-processors apply to them!</span><br><span class="line">    //注册配置的监听器到广播器</span><br><span class="line">    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);</span><br><span class="line">    for (String lisName : listenerBeanNames) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListenerBean(lisName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法"><a href="#17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法" class="headerlink" title="17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法"></a>17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    // Initialize conversion service for this context.</span><br><span class="line">    //初始化自定义类型转换器</span><br><span class="line">    if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br><span class="line">    //该接口，加载Spring Bean时织入第三方模块，如AspectJ</span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);</span><br><span class="line">    for (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Stop using the temporary ClassLoader for type matching.</span><br><span class="line">    beanFactory.setTempClassLoader(null);</span><br><span class="line"></span><br><span class="line">    // Allow for caching all bean definition metadata, not expecting further changes.</span><br><span class="line">    //冻结bean的定义</span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    // Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">    //初始化剩下的单实例bean</span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（一、3）AbstractApplicationContext的finishRefresh方法"><a href="#18、接（一、3）AbstractApplicationContext的finishRefresh方法" class="headerlink" title="18、接（一、3）AbstractApplicationContext的finishRefresh方法"></a>18、接（一、3）AbstractApplicationContext的finishRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected void finishRefresh() &#123;</span><br><span class="line">    // Initialize lifecycle processor for this context.</span><br><span class="line">    //初始化bean生命周期处理器</span><br><span class="line">    initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">    // Propagate refresh to lifecycle processor first.</span><br><span class="line">    //启动实现了Lifecycle接口的bean</span><br><span class="line">    getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">    // Publish the final event.</span><br><span class="line">    publishEvent(new ContextRefreshedEvent(this));</span><br><span class="line"></span><br><span class="line">    // Participate in LiveBeansView MBean, if active.</span><br><span class="line">    //容器注册到MBeanServer中</span><br><span class="line">    LiveBeansView.registerApplicationContext(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、AbstractApplicationContext的initLifecycleProcessor方法"><a href="#19、AbstractApplicationContext的initLifecycleProcessor方法" class="headerlink" title="19、AbstractApplicationContext的initLifecycleProcessor方法"></a>19、AbstractApplicationContext的initLifecycleProcessor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">protected void initLifecycleProcessor() &#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        this.lifecycleProcessor =</span><br><span class="line">                beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Using LifecycleProcessor [&quot; + this.lifecycleProcessor + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //默认bean生命周期处理器</span><br><span class="line">        DefaultLifecycleProcessor defaultProcessor = new DefaultLifecycleProcessor();</span><br><span class="line">        defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">        this.lifecycleProcessor = defaultProcessor;</span><br><span class="line">        beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, this.lifecycleProcessor);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Unable to locate LifecycleProcessor with name &apos;&quot; +</span><br><span class="line">                    LIFECYCLE_PROCESSOR_BEAN_NAME +</span><br><span class="line">                    &quot;&apos;: using default [&quot; + this.lifecycleProcessor + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、接（一、18）DefaultLifecycleProcessor的onRefresh方法"><a href="#20、接（一、18）DefaultLifecycleProcessor的onRefresh方法" class="headerlink" title="20、接（一、18）DefaultLifecycleProcessor的onRefresh方法"></a>20、接（一、18）DefaultLifecycleProcessor的onRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onRefresh() &#123;</span><br><span class="line">    startBeans(true);</span><br><span class="line">    this.running = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、DefaultLifecycleProcessor的startBeans方法"><a href="#21、DefaultLifecycleProcessor的startBeans方法" class="headerlink" title="21、DefaultLifecycleProcessor的startBeans方法"></a>21、DefaultLifecycleProcessor的startBeans方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void startBeans(boolean autoStartupOnly) &#123;</span><br><span class="line">    //获取实现了Lifecycle接口的bean</span><br><span class="line">    Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">    Map&lt;Integer, LifecycleGroup&gt; phases = new HashMap&lt;Integer, LifecycleGroup&gt;();</span><br><span class="line">    //根据phases分组bean</span><br><span class="line">    for (Map.Entry&lt;String, ? extends Lifecycle&gt; entry : lifecycleBeans.entrySet()) &#123;</span><br><span class="line">        Lifecycle bean = entry.getValue();</span><br><span class="line">        if (!autoStartupOnly || (bean instanceof SmartLifecycle &amp;&amp; ((SmartLifecycle) bean).isAutoStartup())) &#123;</span><br><span class="line">            int phase = getPhase(bean);</span><br><span class="line">            LifecycleGroup group = phases.get(phase);</span><br><span class="line">            if (group == null) &#123;</span><br><span class="line">                group = new LifecycleGroup(phase, this.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly);</span><br><span class="line">                phases.put(phase, group);</span><br><span class="line">            &#125;</span><br><span class="line">            group.add(entry.getKey(), bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (phases.size() &gt; 0) &#123;</span><br><span class="line">        List&lt;Integer&gt; keys = new ArrayList&lt;Integer&gt;(phases.keySet());</span><br><span class="line">        Collections.sort(keys);</span><br><span class="line">        for (Integer key : keys) &#123;</span><br><span class="line">            //启动该分组的bean</span><br><span class="line">            phases.get(key).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、接（一、18）AbstractApplicationContext的publishEvent方法"><a href="#22、接（一、18）AbstractApplicationContext的publishEvent方法" class="headerlink" title="22、接（一、18）AbstractApplicationContext的publishEvent方法"></a>22、接（一、18）AbstractApplicationContext的publishEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void publishEvent(ApplicationEvent event) &#123;</span><br><span class="line">    Assert.notNull(event, &quot;Event must not be null&quot;);</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Publishing event in &quot; + getDisplayName() + &quot;: &quot; + event);</span><br><span class="line">    &#125;</span><br><span class="line">    //广播容器刷新完成事件</span><br><span class="line">    getApplicationEventMulticaster().multicastEvent(event);</span><br><span class="line">    if (this.parent != null) &#123;</span><br><span class="line">        this.parent.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、SimpleApplicationEventMulticaster的multicastEvent方法"><a href="#23、SimpleApplicationEventMulticaster的multicastEvent方法" class="headerlink" title="23、SimpleApplicationEventMulticaster的multicastEvent方法"></a>23、SimpleApplicationEventMulticaster的multicastEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void multicastEvent(final ApplicationEvent event) &#123;</span><br><span class="line">    //获取事件相关的监听器</span><br><span class="line">    for (final ApplicationListener&lt;?&gt; listener : getApplicationListeners(event)) &#123;</span><br><span class="line">        Executor executor = getTaskExecutor();</span><br><span class="line">        if (executor != null) &#123;</span><br><span class="line">            executor.execute(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    //监听器处理事件</span><br><span class="line">                    invokeListener(listener, event);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            invokeListener(listener, event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、ClassPathXmlApplicationContext容器关闭"><a href="#二、ClassPathXmlApplicationContext容器关闭" class="headerlink" title="二、ClassPathXmlApplicationContext容器关闭"></a>二、ClassPathXmlApplicationContext容器关闭</h3><h4 id="1、AbstractApplicationContext的close方法"><a href="#1、AbstractApplicationContext的close方法" class="headerlink" title="1、AbstractApplicationContext的close方法"></a>1、AbstractApplicationContext的close方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void close() &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        //关闭</span><br><span class="line">        doClose();</span><br><span class="line">        // If we registered a JVM shutdown hook, we don&apos;t need it anymore now:</span><br><span class="line">        // We&apos;ve already explicitly closed the context.</span><br><span class="line">        //移除关闭回调</span><br><span class="line">        if (this.shutdownHook != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Runtime.getRuntime().removeShutdownHook(this.shutdownHook);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (IllegalStateException ex) &#123;</span><br><span class="line">                // ignore - VM is already shutting down</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AbstractApplicationContext的doClose方法"><a href="#2、AbstractApplicationContext的doClose方法" class="headerlink" title="2、AbstractApplicationContext的doClose方法"></a>2、AbstractApplicationContext的doClose方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">protected void doClose() &#123;</span><br><span class="line">    //更新状态为关闭</span><br><span class="line">    if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) &#123;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(&quot;Closing &quot; + this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LiveBeansView.unregisterApplicationContext(this);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Publish shutdown event.</span><br><span class="line">            //广播容器关闭事件</span><br><span class="line">            publishEvent(new ContextClosedEvent(this));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Stop all Lifecycle beans, to avoid delays during individual destruction.</span><br><span class="line">        try &#123;</span><br><span class="line">            //关闭实现了Lifecycle接口的bean</span><br><span class="line">            getLifecycleProcessor().onClose();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception thrown from LifecycleProcessor on context close&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Destroy all cached singletons in the context&apos;s BeanFactory.</span><br><span class="line">        //销毁bean</span><br><span class="line">        destroyBeans();</span><br><span class="line"></span><br><span class="line">        // Close the state of this context itself.</span><br><span class="line">        //销毁容器</span><br><span class="line">        closeBeanFactory();</span><br><span class="line"></span><br><span class="line">        // Let subclasses do some final clean-up if they wish...</span><br><span class="line">        //待子类实现</span><br><span class="line">        onClose();</span><br><span class="line">        //更新容器状态</span><br><span class="line">        this.active.set(false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、AnnotationConfigApplicationContext容器启动"><a href="#三、AnnotationConfigApplicationContext容器启动" class="headerlink" title="三、AnnotationConfigApplicationContext容器启动"></a>三、AnnotationConfigApplicationContext容器启动</h3><h4 id="1、实例化AnnotationConfigApplicationContext"><a href="#1、实例化AnnotationConfigApplicationContext" class="headerlink" title="1、实例化AnnotationConfigApplicationContext"></a>1、实例化AnnotationConfigApplicationContext</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationConfigApplicationContext(String... basePackages) &#123;</span><br><span class="line">    this();</span><br><span class="line">    //扫描该包</span><br><span class="line">    scan(basePackages);</span><br><span class="line">    //启动容器</span><br><span class="line">    refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationConfigApplicationContext() &#123;</span><br><span class="line">    this.reader = new AnnotatedBeanDefinitionReader(this);</span><br><span class="line">    this.scanner = new ClassPathBeanDefinitionScanner(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public GenericApplicationContext() &#123;</span><br><span class="line">    //内置的容器</span><br><span class="line">    this.beanFactory = new DefaultListableBeanFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、实例化AnnotatedBeanDefinitionReader"><a href="#2、实例化AnnotatedBeanDefinitionReader" class="headerlink" title="2、实例化AnnotatedBeanDefinitionReader"></a>2、实例化AnnotatedBeanDefinitionReader</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    this(registry, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry, Environment environment) &#123;</span><br><span class="line">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">    Assert.notNull(environment, &quot;Environment must not be null&quot;);</span><br><span class="line">    this.registry = registry;</span><br><span class="line">    this.conditionEvaluator = new ConditionEvaluator(registry, environment, null);</span><br><span class="line">    AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法"><a href="#3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法" class="headerlink" title="3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法"></a>3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAnnotationConfigProcessors(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    registerAnnotationConfigProcessors(registry, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public static Set&lt;BeanDefinitionHolder&gt; registerAnnotationConfigProcessors(</span><br><span class="line">        BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    //获取容器中的DefaultListableBeanFactory容器</span><br><span class="line">    DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);</span><br><span class="line">    if (beanFactory != null) &#123;</span><br><span class="line">        //比较器</span><br><span class="line">        if (!(beanFactory.getDependencyComparator() instanceof AnnotationAwareOrderComparator)) &#123;</span><br><span class="line">            beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">        &#125;</span><br><span class="line">        //确定一个bean是否要被注入的工具</span><br><span class="line">        if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) &#123;</span><br><span class="line">            beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefs = new LinkedHashSet&lt;BeanDefinitionHolder&gt;(4);</span><br><span class="line"></span><br><span class="line">    //配置类解析器</span><br><span class="line">    if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //@Autowired、@Value处理器</span><br><span class="line">    if (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //检查带有@Required注解的所有Bean属性是否设置</span><br><span class="line">    if (!registry.containsBeanDefinition(REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(RequiredAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span><br><span class="line">    //处理@Resource注解及WebService、EJB相关的注解</span><br><span class="line">    if (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span><br><span class="line">    //JPA相关注解的Bean后置处理器，主要解析和处理@PersistenceUnit、@PersistenceContext注解</span><br><span class="line">    if (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition();</span><br><span class="line">        try &#123;</span><br><span class="line">            def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,</span><br><span class="line">                    AnnotationConfigUtils.class.getClassLoader()));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ClassNotFoundException ex) &#123;</span><br><span class="line">            throw new IllegalStateException(</span><br><span class="line">                    &quot;Cannot load optional framework class: &quot; + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //容器加载完单例bean之后执行处理器的afterSingletonsInstantiated方法</span><br><span class="line">    //遍历bean将其中注解了@EventListener的方法转换成监听器注册到容器中</span><br><span class="line">    if (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(EventListenerMethodProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //创建监听器的工厂类</span><br><span class="line">    if (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(DefaultEventListenerFactory.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    return beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、接（三、1）ClassPathXmlApplicationContext的scan方法"><a href="#4、接（三、1）ClassPathXmlApplicationContext的scan方法" class="headerlink" title="4、接（三、1）ClassPathXmlApplicationContext的scan方法"></a>4、接（三、1）ClassPathXmlApplicationContext的scan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void scan(String... basePackages) &#123;</span><br><span class="line">    Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</span><br><span class="line">    //扫描该包</span><br><span class="line">    this.scanner.scan(basePackages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、ClassPathBeanDefinitionScanner的scan方法"><a href="#5、ClassPathBeanDefinitionScanner的scan方法" class="headerlink" title="5、ClassPathBeanDefinitionScanner的scan方法"></a>5、ClassPathBeanDefinitionScanner的scan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public int scan(String... basePackages) &#123;</span><br><span class="line">    int beanCountAtScanStart = this.registry.getBeanDefinitionCount();</span><br><span class="line">    //扫描包</span><br><span class="line">    doScan(basePackages);</span><br><span class="line"></span><br><span class="line">    // Register annotation config processors, if necessary.</span><br><span class="line">    //注册</span><br><span class="line">    if (this.includeAnnotationConfig) &#123;</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (this.registry.getBeanDefinitionCount() - beanCountAtScanStart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、ClassPathBeanDefinitionScanner的doScan方法"><a href="#6、ClassPathBeanDefinitionScanner的doScan方法" class="headerlink" title="6、ClassPathBeanDefinitionScanner的doScan方法"></a>6、ClassPathBeanDefinitionScanner的doScan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) &#123;</span><br><span class="line">    Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</span><br><span class="line">    //创建一个集合，存放扫描到Bean定义的封装类</span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&lt;BeanDefinitionHolder&gt;();</span><br><span class="line">    //循环不同的包</span><br><span class="line">    for (String basePackage : basePackages) &#123;</span><br><span class="line">        //扫描给定包，获取符合条件的Bean定义，返回ScannedGenericBeanDefinition的集合</span><br><span class="line">        Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</span><br><span class="line">        for (BeanDefinition candidate : candidates) &#123;</span><br><span class="line">            //获取Bean定义类中@Scope注解的值，即获取Bean的作用域</span><br><span class="line">            ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);</span><br><span class="line">            //为Bean设置注解配置的作用域</span><br><span class="line">            candidate.setScope(scopeMetadata.getScopeName());</span><br><span class="line">            //为Bean生成名称，@Component(&quot;beanName&quot;)的值或类名</span><br><span class="line">            String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);</span><br><span class="line">            </span><br><span class="line">            if (candidate instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">                //设置Bean默认值，设置Bean是否将要被注入其他Bean</span><br><span class="line">                postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (candidate instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">                //处理注解Bean中通用的注解，在分析注解Bean定义类读取器时已经分析过</span><br><span class="line">                AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);</span><br><span class="line">            &#125;</span><br><span class="line">            //根据Bean名称检查指定的Bean是否需要在容器中注册，或者在容器中冲突</span><br><span class="line">            if (checkCandidate(beanName, candidate)) &#123;</span><br><span class="line">                BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);</span><br><span class="line">                //根据注解中配置的作用域，为Bean应用相应的代理模式</span><br><span class="line">                definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);</span><br><span class="line">                beanDefinitions.add(definitionHolder);</span><br><span class="line">                //向容器注册扫描到的Bean  </span><br><span class="line">                registerBeanDefinition(definitionHolder, this.registry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return beanDefinitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ClassPathBeanDefinitionScanner的findCandidateComponents方法"><a href="#7、ClassPathBeanDefinitionScanner的findCandidateComponents方法" class="headerlink" title="7、ClassPathBeanDefinitionScanner的findCandidateComponents方法"></a>7、ClassPathBeanDefinitionScanner的findCandidateComponents方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public Set&lt;BeanDefinition&gt; findCandidateComponents(String basePackage) &#123;</span><br><span class="line">    Set&lt;BeanDefinition&gt; candidates = new LinkedHashSet&lt;BeanDefinition&gt;();</span><br><span class="line">    try &#123;</span><br><span class="line">        //解析给定的包路径，this.resourcePattern=” **/*.class”，  </span><br><span class="line">        //ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX=“classpath:”  </span><br><span class="line">        //resolveBasePackage方法将包名中的”.”转换为文件系统的”/”  </span><br><span class="line">        String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br><span class="line">                resolveBasePackage(basePackage) + &quot;/&quot; + this.resourcePattern;</span><br><span class="line">        //将给定的包路径解析为Spring资源对象 </span><br><span class="line">        Resource[] resources = this.resourcePatternResolver.getResources(packageSearchPath);</span><br><span class="line">        boolean traceEnabled = logger.isTraceEnabled();</span><br><span class="line">        boolean debugEnabled = logger.isDebugEnabled();</span><br><span class="line">        //遍历扫描到的资源</span><br><span class="line">        for (Resource resource : resources) &#123;</span><br><span class="line">            if (traceEnabled) &#123;</span><br><span class="line">                logger.trace(&quot;Scanning &quot; + resource);</span><br><span class="line">            &#125;</span><br><span class="line">            if (resource.isReadable()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //为指定资源获取元数据读取器，元信息读取器通过汇编(ASM)读取资源元信息 </span><br><span class="line">                    MetadataReader metadataReader = this.metadataReaderFactory.getMetadataReader(resource);</span><br><span class="line">                    //如果扫描到的类符合容器配置的过滤规则</span><br><span class="line">                    if (isCandidateComponent(metadataReader)) &#123;</span><br><span class="line">                        //通过汇编(ASM)读取资源字节码中的Bean定义元信息 </span><br><span class="line">                        ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);</span><br><span class="line">                        //设置Bean定义来源于resource</span><br><span class="line">                        sbd.setResource(resource);</span><br><span class="line">                        //为元数据元素设置配置资源对象</span><br><span class="line">                        sbd.setSource(resource);</span><br><span class="line">                        //检查Bean是否符合过滤器要求</span><br><span class="line">                        if (isCandidateComponent(sbd)) &#123;</span><br><span class="line">                            if (debugEnabled) &#123;</span><br><span class="line">                                logger.debug(&quot;Identified candidate component class: &quot; + resource);</span><br><span class="line">                            &#125;</span><br><span class="line">                            //添加BeanDefinition</span><br><span class="line">                            candidates.add(sbd);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else &#123;</span><br><span class="line">                            if (debugEnabled) &#123;</span><br><span class="line">                                logger.debug(&quot;Ignored because not a concrete top-level class: &quot; + resource);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        if (traceEnabled) &#123;</span><br><span class="line">                            logger.trace(&quot;Ignored because not matching any filter: &quot; + resource);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Throwable ex) &#123;</span><br><span class="line">                    throw new BeanDefinitionStoreException(</span><br><span class="line">                            &quot;Failed to read candidate component class: &quot; + resource, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (traceEnabled) &#123;</span><br><span class="line">                    logger.trace(&quot;Ignored because not readable: &quot; + resource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(&quot;I/O failure during classpath scanning&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    return candidates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、ClassPathBeanDefinitionScanner的isCandidateComponent方法"><a href="#8、ClassPathBeanDefinitionScanner的isCandidateComponent方法" class="headerlink" title="8、ClassPathBeanDefinitionScanner的isCandidateComponent方法"></a>8、ClassPathBeanDefinitionScanner的isCandidateComponent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException &#123;</span><br><span class="line">    //排除过滤器</span><br><span class="line">    for (TypeFilter tf : this.excludeFilters) &#123;</span><br><span class="line">        if (tf.match(metadataReader, this.metadataReaderFactory)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //过滤器</span><br><span class="line">    for (TypeFilter tf : this.includeFilters) &#123;</span><br><span class="line">        if (tf.match(metadataReader, this.metadataReaderFactory)) &#123;</span><br><span class="line">            return isConditionMatch(metadataReader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法"><a href="#9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法" class="headerlink" title="9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法"></a>9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法</h4><p>注册默认的过滤器，在父类构ClassPathScanningCandidateComponentProvider造器中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected void registerDefaultFilters() &#123;</span><br><span class="line">    //支持Component注解</span><br><span class="line">    this.includeFilters.add(new AnnotationTypeFilter(Component.class));</span><br><span class="line">    ClassLoader cl = ClassPathScanningCandidateComponentProvider.class.getClassLoader();</span><br><span class="line">    try &#123;</span><br><span class="line">        //支持JavaEE6的@ManagedBean  </span><br><span class="line">        this.includeFilters.add(new AnnotationTypeFilter(</span><br><span class="line">                ((Class&lt;? extends Annotation&gt;) ClassUtils.forName(&quot;javax.annotation.ManagedBean&quot;, cl)), false));</span><br><span class="line">        logger.debug(&quot;JSR-250 &apos;javax.annotation.ManagedBean&apos; found and supported for component scanning&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //支持JSR-330的@Named注解</span><br><span class="line">        this.includeFilters.add(new AnnotationTypeFilter(</span><br><span class="line">                ((Class&lt;? extends Annotation&gt;) ClassUtils.forName(&quot;javax.inject.Named&quot;, cl)), false));</span><br><span class="line">        logger.debug(&quot;JSR-330 &apos;javax.inject.Named&apos; annotation found and supported for component scanning&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // JSR-330 API not available - simply skip.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法"><a href="#10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法" class="headerlink" title="10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法"></a>10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ScopeMetadata resolveScopeMetadata(BeanDefinition definition) &#123;</span><br><span class="line">    ScopeMetadata metadata = new ScopeMetadata();</span><br><span class="line">    if (definition instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">        AnnotatedBeanDefinition annDef = (AnnotatedBeanDefinition) definition;</span><br><span class="line">        //从注解Bean定义类的属性中查找属性为”Scope”的值，即@Scope注解的值  </span><br><span class="line">        // annDef.getMetadata()方法获取StandardAnnotationMetadata，该对象维护了Bean中所有注解和注解的值</span><br><span class="line">        AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(annDef.getMetadata(), this.scopeAnnotationType);</span><br><span class="line">        //将获取到的@Scope注解的值设置到要返回的对象中</span><br><span class="line">        if (attributes != null) &#123;</span><br><span class="line">            metadata.setScopeName(attributes.getString(&quot;value&quot;));</span><br><span class="line">            //获取@Scope注解中的proxyMode属性值，在创建代理对象时会用到</span><br><span class="line">            ScopedProxyMode proxyMode = attributes.getEnum(&quot;proxyMode&quot;);</span><br><span class="line">            //如果@Scope的proxyMode属性值为null、DEFAULT或者NO  </span><br><span class="line">            if (proxyMode == null || proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">                proxyMode = this.defaultProxyMode;</span><br><span class="line">            &#125;</span><br><span class="line">            //为返回的元数据设置proxyMode</span><br><span class="line">            metadata.setScopedProxyMode(proxyMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回解析的作用域元信息对象</span><br><span class="line">    return metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法"><a href="#11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法" class="headerlink" title="11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法"></a>11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd) &#123;</span><br><span class="line">    processCommonDefinitionAnnotations(abd, abd.getMetadata());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd, AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">    //如果Bean定义中有@Lazy注解，则将该Bean预实例化属性设置为@lazy注解的值</span><br><span class="line">    if (metadata.isAnnotated(Lazy.class.getName())) &#123;</span><br><span class="line">        abd.setLazyInit(attributesFor(metadata, Lazy.class).getBoolean(&quot;value&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    else if (abd.getMetadata() != metadata &amp;&amp; abd.getMetadata().isAnnotated(Lazy.class.getName())) &#123;</span><br><span class="line">        abd.setLazyInit(attributesFor(abd.getMetadata(), Lazy.class).getBoolean(&quot;value&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    //如果Bean定义中有@Primary注解，则为该Bean设置为autowiring自动依赖注入配的首选对象</span><br><span class="line">    if (metadata.isAnnotated(Primary.class.getName())) &#123;</span><br><span class="line">        abd.setPrimary(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //如果Bean定义中有@ DependsOn注解，则为该Bean设置所依赖的Bean名称，  </span><br><span class="line">    //容器将确保在实例化该Bean之前首先实例化所依赖的Bean</span><br><span class="line">    if (metadata.isAnnotated(DependsOn.class.getName())) &#123;</span><br><span class="line">        abd.setDependsOn(attributesFor(metadata, DependsOn.class).getStringArray(&quot;value&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (abd instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">        AbstractBeanDefinition absBd = (AbstractBeanDefinition) abd;</span><br><span class="line">        //设置@Role的值</span><br><span class="line">        if (metadata.isAnnotated(Role.class.getName())) &#123;</span><br><span class="line">            absBd.setRole(attributesFor(metadata, Role.class).getNumber(&quot;value&quot;).intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        //设置@Description得值</span><br><span class="line">        if (metadata.isAnnotated(Description.class.getName())) &#123;</span><br><span class="line">            absBd.setDescription(attributesFor(metadata, Description.class).getString(&quot;value&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接（三、1）AbstractApplicationContext的refresh方法"><a href="#12、接（三、1）AbstractApplicationContext的refresh方法" class="headerlink" title="12、接（三、1）AbstractApplicationContext的refresh方法"></a>12、接（三、1）AbstractApplicationContext的refresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        // Prepare this context for refreshing.</span><br><span class="line">        //清空scanner缓存，其余逻辑与一中容器相同</span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        // Tell the subclass to refresh the internal bean factory.</span><br><span class="line">        //直接获取容器父类GenericApplicationContext中的DefaultListableBeanFactory对象</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        // Prepare the bean factory for use in this context.</span><br><span class="line">        //与一中容器相同</span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Allows post-processing of the bean factory in context subclasses.</span><br><span class="line">            //待子类实现</span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Invoke factory processors registered as beans in the context.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Register bean processors that intercept bean creation.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Initialize message source for this context.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            // Initialize event multicaster for this context.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            // Initialize other special beans in specific context subclasses.</span><br><span class="line">            //待子类实现</span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            // Check for listener beans and register them.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            // Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Last step: publish corresponding event.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt&quot;, ex);</span><br><span class="line"></span><br><span class="line">            // Destroy already created singletons to avoid dangling resources.</span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            // Reset &apos;active&apos; flag.</span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            // Propagate exception to caller.</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"><a href="#13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器" class="headerlink" title="13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"></a>13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public AutowiredAnnotationBeanPostProcessor() &#123;</span><br><span class="line">    //将会处理@Autowire注解</span><br><span class="line">    this.autowiredAnnotationTypes.add(Autowired.class);</span><br><span class="line">    //将会处理@Value注解</span><br><span class="line">    this.autowiredAnnotationTypes.add(Value.class);</span><br><span class="line">    try &#123;</span><br><span class="line">        //将会处理javax.inject.Inject JSR-330注解</span><br><span class="line">        this.autowiredAnnotationTypes.add((Class&lt;? extends Annotation&gt;)</span><br><span class="line">                ClassUtils.forName(&quot;javax.inject.Inject&quot;, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));</span><br><span class="line">        logger.info(&quot;JSR-330 &apos;javax.inject.Inject&apos; annotation found and supported for autowiring&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // JSR-330 API not available - simply skip.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"><a href="#14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法" class="headerlink" title="14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"></a>14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName) &#123;</span><br><span class="line">    //获取给定类的autowire相关注解的字段及方法</span><br><span class="line">    InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);</span><br><span class="line">    metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法"><a href="#15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法" class="headerlink" title="15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法"></a>15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata findAutowiringMetadata(String beanName, Class&lt;?&gt; clazz, @Nullable PropertyValues pvs) &#123;</span><br><span class="line">    // Fall back to class name as cache key, for backwards compatibility with custom callers.</span><br><span class="line">    //先从缓存中获取</span><br><span class="line">    String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());</span><br><span class="line">    // Quick check on the concurrent map first, with minimal locking.</span><br><span class="line">    InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">    if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">        synchronized (this.injectionMetadataCache) &#123;</span><br><span class="line">            metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">            if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">                if (metadata != null) &#123;</span><br><span class="line">                    metadata.clear(pvs);</span><br><span class="line">                &#125;</span><br><span class="line">                //解析@Autowired等注解的字段和方法</span><br><span class="line">                metadata = buildAutowiringMetadata(clazz);</span><br><span class="line">                //添加缓存</span><br><span class="line">                this.injectionMetadataCache.put(cacheKey, metadata);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法"><a href="#16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法" class="headerlink" title="16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法"></a>16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata buildAutowiringMetadata(final Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    //存放注解信息的集合  </span><br><span class="line">    LinkedList&lt;InjectionMetadata.InjectedElement&gt; elements = new LinkedList&lt;&gt;();</span><br><span class="line">    Class&lt;?&gt; targetClass = clazz;</span><br><span class="line">    //递归遍历当前类及其所有父类，解析注解</span><br><span class="line">    do &#123;</span><br><span class="line">        //当前正在处理类注解信息的集合</span><br><span class="line">        final LinkedList&lt;InjectionMetadata.InjectedElement&gt; currElements = new LinkedList&lt;&gt;();</span><br><span class="line">        //获取字段上的注解信息</span><br><span class="line">        ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;</span><br><span class="line">            //遍历，获取字段上的注解</span><br><span class="line">            AnnotationAttributes ann = findAutowiredAnnotation(field);</span><br><span class="line">            if (ann != null) &#123;</span><br><span class="line">                //静态字段跳过</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Autowired annotation is not supported on static fields: &quot; + field);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                //判断注解的required属性值是否有效</span><br><span class="line">                boolean required = determineRequiredStatus(ann);</span><br><span class="line">                //字段信息加入集合</span><br><span class="line">                currElements.add(new AutowiredFieldElement(field, required));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //遍历，获取方法上的注解信息</span><br><span class="line">        ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;</span><br><span class="line">            //获取桥接方法的原始方法</span><br><span class="line">            Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method)</span><br><span class="line">            //方法参数和方法返回值类型不同，不处理</span><br><span class="line">            if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            //获取方法上的所有注解</span><br><span class="line">            AnnotationAttributes ann = findAutowiredAnnotation(bridgedMethod);</span><br><span class="line">            if (ann != null &amp;&amp; method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class="line">                //静态方法，不处理</span><br><span class="line">                if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Autowired annotation is not supported on static methods: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                if (method.getParameterCount() == 0) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Autowired annotation should only be used on methods with parameters: &quot; +</span><br><span class="line">                                method);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //判断注解的required属性值是否有效</span><br><span class="line">                boolean required = determineRequiredStatus(ann);</span><br><span class="line">                //获取当前方法的属性描述符，即方法是可读的(readable)getter方法，  </span><br><span class="line">                //还是可写的(writeable)setter方法  </span><br><span class="line">                PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                //方法信息加入集合</span><br><span class="line">                currElements.add(new AutowiredMethodElement(method, required, pd));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //当前类的注解信息存放到集合中</span><br><span class="line">        elements.addAll(0, currElements);</span><br><span class="line">        targetClass = targetClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    while (targetClass != null &amp;&amp; targetClass != Object.class);</span><br><span class="line"></span><br><span class="line">    return new InjectionMetadata(clazz, elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法"><a href="#17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法" class="headerlink" title="17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法"></a>17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private AnnotationAttributes findAutowiredAnnotation(AccessibleObject ao) &#123;</span><br><span class="line">    if (ao.getAnnotations().length &gt; 0) &#123;</span><br><span class="line">        //遍历所有autowire相关的注解:@Autowire、@Value以及JSR-330等</span><br><span class="line">        for (Class&lt;? extends Annotation&gt; type : this.autowiredAnnotationTypes) &#123;</span><br><span class="line">            //获取指定类型的注解</span><br><span class="line">            AnnotationAttributes attributes = AnnotatedElementUtils.getMergedAnnotationAttributes(ao, type);</span><br><span class="line">            if (attributes != null) &#123;</span><br><span class="line">                return attributes;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法"><a href="#18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法" class="headerlink" title="18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法"></a>18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法</h4><p>获取bean时，在设置属性值之前会调用处理器的postProcessPropertyValues方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public PropertyValues postProcessPropertyValues(  </span><br><span class="line">        PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeansException &#123;  </span><br><span class="line">    //获取@Autowired等注解信息 </span><br><span class="line">    InjectionMetadata metadata = findAutowiringMetadata(bean.getClass());  </span><br><span class="line">    try &#123;  </span><br><span class="line">        //自动注入Bean的属性</span><br><span class="line">        metadata.inject(bean, beanName, pvs);  </span><br><span class="line">    &#125;  </span><br><span class="line">    catch (Throwable ex) &#123;  </span><br><span class="line">        throw new BeanCreationException(beanName, &quot;Injection of autowired dependencies failed&quot;, ex);  </span><br><span class="line">    &#125;  </span><br><span class="line">    return pvs;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="19、InjectionMetadata的inject方法"><a href="#19、InjectionMetadata的inject方法" class="headerlink" title="19、InjectionMetadata的inject方法"></a>19、InjectionMetadata的inject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void inject(Object target, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable &#123;</span><br><span class="line">    Collection&lt;InjectedElement&gt; checkedElements = this.checkedElements;</span><br><span class="line">    Collection&lt;InjectedElement&gt; elementsToIterate =</span><br><span class="line">            (checkedElements != null ? checkedElements : this.injectedElements);</span><br><span class="line">    if (!elementsToIterate.isEmpty()) &#123;</span><br><span class="line">        boolean debug = logger.isDebugEnabled();</span><br><span class="line">        for (InjectedElement element : elementsToIterate) &#123;</span><br><span class="line">            if (debug) &#123;</span><br><span class="line">                logger.debug(&quot;Processing injected element of bean &apos;&quot; + beanName + &quot;&apos;: &quot; + element);</span><br><span class="line">            &#125;</span><br><span class="line">            //自动注入Bean的属性</span><br><span class="line">            element.inject(target, beanName, pvs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、AutowiredFieldElement的inject方法"><a href="#20、AutowiredFieldElement的inject方法" class="headerlink" title="20、AutowiredFieldElement的inject方法"></a>20、AutowiredFieldElement的inject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable &#123;</span><br><span class="line">    //注入的字段</span><br><span class="line">    Field field = (Field) this.member;</span><br><span class="line">    Object value;</span><br><span class="line">    //有缓存使用缓存</span><br><span class="line">    if (this.cached) &#123;</span><br><span class="line">        value = resolvedCachedArgument(beanName, this.cachedFieldValue);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        DependencyDescriptor desc = new DependencyDescriptor(field, this.required);</span><br><span class="line">        desc.setContainingClass(bean.getClass());</span><br><span class="line">        Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;&gt;(1);</span><br><span class="line">        Assert.state(beanFactory != null, &quot;No BeanFactory available&quot;);</span><br><span class="line">        TypeConverter typeConverter = beanFactory.getTypeConverter();</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取依赖对象 </span><br><span class="line">            value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(field), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            //添加缓存</span><br><span class="line">            if (!this.cached) &#123;</span><br><span class="line">                if (value != null || this.required) &#123;</span><br><span class="line">                    this.cachedFieldValue = desc;</span><br><span class="line">                    //注册依赖</span><br><span class="line">                    registerDependentBeans(beanName, autowiredBeanNames);</span><br><span class="line">                    if (autowiredBeanNames.size() == 1) &#123;</span><br><span class="line">                        String autowiredBeanName = autowiredBeanNames.iterator().next();</span><br><span class="line">                        //如果容器中有依赖对象且依赖对象类型和字段类型匹配</span><br><span class="line">                        if (beanFactory.containsBean(autowiredBeanName) &amp;&amp;</span><br><span class="line">                                beanFactory.isTypeMatch(autowiredBeanName, field.getType())) &#123;</span><br><span class="line">                            //创建缓存</span><br><span class="line">                            this.cachedFieldValue = new ShortcutDependencyDescriptor(</span><br><span class="line">                                    desc, autowiredBeanName, field.getType());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    this.cachedFieldValue = null;</span><br><span class="line">                &#125;</span><br><span class="line">                this.cached = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (value != null) &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(field);</span><br><span class="line">        field.set(bean, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、AutowiredFieldElement的resolvedCachedArgument方法"><a href="#21、AutowiredFieldElement的resolvedCachedArgument方法" class="headerlink" title="21、AutowiredFieldElement的resolvedCachedArgument方法"></a>21、AutowiredFieldElement的resolvedCachedArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private Object resolvedCachedArgument(@Nullable String beanName, @Nullable Object cachedArgument) &#123;</span><br><span class="line">    if (cachedArgument instanceof DependencyDescriptor) &#123;</span><br><span class="line">        DependencyDescriptor descriptor = (DependencyDescriptor) cachedArgument;</span><br><span class="line">        Assert.state(beanFactory != null, &quot;No BeanFactory available&quot;);</span><br><span class="line">        //获取依赖对象，该方法在XmlBeanFactory容器中已有介绍</span><br><span class="line">        return this.beanFactory.resolveDependency(descriptor, beanName, null, null);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return cachedArgument;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"><a href="#22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器" class="headerlink" title="22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"></a>22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        //加载WebService相关的类</span><br><span class="line">        Class&lt;? extends Annotation&gt; clazz = (Class&lt;? extends Annotation&gt;)</span><br><span class="line">                ClassUtils.forName(&quot;javax.xml.ws.WebServiceRef&quot;, CommonAnnotationBeanPostProcessor.class.getClassLoader());</span><br><span class="line">        webServiceRefClass = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        webServiceRefClass = null;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        //加载EJB相关的类  </span><br><span class="line">        Class&lt;? extends Annotation&gt; clazz = (Class&lt;? extends Annotation&gt;)</span><br><span class="line">                ClassUtils.forName(&quot;javax.ejb.EJB&quot;, CommonAnnotationBeanPostProcessor.class.getClassLoader());</span><br><span class="line">        ejbRefClass = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        ejbRefClass = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public CommonAnnotationBeanPostProcessor() &#123;</span><br><span class="line">    setOrder(Ordered.LOWEST_PRECEDENCE - 3);</span><br><span class="line">    //父类InitDestroyAnnotationBeanPostProcessor</span><br><span class="line">    //在bean初始化之前postProcessBeforeInitialization执行@PostConstruct注解方法</span><br><span class="line">    //在bean销毁之前postProcessBeforeDestruction执行@PreDestroy注解方法</span><br><span class="line">    setInitAnnotationType(PostConstruct.class);</span><br><span class="line">    setDestroyAnnotationType(PreDestroy.class);</span><br><span class="line">    //当使用@Resource注解时.忽略JAX-WS的资源类型 </span><br><span class="line">    ignoreResourceType(&quot;javax.xml.ws.WebServiceContext&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"><a href="#23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法" class="headerlink" title="23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"></a>23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName) &#123;</span><br><span class="line">    super.postProcessMergedBeanDefinition(beanDefinition, beanType, beanName);</span><br><span class="line">    //获取@Resource注解的属性信息</span><br><span class="line">    InjectionMetadata metadata = findResourceMetadata(beanName, beanType, null);</span><br><span class="line">    metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法"><a href="#24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法" class="headerlink" title="24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法"></a>24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata findResourceMetadata(String beanName, final Class&lt;?&gt; clazz, @Nullable PropertyValues pvs) &#123;</span><br><span class="line">    // Fall back to class name as cache key, for backwards compatibility with custom callers.</span><br><span class="line">    String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());</span><br><span class="line">    // Quick check on the concurrent map first, with minimal locking.</span><br><span class="line">    //首先从容器缓存中查找 </span><br><span class="line">    InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">    //缓存数据过期</span><br><span class="line">    if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">        synchronized (this.injectionMetadataCache) &#123;</span><br><span class="line">            metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">            if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">                if (metadata != null) &#123;</span><br><span class="line">                    metadata.clear(pvs);</span><br><span class="line">                &#125;</span><br><span class="line">                //获取@Resource注解的属性信息</span><br><span class="line">                metadata = buildResourceMetadata(clazz);</span><br><span class="line">                this.injectionMetadataCache.put(cacheKey, metadata);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法"><a href="#25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法" class="headerlink" title="25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法"></a>25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata buildResourceMetadata(final Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    //注解数据的集合</span><br><span class="line">    LinkedList&lt;InjectionMetadata.InjectedElement&gt; elements = new LinkedList&lt;&gt;();</span><br><span class="line">    Class&lt;?&gt; targetClass = clazz;</span><br><span class="line">    //递归地的解析给定类及其所有父类的注解信息</span><br><span class="line">    do &#123;</span><br><span class="line">        //存放当前类注解数据的集合</span><br><span class="line">        final LinkedList&lt;InjectionMetadata.InjectedElement&gt; currElements =</span><br><span class="line">                new LinkedList&lt;&gt;();</span><br><span class="line">        //遍历所有的字段，查找符合的注解 </span><br><span class="line">        ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;</span><br><span class="line">            //如果字段上配置了WebService相关的注解</span><br><span class="line">            if (webServiceRefClass != null &amp;&amp; field.isAnnotationPresent(webServiceRefClass)) &#123;</span><br><span class="line">                //静态不处理</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;@WebServiceRef annotation is not supported on static fields&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                currElements.add(new WebServiceRefElement(field, field, null));</span><br><span class="line">            &#125;</span><br><span class="line">            //如果当前字段上配置了EJB相关的注解</span><br><span class="line">            else if (ejbRefClass != null &amp;&amp; field.isAnnotationPresent(ejbRefClass)) &#123;</span><br><span class="line">                //静态不处理</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;@EJB annotation is not supported on static fields&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //加入当前注解数据的集合</span><br><span class="line">                currElements.add(new EjbRefElement(field, field, null));</span><br><span class="line">            &#125;</span><br><span class="line">            //如果当前字段上配置了@Resource注解  </span><br><span class="line">            else if (field.isAnnotationPresent(Resource.class)) &#123;</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;@Resource annotation is not supported on static fields&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //如果当前自动的类型不再被忽略的Resource类型中，  </span><br><span class="line">                //加入当前注解数据的集合</span><br><span class="line">                if (!ignoredResourceTypes.contains(field.getType().getName())) &#123;</span><br><span class="line">                    currElements.add(new ResourceElement(field, field, null));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //遍历所有方法，查找相关的注解</span><br><span class="line">        ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;</span><br><span class="line">            //获取桥接方法</span><br><span class="line">            Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);</span><br><span class="line">            if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            //当前方法没有覆盖父类方法</span><br><span class="line">            if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class="line">                //如果方法上配置了WebService相关的注解</span><br><span class="line">                if (webServiceRefClass != null &amp;&amp; bridgedMethod.isAnnotationPresent(webServiceRefClass)) &#123;</span><br><span class="line">                    if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@WebServiceRef annotation is not supported on static methods&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (method.getParameterCount() != 1) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@WebServiceRef annotation requires a single-arg method: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //获取方法的属性描述 </span><br><span class="line">                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                    //加入当前注解数据的集合</span><br><span class="line">                    currElements.add(new WebServiceRefElement(method, bridgedMethod, pd));</span><br><span class="line">                &#125;</span><br><span class="line">                //如果方法上配置了EJB相关的注解  </span><br><span class="line">                else if (ejbRefClass != null &amp;&amp; bridgedMethod.isAnnotationPresent(ejbRefClass)) &#123;</span><br><span class="line">                    if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@EJB annotation is not supported on static methods&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (method.getParameterCount() != 1) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@EJB annotation requires a single-arg method: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                    currElements.add(new EjbRefElement(method, bridgedMethod, pd));</span><br><span class="line">                &#125;</span><br><span class="line">                //如果方法上配置了EJB相关的注解  </span><br><span class="line">                else if (bridgedMethod.isAnnotationPresent(Resource.class)) &#123;</span><br><span class="line">                    if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@Resource annotation is not supported on static methods&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line">                    if (paramTypes.length != 1) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@Resource annotation requires a single-arg method: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!ignoredResourceTypes.contains(paramTypes[0].getName())) &#123;</span><br><span class="line">                        PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                        currElements.add(new ResourceElement(method, bridgedMethod, pd));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //将当前类注解数据存放到集合中 </span><br><span class="line">        elements.addAll(0, currElements);</span><br><span class="line">        targetClass = targetClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    while (targetClass != null &amp;&amp; targetClass != Object.class);</span><br><span class="line"></span><br><span class="line">    return new InjectionMetadata(clazz, elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、ClassPathXmlApplicationContext容器启动&quot;&gt;&lt;a href=&quot;#一、ClassPathXmlApplicationContext容器启动&quot; class=&quot;headerlink&quot; title=&quot;一、ClassPathXmlApplic
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>spring源码AOP</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/spring%E6%BA%90%E7%A0%81AOP/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/spring源码AOP/</id>
    <published>2018-06-27T13:10:29.016Z</published>
    <updated>2018-06-28T14:07:49.613Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、AOP动态代理配置文件加载"><a href="#一、AOP动态代理配置文件加载" class="headerlink" title="一、AOP动态代理配置文件加载"></a>一、AOP动态代理配置文件加载</h3><h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface Dao &#123;    </span><br><span class="line">    public void select();</span><br><span class="line">    public void insert();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>被代理的类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class DaoImpl implements Dao &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void select() &#123;</span><br><span class="line">        System.out.println(&quot;Enter DaoImpl.select()&quot;);</span><br><span class="line">    ｝</span><br><span class="line">    @Override</span><br><span class="line">    public void insert() &#123;</span><br><span class="line">        System.out.println(&quot;Enter DaoImpl.insert()&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>切面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class TimeHandler &#123;</span><br><span class="line">   public void printTime() &#123;</span><br><span class="line">       System.out.println(&quot;CurrentTime:&quot; + System.currentTimeMillis());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>引介增强，将该类中的方法添加到被代理的类中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Mathematician &#123;  </span><br><span class="line">    public void calculate();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class MathematicianImpl implements Mathematician &#123;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public void calculate() &#123;  </span><br><span class="line">        System.out.println(&quot;calculate the result of the formulae&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AOP配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop-3.0.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;daoImpl&quot; class=&quot;org.xrq.action.aop.DaoImpl&quot; /&gt;</span><br><span class="line">    &lt;bean id=&quot;Einstein&quot; class=&quot;org.xrq.action.aop.Einstein&quot;&gt;&lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;timeHandler&quot; class=&quot;org.xrq.action.aop.TimeHandler&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config proxy-target-class=&quot;true&quot;&gt;</span><br><span class="line">        &lt;aop:aspect id=&quot;time&quot; ref=&quot;timeHandler&quot;&gt;</span><br><span class="line">            &lt;aop:pointcut id=&quot;addAllMethod&quot; expression=&quot;execution(* org.xrq.action.aop.Dao.*(..))&quot; /&gt;</span><br><span class="line">            &lt;aop:before method=&quot;printTime&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt;</span><br><span class="line">            &lt;aop:after method=&quot;printTime&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt;</span><br><span class="line">            &lt;aop:declare-parents types-matching=&quot;org.xrq.action.aop.Dao&quot;   </span><br><span class="line">                implement-interface=&quot;org.xrq.action.aop.Mathematician&quot;  </span><br><span class="line">                default-impl=&quot;org.xrq.action.aop.MathematicianImpl&quot;/&gt;  </span><br><span class="line">        &lt;/aop:aspect&gt;</span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><p>META-INF/spring.handlers<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://www.springframework.org/schema/aop=org.springframework.aop.config.AopNamespaceHandler</span><br></pre></td></tr></table></figure></p><h4 id="1、AopNamespaceHandler的init方法"><a href="#1、AopNamespaceHandler的init方法" class="headerlink" title="1、AopNamespaceHandler的init方法"></a>1、AopNamespaceHandler的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    // In 2.0 XSD as well as in 2.1 XSD.</span><br><span class="line">    registerBeanDefinitionParser(&quot;config&quot;, new ConfigBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;aspectj-autoproxy&quot;, new AspectJAutoProxyBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionDecorator(&quot;scoped-proxy&quot;, new ScopedProxyBeanDefinitionDecorator());</span><br><span class="line"></span><br><span class="line">    // Only in 2.0 XSD: moved to context namespace as of 2.1</span><br><span class="line">    registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ConfigBeanDefinitionParser的parse方法"><a href="#2、ConfigBeanDefinitionParser的parse方法" class="headerlink" title="2、ConfigBeanDefinitionParser的parse方法"></a>2、ConfigBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    CompositeComponentDefinition compositeDef =</span><br><span class="line">            new CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));</span><br><span class="line">    parserContext.pushContainingComponent(compositeDef);</span><br><span class="line">    //注册AutoProxyCreator</span><br><span class="line">    configureAutoProxyCreator(parserContext, element);</span><br><span class="line">    //获取子元素</span><br><span class="line">    List&lt;Element&gt; childElts = DomUtils.getChildElements(element);</span><br><span class="line">    for (Element elt: childElts) &#123;</span><br><span class="line">        String localName = parserContext.getDelegate().getLocalName(elt);</span><br><span class="line">        if (POINTCUT.equals(localName)) &#123;</span><br><span class="line">            //解析pointcut元素</span><br><span class="line">            parsePointcut(elt, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ADVISOR.equals(localName)) &#123;</span><br><span class="line">            //解析advisor元素</span><br><span class="line">            parseAdvisor(elt, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ASPECT.equals(localName)) &#123;</span><br><span class="line">            //解析aspect元素</span><br><span class="line">            parseAspect(elt, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //注册综合组件并广播</span><br><span class="line">    parserContext.popAndRegisterContainingComponent();</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ConfigBeanDefinitionParser的parse方法"><a href="#3、ConfigBeanDefinitionParser的parse方法" class="headerlink" title="3、ConfigBeanDefinitionParser的parse方法"></a>3、ConfigBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private void configureAutoProxyCreator(ParserContext parserContext, Element element) &#123;</span><br><span class="line">    AopNamespaceUtils.registerAspectJAutoProxyCreatorIfNecessary(parserContext, element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAspectJAutoProxyCreatorIfNecessary(</span><br><span class="line">        ParserContext parserContext, Element sourceElement) &#123;</span><br><span class="line">    //注册AspectJAwareAdvisorAutoProxyCreator</span><br><span class="line">    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary(</span><br><span class="line">            parserContext.getRegistry(), parserContext.extractSource(sourceElement));</span><br><span class="line">    //设置proxy-target-class和expose-proxy属性</span><br><span class="line">    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</span><br><span class="line">    //把创建器组件注册到综合组件并广播</span><br><span class="line">    registerComponentIfNecessary(beanDefinition, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static BeanDefinition registerAspectJAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    return registerOrEscalateApcAsRequired(AspectJAwareAdvisorAutoProxyCreator.class, registry, source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private static BeanDefinition registerOrEscalateApcAsRequired(Class&lt;?&gt; cls, BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">    //已存在创建器，根据优先级判断使用哪一个</span><br><span class="line">    if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        if (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;</span><br><span class="line">            int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName());</span><br><span class="line">            int requiredPriority = findPriorityForClass(cls);</span><br><span class="line">            if (currentPriority &lt; requiredPriority) &#123;</span><br><span class="line">                apcDefinition.setBeanClassName(cls.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);</span><br><span class="line">    beanDefinition.setSource(source);</span><br><span class="line">    beanDefinition.getPropertyValues().add(&quot;order&quot;, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //注册新的创建器</span><br><span class="line">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line">    return beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法"><a href="#7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法" class="headerlink" title="7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法"></a>7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition parsePointcut(Element pointcutElement, ParserContext parserContext) &#123;</span><br><span class="line">    //获取id</span><br><span class="line">    String id = pointcutElement.getAttribute(ID);</span><br><span class="line">    //获取expression</span><br><span class="line">    String expression = pointcutElement.getAttribute(EXPRESSION);</span><br><span class="line"></span><br><span class="line">    AbstractBeanDefinition pointcutDefinition = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new PointcutEntry(id));</span><br><span class="line">        //创建切点BeanDefinition</span><br><span class="line">        pointcutDefinition = createPointcutDefinition(expression);</span><br><span class="line">        pointcutDefinition.setSource(parserContext.extractSource(pointcutElement));</span><br><span class="line"></span><br><span class="line">        String pointcutBeanName = id;</span><br><span class="line">        //注册切点BeanDefinition</span><br><span class="line">        if (StringUtils.hasText(pointcutBeanName)) &#123;</span><br><span class="line">            parserContext.getRegistry().registerBeanDefinition(pointcutBeanName, pointcutDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            pointcutBeanName = parserContext.getReaderContext().registerWithGeneratedName(pointcutDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        //把切点组件注册到综合组件并广播</span><br><span class="line">        parserContext.registerComponent(</span><br><span class="line">                new PointcutComponentDefinition(pointcutBeanName, pointcutDefinition, expression));</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pointcutDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法"><a href="#8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法" class="headerlink" title="8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法"></a>8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private void parseAdvisor(Element advisorElement, ParserContext parserContext) &#123;</span><br><span class="line">    //创建通知器BeanDefinition</span><br><span class="line">    AbstractBeanDefinition advisorDef = createAdvisorBeanDefinition(advisorElement, parserContext);</span><br><span class="line">    String id = advisorElement.getAttribute(ID);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new AdvisorEntry(id));</span><br><span class="line">        String advisorBeanName = id;</span><br><span class="line">        //注册通知器BeanDefinition</span><br><span class="line">        if (StringUtils.hasText(advisorBeanName)) &#123;</span><br><span class="line">            parserContext.getRegistry().registerBeanDefinition(advisorBeanName, advisorDef);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            advisorBeanName = parserContext.getReaderContext().registerWithGeneratedName(advisorDef);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取切点</span><br><span class="line">        Object pointcut = parsePointcutProperty(advisorElement, parserContext);</span><br><span class="line">        //切点或切点引用加入通知器</span><br><span class="line">        //把通知器组件注册到综合组件并广播</span><br><span class="line">        if (pointcut instanceof BeanDefinition) &#123;</span><br><span class="line">            advisorDef.getPropertyValues().add(POINTCUT, pointcut);</span><br><span class="line">            parserContext.registerComponent(</span><br><span class="line">                    new AdvisorComponentDefinition(advisorBeanName, advisorDef, (BeanDefinition) pointcut));</span><br><span class="line">        &#125;</span><br><span class="line">        else if (pointcut instanceof String) &#123;</span><br><span class="line">            advisorDef.getPropertyValues().add(POINTCUT, new RuntimeBeanReference((String) pointcut));</span><br><span class="line">            parserContext.registerComponent(</span><br><span class="line">                    new AdvisorComponentDefinition(advisorBeanName, advisorDef));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法"><a href="#9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法" class="headerlink" title="9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法"></a>9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition createAdvisorBeanDefinition(Element advisorElement, ParserContext parserContext) &#123;</span><br><span class="line">    //创建通知器BeanDefinition</span><br><span class="line">    RootBeanDefinition advisorDefinition = new RootBeanDefinition(DefaultBeanFactoryPointcutAdvisor.class);</span><br><span class="line">    advisorDefinition.setSource(parserContext.extractSource(advisorElement));</span><br><span class="line">    //获取advice引用</span><br><span class="line">    String adviceRef = advisorElement.getAttribute(ADVICE_REF);</span><br><span class="line">    //advice引用加入通知器BeanDefinition</span><br><span class="line">    if (!StringUtils.hasText(adviceRef)) &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;&apos;advice-ref&apos; attribute contains empty value.&quot;, advisorElement, this.parseState.snapshot());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        advisorDefinition.getPropertyValues().add(</span><br><span class="line">                ADVICE_BEAN_NAME, new RuntimeBeanNameReference(adviceRef));</span><br><span class="line">    &#125;</span><br><span class="line">    //通知器顺序</span><br><span class="line">    if (advisorElement.hasAttribute(ORDER_PROPERTY)) &#123;</span><br><span class="line">        advisorDefinition.getPropertyValues().add(</span><br><span class="line">                ORDER_PROPERTY, advisorElement.getAttribute(ORDER_PROPERTY));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return advisorDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法"><a href="#10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法" class="headerlink" title="10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法"></a>10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private Object parsePointcutProperty(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    if (element.hasAttribute(POINTCUT) &amp;&amp; element.hasAttribute(POINTCUT_REF)) &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;Cannot define both &apos;pointcut&apos; and &apos;pointcut-ref&apos; on &lt;advisor&gt; tag.&quot;,</span><br><span class="line">                element, this.parseState.snapshot());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(POINTCUT)) &#123;</span><br><span class="line">        // Create a pointcut for the anonymous pc and register it.</span><br><span class="line">        //获取切点表达式</span><br><span class="line">        String expression = element.getAttribute(POINTCUT);</span><br><span class="line">        //创建切点BeanDefinition</span><br><span class="line">        AbstractBeanDefinition pointcutDefinition = createPointcutDefinition(expression);</span><br><span class="line">        pointcutDefinition.setSource(parserContext.extractSource(element));</span><br><span class="line">        return pointcutDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(POINTCUT_REF)) &#123;</span><br><span class="line">        //获取切点bean的id</span><br><span class="line">        String pointcutRef = element.getAttribute(POINTCUT_REF);</span><br><span class="line">        if (!StringUtils.hasText(pointcutRef)) &#123;</span><br><span class="line">            parserContext.getReaderContext().error(</span><br><span class="line">                    &quot;&apos;pointcut-ref&apos; attribute contains empty value.&quot;, element, this.parseState.snapshot());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return pointcutRef;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;Must define one of &apos;pointcut&apos; or &apos;pointcut-ref&apos; on &lt;advisor&gt; tag.&quot;,</span><br><span class="line">                element, this.parseState.snapshot());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ConfigBeanDefinitionParser的createPointcutDefinition方法"><a href="#11、ConfigBeanDefinitionParser的createPointcutDefinition方法" class="headerlink" title="11、ConfigBeanDefinitionParser的createPointcutDefinition方法"></a>11、ConfigBeanDefinitionParser的createPointcutDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected AbstractBeanDefinition createPointcutDefinition(String expression) &#123;</span><br><span class="line">    //创建切点BeanDefinition</span><br><span class="line">    RootBeanDefinition beanDefinition = new RootBeanDefinition(AspectJExpressionPointcut.class);</span><br><span class="line">    beanDefinition.setScope(BeanDefinition.SCOPE_PROTOTYPE);</span><br><span class="line">    beanDefinition.setSynthetic(true);</span><br><span class="line">    //添加切点表达式属性</span><br><span class="line">    beanDefinition.getPropertyValues().add(EXPRESSION, expression);</span><br><span class="line">    return beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法"><a href="#12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法" class="headerlink" title="12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法"></a>12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">private void parseAspect(Element aspectElement, ParserContext parserContext) &#123;</span><br><span class="line">    //获取切面名</span><br><span class="line">    String aspectId = aspectElement.getAttribute(ID);</span><br><span class="line">    //获取切面bean名</span><br><span class="line">    String aspectName = aspectElement.getAttribute(REF);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new AspectEntry(aspectId, aspectName));</span><br><span class="line">        List&lt;BeanDefinition&gt; beanDefinitions = new ArrayList&lt;BeanDefinition&gt;();</span><br><span class="line">        List&lt;BeanReference&gt; beanReferences = new ArrayList&lt;BeanReference&gt;();</span><br><span class="line">        //获取declare-parents类型的子元素</span><br><span class="line">        List&lt;Element&gt; declareParents = DomUtils.getChildElementsByTagName(aspectElement, DECLARE_PARENTS);</span><br><span class="line">        for (int i = METHOD_INDEX; i &lt; declareParents.size(); i++) &#123;</span><br><span class="line">            Element declareParentsElement = declareParents.get(i);</span><br><span class="line">            //解析declare-parents元素，并加入BeanDefinition集合</span><br><span class="line">            beanDefinitions.add(parseDeclareParents(declareParentsElement, parserContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // We have to parse &quot;advice&quot; and all the advice kinds in one loop, to get the</span><br><span class="line">        // ordering semantics right.</span><br><span class="line">        //获取子元素</span><br><span class="line">        NodeList nodeList = aspectElement.getChildNodes();</span><br><span class="line">        boolean adviceFoundAlready = false;</span><br><span class="line">        for (int i = 0; i &lt; nodeList.getLength(); i++) &#123;</span><br><span class="line">            Node node = nodeList.item(i);</span><br><span class="line">            //该元素节点为advice节点,如before等</span><br><span class="line">            if (isAdviceNode(node, parserContext)) &#123;</span><br><span class="line">                if (!adviceFoundAlready) &#123;</span><br><span class="line">                    adviceFoundAlready = true;</span><br><span class="line">                    if (!StringUtils.hasText(aspectName)) &#123;</span><br><span class="line">                        parserContext.getReaderContext().error(</span><br><span class="line">                                &quot;&lt;aspect&gt; tag needs aspect bean reference via &apos;ref&apos; attribute when declaring advices.&quot;,</span><br><span class="line">                                aspectElement, this.parseState.snapshot());</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //切面bean引用加入引用集合</span><br><span class="line">                    beanReferences.add(new RuntimeBeanReference(aspectName));</span><br><span class="line">                &#125;</span><br><span class="line">                //解析获取通知器BeanDefinition</span><br><span class="line">                AbstractBeanDefinition advisorDefinition = parseAdvice(</span><br><span class="line">                        aspectName, i, aspectElement, (Element) node, parserContext, beanDefinitions, beanReferences);</span><br><span class="line">                beanDefinitions.add(advisorDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //创建切面组件BeanDefinition</span><br><span class="line">        AspectComponentDefinition aspectComponentDefinition = createAspectComponentDefinition(</span><br><span class="line">                aspectElement, aspectId, beanDefinitions, beanReferences, parserContext);</span><br><span class="line">        parserContext.pushContainingComponent(aspectComponentDefinition);</span><br><span class="line">        //获取切点类型子元素</span><br><span class="line">        List&lt;Element&gt; pointcuts = DomUtils.getChildElementsByTagName(aspectElement, POINTCUT);</span><br><span class="line">        for (Element pointcutElement : pointcuts) &#123;</span><br><span class="line">            //解析切点元素</span><br><span class="line">            parsePointcut(pointcutElement, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">        //把切面组件注册到综合组件并广播</span><br><span class="line">        parserContext.popAndRegisterContainingComponent();</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、ConfigBeanDefinitionParser的parseDeclareParents方法"><a href="#13、ConfigBeanDefinitionParser的parseDeclareParents方法" class="headerlink" title="13、ConfigBeanDefinitionParser的parseDeclareParents方法"></a>13、ConfigBeanDefinitionParser的parseDeclareParents方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition parseDeclareParents(Element declareParentsElement, ParserContext parserContext) &#123;</span><br><span class="line">    //通知器BeanDefinition的创建器</span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(DeclareParentsAdvisor.class);</span><br><span class="line">    //添加构造函数的参数  </span><br><span class="line">    //这里的构造函数是指DeclareParentsAdvisor的构造函数  </span><br><span class="line">    builder.addConstructorArgValue(declareParentsElement.getAttribute(IMPLEMENT_INTERFACE));</span><br><span class="line">    //类型匹配表达式</span><br><span class="line">    builder.addConstructorArgValue(declareParentsElement.getAttribute(TYPE_PATTERN));</span><br><span class="line">    //接口的默认实现</span><br><span class="line">    String defaultImpl = declareParentsElement.getAttribute(DEFAULT_IMPL);</span><br><span class="line">    //接口的实现引用</span><br><span class="line">    String delegateRef = declareParentsElement.getAttribute(DELEGATE_REF);</span><br><span class="line">    //指定接口实现或引用</span><br><span class="line">    if (StringUtils.hasText(defaultImpl) &amp;&amp; !StringUtils.hasText(delegateRef)) &#123;</span><br><span class="line">        builder.addConstructorArgValue(defaultImpl);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (StringUtils.hasText(delegateRef) &amp;&amp; !StringUtils.hasText(defaultImpl)) &#123;</span><br><span class="line">        builder.addConstructorArgReference(delegateRef);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;Exactly one of the &quot; + DEFAULT_IMPL + &quot; or &quot; + DELEGATE_REF + &quot; attributes must be specified&quot;,</span><br><span class="line">                declareParentsElement, this.parseState.snapshot());</span><br><span class="line">    &#125;</span><br><span class="line">    //创建DeclareParentsAdvisor的BeanDefinition</span><br><span class="line">    AbstractBeanDefinition definition = builder.getBeanDefinition();</span><br><span class="line">    definition.setSource(parserContext.extractSource(declareParentsElement));</span><br><span class="line">    //注册该BeanDefinition</span><br><span class="line">    parserContext.getReaderContext().registerWithGeneratedName(definition);</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法"><a href="#14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法" class="headerlink" title="14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法"></a>14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition parseAdvice(</span><br><span class="line">        String aspectName, int order, Element aspectElement, Element adviceElement, ParserContext parserContext,</span><br><span class="line">        List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences) &#123;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new AdviceEntry(parserContext.getDelegate().getLocalName(adviceElement)));</span><br><span class="line"></span><br><span class="line">        // create the method factory bean</span><br><span class="line">        //拦截方法工厂BeanDefinition</span><br><span class="line">        RootBeanDefinition methodDefinition = new RootBeanDefinition(MethodLocatingFactoryBean.class);</span><br><span class="line">        methodDefinition.getPropertyValues().add(&quot;targetBeanName&quot;, aspectName);</span><br><span class="line">        methodDefinition.getPropertyValues().add(&quot;methodName&quot;, adviceElement.getAttribute(&quot;method&quot;));</span><br><span class="line">        methodDefinition.setSynthetic(true);</span><br><span class="line"></span><br><span class="line">        // create instance factory definition</span><br><span class="line">        //切面工厂BeanDefinition</span><br><span class="line">        RootBeanDefinition aspectFactoryDef =</span><br><span class="line">                new RootBeanDefinition(SimpleBeanFactoryAwareAspectInstanceFactory.class);</span><br><span class="line">        aspectFactoryDef.getPropertyValues().add(&quot;aspectBeanName&quot;, aspectName);</span><br><span class="line">        aspectFactoryDef.setSynthetic(true);</span><br><span class="line"></span><br><span class="line">        // register the pointcut</span><br><span class="line">        //创建advice的BeanDefinition</span><br><span class="line">        AbstractBeanDefinition adviceDef = createAdviceDefinition(</span><br><span class="line">                adviceElement, parserContext, aspectName, order, methodDefinition, aspectFactoryDef,</span><br><span class="line">                beanDefinitions, beanReferences);</span><br><span class="line"></span><br><span class="line">        // configure the advisor</span><br><span class="line">        //创建通知BeanDefinition</span><br><span class="line">        RootBeanDefinition advisorDefinition = new RootBeanDefinition(AspectJPointcutAdvisor.class);</span><br><span class="line">        advisorDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">        //通知bean添加构造函数参数切面bean</span><br><span class="line">        advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef);</span><br><span class="line">        if (aspectElement.hasAttribute(ORDER_PROPERTY)) &#123;</span><br><span class="line">            advisorDefinition.getPropertyValues().add(</span><br><span class="line">                    ORDER_PROPERTY, aspectElement.getAttribute(ORDER_PROPERTY));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // register the final advisor</span><br><span class="line">        //注册通知BeanDefinition</span><br><span class="line">        parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition);</span><br><span class="line"></span><br><span class="line">        return advisorDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、ConfigBeanDefinitionParser的createAdviceDefinition方法"><a href="#15、ConfigBeanDefinitionParser的createAdviceDefinition方法" class="headerlink" title="15、ConfigBeanDefinitionParser的createAdviceDefinition方法"></a>15、ConfigBeanDefinitionParser的createAdviceDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition createAdviceDefinition(</span><br><span class="line">        Element adviceElement, ParserContext parserContext, String aspectName, int order,</span><br><span class="line">        RootBeanDefinition methodDef, RootBeanDefinition aspectFactoryDef,</span><br><span class="line">        List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences) &#123;</span><br><span class="line">    //创建advice的BeanDefinition，类为AspectJMethodBeforeAdvice或AspectJAfterAdvice等</span><br><span class="line">    RootBeanDefinition adviceDefinition = new RootBeanDefinition(getAdviceClass(adviceElement, parserContext));</span><br><span class="line">    adviceDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">    //添加切面名称</span><br><span class="line">    adviceDefinition.getPropertyValues().add(ASPECT_NAME_PROPERTY, aspectName);</span><br><span class="line">    //添加排序</span><br><span class="line">    adviceDefinition.getPropertyValues().add(DECLARATION_ORDER_PROPERTY, order);</span><br><span class="line"></span><br><span class="line">    if (adviceElement.hasAttribute(RETURNING)) &#123;</span><br><span class="line">        adviceDefinition.getPropertyValues().add(</span><br><span class="line">                RETURNING_PROPERTY, adviceElement.getAttribute(RETURNING));</span><br><span class="line">    &#125;</span><br><span class="line">    if (adviceElement.hasAttribute(THROWING)) &#123;</span><br><span class="line">        adviceDefinition.getPropertyValues().add(</span><br><span class="line">                THROWING_PROPERTY, adviceElement.getAttribute(THROWING));</span><br><span class="line">    &#125;</span><br><span class="line">    if (adviceElement.hasAttribute(ARG_NAMES)) &#123;</span><br><span class="line">        adviceDefinition.getPropertyValues().add(</span><br><span class="line">                ARG_NAMES_PROPERTY, adviceElement.getAttribute(ARG_NAMES));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //将拦截方法加入advice的bean的构造函数参数</span><br><span class="line">    ConstructorArgumentValues cav = adviceDefinition.getConstructorArgumentValues();</span><br><span class="line">    cav.addIndexedArgumentValue(METHOD_INDEX, methodDef);</span><br><span class="line">    //获取切点或切点引用并加入advice的bean的构造函数参数</span><br><span class="line">    Object pointcut = parsePointcutProperty(adviceElement, parserContext);</span><br><span class="line">    if (pointcut instanceof BeanDefinition) &#123;</span><br><span class="line">        cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcut);</span><br><span class="line">        beanDefinitions.add((BeanDefinition) pointcut);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (pointcut instanceof String) &#123;</span><br><span class="line">        RuntimeBeanReference pointcutRef = new RuntimeBeanReference((String) pointcut);</span><br><span class="line">        cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcutRef);</span><br><span class="line">        beanReferences.add(pointcutRef);</span><br><span class="line">    &#125;</span><br><span class="line">    //切面工厂加入advice的bean的构造函数参数</span><br><span class="line">    cav.addIndexedArgumentValue(ASPECT_INSTANCE_FACTORY_INDEX, aspectFactoryDef);</span><br><span class="line"></span><br><span class="line">    return adviceDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、AOP动态代理代理对象创建"><a href="#二、AOP动态代理代理对象创建" class="headerlink" title="二、AOP动态代理代理对象创建"></a>二、AOP动态代理代理对象创建</h3><h4 id="1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法"><a href="#1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法" class="headerlink" title="1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法"></a>1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法</h4><p>创建bean之前会执行InstantiationAwareBeanPostProcessor处理器的postProcessBeforeInstantiation方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123;</span><br><span class="line">    //获取缓存key</span><br><span class="line">    Object cacheKey = getCacheKey(beanClass, beanName);</span><br><span class="line">    //当前targetSourcedBeans（通过自定义TargetSourceCreator创建的TargetSource）不包含cacheKey  </span><br><span class="line">    if (beanName == null || !this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        //基础设施类（如Advisor、Advice、AopInfrastructureBean的实现），不需要创建代理</span><br><span class="line">        if (this.advisedBeans.containsKey(cacheKey)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) &#123;</span><br><span class="line">            this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy here if we have a custom TargetSource.</span><br><span class="line">    // Suppresses unnecessary default instantiation of the target bean:</span><br><span class="line">    // The TargetSource will handle target instances in a custom fashion.</span><br><span class="line">    if (beanName != null) &#123;</span><br><span class="line">        //配置的自定义的TargetSourceCreator创建TargetSource  </span><br><span class="line">        TargetSource targetSource = getCustomTargetSource(beanClass, beanName);</span><br><span class="line">        if (targetSource != null) &#123;</span><br><span class="line">            this.targetSourcedBeans.add(beanName);</span><br><span class="line">            //获取增强</span><br><span class="line">            Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</span><br><span class="line">            //创建代理对象</span><br><span class="line">            Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);</span><br><span class="line">            this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">            return proxy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法"><a href="#2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法" class="headerlink" title="2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法"></a>2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">    // TODO: Consider optimization by caching the list of the aspect names</span><br><span class="line">    //获取通知bean</span><br><span class="line">    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">    for (Advisor advisor : candidateAdvisors) &#123;</span><br><span class="line">        if (advisor instanceof AspectJPointcutAdvisor) &#123;</span><br><span class="line">            //类为切面类，返回true，不需要创建代理</span><br><span class="line">            if (((AbstractAspectJAdvice) advisor.getAdvice()).getAspectName().equals(beanName)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回false</span><br><span class="line">    return super.shouldSkip(beanClass, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AbstractAutoProxyCreator的getEarlyBeanReference方法"><a href="#3、AbstractAutoProxyCreator的getEarlyBeanReference方法" class="headerlink" title="3、AbstractAutoProxyCreator的getEarlyBeanReference方法"></a>3、AbstractAutoProxyCreator的getEarlyBeanReference方法</h4><p>出现循环依赖会调用SmartInstantiationAwareBeanPostProcessor处理器的getEarlyBeanReference<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getEarlyBeanReference(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">    if (!this.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">        this.earlyProxyReferences.add(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建代理对象</span><br><span class="line">    return wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、AbstractAutoProxyCreator的postProcessAfterInitialization方法"><a href="#4、AbstractAutoProxyCreator的postProcessAfterInitialization方法" class="headerlink" title="4、AbstractAutoProxyCreator的postProcessAfterInitialization方法"></a>4、AbstractAutoProxyCreator的postProcessAfterInitialization方法</h4><p>执行完自定义初始化方法后会调用BeanPostProcessor处理器的postProcessAfterInitialization方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    if (bean != null) &#123;</span><br><span class="line">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        //如发生循环依赖此处已经是代理对象</span><br><span class="line">        if (!this.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">            //创建代理对象</span><br><span class="line">            return wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、AbstractAutoProxyCreator的wrapIfNecessary方法"><a href="#5、AbstractAutoProxyCreator的wrapIfNecessary方法" class="headerlink" title="5、AbstractAutoProxyCreator的wrapIfNecessary方法"></a>5、AbstractAutoProxyCreator的wrapIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">    //已经是代理对象</span><br><span class="line">    if (beanName != null &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy if we have advice.</span><br><span class="line">    //获取增强</span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">    if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">        //创建代理</span><br><span class="line">        Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">        this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        return proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有增强，不需要代理</span><br><span class="line">    this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AbstractAutoProxyCreator的wrapIfNecessary方法"><a href="#6、AbstractAutoProxyCreator的wrapIfNecessary方法" class="headerlink" title="6、AbstractAutoProxyCreator的wrapIfNecessary方法"></a>6、AbstractAutoProxyCreator的wrapIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">    //已经是代理对象</span><br><span class="line">    if (beanName != null &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy if we have advice.</span><br><span class="line">    //获取增强</span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">    if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">        //创建代理</span><br><span class="line">        Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">        this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        return proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有增强，不需要代理</span><br><span class="line">    this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法"><a href="#7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法" class="headerlink" title="7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法"></a>7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object[] getAdvicesAndAdvisorsForBean(Class&lt;?&gt; beanClass, String beanName, TargetSource targetSource) &#123;</span><br><span class="line">    //获取通知</span><br><span class="line">    List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName);</span><br><span class="line">    if (advisors.isEmpty()) &#123;</span><br><span class="line">        return DO_NOT_PROXY;</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors.toArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法"><a href="#8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法" class="headerlink" title="8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法"></a>8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">    //获取通知</span><br><span class="line">    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">    //晒选可应用的通知</span><br><span class="line">    List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span><br><span class="line">    extendAdvisors(eligibleAdvisors);</span><br><span class="line">    if (!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">        //通知排序</span><br><span class="line">        eligibleAdvisors = sortAdvisors(eligibleAdvisors);</span><br><span class="line">    &#125;</span><br><span class="line">    return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法"><a href="#9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法" class="headerlink" title="9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法"></a>9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findCandidateAdvisors() &#123;</span><br><span class="line">    return this.advisorRetrievalHelper.findAdvisorBeans();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法"><a href="#10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法" class="headerlink" title="10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法"></a>10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; findAdvisorBeans() &#123;</span><br><span class="line">    // Determine list of advisor bean names, if not cached already.</span><br><span class="line">    String[] advisorNames = null;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        advisorNames = this.cachedAdvisorBeanNames;</span><br><span class="line">        if (advisorNames == null) &#123;</span><br><span class="line">            // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">            // uninitialized to let the auto-proxy creator apply to them!</span><br><span class="line">            //从容器及其父容器获取所有Advisor类型的beanName</span><br><span class="line">            advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(</span><br><span class="line">                    this.beanFactory, Advisor.class, true, false);</span><br><span class="line">            this.cachedAdvisorBeanNames = advisorNames;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //不存在，返回空集合</span><br><span class="line">    if (advisorNames.length == 0) &#123;</span><br><span class="line">        return new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    //加载advisor类型的bean，并返回</span><br><span class="line">    List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    for (String name : advisorNames) &#123;</span><br><span class="line">        //该切面是否有效，即includePatterns是否包含此类</span><br><span class="line">        if (isEligibleBean(name)) &#123;</span><br><span class="line">            if (this.beanFactory.isCurrentlyInCreation(name)) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Skipping currently created advisor &apos;&quot; + name + &quot;&apos;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    advisors.add(this.beanFactory.getBean(name, Advisor.class));</span><br><span class="line">                &#125;</span><br><span class="line">                catch (BeanCreationException ex) &#123;</span><br><span class="line">                    Throwable rootCause = ex.getMostSpecificCause();</span><br><span class="line">                    if (rootCause instanceof BeanCurrentlyInCreationException) &#123;</span><br><span class="line">                        BeanCreationException bce = (BeanCreationException) rootCause;</span><br><span class="line">                        if (this.beanFactory.isCurrentlyInCreation(bce.getBeanName())) &#123;</span><br><span class="line">                            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                                logger.debug(&quot;Skipping advisor &apos;&quot; + name +</span><br><span class="line">                                        &quot;&apos; with dependency on currently created bean: &quot; + ex.getMessage());</span><br><span class="line">                            &#125;</span><br><span class="line">                            // Ignore: indicates a reference back to the bean we&apos;re trying to advise.</span><br><span class="line">                            // We want to find advisors other than the currently created bean itself.</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    throw ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法"><a href="#11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法" class="headerlink" title="11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法"></a>11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findAdvisorsThatCanApply(</span><br><span class="line">        List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">    ProxyCreationContext.setCurrentProxiedBeanName(beanName);</span><br><span class="line">    try &#123;</span><br><span class="line">        return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        ProxyCreationContext.setCurrentProxiedBeanName(null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、AopUtils的findAdvisorsThatCanApply方法"><a href="#12、AopUtils的findAdvisorsThatCanApply方法" class="headerlink" title="12、AopUtils的findAdvisorsThatCanApply方法"></a>12、AopUtils的findAdvisorsThatCanApply方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    if (candidateAdvisors.isEmpty()) &#123;</span><br><span class="line">        return candidateAdvisors;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Advisor&gt; eligibleAdvisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    //首先处理引介增强，如DeclareParentsAdvisor</span><br><span class="line">    for (Advisor candidate : candidateAdvisors) &#123;</span><br><span class="line">        if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123;</span><br><span class="line">            eligibleAdvisors.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    boolean hasIntroductions = !eligibleAdvisors.isEmpty();</span><br><span class="line">    //普通增强</span><br><span class="line">    for (Advisor candidate : candidateAdvisors) &#123;</span><br><span class="line">        if (candidate instanceof IntroductionAdvisor) &#123;</span><br><span class="line">            // already processed</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (canApply(candidate, clazz, hasIntroductions)) &#123;</span><br><span class="line">            eligibleAdvisors.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、AopUtils的canApply方法"><a href="#13、AopUtils的canApply方法" class="headerlink" title="13、AopUtils的canApply方法"></a>13、AopUtils的canApply方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;</span><br><span class="line">    Assert.notNull(pc, &quot;Pointcut must not be null&quot;);</span><br><span class="line">    //切点不匹配该类</span><br><span class="line">    if (!pc.getClassFilter().matches(targetClass)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MethodMatcher methodMatcher = pc.getMethodMatcher();</span><br><span class="line">    IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null;</span><br><span class="line">    if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123;</span><br><span class="line">        introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher;</span><br><span class="line">    &#125;</span><br><span class="line">    //切点只要匹配到一个方法就返回true</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;Class&lt;?&gt;&gt;(ClassUtils.getAllInterfacesForClassAsSet(targetClass));</span><br><span class="line">    classes.add(targetClass);</span><br><span class="line">    for (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">        Method[] methods = clazz.getMethods();</span><br><span class="line">        for (Method method : methods) &#123;</span><br><span class="line">            if ((introductionAwareMethodMatcher != null &amp;&amp;</span><br><span class="line">                    introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions)) ||</span><br><span class="line">                    methodMatcher.matches(method, targetClass)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（二、5）AbstractAutoProxyCreator的createProxy方法"><a href="#14、接（二、5）AbstractAutoProxyCreator的createProxy方法" class="headerlink" title="14、接（二、5）AbstractAutoProxyCreator的createProxy方法"></a>14、接（二、5）AbstractAutoProxyCreator的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected Object createProxy(</span><br><span class="line">        Class&lt;?&gt; beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource) &#123;</span><br><span class="line"></span><br><span class="line">    ProxyFactory proxyFactory = new ProxyFactory();</span><br><span class="line">    proxyFactory.copyFrom(this);</span><br><span class="line">    //返回是否用cglib动态代理直接代理该类，用户配置</span><br><span class="line">    if (!proxyFactory.isProxyTargetClass()) &#123;</span><br><span class="line">        //判断是否用cglib动态代理代理该类</span><br><span class="line">        if (shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line">            proxyFactory.setProxyTargetClass(true);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //判断是否是有合适jdk动态代理的接口，将查找到的接口加入代理工厂</span><br><span class="line">            evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取通知</span><br><span class="line">    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">    for (Advisor advisor : advisors) &#123;</span><br><span class="line">        //通知加入代理工厂，如果存在引介增强，则将引介增强的接口放入待实现接口集合</span><br><span class="line">        proxyFactory.addAdvisor(advisor);</span><br><span class="line">    &#125;</span><br><span class="line">    //要代理的类</span><br><span class="line">    proxyFactory.setTargetSource(targetSource);</span><br><span class="line">    //定制代理，待子类实现</span><br><span class="line">    customizeProxyFactory(proxyFactory);</span><br><span class="line">    //冻结代理工厂配置</span><br><span class="line">    proxyFactory.setFrozen(this.freezeProxy);</span><br><span class="line">    if (advisorsPreFiltered()) &#123;</span><br><span class="line">        proxyFactory.setPreFiltered(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建代理对象</span><br><span class="line">    return proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、AbstractAutoProxyCreator的buildAdvisors方法"><a href="#15、AbstractAutoProxyCreator的buildAdvisors方法" class="headerlink" title="15、AbstractAutoProxyCreator的buildAdvisors方法"></a>15、AbstractAutoProxyCreator的buildAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">protected Advisor[] buildAdvisors(String beanName, Object[] specificInterceptors) &#123;</span><br><span class="line">    // Handle prototypes correctly...</span><br><span class="line">    //解析注册到ProxyFactoryBean中的拦截器</span><br><span class="line">    Advisor[] commonInterceptors = resolveInterceptorNames();</span><br><span class="line">    //interceptorNames加入通知集合</span><br><span class="line">    List&lt;Object&gt; allInterceptors = new ArrayList&lt;Object&gt;();</span><br><span class="line">    if (specificInterceptors != null) &#123;</span><br><span class="line">        allInterceptors.addAll(Arrays.asList(specificInterceptors));</span><br><span class="line">        if (commonInterceptors != null) &#123;</span><br><span class="line">            if (this.applyCommonInterceptorsFirst) &#123;</span><br><span class="line">                allInterceptors.addAll(0, Arrays.asList(commonInterceptors));</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                allInterceptors.addAll(Arrays.asList(commonInterceptors));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        int nrOfCommonInterceptors = (commonInterceptors != null ? commonInterceptors.length : 0);</span><br><span class="line">        int nrOfSpecificInterceptors = (specificInterceptors != null ? specificInterceptors.length : 0);</span><br><span class="line">        logger.debug(&quot;Creating implicit proxy for bean &apos;&quot; + beanName + &quot;&apos; with &quot; + nrOfCommonInterceptors +</span><br><span class="line">                &quot; common interceptors and &quot; + nrOfSpecificInterceptors + &quot; specific interceptors&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Advisor[] advisors = new Advisor[allInterceptors.size()];</span><br><span class="line">    for (int i = 0; i &lt; allInterceptors.size(); i++) &#123;</span><br><span class="line">        //拦截器封装转化为Advisor</span><br><span class="line">        advisors[i] = this.advisorAdapterRegistry.wrap(allInterceptors.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、DefaultAdvisorAdapterRegistry的wrap方法"><a href="#16、DefaultAdvisorAdapterRegistry的wrap方法" class="headerlink" title="16、DefaultAdvisorAdapterRegistry的wrap方法"></a>16、DefaultAdvisorAdapterRegistry的wrap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Advisor wrap(Object adviceObject) throws UnknownAdviceTypeException &#123;</span><br><span class="line">    //已经是Advisor类型无需转换</span><br><span class="line">    if (adviceObject instanceof Advisor) &#123;</span><br><span class="line">        return (Advisor) adviceObject;</span><br><span class="line">    &#125;</span><br><span class="line">    //不是Advice则抛出异常</span><br><span class="line">    if (!(adviceObject instanceof Advice)) &#123;</span><br><span class="line">        throw new UnknownAdviceTypeException(adviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    Advice advice = (Advice) adviceObject;</span><br><span class="line">    if (advice instanceof MethodInterceptor) &#123;</span><br><span class="line">        // So well-known it doesn&apos;t even need an adapter.</span><br><span class="line">        //使用默认切点，全部匹配</span><br><span class="line">        return new DefaultPointcutAdvisor(advice);</span><br><span class="line">    &#125;</span><br><span class="line">    //存在适配器</span><br><span class="line">    for (AdvisorAdapter adapter : this.adapters) &#123;</span><br><span class="line">        // Check that it is supported.</span><br><span class="line">        if (adapter.supportsAdvice(advice)) &#123;</span><br><span class="line">            return new DefaultPointcutAdvisor(advice);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    throw new UnknownAdviceTypeException(advice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、接（二、14）ProxyFactory的getProxy方法"><a href="#17、接（二、14）ProxyFactory的getProxy方法" class="headerlink" title="17、接（二、14）ProxyFactory的getProxy方法"></a>17、接（二、14）ProxyFactory的getProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Object getProxy() &#123;</span><br><span class="line">    return createAopProxy().getProxy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、ProxyFactory的createAopProxy方法"><a href="#18、ProxyFactory的createAopProxy方法" class="headerlink" title="18、ProxyFactory的createAopProxy方法"></a>18、ProxyFactory的createAopProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected final synchronized AopProxy createAopProxy() &#123;</span><br><span class="line">    if (!this.active) &#123;</span><br><span class="line">        //广播代理被创建</span><br><span class="line">        activate();</span><br><span class="line">    &#125;</span><br><span class="line">    //创建代理</span><br><span class="line">    return getAopProxyFactory().createAopProxy(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、DefaultAopProxyFactory的createAopProxy方法"><a href="#19、DefaultAopProxyFactory的createAopProxy方法" class="headerlink" title="19、DefaultAopProxyFactory的createAopProxy方法"></a>19、DefaultAopProxyFactory的createAopProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123;</span><br><span class="line">    //optimize 设置Cglib是否使用激进优化策略</span><br><span class="line">    //proxyTargetClass 设置是否使用Cglib代理</span><br><span class="line">    //是否存在可代理接口</span><br><span class="line">    if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">        Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">        if (targetClass == null) &#123;</span><br><span class="line">            throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; +</span><br><span class="line">                    &quot;Either an interface or a target is required for proxy creation.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //目标类为接口</span><br><span class="line">        if (targetClass.isInterface()) &#123;</span><br><span class="line">            return new JdkDynamicAopProxy(config);</span><br><span class="line">        &#125;</span><br><span class="line">        return new ObjenesisCglibAopProxy(config);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return new JdkDynamicAopProxy(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、JdkDynamicAopProxy的getProxy方法"><a href="#20、JdkDynamicAopProxy的getProxy方法" class="headerlink" title="20、JdkDynamicAopProxy的getProxy方法"></a>20、JdkDynamicAopProxy的getProxy方法</h4><p>jdk动态代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy() &#123;</span><br><span class="line">    return getProxy(ClassUtils.getDefaultClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy(ClassLoader classLoader) &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Creating JDK dynamic proxy: target source is &quot; + this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line">    //获取要代理的全部接口,额外添加SpringProxy接口用以标识AOP代理对象，Advised接口用以操作该对象的advice</span><br><span class="line">    Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised);</span><br><span class="line">    //equals和hashCode方法是否被重写</span><br><span class="line">    findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</span><br><span class="line">    //创建代理对象</span><br><span class="line">    return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、JdkDynamicAopProxy的invoke方法"><a href="#21、JdkDynamicAopProxy的invoke方法" class="headerlink" title="21、JdkDynamicAopProxy的invoke方法"></a>21、JdkDynamicAopProxy的invoke方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    MethodInvocation invocation;</span><br><span class="line">    Object oldProxy = null;</span><br><span class="line">    boolean setProxyContext = false;</span><br><span class="line"></span><br><span class="line">    TargetSource targetSource = this.advised.targetSource;</span><br><span class="line">    Class&lt;?&gt; targetClass = null;</span><br><span class="line">    Object target = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //处理equals方法</span><br><span class="line">        if (!this.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">            // The target does not implement the equals(Object) method itself.</span><br><span class="line">            return equals(args[0]);</span><br><span class="line">        &#125;</span><br><span class="line">        //hash方法处理</span><br><span class="line">        if (!this.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">            // The target does not implement the hashCode() method itself.</span><br><span class="line">            return hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">        //Advised的方法或者其超类接口的方法，执行ProxyFactory对象的方法，用于操作增强</span><br><span class="line">        if (!this.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span><br><span class="line">                method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">            // Service invocations on ProxyConfig with the proxy config...</span><br><span class="line">            return AopUtils.invokeJoinpointUsingReflection(this.advised, method, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object retVal;</span><br><span class="line">        //支持对象内部自我调用时，可获取到代理对象，将该代理对象放入本地线程变量</span><br><span class="line">        if (this.advised.exposeProxy) &#123;</span><br><span class="line">            // Make invocation available if necessary.</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // May be null. Get as late as possible to minimize the time we &quot;own&quot; the target,</span><br><span class="line">        // in case it comes from a pool.</span><br><span class="line">        //被代理的对象</span><br><span class="line">        target = targetSource.getTarget();</span><br><span class="line">        if (target != null) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Get the interception chain for this method.</span><br><span class="line">        //获取当前方法的拦截器链</span><br><span class="line">        List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line"></span><br><span class="line">        // Check whether we have any advice. If we don&apos;t, we can fallback on direct</span><br><span class="line">        // reflective invocation of the target, and avoid creating a MethodInvocation.</span><br><span class="line">        if (chain.isEmpty()) &#123;</span><br><span class="line">            // We can skip creating a MethodInvocation: just invoke the target directly</span><br><span class="line">            // Note that the final invoker must be an InvokerInterceptor so we know it does</span><br><span class="line">            // nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span><br><span class="line">            //没有拦截器，直接调用对象方法</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, args);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // We need to create a method invocation...</span><br><span class="line">            //封装拦截器链</span><br><span class="line">            invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">            // Proceed to the joinpoint through the interceptor chain.</span><br><span class="line">            //执行拦截器链</span><br><span class="line">            retVal = invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Massage return value if necessary.</span><br><span class="line">        //返回结果</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        if (retVal != null &amp;&amp; retVal == target &amp;&amp; returnType.isInstance(proxy) &amp;&amp;</span><br><span class="line">                !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">            // Special case: it returned &quot;this&quot; and the return type of the method</span><br><span class="line">            // is type-compatible. Note that we can&apos;t help if the target sets</span><br><span class="line">            // a reference to itself in another returned object.</span><br><span class="line">            retVal = proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">            throw new AopInvocationException(</span><br><span class="line">                    &quot;Null return value from advice does not match primitive return type for: &quot; + method);</span><br><span class="line">        &#125;</span><br><span class="line">        return retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        if (target != null &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            // Must have come from TargetSource.</span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        if (setProxyContext) &#123;</span><br><span class="line">            // Restore old proxy.</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法"><a href="#22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法" class="headerlink" title="22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法"></a>22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">    MethodCacheKey cacheKey = new MethodCacheKey(method);</span><br><span class="line">    List&lt;Object&gt; cached = this.methodCache.get(cacheKey);</span><br><span class="line">    if (cached == null) &#123;</span><br><span class="line">        //获取拦截器链</span><br><span class="line">        cached = this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice(</span><br><span class="line">                this, method, targetClass);</span><br><span class="line">        this.methodCache.put(cacheKey, cached);</span><br><span class="line">    &#125;</span><br><span class="line">    return cached;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法"><a href="#23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法" class="headerlink" title="23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法"></a>23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(</span><br><span class="line">        Advised config, Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line"></span><br><span class="line">    // This is somewhat tricky... We have to process introductions first,</span><br><span class="line">    // but we need to preserve order in the ultimate list.</span><br><span class="line">    List&lt;Object&gt; interceptorList = new ArrayList&lt;Object&gt;(config.getAdvisors().length);</span><br><span class="line">    Class&lt;?&gt; actualClass = (targetClass != null ? targetClass : method.getDeclaringClass());</span><br><span class="line">    //是否有适合该类的引介增强</span><br><span class="line">    boolean hasIntroductions = hasMatchingIntroductions(config, actualClass);</span><br><span class="line">    AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance();</span><br><span class="line"></span><br><span class="line">    for (Advisor advisor : config.getAdvisors()) &#123;</span><br><span class="line">        if (advisor instanceof PointcutAdvisor) &#123;</span><br><span class="line">            // Add it conditionally.</span><br><span class="line">            PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor;</span><br><span class="line">            //通知匹配该类</span><br><span class="line">            if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) &#123;</span><br><span class="line">                MethodInterceptor[] interceptors = registry.getInterceptors(advisor);</span><br><span class="line">                MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher();</span><br><span class="line">                //通知匹配该方法</span><br><span class="line">                if (MethodMatchers.matches(mm, method, actualClass, hasIntroductions)) &#123;</span><br><span class="line">                    //动态匹配</span><br><span class="line">                    if (mm.isRuntime()) &#123;</span><br><span class="line">                        // Creating a new object instance in the getInterceptors() method</span><br><span class="line">                        // isn&apos;t a problem as we normally cache created chains.</span><br><span class="line">                        for (MethodInterceptor interceptor : interceptors) &#123;</span><br><span class="line">                            interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //普通拦截器</span><br><span class="line">                    else &#123;</span><br><span class="line">                        interceptorList.addAll(Arrays.asList(interceptors));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //引介增强</span><br><span class="line">        else if (advisor instanceof IntroductionAdvisor) &#123;</span><br><span class="line">            IntroductionAdvisor ia = (IntroductionAdvisor) advisor;</span><br><span class="line">            if (config.isPreFiltered() || ia.getClassFilter().matches(actualClass)) &#123;</span><br><span class="line">                //获取引介增强的拦截器，如DelegatingIntroductionInterceptor，</span><br><span class="line">                //该拦截器会拦截引介增强接口中的方法处理然后返回，其余方法直接放行</span><br><span class="line">                Interceptor[] interceptors = registry.getInterceptors(advisor);</span><br><span class="line">                interceptorList.addAll(Arrays.asList(interceptors));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            Interceptor[] interceptors = registry.getInterceptors(advisor);</span><br><span class="line">            interceptorList.addAll(Arrays.asList(interceptors));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return interceptorList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="24、接（二、21）ReflectiveMethodInvocation的proceed方法"><a href="#24、接（二、21）ReflectiveMethodInvocation的proceed方法" class="headerlink" title="24、接（二、21）ReflectiveMethodInvocation的proceed方法"></a>24、接（二、21）ReflectiveMethodInvocation的proceed方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">    //  We start with an index of -1 and increment early.</span><br><span class="line">    //执行完所有的通知，执行目标方法</span><br><span class="line">    if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">        return invokeJoinpoint();</span><br><span class="line">    &#125;</span><br><span class="line">    //获取下一个要执行的拦截器</span><br><span class="line">    Object interceptorOrInterceptionAdvice =</span><br><span class="line">            this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</span><br><span class="line">    //动态匹配</span><br><span class="line">    if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">        // Evaluate dynamic method matcher here: static part will already have</span><br><span class="line">        // been evaluated and found to match.</span><br><span class="line">        InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">        if (dm.methodMatcher.matches(this.method, this.targetClass, this.arguments)) &#123;</span><br><span class="line">            return dm.interceptor.invoke(this);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Dynamic matching failed.</span><br><span class="line">            // Skip this interceptor and invoke the next in the chain.</span><br><span class="line">            //不匹配则不拦截</span><br><span class="line">            return proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // It&apos;s an interceptor, so we just invoke it: The pointcut will have</span><br><span class="line">        // been evaluated statically before this object was constructed.</span><br><span class="line">        //普通拦截器，递归调用proceed</span><br><span class="line">        return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25、CglibAopProxy的getProxy方法"><a href="#25、CglibAopProxy的getProxy方法" class="headerlink" title="25、CglibAopProxy的getProxy方法"></a>25、CglibAopProxy的getProxy方法</h4><p>CglibAopProxy的动态代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy() &#123;</span><br><span class="line">    return getProxy(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy(ClassLoader classLoader) &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Creating CGLIB proxy: target source is &quot; + this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //代理的目标类</span><br><span class="line">        Class&lt;?&gt; rootClass = this.advised.getTargetClass();</span><br><span class="line">        Assert.state(rootClass != null, &quot;Target class must be available for creating a CGLIB proxy&quot;);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; proxySuperClass = rootClass;</span><br><span class="line">        //该类已经是代理类</span><br><span class="line">        if (ClassUtils.isCglibProxyClass(rootClass)) &#123;</span><br><span class="line">            proxySuperClass = rootClass.getSuperclass();</span><br><span class="line">            Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();</span><br><span class="line">            for (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;</span><br><span class="line">                this.advised.addInterface(additionalInterface);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Validate the class, writing log messages as necessary.</span><br><span class="line">        //验证类及其父类有无不可被代理的方法</span><br><span class="line">        validateClassIfNecessary(proxySuperClass, classLoader);</span><br><span class="line"></span><br><span class="line">        // Configure CGLIB Enhancer...</span><br><span class="line">        Enhancer enhancer = createEnhancer();</span><br><span class="line">        if (classLoader != null) &#123;</span><br><span class="line">            enhancer.setClassLoader(classLoader);</span><br><span class="line">            if (classLoader instanceof SmartClassLoader &amp;&amp;</span><br><span class="line">                    ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">                enhancer.setUseCache(false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //被代理的类</span><br><span class="line">        enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">        //代理类实现的接口</span><br><span class="line">        enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(this.advised));</span><br><span class="line">        enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">        enhancer.setStrategy(new UndeclaredThrowableStrategy(UndeclaredThrowableException.class));</span><br><span class="line">        //设置拦截器</span><br><span class="line">        Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">        Class&lt;?&gt;[] types = new Class&lt;?&gt;[callbacks.length];</span><br><span class="line">        for (int x = 0; x &lt; types.length; x++) &#123;</span><br><span class="line">            types[x] = callbacks[x].getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        // fixedInterceptorMap only populated at this point, after getCallbacks call above</span><br><span class="line">        //过滤器</span><br><span class="line">        enhancer.setCallbackFilter(new ProxyCallbackFilter(</span><br><span class="line">                this.advised.getConfigurationOnlyCopy(), this.fixedInterceptorMap, this.fixedInterceptorOffset));</span><br><span class="line">        enhancer.setCallbackTypes(types);</span><br><span class="line"></span><br><span class="line">        // Generate the proxy class and create a proxy instance.</span><br><span class="line">        //创建代理对象</span><br><span class="line">        return createProxyClassAndInstance(enhancer, callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (CodeGenerationException ex) &#123;</span><br><span class="line">        throw new AopConfigException(&quot;Could not generate CGLIB subclass of class [&quot; +</span><br><span class="line">                this.advised.getTargetClass() + &quot;]: &quot; +</span><br><span class="line">                &quot;Common causes of this problem include using a final class or a non-visible class&quot;,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IllegalArgumentException ex) &#123;</span><br><span class="line">        throw new AopConfigException(&quot;Could not generate CGLIB subclass of class [&quot; +</span><br><span class="line">                this.advised.getTargetClass() + &quot;]: &quot; +</span><br><span class="line">                &quot;Common causes of this problem include using a final class or a non-visible class&quot;,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        // TargetSource.getTarget() failed</span><br><span class="line">        throw new AopConfigException(&quot;Unexpected AOP exception&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="26、CglibAopProxy的getCallbacks方法"><a href="#26、CglibAopProxy的getCallbacks方法" class="headerlink" title="26、CglibAopProxy的getCallbacks方法"></a>26、CglibAopProxy的getCallbacks方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">private Callback[] getCallbacks(Class&lt;?&gt; rootClass) throws Exception &#123;</span><br><span class="line">    // Parameters used for optimisation choices...</span><br><span class="line">    boolean exposeProxy = this.advised.isExposeProxy();</span><br><span class="line">    boolean isFrozen = this.advised.isFrozen();</span><br><span class="line">    //getTarget每次获取的是同一个对象，默认true</span><br><span class="line">    boolean isStatic = this.advised.getTargetSource().isStatic();</span><br><span class="line"></span><br><span class="line">    // Choose an &quot;aop&quot; interceptor (used for AOP calls).</span><br><span class="line">    //拦截器</span><br><span class="line">    Callback aopInterceptor = new DynamicAdvisedInterceptor(this.advised);</span><br><span class="line"></span><br><span class="line">    // Choose a &quot;straight to target&quot; interceptor. (used for calls that are</span><br><span class="line">    // unadvised but can return this). May be required to expose the proxy.</span><br><span class="line">    Callback targetInterceptor;</span><br><span class="line">    //类内部调用时，是否增强</span><br><span class="line">    if (exposeProxy) &#123;</span><br><span class="line">        targetInterceptor = isStatic ?</span><br><span class="line">                new StaticUnadvisedExposedInterceptor(this.advised.getTargetSource().getTarget()) :</span><br><span class="line">                new DynamicUnadvisedExposedInterceptor(this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        targetInterceptor = isStatic ?</span><br><span class="line">                new StaticUnadvisedInterceptor(this.advised.getTargetSource().getTarget()) :</span><br><span class="line">                new DynamicUnadvisedInterceptor(this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Choose a &quot;direct to target&quot; dispatcher (used for</span><br><span class="line">    // unadvised calls to static targets that cannot return this).</span><br><span class="line">    Callback targetDispatcher = isStatic ?</span><br><span class="line">            new StaticDispatcher(this.advised.getTargetSource().getTarget()) : new SerializableNoOp();</span><br><span class="line"></span><br><span class="line">    Callback[] mainCallbacks = new Callback[]&#123;</span><br><span class="line">        //aop增强</span><br><span class="line">        aopInterceptor, // for normal advice</span><br><span class="line">        //直接执行被代理对象的方法，不增强</span><br><span class="line">        targetInterceptor, // invoke target without considering advice, if optimized</span><br><span class="line">        //代理类无该方法，不处理</span><br><span class="line">        new SerializableNoOp(), // no override for methods mapped to this</span><br><span class="line">        //直接返回内部对象</span><br><span class="line">        targetDispatcher, this.advisedDispatcher,</span><br><span class="line">        //处理Equals方法</span><br><span class="line">        new EqualsInterceptor(this.advised),</span><br><span class="line">        //处理HashCode方法</span><br><span class="line">        new HashCodeInterceptor(this.advised)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Callback[] callbacks;</span><br><span class="line"></span><br><span class="line">    // If the target is a static one and the advice chain is frozen,</span><br><span class="line">    // then we can make some optimisations by sending the AOP calls</span><br><span class="line">    // direct to the target using the fixed chain for that method.</span><br><span class="line">    //getTarget每次获取同一对象且通知链不可被修改</span><br><span class="line">    if (isStatic &amp;&amp; isFrozen) &#123;</span><br><span class="line">        Method[] methods = rootClass.getMethods();</span><br><span class="line">        Callback[] fixedCallbacks = new Callback[methods.length];</span><br><span class="line">        this.fixedInterceptorMap = new HashMap&lt;String, Integer&gt;(methods.length);</span><br><span class="line"></span><br><span class="line">        // TODO: small memory optimisation here (can skip creation for methods with no advice)</span><br><span class="line">        //创建每个方法的拦截器链的缓存</span><br><span class="line">        for (int x = 0; x &lt; methods.length; x++) &#123;</span><br><span class="line">            List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(methods[x], rootClass);</span><br><span class="line">            fixedCallbacks[x] = new FixedChainStaticTargetInterceptor(</span><br><span class="line">                    chain, this.advised.getTargetSource().getTarget(), this.advised.getTargetClass());</span><br><span class="line">            this.fixedInterceptorMap.put(methods[x].toString(), x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Now copy both the callbacks from mainCallbacks</span><br><span class="line">        // and fixedCallbacks into the callbacks array.</span><br><span class="line">        callbacks = new Callback[mainCallbacks.length + fixedCallbacks.length];</span><br><span class="line">        System.arraycopy(mainCallbacks, 0, callbacks, 0, mainCallbacks.length);</span><br><span class="line">        System.arraycopy(fixedCallbacks, 0, callbacks, mainCallbacks.length, fixedCallbacks.length);</span><br><span class="line">        this.fixedInterceptorOffset = mainCallbacks.length;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        callbacks = mainCallbacks;</span><br><span class="line">    &#125;</span><br><span class="line">    return callbacks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="27、ProxyCallbackFilter的accept方法"><a href="#27、ProxyCallbackFilter的accept方法" class="headerlink" title="27、ProxyCallbackFilter的accept方法"></a>27、ProxyCallbackFilter的accept方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int accept(Method method) &#123;</span><br><span class="line">    //finalize方法 不处理</span><br><span class="line">    if (AopUtils.isFinalizeMethod(method)) &#123;</span><br><span class="line">        logger.debug(&quot;Found finalize() method - using NO_OVERRIDE&quot;);</span><br><span class="line">        return NO_OVERRIDE;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回advised对象</span><br><span class="line">    if (!this.advised.isOpaque() &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span><br><span class="line">            method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Method is declared on Advised interface: &quot; + method);</span><br><span class="line">        &#125;</span><br><span class="line">        return DISPATCH_ADVISED;</span><br><span class="line">    &#125;</span><br><span class="line">    // We must always proxy equals, to direct calls to this.</span><br><span class="line">    //equals方法</span><br><span class="line">    if (AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">        logger.debug(&quot;Found &apos;equals&apos; method: &quot; + method);</span><br><span class="line">        return INVOKE_EQUALS;</span><br><span class="line">    &#125;</span><br><span class="line">    // We must always calculate hashCode based on the proxy.</span><br><span class="line">    //hashCode方法</span><br><span class="line">    if (AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">        logger.debug(&quot;Found &apos;hashCode&apos; method: &quot; + method);</span><br><span class="line">        return INVOKE_HASHCODE;</span><br><span class="line">    &#125;</span><br><span class="line">    //代理目标类</span><br><span class="line">    Class&lt;?&gt; targetClass = this.advised.getTargetClass();</span><br><span class="line">    // Proxy is not yet available, but that shouldn&apos;t matter.</span><br><span class="line">    List&lt;?&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">    //是否有通知链</span><br><span class="line">    boolean haveAdvice = !chain.isEmpty();</span><br><span class="line">    //内部调用是否执行通知链</span><br><span class="line">    boolean exposeProxy = this.advised.isExposeProxy();</span><br><span class="line">    boolean isStatic = this.advised.getTargetSource().isStatic();</span><br><span class="line">    boolean isFrozen = this.advised.isFrozen();</span><br><span class="line">    if (haveAdvice || !isFrozen) &#123;</span><br><span class="line">        // If exposing the proxy, then AOP_PROXY must be used.</span><br><span class="line">        if (exposeProxy) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Must expose proxy on advised method: &quot; + method);</span><br><span class="line">            &#125;</span><br><span class="line">            //执行AOP增强</span><br><span class="line">            return AOP_PROXY;</span><br><span class="line">        &#125;</span><br><span class="line">        String key = method.toString();</span><br><span class="line">        // Check to see if we have fixed interceptor to serve this method.</span><br><span class="line">        // Else use the AOP_PROXY.</span><br><span class="line">        //使用缓存的方法通知链</span><br><span class="line">        if (isStatic &amp;&amp; isFrozen &amp;&amp; this.fixedInterceptorMap.containsKey(key)) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method has advice and optimisations are enabled: &quot; + method);</span><br><span class="line">            &#125;</span><br><span class="line">            // We know that we are optimising so we can use the</span><br><span class="line">            // FixedStaticChainInterceptors.</span><br><span class="line">            int index = this.fixedInterceptorMap.get(key);</span><br><span class="line">            return (index + this.fixedInterceptorOffset);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Unable to apply any optimisations to advised method: &quot; + method);</span><br><span class="line">            &#125;</span><br><span class="line">            //执行AOP增强</span><br><span class="line">            return AOP_PROXY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // See if the return type of the method is outside the class hierarchy</span><br><span class="line">        // of the target type. If so we know it never needs to have return type</span><br><span class="line">        // massage and can use a dispatcher.</span><br><span class="line">        // If the proxy is being exposed, then must use the interceptor the</span><br><span class="line">        // correct one is already configured. If the target is not static, then</span><br><span class="line">        // cannot use a dispatcher because the target cannot be released.</span><br><span class="line">        //直接执行方法</span><br><span class="line">        if (exposeProxy || !isStatic) &#123;</span><br><span class="line">            return INVOKE_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        //返回该代理对象</span><br><span class="line">        if (targetClass == returnType) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method &quot; + method +</span><br><span class="line">                        &quot;has return type same as target type (may return this) - using INVOKE_TARGET&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return INVOKE_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">        //直接返回被代理对象</span><br><span class="line">        else if (returnType.isPrimitive() || !returnType.isAssignableFrom(targetClass)) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method &quot; + method +</span><br><span class="line">                        &quot; has return type that ensures this cannot be returned- using DISPATCH_TARGET&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return DISPATCH_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method &quot; + method +</span><br><span class="line">                        &quot;has return type that is assignable from the target type (may return this) - &quot; +</span><br><span class="line">                        &quot;using INVOKE_TARGET&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return INVOKE_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="28、DynamicAdvisedInterceptor的intercept方法"><a href="#28、DynamicAdvisedInterceptor的intercept方法" class="headerlink" title="28、DynamicAdvisedInterceptor的intercept方法"></a>28、DynamicAdvisedInterceptor的intercept方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">    Object oldProxy = null;</span><br><span class="line">    boolean setProxyContext = false;</span><br><span class="line">    Class&lt;?&gt; targetClass = null;</span><br><span class="line">    Object target = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        //内部调用代理</span><br><span class="line">        if (this.advised.exposeProxy) &#123;</span><br><span class="line">            // Make invocation available if necessary.</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = true;</span><br><span class="line">        &#125;</span><br><span class="line">        // May be null. Get as late as possible to minimize the time we</span><br><span class="line">        // &quot;own&quot; the target, in case it comes from a pool...</span><br><span class="line">        target = getTarget();</span><br><span class="line">        if (target != null) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        //获取通知链</span><br><span class="line">        List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">        Object retVal;</span><br><span class="line">        // Check whether we only have one InvokerInterceptor: that is,</span><br><span class="line">        // no real advice, but just reflective invocation of the target.</span><br><span class="line">        if (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">            // We can skip creating a MethodInvocation: just invoke the target directly.</span><br><span class="line">            // Note that the final invoker must be an InvokerInterceptor, so we know</span><br><span class="line">            // it does nothing but a reflective operation on the target, and no hot</span><br><span class="line">            // swapping or fancy proxying.</span><br><span class="line">            //直接执行该方法</span><br><span class="line">            retVal = methodProxy.invoke(target, args);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // We need to create a method invocation...</span><br><span class="line">            //执行通知链</span><br><span class="line">            retVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        //处理返回结果</span><br><span class="line">        retVal = processReturnType(proxy, target, method, retVal);</span><br><span class="line">        return retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        if (target != null) &#123;</span><br><span class="line">            releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        if (setProxyContext) &#123;</span><br><span class="line">            // Restore old proxy.</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、注解方式的AOP动态代理"><a href="#二、注解方式的AOP动态代理" class="headerlink" title="二、注解方式的AOP动态代理"></a>二、注解方式的AOP动态代理</h3><h4 id="demo-1"><a href="#demo-1" class="headerlink" title="demo"></a>demo</h4><p>配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">    xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/context</span><br><span class="line">        http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;  </span><br><span class="line">       </span><br><span class="line">    &lt;!-- 开启aop注解方式,默认为false --&gt;    </span><br><span class="line">    &lt;aop:aspectj-autoproxy&gt;</span><br><span class="line">        //切面类名</span><br><span class="line">        &lt;aop:include name=&quot;aop&quot;/&gt;</span><br><span class="line">    &lt;/aop:aspectj-autoproxy&gt;</span><br><span class="line">     </span><br><span class="line">    &lt;bean id=&quot;userDao&quot; class=&quot;com.baobaotao.simple.UserDao&quot;&gt;&lt;/bean&gt;</span><br><span class="line">    &lt;bean class=&quot;com.demo.aop.AOP&quot;&gt;&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><p>切面示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Aspect  //指定当前类为切面类</span><br><span class="line">public class Aop &#123;</span><br><span class="line"></span><br><span class="line">    //拦截该对象下所有方法</span><br><span class="line">    @Pointcut(&quot;execution(* com.demo.aop.UserDao.*(..))&quot;)</span><br><span class="line">    public void pointCut()&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Before(&quot;pointCut()&quot;)</span><br><span class="line">    public void begin()&#123;</span><br><span class="line">        System.out.println(&quot;开启事务&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @After(&quot;pointCut()&quot;)</span><br><span class="line">    public void close()&#123;</span><br><span class="line">        System.out.println(&quot;关闭事务&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      //&quot;+&quot;表示demo的所有子类；defaultImpl 表示默认需要添加的新的类</span><br><span class="line">    @DeclareParents(value = &quot;com.demo.Demo+&quot;, defaultImpl = Demo.class)</span><br><span class="line">    public UserDao userDao;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>被增强的对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class UserDao &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void save() &#123;</span><br><span class="line">        System.out.println(&quot;..核心业务--核心业务..&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="1、AspectJAutoProxyBeanDefinitionParser的parse方法"><a href="#1、AspectJAutoProxyBeanDefinitionParser的parse方法" class="headerlink" title="1、AspectJAutoProxyBeanDefinitionParser的parse方法"></a>1、AspectJAutoProxyBeanDefinitionParser的parse方法</h4><p>读取配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //注册AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">    AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);</span><br><span class="line">    //将子节点的相关信息添加到beanDefinition</span><br><span class="line">    extendBeanDefinition(element, parserContext);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"><a href="#2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法" class="headerlink" title="2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"></a>2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary(</span><br><span class="line">        ParserContext parserContext, Element sourceElement) &#123;</span><br><span class="line">    //注册AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(</span><br><span class="line">            parserContext.getRegistry(), parserContext.extractSource(sourceElement));</span><br><span class="line">    //设置proxyTargetClass和exposeProxy属性</span><br><span class="line">    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</span><br><span class="line">    //注册并广播AOP组件</span><br><span class="line">    registerComponentIfNecessary(beanDefinition, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"><a href="#3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法" class="headerlink" title="3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"></a>3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法"><a href="#4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法" class="headerlink" title="4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法"></a>4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private static BeanDefinition registerOrEscalateApcAsRequired(Class&lt;?&gt; cls, BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">    //已存在，选择优先级高的</span><br><span class="line">    if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        if (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;</span><br><span class="line">            int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName());</span><br><span class="line">            int requiredPriority = findPriorityForClass(cls);</span><br><span class="line">            if (currentPriority &lt; requiredPriority) &#123;</span><br><span class="line">                apcDefinition.setBeanClassName(cls.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //AnnotationAwareAspectJAutoProxyCreator的BeanDefinition</span><br><span class="line">    RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);</span><br><span class="line">    beanDefinition.setSource(source);</span><br><span class="line">    //最高的优先级</span><br><span class="line">    beanDefinition.getPropertyValues().add(&quot;order&quot;, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    //基础设施</span><br><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //注册该BeanDefinition</span><br><span class="line">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line">    return beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法"><a href="#5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法" class="headerlink" title="5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法"></a>5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void extendBeanDefinition(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    BeanDefinition beanDef =</span><br><span class="line">            parserContext.getRegistry().getBeanDefinition(AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">    if (element.hasChildNodes()) &#123;</span><br><span class="line">        //解析子节点</span><br><span class="line">        addIncludePatterns(element, parserContext, beanDef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法"><a href="#6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法" class="headerlink" title="6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法"></a>6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void addIncludePatterns(Element element, ParserContext parserContext, BeanDefinition beanDef) &#123;</span><br><span class="line">    ManagedList&lt;TypedStringValue&gt; includePatterns = new ManagedList&lt;TypedStringValue&gt;();</span><br><span class="line">    NodeList childNodes = element.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; childNodes.getLength(); i++) &#123;</span><br><span class="line">        Node node = childNodes.item(i);</span><br><span class="line">        if (node instanceof Element) &#123;</span><br><span class="line">            Element includeElement = (Element) node;</span><br><span class="line">            TypedStringValue valueHolder = new TypedStringValue(includeElement.getAttribute(&quot;name&quot;));</span><br><span class="line">            valueHolder.setSource(parserContext.extractSource(includeElement));</span><br><span class="line">            includePatterns.add(valueHolder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!includePatterns.isEmpty()) &#123;</span><br><span class="line">        includePatterns.setSource(parserContext.extractSource(element));</span><br><span class="line">        //子节点加入bean</span><br><span class="line">        beanDef.getPropertyValues().add(&quot;includePatterns&quot;, includePatterns);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法"><a href="#7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法" class="headerlink" title="7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法"></a>7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法</h4><p>创建代理对象之前，首先获取通知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected List&lt;Advisor&gt; findCandidateAdvisors() &#123;</span><br><span class="line">    // Add all the Spring advisors found according to superclass rules.</span><br><span class="line">    //父类的获取通知方法，与上一节相同</span><br><span class="line">    List&lt;Advisor&gt; advisors = super.findCandidateAdvisors();</span><br><span class="line">    // Build Advisors for all AspectJ aspects in the bean factory.</span><br><span class="line">    //获取注解AspectJ的类的通知器</span><br><span class="line">    advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors());</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法"><a href="#8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法" class="headerlink" title="8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法"></a>8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; buildAspectJAdvisors() &#123;</span><br><span class="line">    List&lt;String&gt; aspectNames = null;</span><br><span class="line"></span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        aspectNames = this.aspectBeanNames;</span><br><span class="line">        if (aspectNames == null) &#123;</span><br><span class="line">            List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">            aspectNames = new LinkedList&lt;String&gt;();</span><br><span class="line">            //获取所有beanName</span><br><span class="line">            String[] beanNames =</span><br><span class="line">                    BeanFactoryUtils.beanNamesForTypeIncludingAncestors(this.beanFactory, Object.class, true, false);</span><br><span class="line">            for (String beanName : beanNames) &#123;</span><br><span class="line">                //不合法的bean，默认true，子类定义规则</span><br><span class="line">                if (!isEligibleBean(beanName)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // We must be careful not to instantiate beans eagerly as in this</span><br><span class="line">                // case they would be cached by the Spring container but would not</span><br><span class="line">                // have been weaved</span><br><span class="line">                Class&lt;?&gt; beanType = this.beanFactory.getType(beanName);</span><br><span class="line">                if (beanType == null) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //该类是否有Aspect注解</span><br><span class="line">                if (this.advisorFactory.isAspect(beanType)) &#123;</span><br><span class="line">                    aspectNames.add(beanName);</span><br><span class="line">                    AspectMetadata amd = new AspectMetadata(beanType, beanName);</span><br><span class="line">                    if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) &#123;</span><br><span class="line">                        MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">                                new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">                        //获取类中的增强方法</span><br><span class="line">                        List&lt;Advisor&gt; classAdvisors = this.advisorFactory.getAdvisors(factory);</span><br><span class="line">                        //添加缓存</span><br><span class="line">                        if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">                            this.advisorsCache.put(beanName, classAdvisors);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else &#123;</span><br><span class="line">                            this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">                        &#125;</span><br><span class="line">                        advisors.addAll(classAdvisors);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        // Per target or per this.</span><br><span class="line">                        if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">                            throw new IllegalArgumentException(&quot;Bean with name &apos;&quot; + beanName +</span><br><span class="line">                                    &quot;&apos; is a singleton, but aspect instantiation model is not singleton&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">                                new PrototypeAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">                        this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">                        advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            this.aspectBeanNames = aspectNames;</span><br><span class="line">            return advisors;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (aspectNames.isEmpty()) &#123;</span><br><span class="line">        return Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    //获取缓存中的通知器</span><br><span class="line">    List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    for (String aspectName : aspectNames) &#123;</span><br><span class="line">        List&lt;Advisor&gt; cachedAdvisors = this.advisorsCache.get(aspectName);</span><br><span class="line">        if (cachedAdvisors != null) &#123;</span><br><span class="line">            advisors.addAll(cachedAdvisors);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            MetadataAwareAspectInstanceFactory factory = this.aspectFactoryCache.get(aspectName);</span><br><span class="line">            advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ReflectiveAspectJAdvisorFactory的getAdvisors方法"><a href="#9、ReflectiveAspectJAdvisorFactory的getAdvisors方法" class="headerlink" title="9、ReflectiveAspectJAdvisorFactory的getAdvisors方法"></a>9、ReflectiveAspectJAdvisorFactory的getAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public List&lt;Advisor&gt; getAdvisors(MetadataAwareAspectInstanceFactory maaif) &#123;</span><br><span class="line">    final Class&lt;?&gt; aspectClass = maaif.getAspectMetadata().getAspectClass();</span><br><span class="line">    final String aspectName = maaif.getAspectMetadata().getAspectName();</span><br><span class="line">    //验证该类</span><br><span class="line">    validate(aspectClass);</span><br><span class="line"></span><br><span class="line">    // We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span><br><span class="line">    // so that it will only instantiate once.</span><br><span class="line">    final MetadataAwareAspectInstanceFactory lazySingletonAspectInstanceFactory =</span><br><span class="line">            new LazySingletonAspectInstanceFactoryDecorator(maaif);</span><br><span class="line"></span><br><span class="line">    final List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    //处理所有注解不为Pointcut的方法</span><br><span class="line">    for (Method method : getAdvisorMethods(aspectClass)) &#123;</span><br><span class="line">        //创建通知器</span><br><span class="line">        Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, advisors.size(), aspectName);</span><br><span class="line">        if (advisor != null) &#123;</span><br><span class="line">            advisors.add(advisor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If it&apos;s a per target aspect, emit the dummy instantiating aspect.</span><br><span class="line">    //通知延迟初始化</span><br><span class="line">    if (!advisors.isEmpty() &amp;&amp; lazySingletonAspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) &#123;</span><br><span class="line">        Advisor instantiationAdvisor = new SyntheticInstantiationAdvisor(lazySingletonAspectInstanceFactory);</span><br><span class="line">        advisors.add(0, instantiationAdvisor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Find introduction fields.</span><br><span class="line">    //处理DeclareParents注解</span><br><span class="line">    for (Field field : aspectClass.getDeclaredFields()) &#123;</span><br><span class="line">        Advisor advisor = getDeclareParentsAdvisor(field);</span><br><span class="line">        if (advisor != null) &#123;</span><br><span class="line">            advisors.add(advisor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、ReflectiveAspectJAdvisorFactory的getAdvisor方法"><a href="#10、ReflectiveAspectJAdvisorFactory的getAdvisor方法" class="headerlink" title="10、ReflectiveAspectJAdvisorFactory的getAdvisor方法"></a>10、ReflectiveAspectJAdvisorFactory的getAdvisor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Advisor getAdvisor(Method candidateAdviceMethod, MetadataAwareAspectInstanceFactory aif,</span><br><span class="line">        int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">    validate(aif.getAspectMetadata().getAspectClass());</span><br><span class="line">    //获取切点</span><br><span class="line">    AspectJExpressionPointcut ajexp =</span><br><span class="line">            getPointcut(candidateAdviceMethod, aif.getAspectMetadata().getAspectClass());</span><br><span class="line">    if (ajexp == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建通知器</span><br><span class="line">    return new InstantiationModelAwarePointcutAdvisorImpl(</span><br><span class="line">            this, ajexp, aif, candidateAdviceMethod, declarationOrderInAspect, aspectName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ReflectiveAspectJAdvisorFactory的getPointcut方法"><a href="#11、ReflectiveAspectJAdvisorFactory的getPointcut方法" class="headerlink" title="11、ReflectiveAspectJAdvisorFactory的getPointcut方法"></a>11、ReflectiveAspectJAdvisorFactory的getPointcut方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private AspectJExpressionPointcut getPointcut(Method candidateAdviceMethod, Class&lt;?&gt; candidateAspectClass) &#123;</span><br><span class="line">    //获取方法上的注解</span><br><span class="line">    AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br><span class="line">            AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br><span class="line">    if (aspectJAnnotation == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //切点类</span><br><span class="line">    AspectJExpressionPointcut ajexp =</span><br><span class="line">            new AspectJExpressionPointcut(candidateAspectClass, new String[0], new Class&lt;?&gt;[0]);</span><br><span class="line">    //设置节点表达式，例如@Before(&quot;pointCut()&quot;)的&quot;pointCut()&quot;</span><br><span class="line">    ajexp.setExpression(aspectJAnnotation.getPointcutExpression());</span><br><span class="line">    return ajexp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接-三、10-实例化InstantiationModelAwarePointcutAdvisorImpl"><a href="#12、接-三、10-实例化InstantiationModelAwarePointcutAdvisorImpl" class="headerlink" title="12、接(三、10)实例化InstantiationModelAwarePointcutAdvisorImpl"></a>12、接(三、10)实例化InstantiationModelAwarePointcutAdvisorImpl</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public InstantiationModelAwarePointcutAdvisorImpl(AspectJAdvisorFactory af, AspectJExpressionPointcut ajexp,</span><br><span class="line">        MetadataAwareAspectInstanceFactory aif, Method method, int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">    this.declaredPointcut = ajexp;</span><br><span class="line">    this.method = method;</span><br><span class="line">    this.atAspectJAdvisorFactory = af;</span><br><span class="line">    this.aspectInstanceFactory = aif;</span><br><span class="line">    this.declarationOrder = declarationOrderInAspect;</span><br><span class="line">    this.aspectName = aspectName;</span><br><span class="line"></span><br><span class="line">    if (aif.getAspectMetadata().isLazilyInstantiated()) &#123;</span><br><span class="line">        // Static part of the pointcut is a lazy type.</span><br><span class="line">        Pointcut preInstantiationPointcut =</span><br><span class="line">                Pointcuts.union(aif.getAspectMetadata().getPerClausePointcut(), this.declaredPointcut);</span><br><span class="line"></span><br><span class="line">        // Make it dynamic: must mutate from pre-instantiation to post-instantiation state.</span><br><span class="line">        // If it&apos;s not a dynamic pointcut, it may be optimized out</span><br><span class="line">        // by the Spring AOP infrastructure after the first evaluation.</span><br><span class="line">        this.pointcut = new PerTargetInstantiationModelPointcut(this.declaredPointcut, preInstantiationPointcut, aif);</span><br><span class="line">        this.lazy = true;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // A singleton aspect.</span><br><span class="line">        //创建增强器</span><br><span class="line">        this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut);</span><br><span class="line">        this.pointcut = declaredPointcut;</span><br><span class="line">        this.lazy = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法"><a href="#13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法" class="headerlink" title="13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法"></a>13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private Advice instantiateAdvice(AspectJExpressionPointcut pcut) &#123;</span><br><span class="line">    return this.atAspectJAdvisorFactory.getAdvice(</span><br><span class="line">            this.method, pcut, this.aspectInstanceFactory, this.declarationOrder, this.aspectName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、ReflectiveAspectJAdvisorFactory的getAdvice方法"><a href="#14、ReflectiveAspectJAdvisorFactory的getAdvice方法" class="headerlink" title="14、ReflectiveAspectJAdvisorFactory的getAdvice方法"></a>14、ReflectiveAspectJAdvisorFactory的getAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Advice getAdvice(Method candidateAdviceMethod, AspectJExpressionPointcut ajexp,</span><br><span class="line">        MetadataAwareAspectInstanceFactory aif, int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; candidateAspectClass = aif.getAspectMetadata().getAspectClass();</span><br><span class="line">    validate(candidateAspectClass);</span><br><span class="line">    //获取方法注解</span><br><span class="line">    AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br><span class="line">            AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br><span class="line">    if (aspectJAnnotation == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If we get here, we know we have an AspectJ method.</span><br><span class="line">    // Check that it&apos;s an AspectJ-annotated class</span><br><span class="line">    if (!isAspect(candidateAspectClass)) &#123;</span><br><span class="line">        throw new AopConfigException(&quot;Advice must be declared inside an aspect type: &quot; +</span><br><span class="line">                &quot;Offending method &apos;&quot; + candidateAdviceMethod + &quot;&apos; in class [&quot; +</span><br><span class="line">                candidateAspectClass.getName() + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Found AspectJ method: &quot; + candidateAdviceMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AbstractAspectJAdvice springAdvice;</span><br><span class="line">    //不同的注解类型，创建不同的增强器</span><br><span class="line">    switch (aspectJAnnotation.getAnnotationType()) &#123;</span><br><span class="line">        case AtBefore:</span><br><span class="line">            springAdvice = new AspectJMethodBeforeAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            break;</span><br><span class="line">        case AtAfter:</span><br><span class="line">            springAdvice = new AspectJAfterAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            break;</span><br><span class="line">        case AtAfterReturning:</span><br><span class="line">            springAdvice = new AspectJAfterReturningAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            AfterReturning afterReturningAnnotation = (AfterReturning) aspectJAnnotation.getAnnotation();</span><br><span class="line">            if (StringUtils.hasText(afterReturningAnnotation.returning())) &#123;</span><br><span class="line">                springAdvice.setReturningName(afterReturningAnnotation.returning());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case AtAfterThrowing:</span><br><span class="line">            springAdvice = new AspectJAfterThrowingAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            AfterThrowing afterThrowingAnnotation = (AfterThrowing) aspectJAnnotation.getAnnotation();</span><br><span class="line">            if (StringUtils.hasText(afterThrowingAnnotation.throwing())) &#123;</span><br><span class="line">                springAdvice.setThrowingName(afterThrowingAnnotation.throwing());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case AtAround:</span><br><span class="line">            springAdvice = new AspectJAroundAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            break;</span><br><span class="line">        case AtPointcut:</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Processing pointcut &apos;&quot; + candidateAdviceMethod.getName() + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        default:</span><br><span class="line">            throw new UnsupportedOperationException(</span><br><span class="line">                    &quot;Unsupported advice type on method &quot; + candidateAdviceMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Now to configure the advice...</span><br><span class="line">    springAdvice.setAspectName(aspectName);</span><br><span class="line">    springAdvice.setDeclarationOrder(declarationOrderInAspect);</span><br><span class="line">    String[] argNames = this.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);</span><br><span class="line">    if (argNames != null) &#123;</span><br><span class="line">        springAdvice.setArgumentNamesFromStringArray(argNames);</span><br><span class="line">    &#125;</span><br><span class="line">    springAdvice.calculateArgumentBindings();</span><br><span class="line">    return springAdvice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、AOP静态代理"><a href="#四、AOP静态代理" class="headerlink" title="四、AOP静态代理"></a>四、AOP静态代理</h3><h4 id="demo-2"><a href="#demo-2" class="headerlink" title="demo"></a>demo</h4><p>被代理的类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class DemoBean &#123;</span><br><span class="line">    public void run1() &#123;</span><br><span class="line">        System.out.println(&quot;run1...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public void run2() throws Exception &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(2);</span><br><span class="line">        System.out.println(&quot;run2...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>切面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">public class ProfileAspect &#123;</span><br><span class="line">    @Around(&quot;profileMethod()&quot;)</span><br><span class="line">    public Object profile(ProceedingJoinPoint pjp) throws Throwable &#123;</span><br><span class="line">        StopWatch sw = new StopWatch(getClass().getName());</span><br><span class="line">        try &#123;</span><br><span class="line">            sw.start(pjp.getSignature().getName());</span><br><span class="line">            return pjp.proceed();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            sw.stop();</span><br><span class="line">            System.err.println(sw.prettyPrint());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Pointcut(&quot;execution(public * org.codetree.core.spring.loadtimeweaver.*.*(..))&quot;)</span><br><span class="line">    public void profileMethod() &#123;</span><br><span class="line">        System.out.println(&quot;profileMethod..&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>META-INF/aop.xml的aop.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE aspectj PUBLIC &quot;-//AspectJ//DTD//EN&quot; &quot;http://www.eclipse.org/aspectj/dtd/aspectj.dtd&quot;&gt;</span><br><span class="line">&lt;aspectj&gt;</span><br><span class="line">    &lt;weaver&gt;</span><br><span class="line">        &lt;!-- only weave classes in your application-specific packages --&gt;</span><br><span class="line">        &lt;!--被代理的目标包--&gt;</span><br><span class="line">        &lt;include within=&quot;org.codetree.core.spring.loadtimeweaver.*&quot; /&gt;</span><br><span class="line">    &lt;/weaver&gt;</span><br><span class="line">    &lt;aspects&gt;</span><br><span class="line">        &lt;!-- weave in just these aspects --&gt;</span><br><span class="line">        &lt;aspect name=&quot;org.codetree.core.spring.loadtimeweaver.ProfileAspect&quot; /&gt;</span><br><span class="line">    &lt;/aspects&gt;</span><br><span class="line">&lt;/aspectj&gt;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class ExtInstrumentationLoadTimeWeaver extends InstrumentationLoadTimeWeaver(默认的weaver) &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void addTransformer(ClassFileTransformer transformer) &#123;  </span><br><span class="line">       try &#123;  </span><br><span class="line">           super.addTransformer(transformer);  </span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AOP配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; </span><br><span class="line"></span><br><span class="line">        xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans </span><br><span class="line">    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">    http://www.springframework.org/schema/context</span><br><span class="line">    http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:load-time-weaver weaver-class=&quot;com.multidemo.spring.ExtInstrumentationLoadTimeWeaver&quot; aspectj-weaving=&quot;autodetect&quot; /&gt;  </span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.multidemo&quot;&gt;&lt;/context:component-scan&gt;  </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><h4 id="1、ContextNamespaceHandler的init方法"><a href="#1、ContextNamespaceHandler的init方法" class="headerlink" title="1、ContextNamespaceHandler的init方法"></a>1、ContextNamespaceHandler的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    registerBeanDefinitionParser(&quot;property-placeholder&quot;, new PropertyPlaceholderBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;property-override&quot;, new PropertyOverrideBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;annotation-config&quot;, new AnnotationConfigBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;component-scan&quot;, new ComponentScanBeanDefinitionParser());</span><br><span class="line">    //注册该标签的解析器</span><br><span class="line">    registerBeanDefinitionParser(&quot;load-time-weaver&quot;, new LoadTimeWeaverBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;mbean-export&quot;, new MBeanExportBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;mbean-server&quot;, new MBeanServerBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AbstractBeanDefinitionParser的parse方法"><a href="#2、AbstractBeanDefinitionParser的parse方法" class="headerlink" title="2、AbstractBeanDefinitionParser的parse方法"></a>2、AbstractBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //解析配置文件</span><br><span class="line">    AbstractBeanDefinition definition = parseInternal(element, parserContext);</span><br><span class="line">    if (definition != null &amp;&amp; !parserContext.isNested()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //子类实现，返回&quot;loadTimeWeaver&quot;</span><br><span class="line">            String id = resolveId(element, definition, parserContext);</span><br><span class="line">            if (!StringUtils.hasText(id)) &#123;</span><br><span class="line">                parserContext.getReaderContext().error(</span><br><span class="line">                        &quot;Id is required for element &apos;&quot; + parserContext.getDelegate().getLocalName(element)</span><br><span class="line">                                + &quot;&apos; when used as a top-level tag&quot;, element);</span><br><span class="line">            &#125;</span><br><span class="line">            String[] aliases = null;</span><br><span class="line">            if (shouldParseNameAsAliases()) &#123;</span><br><span class="line">                String name = element.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">                if (StringUtils.hasLength(name)) &#123;</span><br><span class="line">                    aliases = StringUtils.trimArrayElements(StringUtils.commaDelimitedListToStringArray(name));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            BeanDefinitionHolder holder = new BeanDefinitionHolder(definition, id, aliases);</span><br><span class="line">            //注册该bean</span><br><span class="line">            registerBeanDefinition(holder, parserContext.getRegistry());</span><br><span class="line">            //注册并广播该组件</span><br><span class="line">            if (shouldFireEvents()) &#123;</span><br><span class="line">                BeanComponentDefinition componentDefinition = new BeanComponentDefinition(holder);</span><br><span class="line">                postProcessComponentDefinition(componentDefinition);</span><br><span class="line">                parserContext.registerComponent(componentDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            parserContext.getReaderContext().error(ex.getMessage(), element);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AbstractSingleBeanDefinitionParser的parseInternal方法"><a href="#3、AbstractSingleBeanDefinitionParser的parseInternal方法" class="headerlink" title="3、AbstractSingleBeanDefinitionParser的parseInternal方法"></a>3、AbstractSingleBeanDefinitionParser的parseInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final AbstractBeanDefinition parseInternal(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line">    String parentName = getParentName(element);</span><br><span class="line">    if (parentName != null) &#123;</span><br><span class="line">        builder.getRawBeanDefinition().setParentName(parentName);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取weaver-class属性，子类实现，默认返回&quot;org.springframework.context.weaving.DefaultContextLoadTimeWeaver&quot;</span><br><span class="line">    //本例返回&quot;com.multidemo.spring.ExtInstrumentationLoadTimeWeaver&quot;</span><br><span class="line">    Class&lt;?&gt; beanClass = getBeanClass(element);</span><br><span class="line">    if (beanClass != null) &#123;</span><br><span class="line">        builder.getRawBeanDefinition().setBeanClass(beanClass);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        String beanClassName = getBeanClassName(element);</span><br><span class="line">        if (beanClassName != null) &#123;</span><br><span class="line">            builder.getRawBeanDefinition().setBeanClassName(beanClassName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</span><br><span class="line">    if (parserContext.isNested()) &#123;</span><br><span class="line">        // Inner bean definition must receive same scope as containing bean.</span><br><span class="line">        builder.setScope(parserContext.getContainingBeanDefinition().getScope());</span><br><span class="line">    &#125;</span><br><span class="line">    if (parserContext.isDefaultLazyInit()) &#123;</span><br><span class="line">        // Default-lazy-init applies to custom bean definitions as well.</span><br><span class="line">        builder.setLazyInit(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析配置文件</span><br><span class="line">    doParse(element, parserContext, builder);</span><br><span class="line">    //创建BeanDefinition</span><br><span class="line">    return builder.getBeanDefinition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、LoadTimeWeaverBeanDefinitionParser的doParse方法"><a href="#4、LoadTimeWeaverBeanDefinitionParser的doParse方法" class="headerlink" title="4、LoadTimeWeaverBeanDefinitionParser的doParse方法"></a>4、LoadTimeWeaverBeanDefinitionParser的doParse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void doParse(Element element, ParserContext parserContext, BeanDefinitionBuilder builder) &#123;</span><br><span class="line">    builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //是否开启AspectJ</span><br><span class="line">    if (isAspectJWeavingEnabled(element.getAttribute(ASPECTJ_WEAVING_ATTRIBUTE), parserContext)) &#123;</span><br><span class="line">        RootBeanDefinition weavingEnablerDef = new RootBeanDefinition();</span><br><span class="line">        //&quot;org.springframework.context.weaving.AspectJWeavingEnabler&quot;</span><br><span class="line">        weavingEnablerDef.setBeanClassName(ASPECTJ_WEAVING_ENABLER_CLASS_NAME);</span><br><span class="line">        //注册该bean</span><br><span class="line">        parserContext.getReaderContext().registerWithGeneratedName(weavingEnablerDef);</span><br><span class="line">        //注册BeanDefinition</span><br><span class="line">        //类org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect</span><br><span class="line">        //bean的名字org.springframework.context.config.internalBeanConfigurerAspect</span><br><span class="line">        if (isBeanConfigurerAspectEnabled(parserContext.getReaderContext().getBeanClassLoader())) &#123;</span><br><span class="line">            new SpringConfiguredBeanDefinitionParser().parse(element, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法"><a href="#5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法" class="headerlink" title="5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法"></a>5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected boolean isAspectJWeavingEnabled(String value, ParserContext parserContext) &#123;</span><br><span class="line">    if (&quot;on&quot;.equals(value)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (&quot;off&quot;.equals(value)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Determine default...</span><br><span class="line">        //检查是否存在&quot;META-INF/aop.xml&quot;</span><br><span class="line">        ClassLoader cl = parserContext.getReaderContext().getResourceLoader().getClassLoader();</span><br><span class="line">        return (cl.getResource(AspectJWeavingEnabler.ASPECTJ_AOP_XML_RESOURCE) != null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法"><a href="#5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法" class="headerlink" title="5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法"></a>5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法</h4><p>prepareBeanFactory时，会添加LoadTimeWeaverAwareProcessor以及一个临时的TempClassLoader，<br>用于类型比较或者校验的时候加载，bean实例化之前被清掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    //AspectJWeavingEnabler类实现了LoadTimeWeaverAware接口</span><br><span class="line">    if (bean instanceof LoadTimeWeaverAware) &#123;</span><br><span class="line">        LoadTimeWeaver ltw = this.loadTimeWeaver;//DefaultContextLoadTimeWeaver</span><br><span class="line">        if (ltw == null) &#123;</span><br><span class="line">            Assert.state(this.beanFactory != null,</span><br><span class="line">                    &quot;BeanFactory required if no LoadTimeWeaver explicitly specified&quot;);</span><br><span class="line">            ltw = this.beanFactory.getBean(</span><br><span class="line">                    ConfigurableApplicationContext.LOAD_TIME_WEAVER_BEAN_NAME, LoadTimeWeaver.class);</span><br><span class="line">        &#125;</span><br><span class="line">        ((LoadTimeWeaverAware) bean).setLoadTimeWeaver(ltw);</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法"><a href="#6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法" class="headerlink" title="6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法"></a>6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法</h4><p>DefaultContextLoadTimeWeaver实现了BeanClassLoaderAware接口，在初始化的时候会执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setBeanClassLoader(ClassLoader classLoader) &#123;</span><br><span class="line">    LoadTimeWeaver serverSpecificLoadTimeWeaver = createServerSpecificLoadTimeWeaver(classLoader);</span><br><span class="line">    if (serverSpecificLoadTimeWeaver != null) &#123;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(&quot;Determined server-specific load-time weaver: &quot; +</span><br><span class="line">                    serverSpecificLoadTimeWeaver.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        this.loadTimeWeaver = serverSpecificLoadTimeWeaver;</span><br><span class="line">    &#125;</span><br><span class="line">    //检查当前虚拟机中的Instrumentation实例是否可用</span><br><span class="line">    else if (InstrumentationLoadTimeWeaver.isInstrumentationAvailable()) &#123;</span><br><span class="line">        logger.info(&quot;Found Spring&apos;s JVM agent for instrumentation&quot;);</span><br><span class="line">        this.loadTimeWeaver = new InstrumentationLoadTimeWeaver(classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.loadTimeWeaver = new ReflectiveLoadTimeWeaver(classLoader);</span><br><span class="line">            logger.info(&quot;Using a reflective load-time weaver for class loader: &quot; +</span><br><span class="line">                    this.loadTimeWeaver.getInstrumentableClassLoader().getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IllegalStateException ex) &#123;</span><br><span class="line">            throw new IllegalStateException(ex.getMessage() + &quot; Specify a custom LoadTimeWeaver or start your &quot; +</span><br><span class="line">                    &quot;Java virtual machine with Spring&apos;s agent: -javaagent:org.springframework.instrument.jar&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>7、AspectJWeavingEnabler的postProcessBeanFactory方法<br>AspectJWeavingEnabler实现了BeanFactoryPostProcessor接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">    enableAspectJWeaving(this.loadTimeWeaver, this.beanClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>8、AspectJWeavingEnabler的enableAspectJWeaving方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static void enableAspectJWeaving(LoadTimeWeaver weaverToUse, ClassLoader beanClassLoader) &#123;</span><br><span class="line">    //此时已经被初始化为DefaultContextLoadTimeWeaver</span><br><span class="line">    if (weaverToUse == null) &#123;</span><br><span class="line">        if (InstrumentationLoadTimeWeaver.isInstrumentationAvailable()) &#123;</span><br><span class="line">            weaverToUse = new InstrumentationLoadTimeWeaver(beanClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;No LoadTimeWeaver available&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //使用DefaultContextLoadTimeWeaver类型的bean中的loadTimeWeaver属性注册转换器</span><br><span class="line">    weaverToUse.addTransformer(new AspectJClassBypassingClassFileTransformer(</span><br><span class="line">                new ClassPreProcessorAgentAdapter()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>9、InstrumentationLoadTimeWeaver的addTransformer方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void addTransformer(ClassFileTransformer transformer) &#123;</span><br><span class="line">    Assert.notNull(transformer, &quot;Transformer must not be null&quot;);</span><br><span class="line">    FilteringClassFileTransformer actualTransformer =</span><br><span class="line">            new FilteringClassFileTransformer(transformer, this.classLoader);</span><br><span class="line">    synchronized (this.transformers) &#123;</span><br><span class="line">        if (this.instrumentation == null) &#123;</span><br><span class="line">            throw new IllegalStateException(</span><br><span class="line">                    &quot;Must start with Java agent to use InstrumentationLoadTimeWeaver. See Spring documentation.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //加入到jdk的instrumentation中加载class时自动调用</span><br><span class="line">        this.instrumentation.addTransformer(actualTransformer);</span><br><span class="line">        this.transformers.add(actualTransformer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>10、FilteringClassFileTransformer的transform方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line"></span><br><span class="line">    if (!this.targetClassLoader.equals(loader)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    return this.targetTransformer.transform(</span><br><span class="line">            loader, className, classBeingRedefined, protectionDomain, classfileBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>11、AspectJClassBypassingClassFileTransformer的transform方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line">    //不处理这两个包下面的</span><br><span class="line">    if (className.startsWith(&quot;org.aspectj&quot;) || className.startsWith(&quot;org/aspectj&quot;)) &#123;</span><br><span class="line">        return classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line">    //委托给AspectJ代理继续处理</span><br><span class="line">    return this.delegate.transform(loader, className, classBeingRedefined, protectionDomain, classfileBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、AOP动态代理配置文件加载&quot;&gt;&lt;a href=&quot;#一、AOP动态代理配置文件加载&quot; class=&quot;headerlink&quot; title=&quot;一、AOP动态代理配置文件加载&quot;&gt;&lt;/a&gt;一、AOP动态代理配置文件加载&lt;/h3&gt;&lt;h4 id=&quot;demo&quot;&gt;&lt;a href
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>springboot源码默认注解</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/springboot%E6%BA%90%E7%A0%81%E9%BB%98%E8%AE%A4%E6%B3%A8%E8%A7%A3/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/springboot源码默认注解/</id>
    <published>2018-06-27T13:10:29.014Z</published>
    <updated>2018-06-28T14:06:06.628Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@SpringBootConfiguration</span><br><span class="line">@EnableAutoConfiguration</span><br><span class="line">@ComponentScan(excludeFilters = &#123;</span><br><span class="line">        @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line">public @interface SpringBootApplication &#123;</span><br><span class="line">    。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一、-SpringBootConfiguration注解"><a href="#一、-SpringBootConfiguration注解" class="headerlink" title="一、@SpringBootConfiguration注解"></a>一、@SpringBootConfiguration注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//ElementType.TYPE表示SpringBootConfiguration注解作用于接口、类、枚举类</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">//RetentionPolicy.RUNTIME表示SpringBootConfiguration注解信息保留至运行时</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">//表示@SpringBootConfiguration注解会被javadoc工具提取成文档</span><br><span class="line">@Documented</span><br><span class="line">//被本注解或组合注解，注解的类是springboot的配置类</span><br><span class="line">@Configuration</span><br><span class="line">public @interface SpringBootConfiguration &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1、-Target注解"><a href="#1、-Target注解" class="headerlink" title="1、@Target注解"></a>1、@Target注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">//ElementType.ANNOTATION_TYPE表示Target只能作用于注解类</span><br><span class="line">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="line">public @interface Target &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Returns an array of the kinds of elements an annotation type</span><br><span class="line">     * can be applied to.</span><br><span class="line">     * @return an array of the kinds of elements an annotation type</span><br><span class="line">     * can be applied to</span><br><span class="line">     */</span><br><span class="line">    ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、-Retention注解"><a href="#2、-Retention注解" class="headerlink" title="2、@Retention注解"></a>2、@Retention注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="line">public @interface Retention &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Returns the retention policy.</span><br><span class="line">     * @return the retention policy</span><br><span class="line">     */</span><br><span class="line">    RetentionPolicy value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、-Configuration注解"><a href="#3、-Configuration注解" class="headerlink" title="3、@Configuration注解"></a>3、@Configuration注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//被本注解或组合注解，注解的类能被过滤器获取</span><br><span class="line">@Component</span><br><span class="line">public @interface Configuration &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Explicitly specify the name of the Spring bean definition associated</span><br><span class="line">     * with this Configuration class. If left unspecified (the common case),</span><br><span class="line">     * a bean name will be automatically generated.</span><br><span class="line">     * &lt;p&gt;The custom name applies only if the Configuration class is picked up via</span><br><span class="line">     * component scanning or supplied directly to a &#123;@link AnnotationConfigApplicationContext&#125;.</span><br><span class="line">     * If the Configuration class is registered as a traditional XML bean definition,</span><br><span class="line">     * the name/id of the bean element will take precedence.</span><br><span class="line">     * @return the suggested component name, if any (or empty String otherwise)</span><br><span class="line">     * @see org.springframework.beans.factory.support.DefaultBeanNameGenerator</span><br><span class="line">     */</span><br><span class="line">    @AliasFor(annotation = Component.class)</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、-EnableAutoConfiguration注解"><a href="#二、-EnableAutoConfiguration注解" class="headerlink" title="二、@EnableAutoConfiguration注解"></a>二、@EnableAutoConfiguration注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//EnableAutoConfiguration作用于一个class，则被用于该class的子类</span><br><span class="line">@Inherited</span><br><span class="line">//</span><br><span class="line">@AutoConfigurationPackage</span><br><span class="line">//</span><br><span class="line">@Import(AutoConfigurationImportSelector.class)</span><br><span class="line">public @interface EnableAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Exclude specific auto-configuration classes such that they will never be applied.</span><br><span class="line">     * @return the classes to exclude</span><br><span class="line">     */</span><br><span class="line">    Class&lt;?&gt;[] exclude() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Exclude specific auto-configuration class names such that they will never be</span><br><span class="line">     * applied.</span><br><span class="line">     * @return the class names to exclude</span><br><span class="line">     * @since 1.3.0</span><br><span class="line">     */</span><br><span class="line">    String[] excludeName() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1、-AutoConfigurationPackage注解"><a href="#1、-AutoConfigurationPackage注解" class="headerlink" title="1、@AutoConfigurationPackage注解"></a>1、@AutoConfigurationPackage注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@Import(AutoConfigurationPackages.Registrar.class)</span><br><span class="line">public @interface AutoConfigurationPackage &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法"><a href="#2、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法" class="headerlink" title="2、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法"></a>2、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata metadata,</span><br><span class="line">        BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    //注册配置类的包名</span><br><span class="line">    register(registry, new PackageImport(metadata).getPackageName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法"><a href="#3、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法" class="headerlink" title="3、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法"></a>3、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static void register(BeanDefinitionRegistry registry, String... packageNames) &#123;</span><br><span class="line">    if (registry.containsBeanDefinition(BEAN)) &#123;</span><br><span class="line">        BeanDefinition beanDefinition = registry.getBeanDefinition(BEAN);</span><br><span class="line">        ConstructorArgumentValues constructorArguments = beanDefinition</span><br><span class="line">                .getConstructorArgumentValues();</span><br><span class="line">        constructorArguments.addIndexedArgumentValue(0,</span><br><span class="line">                addBasePackages(constructorArguments, packageNames));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        GenericBeanDefinition beanDefinition = new GenericBeanDefinition();</span><br><span class="line">        beanDefinition.setBeanClass(BasePackages.class);</span><br><span class="line">        beanDefinition.getConstructorArgumentValues().addIndexedArgumentValue(0,</span><br><span class="line">                packageNames);</span><br><span class="line">        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        //配置类的包，注册为基础包</span><br><span class="line">        registry.registerBeanDefinition(BEAN, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AutoConfigurationImportSelector的selectImports方法"><a href="#4、AutoConfigurationImportSelector的selectImports方法" class="headerlink" title="4、AutoConfigurationImportSelector的selectImports方法"></a>4、AutoConfigurationImportSelector的selectImports方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">    if (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        return NO_IMPORTS;</span><br><span class="line">    &#125;</span><br><span class="line">    //从配置文件&quot;META-INF/spring-autoconfigure-metadata.properties&quot;中加载配置</span><br><span class="line">    AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">            .loadMetadata(this.beanClassLoader);</span><br><span class="line">    //获取注解的EnableAutoConfiguration注解值信息</span><br><span class="line">    AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">    //从&quot;META-INF\spring.factories&quot;中获取自动配类</span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,</span><br><span class="line">            attributes);</span><br><span class="line">    //去重</span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    //获取EnableAutoConfiguration中的或配置中要去除的自动配置类</span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    //检查是否有无效的排除类</span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    //删除排除的配置类</span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    //应用过滤器</span><br><span class="line">    configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">    //广播事件 AutoConfigurationImportEvent</span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    return StringUtils.toStringArray(configurations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>META-INF\spring.factories<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cloud.CloudAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.elasticsearch.jest.JestAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.reactor.core.ReactorCoreAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration</span><br></pre></td></tr></table></figure></p><h4 id="5、AutoConfigurationImportSelector的filter方法"><a href="#5、AutoConfigurationImportSelector的filter方法" class="headerlink" title="5、AutoConfigurationImportSelector的filter方法"></a>5、AutoConfigurationImportSelector的filter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;String&gt; filter(List&lt;String&gt; configurations,</span><br><span class="line">        AutoConfigurationMetadata autoConfigurationMetadata) &#123;</span><br><span class="line">    long startTime = System.nanoTime();</span><br><span class="line">    String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">    boolean[] skip = new boolean[candidates.length];</span><br><span class="line">    boolean skipped = false;</span><br><span class="line">    //从配置&quot;META-INF\spring.factories&quot;中获取过滤器OnClassCondition</span><br><span class="line">    for (AutoConfigurationImportFilter filter : getAutoConfigurationImportFilters()) &#123;</span><br><span class="line">        //设置相应的资源</span><br><span class="line">        invokeAwareMethods(filter);</span><br><span class="line">        //是否匹配</span><br><span class="line">        boolean[] match = filter.match(candidates, autoConfigurationMetadata);</span><br><span class="line">        //不匹配须过滤</span><br><span class="line">        for (int i = 0; i &lt; match.length; i++) &#123;</span><br><span class="line">            if (!match[i]) &#123;</span><br><span class="line">                skip[i] = true;</span><br><span class="line">                skipped = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //全部匹配</span><br><span class="line">    if (!skipped) &#123;</span><br><span class="line">        return configurations;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; result = new ArrayList&lt;&gt;(candidates.length);</span><br><span class="line">    for (int i = 0; i &lt; candidates.length; i++) &#123;</span><br><span class="line">        //判断是否跳过</span><br><span class="line">        if (!skip[i]) &#123;</span><br><span class="line">            result.add(candidates[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        int numberFiltered = configurations.size() - result.size();</span><br><span class="line">        logger.trace(&quot;Filtered &quot; + numberFiltered + &quot; auto configuration class in &quot;</span><br><span class="line">                + TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime)</span><br><span class="line">                + &quot; ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return new ArrayList&lt;&gt;(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>META-INF\spring.factories<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configuration Import Filters</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnClassCondition</span><br></pre></td></tr></table></figure></p><h4 id="6、OnClassCondition的match方法"><a href="#6、OnClassCondition的match方法" class="headerlink" title="6、OnClassCondition的match方法"></a>6、OnClassCondition的match方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean[] match(String[] autoConfigurationClasses,</span><br><span class="line">        AutoConfigurationMetadata autoConfigurationMetadata) &#123;</span><br><span class="line">    ConditionEvaluationReport report = getConditionEvaluationReport();</span><br><span class="line">    //查看配置&quot;META-INF/spring-autoconfigure-metadata.properties&quot;中，配置的ConditionalOnClass，在依赖中是否存在</span><br><span class="line">    ConditionOutcome[] outcomes = getOutcomes(autoConfigurationClasses,</span><br><span class="line">            autoConfigurationMetadata);</span><br><span class="line">    boolean[] match = new boolean[outcomes.length];</span><br><span class="line">    for (int i = 0; i &lt; outcomes.length; i++) &#123;</span><br><span class="line">        //匹配结果</span><br><span class="line">        match[i] = (outcomes[i] == null || outcomes[i].isMatch());</span><br><span class="line">        if (!match[i] &amp;&amp; outcomes[i] != null) &#123;</span><br><span class="line">            logOutcome(autoConfigurationClasses[i], outcomes[i]);</span><br><span class="line">            if (report != null) &#123;</span><br><span class="line">                report.recordConditionEvaluation(autoConfigurationClasses[i], this,</span><br><span class="line">                        outcomes[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return match;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、-ComponentScan注解"><a href="#三、-ComponentScan注解" class="headerlink" title="三、@ComponentScan注解"></a>三、@ComponentScan注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Documented</span><br><span class="line">//ComponentScan注解可重复注解</span><br><span class="line">@Repeatable(ComponentScans.class)</span><br><span class="line">public @interface ComponentScan &#123;</span><br><span class="line">    。。。</span><br><span class="line">    /**</span><br><span class="line">     * Specifies which types are eligible for component scanning.</span><br><span class="line">     * &lt;p&gt;Further narrows the set of candidate components from everything in &#123;@link #basePackages&#125;</span><br><span class="line">     * to everything in the base packages that matches the given filter or filters.</span><br><span class="line">     * &lt;p&gt;Note that these filters will be applied in addition to the default filters, if specified.</span><br><span class="line">     * Any type under the specified base packages which matches a given filter will be included,</span><br><span class="line">     * even if it does not match the default filters (i.e. is not annotated with &#123;@code @Component&#125;).</span><br><span class="line">     * @see #resourcePattern()</span><br><span class="line">     * @see #useDefaultFilters()</span><br><span class="line">     */</span><br><span class="line">    //过滤器</span><br><span class="line">    Filter[] includeFilters() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies which types are not eligible for component scanning.</span><br><span class="line">     * @see #resourcePattern</span><br><span class="line">     */</span><br><span class="line">    //过滤器</span><br><span class="line">    Filter[] excludeFilters() default &#123;&#125;;</span><br><span class="line">    。。。</span><br><span class="line">｝</span><br></pre></td></tr></table></figure><h4 id="1、TypeExcludeFilter的match方法"><a href="#1、TypeExcludeFilter的match方法" class="headerlink" title="1、TypeExcludeFilter的match方法"></a>1、TypeExcludeFilter的match方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean match(MetadataReader metadataReader,</span><br><span class="line">        MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">    if (this.beanFactory instanceof ListableBeanFactory</span><br><span class="line">            &amp;&amp; getClass() == TypeExcludeFilter.class) &#123;</span><br><span class="line">        //获取容器中的TypeExcludeFilter</span><br><span class="line">        Collection&lt;TypeExcludeFilter&gt; delegates = ((ListableBeanFactory) this.beanFactory)</span><br><span class="line">                .getBeansOfType(TypeExcludeFilter.class).values();</span><br><span class="line">        //有一个能能匹配则反回true</span><br><span class="line">        for (TypeExcludeFilter delegate : delegates) &#123;</span><br><span class="line">            if (delegate.match(metadataReader, metadataReaderFactory)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AutoConfigurationExcludeFilter的match方法"><a href="#2、AutoConfigurationExcludeFilter的match方法" class="headerlink" title="2、AutoConfigurationExcludeFilter的match方法"></a>2、AutoConfigurationExcludeFilter的match方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean match(MetadataReader metadataReader,</span><br><span class="line">        MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">    //是配置类,并且是自动配置类，返回ture，即不扫描自动配置类</span><br><span class="line">    return isConfiguration(metadataReader) &amp;&amp; isAutoConfiguration(metadataReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、AopAutoConfiguration自动配置类"><a href="#四、AopAutoConfiguration自动配置类" class="headerlink" title="四、AopAutoConfiguration自动配置类"></a>四、AopAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">//条件注解，EnableAspectJAutoProxy、Aspect、Advice类存在，才能解析此配置类</span><br><span class="line">@ConditionalOnClass(&#123; EnableAspectJAutoProxy.class, Aspect.class, Advice.class,</span><br><span class="line">     AnnotatedElement.class &#125;)</span><br><span class="line">//配置文件中存在&quot;spring.aop.auto=true&quot;才能解析此配置类</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">public class AopAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //创建AnnotationAwareAspectJAutoProxyCreator，采用Jdk动态代理</span><br><span class="line">    @EnableAspectJAutoProxy(proxyTargetClass = false)</span><br><span class="line">    //配置文件中存在&quot;spring.aop.proxy-target-class=false&quot;才能解析此配置类</span><br><span class="line">    @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;, matchIfMissing = false)</span><br><span class="line">    public static class JdkDynamicAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //创建AnnotationAwareAspectJAutoProxyCreator，采用Cglib动态代理</span><br><span class="line">    @EnableAspectJAutoProxy(proxyTargetClass = true)</span><br><span class="line">    //配置文件中存在&quot;spring.aop.proxy-target-class=true&quot;才能解析此配置类</span><br><span class="line">    @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">    public static class CglibAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1、-ConditionalOnClass注解"><a href="#1、-ConditionalOnClass注解" class="headerlink" title="1、@ConditionalOnClass注解"></a>1、@ConditionalOnClass注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//条件注解</span><br><span class="line">@Conditional(OnClassCondition.class)</span><br><span class="line">public @interface ConditionalOnClass &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The classes that must be present. Since this annotation is parsed by loading class</span><br><span class="line">     * bytecode, it is safe to specify classes here that may ultimately not be on the</span><br><span class="line">     * classpath, only if this annotation is directly on the affected component and</span><br><span class="line">     * &lt;b&gt;not&lt;/b&gt; if this annotation is used as a composed, meta-annotation. In order to</span><br><span class="line">     * use this annotation as a meta-annotation, only use the &#123;@link #name&#125; attribute.</span><br><span class="line">     * @return the classes that must be present</span><br><span class="line">     */</span><br><span class="line">    Class&lt;?&gt;[] value() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The classes names that must be present.</span><br><span class="line">     * @return the class names that must be present.</span><br><span class="line">     */</span><br><span class="line">    String[] name() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、SpringBootCondition的matches方法"><a href="#2、SpringBootCondition的matches方法" class="headerlink" title="2、SpringBootCondition的matches方法"></a>2、SpringBootCondition的matches方法</h4><p>OnClassCondition的父类，返回true则表示满足条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final boolean matches(ConditionContext context,</span><br><span class="line">        AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">    String classOrMethodName = getClassOrMethodName(metadata);</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取条件是否满足</span><br><span class="line">        ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br><span class="line">        logOutcome(classOrMethodName, outcome);</span><br><span class="line">        recordEvaluation(context, classOrMethodName, outcome);</span><br><span class="line">        return outcome.isMatch();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoClassDefFoundError ex) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;Could not evaluate condition on &quot; + classOrMethodName + &quot; due to &quot;</span><br><span class="line">                        + ex.getMessage() + &quot; not &quot;</span><br><span class="line">                        + &quot;found. Make sure your own configuration does not rely on &quot;</span><br><span class="line">                        + &quot;that class. This can also happen if you are &quot;</span><br><span class="line">                        + &quot;@ComponentScanning a springframework package (e.g. if you &quot;</span><br><span class="line">                        + &quot;put a @ComponentScan in the default package by mistake)&quot;,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (RuntimeException ex) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;Error processing condition on &quot; + getName(metadata), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、OnClassCondition的getMatchOutcome方法"><a href="#3、OnClassCondition的getMatchOutcome方法" class="headerlink" title="3、OnClassCondition的getMatchOutcome方法"></a>3、OnClassCondition的getMatchOutcome方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ConditionOutcome getMatchOutcome(ConditionContext context,</span><br><span class="line">        AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">    ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">    ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">    //获取需要存在的类</span><br><span class="line">    List&lt;String&gt; onClasses = getCandidates(metadata, ConditionalOnClass.class);</span><br><span class="line">    if (onClasses != null) &#123;</span><br><span class="line">        //获取需要存在但不存在的类</span><br><span class="line">        List&lt;String&gt; missing = getMatches(onClasses, MatchType.MISSING, classLoader);</span><br><span class="line">        if (!missing.isEmpty()) &#123;</span><br><span class="line">            //条件不满足</span><br><span class="line">            return ConditionOutcome</span><br><span class="line">                    .noMatch(ConditionMessage.forCondition(ConditionalOnClass.class)</span><br><span class="line">                            .didNotFind(&quot;required class&quot;, &quot;required classes&quot;)</span><br><span class="line">                            .items(Style.QUOTE, missing));</span><br><span class="line">        &#125;</span><br><span class="line">        matchMessage = matchMessage.andCondition(ConditionalOnClass.class)</span><br><span class="line">                .found(&quot;required class&quot;, &quot;required classes&quot;).items(Style.QUOTE,</span><br><span class="line">                        getMatches(onClasses, MatchType.PRESENT, classLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    //获取需要不存在的类</span><br><span class="line">    List&lt;String&gt; onMissingClasses = getCandidates(metadata,</span><br><span class="line">            ConditionalOnMissingClass.class);</span><br><span class="line">    if (onMissingClasses != null) &#123;</span><br><span class="line">        List&lt;String&gt; present = getMatches(onMissingClasses, MatchType.PRESENT,</span><br><span class="line">                classLoader);</span><br><span class="line">        if (!present.isEmpty()) &#123;</span><br><span class="line">            return ConditionOutcome.noMatch(</span><br><span class="line">                    ConditionMessage.forCondition(ConditionalOnMissingClass.class)</span><br><span class="line">                            .found(&quot;unwanted class&quot;, &quot;unwanted classes&quot;)</span><br><span class="line">                            .items(Style.QUOTE, present));</span><br><span class="line">        &#125;</span><br><span class="line">        matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class)</span><br><span class="line">                .didNotFind(&quot;unwanted class&quot;, &quot;unwanted classes&quot;).items(Style.QUOTE,</span><br><span class="line">                        getMatches(onMissingClasses, MatchType.MISSING, classLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    //满足条件</span><br><span class="line">    return ConditionOutcome.match(matchMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、-EnableAspectJAutoProxy注解"><a href="#4、-EnableAspectJAutoProxy注解" class="headerlink" title="4、@EnableAspectJAutoProxy注解"></a>4、@EnableAspectJAutoProxy注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(AspectJAutoProxyRegistrar.class)</span><br><span class="line">public @interface EnableAspectJAutoProxy &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed</span><br><span class="line">     * to standard Java interface-based proxies. The default is &#123;@code false&#125;.</span><br><span class="line">     */</span><br><span class="line">    boolean proxyTargetClass() default false;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Indicate that the proxy should be exposed by the AOP framework as a &#123;@code ThreadLocal&#125;</span><br><span class="line">     * for retrieval via the &#123;@link org.springframework.aop.framework.AopContext&#125; class.</span><br><span class="line">     * Off by default, i.e. no guarantees that &#123;@code AopContext&#125; access will work.</span><br><span class="line">     * @since 4.3.1</span><br><span class="line">     */</span><br><span class="line">    boolean exposeProxy() default false;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法"><a href="#5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法" class="headerlink" title="5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法"></a>5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(</span><br><span class="line">        AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    //注册AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">    AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span><br><span class="line">    //获取EnableAspectJAutoProxy注解的值</span><br><span class="line">    AnnotationAttributes enableAspectJAutoProxy =</span><br><span class="line">            AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);</span><br><span class="line">    //设置proxyTargetClass和exposeProxy属性</span><br><span class="line">    if (enableAspectJAutoProxy != null) &#123;</span><br><span class="line">        if (enableAspectJAutoProxy.getBoolean(&quot;proxyTargetClass&quot;)) &#123;</span><br><span class="line">            AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">        &#125;</span><br><span class="line">        if (enableAspectJAutoProxy.getBoolean(&quot;exposeProxy&quot;)) &#123;</span><br><span class="line">            AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="五、DataSourceAutoConfiguration自动配置类"><a href="#五、DataSourceAutoConfiguration自动配置类" class="headerlink" title="五、DataSourceAutoConfiguration自动配置类"></a>五、DataSourceAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">//条件注解，须存在DataSource、EmbeddedDatabaseType类,才解析该配置类</span><br><span class="line">@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</span><br><span class="line">//自动配置数据源属性</span><br><span class="line">@EnableConfigurationProperties(DataSourceProperties.class)</span><br><span class="line">//注入配置类</span><br><span class="line">//DataSourcePoolMetadataProvidersConfiguration创建DataSourcePoolMetadata，如TomcatDataSourcePoolMetadata</span><br><span class="line">//DataSourceInitializationConfiguration注册DataSourceInitializerPostProcessor处理器</span><br><span class="line">@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class,</span><br><span class="line">        DataSourceInitializationConfiguration.class &#125;)</span><br><span class="line">public class DataSourceAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //条件注解，须存在内置数据库连接EmbeddedDatabaseConnection类,才解析该配置类</span><br><span class="line">    @Conditional(EmbeddedDatabaseCondition.class)</span><br><span class="line">    //条件注解，不存在DataSource、XADataSource对象,才解析该配置类</span><br><span class="line">    @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span><br><span class="line">    //注入配置类，该配置类创建内置数据源EmbeddedDatabase</span><br><span class="line">    @Import(EmbeddedDataSourceConfiguration.class)</span><br><span class="line">    protected static class EmbeddedDatabaseConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //条件注解，须存在&quot;com.zaxxer.hikari.HikariDataSource&quot;或</span><br><span class="line">    //&quot;org.apache.tomcat.jdbc.pool.DataSource&quot;或</span><br><span class="line">    //&quot;org.apache.commons.dbcp2.BasicDataSource&quot;类,才解析该配置类</span><br><span class="line">    @Conditional(PooledDataSourceCondition.class)</span><br><span class="line">    //条件注解，不存在DataSource、XADataSource对象,才解析该配置类</span><br><span class="line">    @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span><br><span class="line">    //注入配置类</span><br><span class="line">    //如DataSourceConfiguration.Tomcat.class，创建org.apache.tomcat.jdbc.pool.DataSource数据源</span><br><span class="line">    @Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span><br><span class="line">            DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.Generic.class,</span><br><span class="line">            DataSourceJmxConfiguration.class &#125;)</span><br><span class="line">    protected static class PooledDataSourceConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    。。。</span><br><span class="line">｝</span><br></pre></td></tr></table></figure><h4 id="1、-EnableConfigurationProperties注解"><a href="#1、-EnableConfigurationProperties注解" class="headerlink" title="1、@EnableConfigurationProperties注解"></a>1、@EnableConfigurationProperties注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//注入ConfigurationPropertiesBeanRegistrar、ConfigurationPropertiesBindingPostProcessorRegistrar</span><br><span class="line">//ConfigurationPropertiesBeanRegistrar注册DataSourceProperties的bean</span><br><span class="line">//ConfigurationPropertiesBindingPostProcessorRegistrar注册ConfigurationPropertiesBindingPostProcessor属性绑定处理器</span><br><span class="line">@Import(EnableConfigurationPropertiesImportSelector.class)</span><br><span class="line">public @interface EnableConfigurationProperties &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Convenient way to quickly register &#123;@link ConfigurationProperties&#125; annotated beans</span><br><span class="line">     * with Spring. Standard Spring Beans will also be scanned regardless of this value.</span><br><span class="line">     * @return &#123;@link ConfigurationProperties&#125; annotated beans to register</span><br><span class="line">     */</span><br><span class="line">    Class&lt;?&gt;[] value() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法"><a href="#2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法" class="headerlink" title="2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法"></a>2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessBeforeInitialization(Object bean, String beanName)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line">    //获取bean的ConfigurationProperties注解</span><br><span class="line">    ConfigurationProperties annotation = getAnnotation(bean, beanName,</span><br><span class="line">            ConfigurationProperties.class);</span><br><span class="line">    //存在该注解</span><br><span class="line">    if (annotation != null) &#123;</span><br><span class="line">        //绑定属性</span><br><span class="line">        bind(bean, beanName, annotation);</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ConfigurationPropertiesBindingPostProcessor的bind方法"><a href="#3、ConfigurationPropertiesBindingPostProcessor的bind方法" class="headerlink" title="3、ConfigurationPropertiesBindingPostProcessor的bind方法"></a>3、ConfigurationPropertiesBindingPostProcessor的bind方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private void bind(Object bean, String beanName, ConfigurationProperties annotation) &#123;</span><br><span class="line">    //获取bean的类型</span><br><span class="line">    ResolvableType type = getBeanType(bean, beanName);</span><br><span class="line">    //获取类的@Validated</span><br><span class="line">    Validated validated = getAnnotation(bean, beanName, Validated.class);</span><br><span class="line">    Annotation[] annotations = (validated != null</span><br><span class="line">            ? new Annotation[] &#123; annotation, validated &#125;</span><br><span class="line">            : new Annotation[] &#123; annotation &#125;);</span><br><span class="line">    //绑定属性的对象</span><br><span class="line">    Bindable&lt;?&gt; target = Bindable.of(type).withExistingValue(bean)</span><br><span class="line">            .withAnnotations(annotations);</span><br><span class="line">    try &#123;</span><br><span class="line">        //绑定属性</span><br><span class="line">        this.configurationPropertiesBinder.bind(target);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        throw new ConfigurationPropertiesBindException(beanName, bean, annotation,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DataSourceProperties连接池属性"><a href="#4、DataSourceProperties连接池属性" class="headerlink" title="4、DataSourceProperties连接池属性"></a>4、DataSourceProperties连接池属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//属性前缀</span><br><span class="line">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br><span class="line">public class DataSourceProperties implements BeanClassLoaderAware, InitializingBean &#123;</span><br><span class="line">    ...</span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">        //获取内置数据库连接</span><br><span class="line">        this.embeddedDatabaseConnection = EmbeddedDatabaseConnection</span><br><span class="line">            .get(this.classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //创建数据库连接池</span><br><span class="line">    public DataSourceBuilder&lt;?&gt; initializeDataSourceBuilder() &#123;</span><br><span class="line">        return DataSourceBuilder.create(getClassLoader()).type(getType())</span><br><span class="line">                .driverClassName(determineDriverClassName()).url(determineUrl())</span><br><span class="line">                .username(determineUsername()).password(determinePassword());</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure><h4 id="5、DataSourceConfiguration-Tomcat-class"><a href="#5、DataSourceConfiguration-Tomcat-class" class="headerlink" title="5、DataSourceConfiguration.Tomcat.class"></a>5、DataSourceConfiguration.Tomcat.class</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//条件注解</span><br><span class="line">@ConditionalOnClass(org.apache.tomcat.jdbc.pool.DataSource.class)</span><br><span class="line">//条件注解</span><br><span class="line">@ConditionalOnProperty(name = &quot;spring.datasource.type&quot;, havingValue = &quot;org.apache.tomcat.jdbc.pool.DataSource&quot;, matchIfMissing = true)</span><br><span class="line">static class Tomcat extends DataSourceConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource.tomcat&quot;)</span><br><span class="line">    //创建数据源</span><br><span class="line">    public org.apache.tomcat.jdbc.pool.DataSource dataSource(</span><br><span class="line">            DataSourceProperties properties) &#123;</span><br><span class="line">        //创建连接池</span><br><span class="line">        org.apache.tomcat.jdbc.pool.DataSource dataSource = createDataSource(</span><br><span class="line">                properties, org.apache.tomcat.jdbc.pool.DataSource.class);</span><br><span class="line">        //获取数据库驱动</span><br><span class="line">        DatabaseDriver databaseDriver = DatabaseDriver</span><br><span class="line">                .fromJdbcUrl(properties.determineUrl());</span><br><span class="line">        String validationQuery = databaseDriver.getValidationQuery();</span><br><span class="line">        if (validationQuery != null) &#123;</span><br><span class="line">            dataSource.setTestOnBorrow(true);</span><br><span class="line">            dataSource.setValidationQuery(validationQuery);</span><br><span class="line">        &#125;</span><br><span class="line">        return dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="六、DataSourceTransactionManagerAutoConfiguration自动配置类"><a href="#六、DataSourceTransactionManagerAutoConfiguration自动配置类" class="headerlink" title="六、DataSourceTransactionManagerAutoConfiguration自动配置类"></a>六、DataSourceTransactionManagerAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">//条件注解</span><br><span class="line">@ConditionalOnClass(&#123; JdbcTemplate.class, PlatformTransactionManager.class &#125;)</span><br><span class="line">//自动配置优先级</span><br><span class="line">@AutoConfigureOrder(Ordered.LOWEST_PRECEDENCE)</span><br><span class="line">//自动配置数据源属性</span><br><span class="line">@EnableConfigurationProperties(DataSourceProperties.class)</span><br><span class="line">public class DataSourceTransactionManagerAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //条件注解，只有一个数据源</span><br><span class="line">    @ConditionalOnSingleCandidate(DataSource.class)</span><br><span class="line">    static class DataSourceTransactionManagerConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        private final DataSource dataSource;</span><br><span class="line"></span><br><span class="line">        private final TransactionManagerCustomizers transactionManagerCustomizers;</span><br><span class="line"></span><br><span class="line">        DataSourceTransactionManagerConfiguration(DataSource dataSource,</span><br><span class="line">                ObjectProvider&lt;TransactionManagerCustomizers&gt; transactionManagerCustomizers) &#123;</span><br><span class="line">            this.dataSource = dataSource;</span><br><span class="line">            this.transactionManagerCustomizers = transactionManagerCustomizers</span><br><span class="line">                    .getIfAvailable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Bean</span><br><span class="line">        //条件注解</span><br><span class="line">        @ConditionalOnMissingBean(PlatformTransactionManager.class)</span><br><span class="line">        //创建数据源事务管理器</span><br><span class="line">        public DataSourceTransactionManager transactionManager(</span><br><span class="line">                DataSourceProperties properties) &#123;</span><br><span class="line">            DataSourceTransactionManager transactionManager = new DataSourceTransactionManager(</span><br><span class="line">                    this.dataSource);</span><br><span class="line">            if (this.transactionManagerCustomizers != null) &#123;</span><br><span class="line">                this.transactionManagerCustomizers.customize(transactionManager);</span><br><span class="line">            &#125;</span><br><span class="line">            return transactionManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="七、DataSourceTransactionManagerAutoConfiguration自动配置类"><a href="#七、DataSourceTransactionManagerAutoConfiguration自动配置类" class="headerlink" title="七、DataSourceTransactionManagerAutoConfiguration自动配置类"></a>七、DataSourceTransactionManagerAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(PlatformTransactionManager.class)</span><br><span class="line">//检查解析配置类顺序</span><br><span class="line">@AutoConfigureAfter(&#123; JtaAutoConfiguration.class, HibernateJpaAutoConfiguration.class,</span><br><span class="line">        DataSourceTransactionManagerAutoConfiguration.class,</span><br><span class="line">        Neo4jDataAutoConfiguration.class &#125;)</span><br><span class="line">//自动配置事务属性</span><br><span class="line">@EnableConfigurationProperties(TransactionProperties.class)</span><br><span class="line">public class TransactionAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    //创建初始化器</span><br><span class="line">    public TransactionManagerCustomizers platformTransactionManagerCustomizers(</span><br><span class="line">            ObjectProvider&lt;List&lt;PlatformTransactionManagerCustomizer&lt;?&gt;&gt;&gt; customizers) &#123;</span><br><span class="line">        return new TransactionManagerCustomizers(customizers.getIfAvailable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    @ConditionalOnSingleCandidate(PlatformTransactionManager.class)</span><br><span class="line">    public static class TransactionTemplateConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        private final PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">        public TransactionTemplateConfiguration(</span><br><span class="line">                PlatformTransactionManager transactionManager) &#123;</span><br><span class="line">            this.transactionManager = transactionManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Bean</span><br><span class="line">        @ConditionalOnMissingBean</span><br><span class="line">        //编程式事务</span><br><span class="line">        public TransactionTemplate transactionTemplate() &#123;</span><br><span class="line">            return new TransactionTemplate(this.transactionManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    @ConditionalOnBean(PlatformTransactionManager.class)</span><br><span class="line">    //不存在该bean，说明未解析事务配置类</span><br><span class="line">    @ConditionalOnMissingBean(AbstractTransactionManagementConfiguration.class)</span><br><span class="line">    public static class EnableTransactionManagementConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        @Configuration</span><br><span class="line">        @EnableTransactionManagement(proxyTargetClass = false)</span><br><span class="line">        @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;, matchIfMissing = false)</span><br><span class="line">        //Jdk动态代理的方式实现事务</span><br><span class="line">        public static class JdkDynamicAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Configuration</span><br><span class="line">        @EnableTransactionManagement(proxyTargetClass = true)</span><br><span class="line">        @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">        //Cglib动态代理方式实现事务</span><br><span class="line">        public static class CglibAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1、-EnableTransactionManagement注解"><a href="#1、-EnableTransactionManagement注解" class="headerlink" title="1、@EnableTransactionManagement注解"></a>1、@EnableTransactionManagement注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(TransactionManagementConfigurationSelector.class)</span><br><span class="line">public @interface EnableTransactionManagement &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、TransactionManagementConfigurationSelector的selectImports方法"><a href="#2、TransactionManagementConfigurationSelector的selectImports方法" class="headerlink" title="2、TransactionManagementConfigurationSelector的selectImports方法"></a>2、TransactionManagementConfigurationSelector的selectImports方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected String[] selectImports(AdviceMode adviceMode) &#123;</span><br><span class="line">    switch (adviceMode) &#123;</span><br><span class="line">        //动态代理方式实现事务</span><br><span class="line">        case PROXY:</span><br><span class="line">            return new String[] &#123;AutoProxyRegistrar.class.getName(), ProxyTransactionManagementConfiguration.class.getName()&#125;;</span><br><span class="line">        //ASPECTJ方式实现事务</span><br><span class="line">        case ASPECTJ:</span><br><span class="line">            return new String[] &#123;TransactionManagementConfigUtils.TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME&#125;;</span><br><span class="line">        default:</span><br><span class="line">            return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AutoProxyRegistrar的registerBeanDefinitions方法"><a href="#3、AutoProxyRegistrar的registerBeanDefinitions方法" class="headerlink" title="3、AutoProxyRegistrar的registerBeanDefinitions方法"></a>3、AutoProxyRegistrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    boolean candidateFound = false;</span><br><span class="line">    Set&lt;String&gt; annoTypes = importingClassMetadata.getAnnotationTypes();</span><br><span class="line">    for (String annoType : annoTypes) &#123;</span><br><span class="line">        //获取注解信息</span><br><span class="line">        AnnotationAttributes candidate = AnnotationConfigUtils.attributesFor(importingClassMetadata, annoType);</span><br><span class="line">        if (candidate == null) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        Object mode = candidate.get(&quot;mode&quot;);</span><br><span class="line">        Object proxyTargetClass = candidate.get(&quot;proxyTargetClass&quot;);</span><br><span class="line">        if (mode != null &amp;&amp; proxyTargetClass != null &amp;&amp; AdviceMode.class == mode.getClass() &amp;&amp;</span><br><span class="line">                Boolean.class == proxyTargetClass.getClass()) &#123;</span><br><span class="line">            candidateFound = true;</span><br><span class="line">            //AOP代理方式实现事务</span><br><span class="line">            if (mode == AdviceMode.PROXY) &#123;</span><br><span class="line">                //注册InfrastructureAdvisorAutoProxyCreator</span><br><span class="line">                AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry);</span><br><span class="line">                if ((Boolean) proxyTargetClass) &#123;</span><br><span class="line">                    //设置&quot;proxyTargetClass&quot;属性</span><br><span class="line">                    AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!candidateFound) &#123;</span><br><span class="line">        String name = getClass().getSimpleName();</span><br><span class="line">        logger.warn(String.format(&quot;%s was imported but no annotations were found &quot; +</span><br><span class="line">                &quot;having both &apos;mode&apos; and &apos;proxyTargetClass&apos; attributes of type &quot; +</span><br><span class="line">                &quot;AdviceMode and boolean respectively. This means that auto proxy &quot; +</span><br><span class="line">                &quot;creator registration and configuration may not have occurred as &quot; +</span><br><span class="line">                &quot;intended, and components may not be proxied as expected. Check to &quot; +</span><br><span class="line">                &quot;ensure that %s has been @Import&apos;ed on the same class where these &quot; +</span><br><span class="line">                &quot;annotations are declared; otherwise remove the import of %s &quot; +</span><br><span class="line">                &quot;altogether.&quot;, name, name, name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、-ProxyTransactionManagementConfiguration注解"><a href="#4、-ProxyTransactionManagementConfiguration注解" class="headerlink" title="4、@ProxyTransactionManagementConfiguration注解"></a>4、@ProxyTransactionManagementConfiguration注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ProxyTransactionManagementConfiguration extends AbstractTransactionManagementConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)</span><br><span class="line">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">    //注册通知器</span><br><span class="line">    public BeanFactoryTransactionAttributeSourceAdvisor transactionAdvisor() &#123;</span><br><span class="line">        BeanFactoryTransactionAttributeSourceAdvisor advisor = new BeanFactoryTransactionAttributeSourceAdvisor();</span><br><span class="line">        advisor.setTransactionAttributeSource(transactionAttributeSource());</span><br><span class="line">        advisor.setAdvice(transactionInterceptor());</span><br><span class="line">        if (this.enableTx != null) &#123;</span><br><span class="line">            advisor.setOrder(this.enableTx.&lt;Integer&gt;getNumber(&quot;order&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        return advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">    //注册TransactionAttributeSource</span><br><span class="line">    public TransactionAttributeSource transactionAttributeSource() &#123;</span><br><span class="line">        return new AnnotationTransactionAttributeSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">    //注册TransactionInterceptor事务增强器</span><br><span class="line">    public TransactionInterceptor transactionInterceptor() &#123;</span><br><span class="line">        TransactionInterceptor interceptor = new TransactionInterceptor();</span><br><span class="line">        interceptor.setTransactionAttributeSource(transactionAttributeSource());</span><br><span class="line">        if (this.txManager != null) &#123;</span><br><span class="line">            interceptor.setTransactionManager(this.txManager);</span><br><span class="line">        &#125;</span><br><span class="line">        return interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="八、DataSourceTransactionManagerAutoConfiguration自动配置类"><a href="#八、DataSourceTransactionManagerAutoConfiguration自动配置类" class="headerlink" title="八、DataSourceTransactionManagerAutoConfiguration自动配置类"></a>八、DataSourceTransactionManagerAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@org.springframework.context.annotation.Configuration</span><br><span class="line">@ConditionalOnClass(&#123; SqlSessionFactory.class, SqlSessionFactoryBean.class &#125;)</span><br><span class="line">@ConditionalOnBean(DataSource.class)</span><br><span class="line">//自动处理属性注解</span><br><span class="line">@EnableConfigurationProperties(MybatisProperties.class)</span><br><span class="line">@AutoConfigureAfter(DataSourceAutoConfiguration.class)</span><br><span class="line">public class MybatisAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    //创建SqlSessionFactory</span><br><span class="line">    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">        SqlSessionFactoryBean factory = new SqlSessionFactoryBean();</span><br><span class="line">        factory.setDataSource(dataSource);</span><br><span class="line">        factory.setVfs(SpringBootVFS.class);</span><br><span class="line">        //设置配置文件地址</span><br><span class="line">        if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">            factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">        &#125;</span><br><span class="line">        Configuration configuration = this.properties.getConfiguration();</span><br><span class="line">        if (configuration == null &amp;&amp; !StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">            //创建configuration</span><br><span class="line">            configuration = new Configuration();</span><br><span class="line">        &#125;</span><br><span class="line">        if (configuration != null &amp;&amp; !CollectionUtils.isEmpty(this.configurationCustomizers)) &#123;</span><br><span class="line">            for (ConfigurationCustomizer customizer : this.configurationCustomizers) &#123;</span><br><span class="line">                customizer.customize(configuration);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置configuration</span><br><span class="line">        factory.setConfiguration(configuration);</span><br><span class="line">        if (this.properties.getConfigurationProperties() != null) &#123;</span><br><span class="line">            factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">        &#125;</span><br><span class="line">        //设置拦截器</span><br><span class="line">        if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">            factory.setPlugins(this.interceptors);</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.databaseIdProvider != null) &#123;</span><br><span class="line">            factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">        &#125;</span><br><span class="line">        //设置注册别名的包</span><br><span class="line">        if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">            factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">            factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">        &#125;</span><br><span class="line">        //mapper文件地址</span><br><span class="line">        if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">            factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return factory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    //创建SqlSessionTemplate</span><br><span class="line">    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">        ExecutorType executorType = this.properties.getExecutorType();</span><br><span class="line">        if (executorType != null) &#123;</span><br><span class="line">            return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#123;@link org.mybatis.spring.annotation.MapperScan&#125; ultimately ends up</span><br><span class="line">     * creating instances of &#123;@link MapperFactoryBean&#125;. If</span><br><span class="line">     * &#123;@link org.mybatis.spring.annotation.MapperScan&#125; is used then this</span><br><span class="line">     * auto-configuration is not needed. If it is _not_ used, however, then this</span><br><span class="line">     * will bring in a bean registrar and automatically register components based</span><br><span class="line">     * on the same component-scanning path as Spring Boot itself.</span><br><span class="line">     */</span><br><span class="line">    @org.springframework.context.annotation.Configuration</span><br><span class="line">    //执行AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions</span><br><span class="line">    @Import(&#123; AutoConfiguredMapperScannerRegistrar.class &#125;)</span><br><span class="line">    @ConditionalOnMissingBean(MapperFactoryBean.class)</span><br><span class="line">    public static class MapperScannerRegistrarNotFoundConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        @PostConstruct</span><br><span class="line">        public void afterPropertiesSet() &#123;</span><br><span class="line">            logger.debug(&quot;No &#123;&#125; found.&quot;, MapperFactoryBean.class.getName());</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法"><a href="#1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法" class="headerlink" title="1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法"></a>1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line"></span><br><span class="line">    logger.debug(&quot;Searching for mappers annotated with @Mapper&quot;);</span><br><span class="line">    //扫描器</span><br><span class="line">    ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (this.resourceLoader != null) &#123;</span><br><span class="line">            scanner.setResourceLoader(this.resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        //从IOC容器中，获取包路径</span><br><span class="line">        List&lt;String&gt; packages = AutoConfigurationPackages.get(this.beanFactory);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            for (String pkg : packages) &#123;</span><br><span class="line">                logger.debug(&quot;Using auto-configuration base package &apos;&#123;&#125;&apos;&quot;, pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置扫描的注解</span><br><span class="line">        scanner.setAnnotationClass(Mapper.class);</span><br><span class="line">        //设置过滤器</span><br><span class="line">        scanner.registerFilters();</span><br><span class="line">        //扫描包</span><br><span class="line">        scanner.doScan(StringUtils.toStringArray(packages));</span><br><span class="line">    &#125; catch (IllegalStateException ex) &#123;</span><br><span class="line">        logger.debug(&quot;Could not determine auto-configuration package, automatic mapper scanning disabled.&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>springboot源码启动过程</title>
    <link href="http://yoursite.com/2018/06/27/spring%E6%BA%90%E7%A0%81/springboot%E6%BA%90%E7%A0%81%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>http://yoursite.com/2018/06/27/spring源码/springboot源码启动过程/</id>
    <published>2018-06-27T13:10:29.012Z</published>
    <updated>2018-06-28T14:06:16.813Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class Application &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一、springboot启动过程"><a href="#一、springboot启动过程" class="headerlink" title="一、springboot启动过程"></a>一、springboot启动过程</h3><h4 id="1、SpringApplication的run方法"><a href="#1、SpringApplication的run方法" class="headerlink" title="1、SpringApplication的run方法"></a>1、SpringApplication的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static ConfigurableApplicationContext run(Class&lt;?&gt; primarySource,</span><br><span class="line">        String... args) &#123;</span><br><span class="line">    return run(new Class&lt;?&gt;[] &#123; primarySource &#125;, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static ConfigurableApplicationContext run(Class&lt;?&gt;[] primarySources,</span><br><span class="line">        String[] args) &#123;</span><br><span class="line">    return new SpringApplication(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、实例化SpringApplication"><a href="#2、实例化SpringApplication" class="headerlink" title="2、实例化SpringApplication"></a>2、实例化SpringApplication</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SpringApplication(Class&lt;?&gt;... primarySources) &#123;</span><br><span class="line">    this(null, primarySources);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span><br><span class="line">public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) &#123;</span><br><span class="line">    this.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, &quot;PrimarySources must not be null&quot;);</span><br><span class="line">    //Application类</span><br><span class="line">    this.primarySources = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    //判断应用类型是Standard还是Web</span><br><span class="line">    this.webApplicationType = deduceWebApplicationType();</span><br><span class="line">    //设置初始化器Initializer,从META-INF/spring.factories中获取配置的ApplicationContextInitializer类</span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(</span><br><span class="line">            ApplicationContextInitializer.class));</span><br><span class="line">    //设置监听器Listener,从META-INF/spring.factories中获取配置的ApplicationListener类</span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    //获取应用入口类</span><br><span class="line">    this.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认META-INF/spring.factories<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Application Context Initializers</span><br><span class="line">org.springframework.context.ApplicationContextInitializer=\</span><br><span class="line">org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line">org.springframework.boot.ClearCachesApplicationListener,\</span><br><span class="line">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</span><br><span class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.ConfigFileApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.LoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener</span><br></pre></td></tr></table></figure><h4 id="3、SpringApplication的deduceWebApplicationType方法"><a href="#3、SpringApplication的deduceWebApplicationType方法" class="headerlink" title="3、SpringApplication的deduceWebApplicationType方法"></a>3、SpringApplication的deduceWebApplicationType方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private WebApplicationType deduceWebApplicationType() &#123;</span><br><span class="line">    //有org.springframework.web.reactive.DispatcherHandler类</span><br><span class="line">    //且无org.springframework.web.servlet.DispatcherServlet类，则认为是reactive web application</span><br><span class="line">    if (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, null)</span><br><span class="line">            &amp;&amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, null)) &#123;</span><br><span class="line">        return WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有javax.servlet.Servlet和org.springframework.web.context.ConfigurableWebApplicationContext类</span><br><span class="line">    //则认为不是web项目   </span><br><span class="line">    for (String className : WEB_ENVIRONMENT_CLASSES) &#123;</span><br><span class="line">        if (!ClassUtils.isPresent(className, null)) &#123;</span><br><span class="line">            return WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //servlet-based web application</span><br><span class="line">    return WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、接（一、2）SpringApplication的deduceWebApplicationType方法"><a href="#4、接（一、2）SpringApplication的deduceWebApplicationType方法" class="headerlink" title="4、接（一、2）SpringApplication的deduceWebApplicationType方法"></a>4、接（一、2）SpringApplication的deduceWebApplicationType方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void setInitializers(</span><br><span class="line">        Collection&lt;? extends ApplicationContextInitializer&lt;?&gt;&gt; initializers) &#123;</span><br><span class="line">    this.initializers = new ArrayList&lt;&gt;();</span><br><span class="line">    this.initializers.addAll(initializers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（一、2）SpringApplication的getSpringFactoriesInstances方法"><a href="#5、接（一、2）SpringApplication的getSpringFactoriesInstances方法" class="headerlink" title="5、接（一、2）SpringApplication的getSpringFactoriesInstances方法"></a>5、接（一、2）SpringApplication的getSpringFactoriesInstances方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private &lt;T&gt; Collection&lt;T&gt; getSpringFactoriesInstances(Class&lt;T&gt; type) &#123;</span><br><span class="line">    //从META-INF/spring.factories中获取配置的type类</span><br><span class="line">    return getSpringFactoriesInstances(type, new Class&lt;?&gt;[] &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private &lt;T&gt; Collection&lt;T&gt; getSpringFactoriesInstances(Class&lt;T&gt; type,</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes, Object... args) &#123;</span><br><span class="line">    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    // Use names and ensure unique to protect against duplicates</span><br><span class="line">    //加载并获取该类</span><br><span class="line">    Set&lt;String&gt; names = new LinkedHashSet&lt;&gt;(</span><br><span class="line">            SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    //实例化names的类</span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes,</span><br><span class="line">            classLoader, args, names);</span><br><span class="line">    //排序</span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    return instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（一、2）SpringApplication的deduceMainApplicationClass方法"><a href="#6、接（一、2）SpringApplication的deduceMainApplicationClass方法" class="headerlink" title="6、接（一、2）SpringApplication的deduceMainApplicationClass方法"></a>6、接（一、2）SpringApplication的deduceMainApplicationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private Class&lt;?&gt; deduceMainApplicationClass() &#123;</span><br><span class="line">    //构造一个运行时异常，通过异常栈中方法名为main的栈帧来得到入口类的名字</span><br><span class="line">    try &#123;</span><br><span class="line">        StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();</span><br><span class="line">        for (StackTraceElement stackTraceElement : stackTrace) &#123;</span><br><span class="line">            if (&quot;main&quot;.equals(stackTraceElement.getMethodName())) &#123;</span><br><span class="line">                return Class.forName(stackTraceElement.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // Swallow and continue</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（一、1）SpringApplication的run方法"><a href="#7、接（一、1）SpringApplication的run方法" class="headerlink" title="7、接（一、1）SpringApplication的run方法"></a>7、接（一、1）SpringApplication的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">    //计时工具</span><br><span class="line">    StopWatch stopWatch = new StopWatch();</span><br><span class="line">    //启动计时器，设置开始时间</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    //容器</span><br><span class="line">    ConfigurableApplicationContext context = null;</span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList&lt;&gt;();</span><br><span class="line">    //设置java.awt.headless系统属性为true - 没有图形化界面</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    //获取SpringApplicationRunListeners</span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    // 广播开始启动事件</span><br><span class="line">    listeners.starting();</span><br><span class="line">    try &#123;</span><br><span class="line">        // 构造一个应用程序参数持有类</span><br><span class="line">        ApplicationArguments applicationArguments = new DefaultApplicationArguments(</span><br><span class="line">                args);</span><br><span class="line">        //根据SpringApplicationRunListeners以及参数来准备环境</span><br><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">                applicationArguments);</span><br><span class="line">        //设置是否跳过搜索BeanInfo类，默认true</span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line">        //准备Banner打印器 - 就是启动Spring Boot的时候打印在console上的ASCII艺术字体</span><br><span class="line">        Banner printedBanner = printBanner(environment);</span><br><span class="line">        //创建Spring容器</span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        //准备异常报告器</span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(</span><br><span class="line">                SpringBootExceptionReporter.class,</span><br><span class="line">                new Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        //Spring容器上下文前置处理</span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">                printedBanner);</span><br><span class="line">        //Spring容器上下文刷新</span><br><span class="line">        refreshContext(context);</span><br><span class="line">        //Spring容器上下文后置处理,默认为空</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        //停止计时器,设置结束时机</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        if (this.logStartupInfo) &#123;</span><br><span class="line">            new StartupInfoLogger(this.mainApplicationClass)</span><br><span class="line">                    .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line">        //广播启动完成事件</span><br><span class="line">        listeners.started(context);</span><br><span class="line">        // 调用Spring容器中的ApplicationRunner和CommandLineRunner接口的实现类</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">        throw new IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        listeners.running(context);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, null);</span><br><span class="line">        throw new IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    return context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>异常报告器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Error Reporters</span><br><span class="line">org.springframework.boot.SpringBootExceptionReporter=\</span><br><span class="line">org.springframework.boot.diagnostics.FailureAnalyzers</span><br></pre></td></tr></table></figure></p><h4 id="8、SpringApplication的getRunListeners方法"><a href="#8、SpringApplication的getRunListeners方法" class="headerlink" title="8、SpringApplication的getRunListeners方法"></a>8、SpringApplication的getRunListeners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private SpringApplicationRunListeners getRunListeners(String[] args) &#123;</span><br><span class="line">    Class&lt;?&gt;[] types = new Class&lt;?&gt;[] &#123; SpringApplication.class, String[].class &#125;;</span><br><span class="line">    //从META-INF/spring.factories中获取配置的SpringApplicationRunListener类,构造SpringApplicationRunListeners</span><br><span class="line">    return new SpringApplicationRunListeners(logger, getSpringFactoriesInstances(</span><br><span class="line">            SpringApplicationRunListener.class, types, this, args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br></pre></td></tr></table></figure><h4 id="9、实例化EventPublishingRunListener"><a href="#9、实例化EventPublishingRunListener" class="headerlink" title="9、实例化EventPublishingRunListener"></a>9、实例化EventPublishingRunListener</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public EventPublishingRunListener(SpringApplication application, String[] args) &#123;</span><br><span class="line">    this.application = application;</span><br><span class="line">    this.args = args;</span><br><span class="line">    //事件转发器</span><br><span class="line">    this.initialMulticaster = new SimpleApplicationEventMulticaster();</span><br><span class="line">    //添加监听器</span><br><span class="line">    for (ApplicationListener&lt;?&gt; listener : application.getListeners()) &#123;</span><br><span class="line">        this.initialMulticaster.addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（一、7）SpringApplication的getRunListeners方法"><a href="#10、接（一、7）SpringApplication的getRunListeners方法" class="headerlink" title="10、接（一、7）SpringApplication的getRunListeners方法"></a>10、接（一、7）SpringApplication的getRunListeners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void starting() &#123;</span><br><span class="line">    for (SpringApplicationRunListener listener : this.listeners) &#123;</span><br><span class="line">        //默认只有EventPublishingRunListener监听器</span><br><span class="line">        listener.starting();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、EventPublishingRunListener的starting方法"><a href="#11、EventPublishingRunListener的starting方法" class="headerlink" title="11、EventPublishingRunListener的starting方法"></a>11、EventPublishingRunListener的starting方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void starting() &#123;</span><br><span class="line">    //事件转发给相应的监听器</span><br><span class="line">    this.initialMulticaster.multicastEvent(</span><br><span class="line">            new ApplicationStartingEvent(this.application, this.args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接（一、7）SpringApplication的prepareEnvironment方法"><a href="#12、接（一、7）SpringApplication的prepareEnvironment方法" class="headerlink" title="12、接（一、7）SpringApplication的prepareEnvironment方法"></a>12、接（一、7）SpringApplication的prepareEnvironment方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private ConfigurableEnvironment prepareEnvironment(</span><br><span class="line">        SpringApplicationRunListeners listeners,</span><br><span class="line">        ApplicationArguments applicationArguments) &#123;</span><br><span class="line">    // Create and configure the environment</span><br><span class="line">    ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br><span class="line">    //设置环境</span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    //广播一个准备环境事件</span><br><span class="line">    listeners.environmentPrepared(environment);</span><br><span class="line">    //环境绑定到SpringApplication</span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    if (this.webApplicationType == WebApplicationType.NONE) &#123;</span><br><span class="line">        environment = new EnvironmentConverter(getClassLoader())</span><br><span class="line">                .convertToStandardEnvironmentIfNecessary(environment);</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    return environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、SpringApplication的getOrCreateEnvironment方法"><a href="#13、SpringApplication的getOrCreateEnvironment方法" class="headerlink" title="13、SpringApplication的getOrCreateEnvironment方法"></a>13、SpringApplication的getOrCreateEnvironment方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private ConfigurableEnvironment getOrCreateEnvironment() &#123;</span><br><span class="line">    if (this.environment != null) &#123;</span><br><span class="line">        return this.environment;</span><br><span class="line">    &#125;</span><br><span class="line">    //SERVLET的环境参数</span><br><span class="line">    if (this.webApplicationType == WebApplicationType.SERVLET) &#123;</span><br><span class="line">        return new StandardServletEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line">    //标准环境参数</span><br><span class="line">    return new StandardEnvironment();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（一、7）SpringApplication的createApplicationContext方法"><a href="#14、接（一、7）SpringApplication的createApplicationContext方法" class="headerlink" title="14、接（一、7）SpringApplication的createApplicationContext方法"></a>14、接（一、7）SpringApplication的createApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableApplicationContext createApplicationContext() &#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = this.applicationContextClass;</span><br><span class="line">    if (contextClass == null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            switch (this.webApplicationType) &#123;</span><br><span class="line">            //用该spring容器AnnotationConfigServletWebServerApplicationContext</span><br><span class="line">            case SERVLET:</span><br><span class="line">                contextClass = Class.forName(DEFAULT_WEB_CONTEXT_CLASS);</span><br><span class="line">                break;</span><br><span class="line">            //用该spring容器AnnotationConfigReactiveWebServerApplicationContext</span><br><span class="line">            case REACTIVE:</span><br><span class="line">                contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">                break;</span><br><span class="line">            //标准spring容器AnnotationConfigApplicationContext</span><br><span class="line">            default:</span><br><span class="line">                contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ClassNotFoundException ex) &#123;</span><br><span class="line">            throw new IllegalStateException(</span><br><span class="line">                    &quot;Unable create a default ApplicationContext, &quot;</span><br><span class="line">                            + &quot;please specify an ApplicationContextClass&quot;,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建容器对象</span><br><span class="line">    return (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、接（一、7）SpringApplication的prepareContext方法"><a href="#15、接（一、7）SpringApplication的prepareContext方法" class="headerlink" title="15、接（一、7）SpringApplication的prepareContext方法"></a>15、接（一、7）SpringApplication的prepareContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private void prepareContext(ConfigurableApplicationContext context,</span><br><span class="line">        ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span><br><span class="line">        ApplicationArguments applicationArguments, Banner printedBanner) &#123;</span><br><span class="line">    //往容器中设置环境</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    //配置Bean生成器以及资源加载器</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    //应用初始化器</span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    //广播Spring Boot启动过程的contextPrepared事件</span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    //打印启动信息</span><br><span class="line">    if (this.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == null);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Add boot specific singleton beans</span><br><span class="line">    // 添加两个Spring Boot中的特殊单例Beans - springApplicationArguments以及springBootBanner</span><br><span class="line">    context.getBeanFactory().registerSingleton(&quot;springApplicationArguments&quot;,</span><br><span class="line">            applicationArguments);</span><br><span class="line">    if (printedBanner != null) &#123;</span><br><span class="line">        context.getBeanFactory().registerSingleton(&quot;springBootBanner&quot;, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Load the sources</span><br><span class="line">    // 加载sources 本例中为Application.class</span><br><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">    Assert.notEmpty(sources, &quot;Sources must not be empty&quot;);</span><br><span class="line">    //加载sources中的类，Application.class被解析为AnnotatedGenericBeanDefinition注册到容器中</span><br><span class="line">    load(context, sources.toArray(new Object[0]));</span><br><span class="line">    //广播Spring Boot启动过程的contextLoaded事件</span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、SpringApplicationRunListeners的postProcessApplicationContext方法"><a href="#16、SpringApplicationRunListeners的postProcessApplicationContext方法" class="headerlink" title="16、SpringApplicationRunListeners的postProcessApplicationContext方法"></a>16、SpringApplicationRunListeners的postProcessApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected void postProcessApplicationContext(ConfigurableApplicationContext context) &#123;</span><br><span class="line">    //注册beanName生成器</span><br><span class="line">    if (this.beanNameGenerator != null) &#123;</span><br><span class="line">        context.getBeanFactory().registerSingleton(</span><br><span class="line">                AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR,</span><br><span class="line">                this.beanNameGenerator);</span><br><span class="line">    &#125;</span><br><span class="line">    //将ApplicationContext中的资源加载器放入容器中</span><br><span class="line">    if (this.resourceLoader != null) &#123;</span><br><span class="line">        if (context instanceof GenericApplicationContext) &#123;</span><br><span class="line">            ((GenericApplicationContext) context)</span><br><span class="line">                    .setResourceLoader(this.resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        if (context instanceof DefaultResourceLoader) &#123;</span><br><span class="line">            ((DefaultResourceLoader) context)</span><br><span class="line">                    .setClassLoader(this.resourceLoader.getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、接（一、7）SpringApplication的refreshContext方法"><a href="#17、接（一、7）SpringApplication的refreshContext方法" class="headerlink" title="17、接（一、7）SpringApplication的refreshContext方法"></a>17、接（一、7）SpringApplication的refreshContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void refreshContext(ConfigurableApplicationContext context) &#123;</span><br><span class="line">    //刷新容器</span><br><span class="line">    refresh(context);</span><br><span class="line">    if (this.registerShutdownHook) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 注册一个关闭容器时的钩子函数</span><br><span class="line">            context.registerShutdownHook();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (AccessControlException ex) &#123;</span><br><span class="line">            // Not allowed in some environments.</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（一、7）SpringApplication的callRunners方法"><a href="#18、接（一、7）SpringApplication的callRunners方法" class="headerlink" title="18、接（一、7）SpringApplication的callRunners方法"></a>18、接（一、7）SpringApplication的callRunners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void callRunners(ApplicationContext context, ApplicationArguments args) &#123;</span><br><span class="line">    List&lt;Object&gt; runners = new ArrayList&lt;&gt;();</span><br><span class="line">    // 找出Spring容器中ApplicationRunner接口的实现类</span><br><span class="line">    runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());</span><br><span class="line">    // 找出Spring容器中CommandLineRunner接口的实现类</span><br><span class="line">    runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());</span><br><span class="line">    // 对runners进行排序</span><br><span class="line">    AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">    // 遍历runners依次执行</span><br><span class="line">    for (Object runner : new LinkedHashSet&lt;&gt;(runners)) &#123;</span><br><span class="line">        if (runner instanceof ApplicationRunner) &#123;</span><br><span class="line">            callRunner((ApplicationRunner) runner, args);</span><br><span class="line">        &#125;</span><br><span class="line">        if (runner instanceof CommandLineRunner) &#123;</span><br><span class="line">            callRunner((CommandLineRunner) runner, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、AnnotationConfigApplicationContext容器"><a href="#二、AnnotationConfigApplicationContext容器" class="headerlink" title="二、AnnotationConfigApplicationContext容器"></a>二、AnnotationConfigApplicationContext容器</h3><h4 id="1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法"><a href="#1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法" class="headerlink" title="1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法"></a>1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法</h4><p>AnnotationConfigApplicationContext容器，上篇（三、3）中注册了配置类处理器ConfigurationClassPostProcessor<br>该处理器实现了BeanDefinitionRegistryPostProcessor，在invokeBeanFactoryPostProcessors方法中会调用该类的<br>postProcessBeanDefinitionRegistry方法和postProcessBeanFactory方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    int registryId = System.identityHashCode(registry);</span><br><span class="line">    if (this.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot; + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    if (this.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;postProcessBeanFactory already called on this post-processor against &quot; + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    this.registriesPostProcessed.add(registryId);</span><br><span class="line">    //处理配置类</span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法"><a href="#2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法" class="headerlink" title="2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法"></a>2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = new ArrayList&lt;&gt;();</span><br><span class="line">    //获取已有的beanName，Application也作为BeanDefinition注册到了容器中</span><br><span class="line">    String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">    for (String beanName : candidateNames) &#123;</span><br><span class="line">        BeanDefinition beanDef = registry.getBeanDefinition(beanName);</span><br><span class="line">        //BeanDefinition 中的configurationClass 属性为full 或者lite ,则意味着已经处理</span><br><span class="line">        if (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||</span><br><span class="line">                ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Bean definition has already been processed as a configuration class: &quot; + beanDef);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //如果类存在@Configuration、@Component、@ComponentScan、@Import、@ImportResource</span><br><span class="line">        //或者存在被@bean注解的方法，则加入configCandidates</span><br><span class="line">        else if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) &#123;</span><br><span class="line">            configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Return immediately if no @Configuration classes were found</span><br><span class="line">    if (configCandidates.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Sort by previously determined @Order value, if applicable</span><br><span class="line">    //对configCandidates排序,按照@Order配置的值进行排序</span><br><span class="line">    configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">        int i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">        int i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">        return Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // Detect any custom bean name generation strategy supplied through the enclosing application context</span><br><span class="line">    SingletonBeanRegistry sbr = null;</span><br><span class="line">    //DefaultListableBeanFactory是SingletonBeanRegistry的子类</span><br><span class="line">    if (registry instanceof SingletonBeanRegistry) &#123;</span><br><span class="line">        sbr = (SingletonBeanRegistry) registry;</span><br><span class="line">        if (!this.localBeanNameGeneratorSet) &#123;</span><br><span class="line">            BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">            if (generator != null) &#123;</span><br><span class="line">                this.componentScanBeanNameGenerator = generator;</span><br><span class="line">                this.importBeanNameGenerator = generator;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.environment == null) &#123;</span><br><span class="line">        this.environment = new StandardEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Parse each @Configuration class</span><br><span class="line">    //实例化ConfigurationClassParser解析配置类</span><br><span class="line">    ConfigurationClassParser parser = new ConfigurationClassParser(</span><br><span class="line">            this.metadataReaderFactory, this.problemReporter, this.environment,</span><br><span class="line">            this.resourceLoader, this.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = new LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line">    Set&lt;ConfigurationClass&gt; alreadyParsed = new HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line">    do &#123;</span><br><span class="line">        //解析配置类</span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">        //校验，配置类不能为final，@Bean注解的方法如不是static的则必须能被覆盖</span><br><span class="line">        parser.validate();</span><br><span class="line">        //解析完的配置类，除重，除去已加载的配置类</span><br><span class="line">        Set&lt;ConfigurationClass&gt; configClasses = new LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">        configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">        // Read the model and create bean definitions based on its content</span><br><span class="line">        if (this.reader == null) &#123;</span><br><span class="line">            this.reader = new ConfigurationClassBeanDefinitionReader(</span><br><span class="line">                    registry, this.sourceExtractor, this.resourceLoader, this.environment,</span><br><span class="line">                    this.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        //加载资源</span><br><span class="line">        this.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        //该配置类已处理</span><br><span class="line">        alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">        candidates.clear();</span><br><span class="line">        //获取注册的bean的BeanDefinition</span><br><span class="line">        if (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">            String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">            Set&lt;String&gt; oldCandidateNames = new HashSet&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line">            Set&lt;String&gt; alreadyParsedClasses = new HashSet&lt;&gt;();</span><br><span class="line">            for (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">                alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">            for (String candidateName : newCandidateNames) &#123;</span><br><span class="line">                if (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">                    BeanDefinition bd = registry.getBeanDefinition(candidateName);</span><br><span class="line">                    //新加载的BeanDefinition中的配置类</span><br><span class="line">                    if (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory) &amp;&amp;</span><br><span class="line">                            !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">                        candidates.add(new BeanDefinitionHolder(bd, candidateName));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            candidateNames = newCandidateNames;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //处理新加载的BeanDefinition中的配置类</span><br><span class="line">    while (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">    // Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span><br><span class="line">    if (sbr != null &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">        //注册一个ImportRegistry(ImportStack),</span><br><span class="line">        sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    //清除缓存</span><br><span class="line">    if (this.metadataReaderFactory instanceof CachingMetadataReaderFactory) &#123;</span><br><span class="line">        // Clear cache in externally provided MetadataReaderFactory; this is a no-op</span><br><span class="line">        // for a shared cache since it&apos;ll be cleared by the ApplicationContext.</span><br><span class="line">        ((CachingMetadataReaderFactory) this.metadataReaderFactory).clearCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ConfigurationClassUtils的checkConfigurationClassCandidate方法"><a href="#3、ConfigurationClassUtils的checkConfigurationClassCandidate方法" class="headerlink" title="3、ConfigurationClassUtils的checkConfigurationClassCandidate方法"></a>3、ConfigurationClassUtils的checkConfigurationClassCandidate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static boolean checkConfigurationClassCandidate(BeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory) &#123;</span><br><span class="line">    //获取类名</span><br><span class="line">    String className = beanDef.getBeanClassName();</span><br><span class="line">    if (className == null || beanDef.getFactoryMethodName() != null) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    //获得AnnotationMetadata</span><br><span class="line">    AnnotationMetadata metadata;</span><br><span class="line">    if (beanDef instanceof AnnotatedBeanDefinition &amp;&amp;</span><br><span class="line">            className.equals(((AnnotatedBeanDefinition) beanDef).getMetadata().getClassName())) &#123;</span><br><span class="line">        // Can reuse the pre-parsed metadata from the given BeanDefinition...</span><br><span class="line">        //直接从BeanDefinition获得Metadata</span><br><span class="line">        metadata = ((AnnotatedBeanDefinition) beanDef).getMetadata();</span><br><span class="line">    &#125;</span><br><span class="line">    else if (beanDef instanceof AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) beanDef).hasBeanClass()) &#123;</span><br><span class="line">        // Check already loaded Class if present...</span><br><span class="line">        // since we possibly can&apos;t even load the class file for this Class.</span><br><span class="line">        Class&lt;?&gt; beanClass = ((AbstractBeanDefinition) beanDef).getBeanClass();</span><br><span class="line">        //实例化StandardAnnotationMetadata</span><br><span class="line">        metadata = new StandardAnnotationMetadata(beanClass, true);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //通过MetadataReaderFactory中的MetadataReader进行读取</span><br><span class="line">            MetadataReader metadataReader = metadataReaderFactory.getMetadataReader(className);</span><br><span class="line">            metadata = metadataReader.getAnnotationMetadata();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IOException ex) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Could not find class file for introspecting configuration annotations: &quot; + className, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //存在Configuration注解,则为BeanDefinition 设置configurationClass属性为full</span><br><span class="line">    if (isFullConfigurationCandidate(metadata)) &#123;</span><br><span class="line">        beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL);</span><br><span class="line">    &#125;</span><br><span class="line">    //存在Component,ComponentScan,Import,ImportResource注解中的任意一个,或者存在被@bean注解的方法</span><br><span class="line">    //则设置configurationClass属性为lite</span><br><span class="line">    else if (isLiteConfigurationCandidate(metadata)) &#123;</span><br><span class="line">        beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // It&apos;s a full or lite configuration candidate... Let&apos;s determine the order value, if any.</span><br><span class="line">    //如果该类被@Order所注解,则设置order属性为@Order的值</span><br><span class="line">    Integer order = getOrder(metadata);</span><br><span class="line">    if (order != null) &#123;</span><br><span class="line">        beanDef.setAttribute(ORDER_ATTRIBUTE, order);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ConfigurationClassUtils的isFullConfigurationCandidate方法"><a href="#4、ConfigurationClassUtils的isFullConfigurationCandidate方法" class="headerlink" title="4、ConfigurationClassUtils的isFullConfigurationCandidate方法"></a>4、ConfigurationClassUtils的isFullConfigurationCandidate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isFullConfigurationCandidate(AnnotationMetadata metadata) &#123;</span><br><span class="line">    //是否存在Configuration注解</span><br><span class="line">    return metadata.isAnnotated(Configuration.class.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、StandardAnnotationMetadata的isAnnotated方法"><a href="#5、StandardAnnotationMetadata的isAnnotated方法" class="headerlink" title="5、StandardAnnotationMetadata的isAnnotated方法"></a>5、StandardAnnotationMetadata的isAnnotated方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean isAnnotated(String annotationName) &#123;</span><br><span class="line">    //是否存在annotationName注解</span><br><span class="line">    return (this.annotations.length &gt; 0 &amp;&amp;</span><br><span class="line">            AnnotatedElementUtils.isAnnotated(getIntrospectedClass(), annotationName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AnnotatedElementUtils的isAnnotated方法"><a href="#6、AnnotatedElementUtils的isAnnotated方法" class="headerlink" title="6、AnnotatedElementUtils的isAnnotated方法"></a>6、AnnotatedElementUtils的isAnnotated方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isAnnotated(AnnotatedElement element, String annotationName) &#123;</span><br><span class="line">    //是否存在annotationName注解</span><br><span class="line">    return Boolean.TRUE.equals(searchWithGetSemantics(element, null, annotationName, alwaysTrueAnnotationProcessor));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、AnnotatedElementUtils的searchWithGetSemantics方法"><a href="#7、AnnotatedElementUtils的searchWithGetSemantics方法" class="headerlink" title="7、AnnotatedElementUtils的searchWithGetSemantics方法"></a>7、AnnotatedElementUtils的searchWithGetSemantics方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemantics(AnnotatedElement element,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; annotationType,</span><br><span class="line">        @Nullable String annotationName, Processor&lt;T&gt; processor) &#123;</span><br><span class="line">    //查找并处理annotationName注解</span><br><span class="line">    return searchWithGetSemantics(element, annotationType, annotationName, null, processor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemantics(AnnotatedElement element,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; annotationType, @Nullable String annotationName,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; containerType, Processor&lt;T&gt; processor) &#123;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //查找并处理annotationName注解</span><br><span class="line">        return searchWithGetSemantics(element, annotationType, annotationName, containerType, processor,</span><br><span class="line">                new HashSet&lt;&gt;(), 0);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        AnnotationUtils.rethrowAnnotationConfigurationException(ex);</span><br><span class="line">        throw new IllegalStateException(&quot;Failed to introspect annotations on &quot; + element, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemantics(AnnotatedElement element,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; annotationType, @Nullable String annotationName,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; containerType, Processor&lt;T&gt; processor,</span><br><span class="line">        Set&lt;AnnotatedElement&gt; visited, int metaDepth) &#123;</span><br><span class="line">    //该配置类加入已处理的集合</span><br><span class="line">    if (visited.add(element)) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // Start searching within locally declared annotations</span><br><span class="line">            //获取该类的直接注解</span><br><span class="line">            List&lt;Annotation&gt; declaredAnnotations = Arrays.asList(element.getDeclaredAnnotations());</span><br><span class="line">            //查找并处理annotationName注解</span><br><span class="line">            T result = searchWithGetSemanticsInAnnotations(element, declaredAnnotations,</span><br><span class="line">                    annotationType, annotationName, containerType, processor, visited, metaDepth);</span><br><span class="line">            if (result != null) &#123;</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (element instanceof Class) &#123; // otherwise getAnnotations doesn&apos;t return anything new</span><br><span class="line">                List&lt;Annotation&gt; inheritedAnnotations = new ArrayList&lt;&gt;();</span><br><span class="line">                //获取该类的继承而来的注解</span><br><span class="line">                for (Annotation annotation : element.getAnnotations()) &#123;</span><br><span class="line">                    if (!declaredAnnotations.contains(annotation)) &#123;</span><br><span class="line">                        inheritedAnnotations.add(annotation);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Continue searching within inherited annotations</span><br><span class="line">                result = searchWithGetSemanticsInAnnotations(element, inheritedAnnotations,</span><br><span class="line">                        annotationType, annotationName, containerType, processor, visited, metaDepth);</span><br><span class="line">                if (result != null) &#123;</span><br><span class="line">                    return result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            AnnotationUtils.handleIntrospectionFailure(element, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法"><a href="#8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法" class="headerlink" title="8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法"></a>8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemanticsInAnnotations(@Nullable AnnotatedElement element,</span><br><span class="line">        List&lt;Annotation&gt; annotations, @Nullable Class&lt;? extends Annotation&gt; annotationType,</span><br><span class="line">        @Nullable String annotationName, @Nullable Class&lt;? extends Annotation&gt; containerType,</span><br><span class="line">        Processor&lt;T&gt; processor, Set&lt;AnnotatedElement&gt; visited, int metaDepth) &#123;</span><br><span class="line"></span><br><span class="line">    // Search in annotations</span><br><span class="line">    //循环该类注解</span><br><span class="line">    for (Annotation annotation : annotations) &#123;</span><br><span class="line">        Class&lt;? extends Annotation&gt; currentAnnotationType = annotation.annotationType();</span><br><span class="line">        if (!AnnotationUtils.isInJavaLangAnnotationPackage(currentAnnotationType)) &#123;</span><br><span class="line">            //查找并处理annotationName注解</span><br><span class="line">            if (currentAnnotationType == annotationType ||</span><br><span class="line">                    currentAnnotationType.getName().equals(annotationName) ||</span><br><span class="line">                    processor.alwaysProcesses()) &#123;</span><br><span class="line">                T result = processor.process(element, annotation, metaDepth);</span><br><span class="line">                if (result != null) &#123;</span><br><span class="line">                    if (processor.aggregates() &amp;&amp; metaDepth == 0) &#123;</span><br><span class="line">                        processor.getAggregatedResults().add(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        return result;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Repeatable annotations in container?</span><br><span class="line">            else if (currentAnnotationType == containerType) &#123;</span><br><span class="line">                for (Annotation contained : getRawAnnotationsFromContainer(element, annotation)) &#123;</span><br><span class="line">                    T result = processor.process(element, contained, metaDepth);</span><br><span class="line">                    if (result != null) &#123;</span><br><span class="line">                        // No need to post-process since repeatable annotations within a</span><br><span class="line">                        // container cannot be composed annotations.</span><br><span class="line">                        processor.getAggregatedResults().add(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Recursively search in meta-annotations</span><br><span class="line">    //循环该类注解</span><br><span class="line">    for (Annotation annotation : annotations) &#123;</span><br><span class="line">        //获取注解类型</span><br><span class="line">        Class&lt;? extends Annotation&gt; currentAnnotationType = annotation.annotationType();</span><br><span class="line">        if (hasSearchableMetaAnnotations(currentAnnotationType, annotationType, annotationName)) &#123;</span><br><span class="line">            //查找并处理annotationName注解</span><br><span class="line">            T result = searchWithGetSemantics(currentAnnotationType, annotationType,</span><br><span class="line">                    annotationName, containerType, processor, visited, metaDepth + 1);</span><br><span class="line">            if (result != null) &#123;</span><br><span class="line">                processor.postProcess(element, annotation, result);</span><br><span class="line">                if (processor.aggregates() &amp;&amp; metaDepth == 0) &#123;</span><br><span class="line">                    processor.getAggregatedResults().add(result);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    return result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（二、2）ConfigurationClassParser的parse方法"><a href="#9、接（二、2）ConfigurationClassParser的parse方法" class="headerlink" title="9、接（二、2）ConfigurationClassParser的parse方法"></a>9、接（二、2）ConfigurationClassParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void parse(Set&lt;BeanDefinitionHolder&gt; configCandidates) &#123;</span><br><span class="line">    this.deferredImportSelectors = new LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    for (BeanDefinitionHolder holder : configCandidates) &#123;</span><br><span class="line">        BeanDefinition bd = holder.getBeanDefinition();</span><br><span class="line">        try &#123;</span><br><span class="line">            //解析配置类</span><br><span class="line">            if (bd instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">                parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            else if (bd instanceof AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) bd).hasBeanClass()) &#123;</span><br><span class="line">                parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                parse(bd.getBeanClassName(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(</span><br><span class="line">                    &quot;Failed to parse configuration class [&quot; + bd.getBeanClassName() + &quot;]&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    processDeferredImportSelectors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected final void parse(AnnotationMetadata metadata, String beanName) throws IOException &#123;</span><br><span class="line">    //解析配置类</span><br><span class="line">    processConfigurationClass(new ConfigurationClass(metadata, beanName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、ConfigurationClassParser的processConfigurationClass方法"><a href="#10、ConfigurationClassParser的processConfigurationClass方法" class="headerlink" title="10、ConfigurationClassParser的processConfigurationClass方法"></a>10、ConfigurationClassParser的processConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">protected void processConfigurationClass(ConfigurationClass configClass) throws IOException &#123;</span><br><span class="line">    //该类有条件注解，且不匹配，不处理</span><br><span class="line">    if (this.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConfigurationClass existingClass = this.configurationClasses.get(configClass);</span><br><span class="line">    if (existingClass != null) &#123;</span><br><span class="line">        //该类已解析，且为import的类，合并导入信息，不处理该类</span><br><span class="line">        if (configClass.isImported()) &#123;</span><br><span class="line">            if (existingClass.isImported()) &#123;</span><br><span class="line">                existingClass.mergeImportedBy(configClass);</span><br><span class="line">            &#125;</span><br><span class="line">            // Otherwise ignore new imported config class; existing non-imported class overrides it.</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //删除旧配置类，重新解析</span><br><span class="line">        else &#123;</span><br><span class="line">            // Explicit bean definition found, probably replacing an import.</span><br><span class="line">            // Let&apos;s remove the old one and go with the new one.</span><br><span class="line">            this.configurationClasses.remove(configClass);</span><br><span class="line">            this.knownSuperclasses.values().removeIf(configClass::equals);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Recursively process the configuration class and its superclass hierarchy.</span><br><span class="line">    //配置类</span><br><span class="line">    SourceClass sourceClass = asSourceClass(configClass);</span><br><span class="line">    do &#123;</span><br><span class="line">        //解析配置类</span><br><span class="line">        sourceClass = doProcessConfigurationClass(configClass, sourceClass);</span><br><span class="line">    &#125;</span><br><span class="line">    while (sourceClass != null);</span><br><span class="line"></span><br><span class="line">    this.configurationClasses.put(configClass, configClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ConfigurationClassParser的doProcessConfigurationClass方法"><a href="#11、ConfigurationClassParser的doProcessConfigurationClass方法" class="headerlink" title="11、ConfigurationClassParser的doProcessConfigurationClass方法"></a>11、ConfigurationClassParser的doProcessConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)</span><br><span class="line">        throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    // Recursively process any member (nested) classes first</span><br><span class="line">    //处理内部类</span><br><span class="line">    processMemberClasses(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">    // Process any @PropertySource annotations</span><br><span class="line">    //处理配置类、配置类父类、配置类注解类的@PropertySource注解</span><br><span class="line">    for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">            org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">        if (this.environment instanceof ConfigurableEnvironment) &#123;</span><br><span class="line">            processPropertySource(propertySource);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            logger.warn(&quot;Ignoring @PropertySource annotation on [&quot; + sourceClass.getMetadata().getClassName() +</span><br><span class="line">                    &quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process any @ComponentScan annotations</span><br><span class="line">    //获取配置类、配置类父类、配置类注解类的@ComponentScan注解</span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    if (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">            !this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        for (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">            // The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span><br><span class="line">            //解析注解，并扫描</span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">                    this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">            // Check the set of scanned definitions for any further config classes and parse recursively if needed</span><br><span class="line">            for (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">                BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">                if (bdCand == null) &#123;</span><br><span class="line">                    bdCand = holder.getBeanDefinition();</span><br><span class="line">                &#125;</span><br><span class="line">                //继续解析扫描获取到的配置类</span><br><span class="line">                if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) &#123;</span><br><span class="line">                    parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process any @Import annotations</span><br><span class="line">    //处理配置类、配置类父类、配置类注解类的@Import注解</span><br><span class="line">    //将注解的值注册到容器中</span><br><span class="line">    processImports(configClass, sourceClass, getImports(sourceClass), true);</span><br><span class="line"></span><br><span class="line">    // Process any @ImportResource annotations</span><br><span class="line">    //处理配置类、配置类父类、配置类注解类的@ImportResource注解的值</span><br><span class="line">    AnnotationAttributes importResource =</span><br><span class="line">            AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">    if (importResource != null) &#123;</span><br><span class="line">        //获取资源</span><br><span class="line">        String[] resources = importResource.getStringArray(&quot;locations&quot;);</span><br><span class="line">        Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(&quot;reader&quot;);</span><br><span class="line">        //遍历资源,加入到configClass中</span><br><span class="line">        for (String resource : resources) &#123;</span><br><span class="line">            String resolvedResource = this.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">            configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process individual @Bean methods</span><br><span class="line">    //配置类的@Bean注解的方法,添加到configClass</span><br><span class="line">    Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">    for (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">        configClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process default methods on interfaces</span><br><span class="line">    //配置类接口的方法,添加到configClass</span><br><span class="line">    processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">    // Process superclass, if any</span><br><span class="line">    //配置类有父类则继续处理</span><br><span class="line">    if (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">        String superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">        if (superclass != null &amp;&amp; !superclass.startsWith(&quot;java&quot;) &amp;&amp;</span><br><span class="line">                !this.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">            this.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">            // Superclass found, return its annotation metadata and recurse</span><br><span class="line">            return sourceClass.getSuperClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // No superclass -&gt; processing is complete</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、ConfigurationClassParser的processMemberClasses方法"><a href="#12、ConfigurationClassParser的processMemberClasses方法" class="headerlink" title="12、ConfigurationClassParser的processMemberClasses方法"></a>12、ConfigurationClassParser的processMemberClasses方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void processMemberClasses(ConfigurationClass configClass, SourceClass sourceClass) throws IOException &#123;</span><br><span class="line">    //获取内部类</span><br><span class="line">    Collection&lt;SourceClass&gt; memberClasses = sourceClass.getMemberClasses();</span><br><span class="line">    if (!memberClasses.isEmpty()) &#123;</span><br><span class="line">        List&lt;SourceClass&gt; candidates = new ArrayList&lt;&gt;(memberClasses.size());</span><br><span class="line">        //遍历class中的内部类,将配置类加入candidates</span><br><span class="line">        for (SourceClass memberClass : memberClasses) &#123;</span><br><span class="line">            if (ConfigurationClassUtils.isConfigurationCandidate(memberClass.getMetadata()) &amp;&amp;</span><br><span class="line">                    !memberClass.getMetadata().getClassName().equals(configClass.getMetadata().getClassName())) &#123;</span><br><span class="line">                candidates.add(memberClass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //排序</span><br><span class="line">        OrderComparator.sort(candidates);</span><br><span class="line">        //遍历candidates</span><br><span class="line">        for (SourceClass candidate : candidates) &#123;</span><br><span class="line">            //importStack包含该configClass的类,说明发生了循环依赖</span><br><span class="line">            if (this.importStack.contains(configClass)) &#123;</span><br><span class="line">                this.problemReporter.error(new CircularImportProblem(configClass, this.importStack));</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                this.importStack.push(configClass);</span><br><span class="line">                try &#123;</span><br><span class="line">                    //解析该配置类</span><br><span class="line">                    processConfigurationClass(candidate.asConfigClass(configClass));</span><br><span class="line">                &#125;</span><br><span class="line">                finally &#123;</span><br><span class="line">                    this.importStack.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、接（二、11）ConfigurationClassParser的processPropertySource方法"><a href="#13、接（二、11）ConfigurationClassParser的processPropertySource方法" class="headerlink" title="13、接（二、11）ConfigurationClassParser的processPropertySource方法"></a>13、接（二、11）ConfigurationClassParser的processPropertySource方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">private void processPropertySource(AnnotationAttributes propertySource) throws IOException &#123;</span><br><span class="line">    String name = propertySource.getString(&quot;name&quot;);</span><br><span class="line">    if (!StringUtils.hasLength(name)) &#123;</span><br><span class="line">        name = null;</span><br><span class="line">    &#125;</span><br><span class="line">    String encoding = propertySource.getString(&quot;encoding&quot;);</span><br><span class="line">    if (!StringUtils.hasLength(encoding)) &#123;</span><br><span class="line">        encoding = null;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取资源地址</span><br><span class="line">    String[] locations = propertySource.getStringArray(&quot;value&quot;);</span><br><span class="line">    Assert.isTrue(locations.length &gt; 0, &quot;At least one @PropertySource(value) location is required&quot;);</span><br><span class="line">    //是否忽略未发现资源</span><br><span class="line">    boolean ignoreResourceNotFound = propertySource.getBoolean(&quot;ignoreResourceNotFound&quot;);</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends PropertySourceFactory&gt; factoryClass = propertySource.getClass(&quot;factory&quot;);</span><br><span class="line">    //默认DefaultPropertySourceFactory</span><br><span class="line">    PropertySourceFactory factory = (factoryClass == PropertySourceFactory.class ?</span><br><span class="line">            DEFAULT_PROPERTY_SOURCE_FACTORY : BeanUtils.instantiateClass(factoryClass));</span><br><span class="line"></span><br><span class="line">    for (String location : locations) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //对location进行SPEL表达式的解析。比如$&#123;app&#125;</span><br><span class="line">            String resolvedLocation = this.environment.resolveRequiredPlaceholders(location);</span><br><span class="line">            Resource resource = this.resourceLoader.getResource(resolvedLocation);</span><br><span class="line">            //将指定的资源处理之后，添加到当前springboot运行的环境中</span><br><span class="line">            addPropertySource(factory.createPropertySource(name, new EncodedResource(resource, encoding)));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IllegalArgumentException | FileNotFoundException | UnknownHostException ex) &#123;</span><br><span class="line">            // Placeholders not resolvable or resource not found when trying to open it</span><br><span class="line">            if (ignoreResourceNotFound) &#123;</span><br><span class="line">                if (logger.isInfoEnabled()) &#123;</span><br><span class="line">                    logger.info(&quot;Properties location [&quot; + location + &quot;] not resolvable: &quot; + ex.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（二、11）ComponentScanAnnotationParser的parse方法"><a href="#14、接（二、11）ComponentScanAnnotationParser的parse方法" class="headerlink" title="14、接（二、11）ComponentScanAnnotationParser的parse方法"></a>14、接（二、11）ComponentScanAnnotationParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public Set&lt;BeanDefinitionHolder&gt; parse(AnnotationAttributes componentScan, final String declaringClass) &#123;</span><br><span class="line">    //扫描器</span><br><span class="line">    ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(this.registry,</span><br><span class="line">            componentScan.getBoolean(&quot;useDefaultFilters&quot;), this.environment, this.resourceLoader);</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass = componentScan.getClass(&quot;nameGenerator&quot;);</span><br><span class="line">    boolean useInheritedGenerator = (BeanNameGenerator.class == generatorClass);</span><br><span class="line">    //设置beanName生成器</span><br><span class="line">    scanner.setBeanNameGenerator(useInheritedGenerator ? this.beanNameGenerator :</span><br><span class="line">            BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    //代理，解决向大作用域bean注入小作用域bean的问题</span><br><span class="line">    ScopedProxyMode scopedProxyMode = componentScan.getEnum(&quot;scopedProxy&quot;);</span><br><span class="line">    if (scopedProxyMode != ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">        scanner.setScopedProxyMode(scopedProxyMode);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Class&lt;? extends ScopeMetadataResolver&gt; resolverClass = componentScan.getClass(&quot;scopeResolver&quot;);</span><br><span class="line">        scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));</span><br><span class="line">    &#125;</span><br><span class="line">    //对资源进行筛选的正则表达式</span><br><span class="line">    scanner.setResourcePattern(componentScan.getString(&quot;resourcePattern&quot;));</span><br><span class="line">    //过滤器，指定扫描资源</span><br><span class="line">    for (AnnotationAttributes filter : componentScan.getAnnotationArray(&quot;includeFilters&quot;)) &#123;</span><br><span class="line">        for (TypeFilter typeFilter : typeFiltersFor(filter)) &#123;</span><br><span class="line">            scanner.addIncludeFilter(typeFilter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //过滤器，排除不扫描资源</span><br><span class="line">    for (AnnotationAttributes filter : componentScan.getAnnotationArray(&quot;excludeFilters&quot;)) &#123;</span><br><span class="line">        for (TypeFilter typeFilter : typeFiltersFor(filter)) &#123;</span><br><span class="line">            scanner.addExcludeFilter(typeFilter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //是否延迟加载</span><br><span class="line">    boolean lazyInit = componentScan.getBoolean(&quot;lazyInit&quot;);</span><br><span class="line">    if (lazyInit) &#123;</span><br><span class="line">        scanner.getBeanDefinitionDefaults().setLazyInit(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取扫描资源的包路径</span><br><span class="line">    Set&lt;String&gt; basePackages = new LinkedHashSet&lt;&gt;();</span><br><span class="line">    //获取配置的包路径</span><br><span class="line">    String[] basePackagesArray = componentScan.getStringArray(&quot;basePackages&quot;);</span><br><span class="line">    for (String pkg : basePackagesArray) &#123;</span><br><span class="line">        String[] tokenized = StringUtils.tokenizeToStringArray(this.environment.resolvePlaceholders(pkg),</span><br><span class="line">                ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">        Collections.addAll(basePackages, tokenized);</span><br><span class="line">    &#125;</span><br><span class="line">    for (Class&lt;?&gt; clazz : componentScan.getClassArray(&quot;basePackageClasses&quot;)) &#123;</span><br><span class="line">        basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">    &#125;</span><br><span class="line">    //默认扫描配置类的包</span><br><span class="line">    if (basePackages.isEmpty()) &#123;</span><br><span class="line">        basePackages.add(ClassUtils.getPackageName(declaringClass));</span><br><span class="line">    &#125;</span><br><span class="line">    //排除自己</span><br><span class="line">    scanner.addExcludeFilter(new AbstractTypeHierarchyTraversingFilter(false, false) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected boolean matchClassName(String className) &#123;</span><br><span class="line">            return declaringClass.equals(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //扫描加载资源，在上篇已有解析</span><br><span class="line">    return scanner.doScan(StringUtils.toStringArray(basePackages));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（二、11）ComponentScanAnnotationParser的processImports方法"><a href="#14、接（二、11）ComponentScanAnnotationParser的processImports方法" class="headerlink" title="14、接（二、11）ComponentScanAnnotationParser的processImports方法"></a>14、接（二、11）ComponentScanAnnotationParser的processImports方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">private void processImports(ConfigurationClass configClass, SourceClass currentSourceClass,</span><br><span class="line">        Collection&lt;SourceClass&gt; importCandidates, boolean checkForCircularImports) &#123;</span><br><span class="line">    //import的类为空</span><br><span class="line">    if (importCandidates.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //检查循环依赖</span><br><span class="line">    if (checkForCircularImports &amp;&amp; isChainedImportOnStack(configClass)) &#123;</span><br><span class="line">        this.problemReporter.error(new CircularImportProblem(configClass, this.importStack));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        this.importStack.push(configClass);</span><br><span class="line">        try &#123;</span><br><span class="line">            //遍历处理</span><br><span class="line">            for (SourceClass candidate : importCandidates) &#123;</span><br><span class="line">                //ImportSelector的子类</span><br><span class="line">                if (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">                    // Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br><span class="line">                    Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">                    //实例化该类</span><br><span class="line">                    ImportSelector selector = BeanUtils.instantiateClass(candidateClass, ImportSelector.class);</span><br><span class="line">                    //给实现特定接口的类设置资源</span><br><span class="line">                    ParserStrategyUtils.invokeAwareMethods(</span><br><span class="line">                            selector, this.environment, this.resourceLoader, this.registry);</span><br><span class="line">                    //DeferredImportSelector的实现,加入到deferredImportSelectors</span><br><span class="line">                    if (this.deferredImportSelectors != null &amp;&amp; selector instanceof DeferredImportSelector) &#123;</span><br><span class="line">                        this.deferredImportSelectors.add(</span><br><span class="line">                                new DeferredImportSelectorHolder(configClass, (DeferredImportSelector) selector));</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        //获取该类中定义的需要import的类</span><br><span class="line">                        String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">                        Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames);</span><br><span class="line">                        //循环调用该方法，处理importSourceClasses</span><br><span class="line">                        processImports(configClass, currentSourceClass, importSourceClasses, false);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //ImportBeanDefinitionRegistrar的子类</span><br><span class="line">                else if (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">                    // Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span><br><span class="line">                    // delegate to it to register additional bean definitions</span><br><span class="line">                    Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">                    ImportBeanDefinitionRegistrar registrar =</span><br><span class="line">                            BeanUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class);</span><br><span class="line">                    ParserStrategyUtils.invokeAwareMethods(</span><br><span class="line">                            registrar, this.environment, this.resourceLoader, this.registry);</span><br><span class="line">                    //添加到configClass中</span><br><span class="line">                    configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    // Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span><br><span class="line">                    // process it as an @Configuration class</span><br><span class="line">                    this.importStack.registerImport(</span><br><span class="line">                            currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());</span><br><span class="line">                    //调用processConfigurationClass进行处理,当成普通配置类</span><br><span class="line">                    processConfigurationClass(candidate.asConfigClass(configClass));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(</span><br><span class="line">                    &quot;Failed to process import candidates for configuration class [&quot; +</span><br><span class="line">                    configClass.getMetadata().getClassName() + &quot;]&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            this.importStack.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、接（二、9）ConfigurationClassParser的parse方法"><a href="#15、接（二、9）ConfigurationClassParser的parse方法" class="headerlink" title="15、接（二、9）ConfigurationClassParser的parse方法"></a>15、接（二、9）ConfigurationClassParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    private void processDeferredImportSelectors() &#123;</span><br><span class="line">    //import进来的DeferredImportSelector</span><br><span class="line">    List&lt;DeferredImportSelectorHolder&gt; deferredImports = this.deferredImportSelectors;</span><br><span class="line">    this.deferredImportSelectors = null;</span><br><span class="line">    if (deferredImports == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //排序</span><br><span class="line">    deferredImports.sort(DEFERRED_IMPORT_COMPARATOR);</span><br><span class="line">    Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = new LinkedHashMap&lt;&gt;();</span><br><span class="line">    Map&lt;AnnotationMetadata, ConfigurationClass&gt; configurationClasses = new HashMap&lt;&gt;();</span><br><span class="line">    //DeferredImportSelector分组</span><br><span class="line">    for (DeferredImportSelectorHolder deferredImport : deferredImports) &#123;</span><br><span class="line">        Class&lt;? extends Group&gt; group = deferredImport.getImportSelector().getImportGroup();</span><br><span class="line">        DeferredImportSelectorGrouping grouping = groupings.computeIfAbsent(</span><br><span class="line">                (group == null ? deferredImport : group),</span><br><span class="line">                (key) -&gt; new DeferredImportSelectorGrouping(createGroup(group)));</span><br><span class="line">        grouping.add(deferredImport);</span><br><span class="line">        configurationClasses.put(deferredImport.getConfigurationClass().getMetadata(),</span><br><span class="line">                deferredImport.getConfigurationClass());</span><br><span class="line">    &#125;</span><br><span class="line">    for (DeferredImportSelectorGrouping grouping : groupings.values()) &#123;</span><br><span class="line">        //获取、排序、遍历DeferredImportSelector中要导入的类</span><br><span class="line">        grouping.getImports().forEach((entry) -&gt; &#123;</span><br><span class="line">            ConfigurationClass configurationClass = configurationClasses.get(</span><br><span class="line">                    entry.getMetadata());</span><br><span class="line">            try &#123;</span><br><span class="line">                //导入、解析并注册到容器中</span><br><span class="line">                processImports(configurationClass, asSourceClass(configurationClass),</span><br><span class="line">                        asSourceClasses(entry.getImportClassName()), false);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                throw new BeanDefinitionStoreException(</span><br><span class="line">                        &quot;Failed to process import candidates for configuration class [&quot; +</span><br><span class="line">                                configurationClass.getMetadata().getClassName() + &quot;]&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、AutoConfigurationGroup的sortAutoConfigurations方法"><a href="#16、AutoConfigurationGroup的sortAutoConfigurations方法" class="headerlink" title="16、AutoConfigurationGroup的sortAutoConfigurations方法"></a>16、AutoConfigurationGroup的sortAutoConfigurations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;String&gt; sortAutoConfigurations() &#123;</span><br><span class="line">    List&lt;String&gt; autoConfigurations = new ArrayList&lt;&gt;(this.entries.keySet());</span><br><span class="line">    if (this.entries.size() &lt;= 1) &#123;</span><br><span class="line">        return autoConfigurations;</span><br><span class="line">    &#125;</span><br><span class="line">    AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">            .loadMetadata(this.beanClassLoader);</span><br><span class="line">    //对即将导入的类排序</span><br><span class="line">    return new AutoConfigurationSorter(getMetadataReaderFactory(),</span><br><span class="line">            autoConfigurationMetadata).getInPriorityOrder(autoConfigurations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、AutoConfigurationSorter的sortAutoConfigurations方法"><a href="#17、AutoConfigurationSorter的sortAutoConfigurations方法" class="headerlink" title="17、AutoConfigurationSorter的sortAutoConfigurations方法"></a>17、AutoConfigurationSorter的sortAutoConfigurations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;String&gt; getInPriorityOrder(Collection&lt;String&gt; classNames) &#123;</span><br><span class="line">    AutoConfigurationClasses classes = new AutoConfigurationClasses(</span><br><span class="line">            this.metadataReaderFactory, this.autoConfigurationMetadata, classNames);</span><br><span class="line">    List&lt;String&gt; orderedClassNames = new ArrayList&lt;&gt;(classNames);</span><br><span class="line">    // Initially sort alphabetically</span><br><span class="line">    //按照名称字母排序</span><br><span class="line">    Collections.sort(orderedClassNames);</span><br><span class="line">    // Then sort by order</span><br><span class="line">    //按照@AutoConfigureOrder值排序</span><br><span class="line">    orderedClassNames.sort((o1, o2) -&gt; &#123;</span><br><span class="line">        int i1 = classes.get(o1).getOrder();</span><br><span class="line">        int i2 = classes.get(o2).getOrder();</span><br><span class="line">        return Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line">    // Then respect @AutoConfigureBefore @AutoConfigureAfter</span><br><span class="line">    //检查@AutoConfigureBefore @AutoConfigureAfter规定的顺序是否满足</span><br><span class="line">    orderedClassNames = sortByAnnotation(classes, orderedClassNames);</span><br><span class="line">    return orderedClassNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法"><a href="#18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法" class="headerlink" title="18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法"></a>18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void loadBeanDefinitions(Set&lt;ConfigurationClass&gt; configurationModel) &#123;</span><br><span class="line">    //条件注解处理器</span><br><span class="line">    TrackedConditionEvaluator trackedConditionEvaluator = new TrackedConditionEvaluator();</span><br><span class="line">    //遍历处理配置类</span><br><span class="line">    for (ConfigurationClass configClass : configurationModel) &#123;</span><br><span class="line">        loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法"><a href="#19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法" class="headerlink" title="19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法"></a>19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsForConfigurationClass(</span><br><span class="line">        ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) &#123;</span><br><span class="line">    //使用条件注解判断是否需要跳过这个配置类</span><br><span class="line">    if (trackedConditionEvaluator.shouldSkip(configClass)) &#123;</span><br><span class="line">        //跳过配置类则移除Spring容器中bean的注册</span><br><span class="line">        String beanName = configClass.getBeanName();</span><br><span class="line">        if (StringUtils.hasLength(beanName) &amp;&amp; this.registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            this.registry.removeBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        //从importRegistry进行删除</span><br><span class="line">        this.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //配置类是被@Import注释所import的，注册自己</span><br><span class="line">    if (configClass.isImported()) &#123;</span><br><span class="line">        registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line">    &#125;</span><br><span class="line">    //遍历BeanMethods,依次对其进行注册</span><br><span class="line">    for (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;</span><br><span class="line">        loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    //注册@ImportResource注解注释的资源文件中的bean</span><br><span class="line">    loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line">    //注册@Import注解中的ImportBeanDefinitionRegistrar接口的registerBeanDefinitions</span><br><span class="line">    loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法"><a href="#20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法" class="headerlink" title="20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法"></a>20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void registerBeanDefinitionForImportedConfigurationClass(ConfigurationClass configClass) &#123;</span><br><span class="line">    //根据configClass中配置的AnnotationMetadata 实例化AnnotatedGenericBeanDefinition</span><br><span class="line">    AnnotationMetadata metadata = configClass.getMetadata();</span><br><span class="line">    AnnotatedGenericBeanDefinition configBeanDef = new AnnotatedGenericBeanDefinition(metadata);</span><br><span class="line">    //解析并设置该configClass的Scope</span><br><span class="line">    ScopeMetadata scopeMetadata = scopeMetadataResolver.resolveScopeMetadata(configBeanDef);</span><br><span class="line">    configBeanDef.setScope(scopeMetadata.getScopeName());</span><br><span class="line">    //生成bean的id</span><br><span class="line">    String configBeanName = this.importBeanNameGenerator.generateBeanName(configBeanDef, this.registry);</span><br><span class="line">    //设置bean的一些属性,如LazyInit,Primary,DependsOn等</span><br><span class="line">    AnnotationConfigUtils.processCommonDefinitionAnnotations(configBeanDef, metadata);</span><br><span class="line">    //生成BeanDefinitionHolder,并对其尝试进行代理,最后向registry进行注册</span><br><span class="line">    BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(configBeanDef, configBeanName);</span><br><span class="line">    definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);</span><br><span class="line">    this.registry.registerBeanDefinition(definitionHolder.getBeanName(), definitionHolder.getBeanDefinition());</span><br><span class="line">    configClass.setBeanName(configBeanName);</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Registered bean definition for imported class &apos;&quot; + configBeanName + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法"><a href="#21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法" class="headerlink" title="21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法"></a>21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) &#123;</span><br><span class="line">    //获得声明该BeanMethod的ConfigurationClass</span><br><span class="line">    ConfigurationClass configClass = beanMethod.getConfigurationClass();</span><br><span class="line">    //获得BeanMethod的MethodMetadata和methodName</span><br><span class="line">    MethodMetadata metadata = beanMethod.getMetadata();</span><br><span class="line">    String methodName = metadata.getMethodName();</span><br><span class="line"></span><br><span class="line">    // Do we need to mark the bean as skipped by its condition?</span><br><span class="line">    //更具condition判断是否该跳过</span><br><span class="line">    if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        configClass.skippedBeanMethods.add(methodName);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (configClass.skippedBeanMethods.contains(methodName)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //从@Bean中获得配置的names,如果names不为空的话,则第一个为bean的id,否则该方法名字作为bean的id</span><br><span class="line">    AnnotationAttributes bean = AnnotationConfigUtils.attributesFor(metadata, Bean.class);</span><br><span class="line">    Assert.state(bean != null, &quot;No @Bean annotation attributes&quot;);</span><br><span class="line"></span><br><span class="line">    // Consider name and any aliases</span><br><span class="line">    List&lt;String&gt; names = new ArrayList&lt;&gt;(Arrays.asList(bean.getStringArray(&quot;name&quot;)));</span><br><span class="line">    String beanName = (!names.isEmpty() ? names.remove(0) : methodName);</span><br><span class="line"></span><br><span class="line">    // Register aliases even when overridden</span><br><span class="line">    for (String alias : names) &#123;</span><br><span class="line">        this.registry.registerAlias(beanName, alias);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Has this effectively been overridden before (e.g. via XML)?</span><br><span class="line">    //重复定义,直接return</span><br><span class="line">    if (isOverriddenByExistingDefinition(beanMethod, beanName)) &#123;</span><br><span class="line">        if (beanName.equals(beanMethod.getConfigurationClass().getBeanName())) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(beanMethod.getConfigurationClass().getResource().getDescription(),</span><br><span class="line">                    beanName, &quot;Bean name derived from @Bean method &apos;&quot; + beanMethod.getMetadata().getMethodName() +</span><br><span class="line">                    &quot;&apos; clashes with bean name for containing configuration class; please make those names unique!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConfigurationClassBeanDefinition beanDef = new ConfigurationClassBeanDefinition(configClass, metadata);</span><br><span class="line">    beanDef.setResource(configClass.getResource());</span><br><span class="line">    beanDef.setSource(this.sourceExtractor.extractSource(metadata, configClass.getResource()));</span><br><span class="line">    //该方法是静态的,则将methodName设置为工厂方法</span><br><span class="line">    if (metadata.isStatic()) &#123;</span><br><span class="line">        // static @Bean method</span><br><span class="line">        beanDef.setBeanClassName(configClass.getMetadata().getClassName());</span><br><span class="line">        beanDef.setFactoryMethodName(methodName);</span><br><span class="line">    &#125;</span><br><span class="line">    //实例方法,则将configClass的BeanName设置为FactoryBeanName,methodName设置为UniqueFactoryMethodName</span><br><span class="line">    else &#123;</span><br><span class="line">        // instance @Bean method</span><br><span class="line">        beanDef.setFactoryBeanName(configClass.getBeanName());</span><br><span class="line">        beanDef.setUniqueFactoryMethodName(methodName);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置AutowireMode为构造器注入</span><br><span class="line">    beanDef.setAutowireMode(RootBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line">    //设置skipRequiredCheck属性为true</span><br><span class="line">    beanDef.setAttribute(RequiredAnnotationBeanPostProcessor.SKIP_REQUIRED_CHECK_ATTRIBUTE, Boolean.TRUE);</span><br><span class="line">    //设置属性</span><br><span class="line">    AnnotationConfigUtils.processCommonDefinitionAnnotations(beanDef, metadata);</span><br><span class="line"></span><br><span class="line">    Autowire autowire = bean.getEnum(&quot;autowire&quot;);</span><br><span class="line">    if (autowire.isAutowire()) &#123;</span><br><span class="line">        beanDef.setAutowireMode(autowire.value());</span><br><span class="line">    &#125;</span><br><span class="line">    //设置InitMethod</span><br><span class="line">    String initMethodName = bean.getString(&quot;initMethod&quot;);</span><br><span class="line">    if (StringUtils.hasText(initMethodName)) &#123;</span><br><span class="line">        beanDef.setInitMethodName(initMethodName);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置DestroyMethod</span><br><span class="line">    String destroyMethodName = bean.getString(&quot;destroyMethod&quot;);</span><br><span class="line">    beanDef.setDestroyMethodName(destroyMethodName);</span><br><span class="line"></span><br><span class="line">    // Consider scoping</span><br><span class="line">    //设置ScopedProxyMode</span><br><span class="line">    ScopedProxyMode proxyMode = ScopedProxyMode.NO;</span><br><span class="line">    AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(metadata, Scope.class);</span><br><span class="line">    if (attributes != null) &#123;</span><br><span class="line">        beanDef.setScope(attributes.getString(&quot;value&quot;));</span><br><span class="line">        proxyMode = attributes.getEnum(&quot;proxyMode&quot;);</span><br><span class="line">        if (proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">            proxyMode = ScopedProxyMode.NO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Replace the original bean definition with the target one, if necessary</span><br><span class="line">    //ScopedProxyMode不等于NO,则生成代理</span><br><span class="line">    BeanDefinition beanDefToRegister = beanDef;</span><br><span class="line">    if (proxyMode != ScopedProxyMode.NO) &#123;</span><br><span class="line">        BeanDefinitionHolder proxyDef = ScopedProxyCreator.createScopedProxy(</span><br><span class="line">                new BeanDefinitionHolder(beanDef, beanName), this.registry,</span><br><span class="line">                proxyMode == ScopedProxyMode.TARGET_CLASS);</span><br><span class="line">        beanDefToRegister = new ConfigurationClassBeanDefinition(</span><br><span class="line">                (RootBeanDefinition) proxyDef.getBeanDefinition(), configClass, metadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(String.format(&quot;Registering bean definition for @Bean method %s.%s()&quot;,</span><br><span class="line">                configClass.getMetadata().getClassName(), beanName));</span><br><span class="line">    &#125;</span><br><span class="line">    //进行注册</span><br><span class="line">    this.registry.registerBeanDefinition(beanName, beanDefToRegister);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法"><a href="#18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法" class="headerlink" title="18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法"></a>18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsFromImportedResources(</span><br><span class="line">        Map&lt;String, Class&lt;? extends BeanDefinitionReader&gt;&gt; importedResources) &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Class&lt;?&gt;, BeanDefinitionReader&gt; readerInstanceCache = new HashMap&lt;&gt;();</span><br><span class="line">    //遍历importedResources</span><br><span class="line">    importedResources.forEach((resource, readerClass) -&gt; &#123;</span><br><span class="line">        // Default reader selection necessary?</span><br><span class="line">        //选择BeanDefinitionReader</span><br><span class="line">        if (BeanDefinitionReader.class == readerClass) &#123;</span><br><span class="line">            //如果是.groovy,则使用GroovyBeanDefinitionReader</span><br><span class="line">            if (StringUtils.endsWithIgnoreCase(resource, &quot;.groovy&quot;)) &#123;</span><br><span class="line">                // When clearly asking for Groovy, that&apos;s what they&apos;ll get...</span><br><span class="line">                readerClass = GroovyBeanDefinitionReader.class;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // Primarily &quot;.xml&quot; files but for any other extension as well</span><br><span class="line">                //否则为XmlBeanDefinitionReader,一般都是XmlBeanDefinitionReader</span><br><span class="line">                readerClass = XmlBeanDefinitionReader.class;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //从缓存里获取</span><br><span class="line">        BeanDefinitionReader reader = readerInstanceCache.get(readerClass);</span><br><span class="line">        //实例化一个reader</span><br><span class="line">        if (reader == null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // Instantiate the specified BeanDefinitionReader</span><br><span class="line">                reader = readerClass.getConstructor(BeanDefinitionRegistry.class).newInstance(this.registry);</span><br><span class="line">                // Delegate the current ResourceLoader to it if possible</span><br><span class="line">                if (reader instanceof AbstractBeanDefinitionReader) &#123;</span><br><span class="line">                    AbstractBeanDefinitionReader abdr = ((AbstractBeanDefinitionReader) reader);</span><br><span class="line">                    abdr.setResourceLoader(this.resourceLoader);</span><br><span class="line">                    abdr.setEnvironment(this.environment);</span><br><span class="line">                &#125;</span><br><span class="line">                readerInstanceCache.put(readerClass, reader);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Could not instantiate BeanDefinitionReader class [&quot; + readerClass.getName() + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // TODO SPR-6310: qualify relative path locations as done in AbstractContextLoader.modifyLocations</span><br><span class="line">        //读取配置文件，与前文XmlBeanFactory中一样</span><br><span class="line">        reader.loadBeanDefinitions(resource);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法"><a href="#19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法" class="headerlink" title="19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法"></a>19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsFromRegistrars(Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; registrars) &#123;</span><br><span class="line">    //将被注解的配置类的相关信息，注册到@Import的ImportBeanDefinitionRegistrar中</span><br><span class="line">    registrars.forEach((registrar, metadata) -&gt;</span><br><span class="line">            registrar.registerBeanDefinitions(metadata, this.registry));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里配置类解析就结束了，获取bean在前文AnnotationConfigApplicationContext中</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
      <category term="spring" scheme="http://yoursite.com/categories/spring/"/>
    
    
  </entry>
  
  <entry>
    <title>JUC集合(3)</title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E9%9B%86%E5%90%88(3)/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC集合(3)/</id>
    <published>2018-05-06T13:48:30.190Z</published>
    <updated>2018-06-28T14:03:18.245Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、CopyOnWriteArrayList"><a href="#一、CopyOnWriteArrayList" class="headerlink" title="一、CopyOnWriteArrayList"></a>一、CopyOnWriteArrayList</h3><h4 id="1、实例化CopyOnWriteArrayList"><a href="#1、实例化CopyOnWriteArrayList" class="headerlink" title="1、实例化CopyOnWriteArrayList"></a>1、实例化CopyOnWriteArrayList</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public CopyOnWriteArrayList() &#123;</span><br><span class="line">    setArray(new Object[0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">final void setArray(Object[] a) &#123;</span><br><span class="line">    array = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//存放该list数据的数组，volatile修饰数组，代表该数组地址的可见性，</span><br><span class="line">//也即一个线程给该数组从新赋值，另一个线程能立即看到，但是数组内部成员改变不具有该性质。</span><br><span class="line">private transient volatile Object[] array;</span><br><span class="line">//该对象内部保证线程安全的独占锁</span><br><span class="line">final transient ReentrantLock lock = new ReentrantLock();</span><br></pre></td></tr></table></figure><h4 id="2、CopyOnWriteArrayList的add方法"><a href="#2、CopyOnWriteArrayList的add方法" class="headerlink" title="2、CopyOnWriteArrayList的add方法"></a>2、CopyOnWriteArrayList的add方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    //获取锁</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取数组</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        int len = elements.length;</span><br><span class="line">        //新数组</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + 1);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        //更新数组</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        return true;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、CopyOnWriteArrayList的get方法"><a href="#3、CopyOnWriteArrayList的get方法" class="headerlink" title="3、CopyOnWriteArrayList的get方法"></a>3、CopyOnWriteArrayList的get方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public E get(int index) &#123;</span><br><span class="line">    return get(getArray(), index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">private E get(Object[] a, int index) &#123;</span><br><span class="line">    return (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、CopyOnWriteArrayList的remove方法"><a href="#4、CopyOnWriteArrayList的remove方法" class="headerlink" title="4、CopyOnWriteArrayList的remove方法"></a>4、CopyOnWriteArrayList的remove方法</h4><p>删除元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public E remove(int index) &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    //获取锁</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取数组</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        int len = elements.length;</span><br><span class="line">        //获取被删除的元素</span><br><span class="line">        E oldValue = get(elements, index);</span><br><span class="line">        int numMoved = len - index - 1;</span><br><span class="line">        //复制一个新数组，更新到CopyOnWriteArrayList对象中</span><br><span class="line">        if (numMoved == 0)</span><br><span class="line">            setArray(Arrays.copyOf(elements, len - 1));</span><br><span class="line">        else &#123;</span><br><span class="line">            Object[] newElements = new Object[len - 1];</span><br><span class="line">            System.arraycopy(elements, 0, newElements, 0, index);</span><br><span class="line">            System.arraycopy(elements, index + 1, newElements, index,</span><br><span class="line">                             numMoved);</span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125;</span><br><span class="line">        return oldValue;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、CopyOnWriteArrayList的iterator方法"><a href="#5、CopyOnWriteArrayList的iterator方法" class="headerlink" title="5、CopyOnWriteArrayList的iterator方法"></a>5、CopyOnWriteArrayList的iterator方法</h4><p>迭代器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Iterator&lt;E&gt; iterator() &#123;</span><br><span class="line">    return new COWIterator&lt;E&gt;(getArray(), 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、实例化COWIterator"><a href="#6、实例化COWIterator" class="headerlink" title="6、实例化COWIterator"></a>6、实例化COWIterator</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private COWIterator(Object[] elements, int initialCursor) &#123;</span><br><span class="line">    cursor = initialCursor;</span><br><span class="line">    //集合的数组</span><br><span class="line">    snapshot = elements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、COWIterator的next方法"><a href="#7、COWIterator的next方法" class="headerlink" title="7、COWIterator的next方法"></a>7、COWIterator的next方法</h4><p>获取下一个元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public E next() &#123;</span><br><span class="line">    //查看有没有下一个元素</span><br><span class="line">    if (! hasNext())</span><br><span class="line">        throw new NoSuchElementException();</span><br><span class="line">    //返回下一个元素</span><br><span class="line">    return (E) snapshot[cursor++];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、COWIterator的hasNext方法"><a href="#8、COWIterator的hasNext方法" class="headerlink" title="8、COWIterator的hasNext方法"></a>8、COWIterator的hasNext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasNext() &#123;</span><br><span class="line">    return cursor &lt; snapshot.length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、CopyOnWriteArraySet"><a href="#二、CopyOnWriteArraySet" class="headerlink" title="二、CopyOnWriteArraySet"></a>二、CopyOnWriteArraySet</h3><h4 id="1、实例化CopyOnWriteArraySet"><a href="#1、实例化CopyOnWriteArraySet" class="headerlink" title="1、实例化CopyOnWriteArraySet"></a>1、实例化CopyOnWriteArraySet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public CopyOnWriteArraySet() &#123;</span><br><span class="line">    al = new CopyOnWriteArrayList&lt;E&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、CopyOnWriteArraySet的add方法"><a href="#2、CopyOnWriteArraySet的add方法" class="headerlink" title="2、CopyOnWriteArraySet的add方法"></a>2、CopyOnWriteArraySet的add方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    return al.addIfAbsent(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、CopyOnWriteArrayList的addIfAbsent方法"><a href="#3、CopyOnWriteArrayList的addIfAbsent方法" class="headerlink" title="3、CopyOnWriteArrayList的addIfAbsent方法"></a>3、CopyOnWriteArrayList的addIfAbsent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public boolean addIfAbsent(E e) &#123;</span><br><span class="line">    Object[] snapshot = getArray();</span><br><span class="line">    return indexOf(e, snapshot, 0, snapshot.length) &gt;= 0 ? false :</span><br><span class="line">        addIfAbsent(e, snapshot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private boolean addIfAbsent(E e, Object[] snapshot) &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    //获取锁</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        Object[] current = getArray();</span><br><span class="line">        int len = current.length;</span><br><span class="line">        //不相等，则说明数字已被更改</span><br><span class="line">        if (snapshot != current) &#123;</span><br><span class="line">            int common = Math.min(snapshot.length, len);</span><br><span class="line">            //current中查找e,找到则返回false</span><br><span class="line">            for (int i = 0; i &lt; common; i++)</span><br><span class="line">                if (current[i] != snapshot[i] &amp;&amp; eq(e, current[i]))</span><br><span class="line">                    return false;</span><br><span class="line">            if (indexOf(e, current, common, len) &gt;= 0)</span><br><span class="line">                    return false;</span><br><span class="line">        &#125;</span><br><span class="line">        Object[] newElements = Arrays.copyOf(current, len + 1);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        return true;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、CopyOnWriteArrayList的indexOf方法"><a href="#4、CopyOnWriteArrayList的indexOf方法" class="headerlink" title="4、CopyOnWriteArrayList的indexOf方法"></a>4、CopyOnWriteArrayList的indexOf方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private static int indexOf(Object o, Object[] elements,</span><br><span class="line">                           int index, int fence) &#123;</span><br><span class="line">    //在数组index到fence中查找o，有则返回下标，不存在则返回-1</span><br><span class="line">    if (o == null) &#123;</span><br><span class="line">        for (int i = index; i &lt; fence; i++)</span><br><span class="line">            if (elements[i] == null)</span><br><span class="line">                return i;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        for (int i = index; i &lt; fence; i++)</span><br><span class="line">            if (o.equals(elements[i]))</span><br><span class="line">                return i;</span><br><span class="line">    &#125;</span><br><span class="line">    return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>remove、iterator等方法，均是调用了CopyOnWriteArrayList的同名方法。</p><h3 id="三、ArrayBlockingQueue"><a href="#三、ArrayBlockingQueue" class="headerlink" title="三、ArrayBlockingQueue"></a>三、ArrayBlockingQueue</h3><h4 id="1、实例化ArrayBlockingQueue"><a href="#1、实例化ArrayBlockingQueue" class="headerlink" title="1、实例化ArrayBlockingQueue"></a>1、实例化ArrayBlockingQueue</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ArrayBlockingQueue(int capacity) &#123;</span><br><span class="line">    this(capacity, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public ArrayBlockingQueue(int capacity, boolean fair) &#123;</span><br><span class="line">    if (capacity &lt;= 0)</span><br><span class="line">        throw new IllegalArgumentException();</span><br><span class="line">    //存放元素的数组</span><br><span class="line">    this.items = new Object[capacity];</span><br><span class="line">    //独占锁</span><br><span class="line">    lock = new ReentrantLock(fair);</span><br><span class="line">    notEmpty = lock.newCondition();</span><br><span class="line">    notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ArrayBlockingQueue的offer方法"><a href="#2、ArrayBlockingQueue的offer方法" class="headerlink" title="2、ArrayBlockingQueue的offer方法"></a>2、ArrayBlockingQueue的offer方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public boolean offer(E e) &#123;</span><br><span class="line">    // 创建插入的元素是否为null，是的话抛出NullPointerException异常</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    //获取锁</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (count == items.length)</span><br><span class="line">        // 如果队列已满，则返回false。</span><br><span class="line">            return false;</span><br><span class="line">        else &#123;</span><br><span class="line">        // 如果队列未满，则插入e，并返回true。</span><br><span class="line">            enqueue(e);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放锁</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、ArrayBlockingQueue的enqueue方法"><a href="#3、ArrayBlockingQueue的enqueue方法" class="headerlink" title="3、ArrayBlockingQueue的enqueue方法"></a>3、ArrayBlockingQueue的enqueue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void enqueue(E x) &#123;</span><br><span class="line">    final Object[] items = this.items;</span><br><span class="line">    items[putIndex] = x;</span><br><span class="line">    //循环数组</span><br><span class="line">    if (++putIndex == items.length)</span><br><span class="line">        putIndex = 0;</span><br><span class="line">    count++;</span><br><span class="line">    //唤醒等待线程</span><br><span class="line">    notEmpty.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ArrayBlockingQueue的take方法"><a href="#4、ArrayBlockingQueue的take方法" class="headerlink" title="4、ArrayBlockingQueue的take方法"></a>4、ArrayBlockingQueue的take方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public E take() throws InterruptedException &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    //获取锁</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    try &#123;</span><br><span class="line">        //队列为空，则等待</span><br><span class="line">        while (count == 0)</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        //取出下一个元素</span><br><span class="line">        return dequeue();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、ArrayBlockingQueue的dequeue方法"><a href="#5、ArrayBlockingQueue的dequeue方法" class="headerlink" title="5、ArrayBlockingQueue的dequeue方法"></a>5、ArrayBlockingQueue的dequeue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private E dequeue() &#123;</span><br><span class="line">    final Object[] items = this.items;</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    E x = (E) items[takeIndex];</span><br><span class="line">    items[takeIndex] = null;</span><br><span class="line">    //循环数组</span><br><span class="line">    if (++takeIndex == items.length)</span><br><span class="line">        takeIndex = 0;</span><br><span class="line">    count--;</span><br><span class="line">    if (itrs != null)</span><br><span class="line">        //处理迭代器</span><br><span class="line">        itrs.elementDequeued();</span><br><span class="line">    //唤醒等待线程</span><br><span class="line">    notFull.signal();</span><br><span class="line">    return x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、Itrs的elementDequeued方法"><a href="#6、Itrs的elementDequeued方法" class="headerlink" title="6、Itrs的elementDequeued方法"></a>6、Itrs的elementDequeued方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void elementDequeued() &#123;</span><br><span class="line">    // assert lock.getHoldCount() == 1;</span><br><span class="line">    if (count == 0)</span><br><span class="line">        //队列为空，清空迭代器</span><br><span class="line">        queueIsEmpty();</span><br><span class="line">    else if (takeIndex == 0)</span><br><span class="line">        //循环数组，循环轮次加一，清除过期迭代器</span><br><span class="line">        takeIndexWrapped();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、Itrs的queueIsEmpty方法"><a href="#7、Itrs的queueIsEmpty方法" class="headerlink" title="7、Itrs的queueIsEmpty方法"></a>7、Itrs的queueIsEmpty方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void queueIsEmpty() &#123;</span><br><span class="line">    //清除迭代器队列,逐个关闭迭代器</span><br><span class="line">    for (Node p = head; p != null; p = p.next) &#123;</span><br><span class="line">        Itr it = p.get();</span><br><span class="line">        if (it != null) &#123;</span><br><span class="line">            p.clear();</span><br><span class="line">            it.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    head = null;</span><br><span class="line">    itrs = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、接（三、6）Itrs的takeIndexWrapped方法"><a href="#8、接（三、6）Itrs的takeIndexWrapped方法" class="headerlink" title="8、接（三、6）Itrs的takeIndexWrapped方法"></a>8、接（三、6）Itrs的takeIndexWrapped方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void takeIndexWrapped() &#123;</span><br><span class="line">    //循环轮次加一</span><br><span class="line">    cycles++;</span><br><span class="line">    //清除过期迭代器</span><br><span class="line">    for (Node o = null, p = head; p != null;) &#123;</span><br><span class="line">        final Itr it = p.get();</span><br><span class="line">        final Node next = p.next;</span><br><span class="line">        if (it == null || it.takeIndexWrapped()) &#123;</span><br><span class="line">        //迭代器已过期，清除节点</span><br><span class="line">            //清除过期迭代器</span><br><span class="line">            p.clear();</span><br><span class="line">            p.next = null;</span><br><span class="line">            if (o == null)</span><br><span class="line">                head = next;</span><br><span class="line">            else</span><br><span class="line">                o.next = next;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            o = p;</span><br><span class="line">        &#125;</span><br><span class="line">        p = next;</span><br><span class="line">    &#125;</span><br><span class="line">    if (head == null)   // no more iterators to track</span><br><span class="line">        itrs = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、Itrs的takeIndexWrapped方法"><a href="#9、Itrs的takeIndexWrapped方法" class="headerlink" title="9、Itrs的takeIndexWrapped方法"></a>9、Itrs的takeIndexWrapped方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">boolean takeIndexWrapped() &#123;</span><br><span class="line">    //迭代器已使用完</span><br><span class="line">    if (isDetached())</span><br><span class="line">        return true;</span><br><span class="line">    //过期</span><br><span class="line">    if (itrs.cycles - prevCycles &gt; 1) &#123;</span><br><span class="line">        //废弃该迭代器</span><br><span class="line">        shutdown();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、Itrs的shutdown方法"><a href="#10、Itrs的shutdown方法" class="headerlink" title="10、Itrs的shutdown方法"></a>10、Itrs的shutdown方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void shutdown() &#123;</span><br><span class="line">    cursor = NONE;</span><br><span class="line">    if (nextIndex &gt;= 0)</span><br><span class="line">        nextIndex = REMOVED;</span><br><span class="line">    if (lastRet &gt;= 0) &#123;</span><br><span class="line">        lastRet = REMOVED;</span><br><span class="line">        lastItem = null;</span><br><span class="line">    &#125;</span><br><span class="line">    prevTakeIndex = DETACHED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ArrayBlockingQueue的remove方法"><a href="#11、ArrayBlockingQueue的remove方法" class="headerlink" title="11、ArrayBlockingQueue的remove方法"></a>11、ArrayBlockingQueue的remove方法</h4><p>删除元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    if (o == null) return false;</span><br><span class="line">    final Object[] items = this.items;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (count &gt; 0) &#123;</span><br><span class="line">            final int putIndex = this.putIndex;</span><br><span class="line">            int i = takeIndex;</span><br><span class="line">            //takeIndex到putIndex之间为队列现有元素</span><br><span class="line">            do &#123;</span><br><span class="line">                if (o.equals(items[i])) &#123;</span><br><span class="line">                    removeAt(i);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">                if (++i == items.length)</span><br><span class="line">                    i = 0;</span><br><span class="line">            &#125; while (i != putIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="12、ArrayBlockingQueue的removeAt方法"><a href="#12、ArrayBlockingQueue的removeAt方法" class="headerlink" title="12、ArrayBlockingQueue的removeAt方法"></a>12、ArrayBlockingQueue的removeAt方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">void removeAt(final int removeIndex) &#123;</span><br><span class="line">    //删除元素，后面的元素迁移</span><br><span class="line">    final Object[] items = this.items;</span><br><span class="line">    if (removeIndex == takeIndex) &#123;</span><br><span class="line">        // removing front item; just advance</span><br><span class="line">        items[takeIndex] = null;</span><br><span class="line">        if (++takeIndex == items.length)</span><br><span class="line">            takeIndex = 0;</span><br><span class="line">        count--;</span><br><span class="line">        if (itrs != null)</span><br><span class="line">            itrs.elementDequeued();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final int putIndex = this.putIndex;</span><br><span class="line">        for (int i = removeIndex;;) &#123;</span><br><span class="line">            int next = i + 1;</span><br><span class="line">            if (next == items.length)</span><br><span class="line">                next = 0;</span><br><span class="line">            if (next != putIndex) &#123;</span><br><span class="line">                items[i] = items[next];</span><br><span class="line">                i = next;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                items[i] = null;</span><br><span class="line">                this.putIndex = i;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        count--;</span><br><span class="line">        //跟新迭代器</span><br><span class="line">        if (itrs != null)</span><br><span class="line">            itrs.removedAt(removeIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    notFull.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、Itrs的removeAt方法"><a href="#13、Itrs的removeAt方法" class="headerlink" title="13、Itrs的removeAt方法"></a>13、Itrs的removeAt方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">void removedAt(int removedIndex) &#123;</span><br><span class="line">    for (Node o = null, p = head; p != null;) &#123;</span><br><span class="line">        final Itr it = p.get();</span><br><span class="line">        final Node next = p.next;</span><br><span class="line">        if (it == null || it.removedAt(removedIndex)) &#123;</span><br><span class="line">            //清除过期的迭代器</span><br><span class="line">            p.clear();</span><br><span class="line">            p.next = null;</span><br><span class="line">            if (o == null)</span><br><span class="line">                head = next;</span><br><span class="line">            else</span><br><span class="line">                o.next = next;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            o = p;</span><br><span class="line">        &#125;</span><br><span class="line">        p = next;</span><br><span class="line">    &#125;</span><br><span class="line">    if (head == null)   // no more iterators to track</span><br><span class="line">        itrs = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、Itr的removeAt方法"><a href="#14、Itr的removeAt方法" class="headerlink" title="14、Itr的removeAt方法"></a>14、Itr的removeAt方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">boolean removedAt(int removedIndex) &#123;</span><br><span class="line">    // assert lock.getHoldCount() == 1;</span><br><span class="line">    if (isDetached())</span><br><span class="line">        return true;</span><br><span class="line"></span><br><span class="line">    final int cycles = itrs.cycles;</span><br><span class="line">    final int takeIndex = ArrayBlockingQueue.this.takeIndex;</span><br><span class="line">    final int prevCycles = this.prevCycles;</span><br><span class="line">    final int prevTakeIndex = this.prevTakeIndex;</span><br><span class="line">    final int len = items.length;</span><br><span class="line">    int cycleDiff = cycles - prevCycles;</span><br><span class="line">    if (removedIndex &lt; takeIndex)</span><br><span class="line">        cycleDiff++;</span><br><span class="line">    //删除的元素到上个take元素的距离</span><br><span class="line">    final int removedDistance =</span><br><span class="line">        (cycleDiff * len) + (removedIndex - prevTakeIndex);</span><br><span class="line">    // assert removedDistance &gt;= 0;</span><br><span class="line">    int cursor = this.cursor;</span><br><span class="line">    //更新游标</span><br><span class="line">    if (cursor &gt;= 0) &#123;</span><br><span class="line">        int x = distance(cursor, prevTakeIndex, len);</span><br><span class="line">        if (x == removedDistance) &#123;</span><br><span class="line">        //删除的是cursor上的元素</span><br><span class="line">            if (cursor == putIndex)</span><br><span class="line">                this.cursor = cursor = NONE;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (x &gt; removedDistance) &#123;</span><br><span class="line">        //删除的元素在cursor之前,cursor前移一位</span><br><span class="line">            this.cursor = cursor = dec(cursor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    int lastRet = this.lastRet;</span><br><span class="line">    //更新最近获取元素下标</span><br><span class="line">    if (lastRet &gt;= 0) &#123;</span><br><span class="line">        int x = distance(lastRet, prevTakeIndex, len);</span><br><span class="line">        //删除的正好是</span><br><span class="line">        if (x == removedDistance)</span><br><span class="line">            this.lastRet = lastRet = REMOVED;</span><br><span class="line">        else if (x &gt; removedDistance)</span><br><span class="line">            this.lastRet = lastRet = dec(lastRet);</span><br><span class="line">    &#125;</span><br><span class="line">    int nextIndex = this.nextIndex;</span><br><span class="line">    //更新下一个元素下标</span><br><span class="line">    if (nextIndex &gt;= 0) &#123;</span><br><span class="line">        int x = distance(nextIndex, prevTakeIndex, len);</span><br><span class="line">        if (x == removedDistance)</span><br><span class="line">            this.nextIndex = nextIndex = REMOVED;</span><br><span class="line">        else if (x &gt; removedDistance)</span><br><span class="line">            this.nextIndex = nextIndex = dec(nextIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (cursor &lt; 0 &amp;&amp; nextIndex &lt; 0 &amp;&amp; lastRet &lt; 0) &#123;</span><br><span class="line">    //迭代器，已被关闭</span><br><span class="line">        this.prevTakeIndex = DETACHED;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、ArrayBlockingQueue的removeAt方法"><a href="#15、ArrayBlockingQueue的removeAt方法" class="headerlink" title="15、ArrayBlockingQueue的removeAt方法"></a>15、ArrayBlockingQueue的removeAt方法</h4><p>获取迭代器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Iterator&lt;E&gt; iterator() &#123;</span><br><span class="line">    return new Itr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="16、实例化Itr"><a href="#16、实例化Itr" class="headerlink" title="16、实例化Itr"></a>16、实例化Itr</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Itr() &#123;</span><br><span class="line">    lastRet = NONE;</span><br><span class="line">    final ReentrantLock lock = ArrayBlockingQueue.this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (count == 0) &#123;</span><br><span class="line">            // assert itrs == null;</span><br><span class="line">            cursor = NONE;</span><br><span class="line">            nextIndex = NONE;</span><br><span class="line">            prevTakeIndex = DETACHED;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            final int takeIndex = ArrayBlockingQueue.this.takeIndex;</span><br><span class="line">            prevTakeIndex = takeIndex;</span><br><span class="line">            nextItem = itemAt(nextIndex = takeIndex);</span><br><span class="line">            //游标，下标后移一位,该位置元素不存在则返回-1</span><br><span class="line">            cursor = incCursor(takeIndex);</span><br><span class="line">            if (itrs == null) &#123;</span><br><span class="line">                //创建迭代器容器，并创建迭代器</span><br><span class="line">                itrs = new Itrs(this);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //将迭代器，加入队列</span><br><span class="line">                itrs.register(this); // in this order</span><br><span class="line">                //清除过期迭代器</span><br><span class="line">                itrs.doSomeSweeping(false);</span><br><span class="line">            &#125;</span><br><span class="line">            //循环数组轮次</span><br><span class="line">            prevCycles = itrs.cycles;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、实例化Itrs"><a href="#17、实例化Itrs" class="headerlink" title="17、实例化Itrs"></a>17、实例化Itrs</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Itrs(Itr initial) &#123;</span><br><span class="line">    register(initial);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、Itrs的register方法"><a href="#18、Itrs的register方法" class="headerlink" title="18、Itrs的register方法"></a>18、Itrs的register方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void register(Itr itr) &#123;</span><br><span class="line">    //新节点放在队首 </span><br><span class="line">    head = new Node(itr, head);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、接（三、16）Itrs的doSomeSweeping方法"><a href="#19、接（三、16）Itrs的doSomeSweeping方法" class="headerlink" title="19、接（三、16）Itrs的doSomeSweeping方法"></a>19、接（三、16）Itrs的doSomeSweeping方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">void doSomeSweeping(boolean tryHarder) &#123;</span><br><span class="line">    //迭代次数</span><br><span class="line">    int probes = tryHarder ? LONG_SWEEP_PROBES : SHORT_SWEEP_PROBES;</span><br><span class="line">    Node o, p;</span><br><span class="line">    final Node sweeper = this.sweeper;</span><br><span class="line">    boolean passedGo;   // to limit search to one full sweep</span><br><span class="line">    //sweeper不存在从头开始，存在从sweeper开始</span><br><span class="line">    if (sweeper == null) &#123;</span><br><span class="line">        o = null;</span><br><span class="line">        p = head;</span><br><span class="line">        passedGo = true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        o = sweeper;</span><br><span class="line">        p = o.next;</span><br><span class="line">        passedGo = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (; probes &gt; 0; probes--) &#123;</span><br><span class="line">        //sweeper后一个不存在，从头开始</span><br><span class="line">        if (p == null) &#123;</span><br><span class="line">            if (passedGo)</span><br><span class="line">                break;</span><br><span class="line">            o = null;</span><br><span class="line">            p = head;</span><br><span class="line">            passedGo = true;</span><br><span class="line">        &#125;</span><br><span class="line">        final Itr it = p.get();</span><br><span class="line">        final Node next = p.next;</span><br><span class="line">        if (it == null || it.isDetached()) &#123;</span><br><span class="line">            //发现一个过期迭代器，继续往后排查16个</span><br><span class="line">            probes = LONG_SWEEP_PROBES; // &quot;try harder&quot;</span><br><span class="line">            //清除过期迭代器</span><br><span class="line">            p.clear();</span><br><span class="line">            p.next = null;</span><br><span class="line">            if (o == null) &#123;</span><br><span class="line">                head = next;</span><br><span class="line">                if (next == null) &#123;</span><br><span class="line">                    // We&apos;ve run out of iterators to track; retire</span><br><span class="line">                    itrs = null;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">                o.next = next;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            o = p;</span><br><span class="line">        &#125;</span><br><span class="line">        p = next;</span><br><span class="line">    &#125;</span><br><span class="line">    //本次排查到的位置</span><br><span class="line">    this.sweeper = (p == null) ? null : o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、Itr的hasNext方法"><a href="#20、Itr的hasNext方法" class="headerlink" title="20、Itr的hasNext方法"></a>20、Itr的hasNext方法</h4><p>查看是否有下一个元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasNext() &#123;</span><br><span class="line">    // assert lock.getHoldCount() == 0;</span><br><span class="line">    if (nextItem != null)</span><br><span class="line">        return true;</span><br><span class="line">    //废弃迭代器</span><br><span class="line">    noNext();</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="21、Itr的noNext方法"><a href="#21、Itr的noNext方法" class="headerlink" title="21、Itr的noNext方法"></a>21、Itr的noNext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void noNext() &#123;</span><br><span class="line">    final ReentrantLock lock = ArrayBlockingQueue.this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //迭代器有效</span><br><span class="line">        if (!isDetached()) &#123;</span><br><span class="line">            //更新迭代器</span><br><span class="line">            incorporateDequeues(); // might update lastRet</span><br><span class="line">            if (lastRet &gt;= 0) &#123;</span><br><span class="line">                lastItem = itemAt(lastRet);</span><br><span class="line">                //废弃该迭代器</span><br><span class="line">                detach();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、Itr的next方法"><a href="#22、Itr的next方法" class="headerlink" title="22、Itr的next方法"></a>22、Itr的next方法</h4><p>获取下一个元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public E next() &#123;</span><br><span class="line">    final E x = nextItem;</span><br><span class="line">    if (x == null)</span><br><span class="line">        throw new NoSuchElementException();</span><br><span class="line">    final ReentrantLock lock = ArrayBlockingQueue.this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (!isDetached())</span><br><span class="line">            //更新迭代器</span><br><span class="line">            incorporateDequeues();</span><br><span class="line">        lastRet = nextIndex;</span><br><span class="line">        final int cursor = this.cursor;</span><br><span class="line">        if (cursor &gt;= 0) &#123;</span><br><span class="line">            //下一个元素</span><br><span class="line">            nextItem = itemAt(nextIndex = cursor);</span><br><span class="line">            //游标后移</span><br><span class="line">            this.cursor = incCursor(cursor);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //下一个元素不存在</span><br><span class="line">            nextIndex = NONE;</span><br><span class="line">            nextItem = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    return x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="23、Itr的incorporateDequeues方法"><a href="#23、Itr的incorporateDequeues方法" class="headerlink" title="23、Itr的incorporateDequeues方法"></a>23、Itr的incorporateDequeues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private void incorporateDequeues() &#123;</span><br><span class="line"></span><br><span class="line">    final int cycles = itrs.cycles;</span><br><span class="line">    final int takeIndex = ArrayBlockingQueue.this.takeIndex;</span><br><span class="line">    final int prevCycles = this.prevCycles;</span><br><span class="line">    final int prevTakeIndex = this.prevTakeIndex;</span><br><span class="line"></span><br><span class="line">    if (cycles != prevCycles || takeIndex != prevTakeIndex) &#123;</span><br><span class="line">        final int len = items.length;</span><br><span class="line">       </span><br><span class="line">        long dequeues = (cycles - prevCycles) * len</span><br><span class="line">            + (takeIndex - prevTakeIndex);</span><br><span class="line"></span><br><span class="line">        //新的takeIndex在lastRet之后</span><br><span class="line">        if (invalidated(lastRet, prevTakeIndex, dequeues, len))</span><br><span class="line">            lastRet = REMOVED;</span><br><span class="line">        //新的takeIndex在nextIndex之后</span><br><span class="line">        if (invalidated(nextIndex, prevTakeIndex, dequeues, len))</span><br><span class="line">            nextIndex = REMOVED;</span><br><span class="line">        //新的takeIndex在cursor之后</span><br><span class="line">        if (invalidated(cursor, prevTakeIndex, dequeues, len))</span><br><span class="line">            cursor = takeIndex;</span><br><span class="line">        if (cursor &lt; 0 &amp;&amp; nextIndex &lt; 0 &amp;&amp; lastRet &lt; 0)</span><br><span class="line">            //废弃迭代器</span><br><span class="line">            detach();</span><br><span class="line">        else &#123;</span><br><span class="line">            this.prevCycles = cycles;</span><br><span class="line">            this.prevTakeIndex = takeIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、LinkedBlockingQueue"><a href="#四、LinkedBlockingQueue" class="headerlink" title="四、LinkedBlockingQueue"></a>四、LinkedBlockingQueue</h3><h4 id="1、实例化LinkedBlockingQueue"><a href="#1、实例化LinkedBlockingQueue" class="headerlink" title="1、实例化LinkedBlockingQueue"></a>1、实例化LinkedBlockingQueue</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public LinkedBlockingQueue() &#123;</span><br><span class="line">    this(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public LinkedBlockingQueue(int capacity) &#123;</span><br><span class="line">    if (capacity &lt;= 0) throw new IllegalArgumentException();</span><br><span class="line">    this.capacity = capacity;</span><br><span class="line">    last = head = new Node&lt;E&gt;(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、LinkedBlockingQueue的offer方法"><a href="#2、LinkedBlockingQueue的offer方法" class="headerlink" title="2、LinkedBlockingQueue的offer方法"></a>2、LinkedBlockingQueue的offer方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public boolean offer(E e) &#123;</span><br><span class="line">    if (e == null) throw new NullPointerException();</span><br><span class="line">    final AtomicInteger count = this.count;</span><br><span class="line">    //达到最大限制</span><br><span class="line">    if (count.get() == capacity)</span><br><span class="line">        return false;</span><br><span class="line">    int c = -1;</span><br><span class="line">    //创建新节点</span><br><span class="line">    Node&lt;E&gt; node = new Node&lt;E&gt;(e);</span><br><span class="line">    final ReentrantLock putLock = this.putLock;</span><br><span class="line">    //获取写锁</span><br><span class="line">    putLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (count.get() &lt; capacity) &#123;</span><br><span class="line">            //新增节点加入队尾</span><br><span class="line">            enqueue(node);</span><br><span class="line">            //元素数量加一</span><br><span class="line">            c = count.getAndIncrement();</span><br><span class="line">            if (c + 1 &lt; capacity)</span><br><span class="line">                //唤醒等待的写线程</span><br><span class="line">                notFull.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    if (c == 0)</span><br><span class="line">        //唤醒等待获取的线程</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">    return c &gt;= 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、LinkedBlockingQueue的take方法"><a href="#3、LinkedBlockingQueue的take方法" class="headerlink" title="3、LinkedBlockingQueue的take方法"></a>3、LinkedBlockingQueue的take方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public E take() throws InterruptedException &#123;</span><br><span class="line">    E x;</span><br><span class="line">    int c = -1;</span><br><span class="line">    final AtomicInteger count = this.count;</span><br><span class="line">    final ReentrantLock takeLock = this.takeLock;</span><br><span class="line">    takeLock.lockInterruptibly();</span><br><span class="line">    try &#123;</span><br><span class="line">        while (count.get() == 0) &#123;</span><br><span class="line">            //队列为空，线程等待</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        &#125;</span><br><span class="line">        //从队首获取元素</span><br><span class="line">        x = dequeue();</span><br><span class="line">        c = count.getAndDecrement();</span><br><span class="line">        if (c &gt; 1)</span><br><span class="line">            //唤醒等待获取的线程</span><br><span class="line">            notEmpty.signal();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    if (c == capacity)</span><br><span class="line">        //释放等待添加的线程</span><br><span class="line">        signalNotFull();</span><br><span class="line">    return x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、LinkedBlockingQueue的remove方法"><a href="#4、LinkedBlockingQueue的remove方法" class="headerlink" title="4、LinkedBlockingQueue的remove方法"></a>4、LinkedBlockingQueue的remove方法</h4><p>删除元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    if (o == null) return false;</span><br><span class="line">    //获取锁</span><br><span class="line">    fullyLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        for (Node&lt;E&gt; trail = head, p = trail.next;</span><br><span class="line">             p != null;</span><br><span class="line">             trail = p, p = p.next) &#123;</span><br><span class="line">            if (o.equals(p.item)) &#123;</span><br><span class="line">                //删除该元素</span><br><span class="line">                unlink(p, trail);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        fullyUnlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、LinkedBlockingQueue的iterator方法"><a href="#5、LinkedBlockingQueue的iterator方法" class="headerlink" title="5、LinkedBlockingQueue的iterator方法"></a>5、LinkedBlockingQueue的iterator方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Iterator&lt;E&gt; iterator() &#123;</span><br><span class="line">    return new Itr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、实例化Itr"><a href="#6、实例化Itr" class="headerlink" title="6、实例化Itr"></a>6、实例化Itr</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Itr() &#123;</span><br><span class="line">    fullyLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //初始化当前元素</span><br><span class="line">        current = head.next;</span><br><span class="line">        if (current != null)</span><br><span class="line">            currentElement = current.item;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        fullyUnlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、Itr的hasNext方法"><a href="#7、Itr的hasNext方法" class="headerlink" title="7、Itr的hasNext方法"></a>7、Itr的hasNext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasNext() &#123;</span><br><span class="line">    return current != null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、Itr的next方法"><a href="#8、Itr的next方法" class="headerlink" title="8、Itr的next方法"></a>8、Itr的next方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public E next() &#123;</span><br><span class="line">    fullyLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (current == null)</span><br><span class="line">            throw new NoSuchElementException();</span><br><span class="line">        E x = currentElement;</span><br><span class="line">        //最近获取元素</span><br><span class="line">        lastRet = current;</span><br><span class="line">        //更新current</span><br><span class="line">        current = nextNode(current);</span><br><span class="line">        currentElement = (current == null) ? null : current.item;</span><br><span class="line">        return x;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        fullyUnlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、Itr的nextNode方法"><a href="#9、Itr的nextNode方法" class="headerlink" title="9、Itr的nextNode方法"></a>9、Itr的nextNode方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private Node&lt;E&gt; nextNode(Node&lt;E&gt; p) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        Node&lt;E&gt; s = p.next;</span><br><span class="line">        //p已被取出</span><br><span class="line">        if (s == p)</span><br><span class="line">            return head.next;</span><br><span class="line">        if (s == null || s.item != null)</span><br><span class="line">            return s;</span><br><span class="line">        //s已被删除，向后迭代获取</span><br><span class="line">        p = s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="五、LinkedBlockingDeque"><a href="#五、LinkedBlockingDeque" class="headerlink" title="五、LinkedBlockingDeque"></a>五、LinkedBlockingDeque</h3><h4 id="1、实例化LinkedBlockingDeque"><a href="#1、实例化LinkedBlockingDeque" class="headerlink" title="1、实例化LinkedBlockingDeque"></a>1、实例化LinkedBlockingDeque</h4><p>LinkedBlockingDeque为双向队列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public LinkedBlockingDeque() &#123;</span><br><span class="line">    this(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public LinkedBlockingDeque(int capacity) &#123;</span><br><span class="line">    if (capacity &lt;= 0) throw new IllegalArgumentException();</span><br><span class="line">    this.capacity = capacity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、LinkedBlockingDeque的offer方法"><a href="#2、LinkedBlockingDeque的offer方法" class="headerlink" title="2、LinkedBlockingDeque的offer方法"></a>2、LinkedBlockingDeque的offer方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean offer(E e) &#123;</span><br><span class="line">    return offerLast(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、LinkedBlockingDeque的offerLast方法"><a href="#3、LinkedBlockingDeque的offerLast方法" class="headerlink" title="3、LinkedBlockingDeque的offerLast方法"></a>3、LinkedBlockingDeque的offerLast方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public boolean offerLast(E e) &#123;</span><br><span class="line">    if (e == null) throw new NullPointerException();</span><br><span class="line">    Node&lt;E&gt; node = new Node&lt;E&gt;(e);</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        return linkLast(node);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、LinkedBlockingDeque的linkLast方法"><a href="#4、LinkedBlockingDeque的linkLast方法" class="headerlink" title="4、LinkedBlockingDeque的linkLast方法"></a>4、LinkedBlockingDeque的linkLast方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private boolean linkLast(Node&lt;E&gt; node) &#123;</span><br><span class="line">    //超出数量限制</span><br><span class="line">    if (count &gt;= capacity)</span><br><span class="line">        return false;</span><br><span class="line">    //获取队尾</span><br><span class="line">    Node&lt;E&gt; l = last;</span><br><span class="line">    //添加到队尾</span><br><span class="line">    node.prev = l;</span><br><span class="line">    //更新队尾</span><br><span class="line">    last = node;</span><br><span class="line">    //设置队首</span><br><span class="line">    if (first == null)</span><br><span class="line">        first = node;</span><br><span class="line">    else</span><br><span class="line">        l.next = node;</span><br><span class="line">    ++count;</span><br><span class="line">    //唤醒等待获取的线程</span><br><span class="line">    notEmpty.signal();</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、LinkedBlockingDeque的take方法"><a href="#5、LinkedBlockingDeque的take方法" class="headerlink" title="5、LinkedBlockingDeque的take方法"></a>5、LinkedBlockingDeque的take方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public E take() throws InterruptedException &#123;</span><br><span class="line">    return takeFirst();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、LinkedBlockingDeque的takeFirst方法"><a href="#6、LinkedBlockingDeque的takeFirst方法" class="headerlink" title="6、LinkedBlockingDeque的takeFirst方法"></a>6、LinkedBlockingDeque的takeFirst方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public E takeFirst() throws InterruptedException &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        E x;</span><br><span class="line">        // 若队列为空，则一直等待。否则，通过unlinkFirst()删除第一个节点。</span><br><span class="line">        while ( (x = unlinkFirst()) == null)</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        return x;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、LinkedBlockingDeque的unlinkFirst方法"><a href="#7、LinkedBlockingDeque的unlinkFirst方法" class="headerlink" title="7、LinkedBlockingDeque的unlinkFirst方法"></a>7、LinkedBlockingDeque的unlinkFirst方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private E unlinkFirst() &#123;</span><br><span class="line">    Node&lt;E&gt; f = first;</span><br><span class="line">    if (f == null)</span><br><span class="line">        return null;</span><br><span class="line">    // 删除并更新第一个节点</span><br><span class="line">    Node&lt;E&gt; n = f.next;</span><br><span class="line">    E item = f.item;</span><br><span class="line">    f.item = null;</span><br><span class="line">    f.next = f; // help GC</span><br><span class="line">    first = n;</span><br><span class="line">    if (n == null)</span><br><span class="line">        last = null;</span><br><span class="line">    else</span><br><span class="line">        n.prev = null;</span><br><span class="line">    --count;</span><br><span class="line">    //唤醒等待添加线程</span><br><span class="line">    notFull.signal();</span><br><span class="line">    return item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、LinkedBlockingDeque的iterator方法"><a href="#8、LinkedBlockingDeque的iterator方法" class="headerlink" title="8、LinkedBlockingDeque的iterator方法"></a>8、LinkedBlockingDeque的iterator方法</h4><p>正向迭代器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Iterator&lt;E&gt; iterator() &#123;</span><br><span class="line">    return new Itr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="9、实例化Itr"><a href="#9、实例化Itr" class="headerlink" title="9、实例化Itr"></a>9、实例化Itr</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AbstractItr() &#123;</span><br><span class="line">    // set to initial position</span><br><span class="line">    final ReentrantLock lock = LinkedBlockingDeque.this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        next = firstNode();</span><br><span class="line">        nextItem = (next == null) ? null : next.item;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private class Itr extends AbstractItr &#123;</span><br><span class="line">    Node&lt;E&gt; firstNode() &#123; return first; &#125;</span><br><span class="line">    Node&lt;E&gt; nextNode(Node&lt;E&gt; n) &#123; return n.next; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、Itr的hasNext方法"><a href="#10、Itr的hasNext方法" class="headerlink" title="10、Itr的hasNext方法"></a>10、Itr的hasNext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasNext() &#123;</span><br><span class="line">    return next != null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、Itr的next方法"><a href="#11、Itr的next方法" class="headerlink" title="11、Itr的next方法"></a>11、Itr的next方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public E next() &#123;</span><br><span class="line">    if (next == null)</span><br><span class="line">        throw new NoSuchElementException();</span><br><span class="line">    lastRet = next;</span><br><span class="line">    E x = nextItem;</span><br><span class="line">    //更新next和nextItem</span><br><span class="line">    advance();</span><br><span class="line">    return x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、Itr的advance方法"><a href="#12、Itr的advance方法" class="headerlink" title="12、Itr的advance方法"></a>12、Itr的advance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void advance() &#123;</span><br><span class="line">    final ReentrantLock lock = LinkedBlockingDeque.this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取下一个节点</span><br><span class="line">        next = succ(next);</span><br><span class="line">        nextItem = (next == null) ? null : next.item;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、Itr的succ方法"><a href="#13、Itr的succ方法" class="headerlink" title="13、Itr的succ方法"></a>13、Itr的succ方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private Node&lt;E&gt; succ(Node&lt;E&gt; n) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        //获取下一个节点</span><br><span class="line">        Node&lt;E&gt; s = nextNode(n);</span><br><span class="line">        if (s == null)</span><br><span class="line">            return null;</span><br><span class="line">        else if (s.item != null)</span><br><span class="line">            return s;</span><br><span class="line">        else if (s == n)</span><br><span class="line">        //n节点已被取出，重新返回头节点</span><br><span class="line">            return firstNode();</span><br><span class="line">        else</span><br><span class="line">        //n被删除，迭代下一个节点</span><br><span class="line">            n = s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="六、ConcurrentLinkedQueue"><a href="#六、ConcurrentLinkedQueue" class="headerlink" title="六、ConcurrentLinkedQueue"></a>六、ConcurrentLinkedQueue</h3><h4 id="1、实例化ConcurrentLinkedQueue"><a href="#1、实例化ConcurrentLinkedQueue" class="headerlink" title="1、实例化ConcurrentLinkedQueue"></a>1、实例化ConcurrentLinkedQueue</h4><p>item为删除的锁<br>next为添加的锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentLinkedQueue() &#123;</span><br><span class="line">    head = tail = new Node&lt;E&gt;(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、ConcurrentLinkedQueue的add方法"><a href="#2、ConcurrentLinkedQueue的add方法" class="headerlink" title="2、ConcurrentLinkedQueue的add方法"></a>2、ConcurrentLinkedQueue的add方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    return offer(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、ConcurrentLinkedQueue的offer方法"><a href="#3、ConcurrentLinkedQueue的offer方法" class="headerlink" title="3、ConcurrentLinkedQueue的offer方法"></a>3、ConcurrentLinkedQueue的offer方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public boolean offer(E e) &#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    final Node&lt;E&gt; newNode = new Node&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    for (Node&lt;E&gt; t = tail, p = t;;) &#123;</span><br><span class="line">        Node&lt;E&gt; q = p.next;</span><br><span class="line">        if (q == null) &#123;</span><br><span class="line">            //新节点加入队尾，失败了重新循环</span><br><span class="line">            if (p.casNext(null, newNode)) &#123;</span><br><span class="line">                //更新队尾</span><br><span class="line">                if (p != t) // hop two nodes at a time</span><br><span class="line">                    casTail(t, newNode);  // Failure is OK.</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            // Lost CAS race to another thread; re-read next</span><br><span class="line">        &#125;</span><br><span class="line">        else if (p == q)</span><br><span class="line">        //p已被删除，重新查找队尾 </span><br><span class="line">            p = (t != (t = tail)) ? t : head;</span><br><span class="line">        else</span><br><span class="line">        //p已不是队尾，向后迭代</span><br><span class="line">            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ConcurrentLinkedQueue的poll方法"><a href="#4、ConcurrentLinkedQueue的poll方法" class="headerlink" title="4、ConcurrentLinkedQueue的poll方法"></a>4、ConcurrentLinkedQueue的poll方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public E poll() &#123;</span><br><span class="line">    restartFromHead:</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        for (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            E item = p.item;</span><br><span class="line">            if (item != null &amp;&amp; p.casItem(item, null)) &#123;</span><br><span class="line">            //获取该节点</span><br><span class="line">                //更新头节点</span><br><span class="line">                if (p != h) // hop two nodes at a time</span><br><span class="line">                    updateHead(h, ((q = p.next) != null) ? q : p);</span><br><span class="line">                return item;</span><br><span class="line">            &#125;</span><br><span class="line">            else if ((q = p.next) == null) &#123;</span><br><span class="line">            //队列已空，获取不到</span><br><span class="line">                //更新头节点</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (p == q)</span><br><span class="line">            //p节点已被删除，重新查找</span><br><span class="line">                continue restartFromHead;</span><br><span class="line">            else</span><br><span class="line">            //该节点已被其他线程获取，向后迭代</span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、ConcurrentLinkedQueue的remove方法"><a href="#5、ConcurrentLinkedQueue的remove方法" class="headerlink" title="5、ConcurrentLinkedQueue的remove方法"></a>5、ConcurrentLinkedQueue的remove方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    if (o != null) &#123;</span><br><span class="line">        Node&lt;E&gt; next, pred = null;</span><br><span class="line">        for (Node&lt;E&gt; p = first(); p != null; pred = p, p = next) &#123;</span><br><span class="line">            boolean removed = false;</span><br><span class="line">            E item = p.item;</span><br><span class="line">            if (item != null) &#123;</span><br><span class="line">                if (!o.equals(item)) &#123;</span><br><span class="line">                    //查找下一个节点继续迭代</span><br><span class="line">                    next = succ(p);</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //删除p</span><br><span class="line">                removed = p.casItem(item, null);</span><br><span class="line">            &#125;</span><br><span class="line">            next = succ(p);</span><br><span class="line">            if (pred != null &amp;&amp; next != null) // unlink</span><br><span class="line">                //节点踢出队列</span><br><span class="line">                pred.casNext(p, next);</span><br><span class="line">            if (removed)</span><br><span class="line">                return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、CopyOnWriteArrayList&quot;&gt;&lt;a href=&quot;#一、CopyOnWriteArrayList&quot; class=&quot;headerlink&quot; title=&quot;一、CopyOnWriteArrayList&quot;&gt;&lt;/a&gt;一、CopyOnWriteArrayLi
      
    
    </summary>
    
      <category term="java.util.concurrent" scheme="http://yoursite.com/categories/java-util-concurrent/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E9%9B%86%E5%90%88(2)ConcurrentSkipListMap/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC集合(2)ConcurrentSkipListMap/</id>
    <published>2018-05-06T13:48:30.187Z</published>
    <updated>2018-06-28T14:03:06.710Z</updated>
    
    <content type="html"><![CDATA[<hr><p>title: JUC集合(2)ConcurrentSkipListMap</p><h2 id="categories-java-util-concurrent"><a href="#categories-java-util-concurrent" class="headerlink" title="categories: java.util.concurrent"></a>categories: java.util.concurrent</h2><h3 id="一、ConcurrentSkipListMap"><a href="#一、ConcurrentSkipListMap" class="headerlink" title="一、ConcurrentSkipListMap"></a>一、ConcurrentSkipListMap</h3><h4 id="1、实例化ConcurrentSkipListMap"><a href="#1、实例化ConcurrentSkipListMap" class="headerlink" title="1、实例化ConcurrentSkipListMap"></a>1、实例化ConcurrentSkipListMap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = Node.class;</span><br><span class="line">        //value的位置偏移。删除节点的锁</span><br><span class="line">        valueOffset = UNSAFE.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;value&quot;));</span><br><span class="line">        /后继节点的位置偏移。新增节点的锁</span><br><span class="line">        nextOffset = UNSAFE.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;next&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentSkipListMap() &#123;</span><br><span class="line">    this.comparator = null;</span><br><span class="line">    initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void initialize() &#123;</span><br><span class="line">    keySet = null;</span><br><span class="line">    entrySet = null;</span><br><span class="line">    values = null;</span><br><span class="line">    descendingMap = null;</span><br><span class="line">    head = new HeadIndex&lt;K,V&gt;(new Node&lt;K,V&gt;(null, BASE_HEADER, null),</span><br><span class="line">                              null, null, 1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、实例化Index"><a href="#2、实例化Index" class="headerlink" title="2、实例化Index"></a>2、实例化Index</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = Index.class;</span><br><span class="line">        //right的位置偏移。操作索引的锁</span><br><span class="line">        rightOffset = UNSAFE.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;right&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Index(Node&lt;K,V&gt; node, Index&lt;K,V&gt; down, Index&lt;K,V&gt; right) &#123;</span><br><span class="line">    this.node = node;</span><br><span class="line">    this.down = down;</span><br><span class="line">    this.right = right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ConcurrentSkipListMap的put方法"><a href="#3、ConcurrentSkipListMap的put方法" class="headerlink" title="3、ConcurrentSkipListMap的put方法"></a>3、ConcurrentSkipListMap的put方法</h4><p>添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">    if (value == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    return doPut(key, value, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、ConcurrentSkipListMap的doPut方法"><a href="#4、ConcurrentSkipListMap的doPut方法" class="headerlink" title="4、ConcurrentSkipListMap的doPut方法"></a>4、ConcurrentSkipListMap的doPut方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"> private V doPut(K key, V value, boolean onlyIfAbsent) &#123;</span><br><span class="line">    Node&lt;K,V&gt; z;             // added node</span><br><span class="line">    if (key == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    Comparator&lt;? super K&gt; cmp = comparator;</span><br><span class="line">    outer: for (;;) &#123;</span><br><span class="line">        //由索引查找队列前面最接近的节点</span><br><span class="line">        for (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            if (n != null) &#123;</span><br><span class="line">                Object v; int c;</span><br><span class="line">                Node&lt;K,V&gt; f = n.next;</span><br><span class="line">                //b节点的后继节点已被更改，跳出内循环，重新查找</span><br><span class="line">                if (n != b.next)               // inconsistent read</span><br><span class="line">                    break;</span><br><span class="line">                //n节点被删除，帮助删除，然后重新查找</span><br><span class="line">                if ((v = n.value) == null) &#123;   // n is deleted</span><br><span class="line">                    n.helpDelete(b, f);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                //b节点已删除</span><br><span class="line">                if (b.value == null || v == n) // b is deleted</span><br><span class="line">                    break;</span><br><span class="line">                //新增节点大于后继节点，后继节点作为当前结点，继续迭代</span><br><span class="line">                if ((c = cpr(cmp, key, n.key)) &gt; 0) &#123;</span><br><span class="line">                    b = n;</span><br><span class="line">                    n = f;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //新增节点已存在，如果允许则替换</span><br><span class="line">                if (c == 0) &#123;</span><br><span class="line">                    if (onlyIfAbsent || n.casValue(v, value)) &#123;</span><br><span class="line">                        @SuppressWarnings(&quot;unchecked&quot;) V vv = (V)v;</span><br><span class="line">                        return vv;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break; // restart if lost race to replace value</span><br><span class="line">                &#125;</span><br><span class="line">                // else c &lt; 0; fall through</span><br><span class="line">            &#125;</span><br><span class="line">            z = new Node&lt;K,V&gt;(key, value, n);</span><br><span class="line">            //找到前继节点，添加当前节点</span><br><span class="line">            if (!b.casNext(n, z))</span><br><span class="line">                break;         // restart if lost race to append to b</span><br><span class="line">            break outer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //随机数</span><br><span class="line">    int rnd = ThreadLocalRandom.nextSecondarySeed();</span><br><span class="line">    if ((rnd &amp; 0x80000001) == 0) &#123; // test highest and lowest bits</span><br><span class="line">        int level = 1, max;</span><br><span class="line">        //1的个数，作为level</span><br><span class="line">        while (((rnd &gt;&gt;&gt;= 1) &amp; 1) != 0)</span><br><span class="line">            ++level;</span><br><span class="line">        Index&lt;K,V&gt; idx = null;</span><br><span class="line">        HeadIndex&lt;K,V&gt; h = head;</span><br><span class="line">        if (level &lt;= (max = h.level)) &#123;</span><br><span class="line">        //level小于已有的max，直接创建新增节点的索引</span><br><span class="line">            for (int i = 1; i &lt;= level; ++i)</span><br><span class="line">                idx = new Index&lt;K,V&gt;(z, idx, null);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123; // try to grow by one level</span><br><span class="line">        //level大于已有的max</span><br><span class="line">            //将当前的max加一</span><br><span class="line">            level = max + 1; // hold in array and later pick the one to use</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)Index&lt;K,V&gt;[] idxs =</span><br><span class="line">                (Index&lt;K,V&gt;[])new Index&lt;?,?&gt;[level+1];</span><br><span class="line">            //创建新增节点的索引</span><br><span class="line">            for (int i = 1; i &lt;= level; ++i)</span><br><span class="line">                idxs[i] = idx = new Index&lt;K,V&gt;(z, idx, null);</span><br><span class="line">            for (;;) &#123;</span><br><span class="line">                h = head;</span><br><span class="line">                int oldLevel = h.level;</span><br><span class="line">                //其它线程已经，增加了头节点的索引</span><br><span class="line">                if (level &lt;= oldLevel) // lost race to add level</span><br><span class="line">                    break;</span><br><span class="line">                HeadIndex&lt;K,V&gt; newh = h;</span><br><span class="line">                Node&lt;K,V&gt; oldbase = h.node;</span><br><span class="line">                //头节点新增的索引</span><br><span class="line">                for (int j = oldLevel+1; j &lt;= level; ++j)</span><br><span class="line">                    newh = new HeadIndex&lt;K,V&gt;(oldbase, newh, idxs[j], j);</span><br><span class="line">                //更新索引头</span><br><span class="line">                if (casHead(h, newh)) &#123;</span><br><span class="line">                    h = newh;</span><br><span class="line">                    idx = idxs[level = oldLevel];</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // find insertion points and splice in</span><br><span class="line">        splice: for (int insertionLevel = level;;) &#123;</span><br><span class="line">            int j = h.level;</span><br><span class="line">            for (Index&lt;K,V&gt; q = h, r = q.right, t = idx;;) &#123;</span><br><span class="line">                //节点被删除，重新添加</span><br><span class="line">                if (q == null || t == null)</span><br><span class="line">                    break splice;</span><br><span class="line">                if (r != null) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; n = r.node;</span><br><span class="line">                    // compare before deletion check avoids needing recheck</span><br><span class="line">                    int c = cpr(cmp, key, n.key);</span><br><span class="line">                    //n被删除，获取q的新右索引</span><br><span class="line">                    if (n.value == null) &#123;</span><br><span class="line">                        if (!q.unlink(r))</span><br><span class="line">                            break;</span><br><span class="line">                        r = q.right;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //右节点做当前节点，继续迭代</span><br><span class="line">                    if (c &gt; 0) &#123;</span><br><span class="line">                        q = r;</span><br><span class="line">                        r = r.right;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (j == insertionLevel) &#123;</span><br><span class="line">                    //添加索引</span><br><span class="line">                    if (!q.link(r, t))</span><br><span class="line">                        break; // restart</span><br><span class="line">                    //节点已删除</span><br><span class="line">                    if (t.node.value == null) &#123;</span><br><span class="line">                        findNode(key);</span><br><span class="line">                        break splice;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //全部处理完成</span><br><span class="line">                    if (--insertionLevel == 0)</span><br><span class="line">                        break splice;</span><br><span class="line">                &#125;</span><br><span class="line">                //继续处理下一层索引</span><br><span class="line">                if (--j &gt;= insertionLevel &amp;&amp; j &lt; level)</span><br><span class="line">                    t = t.down;</span><br><span class="line">                q = q.down;</span><br><span class="line">                r = q.right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、ConcurrentSkipListMap的put方法"><a href="#5、ConcurrentSkipListMap的put方法" class="headerlink" title="5、ConcurrentSkipListMap的put方法"></a>5、ConcurrentSkipListMap的put方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public V get(Object key) &#123;</span><br><span class="line">    return doGet(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、ConcurrentSkipListMap的doGet方法"><a href="#6、ConcurrentSkipListMap的doGet方法" class="headerlink" title="6、ConcurrentSkipListMap的doGet方法"></a>6、ConcurrentSkipListMap的doGet方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private V doGet(Object key) &#123;</span><br><span class="line">    if (key == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    Comparator&lt;? super K&gt; cmp = comparator;</span><br><span class="line">    outer: for (;;) &#123;</span><br><span class="line">        //由索引查找队列前面最接近的节点</span><br><span class="line">        for (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; int c;</span><br><span class="line">            //查到队尾,未找到</span><br><span class="line">            if (n == null)</span><br><span class="line">                break outer;</span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            //后继节点已变更，重新查找</span><br><span class="line">            if (n != b.next)                // inconsistent read</span><br><span class="line">                break;</span><br><span class="line">            //n节点已被删除，帮助删除</span><br><span class="line">            if ((v = n.value) == null) &#123;    // n is deleted</span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            //b已被删除，重新查找</span><br><span class="line">            if (b.value == null || v == n)  // b is deleted</span><br><span class="line">                break;</span><br><span class="line">            //找到</span><br><span class="line">            if ((c = cpr(cmp, key, n.key)) == 0) &#123;</span><br><span class="line">                @SuppressWarnings(&quot;unchecked&quot;) V vv = (V)v;</span><br><span class="line">                return vv;</span><br><span class="line">            &#125;</span><br><span class="line">            //未找到</span><br><span class="line">            if (c &lt; 0)</span><br><span class="line">                break outer;</span><br><span class="line">            //后继节点做当前节点，继续迭代</span><br><span class="line">            b = n;</span><br><span class="line">            n = f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ConcurrentSkipListMap的findPredecessor方法"><a href="#7、ConcurrentSkipListMap的findPredecessor方法" class="headerlink" title="7、ConcurrentSkipListMap的findPredecessor方法"></a>7、ConcurrentSkipListMap的findPredecessor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private Node&lt;K,V&gt; findPredecessor(Object key, Comparator&lt;? super K&gt; cmp) &#123;</span><br><span class="line">    if (key == null)</span><br><span class="line">        throw new NullPointerException(); // don&apos;t postpone errors</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        for (Index&lt;K,V&gt; q = head, r = q.right, d;;) &#123;</span><br><span class="line">            if (r != null) &#123;</span><br><span class="line">                Node&lt;K,V&gt; n = r.node;</span><br><span class="line">                K k = n.key;</span><br><span class="line">                //节点已被删除，帮助删除</span><br><span class="line">                if (n.value == null) &#123;</span><br><span class="line">                    if (!q.unlink(r))</span><br><span class="line">                        break;           // restart</span><br><span class="line">                    r = q.right;         // reread r</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //先往右查找</span><br><span class="line">                if (cpr(cmp, key, k) &gt; 0) &#123;</span><br><span class="line">                    q = r;</span><br><span class="line">                    r = r.right;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //往下查找，直到索引最下行</span><br><span class="line">            if ((d = q.down) == null)</span><br><span class="line">                return q.node;</span><br><span class="line">            q = d;</span><br><span class="line">            r = d.right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、ConcurrentSkipListMap的remove方法"><a href="#8、ConcurrentSkipListMap的remove方法" class="headerlink" title="8、ConcurrentSkipListMap的remove方法"></a>8、ConcurrentSkipListMap的remove方法</h4><p>删除元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public V remove(Object key) &#123;</span><br><span class="line">    return doRemove(key, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="9、ConcurrentSkipListMap的doRemove方法"><a href="#9、ConcurrentSkipListMap的doRemove方法" class="headerlink" title="9、ConcurrentSkipListMap的doRemove方法"></a>9、ConcurrentSkipListMap的doRemove方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">final V doRemove(Object key, Object value) &#123;</span><br><span class="line">    if (key == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    Comparator&lt;? super K&gt; cmp = comparator;</span><br><span class="line">    outer: for (;;) &#123;</span><br><span class="line">        //由索引查找队列前面最接近的节点</span><br><span class="line">        for (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; int c;</span><br><span class="line">            //查到队尾,未找到</span><br><span class="line">            if (n == null)</span><br><span class="line">                break outer;</span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            //后继节点已被更改</span><br><span class="line">            if (n != b.next)                    // inconsistent read</span><br><span class="line">                break;</span><br><span class="line">            //节点被删除，帮助删除</span><br><span class="line">            if ((v = n.value) == null) &#123;        // n is deleted</span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            //b节点被删除</span><br><span class="line">            if (b.value == null || v == n)      // b is deleted</span><br><span class="line">                break;</span><br><span class="line">            //未找到</span><br><span class="line">            if ((c = cpr(cmp, key, n.key)) &lt; 0)</span><br><span class="line">                break outer;</span><br><span class="line">            //后继节点做当前节点，继续迭代</span><br><span class="line">            if (c &gt; 0) &#123;</span><br><span class="line">                b = n;</span><br><span class="line">                n = f;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            //该节点值已被替换</span><br><span class="line">            if (value != null &amp;&amp; !value.equals(v))</span><br><span class="line">                break outer;</span><br><span class="line">            //节点值置空</span><br><span class="line">            if (!n.casValue(v, null))</span><br><span class="line">                break;</span><br><span class="line">            if (!n.appendMarker(f) || !b.casNext(n, f))</span><br><span class="line">            //标记n节点已被删除且删除节点</span><br><span class="line">                //清空节点索引</span><br><span class="line">                findNode(key);                  // retry via findNode</span><br><span class="line">            else &#123;</span><br><span class="line">                //清空节点索引</span><br><span class="line">                findPredecessor(key, cmp);      // clean index</span><br><span class="line">                //减少索引高度</span><br><span class="line">                if (head.right == null)</span><br><span class="line">                    tryReduceLevel();</span><br><span class="line">            &#125;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;) V vv = (V)v;</span><br><span class="line">            return vv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、ConcurrentSkipListMap的helpDelete方法"><a href="#10、ConcurrentSkipListMap的helpDelete方法" class="headerlink" title="10、ConcurrentSkipListMap的helpDelete方法"></a>10、ConcurrentSkipListMap的helpDelete方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void helpDelete(Node&lt;K,V&gt; b, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    //尚未标记且尚未删除</span><br><span class="line">    if (f == next &amp;&amp; this == b.next) &#123;</span><br><span class="line">        if (f == null || f.value != f) // not already marked</span><br><span class="line">            //标记n节点被删除</span><br><span class="line">            casNext(f, new Node&lt;K,V&gt;(f));</span><br><span class="line">        else</span><br><span class="line">            //删除n节点</span><br><span class="line">            b.casNext(this, f.next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、接（一、8）ConcurrentSkipListMap的tryReduceLevel方法"><a href="#11、接（一、8）ConcurrentSkipListMap的tryReduceLevel方法" class="headerlink" title="11、接（一、8）ConcurrentSkipListMap的tryReduceLevel方法"></a>11、接（一、8）ConcurrentSkipListMap的tryReduceLevel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void tryReduceLevel() &#123;</span><br><span class="line">    HeadIndex&lt;K,V&gt; h = head;</span><br><span class="line">    HeadIndex&lt;K,V&gt; d;</span><br><span class="line">    HeadIndex&lt;K,V&gt; e;</span><br><span class="line">    //索引高度大于3，</span><br><span class="line">    //最高三层头索引，右节点索引都不存在,减一层索引，并检查删除的头节点索引是否又被新的右索引</span><br><span class="line">    if (h.level &gt; 3 &amp;&amp;</span><br><span class="line">        (d = (HeadIndex&lt;K,V&gt;)h.down) != null &amp;&amp;</span><br><span class="line">        (e = (HeadIndex&lt;K,V&gt;)d.down) != null &amp;&amp;</span><br><span class="line">        e.right == null &amp;&amp;</span><br><span class="line">        d.right == null &amp;&amp;</span><br><span class="line">        h.right == null &amp;&amp;</span><br><span class="line">        casHead(h, d) &amp;&amp; // try to set</span><br><span class="line">        h.right != null) // recheck</span><br><span class="line">        casHead(d, h);   // try to backout</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、ConcurrentSkipListSet"><a href="#二、ConcurrentSkipListSet" class="headerlink" title="二、ConcurrentSkipListSet"></a>二、ConcurrentSkipListSet</h3><h4 id="1、实例化ConcurrentSkipListSet"><a href="#1、实例化ConcurrentSkipListSet" class="headerlink" title="1、实例化ConcurrentSkipListSet"></a>1、实例化ConcurrentSkipListSet</h4><p>内部通过一个ConcurrentSkipListMap实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentSkipListSet() &#123;</span><br><span class="line">    m = new ConcurrentSkipListMap&lt;E,Object&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、ConcurrentSkipListSet的add方法"><a href="#2、ConcurrentSkipListSet的add方法" class="headerlink" title="2、ConcurrentSkipListSet的add方法"></a>2、ConcurrentSkipListSet的add方法</h4><p>添加元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    return m.putIfAbsent(e, Boolean.TRUE) == null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、ConcurrentSkipListMap的putIfAbsent方法"><a href="#3、ConcurrentSkipListMap的putIfAbsent方法" class="headerlink" title="3、ConcurrentSkipListMap的putIfAbsent方法"></a>3、ConcurrentSkipListMap的putIfAbsent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public V putIfAbsent(K key, V value) &#123;</span><br><span class="line">    if (value == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    return doPut(key, value, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ConcurrentSkipListSet的contains方法"><a href="#4、ConcurrentSkipListSet的contains方法" class="headerlink" title="4、ConcurrentSkipListSet的contains方法"></a>4、ConcurrentSkipListSet的contains方法</h4><p>元素是否存在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean contains(Object o) &#123;</span><br><span class="line">    return m.containsKey(o);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、ConcurrentSkipListMap的containsKey方法"><a href="#5、ConcurrentSkipListMap的containsKey方法" class="headerlink" title="5、ConcurrentSkipListMap的containsKey方法"></a>5、ConcurrentSkipListMap的containsKey方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean containsKey(Object key) &#123;</span><br><span class="line">    return doGet(key) != null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、ConcurrentSkipListMap的doGet方法-1"><a href="#6、ConcurrentSkipListMap的doGet方法-1" class="headerlink" title="6、ConcurrentSkipListMap的doGet方法"></a>6、ConcurrentSkipListMap的doGet方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private V doGet(Object key) &#123;</span><br><span class="line">    if (key == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    Comparator&lt;? super K&gt; cmp = comparator;</span><br><span class="line">    outer: for (;;) &#123;</span><br><span class="line">        for (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; int c;</span><br><span class="line">            if (n == null)</span><br><span class="line">                break outer;</span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            if (n != b.next)                // inconsistent read</span><br><span class="line">                break;</span><br><span class="line">            if ((v = n.value) == null) &#123;    // n is deleted</span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (b.value == null || v == n)  // b is deleted</span><br><span class="line">                break;</span><br><span class="line">            if ((c = cpr(cmp, key, n.key)) == 0) &#123;</span><br><span class="line">                @SuppressWarnings(&quot;unchecked&quot;) V vv = (V)v;</span><br><span class="line">                return vv;</span><br><span class="line">            &#125;</span><br><span class="line">            if (c &lt; 0)</span><br><span class="line">                break outer;</span><br><span class="line">            b = n;</span><br><span class="line">            n = f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ConcurrentSkipListSet的remove方法"><a href="#7、ConcurrentSkipListSet的remove方法" class="headerlink" title="7、ConcurrentSkipListSet的remove方法"></a>7、ConcurrentSkipListSet的remove方法</h4><p>删除元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    return m.remove(o, Boolean.TRUE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、ConcurrentSkipListMap的remove方法-1"><a href="#8、ConcurrentSkipListMap的remove方法-1" class="headerlink" title="8、ConcurrentSkipListMap的remove方法"></a>8、ConcurrentSkipListMap的remove方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public boolean remove(Object key, Object value) &#123;</span><br><span class="line">    if (key == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    return value != null &amp;&amp; doRemove(key, value) != null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;hr&gt;
&lt;p&gt;title: JUC集合(2)ConcurrentSkipListMap&lt;/p&gt;
&lt;h2 id=&quot;categories-java-util-concurrent&quot;&gt;&lt;a href=&quot;#categories-java-util-concurrent&quot; class=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>JUC集合(1)ConcurrentHashMap</title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E9%9B%86%E5%90%88(1)ConcurrentHashMap/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC集合(1)ConcurrentHashMap/</id>
    <published>2018-05-06T13:48:30.185Z</published>
    <updated>2018-06-28T14:02:50.205Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、ConcurrentHashMap"><a href="#一、ConcurrentHashMap" class="headerlink" title="一、ConcurrentHashMap"></a>一、ConcurrentHashMap</h3><h4 id="1、实例化ConcurrentHashMap"><a href="#1、实例化ConcurrentHashMap" class="headerlink" title="1、实例化ConcurrentHashMap"></a>1、实例化ConcurrentHashMap</h4><p>JDK1.8的ConcurrentHashMap的实现方式与之前不同，采用的是数组链表方式，当链表里数据过多的时候，链表自动转换为红黑树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = ConcurrentHashMap.class;</span><br><span class="line">        //数组扩容的锁，在对象中的位置偏移</span><br><span class="line">        SIZECTL = U.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;sizeCtl&quot;));</span><br><span class="line">        //transferIndex扩容时处理到的数组下标值，在对象中的位置偏移。扩容时线程获取处理链表的锁</span><br><span class="line">        TRANSFERINDEX = U.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;transferIndex&quot;));</span><br><span class="line">        //元素的数量，在对象中的位置偏移</span><br><span class="line">        BASECOUNT = U.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;baseCount&quot;));</span><br><span class="line">        //存放元素数量数组扩容锁，在对象中的位置偏移</span><br><span class="line">        CELLSBUSY = U.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;cellsBusy&quot;));</span><br><span class="line">        Class&lt;?&gt; ck = CounterCell.class;</span><br><span class="line">        //存放的是部分元素的数量</span><br><span class="line">        CELLVALUE = U.objectFieldOffset</span><br><span class="line">            (ck.getDeclaredField(&quot;value&quot;));</span><br><span class="line">        Class&lt;?&gt; ak = Node[].class;</span><br><span class="line">        //数组第一个元素相对于数组起始位置的偏移</span><br><span class="line">        ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">        //数组元素的大小</span><br><span class="line">        int scale = U.arrayIndexScale(ak);</span><br><span class="line">        if ((scale &amp; (scale - 1)) != 0)</span><br><span class="line">            throw new Error(&quot;data type scale not a power of two&quot;);</span><br><span class="line">        ASHIFT = 31 - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentHashMap() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ConcurrentHashMap的put方法"><a href="#2、ConcurrentHashMap的put方法" class="headerlink" title="2、ConcurrentHashMap的put方法"></a>2、ConcurrentHashMap的put方法</h4><p>添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">    return putVal(key, value, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、ConcurrentHashMap的putVal方法"><a href="#3、ConcurrentHashMap的putVal方法" class="headerlink" title="3、ConcurrentHashMap的putVal方法"></a>3、ConcurrentHashMap的putVal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">final V putVal(K key, V value, boolean onlyIfAbsent) &#123;</span><br><span class="line">    if (key == null || value == null) throw new NullPointerException();</span><br><span class="line">    //获取key的hash值</span><br><span class="line">    int hash = spread(key.hashCode());</span><br><span class="line">    int binCount = 0;</span><br><span class="line">    for (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; int n, i, fh;</span><br><span class="line">        if (tab == null || (n = tab.length) == 0)</span><br><span class="line">            //节点数组不存在</span><br><span class="line">            //初始化节点数组</span><br><span class="line">            tab = initTable();</span><br><span class="line">        else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123;</span><br><span class="line">            //节点数组长度与key的hash值取模作为key在节点数组中的下标</span><br><span class="line">            //若数组该下标节点不存在，则用当前的key、value新建一个节点，添加进数组</span><br><span class="line">            if (casTabAt(tab, i, null,new Node&lt;K,V&gt;(hash, key, value, null)))</span><br><span class="line">                break;                   // no lock when adding to empty bin</span><br><span class="line">        &#125;</span><br><span class="line">        else if ((fh = f.hash) == MOVED)</span><br><span class="line">            //数组正在扩容</span><br><span class="line">            //参与到扩容中去</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        else &#123;</span><br><span class="line">            //数组该下标节点已存在，且有效</span><br><span class="line">            V oldVal = null;</span><br><span class="line">            //获取该节点的对象锁</span><br><span class="line">            synchronized (f) &#123;</span><br><span class="line">                //数组该下标节点任然等于f，说明未被其他线程更改</span><br><span class="line">                if (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    if (fh &gt;= 0) &#123;</span><br><span class="line">                        //该节点hash值大于零，表示该节点仍为普通节点</span><br><span class="line">                        //该链表节点数</span><br><span class="line">                        binCount = 1;</span><br><span class="line">                        for (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            //该节点key与添加的key相等</span><br><span class="line">                            if (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != null &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                //是否允许覆盖</span><br><span class="line">                                if (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            if ((e = e.next) == null) &#123;</span><br><span class="line">                                //将当前key、value新建节点，加入链表最后</span><br><span class="line">                                pred.next = new Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, null);</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else if (f instanceof TreeBin) &#123;</span><br><span class="line">                        //f节点为红黑树</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = 2;</span><br><span class="line">                        //往红黑树中添加该key、value</span><br><span class="line">                        if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,value)) != null) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            if (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (binCount != 0) &#123;</span><br><span class="line">                //链表元素超过8个</span><br><span class="line">                if (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    //重新设置数组长度或者将链表转换为红黑树</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                if (oldVal != null)</span><br><span class="line">                    return oldVal;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //增加元素数量</span><br><span class="line">    addCount(1L, binCount);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ConcurrentHashMap的initTable方法"><a href="#4、ConcurrentHashMap的initTable方法" class="headerlink" title="4、ConcurrentHashMap的initTable方法"></a>4、ConcurrentHashMap的initTable方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private final Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; int sc;</span><br><span class="line">    //table不存在</span><br><span class="line">    while ((tab = table) == null || tab.length == 0) &#123;</span><br><span class="line">        if ((sc = sizeCtl) &lt; 0)</span><br><span class="line">            //其他线程已经在初始化，本线程进入待执行状态</span><br><span class="line">            Thread.yield(); // lost initialization race; just spin</span><br><span class="line">        else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123;</span><br><span class="line">            //将sizeCtl改为-1，获取数组扩容锁</span><br><span class="line">            try &#123;</span><br><span class="line">                //table不存在，须初始化</span><br><span class="line">                if ((tab = table) == null || tab.length == 0) &#123;</span><br><span class="line">                    //sc大于零说明实例化的时候给了数组的容量</span><br><span class="line">                    int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    //创建一个空数组，赋值给table</span><br><span class="line">                    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; 2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（一、3）ConcurrentHashMap的helpTransfer方法"><a href="#5、接（一、3）ConcurrentHashMap的helpTransfer方法" class="headerlink" title="5、接（一、3）ConcurrentHashMap的helpTransfer方法"></a>5、接（一、3）ConcurrentHashMap的helpTransfer方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; int sc;</span><br><span class="line">    //正在扩容</span><br><span class="line">    if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp;</span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) &#123;</span><br><span class="line">        //获取锁标志</span><br><span class="line">        int rs = resizeStamp(tab.length);</span><br><span class="line">        while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">               (sc = sizeCtl) &lt; 0) &#123;</span><br><span class="line">            //(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs 表示数组初始化状态</span><br><span class="line">            //sc == rs + 1 表示数组扩容已完成</span><br><span class="line">            //sc == rs + MAX_RESIZERS 表示获取锁的线程已达到上限</span><br><span class="line">            //剩余条件均表示扩容已完成</span><br><span class="line">            if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            //获取锁</span><br><span class="line">            if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) &#123;</span><br><span class="line">                //参与扩容</span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    return table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（一、3）ConcurrentHashMap的treeifyBin方法"><a href="#6、接（一、3）ConcurrentHashMap的treeifyBin方法" class="headerlink" title="6、接（一、3）ConcurrentHashMap的treeifyBin方法"></a>6、接（一、3）ConcurrentHashMap的treeifyBin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private final void treeifyBin(Node&lt;K,V&gt;[] tab, int index) &#123;</span><br><span class="line">    Node&lt;K,V&gt; b; int n, sc;</span><br><span class="line">    if (tab != null) &#123;</span><br><span class="line">        if ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            //数组长度未达到，最小转换红黑数的长度</span><br><span class="line">            //扩大数组容量</span><br><span class="line">            tryPresize(n &lt;&lt; 1);</span><br><span class="line">        else if ((b = tabAt(tab, index)) != null &amp;&amp; b.hash &gt;= 0) &#123;</span><br><span class="line">            //b.hash大于等于零,b是普通节点</span><br><span class="line">            synchronized (b) &#123;</span><br><span class="line">                //节点b未发生改变</span><br><span class="line">                if (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = null, tl = null;</span><br><span class="line">                    //将b及之后的元素，加入一个TreeNode队列</span><br><span class="line">                    for (Node&lt;K,V&gt; e = b; e != null; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p =</span><br><span class="line">                            new TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                              null, null);</span><br><span class="line">                        //创建双向队列</span><br><span class="line">                        if ((p.prev = tl) == null)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        else</span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //把TreeNode队列加入TreeBin，并转换为红黑树，然后加入数组</span><br><span class="line">                    setTabAt(tab, index, new TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ConcurrentHashMap的tryPresize方法"><a href="#7、ConcurrentHashMap的tryPresize方法" class="headerlink" title="7、ConcurrentHashMap的tryPresize方法"></a>7、ConcurrentHashMap的tryPresize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">private final void tryPresize(int size) &#123;</span><br><span class="line">    //获取新数组的容量</span><br><span class="line">    int c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY :</span><br><span class="line">        tableSizeFor(size + (size &gt;&gt;&gt; 1) + 1);</span><br><span class="line">    int sc;</span><br><span class="line">    //锁未被获取</span><br><span class="line">    while ((sc = sizeCtl) &gt;= 0) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; int n;</span><br><span class="line">        if (tab == null || (n = tab.length) == 0) &#123;</span><br><span class="line">        //数组不存在</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            //获取锁</span><br><span class="line">            if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //数组未改变，初始化数组</span><br><span class="line">                    if (table == tab) &#123;</span><br><span class="line">                        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; 2);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    //释放锁</span><br><span class="line">                    sizeCtl = sc;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">        //无需扩容</span><br><span class="line">            break;</span><br><span class="line">        else if (tab == table) &#123;</span><br><span class="line">            //由数组长度，获取锁标志</span><br><span class="line">            int rs = resizeStamp(n);</span><br><span class="line">            if (sc &lt; 0) &#123;</span><br><span class="line">            //锁已被获取</span><br><span class="line">                Node&lt;K,V&gt;[] nt;</span><br><span class="line">                //(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs 表示数组初始化状态</span><br><span class="line">                //sc == rs + 1 表示数组扩容已完成</span><br><span class="line">                //sc == rs + MAX_RESIZERS 表示获取锁的线程已达到上限</span><br><span class="line">                //剩余条件均表示扩容已完成</span><br><span class="line">                if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||</span><br><span class="line">                    transferIndex &lt;= 0)</span><br><span class="line">                    break;</span><br><span class="line">                //获取锁，并参与到扩容中去</span><br><span class="line">                if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (U.compareAndSwapInt(this, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))</span><br><span class="line">            //锁未被其他线程获取，并且本线程已获取到锁</span><br><span class="line">                //扩容数组</span><br><span class="line">                transfer(tab, null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、ConcurrentHashMap的transfer方法"><a href="#8、ConcurrentHashMap的transfer方法" class="headerlink" title="8、ConcurrentHashMap的transfer方法"></a>8、ConcurrentHashMap的transfer方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) &#123;</span><br><span class="line">    //stride线程一批处理数组中链表的个数</span><br><span class="line">    int n = tab.length, stride;</span><br><span class="line">    if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; // subdivide range</span><br><span class="line">    //扩容后的数组尚不存在，初始化</span><br><span class="line">    if (nextTab == null) &#123;            // initiating</span><br><span class="line">        try &#123;</span><br><span class="line">            @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; catch (Throwable ex) &#123;      // try to cope with OOME</span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    //扩容后数组的长度</span><br><span class="line">    int nextn = nextTab.length;</span><br><span class="line">    //扩容数组时，替代老数组中的处理完的链表</span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    //本批次是否处理完成</span><br><span class="line">    boolean advance = true;</span><br><span class="line">    //数组扩容完成</span><br><span class="line">    boolean finishing = false; // to ensure sweep before committing nextTab</span><br><span class="line">    for (int i = 0, bound = 0;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; int fh;</span><br><span class="line">        while (advance) &#123;</span><br><span class="line">            int nextIndex, nextBound;</span><br><span class="line">            if (--i &gt;= bound || finishing)</span><br><span class="line">            //本批次尚未处理完成，或已经全部处理完成</span><br><span class="line">                advance = false;</span><br><span class="line">            else if ((nextIndex = transferIndex) &lt;= 0) &#123;</span><br><span class="line">            //已没有可以处理的批次</span><br><span class="line">                i = -1;</span><br><span class="line">                advance = false;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (U.compareAndSwapInt</span><br><span class="line">                     (this, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : 0))) &#123;</span><br><span class="line">                //transferIndex当前处理到的数组下标</span><br><span class="line">                bound = nextBound;</span><br><span class="line">                i = nextIndex - 1;</span><br><span class="line">                advance = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">        //已处理完</span><br><span class="line">            int sc;</span><br><span class="line">            //全部处理完成</span><br><span class="line">            if (finishing) &#123;</span><br><span class="line">                nextTable = null;</span><br><span class="line">                //更新table</span><br><span class="line">                table = nextTab;</span><br><span class="line">                //释放锁</span><br><span class="line">                sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) &#123;</span><br><span class="line">            //释放一层锁</span><br><span class="line">                //表明尚有其他线程正在处理</span><br><span class="line">                if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    return;</span><br><span class="line">                //已全部处理完成</span><br><span class="line">                finishing = advance = true;</span><br><span class="line">                i = n; // recheck before commit</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if ((f = tabAt(tab, i)) == null)</span><br><span class="line">        //数组该位置未有元素</span><br><span class="line">            //设置老数组该位置元素为fwd</span><br><span class="line">            advance = casTabAt(tab, i, null, fwd);</span><br><span class="line">        else if ((fh = f.hash) == MOVED)</span><br><span class="line">        //已处理</span><br><span class="line">            advance = true; // already processed</span><br><span class="line">        else &#123;</span><br><span class="line">            synchronized (f) &#123;</span><br><span class="line">                //数组该位置未改变</span><br><span class="line">                if (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    if (fh &gt;= 0) &#123;</span><br><span class="line">                    //f为普通节点</span><br><span class="line">                        //hash值&amp;n表示扩容后取模的值，是否增加n</span><br><span class="line">                        int runBit = fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) &#123;</span><br><span class="line">                            int b = p.hash &amp; n;</span><br><span class="line">                            if (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                //链表最后的元素</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (runBit == 0) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = null;</span><br><span class="line">                        &#125;</span><br><span class="line">                        else &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = null;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //将原链表元素，重新分为两个链表</span><br><span class="line">                        for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            int ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                            if ((ph &amp; n) == 0)</span><br><span class="line">                                ln = new Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            else</span><br><span class="line">                                hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        //更新新数组元素</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        //更新老数组元素</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = true;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else if (f instanceof TreeBin) &#123;</span><br><span class="line">                    //f为红黑树</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = null, loTail = null;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = null, hiTail = null;</span><br><span class="line">                        int lc = 0, hc = 0;</span><br><span class="line">                        //根据扩容后的数组长度与hash值取模的值，创建两个TreeNode队列</span><br><span class="line">                        for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) &#123;</span><br><span class="line">                            int h = e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, null, null);</span><br><span class="line">                            if ((h &amp; n) == 0) &#123;</span><br><span class="line">                                if ((p.prev = loTail) == null)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                else</span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            else &#123;</span><br><span class="line">                                if ((p.prev = hiTail) == null)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                else</span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //根据节点数量，判断构造红黑树，或者构造链表</span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                            (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = true;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ConcurrentHashMap的untreeify方法"><a href="#9、ConcurrentHashMap的untreeify方法" class="headerlink" title="9、ConcurrentHashMap的untreeify方法"></a>9、ConcurrentHashMap的untreeify方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static &lt;K,V&gt; Node&lt;K,V&gt; untreeify(Node&lt;K,V&gt; b) &#123;</span><br><span class="line">    Node&lt;K,V&gt; hd = null, tl = null;</span><br><span class="line">    //创建链表</span><br><span class="line">    for (Node&lt;K,V&gt; q = b; q != null; q = q.next) &#123;</span><br><span class="line">        Node&lt;K,V&gt; p = new Node&lt;K,V&gt;(q.hash, q.key, q.val, null);</span><br><span class="line">        if (tl == null)</span><br><span class="line">            hd = p;</span><br><span class="line">        else</span><br><span class="line">            tl.next = p;</span><br><span class="line">        tl = p;</span><br><span class="line">    &#125;</span><br><span class="line">    return hd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（一、3）ConcurrentHashMap的addCount方法"><a href="#10、接（一、3）ConcurrentHashMap的addCount方法" class="headerlink" title="10、接（一、3）ConcurrentHashMap的addCount方法"></a>10、接（一、3）ConcurrentHashMap的addCount方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private final void addCount(long x, int check) &#123;</span><br><span class="line">    CounterCell[] as; long b, s;</span><br><span class="line">    //默认用baseCount计数，如果并发争用失败，创建counterCells数组用于计数</span><br><span class="line">    if ((as = counterCells) != null ||</span><br><span class="line">        !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; long v; int m;</span><br><span class="line">        boolean uncontended = true;</span><br><span class="line">        if (as == null || (m = as.length - 1) &lt; 0 ||</span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null ||</span><br><span class="line">            !(uncontended =</span><br><span class="line">              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            //元素数量增加x</span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (check &lt;= 1)</span><br><span class="line">            return;</span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    if (check &gt;= 0) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; int n, sc;</span><br><span class="line">        //元素个数大于sizeCtl扩容数组</span><br><span class="line">        while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            int rs = resizeStamp(n);</span><br><span class="line">            if (sc &lt; 0) &#123;</span><br><span class="line">                if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||</span><br><span class="line">                    transferIndex &lt;= 0)</span><br><span class="line">                    break;</span><br><span class="line">                if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (U.compareAndSwapInt(this, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))</span><br><span class="line">                transfer(tab, null);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ConcurrentHashMap的fullAddCount方法"><a href="#11、ConcurrentHashMap的fullAddCount方法" class="headerlink" title="11、ConcurrentHashMap的fullAddCount方法"></a>11、ConcurrentHashMap的fullAddCount方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">private final void fullAddCount(long x, boolean wasUncontended) &#123;</span><br><span class="line">    int h;</span><br><span class="line">    //获取一个随机数</span><br><span class="line">    if ((h = ThreadLocalRandom.getProbe()) == 0) &#123;</span><br><span class="line">        ThreadLocalRandom.localInit();      // force initialization</span><br><span class="line">        h = ThreadLocalRandom.getProbe();</span><br><span class="line">        wasUncontended = true;</span><br><span class="line">    &#125;</span><br><span class="line">    boolean collide = false;                // True if last slot nonempty</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        CounterCell[] as; CounterCell a; int n; long v;</span><br><span class="line">        if ((as = counterCells) != null &amp;&amp; (n = as.length) &gt; 0) &#123;</span><br><span class="line">        //counterCells数组存在</span><br><span class="line">            if ((a = as[(n - 1) &amp; h]) == null) &#123;</span><br><span class="line">            //该位置没有元素</span><br><span class="line">                if (cellsBusy == 0) &#123;            // Try to attach new Cell</span><br><span class="line">                //cellsBusy锁空闲</span><br><span class="line">                    //创建一个计数器</span><br><span class="line">                    CounterCell r = new CounterCell(x); // Optimistic create</span><br><span class="line">                    //获取锁</span><br><span class="line">                    if (cellsBusy == 0 &amp;&amp;</span><br><span class="line">                        U.compareAndSwapInt(this, CELLSBUSY, 0, 1)) &#123;</span><br><span class="line">                        boolean created = false;</span><br><span class="line">                        try &#123;               // Recheck under lock</span><br><span class="line">                            CounterCell[] rs; int m, j;</span><br><span class="line">                            if ((rs = counterCells) != null &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; 0 &amp;&amp;</span><br><span class="line">                                rs[j = (m - 1) &amp; h] == null) &#123;</span><br><span class="line">                                //添加进数组</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = true;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; finally &#123;</span><br><span class="line">                            //释放锁</span><br><span class="line">                            cellsBusy = 0;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (created)</span><br><span class="line">                            break;</span><br><span class="line">                        continue;           // Slot is now non-empty</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = false;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (!wasUncontended)       // CAS already known to fail</span><br><span class="line">                wasUncontended = true;      // Continue after rehash</span><br><span class="line">            else if (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))</span><br><span class="line">            //增加元素数量，成功则跳出循环</span><br><span class="line">                break;</span><br><span class="line">            else if (counterCells != as || n &gt;= NCPU)</span><br><span class="line">                collide = false;            // At max size or stale</span><br><span class="line">            else if (!collide)</span><br><span class="line">                collide = true;</span><br><span class="line">            else if (cellsBusy == 0 &amp;&amp;</span><br><span class="line">                     U.compareAndSwapInt(this, CELLSBUSY, 0, 1)) &#123;</span><br><span class="line">            //获取锁,counterCells数组扩容</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (counterCells == as) &#123;// Expand table unless stale</span><br><span class="line">                        CounterCell[] rs = new CounterCell[n &lt;&lt; 1];</span><br><span class="line">                        for (int i = 0; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        counterCells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    //释放锁</span><br><span class="line">                    cellsBusy = 0;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = false;</span><br><span class="line">                continue;                   // Retry with expanded table</span><br><span class="line">            &#125;</span><br><span class="line">            //获取下一个随机数</span><br><span class="line">            h = ThreadLocalRandom.advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (cellsBusy == 0 &amp;&amp; counterCells == as &amp;&amp;</span><br><span class="line">                 U.compareAndSwapInt(this, CELLSBUSY, 0, 1)) &#123;</span><br><span class="line">        //counterCells数组不存在，获取锁，初始化counterCells数组</span><br><span class="line">            boolean init = false;</span><br><span class="line">            try &#123;                           // Initialize table</span><br><span class="line">                if (counterCells == as) &#123;</span><br><span class="line">                    CounterCell[] rs = new CounterCell[2];</span><br><span class="line">                    //添加计数</span><br><span class="line">                    rs[h &amp; 1] = new CounterCell(x);</span><br><span class="line">                    counterCells = rs;</span><br><span class="line">                    init = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                //释放锁</span><br><span class="line">                cellsBusy = 0;</span><br><span class="line">            &#125;</span><br><span class="line">            if (init)</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (U.compareAndSwapLong(this, BASECOUNT, v = baseCount, v + x))</span><br><span class="line">        //任然用baseCount计数</span><br><span class="line">            break;                          // Fall back on using base</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、ConcurrentHashMap的get方法"><a href="#12、ConcurrentHashMap的get方法" class="headerlink" title="12、ConcurrentHashMap的get方法"></a>12、ConcurrentHashMap的get方法</h4><p>获取元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public V get(Object key) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek;</span><br><span class="line">    //获取hash值</span><br><span class="line">    int h = spread(key.hashCode());</span><br><span class="line">    //获取hash值对应的数组中的链表</span><br><span class="line">    if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp;</span><br><span class="line">        (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123;</span><br><span class="line">        if ((eh = e.hash) == h) &#123;</span><br><span class="line">            if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))</span><br><span class="line">            //正好在表头</span><br><span class="line">                return e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (eh &lt; 0)</span><br><span class="line">            //从ForwardingNode或红黑树中获取</span><br><span class="line">            return (p = e.find(h, key)) != null ? p.val : null;</span><br><span class="line">        //从链表中逐一查找</span><br><span class="line">        while ((e = e.next) != null) &#123;</span><br><span class="line">            if (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))))</span><br><span class="line">                return e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="13、ForwardingNode的find方法"><a href="#13、ForwardingNode的find方法" class="headerlink" title="13、ForwardingNode的find方法"></a>13、ForwardingNode的find方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;K,V&gt; find(int h, Object k) &#123;</span><br><span class="line">    //从新数组里获取链表</span><br><span class="line">    outer: for (Node&lt;K,V&gt;[] tab = nextTable;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; int n;</span><br><span class="line">        if (k == null || tab == null || (n = tab.length) == 0 ||</span><br><span class="line">            (e = tabAt(tab, (n - 1) &amp; h)) == null)</span><br><span class="line">            //数组该索引位置为空</span><br><span class="line">            return null;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            int eh; K ek;</span><br><span class="line">            if ((eh = e.hash) == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek))))</span><br><span class="line">                //从链表中查找到</span><br><span class="line">                return e;</span><br><span class="line">            if (eh &lt; 0) &#123;</span><br><span class="line">                //再次扩容，从下个数组中查找</span><br><span class="line">                if (e instanceof ForwardingNode) &#123;</span><br><span class="line">                    tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                    continue outer;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                    //从红黑树中查找</span><br><span class="line">                    return e.find(h, k);</span><br><span class="line">            &#125;</span><br><span class="line">            if ((e = e.next) == null)</span><br><span class="line">                return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、ConcurrentHashMap的remove方法"><a href="#14、ConcurrentHashMap的remove方法" class="headerlink" title="14、ConcurrentHashMap的remove方法"></a>14、ConcurrentHashMap的remove方法</h4><p>删除元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public V remove(Object key) &#123;</span><br><span class="line">    return replaceNode(key, null, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="15、ConcurrentHashMap的replaceNode方法"><a href="#15、ConcurrentHashMap的replaceNode方法" class="headerlink" title="15、ConcurrentHashMap的replaceNode方法"></a>15、ConcurrentHashMap的replaceNode方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">final V replaceNode(Object key, V value, Object cv) &#123;</span><br><span class="line">    int hash = spread(key.hashCode());</span><br><span class="line">    for (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; int n, i, fh;</span><br><span class="line">        if (tab == null || (n = tab.length) == 0 ||</span><br><span class="line">            (f = tabAt(tab, i = (n - 1) &amp; hash)) == null)</span><br><span class="line">            //未找到该元素</span><br><span class="line">            break;</span><br><span class="line">        else if ((fh = f.hash) == MOVED)</span><br><span class="line">            //正在扩容数组，帮助扩容</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        else &#123;</span><br><span class="line">            V oldVal = null;</span><br><span class="line">            boolean validated = false;</span><br><span class="line">            //获取f的对象锁</span><br><span class="line">            synchronized (f) &#123;</span><br><span class="line">                if (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    if (fh &gt;= 0) &#123;</span><br><span class="line">                    //正常节点</span><br><span class="line">                        validated = true;</span><br><span class="line">                        //遍历链表</span><br><span class="line">                        for (Node&lt;K,V&gt; e = f, pred = null;;) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            if (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != null &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                V ev = e.val;</span><br><span class="line">                                if (cv == null || cv == ev ||</span><br><span class="line">                                    (ev != null &amp;&amp; cv.equals(ev))) &#123;</span><br><span class="line">                                    oldVal = ev;</span><br><span class="line">                                    if (value != null)</span><br><span class="line">                                        //替换</span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    else if (pred != null)</span><br><span class="line">                                        //删除</span><br><span class="line">                                        pred.next = e.next;</span><br><span class="line">                                    else</span><br><span class="line">                                        //删除</span><br><span class="line">                                        setTabAt(tab, i, e.next);</span><br><span class="line">                                &#125;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                            pred = e;</span><br><span class="line">                            if ((e = e.next) == null)</span><br><span class="line">                                break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else if (f instanceof TreeBin) &#123;</span><br><span class="line">                    //f为红黑树</span><br><span class="line">                        validated = true;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                        //从红黑树中查找到该节点</span><br><span class="line">                        if ((r = t.root) != null &amp;&amp;</span><br><span class="line">                            (p = r.findTreeNode(hash, key, null)) != null) &#123;</span><br><span class="line">                            V pv = p.val;</span><br><span class="line">                            if (cv == null || cv == pv ||</span><br><span class="line">                                (pv != null &amp;&amp; cv.equals(pv))) &#123;</span><br><span class="line">                                oldVal = pv;</span><br><span class="line">                                if (value != null)</span><br><span class="line">                                    //替换</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                                else if (t.removeTreeNode(p))</span><br><span class="line">                                //红黑树删除该节点，并返回是否需要将红黑树转换回链表</span><br><span class="line">                                    setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (validated) &#123;</span><br><span class="line">                if (oldVal != null) &#123;</span><br><span class="line">                    if (value == null)</span><br><span class="line">                        //数量减一</span><br><span class="line">                        addCount(-1L, -1);</span><br><span class="line">                    return oldVal;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、红黑树TreeBin"><a href="#二、红黑树TreeBin" class="headerlink" title="二、红黑树TreeBin"></a>二、红黑树TreeBin</h3><h4 id="1、实例化TreeBin"><a href="#1、实例化TreeBin" class="headerlink" title="1、实例化TreeBin"></a>1、实例化TreeBin</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = TreeBin.class;</span><br><span class="line">        //根节点root锁的位置偏移</span><br><span class="line">        LOCKSTATE = U.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;lockState&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造红黑树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">TreeBin(TreeNode&lt;K,V&gt; b) &#123;</span><br><span class="line">    super(TREEBIN, null, null, null);</span><br><span class="line">    //红黑树中同时维护了一个双向队列</span><br><span class="line">    this.first = b;</span><br><span class="line">    TreeNode&lt;K,V&gt; r = null;</span><br><span class="line">    //逐个处理节点</span><br><span class="line">    for (TreeNode&lt;K,V&gt; x = b, next; x != null; x = next) &#123;</span><br><span class="line">        next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class="line">        x.left = x.right = null;</span><br><span class="line">        if (r == null) &#123;</span><br><span class="line">        //尚未有根节点，当前节点设置为根节点</span><br><span class="line">            x.parent = null;</span><br><span class="line">            x.red = false;</span><br><span class="line">            r = x;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            K k = x.key;</span><br><span class="line">            int h = x.hash;</span><br><span class="line">            Class&lt;?&gt; kc = null;</span><br><span class="line">            //查找新增节点的父节点，并新增</span><br><span class="line">            for (TreeNode&lt;K,V&gt; p = r;;) &#123;</span><br><span class="line">                int dir, ph;</span><br><span class="line">                K pk = p.key;</span><br><span class="line">                //hash小的在左边，大的在右边</span><br><span class="line">                if ((ph = p.hash) &gt; h)</span><br><span class="line">                    dir = -1;</span><br><span class="line">                else if (ph &lt; h)</span><br><span class="line">                    dir = 1;</span><br><span class="line">                else if ((kc == null &amp;&amp;</span><br><span class="line">                          (kc = comparableClassFor(k)) == null) ||</span><br><span class="line">                         (dir = compareComparables(kc, k, pk)) == 0)</span><br><span class="line">                //先用比较器比较</span><br><span class="line">                    //先用类名比较，不成功则用内存地址比较</span><br><span class="line">                    dir = tieBreakOrder(k, pk);</span><br><span class="line">                    TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">                //找到新增节点应当添加的位置</span><br><span class="line">                if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123;</span><br><span class="line">                    x.parent = xp;</span><br><span class="line">                    //对象不等但无法区分大小,也存入左子结点</span><br><span class="line">                    if (dir &lt;= 0)</span><br><span class="line">                        xp.left = x;</span><br><span class="line">                    else</span><br><span class="line">                        xp.right = x;</span><br><span class="line">                    //新增节点之后，平衡红黑树</span><br><span class="line">                    r = balanceInsertion(r, x);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    this.root = r;</span><br><span class="line">    assert checkInvariants(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、TreeBin的balanceInsertion方法"><a href="#2、TreeBin的balanceInsertion方法" class="headerlink" title="2、TreeBin的balanceInsertion方法"></a>2、TreeBin的balanceInsertion方法</h4><p>新增节点后，平衡红黑树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceInsertion(TreeNode&lt;K,V&gt; root,</span><br><span class="line">                                                TreeNode&lt;K,V&gt; x) &#123;</span><br><span class="line">    //新增节点默认红色</span><br><span class="line">    x.red = true;</span><br><span class="line">    for (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</span><br><span class="line">        if ((xp = x.parent) == null) &#123;</span><br><span class="line">        //新增节点为根节点，直接染黑</span><br><span class="line">            x.red = false;</span><br><span class="line">            return x;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (!xp.red || (xpp = xp.parent) == null)</span><br><span class="line">        //父节点为黑色，或者父节点为根节点，无须处理</span><br><span class="line">            return root;</span><br><span class="line">        if (xp == (xppl = xpp.left)) &#123;</span><br><span class="line">        //新增节点的父节点为左子结点</span><br><span class="line">            if ((xppr = xpp.right) != null &amp;&amp; xppr.red) &#123;</span><br><span class="line">            //新增节点的父节点的兄弟节点为红色</span><br><span class="line">            //已知父节点为红色，将父节点和叔叔节点同时设置为黑色，</span><br><span class="line">            //把爷爷节点染红，当成新增节点继续处理</span><br><span class="line">                xppr.red = false;</span><br><span class="line">                xp.red = false;</span><br><span class="line">                xpp.red = true;</span><br><span class="line">                x = xpp;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">            //叔叔节点为黑色</span><br><span class="line">                if (x == xp.right) &#123;</span><br><span class="line">                //新增节点为右子节点</span><br><span class="line">                    //将父节点当成新增节点，并左旋</span><br><span class="line">                    root = rotateLeft(root, x = xp);</span><br><span class="line">                    //我觉得x.parent不会出现null？？</span><br><span class="line">                    xpp = (xp = x.parent) == null ? null : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                //父节点和爷爷节点互换颜色</span><br><span class="line">                //右旋爷爷节点</span><br><span class="line">                if (xp != null) &#123;</span><br><span class="line">                    xp.red = false;</span><br><span class="line">                    if (xpp != null) &#123;</span><br><span class="line">                        xpp.red = true;</span><br><span class="line">                        root = rotateRight(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">        //新增节点的父节点为右子结点，处理过程与之前对称</span><br><span class="line">            if (xppl != null &amp;&amp; xppl.red) &#123;</span><br><span class="line">                xppl.red = false;</span><br><span class="line">                xp.red = false;</span><br><span class="line">                xpp.red = true;</span><br><span class="line">                x = xpp;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (x == xp.left) &#123;</span><br><span class="line">                    root = rotateRight(root, x = xp);</span><br><span class="line">                    xpp = (xp = x.parent) == null ? null : xp.parent;</span><br><span class="line">                &#125;</span><br><span class="line">                if (xp != null) &#123;</span><br><span class="line">                    xp.red = false;</span><br><span class="line">                    if (xpp != null) &#123;</span><br><span class="line">                        xpp.red = true;</span><br><span class="line">                        root = rotateLeft(root, xpp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、TreeBin的putTreeVal方法"><a href="#3、TreeBin的putTreeVal方法" class="headerlink" title="3、TreeBin的putTreeVal方法"></a>3、TreeBin的putTreeVal方法</h4><p>新增节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">final TreeNode&lt;K,V&gt; putTreeVal(int h, K k, V v) &#123;</span><br><span class="line">    Class&lt;?&gt; kc = null;</span><br><span class="line">    boolean searched = false;</span><br><span class="line">    //查找新增节点的父节点，并新增</span><br><span class="line">    for (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">        int dir, ph; K pk;</span><br><span class="line">        if (p == null) &#123;</span><br><span class="line">            //红黑树尚未有节点，新增节点为第一个节点</span><br><span class="line">            first = root = new TreeNode&lt;K,V&gt;(h, k, v, null, null);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        else if ((ph = p.hash) &gt; h)</span><br><span class="line">            dir = -1;</span><br><span class="line">        else if (ph &lt; h)</span><br><span class="line">            dir = 1;</span><br><span class="line">        else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk)))</span><br><span class="line">            //已存在该节点</span><br><span class="line">            return p;</span><br><span class="line">        else if ((kc == null &amp;&amp;</span><br><span class="line">                  (kc = comparableClassFor(k)) == null) ||</span><br><span class="line">                 (dir = compareComparables(kc, k, pk)) == 0) &#123;</span><br><span class="line">            //查找红黑树中是否已存在key</span><br><span class="line">            if (!searched) &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                searched = true;</span><br><span class="line">                if (((ch = p.left) != null &amp;&amp;</span><br><span class="line">                     (q = ch.findTreeNode(h, k, kc)) != null) ||</span><br><span class="line">                    ((ch = p.right) != null &amp;&amp;</span><br><span class="line">                     (q = ch.findTreeNode(h, k, kc)) != null))</span><br><span class="line">                    return q;</span><br><span class="line">            &#125;</span><br><span class="line">            dir = tieBreakOrder(k, pk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">        //找到新增节点的父节点</span><br><span class="line">        if ((p = (dir &lt;= 0) ? p.left : p.right) == null) &#123;</span><br><span class="line">            TreeNode&lt;K,V&gt; x, f = first;</span><br><span class="line">            //创建新节点，放在队首</span><br><span class="line">            first = x = new TreeNode&lt;K,V&gt;(h, k, v, f, xp);</span><br><span class="line">            if (f != null)</span><br><span class="line">                f.prev = x;</span><br><span class="line">            if (dir &lt;= 0)</span><br><span class="line">                xp.left = x;</span><br><span class="line">            else</span><br><span class="line">                xp.right = x;</span><br><span class="line">            if (!xp.red)</span><br><span class="line">                //新增节点默认为红色</span><br><span class="line">                x.red = true;</span><br><span class="line">            else &#123;</span><br><span class="line">                //获取根节点锁</span><br><span class="line">                lockRoot();</span><br><span class="line">                try &#123;</span><br><span class="line">                    //新增后，平衡红黑树</span><br><span class="line">                    root = balanceInsertion(root, x);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    //释放锁</span><br><span class="line">                    unlockRoot();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    assert checkInvariants(root);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、TreeBin的lockRoot方法"><a href="#4、TreeBin的lockRoot方法" class="headerlink" title="4、TreeBin的lockRoot方法"></a>4、TreeBin的lockRoot方法</h4><p>获取根节点锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private final void lockRoot() &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    if (!U.compareAndSwapInt(this, LOCKSTATE, 0, WRITER))</span><br><span class="line">        //获取失败，进入等待</span><br><span class="line">        contendedLock(); // offload to separate method</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5、TreeBin的contendedLock方法"><a href="#5、TreeBin的contendedLock方法" class="headerlink" title="5、TreeBin的contendedLock方法"></a>5、TreeBin的contendedLock方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private final void contendedLock() &#123;</span><br><span class="line">    boolean waiting = false;</span><br><span class="line">    for (int s;;) &#123;</span><br><span class="line">        if (((s = lockState) &amp; ~WAITER) == 0) &#123;</span><br><span class="line">        //锁未被获取，读和写均未被获取</span><br><span class="line">            //获取写锁</span><br><span class="line">            if (U.compareAndSwapInt(this, LOCKSTATE, s, WRITER)) &#123;</span><br><span class="line">                if (waiting)</span><br><span class="line">                    waiter = null;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if ((s &amp; WAITER) == 0) &#123;</span><br><span class="line">        //没有等待线程</span><br><span class="line">            //获取等待锁</span><br><span class="line">            if (U.compareAndSwapInt(this, LOCKSTATE, s, s | WAITER)) &#123;</span><br><span class="line">                waiting = true;</span><br><span class="line">                waiter = Thread.currentThread();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (waiting)</span><br><span class="line">            //阻塞线程</span><br><span class="line">            LockSupport.park(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、TreeBin的unlockRoot方法"><a href="#6、TreeBin的unlockRoot方法" class="headerlink" title="6、TreeBin的unlockRoot方法"></a>6、TreeBin的unlockRoot方法</h4><p>释放根节点锁<br>写操作时，会锁整个节点，因此不会存在线程等待些操作，而读操作在这种情况下会直接查找队列，因此不会存在等待线程<br>读操作时，可能会存在线程等待写操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private final void unlockRoot() &#123;</span><br><span class="line">    lockState = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、TreeBin的find方法"><a href="#7、TreeBin的find方法" class="headerlink" title="7、TreeBin的find方法"></a>7、TreeBin的find方法</h4><p>查找元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">final Node&lt;K,V&gt; find(int h, Object k) &#123;</span><br><span class="line">    if (k != null) &#123;</span><br><span class="line">        for (Node&lt;K,V&gt; e = first; e != null; ) &#123;</span><br><span class="line">            int s; K ek;</span><br><span class="line">            if (((s = lockState) &amp; (WAITER|WRITER)) != 0) &#123;</span><br><span class="line">            //根节点锁，已被获取，从队列中查找</span><br><span class="line">                if (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek))))</span><br><span class="line">                    return e;</span><br><span class="line">                e = e.next;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (U.compareAndSwapInt(this, LOCKSTATE, s,</span><br><span class="line">                                         s + READER)) &#123;</span><br><span class="line">            //获取读锁</span><br><span class="line">                TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //从红黑树中查找</span><br><span class="line">                    p = ((r = root) == null ? null :</span><br><span class="line">                         r.findTreeNode(h, k, null));</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    Thread w;</span><br><span class="line">                    //释放读锁，若完全释放读锁，且存在等待线程，则唤醒等待线程</span><br><span class="line">                    if (U.getAndAddInt(this, LOCKSTATE, -READER) ==</span><br><span class="line">                        (READER|WAITER) &amp;&amp; (w = waiter) != null)</span><br><span class="line">                        LockSupport.unpark(w);</span><br><span class="line">                &#125;</span><br><span class="line">                return p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、TreeBin的findTreeNode方法"><a href="#8、TreeBin的findTreeNode方法" class="headerlink" title="8、TreeBin的findTreeNode方法"></a>8、TreeBin的findTreeNode方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">final TreeNode&lt;K,V&gt; findTreeNode(int h, Object k, Class&lt;?&gt; kc) &#123;</span><br><span class="line">    if (k != null) &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; p = this;</span><br><span class="line">        do  &#123;</span><br><span class="line">            int ph, dir; K pk; TreeNode&lt;K,V&gt; q;</span><br><span class="line">            TreeNode&lt;K,V&gt; pl = p.left, pr = p.right;</span><br><span class="line">            if ((ph = p.hash) &gt; h)</span><br><span class="line">            //往左查找</span><br><span class="line">                p = pl;</span><br><span class="line">            else if (ph &lt; h)</span><br><span class="line">            //往右查找</span><br><span class="line">                p = pr;</span><br><span class="line">            else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk)))</span><br><span class="line">            //已找到</span><br><span class="line">                return p;</span><br><span class="line">            else if (pl == null)</span><br><span class="line">                p = pr;</span><br><span class="line">            else if (pr == null)</span><br><span class="line">                p = pl;</span><br><span class="line">            else if ((kc != null ||</span><br><span class="line">                      (kc = comparableClassFor(k)) != null) &amp;&amp;</span><br><span class="line">                     (dir = compareComparables(kc, k, pk)) != 0)</span><br><span class="line">            //hash值相等，对象不相等，进一步比较</span><br><span class="line">                p = (dir &lt; 0) ? pl : pr;</span><br><span class="line">            else if ((q = pr.findTreeNode(h, k, kc)) != null)</span><br><span class="line">                //对象不等但无法区分大小，向右查找</span><br><span class="line">                return q;</span><br><span class="line">            else</span><br><span class="line">                p = pl;</span><br><span class="line">        &#125; while (p != null);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、TreeBin的removeTreeNode方法"><a href="#9、TreeBin的removeTreeNode方法" class="headerlink" title="9、TreeBin的removeTreeNode方法"></a>9、TreeBin的removeTreeNode方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">final boolean removeTreeNode(TreeNode&lt;K,V&gt; p) &#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; next = (TreeNode&lt;K,V&gt;)p.next;</span><br><span class="line">    TreeNode&lt;K,V&gt; pred = p.prev;  // unlink traversal pointers</span><br><span class="line">    TreeNode&lt;K,V&gt; r, rl;</span><br><span class="line">    if (pred == null)</span><br><span class="line">    //删除的是队首</span><br><span class="line">        first = next;</span><br><span class="line">    else</span><br><span class="line">        pred.next = next;</span><br><span class="line">    if (next != null)</span><br><span class="line">        next.prev = pred;</span><br><span class="line">    //删除了最后一个节点</span><br><span class="line">    if (first == null) &#123;</span><br><span class="line">        root = null;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    //节点过少</span><br><span class="line">    if ((r = root) == null || r.right == null || // too small</span><br><span class="line">        (rl = r.left) == null || rl.left == null)</span><br><span class="line">        return true;</span><br><span class="line">    //获取根节点锁</span><br><span class="line">    lockRoot();</span><br><span class="line">    try &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; replacement;</span><br><span class="line">        TreeNode&lt;K,V&gt; pl = p.left;</span><br><span class="line">        TreeNode&lt;K,V&gt; pr = p.right;</span><br><span class="line">        if (pl != null &amp;&amp; pr != null) &#123;</span><br><span class="line">        //待删除节点有两个子节点</span><br><span class="line">            TreeNode&lt;K,V&gt; s = pr, sl;</span><br><span class="line">            //找到后继节点</span><br><span class="line">            while ((sl = s.left) != null) // find successor</span><br><span class="line">                s = sl;</span><br><span class="line">            //交换节点颜色</span><br><span class="line">            boolean c = s.red; s.red = p.red; p.red = c; // swap colors</span><br><span class="line">            //交换节点位置</span><br><span class="line">            TreeNode&lt;K,V&gt; sr = s.right;</span><br><span class="line">            TreeNode&lt;K,V&gt; pp = p.parent;</span><br><span class="line">            if (s == pr) &#123; // p was s&apos;s direct parent</span><br><span class="line">            //后继节点刚好为删除节点的右子节点</span><br><span class="line">                p.parent = s;</span><br><span class="line">                s.right = p;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sp = s.parent;</span><br><span class="line">                if ((p.parent = sp) != null) &#123;</span><br><span class="line">                    if (s == sp.left)</span><br><span class="line">                        sp.left = p;</span><br><span class="line">                    else</span><br><span class="line">                        sp.right = p;</span><br><span class="line">                &#125;</span><br><span class="line">                if ((s.right = pr) != null)</span><br><span class="line">                    pr.parent = s;</span><br><span class="line">            &#125;</span><br><span class="line">            p.left = null;</span><br><span class="line">            if ((p.right = sr) != null)</span><br><span class="line">                sr.parent = p;</span><br><span class="line">            if ((s.left = pl) != null)</span><br><span class="line">                pl.parent = s;</span><br><span class="line">            if ((s.parent = pp) == null)</span><br><span class="line">                r = s;</span><br><span class="line">            else if (p == pp.left)</span><br><span class="line">                pp.left = s;</span><br><span class="line">            else</span><br><span class="line">                pp.right = s;</span><br><span class="line">            //删除后的替代节点</span><br><span class="line">            if (sr != null)</span><br><span class="line">                replacement = sr;</span><br><span class="line">            else</span><br><span class="line">                replacement = p;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (pl != null)</span><br><span class="line">        //待删除节点只有左子结点</span><br><span class="line">            replacement = pl;</span><br><span class="line">        else if (pr != null)</span><br><span class="line">        //待删除节点只有右子结点</span><br><span class="line">            replacement = pr;</span><br><span class="line">        else</span><br><span class="line">        //待删除节点没有子结点</span><br><span class="line">            replacement = p;</span><br><span class="line">        if (replacement != p) &#123;</span><br><span class="line">        //删除后，替代操作</span><br><span class="line">            TreeNode&lt;K,V&gt; pp = replacement.parent = p.parent;</span><br><span class="line">            if (pp == null)</span><br><span class="line">                r = replacement;</span><br><span class="line">            else if (p == pp.left)</span><br><span class="line">                pp.left = replacement;</span><br><span class="line">            else</span><br><span class="line">                pp.right = replacement;</span><br><span class="line">            p.left = p.right = p.parent = null;</span><br><span class="line">        &#125;</span><br><span class="line">        //删除节点为红色则不处理，否则平衡红黑树</span><br><span class="line">        root = (p.red) ? r : balanceDeletion(r, replacement);</span><br><span class="line">        //无替代节点</span><br><span class="line">        if (p == replacement) &#123;  // detach pointers</span><br><span class="line">            TreeNode&lt;K,V&gt; pp;</span><br><span class="line">            if ((pp = p.parent) != null) &#123;</span><br><span class="line">                if (p == pp.left)</span><br><span class="line">                    pp.left = null;</span><br><span class="line">                else if (p == pp.right)</span><br><span class="line">                    pp.right = null;</span><br><span class="line">                p.parent = null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放锁</span><br><span class="line">        unlockRoot();</span><br><span class="line">    &#125;</span><br><span class="line">    assert checkInvariants(root);</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、TreeBin的balanceDeletion方法"><a href="#10、TreeBin的balanceDeletion方法" class="headerlink" title="10、TreeBin的balanceDeletion方法"></a>10、TreeBin的balanceDeletion方法</h4><p>删除节点后，平衡红黑树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceDeletion(TreeNode&lt;K,V&gt; root,</span><br><span class="line">                                               TreeNode&lt;K,V&gt; x) &#123;</span><br><span class="line">    for (TreeNode&lt;K,V&gt; xp, xpl, xpr;;)  &#123;</span><br><span class="line">        if (x == null || x == root)</span><br><span class="line">            //x迭代到根节点</span><br><span class="line">            return root;</span><br><span class="line">        else if ((xp = x.parent) == null) &#123;</span><br><span class="line">            //x迭代到根节点，染黑</span><br><span class="line">            x.red = false;</span><br><span class="line">            return x;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (x.red) &#123;</span><br><span class="line">            //新x节点为红色，直接染黑</span><br><span class="line">            x.red = false;</span><br><span class="line">            return root;</span><br><span class="line">        &#125;</span><br><span class="line">        else if ((xpl = xp.left) == x) &#123;</span><br><span class="line">        //删除节点为左子节点</span><br><span class="line">            //兄弟节点为红色</span><br><span class="line">            //兄弟节点和父节点互换颜色，左旋父节点</span><br><span class="line">            if ((xpr = xp.right) != null &amp;&amp; xpr.red) &#123;</span><br><span class="line">                xpr.red = false;</span><br><span class="line">                xp.red = true;</span><br><span class="line">                root = rotateLeft(root, xp);</span><br><span class="line">                //更新兄弟节点</span><br><span class="line">                xpr = (xp = x.parent) == null ? null : xp.right;</span><br><span class="line">            &#125;</span><br><span class="line">            if (xpr == null)</span><br><span class="line">            //兄弟节点不可能为null？？？</span><br><span class="line">                x = xp;</span><br><span class="line">            else &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sl = xpr.left, sr = xpr.right;</span><br><span class="line">                if ((sr == null || !sr.red) &amp;&amp;</span><br><span class="line">                    (sl == null || !sl.red)) &#123;</span><br><span class="line">                    //兄弟节点为黑色，兄弟节点的子节点都为黑色</span><br><span class="line">                    //染红兄弟节点，将父节点作为新的x节点,继续迭代</span><br><span class="line">                    xpr.red = true;</span><br><span class="line">                    x = xp;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    //兄弟节点的右子节点为黑色，左子节点为红色</span><br><span class="line">                    //兄弟节点与左子节点互换颜色，右旋兄弟节点</span><br><span class="line">                    if (sr == null || !sr.red) &#123;</span><br><span class="line">                        if (sl != null)</span><br><span class="line">                            sl.red = false;</span><br><span class="line">                        xpr.red = true;</span><br><span class="line">                        root = rotateRight(root, xpr);</span><br><span class="line">                        xpr = (xp = x.parent) == null ?</span><br><span class="line">                            null : xp.right;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //兄弟节点的右子节点为红色，左子节点随意</span><br><span class="line">                    //兄弟节点和父节点互换颜色，左旋父节点，染黑兄弟节点的右子节点</span><br><span class="line">                    if (xpr != null) &#123;</span><br><span class="line">                        xpr.red = (xp == null) ? false : xp.red;</span><br><span class="line">                        if ((sr = xpr.right) != null)</span><br><span class="line">                            sr.red = false;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (xp != null) &#123;</span><br><span class="line">                        xp.red = false;</span><br><span class="line">                        root = rotateLeft(root, xp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123; </span><br><span class="line">        //删除节点为右子节点，与之前对称</span><br><span class="line">            if (xpl != null &amp;&amp; xpl.red) &#123;</span><br><span class="line">                xpl.red = false;</span><br><span class="line">                xp.red = true;</span><br><span class="line">                root = rotateRight(root, xp);</span><br><span class="line">                xpl = (xp = x.parent) == null ? null : xp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            if (xpl == null)</span><br><span class="line">                x = xp;</span><br><span class="line">            else &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; sl = xpl.left, sr = xpl.right;</span><br><span class="line">                if ((sl == null || !sl.red) &amp;&amp;</span><br><span class="line">                    (sr == null || !sr.red)) &#123;</span><br><span class="line">                    xpl.red = true;</span><br><span class="line">                    x = xp;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    if (sl == null || !sl.red) &#123;</span><br><span class="line">                        if (sr != null)</span><br><span class="line">                            sr.red = false;</span><br><span class="line">                        xpl.red = true;</span><br><span class="line">                        root = rotateLeft(root, xpl);</span><br><span class="line">                        xpl = (xp = x.parent) == null ?</span><br><span class="line">                            null : xp.left;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (xpl != null) &#123;</span><br><span class="line">                        xpl.red = (xp == null) ? false : xp.red;</span><br><span class="line">                        if ((sl = xpl.left) != null)</span><br><span class="line">                            sl.red = false;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (xp != null) &#123;</span><br><span class="line">                        xp.red = false;</span><br><span class="line">                        root = rotateRight(root, xp);</span><br><span class="line">                    &#125;</span><br><span class="line">                    x = root;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="11、TreeBin的rotateLeft方法"><a href="#11、TreeBin的rotateLeft方法" class="headerlink" title="11、TreeBin的rotateLeft方法"></a>11、TreeBin的rotateLeft方法</h4><p>左旋<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static &lt;K,V&gt; TreeNode&lt;K,V&gt; rotateLeft(TreeNode&lt;K,V&gt; root,</span><br><span class="line">                                          TreeNode&lt;K,V&gt; p) &#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; r, pp, rl;</span><br><span class="line">    if (p != null &amp;&amp; (r = p.right) != null) &#123;</span><br><span class="line">        if ((rl = p.right = r.left) != null)</span><br><span class="line">            rl.parent = p;</span><br><span class="line">        if ((pp = r.parent = p.parent) == null)</span><br><span class="line">            (root = r).red = false;</span><br><span class="line">        else if (pp.left == p)</span><br><span class="line">            pp.left = r;</span><br><span class="line">        else</span><br><span class="line">            pp.right = r;</span><br><span class="line">        r.left = p;</span><br><span class="line">        p.parent = r;</span><br><span class="line">    &#125;</span><br><span class="line">    return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="12、TreeBin的rotateRight方法"><a href="#12、TreeBin的rotateRight方法" class="headerlink" title="12、TreeBin的rotateRight方法"></a>12、TreeBin的rotateRight方法</h4><p>右旋<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static &lt;K,V&gt; TreeNode&lt;K,V&gt; rotateRight(TreeNode&lt;K,V&gt; root,</span><br><span class="line">                                           TreeNode&lt;K,V&gt; p) &#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; l, pp, lr;</span><br><span class="line">    if (p != null &amp;&amp; (l = p.left) != null) &#123;</span><br><span class="line">        if ((lr = p.left = l.right) != null)</span><br><span class="line">            lr.parent = p;</span><br><span class="line">        if ((pp = l.parent = p.parent) == null)</span><br><span class="line">            (root = l).red = false;</span><br><span class="line">        else if (pp.right == p)</span><br><span class="line">            pp.right = l;</span><br><span class="line">        else</span><br><span class="line">            pp.left = l;</span><br><span class="line">        l.right = p;</span><br><span class="line">        p.parent = l;</span><br><span class="line">    &#125;</span><br><span class="line">    return root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、ConcurrentHashMap&quot;&gt;&lt;a href=&quot;#一、ConcurrentHashMap&quot; class=&quot;headerlink&quot; title=&quot;一、ConcurrentHashMap&quot;&gt;&lt;/a&gt;一、ConcurrentHashMap&lt;/h3&gt;&lt;h4 i
      
    
    </summary>
    
      <category term="java.util.concurrent" scheme="http://yoursite.com/categories/java-util-concurrent/"/>
    
    
  </entry>
  
  <entry>
    <title>JUC锁</title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E9%94%81/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC锁/</id>
    <published>2018-05-06T13:48:30.182Z</published>
    <updated>2018-06-28T14:03:29.277Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、独占锁ReentrantLock"><a href="#一、独占锁ReentrantLock" class="headerlink" title="一、独占锁ReentrantLock"></a>一、独占锁ReentrantLock</h3><h4 id="1、实例化ReentrantLock"><a href="#1、实例化ReentrantLock" class="headerlink" title="1、实例化ReentrantLock"></a>1、实例化ReentrantLock</h4><p>AbstractQueuedSynchronizer的静态代码块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //锁状态state字段，在AbstractQueuedSynchronizer对象中的地址偏移</span><br><span class="line">        stateOffset = unsafe.objectFieldOffset</span><br><span class="line">            (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;state&quot;));</span><br><span class="line">        //CLH队首head字段，在AbstractQueuedSynchronizer对象中的地址偏移</span><br><span class="line">        headOffset = unsafe.objectFieldOffset</span><br><span class="line">            (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;head&quot;));</span><br><span class="line">        //CLH队尾head字段，在AbstractQueuedSynchronizer对象中的地址偏移</span><br><span class="line">        tailOffset = unsafe.objectFieldOffset</span><br><span class="line">            (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;tail&quot;));</span><br><span class="line">        //节点状态waitStatus字段,在Node对象中的位置偏移</span><br><span class="line">        waitStatusOffset = unsafe.objectFieldOffset</span><br><span class="line">            (Node.class.getDeclaredField(&quot;waitStatus&quot;));</span><br><span class="line">        //后继节点next字段,在Node对象中的位置偏移</span><br><span class="line">        nextOffset = unsafe.objectFieldOffset</span><br><span class="line">            (Node.class.getDeclaredField(&quot;next&quot;));</span><br><span class="line">    &#125; catch (Exception ex) &#123; throw new Error(ex); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public ReentrantLock() &#123;</span><br><span class="line">    //默认非公平锁</span><br><span class="line">    sync = new NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ReentrantLock的lock方法"><a href="#2、ReentrantLock的lock方法" class="headerlink" title="2、ReentrantLock的lock方法"></a>2、ReentrantLock的lock方法</h4><p>lock方法获取锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void lock() &#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、NonfairSync的lock方法"><a href="#3、NonfairSync的lock方法" class="headerlink" title="3、NonfairSync的lock方法"></a>3、NonfairSync的lock方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">final void lock() &#123;</span><br><span class="line">    //锁状态state为0则表示锁空闲,state&gt;0则表示锁已被获取</span><br><span class="line">    //将state状态由0改为1</span><br><span class="line">    if (compareAndSetState(0, 1))</span><br><span class="line">        //成功则，设置锁的拥有线程为当前线程</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    else</span><br><span class="line">        //不成功，说明锁状态不为0，已被其他线程获取，则继续获取锁</span><br><span class="line">        acquire(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、AbstractQueuedSynchronizer的acquire方法"><a href="#4、AbstractQueuedSynchronizer的acquire方法" class="headerlink" title="4、AbstractQueuedSynchronizer的acquire方法"></a>4、AbstractQueuedSynchronizer的acquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final void acquire(int arg) &#123;</span><br><span class="line">    //尝试获取锁，失败则将线程加入等待队列</span><br><span class="line">    if (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        //acquireQueued会返回本线程是否中断</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、NonfairSync的tryAcquire方法"><a href="#5、NonfairSync的tryAcquire方法" class="headerlink" title="5、NonfairSync的tryAcquire方法"></a>5、NonfairSync的tryAcquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">    //尝试获取非公平锁</span><br><span class="line">    return nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、Sync的nonfairTryAcquire方法"><a href="#6、Sync的nonfairTryAcquire方法" class="headerlink" title="6、Sync的nonfairTryAcquire方法"></a>6、Sync的nonfairTryAcquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">final boolean nonfairTryAcquire(int acquires) &#123;</span><br><span class="line">    final Thread current = Thread.currentThread();</span><br><span class="line">    //获取state值</span><br><span class="line">    int c = getState();</span><br><span class="line">    //锁状态为0，锁空闲</span><br><span class="line">    if (c == 0) &#123;</span><br><span class="line">        //更改锁状态，成功则返回true</span><br><span class="line">        if (compareAndSetState(0, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        //锁已被本线程获取</span><br><span class="line">        //本线程再次获取锁</span><br><span class="line">        int nextc = c + acquires;</span><br><span class="line">        if (nextc &lt; 0) // overflow</span><br><span class="line">            throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">        //更新锁状态</span><br><span class="line">        setState(nextc);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（一、4）Node的addWaiter方法"><a href="#7、接（一、4）Node的addWaiter方法" class="headerlink" title="7、接（一、4）Node的addWaiter方法"></a>7、接（一、4）Node的addWaiter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private Node addWaiter(Node mode) &#123;</span><br><span class="line">    //创建新节点</span><br><span class="line">    Node node = new Node(Thread.currentThread(), mode);</span><br><span class="line">    //获取队尾节点</span><br><span class="line">    Node pred = tail;</span><br><span class="line">    //tail节点存在，则CLH队列不为空，则将“当前线程”添加到CLH队列末尾</span><br><span class="line">    if (pred != null) &#123;</span><br><span class="line">        //设置本节点的上个节点为队尾节点</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        //将本节点设置为队尾，成功则返回节点，失败则认为队尾已变更，本次操作失败</span><br><span class="line">        if (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            return node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 若CLH队列为空，则调用enq()新建CLH队列，然后再将“当前线程”添加到CLH队列中。</span><br><span class="line">    enq(node);</span><br><span class="line">    return node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、Node的enq方法"><a href="#8、Node的enq方法" class="headerlink" title="8、Node的enq方法"></a>8、Node的enq方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private Node enq(final Node node) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        if (t == null) &#123;</span><br><span class="line">        //队尾不存在，说明队列尚未建立</span><br><span class="line">            //创建一个空节点作为头节点</span><br><span class="line">            if (compareAndSetHead(new Node()))</span><br><span class="line">                //成功则将尾节点也设置为当前节点</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        //队列已建立</span><br><span class="line">            //操作与上个方法相同，成功则返回，不成功则重新循环</span><br><span class="line">            //头节点的前一个节点，是尾节点</span><br><span class="line">            node.prev = t;</span><br><span class="line">            if (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                return t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（一、4）AbstractQueuedSynchronizer的acquireQueued方法"><a href="#9、接（一、4）AbstractQueuedSynchronizer的acquireQueued方法" class="headerlink" title="9、接（一、4）AbstractQueuedSynchronizer的acquireQueued方法"></a>9、接（一、4）AbstractQueuedSynchronizer的acquireQueued方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">final boolean acquireQueued(final Node node, int arg) &#123;</span><br><span class="line">    boolean failed = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        // interrupted表示在CLH队列的调度中，</span><br><span class="line">        // “当前线程”在休眠时，有没有被中断过。</span><br><span class="line">        boolean interrupted = false;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            // 获取上一个节点。</span><br><span class="line">            final Node p = node.predecessor();</span><br><span class="line">            //若p为头节点，则尝试获取锁</span><br><span class="line">            if (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                //设置当前节点为头节点</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = null; // help GC</span><br><span class="line">                failed = false;</span><br><span class="line">                return interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            //当前线程应阻塞，则阻塞当前线程</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (failed)</span><br><span class="line">            //取消本节点</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、AbstractQueuedSynchronizer的shouldParkAfterFailedAcquire方法"><a href="#10、AbstractQueuedSynchronizer的shouldParkAfterFailedAcquire方法" class="headerlink" title="10、AbstractQueuedSynchronizer的shouldParkAfterFailedAcquire方法"></a>10、AbstractQueuedSynchronizer的shouldParkAfterFailedAcquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123;</span><br><span class="line">    // 前继节点的状态</span><br><span class="line">    int ws = pred.waitStatus;</span><br><span class="line">    if (ws == Node.SIGNAL)</span><br><span class="line">        //前继节点的后继节点，在前继节点释放或取消时，需要唤醒后继节点</span><br><span class="line">        return true;</span><br><span class="line">    if (ws &gt; 0) &#123;</span><br><span class="line">         // 如果前继节点是前取消状态，则设置当前节点的前继节点为原前继节点的前继节点。</span><br><span class="line">        do &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; while (pred.waitStatus &gt; 0);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 如果前继节点为0或者共享锁状态，则设置前继节点为SIGNAL状态。</span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>waitStatus的状态如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CANCELLED[1]  -- 当前线程已被取消</span><br><span class="line">SIGNAL[-1]    -- “当前线程的后继线程需要被unpark(唤醒)”。</span><br><span class="line">    一般发生情况是：当前线程的后继线程处于阻塞状态，而当前线程被release或cancel掉，因此需要唤醒当前线程的后继线程。</span><br><span class="line">CONDITION[-2] -- 当前线程(处在Condition休眠状态)在等待Condition唤醒</span><br><span class="line">PROPAGATE[-3] -- (共享锁)其它线程获取到“共享锁”</span><br><span class="line">[0]           -- 当前线程不属于上面的任何一种状态。</span><br></pre></td></tr></table></figure></p><h4 id="11、接（一、9）AbstractQueuedSynchronizer的parkAndCheckInterrupt方法"><a href="#11、接（一、9）AbstractQueuedSynchronizer的parkAndCheckInterrupt方法" class="headerlink" title="11、接（一、9）AbstractQueuedSynchronizer的parkAndCheckInterrupt方法"></a>11、接（一、9）AbstractQueuedSynchronizer的parkAndCheckInterrupt方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private final boolean parkAndCheckInterrupt() &#123;</span><br><span class="line">    // 通过LockSupport的park()阻塞“当前线程”。</span><br><span class="line">    LockSupport.park(this);</span><br><span class="line">    // 返回线程的中断状态。</span><br><span class="line">    return Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接（一、9）AbstractQueuedSynchronizer的cancelAcquire方法"><a href="#12、接（一、9）AbstractQueuedSynchronizer的cancelAcquire方法" class="headerlink" title="12、接（一、9）AbstractQueuedSynchronizer的cancelAcquire方法"></a>12、接（一、9）AbstractQueuedSynchronizer的cancelAcquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private void cancelAcquire(Node node) &#123;</span><br><span class="line">    // Ignore if node doesn&apos;t exist</span><br><span class="line">    if (node == null)</span><br><span class="line">        return;</span><br><span class="line">    //清空node对应的线程</span><br><span class="line">    node.thread = null;</span><br><span class="line">    //获取前继节点</span><br><span class="line">    Node pred = node.prev;</span><br><span class="line">    // 如果前继节点是前取消状态，则设置当前节点的前继节点为原前继节点的前继节点。</span><br><span class="line">    while (pred.waitStatus &gt; 0)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line">    //获取前继节点的后继节点</span><br><span class="line">    Node predNext = pred.next;</span><br><span class="line">    //设置当前节点状态为取消</span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line">    if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        //当前节点为队尾，设置队尾为前继节点</span><br><span class="line">        //设置前继节点的后继节点为null</span><br><span class="line">        compareAndSetNext(pred, predNext, null);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        int ws;</span><br><span class="line">        //前继节点不为头节点，设置前继节点状态为SIGNAL</span><br><span class="line">        if (pred != head &amp;&amp;</span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             (ws &lt;= 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            pred.thread != null) &#123;</span><br><span class="line">            Node next = node.next;</span><br><span class="line">            //后继节点存在且未取消</span><br><span class="line">            if (next != null &amp;&amp; next.waitStatus &lt;= 0)</span><br><span class="line">                //设置前继节点的后继节点为当前节点的后继节点</span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //唤醒后继节点</span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node; // help GC</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、AbstractQueuedSynchronizer的unparkSuccessor方法"><a href="#13、AbstractQueuedSynchronizer的unparkSuccessor方法" class="headerlink" title="13、AbstractQueuedSynchronizer的unparkSuccessor方法"></a>13、AbstractQueuedSynchronizer的unparkSuccessor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private void unparkSuccessor(Node node) &#123;</span><br><span class="line">    //获取节点状态</span><br><span class="line">    int ws = node.waitStatus;</span><br><span class="line">    // 如果状态&lt;0，则设置状态=0</span><br><span class="line">    if (ws &lt; 0)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, 0);</span><br><span class="line">    // 获取当前节点的有效的后继节点，无效的话，则通过for循环进行获取。</span><br><span class="line">    // 这里的有效，是指后继节点对应的线程状态&lt;=0</span><br><span class="line">    Node s = node.next;</span><br><span class="line">    if (s == null || s.waitStatus &gt; 0) &#123;</span><br><span class="line">        s = null;</span><br><span class="line">        //从队尾往前查找</span><br><span class="line">        for (Node t = tail; t != null &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            if (t.waitStatus &lt;= 0)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    // 唤醒后继节点对应的线程</span><br><span class="line">    if (s != null)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、ReentrantLock的unlock方法"><a href="#14、ReentrantLock的unlock方法" class="headerlink" title="14、ReentrantLock的unlock方法"></a>14、ReentrantLock的unlock方法</h4><p>unlock释放锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void unlock() &#123;</span><br><span class="line">    sync.release(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="15、NonfairSync的release方法"><a href="#15、NonfairSync的release方法" class="headerlink" title="15、NonfairSync的release方法"></a>15、NonfairSync的release方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public final boolean release(int arg) &#123;</span><br><span class="line">    //尝试释放锁</span><br><span class="line">    if (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        //头节点存在，且有效</span><br><span class="line">        if (h != null &amp;&amp; h.waitStatus != 0)</span><br><span class="line">            //唤醒头节点的后继节点</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、Sync的tryRelease方法"><a href="#16、Sync的tryRelease方法" class="headerlink" title="16、Sync的tryRelease方法"></a>16、Sync的tryRelease方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryRelease(int releases) &#123;</span><br><span class="line">    //释放一层锁</span><br><span class="line">    int c = getState() - releases;</span><br><span class="line">    if (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        throw new IllegalMonitorStateException();</span><br><span class="line">    boolean free = false;</span><br><span class="line">    //c为零表示完全释放</span><br><span class="line">    if (c == 0) &#123;</span><br><span class="line">        free = true;</span><br><span class="line">        setExclusiveOwnerThread(null);</span><br><span class="line">    &#125;</span><br><span class="line">    //更新锁状态</span><br><span class="line">    setState(c);</span><br><span class="line">    return free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、公平锁"><a href="#二、公平锁" class="headerlink" title="二、公平锁"></a>二、公平锁</h3><h4 id="1、实例化ReentrantLock-1"><a href="#1、实例化ReentrantLock-1" class="headerlink" title="1、实例化ReentrantLock"></a>1、实例化ReentrantLock</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ReentrantLock(boolean fair) &#123;</span><br><span class="line">    sync = fair ? new FairSync() : new NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、FairSync的lock方法"><a href="#2、FairSync的lock方法" class="headerlink" title="2、FairSync的lock方法"></a>2、FairSync的lock方法</h4><p>公平锁   – 公平锁的lock()函数，会直接调用acquire(1)。<br>非公平锁 – 非公平锁会先判断当前锁的状态是不是空闲，是的话，就不排队，而是直接获取锁。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">final void lock() &#123;</span><br><span class="line">    acquire(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、AbstractQueuedSynchronizer的acquire方法"><a href="#3、AbstractQueuedSynchronizer的acquire方法" class="headerlink" title="3、AbstractQueuedSynchronizer的acquire方法"></a>3、AbstractQueuedSynchronizer的acquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final void acquire(int arg) &#123;</span><br><span class="line">    //尝试获取锁，失败则将线程加入等待队列</span><br><span class="line">    if (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        //acquireQueued会返回本线程是否中断</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、FairSync的tryAcquire方法"><a href="#4、FairSync的tryAcquire方法" class="headerlink" title="4、FairSync的tryAcquire方法"></a>4、FairSync的tryAcquire方法</h4><p>公平锁在尝试获取锁时，即使“锁”没有被任何线程锁持有，它也会判断自己是不是CLH等待队列的表头；是的话，才获取锁。<br>非公平锁在尝试获取锁时，如果“锁”没有被任何线程持有，则不管它在CLH队列的何处，它都直接获取锁。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">    final Thread current = Thread.currentThread();</span><br><span class="line">    int c = getState();</span><br><span class="line">    if (c == 0) &#123;</span><br><span class="line">        //锁空闲，首先查看等待队列是否有线程等待，无线程等待或队首节点的后继节点是本线程，</span><br><span class="line">        //再去获取锁，否则获取失败</span><br><span class="line">        if (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            compareAndSetState(0, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        int nextc = c + acquires;</span><br><span class="line">        if (nextc &lt; 0)</span><br><span class="line">            throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="三、Condition条件"><a href="#三、Condition条件" class="headerlink" title="三、Condition条件"></a>三、Condition条件</h3><h4 id="1、ReentrantLock的newCondition方法"><a href="#1、ReentrantLock的newCondition方法" class="headerlink" title="1、ReentrantLock的newCondition方法"></a>1、ReentrantLock的newCondition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">final ConditionObject newCondition() &#123;</span><br><span class="line">    return new ConditionObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ConditionObject的await方法"><a href="#2、ConditionObject的await方法" class="headerlink" title="2、ConditionObject的await方法"></a>2、ConditionObject的await方法</h4><p>线程等待<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public final void await() throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    //往该条件等待队列队尾，添加一个等待线程节点</span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    //完全释放锁</span><br><span class="line">    long savedState = fullyRelease(node);</span><br><span class="line">    int interruptMode = 0;</span><br><span class="line">    //检查该节点是否在CLH队列中，不在则阻塞该线程。条件等待队列和CLH队列是两个不同的队列</span><br><span class="line">    while (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(this);</span><br><span class="line">        //检查线程中断，线程中断时，在条件等待队列中返回（THROW_IE），</span><br><span class="line">        //线程中断时不在条件等待队列中返回REINTERRUPT,线程未中断返回0</span><br><span class="line">        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    //node在CLH队列中重新获取锁</span><br><span class="line">    if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    //该节点的条件等待队列后继节点为空</span><br><span class="line">    if (node.nextWaiter != null) // clean up if cancelled</span><br><span class="line">        //去除队列里的无效节点</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    if (interruptMode != 0)</span><br><span class="line">        //THROW_IE中断则抛出异常，REINTERRUPT设置本线程中断标记</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、ConditionObject的addConditionWaiter方法"><a href="#3、ConditionObject的addConditionWaiter方法" class="headerlink" title="3、ConditionObject的addConditionWaiter方法"></a>3、ConditionObject的addConditionWaiter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private Node addConditionWaiter() &#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    //队尾节点无效</span><br><span class="line">    if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        //去除队列里的无效节点</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        //获取队尾节点</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    //本线程新建节点</span><br><span class="line">    Node node = new Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    if (t == null)</span><br><span class="line">        //队尾节点不存在，说明队列尚不存在，设置队首为本节点</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    else</span><br><span class="line">        //否则设置队尾节点的后继节点为本节点</span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    //设置队尾节点为本节点</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    return node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ConditionObject的unlinkCancelledWaiters方法"><a href="#4、ConditionObject的unlinkCancelledWaiters方法" class="headerlink" title="4、ConditionObject的unlinkCancelledWaiters方法"></a>4、ConditionObject的unlinkCancelledWaiters方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void unlinkCancelledWaiters() &#123;</span><br><span class="line">    //当前处理节点</span><br><span class="line">    Node t = firstWaiter;</span><br><span class="line">    //当前处理节点的前一个节点</span><br><span class="line">    Node trail = null;</span><br><span class="line">    while (t != null) &#123;</span><br><span class="line">        Node next = t.nextWaiter;</span><br><span class="line">        if (t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            //t节点无效</span><br><span class="line">            t.nextWaiter = null;</span><br><span class="line">            if (trail == null)</span><br><span class="line">                //当前节点不存在前继节点</span><br><span class="line">                //设置队首为后继节点</span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            else</span><br><span class="line">                //设置前继节点的后继节点为next</span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            if (next == null)</span><br><span class="line">                //next不存在设置trail为队尾</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            //当前节点有效，上一个节点设置为当前节点</span><br><span class="line">            trail = t;</span><br><span class="line">        //设置当前节点为当前节点的后一个节点</span><br><span class="line">        t = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（四、2）AbstractQueuedLongSynchronizer的unlinkCancelledWaiters方法"><a href="#5、接（四、2）AbstractQueuedLongSynchronizer的unlinkCancelledWaiters方法" class="headerlink" title="5、接（四、2）AbstractQueuedLongSynchronizer的unlinkCancelledWaiters方法"></a>5、接（四、2）AbstractQueuedLongSynchronizer的unlinkCancelledWaiters方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private void unlinkCancelledWaiters() &#123;</span><br><span class="line">    //当前处理节点</span><br><span class="line">    Node t = firstWaiter;</span><br><span class="line">    //当前处理节点的前一个节点</span><br><span class="line">    Node trail = null;</span><br><span class="line">    while (t != null) &#123;</span><br><span class="line">        Node next = t.nextWaiter;</span><br><span class="line">        if (t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            //t节点无效</span><br><span class="line">            t.nextWaiter = null;</span><br><span class="line">            if (trail == null)</span><br><span class="line">                //当前节点不存在前继节点</span><br><span class="line">                //设置队首为后继节点</span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            else</span><br><span class="line">                //设置前继节点的后继节点为next</span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            if (next == null)</span><br><span class="line">                //next不存在设置trail为队尾</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            //当前节点有效，上一个节点设置为当前节点</span><br><span class="line">            trail = t;</span><br><span class="line">        //设置当前节点为当前节点的后一个节点</span><br><span class="line">        t = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、ConditionObject的signal方法"><a href="#6、ConditionObject的signal方法" class="headerlink" title="6、ConditionObject的signal方法"></a>6、ConditionObject的signal方法</h4><p>按顺序唤醒该条件等待的一个线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final void signal() &#123;</span><br><span class="line">    //拥有该锁的线程必须是本线程</span><br><span class="line">    if (!isHeldExclusively())</span><br><span class="line">        throw new IllegalMonitorStateException();</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    if (first != null)</span><br><span class="line">        //唤醒队首</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、ConditionObject的doSignal方法"><a href="#7、ConditionObject的doSignal方法" class="headerlink" title="7、ConditionObject的doSignal方法"></a>7、ConditionObject的doSignal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void doSignal(Node first) &#123;</span><br><span class="line">    do &#123;</span><br><span class="line">        //firstWaiter的后继节点等于null,设置队首队尾为null</span><br><span class="line">        if ( (firstWaiter = first.nextWaiter) == null)</span><br><span class="line">            lastWaiter = null;</span><br><span class="line">        first.nextWaiter = null;</span><br><span class="line">        //节点加入CLH队列，失败则处理下一个</span><br><span class="line">    &#125; while (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、ConditionObject的transferForSignal方法"><a href="#8、ConditionObject的transferForSignal方法" class="headerlink" title="8、ConditionObject的transferForSignal方法"></a>8、ConditionObject的transferForSignal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">final boolean transferForSignal(Node node) &#123;</span><br><span class="line">    //设置该节点状态为0</span><br><span class="line">    if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))</span><br><span class="line">        return false;</span><br><span class="line">    //将该节点加入CLH队列，返回原队尾</span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    int ws = p.waitStatus;</span><br><span class="line">    //设置该节点前继节点的状态为SIGNAL</span><br><span class="line">    if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        //设置失败，唤醒该线程</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ConditionObject的signalAll方法"><a href="#9、ConditionObject的signalAll方法" class="headerlink" title="9、ConditionObject的signalAll方法"></a>9、ConditionObject的signalAll方法</h4><p>唤醒该条件等待的所有线程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> public final void signalAll() &#123;</span><br><span class="line">    if (!isHeldExclusively())</span><br><span class="line">        throw new IllegalMonitorStateException();</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    if (first != null)</span><br><span class="line">        //唤醒所有等待的线程</span><br><span class="line">        doSignalAll(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="10、ConditionObject的doSignal方法"><a href="#10、ConditionObject的doSignal方法" class="headerlink" title="10、ConditionObject的doSignal方法"></a>10、ConditionObject的doSignal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void doSignalAll(Node first) &#123;</span><br><span class="line">    //清空队列</span><br><span class="line">    lastWaiter = firstWaiter = null;</span><br><span class="line">    do &#123;</span><br><span class="line">        Node next = first.nextWaiter;</span><br><span class="line">        first.nextWaiter = null;</span><br><span class="line">        //依次将节点加入CLH队列</span><br><span class="line">        transferForSignal(first);</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; while (first != null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、读写锁ReentrantReadWriteLock"><a href="#四、读写锁ReentrantReadWriteLock" class="headerlink" title="四、读写锁ReentrantReadWriteLock"></a>四、读写锁ReentrantReadWriteLock</h3><h4 id="1、实例化ReentrantReadWriteLock"><a href="#1、实例化ReentrantReadWriteLock" class="headerlink" title="1、实例化ReentrantReadWriteLock"></a>1、实例化ReentrantReadWriteLock</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ReentrantReadWriteLock() &#123;</span><br><span class="line">    this(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public ReentrantReadWriteLock(boolean fair) &#123;</span><br><span class="line">    //默认使用非公平锁</span><br><span class="line">    sync = fair ? new FairSync() : new NonfairSync();</span><br><span class="line">    //读锁</span><br><span class="line">    readerLock = new ReadLock(this);</span><br><span class="line">    //写锁</span><br><span class="line">    writerLock = new WriteLock(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、ReadLock的lock方法"><a href="#2、ReadLock的lock方法" class="headerlink" title="2、ReadLock的lock方法"></a>2、ReadLock的lock方法</h4><p>获取读锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void lock() &#123;</span><br><span class="line">    sync.acquireShared(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、AbstractQueuedSynchronizer的acquireShared方法"><a href="#3、AbstractQueuedSynchronizer的acquireShared方法" class="headerlink" title="3、AbstractQueuedSynchronizer的acquireShared方法"></a>3、AbstractQueuedSynchronizer的acquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireShared(int arg) &#123;</span><br><span class="line">    //尝试获取共享锁</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        //失败则将线程加入等待队列</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、Sync的tryAcquireShared方法"><a href="#4、Sync的tryAcquireShared方法" class="headerlink" title="4、Sync的tryAcquireShared方法"></a>4、Sync的tryAcquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">protected final int tryAcquireShared(int unused) &#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    //获取锁状态,默认左16位为共享锁（读锁）使用，右16位为独占锁（写锁）使用</span><br><span class="line">    int c = getState();</span><br><span class="line">    //独占锁且拥有者不是当前线程，获取失败，返回-1</span><br><span class="line">    if (exclusiveCount(c) != 0 &amp;&amp;</span><br><span class="line">        getExclusiveOwnerThread() != current)</span><br><span class="line">        return -1;</span><br><span class="line">    //c右移去除独占锁部分</span><br><span class="line">    int r = sharedCount(c);</span><br><span class="line">    //readerShouldBlock 非公平锁(如果队首存在且为独占锁，则返回true)</span><br><span class="line">    //                  公平锁(如果队首存在且不为当前线程，则返回true)</span><br><span class="line">    //MAX_COUNT 共享锁最大共享线程数</span><br><span class="line">    //compareAndSetState 获取锁</span><br><span class="line">    if (!readerShouldBlock() &amp;&amp; </span><br><span class="line">        r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">        if (r == 0) &#123;</span><br><span class="line">            //第一次获取共享锁</span><br><span class="line">            firstReader = current;</span><br><span class="line">            firstReaderHoldCount = 1;</span><br><span class="line">        &#125; else if (firstReader == current) &#123;</span><br><span class="line">            //第一个获取共享锁的线程,但不是第一次获取</span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // HoldCounter是用来统计该线程获取“读取锁”的次数。</span><br><span class="line">            HoldCounter rh = cachedHoldCounter;</span><br><span class="line">            if (rh == null || rh.tid != getThreadId(current))</span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            else if (rh.count == 0)</span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            //线程获取锁的次数加一</span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    return fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、Sync的fullTryAcquireShared方法"><a href="#5、Sync的fullTryAcquireShared方法" class="headerlink" title="5、Sync的fullTryAcquireShared方法"></a>5、Sync的fullTryAcquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">final int fullTryAcquireShared(Thread current) &#123;</span><br><span class="line">    HoldCounter rh = null;</span><br><span class="line">    //不停获取锁，直到成功，或者不能获取</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        //获取锁状态</span><br><span class="line">        int c = getState();</span><br><span class="line">        if (exclusiveCount(c) != 0) &#123;</span><br><span class="line">            //独占锁</span><br><span class="line">            //拥有者不是当前线程，获取失败，返回-1</span><br><span class="line">            if (getExclusiveOwnerThread() != current)</span><br><span class="line">                return -1;</span><br><span class="line">        &#125; else if (readerShouldBlock()) &#123;</span><br><span class="line">            //队首存在且为独占锁，则新线程不可再获取读锁</span><br><span class="line">            if (firstReader == current) &#123;</span><br><span class="line">                </span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //若线程未获取到锁，清除rh</span><br><span class="line">                if (rh == null) &#123;</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                    if (rh == null || rh.tid != getThreadId(current)) &#123;</span><br><span class="line">                        rh = readHolds.get();</span><br><span class="line">                        if (rh.count == 0)</span><br><span class="line">                            readHolds.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //新线程不可再获取读锁</span><br><span class="line">                if (rh.count == 0)</span><br><span class="line">                    return -1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //获取共享锁线程，超过最大数量限制</span><br><span class="line">        if (sharedCount(c) == MAX_COUNT)</span><br><span class="line">            throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">        //获取锁，与上个方法相同</span><br><span class="line">        if (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">            if (sharedCount(c) == 0) &#123;</span><br><span class="line">                firstReader = current;</span><br><span class="line">                firstReaderHoldCount = 1;</span><br><span class="line">            &#125; else if (firstReader == current) &#123;</span><br><span class="line">                firstReaderHoldCount++;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (rh == null)</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                if (rh == null || rh.tid != getThreadId(current))</span><br><span class="line">                    rh = readHolds.get();</span><br><span class="line">                else if (rh.count == 0)</span><br><span class="line">                    readHolds.set(rh);</span><br><span class="line">                rh.count++;</span><br><span class="line">                cachedHoldCounter = rh; // cache for release</span><br><span class="line">            &#125;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（四、4）AbstractQueuedSynchronizer的doAcquireShared方法"><a href="#6、接（四、4）AbstractQueuedSynchronizer的doAcquireShared方法" class="headerlink" title="6、接（四、4）AbstractQueuedSynchronizer的doAcquireShared方法"></a>6、接（四、4）AbstractQueuedSynchronizer的doAcquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">private void doAcquireShared(int arg) &#123;</span><br><span class="line">    //创建共享锁节点，并添加到队列中去</span><br><span class="line">    final Node node = addWaiter(Node.SHARED);</span><br><span class="line">    boolean failed = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        boolean interrupted = false;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            //获取前继节点</span><br><span class="line">            final Node p = node.predecessor();</span><br><span class="line">            //说明本节点为队首</span><br><span class="line">            if (p == head) &#123;</span><br><span class="line">                //再次获取共享锁</span><br><span class="line">                int r = tryAcquireShared(arg);</span><br><span class="line">                //获取共享锁成功</span><br><span class="line">                if (r &gt;= 0) &#123;</span><br><span class="line">                    //头节点标记为当前节点，清空当前节点，</span><br><span class="line">                    //后继节点为共享锁，则唤醒后继节点,</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = null; // help GC</span><br><span class="line">                    if (interrupted)</span><br><span class="line">                        //中断本线程</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = false;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //当前线程应阻塞，则阻塞当前线程，与（一、9）相同</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (failed)</span><br><span class="line">            //取消本节点，与（一、12）相同</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、WriteLock的lock方法"><a href="#7、WriteLock的lock方法" class="headerlink" title="7、WriteLock的lock方法"></a>7、WriteLock的lock方法</h4><p>获取写锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void lock() &#123;</span><br><span class="line">    sync.acquire(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、AbstractQueuedSynchronizer的acquire方法"><a href="#8、AbstractQueuedSynchronizer的acquire方法" class="headerlink" title="8、AbstractQueuedSynchronizer的acquire方法"></a>8、AbstractQueuedSynchronizer的acquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public final void acquire(int arg) &#123;</span><br><span class="line">    //tryAcquire尝试获取独占锁，其余方法与之前相同。</span><br><span class="line">    if (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、Sync的tryAcquire方法"><a href="#9、Sync的tryAcquire方法" class="headerlink" title="9、Sync的tryAcquire方法"></a>9、Sync的tryAcquire方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">        Thread current = Thread.currentThread();</span><br><span class="line">        int c = getState();</span><br><span class="line">        //获取独占锁状态</span><br><span class="line">        int w = exclusiveCount(c);</span><br><span class="line">        //锁已被获取</span><br><span class="line">        if (c != 0) &#123;</span><br><span class="line">            //共享锁或者获取独占锁的不是本线程，返回失败</span><br><span class="line">            if (w == 0 || current != getExclusiveOwnerThread())</span><br><span class="line">                return false;</span><br><span class="line">            //独占锁获取次数大于最大次数</span><br><span class="line">            if (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">                throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">            //更新锁状态</span><br><span class="line">            setState(c + acquires);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        //writerShouldBlock永远返回false</span><br><span class="line">        //尝试获取独占锁</span><br><span class="line">        if (writerShouldBlock() ||</span><br><span class="line">            !compareAndSetState(c, c + acquires))</span><br><span class="line">            return false;</span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="10、ReadLock的unlock方法"><a href="#10、ReadLock的unlock方法" class="headerlink" title="10、ReadLock的unlock方法"></a>10、ReadLock的unlock方法</h4><p>释放共享锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void unlock() &#123;</span><br><span class="line">    sync.releaseShared(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="11、AbstractQueuedSynchronizer的releaseShared方法"><a href="#11、AbstractQueuedSynchronizer的releaseShared方法" class="headerlink" title="11、AbstractQueuedSynchronizer的releaseShared方法"></a>11、AbstractQueuedSynchronizer的releaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final boolean releaseShared(int arg) &#123;</span><br><span class="line">    if (tryReleaseShared(arg)) &#123;</span><br><span class="line">        //释放共享锁</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、Sync的tryReleaseShared方法"><a href="#12、Sync的tryReleaseShared方法" class="headerlink" title="12、Sync的tryReleaseShared方法"></a>12、Sync的tryReleaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryReleaseShared(int unused) &#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    if (firstReader == current) &#123;</span><br><span class="line">        //本线程为获取共享锁的第一个线程</span><br><span class="line">        if (firstReaderHoldCount == 1)</span><br><span class="line">            firstReader = null;</span><br><span class="line">        else</span><br><span class="line">            firstReaderHoldCount--;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //线程获取锁次数减1，若线程已完全释放锁，清除rh</span><br><span class="line">        HoldCounter rh = cachedHoldCounter;</span><br><span class="line">        if (rh == null || rh.tid != getThreadId(current))</span><br><span class="line">            rh = readHolds.get();</span><br><span class="line">        int count = rh.count;</span><br><span class="line">        if (count &lt;= 1) &#123;</span><br><span class="line">            readHolds.remove();</span><br><span class="line">            if (count &lt;= 0)</span><br><span class="line">                throw unmatchedUnlockException();</span><br><span class="line">        &#125;</span><br><span class="line">        --rh.count;</span><br><span class="line">    &#125;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int c = getState();</span><br><span class="line">        //释放一层锁</span><br><span class="line">        int nextc = c - SHARED_UNIT;</span><br><span class="line">        if (compareAndSetState(c, nextc))</span><br><span class="line">            //共享锁是否完全释放</span><br><span class="line">            return nextc == 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、接（四、11）Sync的doReleaseShared方法"><a href="#13、接（四、11）Sync的doReleaseShared方法" class="headerlink" title="13、接（四、11）Sync的doReleaseShared方法"></a>13、接（四、11）Sync的doReleaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private void doReleaseShared() &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        if (h != null &amp;&amp; h != tail) &#123;</span><br><span class="line">            int ws = h.waitStatus;</span><br><span class="line">            if (ws == Node.SIGNAL) &#123;</span><br><span class="line">                //SIGNAL说明下个节点需要唤醒</span><br><span class="line">                //设置该节点状态为0，不成功继续循环，</span><br><span class="line">                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))</span><br><span class="line">                    continue;    </span><br><span class="line">                //唤醒下个节点的线程</span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            else if (ws == 0 &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))</span><br><span class="line">                //设置该节点状态为共享锁</span><br><span class="line">                continue;                // loop on failed CAS</span><br><span class="line">        &#125;</span><br><span class="line">        //头结点发生变化，退出循环</span><br><span class="line">        if (h == head)                   // loop if head changed</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、WriteLock的unlock方法"><a href="#14、WriteLock的unlock方法" class="headerlink" title="14、WriteLock的unlock方法"></a>14、WriteLock的unlock方法</h4><p>写锁释放锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void unlock() &#123;</span><br><span class="line">    sync.release(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="15、AbstractQueuedSynchronizer的release方法"><a href="#15、AbstractQueuedSynchronizer的release方法" class="headerlink" title="15、AbstractQueuedSynchronizer的release方法"></a>15、AbstractQueuedSynchronizer的release方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public final boolean release(int arg) &#123;</span><br><span class="line">    //释放锁，返回是否完全释放锁</span><br><span class="line">    if (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        if (h != null &amp;&amp; h.waitStatus != 0)</span><br><span class="line">            //唤醒后继节点线程</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、AbstractQueuedSynchronizer的tryRelease方法"><a href="#16、AbstractQueuedSynchronizer的tryRelease方法" class="headerlink" title="16、AbstractQueuedSynchronizer的tryRelease方法"></a>16、AbstractQueuedSynchronizer的tryRelease方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryRelease(int releases) &#123;</span><br><span class="line">    //拥有锁的是否是当前线程</span><br><span class="line">    if (!isHeldExclusively())</span><br><span class="line">        throw new IllegalMonitorStateException();</span><br><span class="line">    //释放一层锁</span><br><span class="line">    int nextc = getState() - releases;</span><br><span class="line">    //是否完全释放</span><br><span class="line">    boolean free = exclusiveCount(nextc) == 0;</span><br><span class="line">    if (free)</span><br><span class="line">        setExclusiveOwnerThread(null);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    return free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="五、CountDownLatch"><a href="#五、CountDownLatch" class="headerlink" title="五、CountDownLatch"></a>五、CountDownLatch</h3><h4 id="1、实例化CountDownLatch"><a href="#1、实例化CountDownLatch" class="headerlink" title="1、实例化CountDownLatch"></a>1、实例化CountDownLatch</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public CountDownLatch(int count) &#123;</span><br><span class="line">    if (count &lt; 0) throw new IllegalArgumentException(&quot;count &lt; 0&quot;);</span><br><span class="line">    this.sync = new Sync(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sync(int count) &#123;</span><br><span class="line">    setState(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AbstractQueuedSynchronizer的setState方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected final void setState(int newState) &#123;</span><br><span class="line">    state = newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>CountDownLatch重写了tryAcquireShared、tryReleaseShared方法，其余与共享锁相同</p><h4 id="2、CountDownLatch的await方法"><a href="#2、CountDownLatch的await方法" class="headerlink" title="2、CountDownLatch的await方法"></a>2、CountDownLatch的await方法</h4><p>线程加入等待队列，等待CountDownLatch释放锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void await() throws InterruptedException &#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法"><a href="#3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法" class="headerlink" title="3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法"></a>3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireSharedInterruptibly(int arg)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    //查看CountDownLatch是否完全释放，没有则线程加入等待队列</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        //线程加入等待队列，与共享锁相同</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、Sync的tryAcquireShared方法-1"><a href="#4、Sync的tryAcquireShared方法-1" class="headerlink" title="4、Sync的tryAcquireShared方法"></a>4、Sync的tryAcquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected int tryAcquireShared(int acquires) &#123;</span><br><span class="line">    return (getState() == 0) ? 1 : -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（五、3）AbstractQueuedSynchronizer的acquireSharedInterruptibly方法"><a href="#5、接（五、3）AbstractQueuedSynchronizer的acquireSharedInterruptibly方法" class="headerlink" title="5、接（五、3）AbstractQueuedSynchronizer的acquireSharedInterruptibly方法"></a>5、接（五、3）AbstractQueuedSynchronizer的acquireSharedInterruptibly方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">private void doAcquireSharedInterruptibly(int arg)</span><br><span class="line">    throws InterruptedException &#123;</span><br><span class="line">    final Node node = addWaiter(Node.SHARED);</span><br><span class="line">    boolean failed = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            final Node p = node.predecessor();</span><br><span class="line">            if (p == head) &#123;</span><br><span class="line">                //判断CountDownLatch是否完全释放</span><br><span class="line">                int r = tryAcquireShared(arg);</span><br><span class="line">                //CountDownLatch完全释放，唤醒等待队列中的所有线程</span><br><span class="line">                if (r &gt;= 0) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = null; // help GC</span><br><span class="line">                    failed = false;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                throw new InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、CountDownLatch的countDown方法"><a href="#6、CountDownLatch的countDown方法" class="headerlink" title="6、CountDownLatch的countDown方法"></a>6、CountDownLatch的countDown方法</h4><p>CountDownLatch释放一层锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void countDown() &#123;</span><br><span class="line">    sync.releaseShared(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、AbstractQueuedSynchronizer的releaseShared方法"><a href="#7、AbstractQueuedSynchronizer的releaseShared方法" class="headerlink" title="7、AbstractQueuedSynchronizer的releaseShared方法"></a>7、AbstractQueuedSynchronizer的releaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final boolean releaseShared(int arg) &#123;</span><br><span class="line">    //释放一层锁</span><br><span class="line">    if (tryReleaseShared(arg)) &#123;</span><br><span class="line">        //释放共享锁，唤醒等待线程，与共享锁相同</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、Sync的tryReleaseShared方法"><a href="#8、Sync的tryReleaseShared方法" class="headerlink" title="8、Sync的tryReleaseShared方法"></a>8、Sync的tryReleaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected boolean tryReleaseShared(int releases) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int c = getState();</span><br><span class="line">        if (c == 0)</span><br><span class="line">            return false;</span><br><span class="line">        int nextc = c-1;</span><br><span class="line">        //释放一层锁</span><br><span class="line">        if (compareAndSetState(c, nextc))</span><br><span class="line">            //返回CountDownLatch是否完全释放</span><br><span class="line">            return nextc == 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="六、CyclicBarrier"><a href="#六、CyclicBarrier" class="headerlink" title="六、CyclicBarrier"></a>六、CyclicBarrier</h3><h4 id="1、实例化CyclicBarrier"><a href="#1、实例化CyclicBarrier" class="headerlink" title="1、实例化CyclicBarrier"></a>1、实例化CyclicBarrier</h4><p>等待parties个线程到达，才会释放锁<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public CyclicBarrier(int parties, Runnable barrierAction) &#123;</span><br><span class="line">    if (parties &lt;= 0) throw new IllegalArgumentException();</span><br><span class="line">    this.parties = parties;</span><br><span class="line">    this.count = parties;</span><br><span class="line">    //回调线程</span><br><span class="line">    this.barrierCommand = barrierAction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、CyclicBarrier的await方法"><a href="#2、CyclicBarrier的await方法" class="headerlink" title="2、CyclicBarrier的await方法"></a>2、CyclicBarrier的await方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public int await() throws InterruptedException, BrokenBarrierException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        return dowait(false, 0L);</span><br><span class="line">    &#125; catch (TimeoutException toe) &#123;</span><br><span class="line">        throw new Error(toe); // cannot happen</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、CyclicBarrier的dowait方法"><a href="#3、CyclicBarrier的dowait方法" class="headerlink" title="3、CyclicBarrier的dowait方法"></a>3、CyclicBarrier的dowait方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">private int dowait(boolean timed, long nanos)</span><br><span class="line">    throws InterruptedException, BrokenBarrierException,</span><br><span class="line">           TimeoutException &#123;</span><br><span class="line">    //独占锁</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    //获取锁</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //当前的generation</span><br><span class="line">        final Generation g = generation;</span><br><span class="line">        //是否已损坏</span><br><span class="line">        if (g.broken)</span><br><span class="line">            throw new BrokenBarrierException();</span><br><span class="line">        //当前线程已被中断</span><br><span class="line">        if (Thread.interrupted()) &#123;</span><br><span class="line">            //破坏锁，释放等待线程</span><br><span class="line">            breakBarrier();</span><br><span class="line">            throw new InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">        //count 减一</span><br><span class="line">        int index = --count;</span><br><span class="line">        //到达CyclicBarrier的线程数已达到parties个</span><br><span class="line">        if (index == 0) &#123;  // tripped</span><br><span class="line">            boolean ranAction = false;</span><br><span class="line">            try &#123;</span><br><span class="line">                final Runnable command = barrierCommand;</span><br><span class="line">                if (command != null)</span><br><span class="line">                    //执行回调线程</span><br><span class="line">                    command.run();</span><br><span class="line">                ranAction = true;</span><br><span class="line">                //释放等待线程，重置锁</span><br><span class="line">                nextGeneration();</span><br><span class="line">                return 0;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                if (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (!timed)</span><br><span class="line">                    //lock锁的条件等待</span><br><span class="line">                    trip.await();</span><br><span class="line">                else if (nanos &gt; 0L)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; catch (InterruptedException ie) &#123;</span><br><span class="line">                if (g == generation &amp;&amp; ! g.broken) &#123;</span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    throw ie;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (g.broken)</span><br><span class="line">                throw new BrokenBarrierException();</span><br><span class="line"></span><br><span class="line">            if (g != generation)</span><br><span class="line">                return index;</span><br><span class="line"></span><br><span class="line">            if (timed &amp;&amp; nanos &lt;= 0L) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                throw new TimeoutException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、CyclicBarrier的breakBarrier方法"><a href="#4、CyclicBarrier的breakBarrier方法" class="headerlink" title="4、CyclicBarrier的breakBarrier方法"></a>4、CyclicBarrier的breakBarrier方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void breakBarrier() &#123;</span><br><span class="line">    //锁被破坏</span><br><span class="line">    generation.broken = true;</span><br><span class="line">    //重置count</span><br><span class="line">    count = parties;</span><br><span class="line">    //释放在等待的线程</span><br><span class="line">    trip.signalAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（六、3）CyclicBarrier的nextGeneration方法"><a href="#5、接（六、3）CyclicBarrier的nextGeneration方法" class="headerlink" title="5、接（六、3）CyclicBarrier的nextGeneration方法"></a>5、接（六、3）CyclicBarrier的nextGeneration方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void nextGeneration() &#123;</span><br><span class="line">    //释放等待的线程</span><br><span class="line">    trip.signalAll();</span><br><span class="line">    //重置count</span><br><span class="line">    count = parties;</span><br><span class="line">    //重置Generation</span><br><span class="line">    generation = new Generation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="七、Semaphore"><a href="#七、Semaphore" class="headerlink" title="七、Semaphore"></a>七、Semaphore</h3><h4 id="1、实例化Semaphore"><a href="#1、实例化Semaphore" class="headerlink" title="1、实例化Semaphore"></a>1、实例化Semaphore</h4><p>最大信号量permits<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Semaphore(int permits) &#123;</span><br><span class="line">    sync = new NonfairSync(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2、Semaphore的acquire方法"><a href="#2、Semaphore的acquire方法" class="headerlink" title="2、Semaphore的acquire方法"></a>2、Semaphore的acquire方法</h4><p>获取permits的信号量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void acquire(int permits) throws InterruptedException &#123;</span><br><span class="line">    if (permits &lt; 0) throw new IllegalArgumentException();</span><br><span class="line">    sync.acquireSharedInterruptibly(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法-1"><a href="#3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法-1" class="headerlink" title="3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法"></a>3、AbstractQueuedSynchronizer的acquireSharedInterruptibly方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireSharedInterruptibly(int arg)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    //剩余信号量小于零，则线程加入等待队列</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        //加入等待队列,与共享锁相同  </span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、NonfairSync的tryAcquireShared方法"><a href="#4、NonfairSync的tryAcquireShared方法" class="headerlink" title="4、NonfairSync的tryAcquireShared方法"></a>4、NonfairSync的tryAcquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected int tryAcquireShared(int acquires) &#123;</span><br><span class="line">    return nonfairTryAcquireShared(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、Semaphore的nonfairTryAcquireShared方法"><a href="#5、Semaphore的nonfairTryAcquireShared方法" class="headerlink" title="5、Semaphore的nonfairTryAcquireShared方法"></a>5、Semaphore的nonfairTryAcquireShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">final int nonfairTryAcquireShared(int acquires) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        //剩余的信号量</span><br><span class="line">        int available = getState();</span><br><span class="line">        int remaining = available - acquires;</span><br><span class="line">        //剩余信号量大于零，则尝试获取。</span><br><span class="line">        if (remaining &lt; 0 ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            //剩余信号量小于零，或者获取成功，返回剩余信号量</span><br><span class="line">            return remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、Semaphore的release方法"><a href="#6、Semaphore的release方法" class="headerlink" title="6、Semaphore的release方法"></a>6、Semaphore的release方法</h4><p>释放信号量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void release(int permits) &#123;</span><br><span class="line">    if (permits &lt; 0) throw new IllegalArgumentException();</span><br><span class="line">    sync.releaseShared(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、AbstractQueuedSynchronizer的releaseShared方法-1"><a href="#7、AbstractQueuedSynchronizer的releaseShared方法-1" class="headerlink" title="7、AbstractQueuedSynchronizer的releaseShared方法"></a>7、AbstractQueuedSynchronizer的releaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final boolean releaseShared(int arg) &#123;</span><br><span class="line">    if (tryReleaseShared(arg)) &#123;</span><br><span class="line">        //唤醒等待队列，与共享锁相同</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、AbstractQueuedSynchronizer的releaseShared方法"><a href="#8、AbstractQueuedSynchronizer的releaseShared方法" class="headerlink" title="8、AbstractQueuedSynchronizer的releaseShared方法"></a>8、AbstractQueuedSynchronizer的releaseShared方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryReleaseShared(int releases) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int current = getState();</span><br><span class="line">        int next = current + releases;</span><br><span class="line">        if (next &lt; current) // overflow</span><br><span class="line">            throw new Error(&quot;Maximum permit count exceeded&quot;);</span><br><span class="line">        //释放信号量</span><br><span class="line">        if (compareAndSetState(current, next))</span><br><span class="line">            return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（七、3）FairSync的tryAcquireShared方法"><a href="#9、接（七、3）FairSync的tryAcquireShared方法" class="headerlink" title="9、接（七、3）FairSync的tryAcquireShared方法"></a>9、接（七、3）FairSync的tryAcquireShared方法</h4><p>公平锁的信号量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected int tryAcquireShared(int acquires) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        //等待队列中，由线程直接返回-1，其余与非公平锁相同</span><br><span class="line">        if (hasQueuedPredecessors())</span><br><span class="line">            return -1;</span><br><span class="line">        int available = getState();</span><br><span class="line">        int remaining = available - acquires;</span><br><span class="line">        if (remaining &lt; 0 ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            return remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、独占锁ReentrantLock&quot;&gt;&lt;a href=&quot;#一、独占锁ReentrantLock&quot; class=&quot;headerlink&quot; title=&quot;一、独占锁ReentrantLock&quot;&gt;&lt;/a&gt;一、独占锁ReentrantLock&lt;/h3&gt;&lt;h4 id=&quot;1
      
    
    </summary>
    
      <category term="java.util.concurrent" scheme="http://yoursite.com/categories/java-util-concurrent/"/>
    
    
  </entry>
  
  <entry>
    <title>JUC线程池(2)ForkJoinPool</title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E7%BA%BF%E7%A8%8B%E6%B1%A0(2)ForkJoinPool/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC线程池(2)ForkJoinPool/</id>
    <published>2018-05-06T13:48:30.181Z</published>
    <updated>2018-06-28T14:04:01.333Z</updated>
    
    <content type="html"><![CDATA[<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public class Test &#123;  </span><br><span class="line">    public static void main(String[] args) &#123;  </span><br><span class="line">        ForkJoinPool pool = new ForkJoinPool();  </span><br><span class="line">              </span><br><span class="line">        /** </span><br><span class="line">         * get()和join()有两个主要的区别： </span><br><span class="line">         * join()方法同步返回,不能被中断。如果你中断调用join()方法的线程，这个方法将抛出InterruptedException异常。 </span><br><span class="line">         * 如果任务抛出任何未受检异常，get()方法异步返回将返回一个ExecutionException异常，而join()方法将返回一个RuntimeException异常。 </span><br><span class="line">         */  </span><br><span class="line">        //同步返回结果  </span><br><span class="line">        //Future&lt;Integer&gt; result = pool.submit(new CountTask(0, 2000));  </span><br><span class="line">        //System.out.println(result.get());  </span><br><span class="line">        //异步返回结果  </span><br><span class="line">        CountTask task = new CountTask(0, 2000);  </span><br><span class="line">        pool.execute(task);  </span><br><span class="line">        pool.shutdown();  </span><br><span class="line">        Integer count = task.join();  </span><br><span class="line">        System.out.println(count);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">/** </span><br><span class="line"> * 计算1..n相加总和的简单demo </span><br><span class="line"> * @author Administrator </span><br><span class="line"> * </span><br><span class="line"> */  </span><br><span class="line">class CountTask extends RecursiveTask&lt;Integer&gt;&#123;  </span><br><span class="line">        </span><br><span class="line">    private static final long serialVersionUID = 1L;  </span><br><span class="line">    //边界值  </span><br><span class="line">    private static final int THRESHOLD = 50;  </span><br><span class="line">    private int start;  </span><br><span class="line">    private int end;  </span><br><span class="line">       </span><br><span class="line">    public CountTask(int start, int end) &#123;  </span><br><span class="line">        this.start = start;  </span><br><span class="line">        this.end = end;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    @Override  </span><br><span class="line">    protected Integer compute() &#123;  </span><br><span class="line">        int sum = 0;  </span><br><span class="line">        boolean canCompute = (end - start) &lt;= THRESHOLD;  </span><br><span class="line">        if (canCompute) &#123;  </span><br><span class="line">            for (int i = start; i &lt;= end; i++)  </span><br><span class="line">                sum += i;  </span><br><span class="line">        &#125; else &#123;  </span><br><span class="line">            int mid = (start + end) / 2;  </span><br><span class="line">            CountTask t1 = new CountTask(start, mid);  </span><br><span class="line">            CountTask t2 = new CountTask(mid+1, end);  </span><br><span class="line">            t1.fork();  </span><br><span class="line">            t2.fork();  </span><br><span class="line">            sum = t1.join() + t2.join();  </span><br><span class="line">        &#125;  </span><br><span class="line">        return sum;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一、ForkJoinPool"><a href="#一、ForkJoinPool" class="headerlink" title="一、ForkJoinPool"></a>一、ForkJoinPool</h3><h4 id="1、实例化ForkJoinPool"><a href="#1、实例化ForkJoinPool" class="headerlink" title="1、实例化ForkJoinPool"></a>1、实例化ForkJoinPool</h4><p>创建ForkJoinPool<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public ForkJoinPool() &#123;</span><br><span class="line">    this(Math.min(MAX_CAP, Runtime.getRuntime().availableProcessors()),</span><br><span class="line">         defaultForkJoinWorkerThreadFactory, null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public ForkJoinPool(int parallelism,</span><br><span class="line">                    ForkJoinWorkerThreadFactory factory,</span><br><span class="line">                    UncaughtExceptionHandler handler,</span><br><span class="line">                    boolean asyncMode) &#123;</span><br><span class="line">    this(checkParallelism(parallelism),</span><br><span class="line">         checkFactory(factory),</span><br><span class="line">         handler,</span><br><span class="line">         asyncMode ? FIFO_QUEUE : LIFO_QUEUE,</span><br><span class="line">         &quot;ForkJoinPool-&quot; + nextPoolId() + &quot;-worker-&quot;);</span><br><span class="line">    checkPermission();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private ForkJoinPool(int parallelism,</span><br><span class="line">                     ForkJoinWorkerThreadFactory factory,</span><br><span class="line">                     UncaughtExceptionHandler handler,</span><br><span class="line">                     int mode,</span><br><span class="line">                     String workerNamePrefix) &#123;</span><br><span class="line">    //线程名前缀</span><br><span class="line">    this.workerNamePrefix = workerNamePrefix;</span><br><span class="line">    //线程工厂，默认DefaultForkJoinWorkerThreadFactory</span><br><span class="line">    this.factory = factory;</span><br><span class="line">    //</span><br><span class="line">    this.ueh = handler;</span><br><span class="line">    //前16位保存队列模式，后16位保存最大线程数量</span><br><span class="line">    this.config = (parallelism &amp; SMASK) | mode;</span><br><span class="line">    //</span><br><span class="line">    long np = (long)(-parallelism); // offset ctl counts</span><br><span class="line">    //线程锁，前16位保存活跃的工作线程数量，第二个16位保存总线程数量,最后32位保存等待线程在数组中的位置</span><br><span class="line">    this.ctl = ((np &lt;&lt; AC_SHIFT) &amp; AC_MASK) | ((np &lt;&lt; TC_SHIFT) &amp; TC_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>线程池运行状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private static final int  RSLOCK     = 1;</span><br><span class="line">private static final int  RSIGNAL    = 1 &lt;&lt; 1;</span><br><span class="line">private static final int  STARTED    = 1 &lt;&lt; 2;</span><br><span class="line">private static final int  STOP       = 1 &lt;&lt; 29;</span><br><span class="line">private static final int  TERMINATED = 1 &lt;&lt; 30;</span><br><span class="line">private static final int  SHUTDOWN   = 1 &lt;&lt; 31;</span><br></pre></td></tr></table></figure></p><h4 id="2、ForkJoinPool的execute"><a href="#2、ForkJoinPool的execute" class="headerlink" title="2、ForkJoinPool的execute"></a>2、ForkJoinPool的execute</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void execute(ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">    if (task == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    externalPush(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ForkJoinPool的externalPush"><a href="#3、ForkJoinPool的externalPush" class="headerlink" title="3、ForkJoinPool的externalPush"></a>3、ForkJoinPool的externalPush</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">final void externalPush(ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">    WorkQueue[] ws; WorkQueue q; int m;</span><br><span class="line">    //随机数</span><br><span class="line">    int r = ThreadLocalRandom.getProbe();</span><br><span class="line">    int rs = runState;</span><br><span class="line">    //如果数组存在，获取数组中的workQueue队列，将任务加入队列</span><br><span class="line">    if ((ws = workQueues) != null &amp;&amp; (m = (ws.length - 1)) &gt;= 0 &amp;&amp;</span><br><span class="line">        (q = ws[m &amp; r &amp; SQMASK]) != null &amp;&amp; r != 0 &amp;&amp; rs &gt; 0 &amp;&amp;</span><br><span class="line">        U.compareAndSwapInt(q, QLOCK, 0, 1)) &#123;</span><br><span class="line">        ForkJoinTask&lt;?&gt;[] a; int am, n, s;</span><br><span class="line">        if ((a = q.array) != null &amp;&amp;</span><br><span class="line">            (am = a.length - 1) &gt; (n = (s = q.top) - q.base)) &#123;</span><br><span class="line">            int j = ((am &amp; s) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">            U.putOrderedObject(a, j, task);</span><br><span class="line">            U.putOrderedInt(q, QTOP, s + 1);</span><br><span class="line">            U.putIntVolatile(q, QLOCK, 0);</span><br><span class="line">            //尝试创建一个活跃的工作线程</span><br><span class="line">            if (n &lt;= 1)</span><br><span class="line">                signalWork(ws, q);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        U.compareAndSwapInt(q, QLOCK, 1, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    //任务加入线程池</span><br><span class="line">    externalSubmit(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ForkJoinPool的externalSubmit"><a href="#4、ForkJoinPool的externalSubmit" class="headerlink" title="4、ForkJoinPool的externalSubmit"></a>4、ForkJoinPool的externalSubmit</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">private void externalSubmit(ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">    int r;                                    // initialize caller&apos;s probe</span><br><span class="line">    //获取随机数</span><br><span class="line">    if ((r = ThreadLocalRandom.getProbe()) == 0) &#123;</span><br><span class="line">        ThreadLocalRandom.localInit();</span><br><span class="line">        r = ThreadLocalRandom.getProbe();</span><br><span class="line">    &#125;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        WorkQueue[] ws; WorkQueue q; int rs, m, k;</span><br><span class="line">        boolean move = false;</span><br><span class="line">        //线程池已关闭，抛出异常</span><br><span class="line">        if ((rs = runState) &lt; 0) &#123;</span><br><span class="line">            tryTerminate(false, false);     // help terminate</span><br><span class="line">            throw new RejectedExecutionException();</span><br><span class="line">        &#125;</span><br><span class="line">        //初始化数组workQueues</span><br><span class="line">        else if ((rs &amp; STARTED) == 0 ||     // initialize</span><br><span class="line">                 ((ws = workQueues) == null || (m = ws.length - 1) &lt; 0)) &#123;</span><br><span class="line">            int ns = 0;</span><br><span class="line">            rs = lockRunState();</span><br><span class="line">            try &#123;</span><br><span class="line">                if ((rs &amp; STARTED) == 0) &#123;</span><br><span class="line">                    U.compareAndSwapObject(this, STEALCOUNTER, null,</span><br><span class="line">                                           new AtomicLong());</span><br><span class="line">                    // create workQueues array with size a power of two</span><br><span class="line">                    int p = config &amp; SMASK; // ensure at least 2 slots</span><br><span class="line">                    int n = (p &gt; 1) ? p - 1 : 1;</span><br><span class="line">                    n |= n &gt;&gt;&gt; 1; n |= n &gt;&gt;&gt; 2;  n |= n &gt;&gt;&gt; 4;</span><br><span class="line">                    n |= n &gt;&gt;&gt; 8; n |= n &gt;&gt;&gt; 16; n = (n + 1) &lt;&lt; 1;</span><br><span class="line">                    workQueues = new WorkQueue[n];</span><br><span class="line">                    ns = STARTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                unlockRunState(rs, (rs &amp; ~RSLOCK) | ns);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //任务加入队列</span><br><span class="line">        else if ((q = ws[k = r &amp; m &amp; SQMASK]) != null) &#123;</span><br><span class="line">            if (q.qlock == 0 &amp;&amp; U.compareAndSwapInt(q, QLOCK, 0, 1)) &#123;</span><br><span class="line">                ForkJoinTask&lt;?&gt;[] a = q.array;</span><br><span class="line">                int s = q.top;</span><br><span class="line">                boolean submitted = false; // initial submission or resizing</span><br><span class="line">                try &#123;                      // locked version of push</span><br><span class="line">                    if ((a != null &amp;&amp; a.length &gt; s + 1 - q.base) ||</span><br><span class="line">                        (a = q.growArray()) != null) &#123;</span><br><span class="line">                        int j = (((a.length - 1) &amp; s) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                        U.putOrderedObject(a, j, task);</span><br><span class="line">                        U.putOrderedInt(q, QTOP, s + 1);</span><br><span class="line">                        submitted = true;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    U.compareAndSwapInt(q, QLOCK, 1, 0);</span><br><span class="line">                &#125;</span><br><span class="line">                if (submitted) &#123;</span><br><span class="line">                    //创建工作线程</span><br><span class="line">                    signalWork(ws, q);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            move = true;                   // move on failure</span><br><span class="line">        &#125;</span><br><span class="line">        //队列不存在，创建队列</span><br><span class="line">        else if (((rs = runState) &amp; RSLOCK) == 0) &#123; // create new queue</span><br><span class="line">            q = new WorkQueue(this, null);</span><br><span class="line">            q.hint = r;</span><br><span class="line">            q.config = k | SHARED_QUEUE;</span><br><span class="line">            //队列中不存在工作线程</span><br><span class="line">            q.scanState = INACTIVE;</span><br><span class="line">            rs = lockRunState();           // publish index</span><br><span class="line">            if (rs &gt; 0 &amp;&amp;  (ws = workQueues) != null &amp;&amp;</span><br><span class="line">                k &lt; ws.length &amp;&amp; ws[k] == null)</span><br><span class="line">                ws[k] = q;                 // else terminated</span><br><span class="line">            unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            move = true;                   // move if busy</span><br><span class="line">        //添加失败,换个数组下标</span><br><span class="line">        if (move)</span><br><span class="line">            r = ThreadLocalRandom.advanceProbe(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、ForkJoinPool的signalWork"><a href="#5、ForkJoinPool的signalWork" class="headerlink" title="5、ForkJoinPool的signalWork"></a>5、ForkJoinPool的signalWork</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">final void signalWork(WorkQueue[] ws, WorkQueue q) &#123;</span><br><span class="line">    long c; int sp, i; WorkQueue v; Thread p;</span><br><span class="line">    //ctl小于零，说明活跃工作线程数量未达到上限</span><br><span class="line">    while ((c = ctl) &lt; 0L) &#123;                       // too few active</span><br><span class="line">        //没有等待线程</span><br><span class="line">        if ((sp = (int)c) == 0) &#123;                  // no idle workers</span><br><span class="line">            //总线程数未达到上限</span><br><span class="line">            if ((c &amp; ADD_WORKER) != 0L)            // too few workers</span><br><span class="line">                //创建新工作线程</span><br><span class="line">                tryAddWorker(c);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        if (ws == null)                            // unstarted/terminated</span><br><span class="line">            break;</span><br><span class="line">        if (ws.length &lt;= (i = sp &amp; SMASK))         // terminated</span><br><span class="line">            break;</span><br><span class="line">        if ((v = ws[i]) == null)                   // terminating</span><br><span class="line">            break;</span><br><span class="line">        int vs = (sp + SS_SEQ) &amp; ~INACTIVE;        // next scanState</span><br><span class="line">        int d = sp - v.scanState;                  // screen CAS</span><br><span class="line">        //活跃线程加1，唤醒一个正在等待的线程，stackPred保存的前一个等待线程的位置信息</span><br><span class="line">        long nc = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; v.stackPred);</span><br><span class="line">        if (d == 0 &amp;&amp; U.compareAndSwapLong(this, CTL, c, nc)) &#123;</span><br><span class="line">            v.scanState = vs;                      // activate v</span><br><span class="line">            if ((p = v.parker) != null)</span><br><span class="line">                U.unpark(p);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        if (q != null &amp;&amp; q.base == q.top)          // no more work</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、ForkJoinPool的tryAddWorker"><a href="#6、ForkJoinPool的tryAddWorker" class="headerlink" title="6、ForkJoinPool的tryAddWorker"></a>6、ForkJoinPool的tryAddWorker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void tryAddWorker(long c) &#123;</span><br><span class="line">    boolean add = false;</span><br><span class="line">    do &#123;</span><br><span class="line">        //活跃线程，总线程数量分别加1</span><br><span class="line">        long nc = ((AC_MASK &amp; (c + AC_UNIT)) |</span><br><span class="line">                   (TC_MASK &amp; (c + TC_UNIT)));</span><br><span class="line">        if (ctl == c) &#123;</span><br><span class="line">            int rs, stop;                 // check if terminating</span><br><span class="line">            if ((stop = (rs = lockRunState()) &amp; STOP) == 0)</span><br><span class="line">                add = U.compareAndSwapLong(this, CTL, c, nc);</span><br><span class="line">            unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">            if (stop != 0)</span><br><span class="line">                break;</span><br><span class="line">            if (add) &#123;</span><br><span class="line">                //创建工作线程</span><br><span class="line">                createWorker();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (((c = ctl) &amp; ADD_WORKER) != 0L &amp;&amp; (int)c == 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ForkJoinPool的createWorker"><a href="#7、ForkJoinPool的createWorker" class="headerlink" title="7、ForkJoinPool的createWorker"></a>7、ForkJoinPool的createWorker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private boolean createWorker() &#123;</span><br><span class="line">    ForkJoinWorkerThreadFactory fac = factory;</span><br><span class="line">    Throwable ex = null;</span><br><span class="line">    ForkJoinWorkerThread wt = null;</span><br><span class="line">    //创建工作线程，并启动</span><br><span class="line">    try &#123;</span><br><span class="line">        if (fac != null &amp;&amp; (wt = fac.newThread(this)) != null) &#123;</span><br><span class="line">            wt.start();</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable rex) &#123;</span><br><span class="line">        ex = rex;</span><br><span class="line">    &#125;</span><br><span class="line">    deregisterWorker(wt, ex);</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、实例化ForkJoinWorkerThread"><a href="#8、实例化ForkJoinWorkerThread" class="headerlink" title="8、实例化ForkJoinWorkerThread"></a>8、实例化ForkJoinWorkerThread</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected ForkJoinWorkerThread(ForkJoinPool pool) &#123;</span><br><span class="line">    // Use a placeholder until a useful name can be set in registerWorker</span><br><span class="line">    super(&quot;aForkJoinWorkerThread&quot;);</span><br><span class="line">    this.pool = pool;</span><br><span class="line">    this.workQueue = pool.registerWorker(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ForkJoinPool的registerWorker"><a href="#9、ForkJoinPool的registerWorker" class="headerlink" title="9、ForkJoinPool的registerWorker"></a>9、ForkJoinPool的registerWorker</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">final WorkQueue registerWorker(ForkJoinWorkerThread wt) &#123;</span><br><span class="line">    UncaughtExceptionHandler handler;</span><br><span class="line">    wt.setDaemon(true);                           // configure thread</span><br><span class="line">    if ((handler = ueh) != null)</span><br><span class="line">        wt.setUncaughtExceptionHandler(handler);</span><br><span class="line">    //创建该工作线程的队列</span><br><span class="line">    WorkQueue w = new WorkQueue(this, wt);</span><br><span class="line">    int i = 0;                                    // assign a pool index</span><br><span class="line">    int mode = config &amp; MODE_MASK;</span><br><span class="line">    int rs = lockRunState();</span><br><span class="line">    try &#123;</span><br><span class="line">        WorkQueue[] ws; int n;                    // skip if no array</span><br><span class="line">        if ((ws = workQueues) != null &amp;&amp; (n = ws.length) &gt; 0) &#123;</span><br><span class="line">            //随机数的种子</span><br><span class="line">            int s = indexSeed += SEED_INCREMENT;  // unlikely to collide</span><br><span class="line">            int m = n - 1;</span><br><span class="line">            //奇数</span><br><span class="line">            i = ((s &lt;&lt; 1) | 1) &amp; m;               // odd-numbered indices</span><br><span class="line">            if (ws[i] != null) &#123;                  // collision</span><br><span class="line">                int probes = 0;                   // step by approx half n</span><br><span class="line">                //偶数</span><br><span class="line">                int step = (n &lt;= 4) ? 2 : ((n &gt;&gt;&gt; 1) &amp; EVENMASK) + 2;</span><br><span class="line">                while (ws[i = (i + step) &amp; m] != null) &#123;</span><br><span class="line">                    if (++probes &gt;= n) &#123;</span><br><span class="line">                        //数组扩容</span><br><span class="line">                        workQueues = ws = Arrays.copyOf(ws, n &lt;&lt;= 1);</span><br><span class="line">                        m = n - 1;</span><br><span class="line">                        probes = 0;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            w.hint = s;                           // use as random seed</span><br><span class="line">            w.config = i | mode;</span><br><span class="line">            //队列中存在工作线程，数组中的下标</span><br><span class="line">            w.scanState = i;                      // publication fence</span><br><span class="line">            //队列放入数组的奇数位</span><br><span class="line">            ws[i] = w;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">    &#125;</span><br><span class="line">    wt.setName(workerNamePrefix.concat(Integer.toString(i &gt;&gt;&gt; 1)));</span><br><span class="line">    return w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（一、8）ForkJoinWorkerThread的run方法"><a href="#10、接（一、8）ForkJoinWorkerThread的run方法" class="headerlink" title="10、接（一、8）ForkJoinWorkerThread的run方法"></a>10、接（一、8）ForkJoinWorkerThread的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    if (workQueue.array == null) &#123; // only run once</span><br><span class="line">        Throwable exception = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            //空函数,待覆盖</span><br><span class="line">            onStart();</span><br><span class="line">            //处理任务</span><br><span class="line">            pool.runWorker(workQueue);</span><br><span class="line">        &#125; catch (Throwable ex) &#123;</span><br><span class="line">            exception = ex;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                onTermination(exception);</span><br><span class="line">            &#125; catch (Throwable ex) &#123;</span><br><span class="line">                if (exception == null)</span><br><span class="line">                    exception = ex;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                pool.deregisterWorker(this, exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ForkJoinPool的runWorker方法"><a href="#11、ForkJoinPool的runWorker方法" class="headerlink" title="11、ForkJoinPool的runWorker方法"></a>11、ForkJoinPool的runWorker方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">final void runWorker(WorkQueue w) &#123;</span><br><span class="line">    //数组扩容</span><br><span class="line">    w.growArray();                   // allocate queue</span><br><span class="line">    int seed = w.hint;               // initially holds randomization hint</span><br><span class="line">    int r = (seed == 0) ? 1 : seed;  // avoid 0 for xorShift</span><br><span class="line">    for (ForkJoinTask&lt;?&gt; t;;) &#123;</span><br><span class="line">        //偷取任务</span><br><span class="line">        if ((t = scan(w, r)) != null)</span><br><span class="line">            //执行任务</span><br><span class="line">            w.runTask(t);</span><br><span class="line">        //无任务,线程等待</span><br><span class="line">        else if (!awaitWork(w, r))</span><br><span class="line">            break;</span><br><span class="line">        //下一个随机数</span><br><span class="line">        r ^= r &lt;&lt; 13; r ^= r &gt;&gt;&gt; 17; r ^= r &lt;&lt; 5; // xorshift</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、ForkJoinPool的scan方法"><a href="#12、ForkJoinPool的scan方法" class="headerlink" title="12、ForkJoinPool的scan方法"></a>12、ForkJoinPool的scan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">private ForkJoinTask&lt;?&gt; scan(WorkQueue w, int r) &#123;</span><br><span class="line">    WorkQueue[] ws; int m;</span><br><span class="line">    if ((ws = workQueues) != null &amp;&amp; (m = ws.length - 1) &gt; 0 &amp;&amp; w != null) &#123;</span><br><span class="line">        int ss = w.scanState;                     // initially non-negative</span><br><span class="line">        for (int origin = r &amp; m, k = origin, oldSum = 0, checkSum = 0;;) &#123;</span><br><span class="line">            WorkQueue q; ForkJoinTask&lt;?&gt;[] a; ForkJoinTask&lt;?&gt; t;</span><br><span class="line">            int b, n; long c;</span><br><span class="line">            //从随机下标k，获取队列</span><br><span class="line">            if ((q = ws[k]) != null) &#123;</span><br><span class="line">                if ((n = (b = q.base) - q.top) &lt; 0 &amp;&amp;</span><br><span class="line">                    (a = q.array) != null) &#123;      // non-empty</span><br><span class="line">                    //从下往上获取任务</span><br><span class="line">                    long i = (((a.length - 1) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                    if ((t = ((ForkJoinTask&lt;?&gt;)</span><br><span class="line">                              U.getObjectVolatile(a, i))) != null &amp;&amp;</span><br><span class="line">                        q.base == b) &#123;</span><br><span class="line">                        //工作线程活跃状态</span><br><span class="line">                        if (ss &gt;= 0) &#123;</span><br><span class="line">                            //获取并返回任务</span><br><span class="line">                            if (U.compareAndSwapObject(a, i, t, null)) &#123;</span><br><span class="line">                                q.base = b + 1;</span><br><span class="line">                                //任务较多，创建一个工作线程</span><br><span class="line">                                if (n &lt; -1)       // signal others</span><br><span class="line">                                    signalWork(ws, q);</span><br><span class="line">                                return t;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //工作线程非活跃状态</span><br><span class="line">                        else if (oldSum == 0 &amp;&amp;   // try to activate</span><br><span class="line">                                 w.scanState &lt; 0)</span><br><span class="line">                            //释放一个等待线程</span><br><span class="line">                            tryRelease(c = ctl, ws[m &amp; (int)c], AC_UNIT);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (ss &lt; 0)                   // refresh</span><br><span class="line">                        ss = w.scanState;</span><br><span class="line">                    //获取失败,随机换一个数组下标</span><br><span class="line">                    r ^= r &lt;&lt; 1; r ^= r &gt;&gt;&gt; 3; r ^= r &lt;&lt; 10;</span><br><span class="line">                    origin = k = r &amp; m;           // move and rescan</span><br><span class="line">                    oldSum = checkSum = 0;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                checkSum += b;</span><br><span class="line">            &#125;</span><br><span class="line">            //查找了一圈未找到可偷窃的任务</span><br><span class="line">            if ((k = (k + 1) &amp; m) == origin) &#123;    // continue until stable</span><br><span class="line">                if ((ss &gt;= 0 || (ss == (ss = w.scanState))) &amp;&amp;</span><br><span class="line">                    oldSum == (oldSum = checkSum)) &#123;</span><br><span class="line">                    if (ss &lt; 0 || w.qlock &lt; 0)    // already inactive</span><br><span class="line">                        break;</span><br><span class="line">                    //工作线程转为非活跃状态</span><br><span class="line">                    int ns = ss | INACTIVE;       // try to inactivate</span><br><span class="line">                    //活跃线程数减1</span><br><span class="line">                    long nc = ((SP_MASK &amp; ns) |</span><br><span class="line">                               (UC_MASK &amp; ((c = ctl) - AC_UNIT)));</span><br><span class="line">                    //上一个转非活跃线程的数组下标</span><br><span class="line">                    w.stackPred = (int)c;         // hold prev stack top</span><br><span class="line">                    U.putInt(w, QSCANSTATE, ns);</span><br><span class="line">                    if (U.compareAndSwapLong(this, CTL, c, nc))</span><br><span class="line">                        ss = ns;</span><br><span class="line">                    else</span><br><span class="line">                        w.scanState = ss;         // back out</span><br><span class="line">                &#125;</span><br><span class="line">                checkSum = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、接（一、11）ForkJoinWorkerThread的runTask方法"><a href="#13、接（一、11）ForkJoinWorkerThread的runTask方法" class="headerlink" title="13、接（一、11）ForkJoinWorkerThread的runTask方法"></a>13、接（一、11）ForkJoinWorkerThread的runTask方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">final void runTask(ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">    if (task != null) &#123;</span><br><span class="line">        scanState &amp;= ~SCANNING; // mark as busy</span><br><span class="line">        //执行任务，currentSteal为工作线程当前正在执行的任务</span><br><span class="line">        (currentSteal = task).doExec();</span><br><span class="line">        U.putOrderedObject(this, QCURRENTSTEAL, null); // release for GC</span><br><span class="line">        //执行本线程队列的任务</span><br><span class="line">        execLocalTasks();</span><br><span class="line">        ForkJoinWorkerThread thread = owner;</span><br><span class="line">        if (++nsteals &lt; 0)      // collect on overflow</span><br><span class="line">            transferStealCount(pool);</span><br><span class="line">        scanState |= SCANNING;</span><br><span class="line">        if (thread != null)</span><br><span class="line">            thread.afterTopLevelExec();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、ForkJoinTask的doExec方法"><a href="#14、ForkJoinTask的doExec方法" class="headerlink" title="14、ForkJoinTask的doExec方法"></a>14、ForkJoinTask的doExec方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">final int doExec() &#123;</span><br><span class="line">    int s; boolean completed;</span><br><span class="line">    if ((s = status) &gt;= 0) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //执行任务</span><br><span class="line">            completed = exec();</span><br><span class="line">        &#125; catch (Throwable rex) &#123;</span><br><span class="line">            return setExceptionalCompletion(rex);</span><br><span class="line">        &#125;</span><br><span class="line">        if (completed)</span><br><span class="line">            //更新任务状态，唤醒等待任务结果的线程</span><br><span class="line">            s = setCompletion(NORMAL);</span><br><span class="line">    &#125;</span><br><span class="line">    return s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、ForkJoinTask的exec方法"><a href="#15、ForkJoinTask的exec方法" class="headerlink" title="15、ForkJoinTask的exec方法"></a>15、ForkJoinTask的exec方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean exec() &#123;</span><br><span class="line">    //执行任务</span><br><span class="line">    result = compute();</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、接（一、11）ForkJoinPool的awaitWork方法"><a href="#16、接（一、11）ForkJoinPool的awaitWork方法" class="headerlink" title="16、接（一、11）ForkJoinPool的awaitWork方法"></a>16、接（一、11）ForkJoinPool的awaitWork方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">private boolean awaitWork(WorkQueue w, int r) &#123;</span><br><span class="line">    if (w == null || w.qlock &lt; 0)                 // w is terminating</span><br><span class="line">        return false;</span><br><span class="line">    for (int pred = w.stackPred, spins = SPINS, ss;;) &#123;</span><br><span class="line">        //已激活</span><br><span class="line">        if ((ss = w.scanState) &gt;= 0)</span><br><span class="line">            break;</span><br><span class="line">        else if (spins &gt; 0) &#123;</span><br><span class="line">            r ^= r &lt;&lt; 6; r ^= r &gt;&gt;&gt; 21; r ^= r &lt;&lt; 7;</span><br><span class="line">            if (r &gt;= 0 &amp;&amp; --spins == 0) &#123;         // randomize spins</span><br><span class="line">                WorkQueue v; WorkQueue[] ws; int s, j; AtomicLong sc;</span><br><span class="line">                if (pred != 0 &amp;&amp; (ws = workQueues) != null &amp;&amp;</span><br><span class="line">                    (j = pred &amp; SMASK) &lt; ws.length &amp;&amp;</span><br><span class="line">                    (v = ws[j]) != null &amp;&amp;        // see if pred parking</span><br><span class="line">                    (v.parker == null || v.scanState &gt;= 0))</span><br><span class="line">                    spins = SPINS;                // continue spinning</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (w.qlock &lt; 0)                     // recheck after spins</span><br><span class="line">            return false;</span><br><span class="line">        else if (!Thread.interrupted()) &#123;</span><br><span class="line">            long c, prevctl, parkTime, deadline;</span><br><span class="line">            int ac = (int)((c = ctl) &gt;&gt; AC_SHIFT) + (config &amp; SMASK);</span><br><span class="line">            if ((ac &lt;= 0 &amp;&amp; tryTerminate(false, false)) ||</span><br><span class="line">                (runState &amp; STOP) != 0)           // pool terminating</span><br><span class="line">                return false;</span><br><span class="line">            if (ac &lt;= 0 &amp;&amp; ss == (int)c) &#123;        // is last waiter</span><br><span class="line">                prevctl = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; pred);</span><br><span class="line">                int t = (short)(c &gt;&gt;&gt; TC_SHIFT);  // shrink excess spares</span><br><span class="line">                if (t &gt; 2 &amp;&amp; U.compareAndSwapLong(this, CTL, c, prevctl))</span><br><span class="line">                    return false;                 // else use timed wait</span><br><span class="line">                parkTime = IDLE_TIMEOUT * ((t &gt;= 0) ? 1 : 1 - t);</span><br><span class="line">                deadline = System.nanoTime() + parkTime - TIMEOUT_SLOP;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">                prevctl = parkTime = deadline = 0L;</span><br><span class="line">            Thread wt = Thread.currentThread();</span><br><span class="line">            U.putObject(wt, PARKBLOCKER, this);   // emulate LockSupport</span><br><span class="line">            w.parker = wt;</span><br><span class="line">            //阻塞当前线程</span><br><span class="line">            if (w.scanState &lt; 0 &amp;&amp; ctl == c)      // recheck before park</span><br><span class="line">                U.park(false, parkTime);</span><br><span class="line">            U.putOrderedObject(w, QPARKER, null);</span><br><span class="line">            U.putObject(wt, PARKBLOCKER, null);</span><br><span class="line">            if (w.scanState &gt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            if (parkTime != 0L &amp;&amp; ctl == c &amp;&amp;</span><br><span class="line">                deadline - System.nanoTime() &lt;= 0L &amp;&amp;</span><br><span class="line">                U.compareAndSwapLong(this, CTL, c, prevctl))</span><br><span class="line">                return false;                     // shrink pool</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、ForkJoinTask的fork方法"><a href="#17、ForkJoinTask的fork方法" class="headerlink" title="17、ForkJoinTask的fork方法"></a>17、ForkJoinTask的fork方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public final ForkJoinTask&lt;V&gt; fork() &#123;</span><br><span class="line">    Thread t;</span><br><span class="line">    if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)</span><br><span class="line">        //任务加入该线程的任务池</span><br><span class="line">        ((ForkJoinWorkerThread)t).workQueue.push(this);</span><br><span class="line">    else</span><br><span class="line">        //加入公共任务池</span><br><span class="line">        ForkJoinPool.common.externalPush(this);</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、ForkJoinTask的join方法"><a href="#18、ForkJoinTask的join方法" class="headerlink" title="18、ForkJoinTask的join方法"></a>18、ForkJoinTask的join方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final V join() &#123;</span><br><span class="line">    int s;</span><br><span class="line">    if ((s = doJoin() &amp; DONE_MASK) != NORMAL)</span><br><span class="line">        reportException(s);</span><br><span class="line">    //返回结果</span><br><span class="line">    return getRawResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、ForkJoinTask的doJoin方法"><a href="#19、ForkJoinTask的doJoin方法" class="headerlink" title="19、ForkJoinTask的doJoin方法"></a>19、ForkJoinTask的doJoin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private int doJoin() &#123;</span><br><span class="line">    int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w;</span><br><span class="line">    //线程池线程则参与任务处理，非线程池线程则等待任务结束</span><br><span class="line">    return (s = status) &lt; 0 ? s :</span><br><span class="line">        ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ?</span><br><span class="line">        (w = (wt = (ForkJoinWorkerThread)t).workQueue).</span><br><span class="line">        tryUnpush(this) &amp;&amp; (s = doExec()) &lt; 0 ? s :</span><br><span class="line">        wt.pool.awaitJoin(w, this, 0L) :</span><br><span class="line">        externalAwaitDone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、ForkJoinTask的doJoin方法"><a href="#20、ForkJoinTask的doJoin方法" class="headerlink" title="20、ForkJoinTask的doJoin方法"></a>20、ForkJoinTask的doJoin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private int doJoin() &#123;</span><br><span class="line">    int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w;</span><br><span class="line">    //线程池线程则执行awaitJoin，非线程池线程则执行externalAwaitDone</span><br><span class="line">    return (s = status) &lt; 0 ? s :</span><br><span class="line">        ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ?</span><br><span class="line">        (w = (wt = (ForkJoinWorkerThread)t).workQueue).</span><br><span class="line">        tryUnpush(this) &amp;&amp; (s = doExec()) &lt; 0 ? s :</span><br><span class="line">        wt.pool.awaitJoin(w, this, 0L) :</span><br><span class="line">        externalAwaitDone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="21、ForkJoinPool的awaitJoin方法"><a href="#21、ForkJoinPool的awaitJoin方法" class="headerlink" title="21、ForkJoinPool的awaitJoin方法"></a>21、ForkJoinPool的awaitJoin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">final int awaitJoin(WorkQueue w, ForkJoinTask&lt;?&gt; task, long deadline) &#123;</span><br><span class="line">    int s = 0;</span><br><span class="line">    if (task != null &amp;&amp; w != null) &#123;</span><br><span class="line">        ForkJoinTask&lt;?&gt; prevJoin = w.currentJoin;</span><br><span class="line">        U.putOrderedObject(w, QCURRENTJOIN, task);</span><br><span class="line">        CountedCompleter&lt;?&gt; cc = (task instanceof CountedCompleter) ?</span><br><span class="line">            (CountedCompleter&lt;?&gt;)task : null;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            if ((s = task.status) &lt; 0)</span><br><span class="line">                break;</span><br><span class="line">            if (cc != null)</span><br><span class="line">                helpComplete(w, cc, 0);</span><br><span class="line">            //尝试获取并处理本任务，若任务已被其他线程执行，且本线程队列无任务，则帮助其他线程处理任务</span><br><span class="line">            else if (w.base == w.top || w.tryRemoveAndExec(task))</span><br><span class="line">                //帮助其他线程处理任务</span><br><span class="line">                helpStealer(w, task);</span><br><span class="line">            if ((s = task.status) &lt; 0)</span><br><span class="line">                break;</span><br><span class="line">            long ms, ns;</span><br><span class="line">            if (deadline == 0L)</span><br><span class="line">                ms = 0L;</span><br><span class="line">            else if ((ns = deadline - System.nanoTime()) &lt;= 0L)</span><br><span class="line">                break;</span><br><span class="line">            else if ((ms = TimeUnit.NANOSECONDS.toMillis(ns)) &lt;= 0L)</span><br><span class="line">                ms = 1L;</span><br><span class="line">            //等待的任务未完成，且本线程队列有任务，作一定的补偿</span><br><span class="line">            if (tryCompensate(w)) &#123;</span><br><span class="line">                //任务未完成则线程等待，否则唤醒等待该任务的线程</span><br><span class="line">                task.internalWait(ms);</span><br><span class="line">                U.getAndAddLong(this, CTL, AC_UNIT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        U.putOrderedObject(w, QCURRENTJOIN, prevJoin);</span><br><span class="line">    &#125;</span><br><span class="line">    return s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、WorkQueue的tryRemoveAndExec方法"><a href="#22、WorkQueue的tryRemoveAndExec方法" class="headerlink" title="22、WorkQueue的tryRemoveAndExec方法"></a>22、WorkQueue的tryRemoveAndExec方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">final boolean tryRemoveAndExec(ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; int m, s, b, n;</span><br><span class="line">    if ((a = array) != null &amp;&amp; (m = a.length - 1) &gt;= 0 &amp;&amp;</span><br><span class="line">        task != null) &#123;</span><br><span class="line">        while ((n = (s = top) - (b = base)) &gt; 0) &#123;</span><br><span class="line">            for (ForkJoinTask&lt;?&gt; t;;) &#123;      // traverse from s to b</span><br><span class="line">                //从上往下，查找任务</span><br><span class="line">                long j = ((--s &amp; m) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                if ((t = (ForkJoinTask&lt;?&gt;)U.getObject(a, j)) == null)</span><br><span class="line">                    //任务已被其他线程处理，队列已无任务返回true，有任务返回false</span><br><span class="line">                    return s + 1 == top;     // shorter than expected</span><br><span class="line">                else if (t == task) &#123;</span><br><span class="line">                    boolean removed = false;</span><br><span class="line">                    //task刚好在top位置，pop出来执行</span><br><span class="line">                    if (s + 1 == top) &#123;      // pop</span><br><span class="line">                        if (U.compareAndSwapObject(a, j, task, null)) &#123;</span><br><span class="line">                            U.putOrderedInt(this, QTOP, s);</span><br><span class="line">                            removed = true;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //task在队列中间,则使用EmptyTask来占位,将任务取出来执行</span><br><span class="line">                    else if (base == b)      // replace with proxy</span><br><span class="line">                        removed = U.compareAndSwapObject(</span><br><span class="line">                            a, j, task, new EmptyTask());</span><br><span class="line">                    if (removed)</span><br><span class="line">                        task.doExec();</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                //任务已被取消</span><br><span class="line">                else if (t.status &lt; 0 &amp;&amp; s + 1 == top) &#123;</span><br><span class="line">                    if (U.compareAndSwapObject(a, j, t, null))</span><br><span class="line">                        U.putOrderedInt(this, QTOP, s);</span><br><span class="line">                    break;                  // was cancelled</span><br><span class="line">                &#125;</span><br><span class="line">                if (--n == 0)</span><br><span class="line">                    return false;</span><br><span class="line">            &#125;</span><br><span class="line">            //任务已执行完</span><br><span class="line">            if (task.status &lt; 0)</span><br><span class="line">                return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、ForkJoinPool的helpStealer方法"><a href="#23、ForkJoinPool的helpStealer方法" class="headerlink" title="23、ForkJoinPool的helpStealer方法"></a>23、ForkJoinPool的helpStealer方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">private void helpStealer(WorkQueue w, ForkJoinTask&lt;?&gt; task) &#123;</span><br><span class="line">    WorkQueue[] ws = workQueues;</span><br><span class="line">    int oldSum = 0, checkSum, m;</span><br><span class="line">    if (ws != null &amp;&amp; (m = ws.length - 1) &gt;= 0 &amp;&amp; w != null &amp;&amp;</span><br><span class="line">        task != null) &#123;</span><br><span class="line">        do &#123;                                       // restart point</span><br><span class="line">            checkSum = 0;                          // for stability check</span><br><span class="line">            ForkJoinTask&lt;?&gt; subtask;</span><br><span class="line">            WorkQueue j = w, v;                    // v is subtask stealer</span><br><span class="line">            descent: for (subtask = task; subtask.status &gt;= 0; ) &#123;</span><br><span class="line">                for (int h = j.hint | 1, k = 0, i; ; k += 2) &#123;</span><br><span class="line">                    if (k &gt; m)                     // can&apos;t find stealer</span><br><span class="line">                        break descent;</span><br><span class="line">                    //查找正在执行本任务的线程队列</span><br><span class="line">                    if ((v = ws[i = (h + k) &amp; m]) != null) &#123;</span><br><span class="line">                        if (v.currentSteal == subtask) &#123;</span><br><span class="line">                            j.hint = i;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        checkSum += v.base;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                for (;;) &#123;                         // help v or descend</span><br><span class="line">                    ForkJoinTask&lt;?&gt;[] a; int b;</span><br><span class="line">                    checkSum += (b = v.base);</span><br><span class="line">                    ForkJoinTask&lt;?&gt; next = v.currentJoin;</span><br><span class="line">                    if (subtask.status &lt; 0 || j.currentJoin != subtask ||</span><br><span class="line">                        v.currentSteal != subtask) // stale</span><br><span class="line">                        break descent;</span><br><span class="line">                    //帮助线程的任务队列为空，则去帮助“该线程等待任务”的执行线程</span><br><span class="line">                    if (b - v.top &gt;= 0 || (a = v.array) == null) &#123;</span><br><span class="line">                        if ((subtask = next) == null)</span><br><span class="line">                            break descent;</span><br><span class="line">                        j = v;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //从下往上获取并执行任务</span><br><span class="line">                    int i = (((a.length - 1) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                    ForkJoinTask&lt;?&gt; t = ((ForkJoinTask&lt;?&gt;)</span><br><span class="line">                                         U.getObjectVolatile(a, i));</span><br><span class="line">                    if (v.base == b) &#123;</span><br><span class="line">                        if (t == null)             // stale</span><br><span class="line">                            break descent;</span><br><span class="line">                        if (U.compareAndSwapObject(a, i, t, null)) &#123;</span><br><span class="line">                            v.base = b + 1;</span><br><span class="line">                            ForkJoinTask&lt;?&gt; ps = w.currentSteal;</span><br><span class="line">                            int top = w.top;</span><br><span class="line">                            do &#123;</span><br><span class="line">                                U.putOrderedObject(w, QCURRENTSTEAL, t);</span><br><span class="line">                                t.doExec();        // clear local tasks too</span><br><span class="line">                            &#125; while (task.status &gt;= 0 &amp;&amp;</span><br><span class="line">                                     w.top != top &amp;&amp;</span><br><span class="line">                                     (t = w.pop()) != null);</span><br><span class="line">                            U.putOrderedObject(w, QCURRENTSTEAL, ps);</span><br><span class="line">                            if (w.base != w.top)</span><br><span class="line">                                return;            // can&apos;t further help</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while (task.status &gt;= 0 &amp;&amp; oldSum != (oldSum = checkSum));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="24、接（一、21）ForkJoinPool的tryCompensate方法"><a href="#24、接（一、21）ForkJoinPool的tryCompensate方法" class="headerlink" title="24、接（一、21）ForkJoinPool的tryCompensate方法"></a>24、接（一、21）ForkJoinPool的tryCompensate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">private boolean tryCompensate(WorkQueue w) &#123;</span><br><span class="line">    boolean canBlock;</span><br><span class="line">    WorkQueue[] ws; long c; int m, pc, sp;</span><br><span class="line">    if (w == null || w.qlock &lt; 0 ||           // caller terminating</span><br><span class="line">        (ws = workQueues) == null || (m = ws.length - 1) &lt;= 0 ||</span><br><span class="line">        (pc = config &amp; SMASK) == 0)           // parallelism disabled</span><br><span class="line">        canBlock = false;</span><br><span class="line">    //唤醒一个阻塞线程，补偿该线程</span><br><span class="line">    else if ((sp = (int)(c = ctl)) != 0)      // release idle worker</span><br><span class="line">        canBlock = tryRelease(c, ws[sp &amp; m], 0L);</span><br><span class="line">    else &#123;</span><br><span class="line">        int ac = (int)(c &gt;&gt; AC_SHIFT) + pc;</span><br><span class="line">        int tc = (short)(c &gt;&gt; TC_SHIFT) + pc;</span><br><span class="line">        int nbusy = 0;                        // validate saturation</span><br><span class="line">        for (int i = 0; i &lt;= m; ++i) &#123;        // two passes of odd indices</span><br><span class="line">            WorkQueue v;</span><br><span class="line">            if ((v = ws[((i &lt;&lt; 1) | 1) &amp; m]) != null) &#123;</span><br><span class="line">                if ((v.scanState &amp; SCANNING) != 0)</span><br><span class="line">                    break;</span><br><span class="line">                ++nbusy;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (nbusy != (tc &lt;&lt; 1) || ctl != c)</span><br><span class="line">            canBlock = false;                 // unstable or stale</span><br><span class="line">        //直接阻塞，无需补偿</span><br><span class="line">        else if (tc &gt;= pc &amp;&amp; ac &gt; 1 &amp;&amp; w.isEmpty()) &#123;</span><br><span class="line">            long nc = ((AC_MASK &amp; (c - AC_UNIT)) |</span><br><span class="line">                       (~AC_MASK &amp; c));       // uncompensated</span><br><span class="line">            canBlock = U.compareAndSwapLong(this, CTL, c, nc);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (tc &gt;= MAX_CAP ||</span><br><span class="line">                 (this == common &amp;&amp; tc &gt;= pc + commonMaxSpares))</span><br><span class="line">            throw new RejectedExecutionException(</span><br><span class="line">                &quot;Thread limit exceeded replacing blocked worker&quot;);</span><br><span class="line">        else &#123;                                // similar to tryAddWorker</span><br><span class="line">            boolean add = false; int rs;      // CAS within lock</span><br><span class="line">            long nc = ((AC_MASK &amp; c) |</span><br><span class="line">                       (TC_MASK &amp; (c + TC_UNIT)));</span><br><span class="line">            if (((rs = lockRunState()) &amp; STOP) == 0)</span><br><span class="line">                add = U.compareAndSwapLong(this, CTL, c, nc);</span><br><span class="line">            unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">            //创建新线程，补偿该线程</span><br><span class="line">            canBlock = add &amp;&amp; createWorker(); // throws on exception</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return canBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25、ForkJoinPool的shutdown方法"><a href="#25、ForkJoinPool的shutdown方法" class="headerlink" title="25、ForkJoinPool的shutdown方法"></a>25、ForkJoinPool的shutdown方法</h4><p>关闭线程池<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void shutdown() &#123;</span><br><span class="line">    checkPermission();</span><br><span class="line">    //关闭线程池</span><br><span class="line">    tryTerminate(false, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="25、ForkJoinPool的tryTerminate方法"><a href="#25、ForkJoinPool的tryTerminate方法" class="headerlink" title="25、ForkJoinPool的tryTerminate方法"></a>25、ForkJoinPool的tryTerminate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">private boolean tryTerminate(boolean now, boolean enable) &#123;</span><br><span class="line">    int rs;</span><br><span class="line">    //公共池不能关闭</span><br><span class="line">    if (this == common)                       // cannot shut down</span><br><span class="line">        return false;</span><br><span class="line">    if ((rs = runState) &gt;= 0) &#123;</span><br><span class="line">        if (!enable)</span><br><span class="line">            return false;</span><br><span class="line">        rs = lockRunState();                  // enter SHUTDOWN phase</span><br><span class="line">        //进入关闭阶段</span><br><span class="line">        unlockRunState(rs, (rs &amp; ~RSLOCK) | SHUTDOWN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((rs &amp; STOP) == 0) &#123;</span><br><span class="line">        if (!now) &#123;                           // check quiescence</span><br><span class="line">            for (long oldSum = 0L;;) &#123;        // repeat until stable</span><br><span class="line">                WorkQueue[] ws; WorkQueue w; int m, b; long c;</span><br><span class="line">                long checkSum = ctl;</span><br><span class="line">                if ((int)(checkSum &gt;&gt; AC_SHIFT) + (config &amp; SMASK) &gt; 0)</span><br><span class="line">                    return false;             // still active workers</span><br><span class="line">                if ((ws = workQueues) == null || (m = ws.length - 1) &lt;= 0)</span><br><span class="line">                    break;                    // check queues</span><br><span class="line">                //释放阻塞的队列</span><br><span class="line">                for (int i = 0; i &lt;= m; ++i) &#123;</span><br><span class="line">                    if ((w = ws[i]) != null) &#123;</span><br><span class="line">                        if ((b = w.base) != w.top || w.scanState &gt;= 0 ||</span><br><span class="line">                            w.currentSteal != null) &#123;</span><br><span class="line">                            tryRelease(c = ctl, ws[m &amp; (int)c], AC_UNIT);</span><br><span class="line">                            return false;     // arrange for recheck</span><br><span class="line">                        &#125;</span><br><span class="line">                        checkSum += b;</span><br><span class="line">                        if ((i &amp; 1) == 0)</span><br><span class="line">                            w.qlock = -1;     // try to disable external</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (oldSum == (oldSum = checkSum))</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if ((runState &amp; STOP) == 0) &#123;</span><br><span class="line">            rs = lockRunState();              // enter STOP phase</span><br><span class="line">            //进入stop阶段</span><br><span class="line">            unlockRunState(rs, (rs &amp; ~RSLOCK) | STOP);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int pass = 0;                             // 3 passes to help terminate</span><br><span class="line">    for (long oldSum = 0L;;) &#123;                // or until done or stable</span><br><span class="line">        WorkQueue[] ws; WorkQueue w; ForkJoinWorkerThread wt; int m;</span><br><span class="line">        long checkSum = ctl;</span><br><span class="line">        if ((short)(checkSum &gt;&gt;&gt; TC_SHIFT) + (config &amp; SMASK) &lt;= 0 ||</span><br><span class="line">            (ws = workQueues) == null || (m = ws.length - 1) &lt;= 0) &#123;</span><br><span class="line">            if ((runState &amp; TERMINATED) == 0) &#123;</span><br><span class="line">                rs = lockRunState();          // done</span><br><span class="line">                //进入TERMINATED阶段</span><br><span class="line">                unlockRunState(rs, (rs &amp; ~RSLOCK) | TERMINATED);</span><br><span class="line">                synchronized (this) &#123; notifyAll(); &#125; // for awaitTermination</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        //取消未完成任务，中断工作线程</span><br><span class="line">        for (int i = 0; i &lt;= m; ++i) &#123;</span><br><span class="line">            if ((w = ws[i]) != null) &#123;</span><br><span class="line">                checkSum += w.base;</span><br><span class="line">                w.qlock = -1;                 // try to disable</span><br><span class="line">                if (pass &gt; 0) &#123;</span><br><span class="line">                    w.cancelAll();            // clear queue</span><br><span class="line">                    if (pass &gt; 1 &amp;&amp; (wt = w.owner) != null) &#123;</span><br><span class="line">                        if (!wt.isInterrupted()) &#123;</span><br><span class="line">                            try &#123;             // unblock join</span><br><span class="line">                                wt.interrupt();</span><br><span class="line">                            &#125; catch (Throwable ignore) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (w.scanState &lt; 0)</span><br><span class="line">                            U.unpark(wt);     // wake up</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (checkSum != oldSum) &#123;             // unstable</span><br><span class="line">            oldSum = checkSum;</span><br><span class="line">            pass = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (pass &gt; 3 &amp;&amp; pass &gt; m)        // can&apos;t further help</span><br><span class="line">            break;</span><br><span class="line">        else if (++pass &gt; 1) &#123;                // try to dequeue</span><br><span class="line">            long c; int j = 0, sp;            // bound attempts</span><br><span class="line">            while (j++ &lt;= m &amp;&amp; (sp = (int)(c = ctl)) != 0)</span><br><span class="line">                tryRelease(c, ws[sp &amp; m], AC_UNIT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;demo&quot;&gt;&lt;a href=&quot;#demo&quot; class=&quot;headerlink&quot; title=&quot;demo&quot;&gt;&lt;/a&gt;demo&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
      <category term="java.util.concurrent" scheme="http://yoursite.com/categories/java-util-concurrent/"/>
    
    
  </entry>
  
  <entry>
    <title>JUC线程池(1)ThreadPoolExecutor</title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E7%BA%BF%E7%A8%8B%E6%B1%A0(1)ThreadPoolExecutor/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC线程池(1)ThreadPoolExecutor/</id>
    <published>2018-05-06T13:48:30.179Z</published>
    <updated>2018-06-28T14:03:50.231Z</updated>
    
    <content type="html"><![CDATA[<h4 id="线程池demo"><a href="#线程池demo" class="headerlink" title="线程池demo"></a>线程池demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class ThreadPoolDemo1 &#123;</span><br><span class="line">   public static void main(String[] args) &#123;</span><br><span class="line">// 创建一个可重用固定线程数的线程池</span><br><span class="line">ExecutorService pool = Executors.newFixedThreadPool(2);</span><br><span class="line">// 创建实现了Runnable接口对象，Thread对象当然也实现了Runnable接口</span><br><span class="line">Thread ta = new MyThread();</span><br><span class="line">Thread tb = new MyThread();</span><br><span class="line">Thread tc = new MyThread();</span><br><span class="line">Thread td = new MyThread();</span><br><span class="line">Thread te = new MyThread();</span><br><span class="line">// 将线程放入池中进行执行</span><br><span class="line">pool.execute(ta);</span><br><span class="line">pool.execute(tb);</span><br><span class="line">pool.execute(tc);</span><br><span class="line">pool.execute(td);</span><br><span class="line">pool.execute(te);</span><br><span class="line">// 关闭线程池</span><br><span class="line">pool.shutdown();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyThread extends Thread &#123;</span><br><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">System.out.println(Thread.currentThread().getName()+ &quot; is running.&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一、ThreadPoolExecutor"><a href="#一、ThreadPoolExecutor" class="headerlink" title="一、ThreadPoolExecutor"></a>一、ThreadPoolExecutor</h3><h4 id="1、Executors的newFixedThreadPool方法"><a href="#1、Executors的newFixedThreadPool方法" class="headerlink" title="1、Executors的newFixedThreadPool方法"></a>1、Executors的newFixedThreadPool方法</h4><p>创建线程池<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static ExecutorService newFixedThreadPool(int nThreads) &#123;</span><br><span class="line">    return new ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                  0L, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  new LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>线程池状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RUNNING    -- 对应的高3位值是111</span><br><span class="line">            线程池的初始化状态是RUNNING，</span><br><span class="line">            线程池处在RUNNING状态时，能够接收新任务，以及对已添加的任务进行处理</span><br><span class="line">SHUTDOWN   -- 对应的高3位值是000</span><br><span class="line">            调用线程池的shutdown()接口时，线程池由RUNNING -&gt; SHUTDOWN</span><br><span class="line">            线程池处在SHUTDOWN状态时，不接收新任务，但能处理已添加的任务。</span><br><span class="line">STOP       -- 对应的高3位值是001</span><br><span class="line">            调用线程池的shutdownNow()接口时，线程池由(RUNNING or SHUTDOWN ) -&gt; STOP</span><br><span class="line">            线程池处在STOP状态时，不接收新任务，不处理已添加的任务，并且会中断正在处理的任务</span><br><span class="line">TIDYING    -- 对应的高3位值是010，</span><br><span class="line">            当线程池在SHUTDOWN状态下，阻塞队列为空并且线程池中执行的任务也为空时，就会由 SHUTDOWN -&gt; TIDYING</span><br><span class="line">            当线程池在STOP状态下，线程池中执行的任务为空时，就会由STOP -&gt; TIDYING</span><br><span class="line">            当线程池变为TIDYING状态时，会执行钩子函数terminated()。terminated()在ThreadPoolExecutor类中是空的</span><br><span class="line">TERMINATED -- 对应的高3位值是011</span><br><span class="line">            线程池处在TIDYING状态时，执行完terminated()之后，就会由 TIDYING -&gt; TERMINATED</span><br><span class="line">            线程池彻底终止，就变成TERMINATED状态</span><br></pre></td></tr></table></figure></p><h4 id="2、实例化ThreadPoolExecutor"><a href="#2、实例化ThreadPoolExecutor" class="headerlink" title="2、实例化ThreadPoolExecutor"></a>2、实例化ThreadPoolExecutor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public ThreadPoolExecutor(int corePoolSize,</span><br><span class="line">                          int maximumPoolSize,</span><br><span class="line">                          long keepAliveTime,</span><br><span class="line">                          TimeUnit unit,</span><br><span class="line">                          BlockingQueue&lt;Runnable&gt; workQueue) &#123;</span><br><span class="line">    this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><br><span class="line">         Executors.defaultThreadFactory(), defaultHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public ThreadPoolExecutor(int corePoolSize,</span><br><span class="line">                          int maximumPoolSize,</span><br><span class="line">                          long keepAliveTime,</span><br><span class="line">                          TimeUnit unit,</span><br><span class="line">                          BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="line">                          ThreadFactory threadFactory,</span><br><span class="line">                          RejectedExecutionHandler handler) &#123;</span><br><span class="line">    if (corePoolSize &lt; 0 ||</span><br><span class="line">        maximumPoolSize &lt;= 0 ||</span><br><span class="line">        maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">        keepAliveTime &lt; 0)</span><br><span class="line">        throw new IllegalArgumentException();</span><br><span class="line">    if (workQueue == null || threadFactory == null || handler == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    this.acc = System.getSecurityManager() == null ?</span><br><span class="line">            null :</span><br><span class="line">            AccessController.getContext();</span><br><span class="line">    // 核心池大小</span><br><span class="line">    this.corePoolSize = corePoolSize;</span><br><span class="line">    // 最大池大小</span><br><span class="line">    this.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    // 线程池的等待队列</span><br><span class="line">    this.workQueue = workQueue;</span><br><span class="line">    this.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    // 线程工厂对象，默认DefaultThreadFactory</span><br><span class="line">    this.threadFactory = threadFactory;</span><br><span class="line">    // 拒绝策略，默认AbortPolicy 抛出异常</span><br><span class="line">    this.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ThreadPoolExecutor的execute方法"><a href="#3、ThreadPoolExecutor的execute方法" class="headerlink" title="3、ThreadPoolExecutor的execute方法"></a>3、ThreadPoolExecutor的execute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void execute(Runnable command) &#123;</span><br><span class="line">    // 如果任务为null，则抛出异常。</span><br><span class="line">    if (command == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    // 获取ctl对应的int值。c保存了后29位保存线程池中任务的数量，前3位保存线程池状态信息</span><br><span class="line">    int c = ctl.get();</span><br><span class="line">    // 当线程池中的任务数量 &lt; 核心池大小时，即线程池中少于corePoolSize个任务</span><br><span class="line">    if (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        // 则通过addWorker(command, true)新建一个线程，</span><br><span class="line">        // 并添加到该线程中；然后，启动该线程从而执行任务。</span><br><span class="line">        if (addWorker(command, true))</span><br><span class="line">            return;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    // 当线程池中的任务数量 &gt;= 核心池大小时，则尝试将任务添加到阻塞队列中</span><br><span class="line">    if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        int recheck = ctl.get();</span><br><span class="line">        // 若线程池异常终止了，则删除任务；然后通过reject()执行相应的拒绝策略的内容</span><br><span class="line">        if (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        // 如果&quot;线程池中任务数量&quot;为0，则通过addWorker(null, false)尝试新建一个线程</span><br><span class="line">        else if (workerCountOf(recheck) == 0)</span><br><span class="line">            addWorker(null, false);</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果addWorker(command, false)执行失败，则通过reject()执行相应的拒绝策略的内容</span><br><span class="line">    else if (!addWorker(command, false))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、ThreadPoolExecutor的addWorker方法"><a href="#4、ThreadPoolExecutor的addWorker方法" class="headerlink" title="4、ThreadPoolExecutor的addWorker方法"></a>4、ThreadPoolExecutor的addWorker方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">private boolean addWorker(Runnable firstTask, boolean core) &#123;</span><br><span class="line">    retry:</span><br><span class="line">    // 更新线程池状态和计数，即更新ctl</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        // 获取ctl对应的int值</span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        // 获取线程池状态</span><br><span class="line">        int rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        // 必要时，坚持等待队列是否为空</span><br><span class="line">        if (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">               firstTask == null &amp;&amp;</span><br><span class="line">               ! workQueue.isEmpty()))</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            // 获取线程池中任务的数量</span><br><span class="line">            int wc = workerCountOf(c);</span><br><span class="line">            // 如果线程池中任务的数量超过限制，则返回false</span><br><span class="line">            if (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                return false;</span><br><span class="line">            // 通过CAS函数将c的值+1。操作成功的话，则退出循环</span><br><span class="line">            if (compareAndIncrementWorkerCount(c))</span><br><span class="line">                break retry;</span><br><span class="line">            c = ctl.get();  // Re-read ctl</span><br><span class="line">            // 检查线程池状态，如果与之前的状态不同，则从retry重新开始</span><br><span class="line">            if (runStateOf(c) != rs)</span><br><span class="line">                continue retry;</span><br><span class="line">            // else CAS failed due to workerCount change; retry inner loop</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boolean workerStarted = false;</span><br><span class="line">    boolean workerAdded = false;</span><br><span class="line">    Worker w = null;</span><br><span class="line">    // 添加任务到线程池，并启动任务所在的线程</span><br><span class="line">    try &#123;</span><br><span class="line">        // 新建Worker，并且指定firstTask为Worker的第一个任务</span><br><span class="line">        w = new Worker(firstTask);</span><br><span class="line">        // 获取Worker对应的线程</span><br><span class="line">        final Thread t = w.thread;</span><br><span class="line">        if (t != null) &#123;</span><br><span class="line">            final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">            // 获取锁</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                int rs = runStateOf(ctl.get());</span><br><span class="line">                // 确认线程池状态</span><br><span class="line">                if (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123;</span><br><span class="line">                    if (t.isAlive()) // precheck that t is startable</span><br><span class="line">                        throw new IllegalThreadStateException();</span><br><span class="line">                    // 将Worker对象(w)添加到线程池的Worker集合(workers)中</span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    // 更新largestPoolSize</span><br><span class="line">                    int s = workers.size();</span><br><span class="line">                    if (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                // 释放锁</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            // 如果成功将任务添加到线程池中，则启动任务所在的线程</span><br><span class="line">            if (workerAdded) &#123;</span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    // 返回任务是否启动</span><br><span class="line">    return workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、Worker的run方法"><a href="#4、Worker的run方法" class="headerlink" title="4、Worker的run方法"></a>4、Worker的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    runWorker(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、Worker的runWorker方法"><a href="#5、Worker的runWorker方法" class="headerlink" title="5、Worker的runWorker方法"></a>5、Worker的runWorker方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">final void runWorker(Worker w) &#123;</span><br><span class="line">    Thread wt = Thread.currentThread();</span><br><span class="line">    Runnable task = w.firstTask;</span><br><span class="line">    w.firstTask = null;</span><br><span class="line">    w.unlock(); // allow interrupts</span><br><span class="line">    boolean completedAbruptly = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取任务</span><br><span class="line">        while (task != null || (task = getTask()) != null) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            //检查线程池状态</span><br><span class="line">            if ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            try &#123;</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                Throwable thrown = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //执行任务</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; catch (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; throw x;</span><br><span class="line">                &#125; catch (Error x) &#123;</span><br><span class="line">                    thrown = x; throw x;</span><br><span class="line">                &#125; catch (Throwable x) &#123;</span><br><span class="line">                    thrown = x; throw new Error(x);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                task = null;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = false;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //关闭worker</span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、Worker的getTask方法"><a href="#6、Worker的getTask方法" class="headerlink" title="6、Worker的getTask方法"></a>6、Worker的getTask方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private Runnable getTask() &#123;</span><br><span class="line">    boolean timedOut = false; // Did the last poll() time out?</span><br><span class="line"></span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        int rs = runStateOf(c);</span><br><span class="line">        //检查线程池状态</span><br><span class="line">        if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line">        // worker是否要关闭</span><br><span class="line">        if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123;</span><br><span class="line">            if (compareAndDecrementWorkerCount(c))</span><br><span class="line">                return null;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //获取任务</span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take();</span><br><span class="line">            if (r != null)</span><br><span class="line">                return r;</span><br><span class="line">            timedOut = true;</span><br><span class="line">        &#125; catch (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（一、5）Worker的processWorkerExit方法"><a href="#7、接（一、5）Worker的processWorkerExit方法" class="headerlink" title="7、接（一、5）Worker的processWorkerExit方法"></a>7、接（一、5）Worker的processWorkerExit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private void processWorkerExit(Worker w, boolean completedAbruptly) &#123;</span><br><span class="line">    //减少worker数量</span><br><span class="line">    if (completedAbruptly) // If abrupt, then workerCount wasn&apos;t adjusted</span><br><span class="line">        decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">    final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line">        //删除该worker</span><br><span class="line">        workers.remove(w);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //尝试彻底关闭线程池</span><br><span class="line">    tryTerminate();</span><br><span class="line"></span><br><span class="line">    int c = ctl.get();</span><br><span class="line">    if (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">        if (!completedAbruptly) &#123;</span><br><span class="line">            int min = allowCoreThreadTimeOut ? 0 : corePoolSize;</span><br><span class="line">            if (min == 0 &amp;&amp; ! workQueue.isEmpty())</span><br><span class="line">                min = 1;</span><br><span class="line">            if (workerCountOf(c) &gt;= min)</span><br><span class="line">                return; // replacement not needed</span><br><span class="line">        &#125;</span><br><span class="line">        //线程池未停止，尝试增加一个worker</span><br><span class="line">        addWorker(null, false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、ThreadPoolExecutor的tryTerminate方法"><a href="#8、ThreadPoolExecutor的tryTerminate方法" class="headerlink" title="8、ThreadPoolExecutor的tryTerminate方法"></a>8、ThreadPoolExecutor的tryTerminate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">final void tryTerminate() &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        if (isRunning(c) ||</span><br><span class="line">            runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">            return;</span><br><span class="line">        if (workerCountOf(c) != 0) &#123; // Eligible to terminate</span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">        mainLock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            //将线程池状态转换为TIDYING</span><br><span class="line">            if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //钩子函数，在ThreadPoolExecutor中没有任何动作</span><br><span class="line">                    terminated();</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    //彻底关闭线程池</span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, 0));</span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                &#125;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        // else retry on failed CAS</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、ThreadPoolExecutor的shutdown方法"><a href="#9、ThreadPoolExecutor的shutdown方法" class="headerlink" title="9、ThreadPoolExecutor的shutdown方法"></a>9、ThreadPoolExecutor的shutdown方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void shutdown() &#123;</span><br><span class="line">    final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        // 检查终止线程池的线程是否有权限</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        // 设置线程池的状态为关闭状态</span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        // 中断线程池中空闲的线程</span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        // 钩子函数，在ThreadPoolExecutor中没有任何动作</span><br><span class="line">        onShutdown(); // hook for ScheduledThreadPoolExecutor</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、ThreadPoolExecutor的advanceRunState方法"><a href="#10、ThreadPoolExecutor的advanceRunState方法" class="headerlink" title="10、ThreadPoolExecutor的advanceRunState方法"></a>10、ThreadPoolExecutor的advanceRunState方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void advanceRunState(int targetState) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int c = ctl.get();</span><br><span class="line">        //尚未关闭，则尝试关闭</span><br><span class="line">        if (runStateAtLeast(c, targetState) ||</span><br><span class="line">            ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))))</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、ThreadPoolExecutor的interruptIdleWorkers方法"><a href="#11、ThreadPoolExecutor的interruptIdleWorkers方法" class="headerlink" title="11、ThreadPoolExecutor的interruptIdleWorkers方法"></a>11、ThreadPoolExecutor的interruptIdleWorkers方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private void interruptIdleWorkers() &#123;</span><br><span class="line">    interruptIdleWorkers(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、ThreadPoolExecutor的interruptIdleWorkers方法"><a href="#12、ThreadPoolExecutor的interruptIdleWorkers方法" class="headerlink" title="12、ThreadPoolExecutor的interruptIdleWorkers方法"></a>12、ThreadPoolExecutor的interruptIdleWorkers方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private void interruptIdleWorkers(boolean onlyOne) &#123;</span><br><span class="line">    final ReentrantLock mainLock = this.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        for (Worker w : workers) &#123;</span><br><span class="line">            Thread t = w.thread;</span><br><span class="line">            if (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //中断工作线程</span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; catch (SecurityException ignore) &#123;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (onlyOne)</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、Callable和Future"><a href="#二、Callable和Future" class="headerlink" title="二、Callable和Future"></a>二、Callable和Future</h3><p>####demo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class MyCallable implements Callable &#123;</span><br><span class="line"></span><br><span class="line">    @Override </span><br><span class="line">    public Integer call() throws Exception &#123;</span><br><span class="line">        int sum    = 0;</span><br><span class="line">       // 执行任务</span><br><span class="line">       for (int i=0; i&lt;100; i++)</span><br><span class="line">           sum += i;</span><br><span class="line">       //return sum; </span><br><span class="line">       return Integer.valueOf(sum);</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class CallableTest1 &#123;</span><br><span class="line">    public static void main(String[] args) </span><br><span class="line">        throws ExecutionException, InterruptedException&#123;</span><br><span class="line">        //创建一个线程池</span><br><span class="line">       ExecutorService pool = Executors.newSingleThreadExecutor();</span><br><span class="line">       //创建有返回值的任务</span><br><span class="line">       Callable c1 = new MyCallable();</span><br><span class="line">       //执行任务并获取Future对象 </span><br><span class="line">       Future f1 = pool.submit(c1);</span><br><span class="line">       // 输出结果</span><br><span class="line">       System.out.println(f1.get()); </span><br><span class="line">       //关闭线程池 </span><br><span class="line">       pool.shutdown(); </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="1、AbstractExecutorService的submit方法"><a href="#1、AbstractExecutorService的submit方法" class="headerlink" title="1、AbstractExecutorService的submit方法"></a>1、AbstractExecutorService的submit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) &#123;</span><br><span class="line">    if (task == null) throw new NullPointerException();</span><br><span class="line">    //Callable包装成FutureTask</span><br><span class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span><br><span class="line">    //包装后的FutureTask加入线程池</span><br><span class="line">    execute(ftask);</span><br><span class="line">    return ftask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、实例化FutureTask"><a href="#2、实例化FutureTask" class="headerlink" title="2、实例化FutureTask"></a>2、实例化FutureTask</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = FutureTask.class;</span><br><span class="line">        //任务状态</span><br><span class="line">        stateOffset = UNSAFE.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;state&quot;));</span><br><span class="line">        //执行任务的线程</span><br><span class="line">        runnerOffset = UNSAFE.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;runner&quot;));</span><br><span class="line">        ///等待获取任务的线程队列</span><br><span class="line">        waitersOffset = UNSAFE.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(&quot;waiters&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public FutureTask(Callable&lt;V&gt; callable) &#123;</span><br><span class="line">    if (callable == null)</span><br><span class="line">        throw new NullPointerException();</span><br><span class="line">    this.callable = callable;</span><br><span class="line">    this.state = NEW;       // ensure visibility of callable</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、FutureTask的run方法"><a href="#3、FutureTask的run方法" class="headerlink" title="3、FutureTask的run方法"></a>3、FutureTask的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    if (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(this, runnerOffset,</span><br><span class="line">                                     null, Thread.currentThread()))</span><br><span class="line">        return;</span><br><span class="line">    try &#123;</span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        if (c != null &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            boolean ran;</span><br><span class="line">            try &#123;</span><br><span class="line">                //执行callable</span><br><span class="line">                result = c.call();</span><br><span class="line">                ran = true;</span><br><span class="line">            &#125; catch (Throwable ex) &#123;</span><br><span class="line">                result = null;</span><br><span class="line">                ran = false;</span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            if (ran)</span><br><span class="line">                //更新结果</span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // runner must be non-null until state is settled to</span><br><span class="line">        // prevent concurrent calls to run()</span><br><span class="line">        runner = null;</span><br><span class="line">        // state must be re-read after nulling runner to prevent</span><br><span class="line">        // leaked interrupts</span><br><span class="line">        int s = state;</span><br><span class="line">        if (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、FutureTask的set方法"><a href="#3、FutureTask的set方法" class="headerlink" title="3、FutureTask的set方法"></a>3、FutureTask的set方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected void set(V v) &#123;</span><br><span class="line">    //更新任务状态</span><br><span class="line">    if (UNSAFE.compareAndSwapInt(this, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        outcome = v;</span><br><span class="line">        //更新任务状态</span><br><span class="line">        UNSAFE.putOrderedInt(this, stateOffset, NORMAL); // final state</span><br><span class="line">        //任务完成，唤醒等待获取结果的线程</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、FutureTask的finishCompletion方法"><a href="#4、FutureTask的finishCompletion方法" class="headerlink" title="4、FutureTask的finishCompletion方法"></a>4、FutureTask的finishCompletion方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void finishCompletion() &#123;</span><br><span class="line">    // assert state &gt; COMPLETING;</span><br><span class="line">    for (WaitNode q; (q = waiters) != null;) &#123;</span><br><span class="line">        if (UNSAFE.compareAndSwapObject(this, waitersOffset, q, null)) &#123;</span><br><span class="line">            for (;;) &#123;</span><br><span class="line">                Thread t = q.thread;</span><br><span class="line">                if (t != null) &#123;</span><br><span class="line">                    q.thread = null;</span><br><span class="line">                    //唤醒线程</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                &#125;</span><br><span class="line">                WaitNode next = q.next;</span><br><span class="line">                if (next == null)</span><br><span class="line">                    break;</span><br><span class="line">                q.next = null; // unlink to help gc</span><br><span class="line">                q = next;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    done();</span><br><span class="line"></span><br><span class="line">    callable = null;        // to reduce footprint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、FutureTask的get方法"><a href="#5、FutureTask的get方法" class="headerlink" title="5、FutureTask的get方法"></a>5、FutureTask的get方法</h4><p>获取任务结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public V get() throws InterruptedException, ExecutionException &#123;</span><br><span class="line">    int s = state;</span><br><span class="line">    //任务尚未执行完成，线程进入等待</span><br><span class="line">    if (s &lt;= COMPLETING)</span><br><span class="line">        s = awaitDone(false, 0L);</span><br><span class="line">    //返回结果</span><br><span class="line">    return report(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、FutureTask的awaitDone方法"><a href="#6、FutureTask的awaitDone方法" class="headerlink" title="6、FutureTask的awaitDone方法"></a>6、FutureTask的awaitDone方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private int awaitDone(boolean timed, long nanos)</span><br><span class="line">    throws InterruptedException &#123;</span><br><span class="line">    final long deadline = timed ? System.nanoTime() + nanos : 0L;</span><br><span class="line">    WaitNode q = null;</span><br><span class="line">    boolean queued = false;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        //线程终止，清除本线程节点</span><br><span class="line">        if (Thread.interrupted()) &#123;</span><br><span class="line">            removeWaiter(q);</span><br><span class="line">            throw new InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int s = state;</span><br><span class="line">        //任务已完成</span><br><span class="line">        if (s &gt; COMPLETING) &#123;</span><br><span class="line">            if (q != null)</span><br><span class="line">                q.thread = null;</span><br><span class="line">            return s;</span><br><span class="line">        &#125;</span><br><span class="line">        //正在完成</span><br><span class="line">        else if (s == COMPLETING) // cannot time out yet</span><br><span class="line">            Thread.yield();</span><br><span class="line">        //创建节点</span><br><span class="line">        else if (q == null)</span><br><span class="line">            q = new WaitNode();</span><br><span class="line">        //节点加入队列</span><br><span class="line">        else if (!queued)</span><br><span class="line">            queued = UNSAFE.compareAndSwapObject(this, waitersOffset,</span><br><span class="line">                                                 q.next = waiters, q);</span><br><span class="line">        //阻塞该线程</span><br><span class="line">        else if (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            if (nanos &lt;= 0L) &#123;</span><br><span class="line">                removeWaiter(q);</span><br><span class="line">                return state;</span><br><span class="line">            &#125;</span><br><span class="line">            LockSupport.parkNanos(this, nanos);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">            LockSupport.park(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（二、5）FutureTask的report方法"><a href="#7、接（二、5）FutureTask的report方法" class="headerlink" title="7、接（二、5）FutureTask的report方法"></a>7、接（二、5）FutureTask的report方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">private V report(int s) throws ExecutionException &#123;</span><br><span class="line">    Object x = outcome;</span><br><span class="line">    if (s == NORMAL)</span><br><span class="line">        //返回任务结果</span><br><span class="line">        return (V)x;</span><br><span class="line">    if (s &gt;= CANCELLED)</span><br><span class="line">        throw new CancellationException();</span><br><span class="line">    throw new ExecutionException((Throwable)x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;线程池demo&quot;&gt;&lt;a href=&quot;#线程池demo&quot; class=&quot;headerlink&quot; title=&quot;线程池demo&quot;&gt;&lt;/a&gt;线程池demo&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=
      
    
    </summary>
    
      <category term="java.util.concurrent" scheme="http://yoursite.com/categories/java-util-concurrent/"/>
    
    
  </entry>
  
  <entry>
    <title>JUC原子类</title>
    <link href="http://yoursite.com/2018/05/06/JUC%E6%BA%90%E7%A0%81/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%20/"/>
    <id>http://yoursite.com/2018/05/06/JUC源码/JUC原子类 /</id>
    <published>2018-05-06T13:48:30.176Z</published>
    <updated>2018-06-28T14:04:11.717Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、AtomicLong源码"><a href="#一、AtomicLong源码" class="headerlink" title="一、AtomicLong源码"></a>一、AtomicLong源码</h3><h4 id="1、实例化AtomicLong"><a href="#1、实例化AtomicLong" class="headerlink" title="1、实例化AtomicLong"></a>1、实例化AtomicLong</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取AtomicLong类的value字段，在AtomicLong对象中的地址偏移量</span><br><span class="line">        valueOffset = unsafe.objectFieldOffset(AtomicLong.class.getDeclaredField(&quot;value&quot;));</span><br><span class="line">    &#125; catch (Exception ex) &#123; throw new Error(ex); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public AtomicLong() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AtomicLong的incrementAndGet方法"><a href="#2、AtomicLong的incrementAndGet方法" class="headerlink" title="2、AtomicLong的incrementAndGet方法"></a>2、AtomicLong的incrementAndGet方法</h4><p>以incrementAndGet为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public final long incrementAndGet() &#123;</span><br><span class="line">    //AtomicLong对象的valueOffset位置的值加一，并返回原来的值加一</span><br><span class="line">    return unsafe.getAndAddLong(this, valueOffset, 1L) + 1L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、Unsafe的getAndAddLong方法"><a href="#3、Unsafe的getAndAddLong方法" class="headerlink" title="3、Unsafe的getAndAddLong方法"></a>3、Unsafe的getAndAddLong方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final long getAndAddLong(Object arg0, long arg1, long arg3) &#123;</span><br><span class="line">    long arg5;</span><br><span class="line">    do &#123;</span><br><span class="line">        //获取arg0对象arg1位置的值</span><br><span class="line">        arg5 = this.getLongVolatile(arg0, arg1);</span><br><span class="line">        //将arg0对象arg1位置的值，由arg5改为arg5 + arg3，成功返回true，失败返回false</span><br><span class="line">    &#125; while (!this.compareAndSwapLong(arg0, arg1, arg5, arg5 + arg3));</span><br><span class="line">    return arg5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、AtomicLongArray源码"><a href="#二、AtomicLongArray源码" class="headerlink" title="二、AtomicLongArray源码"></a>二、AtomicLongArray源码</h3><h4 id="1、实例化AtomicLongArray"><a href="#1、实例化AtomicLongArray" class="headerlink" title="1、实例化AtomicLongArray"></a>1、实例化AtomicLongArray</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    //获取数组中一个元素的大小(get size of an element in the array) </span><br><span class="line">    int scale = unsafe.arrayIndexScale(long[].class);</span><br><span class="line">    if ((scale &amp; (scale - 1)) != 0)</span><br><span class="line">        throw new Error(&quot;data type scale not a power of two&quot;);</span><br><span class="line">    //scale为2的shift次方</span><br><span class="line">    shift = 31 - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public AtomicLongArray(int length) &#123;</span><br><span class="line">    array = new long[length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、Integer的numberOfLeadingZeros方法"><a href="#2、Integer的numberOfLeadingZeros方法" class="headerlink" title="2、Integer的numberOfLeadingZeros方法"></a>2、Integer的numberOfLeadingZeros方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static int numberOfLeadingZeros(int i) &#123;</span><br><span class="line">    // HD, Figure 5-6</span><br><span class="line">    if (i == 0)</span><br><span class="line">        return 32;</span><br><span class="line">    int n = 1;</span><br><span class="line">    //判断i的左16位是否为零</span><br><span class="line">    if (i &gt;&gt;&gt; 16 == 0) &#123; n += 16; i &lt;&lt;= 16; &#125;</span><br><span class="line">    //判断不为零的那半部分，左八位是否为零</span><br><span class="line">    if (i &gt;&gt;&gt; 24 == 0) &#123; n +=  8; i &lt;&lt;=  8; &#125;</span><br><span class="line">    if (i &gt;&gt;&gt; 28 == 0) &#123; n +=  4; i &lt;&lt;=  4; &#125;</span><br><span class="line">    if (i &gt;&gt;&gt; 30 == 0) &#123; n +=  2; i &lt;&lt;=  2; &#125;</span><br><span class="line">    n -= i &gt;&gt;&gt; 31;</span><br><span class="line">    //返回i，首部0的个数</span><br><span class="line">    return n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、AtomicLongArray的incrementAndGet方法"><a href="#3、AtomicLongArray的incrementAndGet方法" class="headerlink" title="3、AtomicLongArray的incrementAndGet方法"></a>3、AtomicLongArray的incrementAndGet方法</h4><p>以incrementAndGet为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public final long incrementAndGet(int i) &#123;</span><br><span class="line">    return getAndAdd(i, 1) + 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、AtomicLongArray的getAndAdd方法"><a href="#4、AtomicLongArray的getAndAdd方法" class="headerlink" title="4、AtomicLongArray的getAndAdd方法"></a>4、AtomicLongArray的getAndAdd方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public final long getAndAdd(int i, long delta) &#123;</span><br><span class="line">    return unsafe.getAndAddLong(array, checkedByteOffset(i), delta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、AtomicLongArray的checkedByteOffset方法"><a href="#5、AtomicLongArray的checkedByteOffset方法" class="headerlink" title="5、AtomicLongArray的checkedByteOffset方法"></a>5、AtomicLongArray的checkedByteOffset方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private long checkedByteOffset(int i) &#123;</span><br><span class="line">    if (i &lt; 0 || i &gt;= array.length)</span><br><span class="line">        throw new IndexOutOfBoundsException(&quot;index &quot; + i);</span><br><span class="line">    return byteOffset(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、AtomicLongArray的byteOffset方法"><a href="#6、AtomicLongArray的byteOffset方法" class="headerlink" title="6、AtomicLongArray的byteOffset方法"></a>6、AtomicLongArray的byteOffset方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private static long byteOffset(int i) &#123;</span><br><span class="line">    //数组第i的元素的地址偏移</span><br><span class="line">    return ((long) i &lt;&lt; shift) + base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>base为数组在AtomicLongArray中的地址偏移<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final int base = unsafe.arrayBaseOffset(long[].class);</span><br></pre></td></tr></table></figure></p><h4 id="7、接（二、4）Unsafe的getAndAddLong方法"><a href="#7、接（二、4）Unsafe的getAndAddLong方法" class="headerlink" title="7、接（二、4）Unsafe的getAndAddLong方法"></a>7、接（二、4）Unsafe的getAndAddLong方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final long getAndAddLong(Object arg0, long arg1, long arg3) &#123;</span><br><span class="line">    long arg5;</span><br><span class="line">    do &#123;</span><br><span class="line">        arg5 = this.getLongVolatile(arg0, arg1);</span><br><span class="line">    &#125; while (!this.compareAndSwapLong(arg0, arg1, arg5, arg5 + arg3));</span><br><span class="line"></span><br><span class="line">    return arg5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、AtomicReference源码"><a href="#三、AtomicReference源码" class="headerlink" title="三、AtomicReference源码"></a>三、AtomicReference源码</h3><h4 id="1、实例化AtomicReference"><a href="#1、实例化AtomicReference" class="headerlink" title="1、实例化AtomicReference"></a>1、实例化AtomicReference</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取value对象在AtomicReference对象中的地址偏移</span><br><span class="line">        valueOffset = unsafe.objectFieldOffset</span><br><span class="line">            (AtomicReference.class.getDeclaredField(&quot;value&quot;));</span><br><span class="line">    &#125; catch (Exception ex) &#123; throw new Error(ex); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public AtomicReference() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、AtomicReference的getAndSet方法"><a href="#2、AtomicReference的getAndSet方法" class="headerlink" title="2、AtomicReference的getAndSet方法"></a>2、AtomicReference的getAndSet方法</h4><p>以getAndSet为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public final V getAndSet(V newValue) &#123;</span><br><span class="line">    return (V)unsafe.getAndSetObject(this, valueOffset, newValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、Unsafe的getAndSetObject方法"><a href="#3、Unsafe的getAndSetObject方法" class="headerlink" title="3、Unsafe的getAndSetObject方法"></a>3、Unsafe的getAndSetObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final Object getAndSetObject(Object arg0, long arg1, Object arg3) &#123;</span><br><span class="line">    Object arg4;</span><br><span class="line">    do &#123;</span><br><span class="line">        //获取arg0对象arg1位置的对象</span><br><span class="line">        arg4 = this.getObjectVolatile(arg0, arg1);</span><br><span class="line">    &#125; while (!this.compareAndSwapObject(arg0, arg1, arg4, arg3));</span><br><span class="line">    return arg4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、AtomicLongFieldUpdater源码"><a href="#三、AtomicLongFieldUpdater源码" class="headerlink" title="三、AtomicLongFieldUpdater源码"></a>三、AtomicLongFieldUpdater源码</h3><h4 id="1、实例化AtomicLongFieldUpdater"><a href="#1、实例化AtomicLongFieldUpdater" class="headerlink" title="1、实例化AtomicLongFieldUpdater"></a>1、实例化AtomicLongFieldUpdater</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@CallerSensitive</span><br><span class="line">public static &lt;U&gt; AtomicLongFieldUpdater&lt;U&gt; newUpdater(Class&lt;U&gt; tclass,</span><br><span class="line">                                                       String fieldName) &#123;</span><br><span class="line">    Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">    if (AtomicLong.VM_SUPPORTS_LONG_CAS)</span><br><span class="line">        //JVM支持long类型的CAS函数</span><br><span class="line">        return new CASUpdater&lt;U&gt;(tclass, fieldName, caller);</span><br><span class="line">    else</span><br><span class="line">        //JVM不支持long类型的CAS函数</span><br><span class="line">        return new LockedUpdater&lt;U&gt;(tclass, fieldName, caller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">CASUpdater(final Class&lt;T&gt; tclass, final String fieldName,</span><br><span class="line">               final Class&lt;?&gt; caller) &#123;</span><br><span class="line">    final Field field;</span><br><span class="line">    final int modifiers;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取tclass的fieldName字段</span><br><span class="line">        field = AccessController.doPrivileged(</span><br><span class="line">            new PrivilegedExceptionAction&lt;Field&gt;() &#123;</span><br><span class="line">                public Field run() throws NoSuchFieldException &#123;</span><br><span class="line">                    return tclass.getDeclaredField(fieldName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        //该字段的修饰</span><br><span class="line">        modifiers = field.getModifiers();</span><br><span class="line">        sun.reflect.misc.ReflectUtil.ensureMemberAccess(</span><br><span class="line">            caller, tclass, null, modifiers);</span><br><span class="line">        ClassLoader cl = tclass.getClassLoader();</span><br><span class="line">        ClassLoader ccl = caller.getClassLoader();</span><br><span class="line">        if ((ccl != null) &amp;&amp; (ccl != cl) &amp;&amp;</span><br><span class="line">            ((cl == null) || !isAncestor(cl, ccl))) &#123;</span><br><span class="line">            sun.reflect.misc.ReflectUtil.checkPackageAccess(tclass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (PrivilegedActionException pae) &#123;</span><br><span class="line">        throw new RuntimeException(pae.getException());</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">        throw new RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    this.cclass = (Modifier.isProtected(modifiers) &amp;&amp;</span><br><span class="line">                   tclass.isAssignableFrom(caller) &amp;&amp;</span><br><span class="line">                   !isSamePackage(tclass, caller))</span><br><span class="line">                  ? caller : tclass;</span><br><span class="line">    this.tclass = tclass;</span><br><span class="line">    //获取字段的地址偏移</span><br><span class="line">    this.offset = U.objectFieldOffset(field);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">LockedUpdater(final Class&lt;T&gt; tclass, final String fieldName,</span><br><span class="line">                      final Class&lt;?&gt; caller) &#123;</span><br><span class="line">            Field field = null;</span><br><span class="line">            int modifiers = 0;</span><br><span class="line">            try &#123;</span><br><span class="line">                field = AccessController.doPrivileged(</span><br><span class="line">                    new PrivilegedExceptionAction&lt;Field&gt;() &#123;</span><br><span class="line">                        public Field run() throws NoSuchFieldException &#123;</span><br><span class="line">                            return tclass.getDeclaredField(fieldName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                modifiers = field.getModifiers();</span><br><span class="line">                sun.reflect.misc.ReflectUtil.ensureMemberAccess(</span><br><span class="line">                    caller, tclass, null, modifiers);</span><br><span class="line">                ClassLoader cl = tclass.getClassLoader();</span><br><span class="line">                ClassLoader ccl = caller.getClassLoader();</span><br><span class="line">                if ((ccl != null) &amp;&amp; (ccl != cl) &amp;&amp;</span><br><span class="line">                    ((cl == null) || !isAncestor(cl, ccl))) &#123;</span><br><span class="line">                    sun.reflect.misc.ReflectUtil.checkPackageAccess(tclass);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (PrivilegedActionException pae) &#123;</span><br><span class="line">                throw new RuntimeException(pae.getException());</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                throw new RuntimeException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            this.cclass = (Modifier.isProtected(modifiers) &amp;&amp;</span><br><span class="line">                           tclass.isAssignableFrom(caller) &amp;&amp;</span><br><span class="line">                           !isSamePackage(tclass, caller))</span><br><span class="line">                          ? caller : tclass;</span><br><span class="line">            this.tclass = tclass;</span><br><span class="line">            this.offset = U.objectFieldOffset(field);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="2、CASUpdater的compareAndSet方法"><a href="#2、CASUpdater的compareAndSet方法" class="headerlink" title="2、CASUpdater的compareAndSet方法"></a>2、CASUpdater的compareAndSet方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public final boolean compareAndSet(T obj, long expect, long update) &#123;</span><br><span class="line">    //检查该对象是不是tclass的实例</span><br><span class="line">    accessCheck(obj);</span><br><span class="line">    //将obj对象的offset地址的expect值替换为update，成功返回true，失败返回fasle</span><br><span class="line">    return U.compareAndSwapLong(obj, offset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、LockedUpdater的compareAndSet方法"><a href="#2、LockedUpdater的compareAndSet方法" class="headerlink" title="2、LockedUpdater的compareAndSet方法"></a>2、LockedUpdater的compareAndSet方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> public final boolean compareAndSet(T obj, long expect, long update) &#123;</span><br><span class="line">    accessCheck(obj);</span><br><span class="line">    //获取LockedUpdater的对象锁</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        //获取obj的offset地址的值</span><br><span class="line">        long v = U.getLong(obj, offset);</span><br><span class="line">        //验证获取的值是否等于expect</span><br><span class="line">        if (v != expect)</span><br><span class="line">            return false;</span><br><span class="line">        //设置obj的offset地址的为update</span><br><span class="line">        U.putLong(obj, offset, update);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、AtomicLong源码&quot;&gt;&lt;a href=&quot;#一、AtomicLong源码&quot; class=&quot;headerlink&quot; title=&quot;一、AtomicLong源码&quot;&gt;&lt;/a&gt;一、AtomicLong源码&lt;/h3&gt;&lt;h4 id=&quot;1、实例化AtomicLong&quot;&gt;
      
    
    </summary>
    
      <category term="java.util.concurrent" scheme="http://yoursite.com/categories/java-util-concurrent/"/>
    
    
  </entry>
  
  <entry>
    <title>mybatis源码配置文件加载过程</title>
    <link href="http://yoursite.com/2018/04/20/mybatis3%E6%BA%90%E7%A0%81/mybatis%E6%BA%90%E7%A0%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"/>
    <id>http://yoursite.com/2018/04/20/mybatis3源码/mybatis源码配置文件加载过程/</id>
    <published>2018-04-20T12:41:54.496Z</published>
    <updated>2018-06-28T14:04:52.581Z</updated>
    
    <content type="html"><![CDATA[<h4 id="mybatis-Demo"><a href="#mybatis-Demo" class="headerlink" title="mybatis Demo"></a>mybatis Demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">       //io加载配置文件</span><br><span class="line">       InputStream in=Main.class.getResourceAsStream(&quot;resource/mybatis-cfg.xml&quot;);</span><br><span class="line">       //根据inputstream构建session工厂</span><br><span class="line">       SqlSessionFactory factory=new SqlSessionFactoryBuilder().build(in);</span><br><span class="line">       //创建session</span><br><span class="line">       SqlSession session=factory.openSession();</span><br><span class="line">       //取得mapper对象 调用mapper方法</span><br><span class="line">       DemoMapper mapper=session.getMapper(DemoMapper.class);</span><br><span class="line">       Demo demo=new Demo();</span><br><span class="line">       demo.setId(20);</span><br><span class="line">       demo.setName(&quot;demo&quot;);</span><br><span class="line">       mapper.insertStudent(demo);</span><br><span class="line">       demo=mapper.selectOneById(2);</span><br><span class="line">       List&lt;Demo&gt; demoList=mapper.selectAllDemo();</span><br><span class="line">       //提交，insert需要提交</span><br><span class="line">       session.commit();</span><br><span class="line">       //关闭资源</span><br><span class="line">       session.close();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="一、属性和别名加载过程"><a href="#一、属性和别名加载过程" class="headerlink" title="一、属性和别名加载过程"></a>一、属性和别名加载过程</h3><h4 id="1、SqlSessionFactoryBuilder的build方法"><a href="#1、SqlSessionFactoryBuilder的build方法" class="headerlink" title="1、SqlSessionFactoryBuilder的build方法"></a>1、SqlSessionFactoryBuilder的build方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">        //XMLConfigBuilder.parse(),解析配置文件，返回了一个Configuration对象 </span><br><span class="line">        return build(parser.parse());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">        try &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            // Intentionally ignore. Prefer previous error.</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、XMLConfigBuilder的parse方法"><a href="#2、XMLConfigBuilder的parse方法" class="headerlink" title="2、XMLConfigBuilder的parse方法"></a>2、XMLConfigBuilder的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> public Configuration parse() &#123;</span><br><span class="line">     if (parsed) &#123;</span><br><span class="line">         throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">     parsed = true;</span><br><span class="line">     //解析配置文件configuration节点，加载到Configuration对象中</span><br><span class="line">     parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</span><br><span class="line">     return configuration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、XMLConfigBuilder的parseConfiguration方法"><a href="#3、XMLConfigBuilder的parseConfiguration方法" class="headerlink" title="3、XMLConfigBuilder的parseConfiguration方法"></a>3、XMLConfigBuilder的parseConfiguration方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void parseConfiguration(XNode root) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //加载properties节点,一般是定义一些变量</span><br><span class="line">        propertiesElement(root.evalNode(&quot;properties&quot;)); </span><br><span class="line">        //加载别名</span><br><span class="line">        typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">        //拦截器</span><br><span class="line">        pluginElement(root.evalNode(&quot;plugins&quot;));</span><br><span class="line">        objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</span><br><span class="line">        objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">        settingsElement(root.evalNode(&quot;settings&quot;));</span><br><span class="line">        //环境</span><br><span class="line">        environmentsElement(root.evalNode(&quot;environments&quot;)); </span><br><span class="line">        databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</span><br><span class="line">        typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</span><br><span class="line">        //加载Mapper的配置文件，最主要的有两个：一个是sql的定义，一个是resultMap</span><br><span class="line">        mapperElement(root.evalNode(&quot;mappers&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、XMLConfigBuilder的propertiesElement方法"><a href="#4、XMLConfigBuilder的propertiesElement方法" class="headerlink" title="4、XMLConfigBuilder的propertiesElement方法"></a>4、XMLConfigBuilder的propertiesElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void propertiesElement(XNode context) throws Exception &#123;</span><br><span class="line">    if (context != null) &#123;</span><br><span class="line">        //先加载property子节点下的属性</span><br><span class="line">        Properties defaults = context.getChildrenAsProperties();</span><br><span class="line">        String resource = context.getStringAttribute(&quot;resource&quot;);</span><br><span class="line">        String url = context.getStringAttribute(&quot;url&quot;)</span><br><span class="line">        //不能同时设置resource属性和url属性</span><br><span class="line">        if (resource != null &amp;&amp; url != null) &#123;</span><br><span class="line">            throw new BuilderException(&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (resource != null) &#123;</span><br><span class="line">            //会覆盖子节点的配置</span><br><span class="line">            defaults.putAll(Resources.getResourceAsProperties(resource));</span><br><span class="line">        &#125; else if (url != null) &#123;</span><br><span class="line">            //会覆盖子节点的配置</span><br><span class="line">            defaults.putAll(Resources.getUrlAsProperties(url));</span><br><span class="line">        &#125;</span><br><span class="line">        Properties vars = configuration.getVariables();</span><br><span class="line">        if (vars != null) &#123;</span><br><span class="line">            defaults.putAll(vars);</span><br><span class="line">        &#125;</span><br><span class="line">        parser.setVariables(defaults);</span><br><span class="line">        //加载到configuration中</span><br><span class="line">        configuration.setVariables(defaults);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>properties配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties resource=&quot;resource/config.properties&quot;&gt;  </span><br><span class="line">    &lt;property name=&quot;username&quot; value=&quot;dev&quot;/&gt;  </span><br><span class="line">    &lt;property name=&quot;password&quot; value=&quot;12345&quot;/&gt;  </span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure></p><h4 id="5、接（一、3）XMLConfigBuilder的typeAliasesElement方法"><a href="#5、接（一、3）XMLConfigBuilder的typeAliasesElement方法" class="headerlink" title="5、接（一、3）XMLConfigBuilder的typeAliasesElement方法"></a>5、接（一、3）XMLConfigBuilder的typeAliasesElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void typeAliasesElement(XNode parent) &#123;</span><br><span class="line">    if (parent != null) &#123;</span><br><span class="line">        for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">                String typeAliasPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">                //package的方式，将包下所有类的注解别名(若无则用类名作为别名)，注册到TypeAliasRegistry的TYPE_ALIASES中</span><br><span class="line">                configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //获取别名</span><br><span class="line">                String alias = child.getStringAttribute(&quot;alias&quot;);</span><br><span class="line">                //获取类全名</span><br><span class="line">                String type = child.getStringAttribute(&quot;type&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    //获取类</span><br><span class="line">                    Class&lt;?&gt; clazz = Resources.classForName(type);</span><br><span class="line">                    if (alias == null) &#123;</span><br><span class="line">                        //以类名作为别名注册</span><br><span class="line">                        typeAliasRegistry.registerAlias(clazz);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        //注册别名</span><br><span class="line">                        typeAliasRegistry.registerAlias(alias, clazz);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    throw new BuilderException(&quot;Error registering typeAlias for &apos;&quot; + alias + &quot;&apos;. Cause: &quot; + e, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>typeAliases配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;typeAliases&gt;</span><br><span class="line">    &lt;!-- 单个别名定义 --&gt;</span><br><span class="line">    &lt;typeAlias alias=&quot;demo&quot; type=&quot;com.mhr.dto.Demo&quot;/&gt;</span><br><span class="line">    &lt;!-- 批量别名定义，扫描整个包下的类，别名为类名（首字母大写或小写都可以） --&gt;</span><br><span class="line">    &lt;package name=&quot;com.mhr.dto&quot;/&gt;</span><br><span class="line">&lt;/typeAliases&gt;</span><br></pre></td></tr></table></figure></p><h4 id="6、实例化TypeAliasRegistry"><a href="#6、实例化TypeAliasRegistry" class="headerlink" title="6、实例化TypeAliasRegistry"></a>6、实例化TypeAliasRegistry</h4><p>//默认别名配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public TypeAliasRegistry() &#123;</span><br><span class="line">    registerAlias(&quot;string&quot;, String.class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;byte&quot;, Byte.class);</span><br><span class="line">    registerAlias(&quot;long&quot;, Long.class);</span><br><span class="line">    registerAlias(&quot;short&quot;, Short.class);</span><br><span class="line">    registerAlias(&quot;int&quot;, Integer.class);</span><br><span class="line">    registerAlias(&quot;integer&quot;, Integer.class);</span><br><span class="line">    registerAlias(&quot;double&quot;, Double.class);</span><br><span class="line">    registerAlias(&quot;float&quot;, Float.class);</span><br><span class="line">    registerAlias(&quot;boolean&quot;, Boolean.class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;byte[]&quot;, Byte[].class);</span><br><span class="line">    registerAlias(&quot;long[]&quot;, Long[].class);</span><br><span class="line">    registerAlias(&quot;short[]&quot;, Short[].class);</span><br><span class="line">    registerAlias(&quot;int[]&quot;, Integer[].class);</span><br><span class="line">    registerAlias(&quot;integer[]&quot;, Integer[].class);</span><br><span class="line">    registerAlias(&quot;double[]&quot;, Double[].class);</span><br><span class="line">    registerAlias(&quot;float[]&quot;, Float[].class);</span><br><span class="line">    registerAlias(&quot;boolean[]&quot;, Boolean[].class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;_byte&quot;, byte.class);</span><br><span class="line">    registerAlias(&quot;_long&quot;, long.class);</span><br><span class="line">    registerAlias(&quot;_short&quot;, short.class);</span><br><span class="line">    registerAlias(&quot;_int&quot;, int.class);</span><br><span class="line">    registerAlias(&quot;_integer&quot;, int.class);</span><br><span class="line">    registerAlias(&quot;_double&quot;, double.class);</span><br><span class="line">    registerAlias(&quot;_float&quot;, float.class);</span><br><span class="line">    registerAlias(&quot;_boolean&quot;, boolean.class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;_byte[]&quot;, byte[].class);</span><br><span class="line">    registerAlias(&quot;_long[]&quot;, long[].class);</span><br><span class="line">    registerAlias(&quot;_short[]&quot;, short[].class);</span><br><span class="line">    registerAlias(&quot;_int[]&quot;, int[].class);</span><br><span class="line">    registerAlias(&quot;_integer[]&quot;, int[].class);</span><br><span class="line">    registerAlias(&quot;_double[]&quot;, double[].class);</span><br><span class="line">    registerAlias(&quot;_float[]&quot;, float[].class);</span><br><span class="line">    registerAlias(&quot;_boolean[]&quot;, boolean[].class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;date&quot;, Date.class);</span><br><span class="line">    registerAlias(&quot;decimal&quot;, BigDecimal.class);</span><br><span class="line">    registerAlias(&quot;bigdecimal&quot;, BigDecimal.class);</span><br><span class="line">    registerAlias(&quot;biginteger&quot;, BigInteger.class);</span><br><span class="line">    registerAlias(&quot;object&quot;, Object.class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;date[]&quot;, Date[].class);</span><br><span class="line">    registerAlias(&quot;decimal[]&quot;, BigDecimal[].class);</span><br><span class="line">    registerAlias(&quot;bigdecimal[]&quot;, BigDecimal[].class);</span><br><span class="line">    registerAlias(&quot;biginteger[]&quot;, BigInteger[].class);</span><br><span class="line">    registerAlias(&quot;object[]&quot;, Object[].class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;map&quot;, Map.class);</span><br><span class="line">    registerAlias(&quot;hashmap&quot;, HashMap.class);</span><br><span class="line">    registerAlias(&quot;list&quot;, List.class);</span><br><span class="line">    registerAlias(&quot;arraylist&quot;, ArrayList.class);</span><br><span class="line">    registerAlias(&quot;collection&quot;, Collection.class);</span><br><span class="line">    registerAlias(&quot;iterator&quot;, Iterator.class);</span><br><span class="line"></span><br><span class="line">    registerAlias(&quot;ResultSet&quot;, ResultSet.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、接（一、3）XMLConfigBuilder的environmentsElement方法"><a href="#7、接（一、3）XMLConfigBuilder的environmentsElement方法" class="headerlink" title="7、接（一、3）XMLConfigBuilder的environmentsElement方法"></a>7、接（一、3）XMLConfigBuilder的environmentsElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void environmentsElement(XNode context) throws Exception &#123;</span><br><span class="line">    if (context != null) &#123;</span><br><span class="line">        if (environment == null) &#123;</span><br><span class="line">            //获取默认环境</span><br><span class="line">            environment = context.getStringAttribute(&quot;default&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        for (XNode child : context.getChildren()) &#123;</span><br><span class="line">            String id = child.getStringAttribute(&quot;id&quot;);</span><br><span class="line">            //判断id是否等于默认</span><br><span class="line">            if (isSpecifiedEnvironment(id)) &#123;</span><br><span class="line">                //创建事务工厂，JdbcTransactionFactory</span><br><span class="line">                TransactionFactory txFactory = transactionManagerElement(child.evalNode(&quot;transactionManager&quot;));</span><br><span class="line">                //创建数据源工厂，PooledDataSourceFactory</span><br><span class="line">                DataSourceFactory dsFactory = dataSourceElement(child.evalNode(&quot;dataSource&quot;));</span><br><span class="line">                //获取数据源,PooledDataSource</span><br><span class="line">                DataSource dataSource = dsFactory.getDataSource();</span><br><span class="line">                Environment.Builder environmentBuilder = new Environment.Builder(id)</span><br><span class="line">                      .transactionFactory(txFactory)</span><br><span class="line">                      .dataSource(dataSource);</span><br><span class="line">                //将环境加载到configuration中</span><br><span class="line">                configuration.setEnvironment(environmentBuilder.build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>environment配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;environments default=&quot;development&quot;&gt;  </span><br><span class="line">     &lt;environment id=&quot;development&quot;&gt;  </span><br><span class="line">         &lt;transactionManager type=&quot;JDBC&quot; /&gt;  </span><br><span class="line">         &lt;!-- 配置数据库连接信息 --&gt;  </span><br><span class="line">         &lt;dataSource type=&quot;POOLED&quot;&gt;  </span><br><span class="line">             &lt;!-- value属性值引用db.properties配置文件中配置的值 --&gt;  </span><br><span class="line">             &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot; /&gt;  </span><br><span class="line">             &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot; /&gt;  </span><br><span class="line">             &lt;property name=&quot;username&quot; value=&quot;$&#123;name&#125;&quot; /&gt;  </span><br><span class="line">             &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot; /&gt;  </span><br><span class="line">         &lt;/dataSource&gt;  </span><br><span class="line">     &lt;/environment&gt;  </span><br><span class="line"> &lt;/environments&gt;</span><br></pre></td></tr></table></figure></p><h3 id="二、mapper文件加载过程"><a href="#二、mapper文件加载过程" class="headerlink" title="二、mapper文件加载过程"></a>二、mapper文件加载过程</h3><h4 id="1、接（一、3）XMLConfigBuilder的mapperElement方法"><a href="#1、接（一、3）XMLConfigBuilder的mapperElement方法" class="headerlink" title="1、接（一、3）XMLConfigBuilder的mapperElement方法"></a>1、接（一、3）XMLConfigBuilder的mapperElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private void mapperElement(XNode parent) throws Exception &#123;</span><br><span class="line">    if (parent != null) &#123;</span><br><span class="line">        for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            if (&quot;package&quot;.equals(child.getName())) &#123;</span><br><span class="line">                String mapperPackage = child.getStringAttribute(&quot;name&quot;);</span><br><span class="line">                configuration.addMappers(mapperPackage);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                String resource = child.getStringAttribute(&quot;resource&quot;);</span><br><span class="line">                String url = child.getStringAttribute(&quot;url&quot;);</span><br><span class="line">                String mapperClass = child.getStringAttribute(&quot;class&quot;);</span><br><span class="line">                if (resource != null &amp;&amp; url == null &amp;&amp; mapperClass == null) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(resource);</span><br><span class="line">                    InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">                    //由XMLMapperBuilder对象解析加载 </span><br><span class="line">                    XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; else if (resource == null &amp;&amp; url != null &amp;&amp; mapperClass == null) &#123;</span><br><span class="line">                    ErrorContext.instance().resource(url);</span><br><span class="line">                    InputStream inputStream = Resources.getUrlAsStream(url);</span><br><span class="line">                    //由XMLMapperBuilder对象解析加载</span><br><span class="line">                    XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());</span><br><span class="line">                    mapperParser.parse();</span><br><span class="line">                &#125; else if (resource == null &amp;&amp; url == null &amp;&amp; mapperClass != null) &#123;</span><br><span class="line">                    Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">                    configuration.addMapper(mapperInterface);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    throw new BuilderException(&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mappers配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;mappers&gt;       </span><br><span class="line">    //class 级别的指定,非注解模式的话xml配置文件必须和这个类在同一级目录，且与Mapper类同名  </span><br><span class="line">    &lt;mapper class=&quot;com.mhr.mapper.DemoMapper&quot;/&gt;  </span><br><span class="line">    //非注解模式的话xml配置文件必须也处于同一级 package 下，且与Mapper类同名</span><br><span class="line">    &lt;package name=&quot;com.mhr.mapper&quot;/&gt; </span><br><span class="line">    //使用这个方案，可以单独指定Mapper的位置 </span><br><span class="line">    &lt;mapper resource=&quot;mybatis/mappings/DemoMapper.xml&quot;/&gt;  </span><br><span class="line">&lt;/mappers&gt;</span><br></pre></td></tr></table></figure></p><h4 id="2、XMLMapperBuilder的parse方法"><a href="#2、XMLMapperBuilder的parse方法" class="headerlink" title="2、XMLMapperBuilder的parse方法"></a>2、XMLMapperBuilder的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  public void parse() &#123;</span><br><span class="line">      if (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">          //真正解析</span><br><span class="line">          configurationElement(parser.evalNode(&quot;/mapper&quot;));</span><br><span class="line"></span><br><span class="line">          configuration.addLoadedResource(resource);</span><br><span class="line">          bindMapperForNamespace();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      parsePendingResultMaps();</span><br><span class="line">      parsePendingChacheRefs();</span><br><span class="line">      parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、XMLMapperBuilder的configurationElement方法"><a href="#3、XMLMapperBuilder的configurationElement方法" class="headerlink" title="3、XMLMapperBuilder的configurationElement方法"></a>3、XMLMapperBuilder的configurationElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">private void configurationElement(XNode context) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //命名空间</span><br><span class="line">        String namespace = context.getStringAttribute(&quot;namespace&quot;);</span><br><span class="line">        if (namespace.equals(&quot;&quot;)) &#123;</span><br><span class="line">            throw new BuilderException(&quot;Mapper&apos;s namespace cannot be empty&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">        //引用其他命名空间中的缓存</span><br><span class="line">        cacheRefElement(context.evalNode(&quot;cache-ref&quot;));</span><br><span class="line">        //为当前的命名空间配置缓存</span><br><span class="line">        cacheElement(context.evalNode(&quot;cache&quot;));</span><br><span class="line">        //解析parameterMap节点，Mybatis3中官方已经不推荐使用parameterMap配置</span><br><span class="line">        parameterMapElement(context.evalNodes(&quot;/mapper/parameterMap&quot;));</span><br><span class="line">        //解析resultMap</span><br><span class="line">        resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;));</span><br><span class="line">        //解析sql片段</span><br><span class="line">        sqlElement(context.evalNodes(&quot;/mapper/sql&quot;));</span><br><span class="line">        //解析sql</span><br><span class="line">        buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Error parsing Mapper XML. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、XMLMapperBuilder的configurationElement方法"><a href="#4、XMLMapperBuilder的configurationElement方法" class="headerlink" title="4、XMLMapperBuilder的configurationElement方法"></a>4、XMLMapperBuilder的configurationElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void cacheRefElement(XNode context) &#123;</span><br><span class="line">    if (context != null) &#123;</span><br><span class="line">        //向cacheRefMap中添加命名空间的缓存策略的映射</span><br><span class="line">        configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute(&quot;namespace&quot;));</span><br><span class="line">        CacheRefResolver cacheRefResolver = new CacheRefResolver(builderAssistant, context.getStringAttribute(&quot;namespace&quot;));</span><br><span class="line">        try &#123;</span><br><span class="line">            //将引用命名空间的缓存策略，设置到当前命名空间</span><br><span class="line">            cacheRefResolver.resolveCacheRef();</span><br><span class="line">        &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">            configuration.addIncompleteCacheRef(cacheRefResolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cache-ref配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;cache-ref namespace=&quot;com.mhr.mapper.DemoMapper&quot;/&gt;</span><br></pre></td></tr></table></figure></p><h4 id="5、接（二、3）XMLMapperBuilder的cacheElement方法"><a href="#5、接（二、3）XMLMapperBuilder的cacheElement方法" class="headerlink" title="5、接（二、3）XMLMapperBuilder的cacheElement方法"></a>5、接（二、3）XMLMapperBuilder的cacheElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void cacheElement(XNode context) throws Exception &#123;</span><br><span class="line">    if (context != null) &#123;</span><br><span class="line">        //缓存类型，默认为PERPETUAL,为永久的</span><br><span class="line">        String type = context.getStringAttribute(&quot;type&quot;, &quot;PERPETUAL&quot;);</span><br><span class="line">        Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type);</span><br><span class="line">        //回收策略，LRU,最少使用的被回收 </span><br><span class="line">        String eviction = context.getStringAttribute(&quot;eviction&quot;, &quot;LRU&quot;);</span><br><span class="line">        Class&lt;? extends Cache&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);</span><br><span class="line">        //刷新缓存间隔</span><br><span class="line">        Long flushInterval = context.getLongAttribute(&quot;flushInterval&quot;);</span><br><span class="line">        //缓存大小</span><br><span class="line">        Integer size = context.getIntAttribute(&quot;size&quot;);</span><br><span class="line">        boolean readWrite = !context.getBooleanAttribute(&quot;readOnly&quot;, false);</span><br><span class="line">        Properties props = context.getChildrenAsProperties();</span><br><span class="line">        //构建一个Cache对象，并加入Configuration</span><br><span class="line">        builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cache配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;cache  </span><br><span class="line">    eviction=&quot;FIFO&quot;  </span><br><span class="line">    flushInterval=&quot;60000&quot;  </span><br><span class="line">    size=&quot;512&quot;  </span><br><span class="line">    readOnly=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure></p><h4 id="6、MapperBuilderAssistant的useNewCache方法"><a href="#6、MapperBuilderAssistant的useNewCache方法" class="headerlink" title="6、MapperBuilderAssistant的useNewCache方法"></a>6、MapperBuilderAssistant的useNewCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public Cache useNewCache(Class&lt;? extends Cache&gt; typeClass,</span><br><span class="line">      Class&lt;? extends Cache&gt; evictionClass,</span><br><span class="line">      Long flushInterval,</span><br><span class="line">      Integer size,</span><br><span class="line">      boolean readWrite,</span><br><span class="line">      Properties props) &#123;</span><br><span class="line">    typeClass = valueOrDefault(typeClass, PerpetualCache.class);</span><br><span class="line">    evictionClass = valueOrDefault(evictionClass, LruCache.class);</span><br><span class="line">    //交由Builder处理,命名空间作为cache的id</span><br><span class="line">    Cache cache = new CacheBuilder(currentNamespace)</span><br><span class="line">        .implementation(typeClass)</span><br><span class="line">        .addDecorator(evictionClass)</span><br><span class="line">        .clearInterval(flushInterval)</span><br><span class="line">        .size(size)</span><br><span class="line">        .readWrite(readWrite)</span><br><span class="line">        .properties(props)</span><br><span class="line">        .build();</span><br><span class="line">    //将cache加入configuration中</span><br><span class="line">    configuration.addCache(cache);</span><br><span class="line">    //设置当前命名空间的缓存，在之后的解析select/update/insert/delete节点设置缓存里使用currentCache</span><br><span class="line">    currentCache = cache;</span><br><span class="line">    return cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、CacheBuilder的build方法"><a href="#7、CacheBuilder的build方法" class="headerlink" title="7、CacheBuilder的build方法"></a>7、CacheBuilder的build方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  public Cache build() &#123;</span><br><span class="line">      setDefaultImplementations();</span><br><span class="line">      //生成基本的Cache实现,默认PerpetualCache</span><br><span class="line">      Cache cache = newBaseCacheInstance(implementation, id);</span><br><span class="line">      setCacheProperties(cache);</span><br><span class="line">      // issue #352, do not apply decorators to custom caches</span><br><span class="line">      if (cache.getClass().getName().startsWith(&quot;org.apache.ibatis&quot;)) &#123;</span><br><span class="line">          //LruCache封装cache</span><br><span class="line">          for (Class&lt;? extends Cache&gt; decorator : decorators) &#123;</span><br><span class="line">              cache = newCacheDecoratorInstance(decorator, cache);</span><br><span class="line">              setCacheProperties(cache);</span><br><span class="line">          &#125;</span><br><span class="line">          //为cache加上一些指定的额外的服务，如、日志及线程安全</span><br><span class="line">          cache = setStandardDecorators(cache);</span><br><span class="line">      &#125;</span><br><span class="line">  return cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、CacheBuilder的setStandardDecorators方法"><a href="#8、CacheBuilder的setStandardDecorators方法" class="headerlink" title="8、CacheBuilder的setStandardDecorators方法"></a>8、CacheBuilder的setStandardDecorators方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">private Cache setStandardDecorators(Cache cache) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        MetaObject metaCache = SystemMetaObject.forObject(cache);</span><br><span class="line">        if (size != null &amp;&amp; metaCache.hasSetter(&quot;size&quot;)) &#123;</span><br><span class="line">            metaCache.setValue(&quot;size&quot;, size);</span><br><span class="line">        &#125;</span><br><span class="line">        if (clearInterval != null) &#123;</span><br><span class="line">            //ScheduledCache封装cache</span><br><span class="line">            cache = new ScheduledCache(cache);</span><br><span class="line">            ((ScheduledCache) cache).setClearInterval(clearInterval);</span><br><span class="line">        &#125;</span><br><span class="line">        if (readWrite) &#123;</span><br><span class="line">            //SerializedCache封装cache</span><br><span class="line">            cache = new SerializedCache(cache);</span><br><span class="line">        &#125;</span><br><span class="line">        //LoggingCache封装cache</span><br><span class="line">        cache = new LoggingCache(cache);</span><br><span class="line">        //SynchronizedCache封装cache</span><br><span class="line">        cache = new SynchronizedCache(cache);</span><br><span class="line">        return cache;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new CacheException(&quot;Error building standard cache decorators.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（二、3）XMLMapperBuilder的resultMapElements方法"><a href="#9、接（二、3）XMLMapperBuilder的resultMapElements方法" class="headerlink" title="9、接（二、3）XMLMapperBuilder的resultMapElements方法"></a>9、接（二、3）XMLMapperBuilder的resultMapElements方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void resultMapElements(List&lt;XNode&gt; list) throws Exception &#123;</span><br><span class="line">    for (XNode resultMapNode : list) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //依次解析mapper节点</span><br><span class="line">            resultMapElement(resultMapNode);</span><br><span class="line">        &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">            // ignore, it will be retried</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、XMLMapperBuilder的resultMapElement方法"><a href="#10、XMLMapperBuilder的resultMapElement方法" class="headerlink" title="10、XMLMapperBuilder的resultMapElement方法"></a>10、XMLMapperBuilder的resultMapElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">private ResultMap resultMapElement(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings) throws Exception &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;processing &quot; + resultMapNode.getValueBasedIdentifier());</span><br><span class="line">    //id,对应ResultMap.id,内映射没有ID,用resultMapNode.getValueBasedIdentifier()方法生成一个</span><br><span class="line">    String id = resultMapNode.getStringAttribute(&quot;id&quot;,</span><br><span class="line">        resultMapNode.getValueBasedIdentifier());</span><br><span class="line">    //type,对应ResultMap.Type,这里可以看到这个type可以通过很多个属性进行配置</span><br><span class="line">    String type = resultMapNode.getStringAttribute(&quot;type&quot;,</span><br><span class="line">        resultMapNode.getStringAttribute(&quot;ofType&quot;,</span><br><span class="line">            resultMapNode.getStringAttribute(&quot;resultType&quot;,</span><br><span class="line">                resultMapNode.getStringAttribute(&quot;javaType&quot;))));</span><br><span class="line">    String extend = resultMapNode.getStringAttribute(&quot;extends&quot;);</span><br><span class="line">    //是否自动映射 </span><br><span class="line">    Boolean autoMapping = resultMapNode.getBooleanAttribute(&quot;autoMapping&quot;);</span><br><span class="line">    //将type解析成class,可以是别名，也可以是全限定名</span><br><span class="line">    Class&lt;?&gt; typeClass = resolveClass(type);</span><br><span class="line">    Discriminator discriminator = null;</span><br><span class="line">    //这个resultMappings将对应ResultMap.resultMappings</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = new ArrayList&lt;ResultMapping&gt;();</span><br><span class="line">    resultMappings.addAll(additionalResultMappings);</span><br><span class="line">    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();</span><br><span class="line">    //解析子节点</span><br><span class="line">    for (XNode resultChild : resultChildren) &#123;</span><br><span class="line">        if (&quot;constructor&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">            //解析constructor节点</span><br><span class="line">            processConstructorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">        &#125; else if (&quot;discriminator&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">            //解析disriminator节点</span><br><span class="line">            discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ArrayList&lt;ResultFlag&gt; flags = new ArrayList&lt;ResultFlag&gt;();</span><br><span class="line">            if (&quot;id&quot;.equals(resultChild.getName())) &#123;</span><br><span class="line">                flags.add(ResultFlag.ID);</span><br><span class="line">            &#125;</span><br><span class="line">            //解析其他节点,主要有result、association及collection  </span><br><span class="line">            //在这里可以说明一个result、association及collection都会被解析成一个resultMapping对象，即使他们有很多子元素  </span><br><span class="line">            resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend, discriminator, resultMappings, </span><br><span class="line">        autoMapping);</span><br><span class="line">    try &#123;</span><br><span class="line">        //得到resultMappings后，生成ResultMap并加入到Configuration中</span><br><span class="line">        return resultMapResolver.resolve();</span><br><span class="line">    &#125; catch (IncompleteElementException  e) &#123;</span><br><span class="line">        configuration.addIncompleteResultMap(resultMapResolver);</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>resultMap配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;resultMap id=&quot;Employee&quot; type=&quot;Demo&quot;&gt;  </span><br><span class="line">    &lt;id property=&quot;id&quot; column=&quot;id&quot; /&gt;  </span><br><span class="line">    &lt;result property=&quot;name&quot; column=&quot;name&quot; /&gt;</span><br><span class="line">&lt;/resultMap&gt;</span><br></pre></td></tr></table></figure></p><h4 id="11、XMLMapperBuilder的processConstructorElement方法"><a href="#11、XMLMapperBuilder的processConstructorElement方法" class="headerlink" title="11、XMLMapperBuilder的processConstructorElement方法"></a>11、XMLMapperBuilder的processConstructorElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void processConstructorElement(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings) throws Exception &#123;</span><br><span class="line">    List&lt;XNode&gt; argChildren = resultChild.getChildren();</span><br><span class="line">    //遍历子节点 </span><br><span class="line">    for (XNode argChild : argChildren) &#123;</span><br><span class="line">        ArrayList&lt;ResultFlag&gt; flags = new ArrayList&lt;ResultFlag&gt;();</span><br><span class="line">        //标识为ResultFlag.CONSTRUCTOR </span><br><span class="line">        flags.add(ResultFlag.CONSTRUCTOR);</span><br><span class="line">        if (&quot;idArg&quot;.equals(argChild.getName())) &#123;</span><br><span class="line">            //标识为一个ID属性 </span><br><span class="line">            flags.add(ResultFlag.ID);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建一个ResultMapping对象，并加入resultMappings  </span><br><span class="line">        //这里说明了，constructor下有多个几子节点，就会产生多少个resultMapping对象</span><br><span class="line">        resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、XMLMapperBuilder的buildResultMappingFromContext方法"><a href="#12、XMLMapperBuilder的buildResultMappingFromContext方法" class="headerlink" title="12、XMLMapperBuilder的buildResultMappingFromContext方法"></a>12、XMLMapperBuilder的buildResultMappingFromContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private ResultMapping buildResultMappingFromContext(XNode context, Class&lt;?&gt; resultType, ArrayList&lt;ResultFlag&gt; flags) throws Exception &#123;</span><br><span class="line">    String property = context.getStringAttribute(&quot;property&quot;);</span><br><span class="line">    String column = context.getStringAttribute(&quot;column&quot;);</span><br><span class="line">    String javaType = context.getStringAttribute(&quot;javaType&quot;);</span><br><span class="line">    String jdbcType = context.getStringAttribute(&quot;jdbcType&quot;);</span><br><span class="line">    String nestedSelect = context.getStringAttribute(&quot;select&quot;);</span><br><span class="line">    //这里需要特殊说明，一个resultMapping可以对应一个resultMap对应，我们称之为内部映射 </span><br><span class="line">    String nestedResultMap = context.getStringAttribute(&quot;resultMap&quot;,</span><br><span class="line">        processNestedResultMappings(context, Collections.&lt;ResultMapping&gt; emptyList()));</span><br><span class="line">    String notNullColumn = context.getStringAttribute(&quot;notNullColumn&quot;);</span><br><span class="line">    String columnPrefix = context.getStringAttribute(&quot;columnPrefix&quot;);</span><br><span class="line">    String typeHandler = context.getStringAttribute(&quot;typeHandler&quot;);</span><br><span class="line">    String resulSet = context.getStringAttribute(&quot;resultSet&quot;);</span><br><span class="line">    String foreignColumn = context.getStringAttribute(&quot;foreignColumn&quot;);</span><br><span class="line">    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? extends TypeHandler&lt;?&gt;&gt;) resolveClass(typeHandler);</span><br><span class="line">    JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);</span><br><span class="line">    //这里的ResultMapping生成的方法跟ResultMap生成的过程大同小异</span><br><span class="line">    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap,    </span><br><span class="line">        notNullColumn, columnPrefix, typeHandlerClass, flags, resulSet, foreignColumn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、XMLMapperBuilder的processNestedResultMappings方法"><a href="#13、XMLMapperBuilder的processNestedResultMappings方法" class="headerlink" title="13、XMLMapperBuilder的processNestedResultMappings方法"></a>13、XMLMapperBuilder的processNestedResultMappings方法</h4><p>生成一个内部的ReulstMapp对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private String processNestedResultMappings(XNode context, List&lt;ResultMapping&gt; resultMappings) throws Exception &#123;</span><br><span class="line">    //只有association, collection, case节点才会生成内部映射，其他不生成，返回null</span><br><span class="line">    if (&quot;association&quot;.equals(context.getName())</span><br><span class="line">          || &quot;collection&quot;.equals(context.getName())</span><br><span class="line">          || &quot;case&quot;.equals(context.getName())) &#123;</span><br><span class="line">        if (context.getStringAttribute(&quot;select&quot;) == null) &#123;</span><br><span class="line">            //这里类似一个递归调用，需要注意内部映射的ID是Mybatis自动生成的，不是在配置文件里读取的</span><br><span class="line">            ResultMap resultMap = resultMapElement(context, resultMappings);</span><br><span class="line">            return resultMap.getId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="14、接（二、10）ResultMapResolver的resolve方法"><a href="#14、接（二、10）ResultMapResolver的resolve方法" class="headerlink" title="14、接（二、10）ResultMapResolver的resolve方法"></a>14、接（二、10）ResultMapResolver的resolve方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ResultMap resolve() &#123;</span><br><span class="line">    return assistant.addResultMap(this.id, this.type, this.extend, this.discriminator, this.resultMappings, this.autoMapping);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、MapperBuilderAssistant的addResultMap方法"><a href="#15、MapperBuilderAssistant的addResultMap方法" class="headerlink" title="15、MapperBuilderAssistant的addResultMap方法"></a>15、MapperBuilderAssistant的addResultMap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"> public ResultMap addResultMap(</span><br><span class="line">       String id,</span><br><span class="line">       Class&lt;?&gt; type,</span><br><span class="line">       String extend,</span><br><span class="line">       Discriminator discriminator,</span><br><span class="line">       List&lt;ResultMapping&gt; resultMappings,</span><br><span class="line">       Boolean autoMapping) &#123;</span><br><span class="line">//没有命名空间，则添加当前命名空间，false时检查命名空间是否是当前命名空间</span><br><span class="line">         id = applyCurrentNamespace(id, false);</span><br><span class="line">//没有命名空间，则添加当前命名空间</span><br><span class="line">         extend = applyCurrentNamespace(extend, true);</span><br><span class="line">         //交由ResultMap.Builder来创建ResultMap对象，ResultMap.Builder.build()方法前面已经介绍过</span><br><span class="line">         ResultMap.Builder resultMapBuilder = new ResultMap.Builder(configuration, id, type, resultMappings, autoMapping);</span><br><span class="line">     if (extend != null) &#123;</span><br><span class="line">         //对继承了其他resultMap的处理</span><br><span class="line">         if (!configuration.hasResultMap(extend)) &#123;</span><br><span class="line">             throw new IncompleteElementException(&quot;Could not find a parent resultmap with id &apos;&quot; + extend + &quot;&apos;&quot;);</span><br><span class="line">         &#125;</span><br><span class="line">         ResultMap resultMap = configuration.getResultMap(extend);</span><br><span class="line">         List&lt;ResultMapping&gt; extendedResultMappings = new ArrayList&lt;ResultMapping&gt;(resultMap.getResultMappings());</span><br><span class="line">         extendedResultMappings.removeAll(resultMappings);</span><br><span class="line">         // Remove parent constructor if this resultMap declares a constructor.</span><br><span class="line">         boolean declaresConstructor = false;</span><br><span class="line">         for (ResultMapping resultMapping : resultMappings) &#123;</span><br><span class="line">             if (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">                 declaresConstructor = true;</span><br><span class="line">                 break;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         if (declaresConstructor) &#123;</span><br><span class="line">             Iterator&lt;ResultMapping&gt; extendedResultMappingsIter = extendedResultMappings.iterator();</span><br><span class="line">             while (extendedResultMappingsIter.hasNext()) &#123;</span><br><span class="line">                 if (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</span><br><span class="line">                     extendedResultMappingsIter.remove();</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         resultMappings.addAll(extendedResultMappings);</span><br><span class="line">     &#125;</span><br><span class="line">     resultMapBuilder.discriminator(discriminator);</span><br><span class="line">     //生成ResultMap对象</span><br><span class="line">     ResultMap resultMap = resultMapBuilder.build();</span><br><span class="line">     //另到Configuration中</span><br><span class="line">     configuration.addResultMap(resultMap);</span><br><span class="line">     return resultMap;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h4 id="16、接（二、3）XMLMapperBuilder的sqlElement方法"><a href="#16、接（二、3）XMLMapperBuilder的sqlElement方法" class="headerlink" title="16、接（二、3）XMLMapperBuilder的sqlElement方法"></a>16、接（二、3）XMLMapperBuilder的sqlElement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void sqlElement(List&lt;XNode&gt; list, String requiredDatabaseId) throws Exception &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">        String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">        String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line">        //没有命名空间，则添加命名空间，false时检查命名空间是否是当前命名空间</span><br><span class="line">        id = builderAssistant.applyCurrentNamespace(id, false);</span><br><span class="line">        if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) </span><br><span class="line">            //sql片段加入sqlFragments</span><br><span class="line">            sqlFragments.put(id, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sql配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;sql id=&quot;sql_select&quot;&gt; </span><br><span class="line">    SELECT * FROM BLOG </span><br><span class="line">    WHERE 1=1 </span><br><span class="line">    &lt;if test=&quot;id!= null and title!=null&quot;&gt;</span><br><span class="line">        AND id=#&#123;id&#125; and title=#&#123;title&#125;</span><br><span class="line">    &lt;/if&gt; </span><br><span class="line">&lt;/sql&gt;</span><br></pre></td></tr></table></figure></p><h3 id="三、sql加载过程"><a href="#三、sql加载过程" class="headerlink" title="三、sql加载过程"></a>三、sql加载过程</h3><h4 id="1、接（二、3）XMLMapperBuilder的buildStatementFromContext方法"><a href="#1、接（二、3）XMLMapperBuilder的buildStatementFromContext方法" class="headerlink" title="1、接（二、3）XMLMapperBuilder的buildStatementFromContext方法"></a>1、接（二、3）XMLMapperBuilder的buildStatementFromContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void buildStatementFromContext(List&lt;XNode&gt; list, String requiredDatabaseId) &#123;</span><br><span class="line">    for (XNode context : list) &#123;</span><br><span class="line">        //一个select/update/insert/delete元素创建一个XMLStatementBuilder对象 </span><br><span class="line">        final XMLStatementBuilder statementParser = new XMLStatementBuilder(configuration, builderAssistant, context, </span><br><span class="line">              requiredDatabaseId);</span><br><span class="line">        try &#123;</span><br><span class="line">            //将元素解析成MappedStatemenet对象，并加入到Configuration中去</span><br><span class="line">            statementParser.parseStatementNode();</span><br><span class="line">        &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">            configuration.addIncompleteStatement(statementParser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、XMLStatementBuilder的parseStatementNode方法"><a href="#2、XMLStatementBuilder的parseStatementNode方法" class="headerlink" title="2、XMLStatementBuilder的parseStatementNode方法"></a>2、XMLStatementBuilder的parseStatementNode方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">public void parseStatementNode() &#123;</span><br><span class="line">    String id = context.getStringAttribute(&quot;id&quot;);</span><br><span class="line">    String databaseId = context.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line"></span><br><span class="line">    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) return;</span><br><span class="line"></span><br><span class="line">    Integer fetchSize = context.getIntAttribute(&quot;fetchSize&quot;);</span><br><span class="line">    Integer timeout = context.getIntAttribute(&quot;timeout&quot;);</span><br><span class="line">    String parameterMap = context.getStringAttribute(&quot;parameterMap&quot;);</span><br><span class="line">    //参数类</span><br><span class="line">    String parameterType = context.getStringAttribute(&quot;parameterType&quot;);</span><br><span class="line">    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);</span><br><span class="line">    //返回结果映射</span><br><span class="line">    String resultMap = context.getStringAttribute(&quot;resultMap&quot;);</span><br><span class="line">    //返回结果类</span><br><span class="line">    String resultType = context.getStringAttribute(&quot;resultType&quot;);</span><br><span class="line">    String lang = context.getStringAttribute(&quot;lang&quot;);</span><br><span class="line">    LanguageDriver langDriver = getLanguageDriver(lang);</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    String resultSetType = context.getStringAttribute(&quot;resultSetType&quot;);</span><br><span class="line">    //Statement的类型，对应jdbc里的三个类型:Statement、PreparedStatement、CallableStatement，默认使用PreparedStatement</span><br><span class="line">    StatementType statementType = StatementType.valueOf(context.getStringAttribute(&quot;statementType&quot;, StatementType.PREPARED.toString()));</span><br><span class="line">    //这个也是跟jdbc里相对应的，一般采用默认即可</span><br><span class="line">    ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);</span><br><span class="line"></span><br><span class="line">    //Sql的类型，select/update/insert/delete</span><br><span class="line">    String nodeName = context.getNode().getNodeName();</span><br><span class="line">    SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    boolean isSelect = sqlCommandType == SqlCommandType.SELECT;</span><br><span class="line">    //是否刷新缓存</span><br><span class="line">    boolean flushCache = context.getBooleanAttribute(&quot;flushCache&quot;, !isSelect);</span><br><span class="line">    //是否使用缓存</span><br><span class="line">    boolean useCache = context.getBooleanAttribute(&quot;useCache&quot;, isSelect);</span><br><span class="line">    boolean resultOrdered = context.getBooleanAttribute(&quot;resultOrdered&quot;, false);</span><br><span class="line"></span><br><span class="line">    // Include Fragments before parsing</span><br><span class="line">    XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant);</span><br><span class="line">    //包含sql片段，把sql片段替换进来</span><br><span class="line">    includeParser.applyIncludes(context.getNode());</span><br><span class="line"></span><br><span class="line">    //selectKey生成id</span><br><span class="line">    //Parse selectKey after includes,in case if IncompleteElementException (issue #291)</span><br><span class="line">    List&lt;XNode&gt; selectKeyNodes = context.evalNodes(&quot;selectKey&quot;);</span><br><span class="line">    if (configuration.getDatabaseId() != null) &#123;</span><br><span class="line">        parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());</span><br><span class="line">    &#125;</span><br><span class="line">    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);</span><br><span class="line"></span><br><span class="line">    //XMLLanguageDriver创建sqlSource</span><br><span class="line">    // Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br><span class="line">    SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);</span><br><span class="line">    String resultSets = context.getStringAttribute(&quot;resultSets&quot;);</span><br><span class="line">    String keyProperty = context.getStringAttribute(&quot;keyProperty&quot;);</span><br><span class="line">    String keyColumn = context.getStringAttribute(&quot;keyColumn&quot;);</span><br><span class="line">    //自动生成key</span><br><span class="line">    KeyGenerator keyGenerator;</span><br><span class="line">    String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">    //没有命名空间，则添加当前命名空间</span><br><span class="line">    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true);</span><br><span class="line">    if (configuration.hasKeyGenerator(keyStatementId)) &#123;</span><br><span class="line">        //获取刚刚创建的id生成器</span><br><span class="line">        keyGenerator = configuration.getKeyGenerator(keyStatementId);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //没有selectKey，配置了useGeneratedKeys且为insert，则用Jdbc3KeyGenerator生成器</span><br><span class="line">        keyGenerator = context.getBooleanAttribute(&quot;useGeneratedKeys&quot;,</span><br><span class="line">              configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))</span><br><span class="line">              ? new Jdbc3KeyGenerator() : new NoKeyGenerator();</span><br><span class="line">    &#125;</span><br><span class="line">    //生成MappedStatement对象，并加到Configuration中  </span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">          fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">          resultSetTypeEnum, flushCache, useCache, resultOrdered, </span><br><span class="line">          keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、XMLIncludeTransformer的applyIncludes方法"><a href="#3、XMLIncludeTransformer的applyIncludes方法" class="headerlink" title="3、XMLIncludeTransformer的applyIncludes方法"></a>3、XMLIncludeTransformer的applyIncludes方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void applyIncludes(Node source) &#123;</span><br><span class="line">    //source为sql片段</span><br><span class="line">    if (source.getNodeName().equals(&quot;include&quot;)) &#123;</span><br><span class="line">        //由refid获取sql片段</span><br><span class="line">        Node toInclude = findSqlFragment(getStringAttribute(source, &quot;refid&quot;));</span><br><span class="line">        //若sql片段中包含sql片段，继续解析</span><br><span class="line">        applyIncludes(toInclude);</span><br><span class="line">        if (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;</span><br><span class="line">            toInclude = source.getOwnerDocument().importNode(toInclude, true);</span><br><span class="line">        &#125;</span><br><span class="line">        //用获取的sql片段替换本节点</span><br><span class="line">        source.getParentNode().replaceChild(toInclude, source);</span><br><span class="line">        while (toInclude.hasChildNodes()) &#123;</span><br><span class="line">            toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);</span><br><span class="line">        &#125;</span><br><span class="line">        toInclude.getParentNode().removeChild(toInclude);</span><br><span class="line">    &#125; else if (source.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">        //source为节点列表</span><br><span class="line">        NodeList children = source.getChildNodes();</span><br><span class="line">        for (int i=0; i&lt;children.getLength(); i++) &#123;</span><br><span class="line">            applyIncludes(children.item(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、XMLIncludeTransformer的findSqlFragment方法"><a href="#4、XMLIncludeTransformer的findSqlFragment方法" class="headerlink" title="4、XMLIncludeTransformer的findSqlFragment方法"></a>4、XMLIncludeTransformer的findSqlFragment方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   private Node findSqlFragment(String refid) &#123;</span><br><span class="line">refid = PropertyParser.parse(refid, configuration.getVariables());</span><br><span class="line">//没有命名空间，则添加当前命名空间</span><br><span class="line">refid = builderAssistant.applyCurrentNamespace(refid, true);</span><br><span class="line">try &#123;</span><br><span class="line">  //获取sql片段，必须是在同一个命名空间下</span><br><span class="line">  XNode nodeToInclude = configuration.getSqlFragments().get(refid);</span><br><span class="line">  Node result = nodeToInclude.getNode().cloneNode(true);</span><br><span class="line">  return result;</span><br><span class="line">&#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">  throw new IncompleteElementException(&quot;Could not find SQL statement to include with refid &apos;&quot; + refid + &quot;&apos;&quot;, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（三、2）XMLStatementBuilder的parseSelectKeyNodes方法"><a href="#5、接（三、2）XMLStatementBuilder的parseSelectKeyNodes方法" class="headerlink" title="5、接（三、2）XMLStatementBuilder的parseSelectKeyNodes方法"></a>5、接（三、2）XMLStatementBuilder的parseSelectKeyNodes方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void parseSelectKeyNodes(String parentId, List&lt;XNode&gt; list, Class&lt;?&gt; parameterTypeClass, LanguageDriver </span><br><span class="line">      langDriver, String skRequiredDatabaseId) &#123;</span><br><span class="line">    for (XNode nodeToHandle : list) &#123;</span><br><span class="line">        String id = parentId + SelectKeyGenerator.SELECT_KEY_SUFFIX;</span><br><span class="line">        String databaseId = nodeToHandle.getStringAttribute(&quot;databaseId&quot;);</span><br><span class="line">        if (databaseIdMatchesCurrent(id, databaseId, skRequiredDatabaseId)) &#123;</span><br><span class="line">            parseSelectKeyNode(id, nodeToHandle, parameterTypeClass, langDriver, databaseId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>selectKey配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id=&quot;insert&quot;&gt;</span><br><span class="line">    &lt;selectKey keyProperty=&quot;id&quot; resultType=&quot;int&quot; order=&quot;BEFORE&quot;&gt;</span><br><span class="line">        &lt;if test=&quot;_databaseId == &apos;oracle&apos;&quot;&gt;</span><br><span class="line">            select seq_users.nextval from dual</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">        &lt;if test=&quot;_databaseId == &apos;db2&apos;&quot;&gt;</span><br><span class="line">            select nextval for seq_users from sysibm.sysdummy1&quot;</span><br><span class="line">        &lt;/if&gt;</span><br><span class="line">    &lt;/selectKey&gt;</span><br><span class="line">    insert into users values (#&#123;id&#125;, #&#123;name&#125;)</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure></p><h4 id="6、XMLStatementBuilder的parseSelectKeyNodes方法"><a href="#6、XMLStatementBuilder的parseSelectKeyNodes方法" class="headerlink" title="6、XMLStatementBuilder的parseSelectKeyNodes方法"></a>6、XMLStatementBuilder的parseSelectKeyNodes方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public void parseSelectKeyNode(String id, XNode nodeToHandle, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, </span><br><span class="line">      String databaseId) &#123;</span><br><span class="line">    //返回类型</span><br><span class="line">    String resultType = nodeToHandle.getStringAttribute(&quot;resultType&quot;);</span><br><span class="line">    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);</span><br><span class="line">    //Statement的类型，对应jdbc里的三个类型:Statement、PreparedStatement、CallableStatement，默认使用PreparedStatement </span><br><span class="line">    StatementType statementType = StatementType.valueOf(nodeToHandle.getStringAttribute(&quot;statementType&quot;, </span><br><span class="line">          StatementType.PREPARED.toString()));</span><br><span class="line">    //属性名</span><br><span class="line">    String keyProperty = nodeToHandle.getStringAttribute(&quot;keyProperty&quot;);</span><br><span class="line">    boolean executeBefore = &quot;BEFORE&quot;.equals(nodeToHandle.getStringAttribute(&quot;order&quot;, &quot;AFTER&quot;));</span><br><span class="line"></span><br><span class="line">    //defaults</span><br><span class="line">    boolean useCache = false;</span><br><span class="line">    boolean resultOrdered = false;</span><br><span class="line">    //主键生成器</span><br><span class="line">    KeyGenerator keyGenerator = new NoKeyGenerator();</span><br><span class="line">    Integer fetchSize = null;</span><br><span class="line">    Integer timeout = null;</span><br><span class="line">    boolean flushCache = false;</span><br><span class="line">    String parameterMap = null;</span><br><span class="line">    String resultMap = null;</span><br><span class="line">    ResultSetType resultSetTypeEnum = null;</span><br><span class="line">    //XMLLanguageDriver创建sqlSource</span><br><span class="line">    SqlSource sqlSource = langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);</span><br><span class="line">    SqlCommandType sqlCommandType = SqlCommandType.SELECT;</span><br><span class="line"></span><br><span class="line">    //生成MappedStatement对象，并加到Configuration中</span><br><span class="line">    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,</span><br><span class="line">          fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,</span><br><span class="line">          resultSetTypeEnum, flushCache, useCache, resultOrdered,</span><br><span class="line">          keyGenerator, keyProperty, null, databaseId, langDriver, null);</span><br><span class="line">    //没有命名空间，则添加当前命名空间，false时检查命名空间是否是当前命名空间</span><br><span class="line">    id = builderAssistant.applyCurrentNamespace(id, false);</span><br><span class="line">    //获取刚刚保存得，该selectKey的MappedStatement</span><br><span class="line">    MappedStatement keyStatement = configuration.getMappedStatement(id, false);</span><br><span class="line">    //创建id生成器，加入configuration中</span><br><span class="line">    configuration.addKeyGenerator(id, new SelectKeyGenerator(keyStatement, executeBefore));</span><br><span class="line">    //处理完，删掉本节点</span><br><span class="line">    nodeToHandle.getParent().getNode().removeChild(nodeToHandle.getNode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、XMLLanguageDriver的createSqlSource方法"><a href="#7、XMLLanguageDriver的createSqlSource方法" class="headerlink" title="7、XMLLanguageDriver的createSqlSource方法"></a>7、XMLLanguageDriver的createSqlSource方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public SqlSource createSqlSource(Configuration configuration, XNode script, Class&lt;?&gt; parameterType) &#123;</span><br><span class="line">    XMLScriptBuilder builder = new XMLScriptBuilder(configuration, script);</span><br><span class="line">    return builder.parseScriptNode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、XMLScriptBuilder的parseScriptNode方法"><a href="#8、XMLScriptBuilder的parseScriptNode方法" class="headerlink" title="8、XMLScriptBuilder的parseScriptNode方法"></a>8、XMLScriptBuilder的parseScriptNode方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  public SqlSource parseScriptNode() &#123;</span><br><span class="line">      //解析sql</span><br><span class="line">      List&lt;SqlNode&gt; contents = parseDynamicTags(context);</span><br><span class="line">      //混合sql节点</span><br><span class="line">      MixedSqlNode rootSqlNode = new MixedSqlNode(contents);</span><br><span class="line">//默认动态sql</span><br><span class="line">      SqlSource sqlSource = new DynamicSqlSource(configuration, rootSqlNode);</span><br><span class="line">      return sqlSource;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="9、XMLScriptBuilder的parseDynamicTags方法"><a href="#9、XMLScriptBuilder的parseDynamicTags方法" class="headerlink" title="9、XMLScriptBuilder的parseDynamicTags方法"></a>9、XMLScriptBuilder的parseDynamicTags方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;SqlNode&gt; parseDynamicTags(XNode node) &#123;</span><br><span class="line">    //一个sql会被解析成多个SqlNode</span><br><span class="line">    List&lt;SqlNode&gt; contents = new ArrayList&lt;SqlNode&gt;();</span><br><span class="line">    NodeList children = node.getNode().getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; children.getLength(); i++) &#123;</span><br><span class="line">        XNode child = node.newXNode(children.item(i));</span><br><span class="line">        String nodeName = child.getNode().getNodeName();</span><br><span class="line">        if (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE</span><br><span class="line">              || child.getNode().getNodeType() == Node.TEXT_NODE) &#123;</span><br><span class="line">            //如果这个Node只包含文本  </span><br><span class="line">            String data = child.getStringBody(&quot;&quot;);</span><br><span class="line">            //生成一个TextSqlNode </span><br><span class="line">            contents.add(new TextSqlNode(data));</span><br><span class="line">        &#125; else if (child.getNode().getNodeType() == Node.ELEMENT_NODE &amp;&amp; !&quot;selectKey&quot;.equals(nodeName)) &#123; </span><br><span class="line">            //如果是有xml标签的Node,交由Handler处理，同时被认为是动态的</span><br><span class="line">            NodeHandler handler = nodeHandlers.get(nodeName);</span><br><span class="line">            if (handler == null) &#123;</span><br><span class="line">                throw new BuilderException(&quot;Unknown element &lt;&quot; + nodeName + &quot;&gt; in SQL statement.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //处理该标签</span><br><span class="line">            handler.handleNode(child, contents);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return contents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、If标签处理器"><a href="#10、If标签处理器" class="headerlink" title="10、If标签处理器"></a>10、If标签处理器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">    //Mybatis3动态sql都支持那些配置，这里就很清楚啦  </span><br><span class="line">    put(&quot;trim&quot;, new TrimHandler());  </span><br><span class="line">    put(&quot;where&quot;, new WhereHandler());  </span><br><span class="line">    put(&quot;set&quot;, new SetHandler());  </span><br><span class="line">    put(&quot;foreach&quot;, new ForEachHandler());  </span><br><span class="line">    put(&quot;if&quot;, new IfHandler());  </span><br><span class="line">    put(&quot;choose&quot;, new ChooseHandler());  </span><br><span class="line">    put(&quot;when&quot;, new IfHandler());  </span><br><span class="line">    put(&quot;otherwise&quot;, new OtherwiseHandler());  </span><br><span class="line">    put(&quot;bind&quot;, new BindHandler());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private class IfHandler implements NodeHandler &#123;</span><br><span class="line">    public void handleNode(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents) &#123;</span><br><span class="line">        //解析if标签下的节点</span><br><span class="line">        List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle);</span><br><span class="line">        //创建组合节点</span><br><span class="line">        MixedSqlNode mixedSqlNode = new MixedSqlNode(contents);</span><br><span class="line">        String test = nodeToHandle.getStringAttribute(&quot;test&quot;);</span><br><span class="line">        //创建if节点</span><br><span class="line">        IfSqlNode ifSqlNode = new IfSqlNode(mixedSqlNode, test);</span><br><span class="line">        targetContents.add(ifSqlNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mybatis3的配置文件加载到此就结束了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;mybatis-Demo&quot;&gt;&lt;a href=&quot;#mybatis-Demo&quot; class=&quot;headerlink&quot; title=&quot;mybatis Demo&quot;&gt;&lt;/a&gt;mybatis Demo&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;
      
    
    </summary>
    
      <category term="mybatis3" scheme="http://yoursite.com/categories/mybatis3/"/>
    
    
  </entry>
  
  <entry>
    <title>mybatis源码sql执行过程（2）</title>
    <link href="http://yoursite.com/2018/04/20/mybatis3%E6%BA%90%E7%A0%81/mybatis%E6%BA%90%E7%A0%81sql%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%EF%BC%882%EF%BC%89/"/>
    <id>http://yoursite.com/2018/04/20/mybatis3源码/mybatis源码sql执行过程（2）/</id>
    <published>2018-04-20T12:41:54.494Z</published>
    <updated>2018-06-28T14:04:38.733Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、insert执行过程"><a href="#一、insert执行过程" class="headerlink" title="一、insert执行过程"></a>一、insert执行过程</h3><h4 id="1、DefaultSqlSession的insert方法"><a href="#1、DefaultSqlSession的insert方法" class="headerlink" title="1、DefaultSqlSession的insert方法"></a>1、DefaultSqlSession的insert方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int insert(String statement) &#123;</span><br><span class="line">    return insert(statement, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int insert(String statement, Object parameter) &#123;</span><br><span class="line">    return update(statement, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、DefaultSqlSession的update方法"><a href="#2、DefaultSqlSession的update方法" class="headerlink" title="2、DefaultSqlSession的update方法"></a>2、DefaultSqlSession的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public int update(String statement, Object parameter) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        dirty = true;</span><br><span class="line">        MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">        //执行</span><br><span class="line">        return executor.update(ms, wrapCollection(parameter));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error updating database.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、BaseExecutor的update方法"><a href="#3、BaseExecutor的update方法" class="headerlink" title="3、BaseExecutor的update方法"></a>3、BaseExecutor的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public int update(MappedStatement ms, Object parameter) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing an update&quot;).object(ms.getId());</span><br><span class="line">    if (closed) throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    //清空一级缓存</span><br><span class="line">    clearLocalCache();</span><br><span class="line">    return doUpdate(ms, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、SimpleExecutor的doUpdate方法"><a href="#4、SimpleExecutor的doUpdate方法" class="headerlink" title="4、SimpleExecutor的doUpdate方法"></a>4、SimpleExecutor的doUpdate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public int doUpdate(MappedStatement ms, Object parameter) throws SQLException &#123;</span><br><span class="line">    Statement stmt = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);</span><br><span class="line">        //预处理</span><br><span class="line">        stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        //执行sql</span><br><span class="line">        return handler.update(stmt);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、RoutingStatementHandler的update方法"><a href="#5、RoutingStatementHandler的update方法" class="headerlink" title="5、RoutingStatementHandler的update方法"></a>5、RoutingStatementHandler的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int update(Statement statement) throws SQLException &#123;</span><br><span class="line">    return delegate.update(statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、实例化PreparedStatementHandler"><a href="#6、实例化PreparedStatementHandler" class="headerlink" title="6、实例化PreparedStatementHandler"></a>6、实例化PreparedStatementHandler</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public PreparedStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler </span><br><span class="line">      resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    super(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected BaseStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, </span><br><span class="line">      ResultHandler resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    this.configuration = mappedStatement.getConfiguration();</span><br><span class="line">    this.executor = executor;</span><br><span class="line">    this.mappedStatement = mappedStatement;</span><br><span class="line">    this.rowBounds = rowBounds;</span><br><span class="line"></span><br><span class="line">    this.typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">    this.objectFactory = configuration.getObjectFactory();</span><br><span class="line"></span><br><span class="line">    if (boundSql == null) &#123; // issue #435, get the key before calculating the statement</span><br><span class="line">        generateKeys(parameterObject);</span><br><span class="line">        boundSql = mappedStatement.getBoundSql(parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.boundSql = boundSql;</span><br><span class="line"></span><br><span class="line">    this.parameterHandler = configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class="line">    this.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, rowBounds, parameterHandler, resultHandler, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、BaseStatementHandler的generateKeys"><a href="#7、BaseStatementHandler的generateKeys" class="headerlink" title="7、BaseStatementHandler的generateKeys"></a>7、BaseStatementHandler的generateKeys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected void generateKeys(Object parameter) &#123;</span><br><span class="line">    KeyGenerator keyGenerator = mappedStatement.getKeyGenerator();</span><br><span class="line">    ErrorContext.instance().store();</span><br><span class="line">    keyGenerator.processBefore(executor, mappedStatement, null, parameter);</span><br><span class="line">    ErrorContext.instance().recall();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、SelectKeyGenerator的processBefore"><a href="#8、SelectKeyGenerator的processBefore" class="headerlink" title="8、SelectKeyGenerator的processBefore"></a>8、SelectKeyGenerator的processBefore</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void processBefore(Executor executor, MappedStatement ms, Statement stmt, Object parameter) &#123;</span><br><span class="line">    if (executeBefore) &#123;</span><br><span class="line">        processGeneratedKeys(executor, ms, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、SelectKeyGenerator的processGeneratedKeys"><a href="#9、SelectKeyGenerator的processGeneratedKeys" class="headerlink" title="9、SelectKeyGenerator的processGeneratedKeys"></a>9、SelectKeyGenerator的processGeneratedKeys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private void processGeneratedKeys(Executor executor, MappedStatement ms, Object parameter) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (parameter != null &amp;&amp; keyStatement != null &amp;&amp; keyStatement.getKeyProperties() != null) &#123;</span><br><span class="line">            //主键的属性名</span><br><span class="line">            String keyProperty = keyStatement.getKeyProperties()[0]; // just one key property is supported</span><br><span class="line">            final Configuration configuration = ms.getConfiguration();</span><br><span class="line">            final MetaObject metaParam = configuration.newMetaObject(parameter);</span><br><span class="line">            if (keyProperty != null &amp;&amp; metaParam.hasSetter(keyProperty)) &#123;</span><br><span class="line">                // Do not close keyExecutor.</span><br><span class="line">                // The transaction will be closed by parent executor.</span><br><span class="line">                //获取执行器</span><br><span class="line">                Executor keyExecutor = configuration.newExecutor(executor.getTransaction(), ExecutorType.SIMPLE);</span><br><span class="line">                //执行查询sql，获取主键</span><br><span class="line">                List&lt;Object&gt; values = keyExecutor.query(keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);</span><br><span class="line">                if (values.size() == 0) &#123;</span><br><span class="line">                    throw new ExecutorException(&quot;SelectKey returned no data.&quot;);            </span><br><span class="line">                &#125; else if (values.size() &gt; 1) &#123;</span><br><span class="line">                    throw new ExecutorException(&quot;SelectKey returned more than one value.&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //将获取的主键值设置到参数中</span><br><span class="line">                    metaParam.setValue(keyProperty, values.get(0));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (ExecutorException e) &#123;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new ExecutorException(&quot;Error selecting key or setting result to parameter object. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、接（一、6）PreparedStatementHandler的update方法"><a href="#10、接（一、6）PreparedStatementHandler的update方法" class="headerlink" title="10、接（一、6）PreparedStatementHandler的update方法"></a>10、接（一、6）PreparedStatementHandler的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public int update(Statement statement) throws SQLException &#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    //执行条数</span><br><span class="line">    int rows = ps.getUpdateCount();</span><br><span class="line">    Object parameterObject = boundSql.getParameterObject();</span><br><span class="line">    KeyGenerator keyGenerator = mappedStatement.getKeyGenerator();</span><br><span class="line">    //executeBefore为true，processAfter不会执行</span><br><span class="line">    keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);</span><br><span class="line">    return rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、二级缓存"><a href="#二、二级缓存" class="headerlink" title="二、二级缓存"></a>二、二级缓存</h3><h4 id="1、CachingExecutor的query方法"><a href="#1、CachingExecutor的query方法" class="headerlink" title="1、CachingExecutor的query方法"></a>1、CachingExecutor的query方法</h4><p>配置二级缓存,会用CachingExecutor封装SimpleExecutor<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler) </span><br><span class="line">      throws   SQLException &#123;</span><br><span class="line">    BoundSql boundSql = ms.getBoundSql(parameterObject);</span><br><span class="line">    //创建缓存key，与一级缓存一样</span><br><span class="line">    CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">    return query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, </span><br><span class="line">      BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    //从MappedStatement获取一个Cache，如果对象的命名空间没有配置cache或cache-ref节点,cache将为空，表示不使用缓存，</span><br><span class="line">    //缓存创建过程见配置加载过程（二、8）</span><br><span class="line">    Cache cache = ms.getCache();</span><br><span class="line">    if (cache != null) &#123;</span><br><span class="line">        //如果需要刷新缓存的话就刷新：flushCache=&quot;true&quot;</span><br><span class="line">        flushCacheIfRequired(ms);</span><br><span class="line">        //useCache=&quot;true&quot;</span><br><span class="line">        if (ms.isUseCache() &amp;&amp; resultHandler == null) &#123;</span><br><span class="line">            //检查是否是带ParameterMode.OUT输出参数的存储过程</span><br><span class="line">            ensureNoOutParams(ms, parameterObject, boundSql);</span><br><span class="line">            //如果缓存数据可继续使用</span><br><span class="line">            if (!dirty) &#123;</span><br><span class="line">                //获取读锁</span><br><span class="line">                cache.getReadWriteLock().readLock().lock();</span><br><span class="line">                try &#123;</span><br><span class="line">                    //从缓存中获取数据</span><br><span class="line">                    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                    List&lt;E&gt; cachedList = (List&lt;E&gt;) cache.getObject(key);</span><br><span class="line">                    //如果存在，返回缓存数据</span><br><span class="line">                    if (cachedList != null) return cachedList;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    //释放读锁</span><br><span class="line">                    cache.getReadWriteLock().readLock().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //如果缓存中没有，执行查询</span><br><span class="line">            List&lt;E&gt; list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">            //数据添加进缓存</span><br><span class="line">            tcm.putObject(cache, key, list); // issue #578. Query must be not synchronized to prevent deadlocks</span><br><span class="line">            return list;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有二级缓存，直接查询</span><br><span class="line">    return delegate.&lt;E&gt;query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、CachingExecutor的flushCacheIfRequired方法"><a href="#2、CachingExecutor的flushCacheIfRequired方法" class="headerlink" title="2、CachingExecutor的flushCacheIfRequired方法"></a>2、CachingExecutor的flushCacheIfRequired方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void flushCacheIfRequired(MappedStatement ms) &#123;</span><br><span class="line">    Cache cache = ms.getCache();</span><br><span class="line">    //执行该sql，缓存需刷新</span><br><span class="line">    if (cache != null &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">        //表示缓存数据不可继续使用</span><br><span class="line">        dirty = true; // issue #524. Disable using cached data for this session</span><br><span class="line">        //清空缓存</span><br><span class="line">        tcm.clear(cache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、TransactionalCacheManager的clear方法"><a href="#3、TransactionalCacheManager的clear方法" class="headerlink" title="3、TransactionalCacheManager的clear方法"></a>3、TransactionalCacheManager的clear方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void clear(Cache cache) &#123;</span><br><span class="line">    getTransactionalCache(cache).clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、TransactionalCacheManager的getTransactionalCache方法"><a href="#4、TransactionalCacheManager的getTransactionalCache方法" class="headerlink" title="4、TransactionalCacheManager的getTransactionalCache方法"></a>4、TransactionalCacheManager的getTransactionalCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private TransactionalCache getTransactionalCache(Cache cache) &#123;</span><br><span class="line">    //由cache做key获取TransactionalCache</span><br><span class="line">    TransactionalCache txCache = transactionalCaches.get(cache);</span><br><span class="line">    if (txCache == null) &#123;</span><br><span class="line">        //没有则封装一个</span><br><span class="line">        txCache = new TransactionalCache(cache);</span><br><span class="line">        //存入该Map</span><br><span class="line">        transactionalCaches.put(cache, txCache);</span><br><span class="line">    &#125;</span><br><span class="line">    return txCache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（二、3）TransactionalCache的clear方法"><a href="#5、接（二、3）TransactionalCache的clear方法" class="headerlink" title="5、接（二、3）TransactionalCache的clear方法"></a>5、接（二、3）TransactionalCache的clear方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //清空临时数据</span><br><span class="line">    reset();</span><br><span class="line">    //commit时先清空缓存，在执行后续操作</span><br><span class="line">    clearOnCommit = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、TransactionalCache的reset方法"><a href="#6、TransactionalCache的reset方法" class="headerlink" title="6、TransactionalCache的reset方法"></a>6、TransactionalCache的reset方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void reset() &#123;</span><br><span class="line">    clearOnCommit = false;</span><br><span class="line">    //清空临时数据队列</span><br><span class="line">    entriesToRemoveOnCommit.clear();</span><br><span class="line">    entriesToAddOnCommit.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、接（二、1）SynchronizedCache的getObject方法"><a href="#7、接（二、1）SynchronizedCache的getObject方法" class="headerlink" title="7、接（二、1）SynchronizedCache的getObject方法"></a>7、接（二、1）SynchronizedCache的getObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //获取读锁</span><br><span class="line">    acquireReadLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //继续从下级获取</span><br><span class="line">        return delegate.getObject(key);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放读锁</span><br><span class="line">        releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LoggingCache的getObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //请求次数加一</span><br><span class="line">    requests++;</span><br><span class="line">    //继续从下级获取</span><br><span class="line">    final Object value = delegate.getObject(key);</span><br><span class="line">    if (value != null) &#123;</span><br><span class="line">        //获取成功，命中次数加一</span><br><span class="line">        hits++;</span><br><span class="line">    &#125;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Cache Hit Ratio [&quot; + getId() + &quot;]: &quot; + getHitRatio());</span><br><span class="line">    &#125;</span><br><span class="line">    return value;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>SerializedCache的getObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //继续从下级获取</span><br><span class="line">    Object object = delegate.getObject(key);</span><br><span class="line">    //反序列化</span><br><span class="line">    return object == null ? null : deserialize((byte[]) object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ScheduledCache的getObject<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    if (clearWhenStale()) &#123;</span><br><span class="line">        //当上次清空时间与当前时间差，大于最大缓存清空间隔时间</span><br><span class="line">        //清空缓存，返回null</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //继续从下级获取</span><br><span class="line">        return delegate.getObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>LruCache的getObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  public Object getObject(Object key) &#123;</span><br><span class="line">      //将key对应的Node移至队尾</span><br><span class="line">      keyMap.get(key); //touch</span><br><span class="line">      //继续从下级获取</span><br><span class="line">      return delegate.getObject(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PerpetualCache的getObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //从Map中获取缓存数据</span><br><span class="line">    return cache.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、接（二、1）TransactionalCacheManager的putObject方法"><a href="#8、接（二、1）TransactionalCacheManager的putObject方法" class="headerlink" title="8、接（二、1）TransactionalCacheManager的putObject方法"></a>8、接（二、1）TransactionalCacheManager的putObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Cache cache, CacheKey key, Object value) &#123;</span><br><span class="line">    getTransactionalCache(cache).putObject(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、TransactionalCache的putObject方法"><a href="#9、TransactionalCache的putObject方法" class="headerlink" title="9、TransactionalCache的putObject方法"></a>9、TransactionalCache的putObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    //commit时从缓存中删除</span><br><span class="line">    entriesToRemoveOnCommit.remove(key);</span><br><span class="line">    //commit时添加进缓存</span><br><span class="line">    entriesToAddOnCommit.put(key, new AddEntry(delegate, key, object));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、CachingExecutor的close方法"><a href="#10、CachingExecutor的close方法" class="headerlink" title="10、CachingExecutor的close方法"></a>10、CachingExecutor的close方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void close(boolean forceRollback) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //issue #499. Unresolved session handling</span><br><span class="line">        //issue #573. Autocommit sessions should commit</span><br><span class="line">        if (dirty &amp;&amp; !autoCommit) &#123;</span><br><span class="line">            //缓存失效（说明执行的是update之类方法），并且不是自动提交的</span><br><span class="line">            //回滚未提交的缓存 </span><br><span class="line">            tcm.rollback();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //提交缓存</span><br><span class="line">            tcm.commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        delegate.close(forceRollback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、TransactionalCacheManager的rollback方法"><a href="#11、TransactionalCacheManager的rollback方法" class="headerlink" title="11、TransactionalCacheManager的rollback方法"></a>11、TransactionalCacheManager的rollback方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void rollback() &#123;</span><br><span class="line">    for (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">        //回滚缓存数据</span><br><span class="line">        txCache.rollback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、TransactionalCache的rollback方法"><a href="#12、TransactionalCache的rollback方法" class="headerlink" title="12、TransactionalCache的rollback方法"></a>12、TransactionalCache的rollback方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void rollback() &#123;</span><br><span class="line">    //临时数据区域</span><br><span class="line">    reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、接（二、10）TransactionalCacheManager的commit方法"><a href="#11、接（二、10）TransactionalCacheManager的commit方法" class="headerlink" title="11、接（二、10）TransactionalCacheManager的commit方法"></a>11、接（二、10）TransactionalCacheManager的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    delegate.getReadWriteLock().writeLock().lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (clearOnCommit) &#123;</span><br><span class="line">            //清空缓存</span><br><span class="line">            delegate.clear();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (RemoveEntry entry : entriesToRemoveOnCommit.values()) &#123;</span><br><span class="line">                //删除该key对应的缓存数据</span><br><span class="line">                entry.commit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        for (AddEntry entry : entriesToAddOnCommit.values()) &#123;</span><br><span class="line">            //添加该key对应的缓存数据</span><br><span class="line">            entry.commit();</span><br><span class="line">        &#125;</span><br><span class="line">        //清空队列</span><br><span class="line">        reset();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        delegate.getReadWriteLock().writeLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、SynchronizedCache的clear方法"><a href="#12、SynchronizedCache的clear方法" class="headerlink" title="12、SynchronizedCache的clear方法"></a>12、SynchronizedCache的clear方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //一层一层，最后获取的是PerpetualCache中的readWriteLock锁，获取写锁</span><br><span class="line">    acquireWriteLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        delegate.clear();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        releaseWriteLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>clear方法一层一层调用，LoggingCache（记录缓存命中率）、SerializedCache（流）、ScheduledCache（定时清空Cache）、LruCache（默认的淘汰包装器），<br>直到LruCache的clear方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //下一层clear</span><br><span class="line">    delegate.clear();</span><br><span class="line">    // 清空keyMap</span><br><span class="line">    keyMap.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>keyMap为LinkedHashMap先看下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void setSize(final int size) &#123;</span><br><span class="line">    //size默认1024</span><br><span class="line">    //为Map加锁synchronized</span><br><span class="line">    keyMap = Collections.synchronizedMap(new LinkedHashMap&lt;Object, Object&gt;(size, .75F, true) &#123;</span><br><span class="line">        private static final long serialVersionUID = 4267176411845948333L;</span><br><span class="line">        //实现该方法，将队首节点设置为待删除节点，立即删除keyMap中该节点</span><br><span class="line">        protected boolean removeEldestEntry(Map.Entry&lt;Object, Object&gt; eldest) &#123;</span><br><span class="line">            //当前保存数据数量是否大于size</span><br><span class="line">            boolean tooBig = size() &gt; size;</span><br><span class="line">            if (tooBig) &#123;</span><br><span class="line">                //更新最久未使用的缓存数据</span><br><span class="line">                eldestKey = eldest.getKey();</span><br><span class="line">            &#125;</span><br><span class="line">            return tooBig;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PerpetualCache的clear方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //清空该Map</span><br><span class="line">    cache.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="12、接（二、11）RemoveEntry的commit方法"><a href="#12、接（二、11）RemoveEntry的commit方法" class="headerlink" title="12、接（二、11）RemoveEntry的commit方法"></a>12、接（二、11）RemoveEntry的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    cache.removeObject(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="13、SynchronizedCache的removeObject方法"><a href="#13、SynchronizedCache的removeObject方法" class="headerlink" title="13、SynchronizedCache的removeObject方法"></a>13、SynchronizedCache的removeObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Object removeObject(Object key) &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    acquireWriteLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //依次调用下级缓存删除该节点数据</span><br><span class="line">        return delegate.removeObject(key);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        releaseWriteLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（二、11）AddEntry的commit方法"><a href="#14、接（二、11）AddEntry的commit方法" class="headerlink" title="14、接（二、11）AddEntry的commit方法"></a>14、接（二、11）AddEntry的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    cache.putObject(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、SynchronizedCache的putObject方法"><a href="#15、SynchronizedCache的putObject方法" class="headerlink" title="15、SynchronizedCache的putObject方法"></a>15、SynchronizedCache的putObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    acquireWriteLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //数据添加进下级缓存</span><br><span class="line">        delegate.putObject(key, object);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        releaseWriteLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SerializedCache的putObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    if (object == null || object instanceof Serializable) &#123;</span><br><span class="line">        //数据序列化后，添加进下级缓存</span><br><span class="line">        delegate.putObject(key, serialize((Serializable) object));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new CacheException(&quot;SharedCache failed to make a copy of a non-serializable object: &quot; + object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ScheduledCache的putObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    //超时则清空缓存</span><br><span class="line">    clearWhenStale();</span><br><span class="line">    //数据添加进下级缓存</span><br><span class="line">    delegate.putObject(key, object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>LruCache的putObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object value) &#123;</span><br><span class="line">    //数据添加进下级缓存</span><br><span class="line">    delegate.putObject(key, value);</span><br><span class="line">    //key加入keyMap中，并移至队尾，并检查是否有待删除节点</span><br><span class="line">    cycleKeyList(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PerpetualCache的putObject方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object value) &#123;</span><br><span class="line">    //数据存入缓存</span><br><span class="line">    cache.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="16、LruCache的cycleKeyList方法"><a href="#16、LruCache的cycleKeyList方法" class="headerlink" title="16、LruCache的cycleKeyList方法"></a>16、LruCache的cycleKeyList方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void cycleKeyList(Object key) &#123;</span><br><span class="line">    //key加入keyMap中，并移至队尾</span><br><span class="line">    keyMap.put(key, key);</span><br><span class="line">    //有待删除节点</span><br><span class="line">    if (eldestKey != null) &#123;</span><br><span class="line">        //下级缓存，删除待删除节点</span><br><span class="line">        delegate.removeObject(eldestKey);</span><br><span class="line">        eldestKey = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、PerpetualCache的removeObject方法"><a href="#17、PerpetualCache的removeObject方法" class="headerlink" title="17、PerpetualCache的removeObject方法"></a>17、PerpetualCache的removeObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object removeObject(Object key) &#123;</span><br><span class="line">    //删除该节点</span><br><span class="line">    return cache.remove(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="三、分页插件"><a href="#三、分页插件" class="headerlink" title="三、分页插件"></a>三、分页插件</h3><h4 id="1、XMLConfigBuilder的pluginElement方法"><a href="#1、XMLConfigBuilder的pluginElement方法" class="headerlink" title="1、XMLConfigBuilder的pluginElement方法"></a>1、XMLConfigBuilder的pluginElement方法</h4><p>xml加载时，加载插件配置的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void pluginElement(XNode parent) throws Exception &#123;</span><br><span class="line">    if (parent != null) &#123;</span><br><span class="line">        for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            //插件全类名</span><br><span class="line">            String interceptor = child.getStringAttribute(&quot;interceptor&quot;);</span><br><span class="line">            //属性</span><br><span class="line">            Properties properties = child.getChildrenAsProperties();</span><br><span class="line">            //实例化插件</span><br><span class="line">            Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();</span><br><span class="line">            //设置插件属性</span><br><span class="line">            interceptorInstance.setProperties(properties);</span><br><span class="line">            //插件加载入configuration的interceptorChain中</span><br><span class="line">            configuration.addInterceptor(interceptorInstance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>分页插件配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;!-- com.github.pagehelper为PageHelper类所在包名 --&gt;</span><br><span class="line">    &lt;plugin interceptor=&quot;com.github.pagehelper.PageHelper&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dialect&quot; value=&quot;mysql&quot;/&gt;</span><br><span class="line">        &lt;!-- 该参数默认为false --&gt;</span><br><span class="line">        &lt;!-- 设置为true时，会将RowBounds第一个参数offset当成pageNum页码使用 --&gt;</span><br><span class="line">        &lt;!-- 和startPage中的pageNum效果一样--&gt;</span><br><span class="line">        &lt;property name=&quot;offsetAsPageNum&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 该参数默认为false --&gt;</span><br><span class="line">        &lt;!-- 设置为true时，使用RowBounds分页会进行count查询 --&gt;</span><br><span class="line">        &lt;property name=&quot;rowBoundsWithCount&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 设置为true时，如果pageSize=0或者RowBounds.limit = 0就会查询出全部的结果 --&gt;</span><br><span class="line">        &lt;!-- （相当于没有执行分页查询，但是返回结果仍然是Page类型）--&gt;</span><br><span class="line">        &lt;property name=&quot;pageSizeZero&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 3.3.0版本可用 - 分页参数合理化，默认false禁用 --&gt;</span><br><span class="line">        &lt;!-- 启用合理化时，如果pageNum&lt;1会查询第一页，如果pageNum&gt;pages会查询最后一页 --&gt;</span><br><span class="line">        &lt;!-- 禁用合理化时，如果pageNum&lt;1或pageNum&gt;pages会返回空数据 --&gt;</span><br><span class="line">        &lt;property name=&quot;reasonable&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">        &lt;!-- 3.5.0版本可用 - 为了支持startPage(Object params)方法 --&gt;</span><br><span class="line">        &lt;!-- 增加了一个`params`参数来配置参数映射，用于从Map或ServletRequest中取值 --&gt;</span><br><span class="line">        &lt;!-- 可以配置pageNum,pageSize,count,pageSizeZero,reasonable,不配置映射的用默认值 --&gt;</span><br><span class="line">        &lt;!-- 不理解该含义的前提下，不要随便复制该配置 --&gt;</span><br><span class="line">        &lt;property name=&quot;params&quot; value=&quot;pageNum=start;pageSize=limit;&quot;/&gt;</span><br><span class="line">        &lt;!-- always总是返回PageInfo类型,check检查返回类型是否为PageInfo,none返回Page --&gt;</span><br><span class="line">        &lt;property name=&quot;returnPageInfo&quot; value=&quot;check&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure></p><h4 id="2、InterceptorChain的pluginAll方法"><a href="#2、InterceptorChain的pluginAll方法" class="headerlink" title="2、InterceptorChain的pluginAll方法"></a>2、InterceptorChain的pluginAll方法</h4><p>上一篇中，Configuration的方法中newExecutor方法中调用了InterceptorChain的interceptorChain.pluginAll(executor)方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object pluginAll(Object target) &#123;</span><br><span class="line">    for (Interceptor interceptor : interceptors) &#123;</span><br><span class="line">        target = interceptor.plugin(target);</span><br><span class="line">    &#125;</span><br><span class="line">    return target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3、PageHelper的plugin方法"><a href="#3、PageHelper的plugin方法" class="headerlink" title="3、PageHelper的plugin方法"></a>3、PageHelper的plugin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Object plugin(Object target) &#123;</span><br><span class="line">    //传入对象是Executor，则用Plugin包装，否则返回原对象</span><br><span class="line">    if (target instanceof Executor) &#123;</span><br><span class="line">        return Plugin.wrap(target, this);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、Plugin的wrap方法"><a href="#4、Plugin的wrap方法" class="headerlink" title="4、Plugin的wrap方法"></a>4、Plugin的wrap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static Object wrap(Object target, Interceptor interceptor) &#123;</span><br><span class="line">    //过去，注解指定类及注解指定的类方法的Map</span><br><span class="line">    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = getSignatureMap(interceptor);</span><br><span class="line">    //Executor的类</span><br><span class="line">    Class&lt;?&gt; type = target.getClass();</span><br><span class="line">    Class&lt;?&gt;[] interfaces = getAllInterfaces(type, signatureMap);</span><br><span class="line">    if (interfaces.length &gt; 0) &#123;</span><br><span class="line">        //创建Executor的代理对象</span><br><span class="line">        return Proxy.newProxyInstance(</span><br><span class="line">          type.getClassLoader(),</span><br><span class="line">          interfaces,</span><br><span class="line">          //拦截器</span><br><span class="line">          new Plugin(target, interceptor, signatureMap));</span><br><span class="line">    &#125;</span><br><span class="line">    return target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、Plugin的getSignatureMap方法"><a href="#5、Plugin的getSignatureMap方法" class="headerlink" title="5、Plugin的getSignatureMap方法"></a>5、Plugin的getSignatureMap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private static Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; getSignatureMap(Interceptor interceptor) &#123;</span><br><span class="line">    //获取该类上的Intercepts注解</span><br><span class="line">    Intercepts interceptsAnnotation = interceptor.getClass().getAnnotation(Intercepts.class);</span><br><span class="line">    if (interceptsAnnotation == null) &#123; // issue #251</span><br><span class="line">        throw new PluginException(&quot;No @Intercepts annotation was found in interceptor &quot; + interceptor.getClass().getName());      </span><br><span class="line">    &#125;</span><br><span class="line">    //获取该注解值</span><br><span class="line">    Signature[] sigs = interceptsAnnotation.value();</span><br><span class="line">    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = new HashMap&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt;();</span><br><span class="line">    for (Signature sig : sigs) &#123;</span><br><span class="line">        //由注解指定的类，获取该类的被注解指定的方法</span><br><span class="line">        Set&lt;Method&gt; methods = signatureMap.get(sig.type());</span><br><span class="line">        if (methods == null) &#123;</span><br><span class="line">            methods = new HashSet&lt;Method&gt;();</span><br><span class="line">            //不存在，则添加进signatureMap</span><br><span class="line">            signatureMap.put(sig.type(), methods);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取注解指定类中的被注解指定方法</span><br><span class="line">            Method method = sig.type().getMethod(sig.method(), sig.args());</span><br><span class="line">            //添加进集合</span><br><span class="line">            methods.add(method);</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            throw new PluginException(&quot;Could not find method on &quot; + sig.type() + &quot; named &quot; + sig.method() + &quot;. Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return signatureMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、接（三、4）Plugin的invoke方法"><a href="#6、接（三、4）Plugin的invoke方法" class="headerlink" title="6、接（三、4）Plugin的invoke方法"></a>6、接（三、4）Plugin的invoke方法</h4><p>返回的代理对象为Plugin<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取注解指定的方法</span><br><span class="line">        Set&lt;Method&gt; methods = signatureMap.get(method.getDeclaringClass());</span><br><span class="line">        if (methods != null &amp;&amp; methods.contains(method)) &#123;</span><br><span class="line">            //拦截注解指定的方法</span><br><span class="line">            return interceptor.intercept(new Invocation(target, method, args));</span><br><span class="line">        &#125;</span><br><span class="line">        //调用原对象的该方法</span><br><span class="line">        return method.invoke(target, args);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionUtil.unwrapThrowable(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="7、PageHelper的intercept方法"><a href="#7、PageHelper的intercept方法" class="headerlink" title="7、PageHelper的intercept方法"></a>7、PageHelper的intercept方法</h4><p>Executor的query方法会被PageHelper拦截<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Object intercept(Invocation invocation) throws Throwable &#123;</span><br><span class="line">    //自动获取dialect，</span><br><span class="line">    if (autoDialect) &#123;</span><br><span class="line">        //初始化sqlUtil</span><br><span class="line">        initSqlUtil(invocation);</span><br><span class="line">    &#125;</span><br><span class="line">    return sqlUtil.processPage(invocation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="8、SqlUtil的processPage方法"><a href="#8、SqlUtil的processPage方法" class="headerlink" title="8、SqlUtil的processPage方法"></a>8、SqlUtil的processPage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Object processPage(Invocation invocation) throws Throwable &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Object result = _processPage(invocation);</span><br><span class="line">        return result;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        clearLocalPage();</span><br><span class="line">        OrderByHelper.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、SqlUtil的-processPage方法"><a href="#9、SqlUtil的-processPage方法" class="headerlink" title="9、SqlUtil的_processPage方法"></a>9、SqlUtil的_processPage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">private Object _processPage(Invocation invocation) throws Throwable &#123;</span><br><span class="line">    //获取参数</span><br><span class="line">    final Object[] args = invocation.getArgs();</span><br><span class="line">    //query方法的第三个参数是RowBounds</span><br><span class="line">    RowBounds rowBounds = (RowBounds) args[2];</span><br><span class="line">    if (SqlUtil.getLocalPage() == null &amp;&amp; rowBounds == RowBounds.DEFAULT) &#123;</span><br><span class="line">        //未设置查询数量限制，直接执行</span><br><span class="line">        //设置了排序</span><br><span class="line">        if (OrderByHelper.getOrderBy() != null) &#123;</span><br><span class="line">            //封装排序，返回OrderByDynamicSqlSource对象</span><br><span class="line">            OrderByHelper.processIntercept(invocation);</span><br><span class="line">        &#125;</span><br><span class="line">        //执行查询</span><br><span class="line">        return invocation.proceed();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //获取原始的ms</span><br><span class="line">        MappedStatement ms = (MappedStatement) args[0];</span><br><span class="line">        //判断并处理为PageSqlSource</span><br><span class="line">        if (!isPageSqlSource(ms)) &#123;</span><br><span class="line">            processMappedStatement(ms, parser);</span><br><span class="line">        &#125;</span><br><span class="line">        //忽略RowBounds-否则会进行Mybatis自带的内存分页</span><br><span class="line">        args[2] = RowBounds.DEFAULT;</span><br><span class="line">        //获取分页信息</span><br><span class="line">        Page page = getPage(rowBounds);</span><br><span class="line">        //pageSizeZero的判断</span><br><span class="line">        if ((page.getPageSizeZero() != null &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == 0) &#123;</span><br><span class="line">            COUNT.set(null);</span><br><span class="line">            //执行正常（不分页）查询</span><br><span class="line">            Object result = invocation.proceed();</span><br><span class="line">            //得到处理结果</span><br><span class="line">            page.addAll((List) result);</span><br><span class="line">            //相当于查询第一页</span><br><span class="line">            page.setPageNum(1);</span><br><span class="line">            //这种情况相当于pageSize=total</span><br><span class="line">            page.setPageSize(page.size());</span><br><span class="line">            //仍然要设置total</span><br><span class="line">            page.setTotal(page.size());</span><br><span class="line">            //返回结果仍然为Page类型 - 便于后面对接收类型的统一处理</span><br><span class="line">            return page;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //简单的通过total的值来判断是否进行count查询，total默认等于1</span><br><span class="line">        if (page.isCount()) &#123;</span><br><span class="line">            COUNT.set(Boolean.TRUE);</span><br><span class="line">            //替换MS</span><br><span class="line">            args[0] = msCountMap.get(ms.getId());</span><br><span class="line">            //查询总数</span><br><span class="line">            Object result = invocation.proceed();</span><br><span class="line">            //还原ms</span><br><span class="line">            args[0] = ms;</span><br><span class="line">            //设置总数</span><br><span class="line">            page.setTotal((Integer) ((List) result).get(0));</span><br><span class="line">            if (page.getTotal() == 0) &#123;</span><br><span class="line">                return page;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //pageSize&gt;0的时候执行分页查询，pageSize&lt;=0的时候不执行相当于可能只返回了一个count</span><br><span class="line">        if (page.getPageSize() &gt; 0 &amp;&amp;</span><br><span class="line">                ((rowBounds == RowBounds.DEFAULT &amp;&amp; page.getPageNum() &gt; 0)</span><br><span class="line">                        || rowBounds != RowBounds.DEFAULT)) &#123;</span><br><span class="line">            //将参数中的MappedStatement替换为新的qs</span><br><span class="line">            COUNT.set(null);</span><br><span class="line">            BoundSql boundSql = ms.getBoundSql(args[1]);</span><br><span class="line">            args[1] = parser.setPageParameter(ms, args[1], boundSql, page);</span><br><span class="line">            COUNT.set(Boolean.FALSE);</span><br><span class="line">            //执行分页查询</span><br><span class="line">            Object result = invocation.proceed();</span><br><span class="line">            //得到处理结果</span><br><span class="line">            page.addAll((List) result);</span><br><span class="line">        &#125;</span><br><span class="line">        //返回结果</span><br><span class="line">        return page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、SqlUtil的processMappedStatement方法"><a href="#10、SqlUtil的processMappedStatement方法" class="headerlink" title="10、SqlUtil的processMappedStatement方法"></a>10、SqlUtil的processMappedStatement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public static void processMappedStatement(MappedStatement ms, Parser parser) throws Throwable &#123;</span><br><span class="line">    SqlSource sqlSource = ms.getSqlSource();</span><br><span class="line">    MetaObject msObject = SystemMetaObject.forObject(ms);</span><br><span class="line">    SqlSource tempSqlSource = sqlSource;</span><br><span class="line">    if (sqlSource instanceof OrderBySqlSource) &#123;</span><br><span class="line">        tempSqlSource = ((OrderBySqlSource) tempSqlSource).getOriginal();</span><br><span class="line">    &#125;</span><br><span class="line">    SqlSource pageSqlSource;</span><br><span class="line">    if (tempSqlSource instanceof StaticSqlSource) &#123;</span><br><span class="line">        pageSqlSource = new PageStaticSqlSource((StaticSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else if (tempSqlSource instanceof RawSqlSource) &#123;</span><br><span class="line">        pageSqlSource = new PageRawSqlSource((RawSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else if (tempSqlSource instanceof ProviderSqlSource) &#123;</span><br><span class="line">        pageSqlSource = new PageProviderSqlSource((ProviderSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else if (tempSqlSource instanceof DynamicSqlSource) &#123;</span><br><span class="line">        //默认DynamicSqlSource</span><br><span class="line">        pageSqlSource = new PageDynamicSqlSource((DynamicSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new RuntimeException(&quot;无法处理该类型[&quot; + sqlSource.getClass() + &quot;]的SqlSource&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //替换原来的sqlSource</span><br><span class="line">    msObject.setValue(&quot;sqlSource&quot;, pageSqlSource);</span><br><span class="line">    //由于count查询需要修改返回值，因此这里要创建一个Count查询的MS</span><br><span class="line">    msCountMap.put(ms.getId(), MSUtils.newCountMappedStatement(ms));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、接（三、9）SqlUtil的getPage方法"><a href="#11、接（三、9）SqlUtil的getPage方法" class="headerlink" title="11、接（三、9）SqlUtil的getPage方法"></a>11、接（三、9）SqlUtil的getPage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public Page getPage(Object params) &#123;</span><br><span class="line">    //获取本线程对应的page</span><br><span class="line">    Page page = getLocalPage();</span><br><span class="line">    //未设置page尝试从查询方法参数RowBounds中获取分页信息</span><br><span class="line">    if (page == null) &#123;</span><br><span class="line">        if (params instanceof RowBounds) &#123;</span><br><span class="line">            RowBounds rowBounds = (RowBounds) params;</span><br><span class="line">            if (offsetAsPageNum) &#123;</span><br><span class="line">                page = new Page(rowBounds.getOffset(), rowBounds.getLimit(), rowBoundsWithCount);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                page = new Page(rowBounds, rowBoundsWithCount);</span><br><span class="line">                //offsetAsPageNum=false的时候，由于PageNum问题，不能使用reasonable，这里会强制为false</span><br><span class="line">                page.setReasonable(false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            page = getPageFromObject(params);</span><br><span class="line">        &#125;</span><br><span class="line">        setLocalPage(page);</span><br><span class="line">    &#125;</span><br><span class="line">    //分页合理化</span><br><span class="line">    if (page.getReasonable() == null) &#123;</span><br><span class="line">        page.setReasonable(reasonable);</span><br><span class="line">    &#125;</span><br><span class="line">    //当设置为true的时候，如果pagesize设置为0（或RowBounds的limit=0），就不执行分页，返回全部结果</span><br><span class="line">    if (page.getPageSizeZero() == null) &#123;</span><br><span class="line">        page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    &#125;</span><br><span class="line">    return page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、接（三、9）MysqlParser的setPageParameter方法"><a href="#12、接（三、9）MysqlParser的setPageParameter方法" class="headerlink" title="12、接（三、9）MysqlParser的setPageParameter方法"></a>12、接（三、9）MysqlParser的setPageParameter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Map setPageParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql, Page page) &#123;</span><br><span class="line">    Map paramMap = super.setPageParameter(ms, parameterObject, boundSql, page);</span><br><span class="line">    paramMap.put(PAGEPARAMETER_FIRST, page.getStartRow());</span><br><span class="line">    paramMap.put(PAGEPARAMETER_SECOND, page.getPageSize());</span><br><span class="line">    return paramMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MysqlParser父类AbstractParser的setPageParameter方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Map setPageParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql, Page page) &#123;</span><br><span class="line">    return processParameter(ms, parameterObject, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="13、MysqlParser的processParameter方法"><a href="#13、MysqlParser的processParameter方法" class="headerlink" title="13、MysqlParser的processParameter方法"></a>13、MysqlParser的processParameter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public static Map&lt;String, Object&gt; processParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql) &#123;</span><br><span class="line">    Map paramMap = null;</span><br><span class="line">    if (parameterObject == null) &#123;</span><br><span class="line">        paramMap = new HashMap();</span><br><span class="line">    &#125; else if (parameterObject instanceof Map) &#123;</span><br><span class="line">        //解决不可变Map的情况</span><br><span class="line">        paramMap = new HashMap();</span><br><span class="line">        paramMap.putAll((Map) parameterObject);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        paramMap = new HashMap();</span><br><span class="line">        //动态sql时的判断条件不会出现在ParameterMapping中，但是必须有，所以这里需要收集所有的getter属性</span><br><span class="line">        //TypeHandlerRegistry可以直接处理的会作为一个直接使用的对象进行处理</span><br><span class="line">        boolean hasTypeHandler = ms.getConfiguration().getTypeHandlerRegistry().hasTypeHandler(parameterObject.getClass());</span><br><span class="line">        MetaObject metaObject = SystemMetaObject.forObject(parameterObject);</span><br><span class="line">        //需要针对注解形式的MyProviderSqlSource保存原值</span><br><span class="line">        if (ms.getSqlSource() instanceof PageProviderSqlSource) &#123;</span><br><span class="line">            paramMap.put(PROVIDER_OBJECT, parameterObject);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!hasTypeHandler) &#123;</span><br><span class="line">            for (String name : metaObject.getGetterNames()) &#123;</span><br><span class="line">                paramMap.put(name, metaObject.getValue(name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //下面这段方法，主要解决一个常见类型的参数时的问题</span><br><span class="line">        if (boundSql.getParameterMappings() != null &amp;&amp; boundSql.getParameterMappings().size() &gt; 0) &#123;</span><br><span class="line">            for (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;</span><br><span class="line">                String name = parameterMapping.getProperty();</span><br><span class="line">                if (!name.equals(PAGEPARAMETER_FIRST)</span><br><span class="line">                        &amp;&amp; !name.equals(PAGEPARAMETER_SECOND)</span><br><span class="line">                        &amp;&amp; paramMap.get(name) == null) &#123;</span><br><span class="line">                    if (hasTypeHandler</span><br><span class="line">                            || parameterMapping.getJavaType().equals(parameterObject.getClass())) &#123;</span><br><span class="line">                        paramMap.put(name, parameterObject);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //备份原始参数对象</span><br><span class="line">    paramMap.put(ORIGINAL_PARAMETER_OBJECT, parameterObject);</span><br><span class="line">    return paramMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、PageSqlSource的getBoundSql方法"><a href="#14、PageSqlSource的getBoundSql方法" class="headerlink" title="14、PageSqlSource的getBoundSql方法"></a>14、PageSqlSource的getBoundSql方法</h4><p>Invocation的proceed方法，实际是调用了被代理对象的query方法，与之前相同的方法略过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BoundSql getBoundSql(Object parameterObject) &#123;</span><br><span class="line">    Boolean count = getCount();</span><br><span class="line">    if(count == null)&#123;</span><br><span class="line">        //原始的sql</span><br><span class="line">        return getDefaultBoundSql(parameterObject);</span><br><span class="line">    &#125; else if(count)&#123;</span><br><span class="line">        //统计sql</span><br><span class="line">        return getCountBoundSql(parameterObject);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //分页sql</span><br><span class="line">        return getPageBoundSql(parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="15、PageDynamicSqlSource的getCountBoundSql方法"><a href="#15、PageDynamicSqlSource的getCountBoundSql方法" class="headerlink" title="15、PageDynamicSqlSource的getCountBoundSql方法"></a>15、PageDynamicSqlSource的getCountBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected BoundSql getCountBoundSql(Object parameterObject) &#123;</span><br><span class="line">    DynamicContext context = new DynamicContext(configuration, parameterObject);</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration);</span><br><span class="line">    Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass();</span><br><span class="line">    SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">    BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //sql修改为查询总量sql，AbstractParser.getCountSql方法</span><br><span class="line">    sqlSource = new StaticSqlSource(configuration, parser.getCountSql(boundSql.getSql()), boundSql.getParameterMappings());</span><br><span class="line">    boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //设置条件参数</span><br><span class="line">    for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">        boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法"><a href="#16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法" class="headerlink" title="16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法"></a>16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected BoundSql getPageBoundSql(Object parameterObject) &#123;</span><br><span class="line">    DynamicContext context;</span><br><span class="line">    //由于增加分页参数后会修改parameterObject的值，因此在前面处理时备份该值</span><br><span class="line">    //如果发现参数是Map并且包含该KEY，就使用备份的该值</span><br><span class="line">    //解决bug#25:http://git.oschina.net/free/Mybatis_PageHelper/issues/25</span><br><span class="line">    if (parameterObject != null</span><br><span class="line">            &amp;&amp; parameterObject instanceof Map</span><br><span class="line">            &amp;&amp; ((Map) parameterObject).containsKey(ORIGINAL_PARAMETER_OBJECT)) &#123;</span><br><span class="line">        context = new DynamicContext(configuration, ((Map) parameterObject).get(ORIGINAL_PARAMETER_OBJECT));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        context = new DynamicContext(configuration, parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration);</span><br><span class="line">    Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass();</span><br><span class="line">    SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">    sqlSource = new OrderByStaticSqlSource((StaticSqlSource) sqlSource);</span><br><span class="line">    BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //sql修改为查询总量sql，AbstractParser.getPageSql方法</span><br><span class="line">    sqlSource = new StaticSqlSource(configuration, parser.getPageSql(boundSql.getSql()), parser.getPageParameterMapping(configuration, boundSql));</span><br><span class="line">    boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //设置条件参数</span><br><span class="line">    for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">        boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、PageHelper的startPage方法"><a href="#17、PageHelper的startPage方法" class="headerlink" title="17、PageHelper的startPage方法"></a>17、PageHelper的startPage方法</h4><p>PageHelper的startPage方法设置本线程下次查询的参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize) &#123;</span><br><span class="line">    return startPage(pageNum, pageSize, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize, boolean count) &#123;</span><br><span class="line">    return startPage(pageNum, pageSize, count, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize, boolean count, Boolean reasonable) &#123;</span><br><span class="line">    return startPage(pageNum, pageSize, count, reasonable, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize, boolean count, Boolean reasonable, Boolean pageSizeZero) &#123;</span><br><span class="line">    Page page = new Page(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    SqlUtil.setLocalPage(page);</span><br><span class="line">    return page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、SqlUtil的setLocalPage方法"><a href="#18、SqlUtil的setLocalPage方法" class="headerlink" title="18、SqlUtil的setLocalPage方法"></a>18、SqlUtil的setLocalPage方法</h4><p>LOCAL_PAGE是一个线程局部变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final ThreadLocal&lt;Page&gt; LOCAL_PAGE = new ThreadLocal&lt;Page&gt;();</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void setLocalPage(Page page) &#123;</span><br><span class="line">    //将page添加进线程局部变量</span><br><span class="line">    LOCAL_PAGE.set(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="四、元对象MetaObject"><a href="#四、元对象MetaObject" class="headerlink" title="四、元对象MetaObject"></a>四、元对象MetaObject</h3><h4 id="1、Configuration的newMetaObject方法"><a href="#1、Configuration的newMetaObject方法" class="headerlink" title="1、Configuration的newMetaObject方法"></a>1、Configuration的newMetaObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public MetaObject newMetaObject(Object object) &#123;</span><br><span class="line">    return MetaObject.forObject(object, objectFactory, objectWrapperFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、MetaObject的forObject方法"><a href="#2、MetaObject的forObject方法" class="headerlink" title="2、MetaObject的forObject方法"></a>2、MetaObject的forObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static MetaObject forObject(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory) &#123;</span><br><span class="line">    if (object == null) &#123;</span><br><span class="line">        return SystemMetaObject.NULL_META_OBJECT;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return new MetaObject(object, objectFactory, objectWrapperFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、实例化MetaObject"><a href="#3、实例化MetaObject" class="headerlink" title="3、实例化MetaObject"></a>3、实例化MetaObject</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private MetaObject(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory) &#123;</span><br><span class="line">    this.originalObject = object;</span><br><span class="line">    this.objectFactory = objectFactory;</span><br><span class="line">    this.objectWrapperFactory = objectWrapperFactory;</span><br><span class="line"></span><br><span class="line">    if (object instanceof ObjectWrapper) &#123;</span><br><span class="line">        this.objectWrapper = (ObjectWrapper) object;</span><br><span class="line">    &#125; else if (objectWrapperFactory.hasWrapperFor(object)) &#123;</span><br><span class="line">        this.objectWrapper = objectWrapperFactory.getWrapperFor(this, object);</span><br><span class="line">    &#125; else if (object instanceof Map) &#123;</span><br><span class="line">        this.objectWrapper = new MapWrapper(this, (Map) object);</span><br><span class="line">    &#125; else if (object instanceof Collection) &#123;</span><br><span class="line">        this.objectWrapper = new CollectionWrapper(this, (Collection) object);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //本例以object为bean</span><br><span class="line">        this.objectWrapper = new BeanWrapper(this, object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、实例化BeanWrapper"><a href="#3、实例化BeanWrapper" class="headerlink" title="3、实例化BeanWrapper"></a>3、实例化BeanWrapper</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public BeanWrapper(MetaObject metaObject, Object object) &#123;</span><br><span class="line">    super(metaObject);</span><br><span class="line">    this.object = object;</span><br><span class="line">    this.metaClass = MetaClass.forClass(object.getClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、MetaObject的hasSetter方法"><a href="#4、MetaObject的hasSetter方法" class="headerlink" title="4、MetaObject的hasSetter方法"></a>4、MetaObject的hasSetter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasSetter(String name) &#123;</span><br><span class="line">    return objectWrapper.hasSetter(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、BeanWrapper的hasSetter方法"><a href="#5、BeanWrapper的hasSetter方法" class="headerlink" title="5、BeanWrapper的hasSetter方法"></a>5、BeanWrapper的hasSetter方法</h4><p>name为bean的属性，通常为name或user.name<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasSetter(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = new PropertyTokenizer(name);</span><br><span class="line">    if (prop.hasNext()) &#123;</span><br><span class="line">        //name包含小数点，说明bean A的属性为另一个bean B</span><br><span class="line">        //检验bean A是否有bean B的set方法</span><br><span class="line">        if (metaClass.hasSetter(prop.getIndexedName())) &#123;</span><br><span class="line">            //获取bean B的MetaObject封装对象</span><br><span class="line">            MetaObject metaValue = metaObject.metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">            if (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;</span><br><span class="line">                return metaClass.hasSetter(name);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //检查bean B是否有该属性的set方法</span><br><span class="line">                return metaValue.hasSetter(prop.getChildren());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return metaClass.hasSetter(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、MetaObject的metaObjectForProperty方法"><a href="#6、MetaObject的metaObjectForProperty方法" class="headerlink" title="6、MetaObject的metaObjectForProperty方法"></a>6、MetaObject的metaObjectForProperty方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public MetaObject metaObjectForProperty(String name) &#123;</span><br><span class="line">    //获取name对象</span><br><span class="line">    Object value = getValue(name);</span><br><span class="line">    //MetaObject封装该对象</span><br><span class="line">    return MetaObject.forObject(value, objectFactory, objectWrapperFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、MetaObject的getValue方法"><a href="#7、MetaObject的getValue方法" class="headerlink" title="7、MetaObject的getValue方法"></a>7、MetaObject的getValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public Object getValue(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = new PropertyTokenizer(name);</span><br><span class="line">    //判断是否有第三层，有则递归调用</span><br><span class="line">    if (prop.hasNext()) &#123;</span><br><span class="line">            MetaObject metaValue = metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">        if (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return metaValue.getValue(prop.getChildren());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //获取该对象</span><br><span class="line">        return objectWrapper.get(prop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、insert执行过程&quot;&gt;&lt;a href=&quot;#一、insert执行过程&quot; class=&quot;headerlink&quot; title=&quot;一、insert执行过程&quot;&gt;&lt;/a&gt;一、insert执行过程&lt;/h3&gt;&lt;h4 id=&quot;1、DefaultSqlSession的inser
      
    
    </summary>
    
      <category term="mybatis3" scheme="http://yoursite.com/categories/mybatis3/"/>
    
    
  </entry>
  
  <entry>
    <title>mybatis源码sql执行过程（1）</title>
    <link href="http://yoursite.com/2018/04/20/mybatis3%E6%BA%90%E7%A0%81/mybatis%E6%BA%90%E7%A0%81sql%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%EF%BC%881%EF%BC%89/"/>
    <id>http://yoursite.com/2018/04/20/mybatis3源码/mybatis源码sql执行过程（1）/</id>
    <published>2018-04-20T12:41:54.492Z</published>
    <updated>2018-06-28T14:04:27.597Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、获取SqlSession过程"><a href="#一、获取SqlSession过程" class="headerlink" title="一、获取SqlSession过程"></a>一、获取SqlSession过程</h3><h4 id="1、DefaultSqlSessionFactory的openSession方法"><a href="#1、DefaultSqlSessionFactory的openSession方法" class="headerlink" title="1、DefaultSqlSessionFactory的openSession方法"></a>1、DefaultSqlSessionFactory的openSession方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSession openSession() &#123;</span><br><span class="line">    return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、DefaultSqlSessionFactory的openSession方法"><a href="#2、DefaultSqlSessionFactory的openSession方法" class="headerlink" title="2、DefaultSqlSessionFactory的openSession方法"></a>2、DefaultSqlSessionFactory的openSession方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSession openSession() &#123;</span><br><span class="line">    return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、DefaultSqlSessionFactory的openSessionFromDataSource方法"><a href="#3、DefaultSqlSessionFactory的openSessionFromDataSource方法" class="headerlink" title="3、DefaultSqlSessionFactory的openSessionFromDataSource方法"></a>3、DefaultSqlSessionFactory的openSessionFromDataSource方法</h4><p>这个是最终创建SqlSession对象的方法，需要三个参数。<br>execType,这个示例使用的是configuration.getDefaultExecutorType(),默认ExecutorType.SIMPLE。<br>事务隔离等级，我们对数据库操作里一般都不会带这个属性，这个属性由数据库分配即可。<br>autoCommit:这个一般都是false，不然事务将没有意义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        final Environment environment = configuration.getEnvironment();</span><br><span class="line">        //获取一个事务工厂,配置文件中配置,默认ManagedTransactionFactory</span><br><span class="line">        final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">        //通过事务工厂获取一个事务，默认ManagedTransaction 这个配置从来都不提交和回滚一个连接，而是让容器来管理事务的整个生命周期（比如JEE应用服务的上下文）。</span><br><span class="line">        //默认情况下他会关闭连接，closeConnection属性设置为false来阻止它默认的关闭行为</span><br><span class="line">        //JdbcTransactionFactory,这个配置就是直接使用了JDBC 的提交和回滚设置，它依赖于从数据源得到的连接来管理事务范围。</span><br><span class="line">        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">        //根据execType获取一个Executor，默认SimpleExecutor</span><br><span class="line">        final Executor executor = configuration.newExecutor(tx, execType, autoCommit);</span><br><span class="line">        return new DefaultSqlSession(configuration, executor);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        closeTransaction(tx); // may have fetched a connection so lets call close()</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、Configuration的newExecutor方法"><a href="#4、Configuration的newExecutor方法" class="headerlink" title="4、Configuration的newExecutor方法"></a>4、Configuration的newExecutor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Executor newExecutor(Transaction transaction, ExecutorType executorType, boolean autoCommit) &#123;</span><br><span class="line">    executorType = executorType == null ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    if (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">        executor = new BatchExecutor(this, transaction);</span><br><span class="line">    &#125; else if (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">        executor = new ReuseExecutor(this, transaction);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //默认</span><br><span class="line">        executor = new SimpleExecutor(this, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    if (cacheEnabled) &#123;</span><br><span class="line">         executor = new CachingExecutor(executor, autoCommit);</span><br><span class="line">    &#125;</span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    return executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、Configuration的newExecutor方法"><a href="#5、Configuration的newExecutor方法" class="headerlink" title="5、Configuration的newExecutor方法"></a>5、Configuration的newExecutor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public Executor newExecutor(Transaction transaction, ExecutorType executorType, boolean autoCommit) &#123;</span><br><span class="line">    executorType = executorType == null ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    if (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">        //批量执行器</span><br><span class="line">        executor = new BatchExecutor(this, transaction);</span><br><span class="line">    &#125; else if (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">        executor = new ReuseExecutor(this, transaction);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //默认执行器</span><br><span class="line">        executor = new SimpleExecutor(this, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    if (cacheEnabled) &#123;</span><br><span class="line">        //使用二级缓存，则用该执行器封装一层</span><br><span class="line">        executor = new CachingExecutor(executor, autoCommit);</span><br><span class="line">    &#125;</span><br><span class="line">    //拦截器</span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    return executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>###二、创建Mapper代理对象过程</p><h4 id="1、DefaultSqlSession的getMapper方法"><a href="#1、DefaultSqlSession的getMapper方法" class="headerlink" title="1、DefaultSqlSession的getMapper方法"></a>1、DefaultSqlSession的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type) &#123;</span><br><span class="line">    return configuration.&lt;T&gt;getMapper(type, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、Configuration的getMapper方法"><a href="#2、Configuration的getMapper方法" class="headerlink" title="2、Configuration的getMapper方法"></a>2、Configuration的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type) &#123;</span><br><span class="line">    return configuration.&lt;T&gt;getMapper(type, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、mapperRegistry的getMapper方法"><a href="#3、mapperRegistry的getMapper方法" class="headerlink" title="3、mapperRegistry的getMapper方法"></a>3、mapperRegistry的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line">    //代理工厂</span><br><span class="line">    final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    if (mapperProxyFactory == null)</span><br><span class="line">        //说明这个Mapper接口没有注册 </span><br><span class="line">        throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);</span><br><span class="line">    try &#123;</span><br><span class="line">        //生成一个MapperProxy对象</span><br><span class="line">        return mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、MapperProxyFactory的newInstance方法"><a href="#4、MapperProxyFactory的newInstance方法" class="headerlink" title="4、MapperProxyFactory的newInstance方法"></a>4、MapperProxyFactory的newInstance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public T newInstance(SqlSession sqlSession) &#123;</span><br><span class="line">    //JDK动态代理InvocationHandler的实现类，在该类methodCache管理了被代理的方法，methodCache在整个应用中是共享的</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    return newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    //创建Mapper接口子类的代理类</span><br><span class="line">    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DemoMapper的selectOneById方法"><a href="#5、DemoMapper的selectOneById方法" class="headerlink" title="5、DemoMapper的selectOneById方法"></a>5、DemoMapper的selectOneById方法</h4><p>自动创建的代理类，执行MapperProxy的invoke方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        //如果是Object中定义的方法，直接执行。如toString(),hashCode()等。  </span><br><span class="line">        return method.invoke(this, args);</span><br><span class="line">    &#125;</span><br><span class="line">    //其他Mapper接口定义的方法交由mapperMethod来执行</span><br><span class="line">    final MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    return mapperMethod.execute(sqlSession, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、MapperMethod的execute方法"><a href="#6、MapperMethod的execute方法" class="headerlink" title="6、MapperMethod的execute方法"></a>6、MapperMethod的execute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    //判断这个方法被注解里的Sql类型</span><br><span class="line">    if (SqlCommandType.INSERT == command.getType()) &#123;</span><br><span class="line">        //增</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">    &#125; else if (SqlCommandType.UPDATE == command.getType()) &#123;</span><br><span class="line">        //改</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">    &#125; else if (SqlCommandType.DELETE == command.getType()) &#123;</span><br><span class="line">        //删</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">    &#125; else if (SqlCommandType.SELECT == command.getType()) &#123;</span><br><span class="line">        //查</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">            //没有返回值，并且有ResultHandler的情况</span><br><span class="line">            executeWithResultHandler(sqlSession, args);</span><br><span class="line">            result = null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">            //返回一个List</span><br><span class="line">            result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">            //返回一个Map</span><br><span class="line">            result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //返回一个对象</span><br><span class="line">            Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">            result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">        throw new BindingException(&quot;Mapper method &apos;&quot; + command.getName() </span><br><span class="line">              + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、MapperMethod的executeForMany方法"><a href="#7、MapperMethod的executeForMany方法" class="headerlink" title="7、MapperMethod的executeForMany方法"></a>7、MapperMethod的executeForMany方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private &lt;E&gt; Object executeForMany(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    List&lt;E&gt; result;</span><br><span class="line">    //解析传入参数</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    if (method.hasRowBounds()) &#123;</span><br><span class="line">        //结果有数量限制</span><br><span class="line">        RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">        result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        result = sqlSession.&lt;E&gt;selectList(command.getName(), param);</span><br><span class="line">    &#125;</span><br><span class="line">    // issue #510 Collections &amp; arrays support</span><br><span class="line">    if (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">        if (method.getReturnType().isArray()) &#123;</span><br><span class="line">            return convertToArray(result);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //sql返回的集合，转化为方法声明的集合</span><br><span class="line">            return convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、MapperMethod的convertArgsToSqlCommandParam方法"><a href="#8、MapperMethod的convertArgsToSqlCommandParam方法" class="headerlink" title="8、MapperMethod的convertArgsToSqlCommandParam方法"></a>8、MapperMethod的convertArgsToSqlCommandParam方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public Object convertArgsToSqlCommandParam(Object[] args) &#123;</span><br><span class="line">    //参数个数，配置加载的时候，parameterType只能有一个参数</span><br><span class="line">    final int paramCount = params.size();</span><br><span class="line">    if (args == null || paramCount == 0) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else if (!hasNamedParameters &amp;&amp; paramCount == 1) &#123;</span><br><span class="line">        //获取并返回参数</span><br><span class="line">        return args[params.keySet().iterator().next()];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final Map&lt;String, Object&gt; param = new ParamMap&lt;Object&gt;();</span><br><span class="line">        int i = 0;</span><br><span class="line">        for (Map.Entry&lt;Integer, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">            //按照对应顺序获取参数</span><br><span class="line">            param.put(entry.getValue(), args[entry.getKey()]);</span><br><span class="line">            final String genericParamName = &quot;param&quot; + String.valueOf(i + 1);</span><br><span class="line">            if (!param.containsKey(genericParamName)) &#123;</span><br><span class="line">                param.put(genericParamName, args[entry.getKey()]);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        return param;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>###三、获取可执行sql过程</p><h4 id="1、DefaultSqlSession的selectList方法"><a href="#1、DefaultSqlSession的selectList方法" class="headerlink" title="1、DefaultSqlSession的selectList方法"></a>1、DefaultSqlSession的selectList方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //statement是命名空间+sql的id(等于mapper名+sql的id),获取sql的MappedStatement</span><br><span class="line">        MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">        List&lt;E&gt; result = executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">        return result;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error querying database.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、BaseExecutor的query方法"><a href="#2、BaseExecutor的query方法" class="headerlink" title="2、BaseExecutor的query方法"></a>2、BaseExecutor的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    //BoundSql包含可执行的sql和参数集合 </span><br><span class="line">    BoundSql boundSql = ms.getBoundSql(parameter);</span><br><span class="line">    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">    return query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、MappedStatement的getBoundSql方法"><a href="#3、MappedStatement的getBoundSql方法" class="headerlink" title="3、MappedStatement的getBoundSql方法"></a>3、MappedStatement的getBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  public BoundSql getBoundSql(Object parameterObject) &#123;</span><br><span class="line">      //通过sqlSource对象获取 </span><br><span class="line">      BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">      /parameterMap一般不会配置</span><br><span class="line">      List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">      if (parameterMappings == null || parameterMappings.size() &lt;= 0) &#123;</span><br><span class="line">          boundSql = new BoundSql(configuration, boundSql.getSql(), parameterMap.getParameterMappings(), parameterObject);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // check for nested result maps in parameter mappings (issue #30)</span><br><span class="line">      for (ParameterMapping pm : boundSql.getParameterMappings()) &#123;</span><br><span class="line">          String rmId = pm.getResultMapId();</span><br><span class="line">          if (rmId != null) &#123;</span><br><span class="line">              ResultMap rm = configuration.getResultMap(rmId);</span><br><span class="line">              if (rm != null) &#123;</span><br><span class="line">                  hasNestedResultMaps |= rm.hasNestedResultMaps();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、DynamicSqlSource的getBoundSql方法"><a href="#4、DynamicSqlSource的getBoundSql方法" class="headerlink" title="4、DynamicSqlSource的getBoundSql方法"></a>4、DynamicSqlSource的getBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  public BoundSql getBoundSql(Object parameterObject) &#123;</span><br><span class="line">      DynamicContext context = new DynamicContext(configuration, parameterObject);</span><br><span class="line">      //sqlNode使用组合模式实现，他有多个SqlNode对象  </span><br><span class="line">      //每个SqlNode的apply方法调用时，都为将sql加到context中，最终通过context.getSql()得到完整的sql </span><br><span class="line">      rootSqlNode.apply(context);</span><br><span class="line">      SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration);</span><br><span class="line">      //参数类型</span><br><span class="line">      Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass();</span><br><span class="line">      //这里就是处理&quot;#&#123;&#125;&quot;占位符的地方，返回的StaticSqlSource中包含了可执行的sql </span><br><span class="line">      SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">      //这个BoundSql就是数据库可执行的Sql,同时还包含了运行时的参数  </span><br><span class="line">      BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">      for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">          boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">      return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、SqlNode的apply方法"><a href="#5、SqlNode的apply方法" class="headerlink" title="5、SqlNode的apply方法"></a>5、SqlNode的apply方法</h4><p>MixedSqlNode的apply<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    for (SqlNode sqlNode : contents) &#123;</span><br><span class="line">        sqlNode.apply(context);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>混合节点MixedSqlNode的apply<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    for (SqlNode sqlNode : contents) &#123;</span><br><span class="line">        sqlNode.apply(context);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>文本节点TextSqlNode的apply<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    //解析$&#123;tab_name&#125;这种占位符</span><br><span class="line">    GenericTokenParser parser = new GenericTokenParser(&quot;$&#123;&quot;, &quot;&#125;&quot;, new BindingTokenParser(context));</span><br><span class="line">    //BindingTokenParser的handleToken方法将$&#123;tab_name&#125;替换为传入参数，并将sql加入context中</span><br><span class="line">    context.appendSql(parser.parse(text));</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>if节点IfSqlNode的apply<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    //test表达式成立</span><br><span class="line">    if (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</span><br><span class="line">        //继续执行子sql节点的apply</span><br><span class="line">        contents.apply(context);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6、接（三、4）SqlSourceBuilder的parse方法"><a href="#6、接（三、4）SqlSourceBuilder的parse方法" class="headerlink" title="6、接（三、4）SqlSourceBuilder的parse方法"></a>6、接（三、4）SqlSourceBuilder的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public SqlSource parse(String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters) &#123;</span><br><span class="line">    //处理占位符的handler </span><br><span class="line">    ParameterMappingTokenHandler handler = new ParameterMappingTokenHandler(configuration, parameterType, additionalParameters);</span><br><span class="line">    //要处理什么样的占位符</span><br><span class="line">    GenericTokenParser parser = new GenericTokenParser(&quot;#&#123;&quot;, &quot;&#125;&quot;, handler);</span><br><span class="line">    //开始处理</span><br><span class="line">    String sql = parser.parse(originalSql);</span><br><span class="line">    //这个SqlSource就是一个简单的java对象</span><br><span class="line">    return new StaticSqlSource(configuration, sql, handler.getParameterMappings());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、ParameterMappingTokenHandler的handleToken方法"><a href="#7、ParameterMappingTokenHandler的handleToken方法" class="headerlink" title="7、ParameterMappingTokenHandler的handleToken方法"></a>7、ParameterMappingTokenHandler的handleToken方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public String handleToken(String content) &#123;</span><br><span class="line">    parameterMappings.add(buildParameterMapping(content));</span><br><span class="line">    return &quot;?&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ParameterMappingTokenHandler的buildParameterMapping方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">private ParameterMapping buildParameterMapping(String content) &#123;</span><br><span class="line">    //这里content可以是这样子的:#&#123;height,javaType=double,jdbcType=NUMERIC,numericScale=2&#125;  </span><br><span class="line">    //parseParameterMapping()就是把这种复杂的复杂解析成Map方式</span><br><span class="line">    Map&lt;String, String&gt; propertiesMap = parseParameterMapping(content);</span><br><span class="line">    String property = propertiesMap.get(&quot;property&quot;);</span><br><span class="line">    //解析参数的类型,String,int or boolean ...</span><br><span class="line">    Class&lt;?&gt; propertyType;</span><br><span class="line">    if (metaParameters.hasGetter(property)) &#123; // issue #448 get type from additional params</span><br><span class="line">        propertyType = metaParameters.getGetterType(property);</span><br><span class="line">    &#125; else if (typeHandlerRegistry.hasTypeHandler(parameterType)) &#123;</span><br><span class="line">        propertyType = parameterType;</span><br><span class="line">    &#125; else if (JdbcType.CURSOR.name().equals(propertiesMap.get(&quot;jdbcType&quot;))) &#123;</span><br><span class="line">        propertyType = java.sql.ResultSet.class;</span><br><span class="line">    &#125; else if (property != null) &#123;</span><br><span class="line">        MetaClass metaClass = MetaClass.forClass(parameterType);</span><br><span class="line">        if (metaClass.hasGetter(property)) &#123;</span><br><span class="line">            propertyType = metaClass.getGetterType(property);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            propertyType = Object.class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        propertyType = Object.class;</span><br><span class="line">    &#125;</span><br><span class="line">    //构建一个ParameterMapping对象，ParameterMapping描述的是java对象的属性与sql执行参数的对应关系。跟ResultMapping对象差不多</span><br><span class="line">    ParameterMapping.Builder builder = new ParameterMapping.Builder(configuration, property, propertyType);</span><br><span class="line">    Class&lt;?&gt; javaType = propertyType;</span><br><span class="line">    String typeHandlerAlias = null;</span><br><span class="line">    for (Map.Entry&lt;String, String&gt; entry : propertiesMap.entrySet()) &#123;</span><br><span class="line">        String name = entry.getKey();</span><br><span class="line">        String value = entry.getValue();</span><br><span class="line">        //示例:#&#123;height,javaType=double,jdbcType=NUMERIC,numericScale=2&#125;</span><br><span class="line">        if (&quot;javaType&quot;.equals(name)) &#123;</span><br><span class="line">            javaType = resolveClass(value);</span><br><span class="line">            builder.javaType(javaType);</span><br><span class="line">        &#125; else if (&quot;jdbcType&quot;.equals(name)) &#123;</span><br><span class="line">            builder.jdbcType(resolveJdbcType(value));</span><br><span class="line">        &#125; else if (&quot;mode&quot;.equals(name)) &#123;</span><br><span class="line">            builder.mode(resolveParameterMode(value));</span><br><span class="line">        &#125; else if (&quot;numericScale&quot;.equals(name)) &#123;</span><br><span class="line">            builder.numericScale(Integer.valueOf(value));</span><br><span class="line">        &#125; else if (&quot;resultMap&quot;.equals(name)) &#123;</span><br><span class="line">            builder.resultMapId(value);</span><br><span class="line">        &#125; else if (&quot;typeHandler&quot;.equals(name)) &#123;</span><br><span class="line">            typeHandlerAlias = value;</span><br><span class="line">        &#125; else if (&quot;jdbcTypeName&quot;.equals(name)) &#123;</span><br><span class="line">            builder.jdbcTypeName(value);</span><br><span class="line">        &#125; else if (&quot;property&quot;.equals(name)) &#123;</span><br><span class="line">            // Do Nothing</span><br><span class="line">        &#125; else if (&quot;expression&quot;.equals(name)) &#123;</span><br><span class="line">            throw new BuilderException(&quot;Expression based parameters are not supported yet&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new BuilderException(&quot;An invalid property &apos;&quot; + name + &quot;&apos; was found in mapping #&#123;&quot; + content + &quot;&#125;.  Valid properties are &quot; + parameterProperties);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (typeHandlerAlias != null) &#123;</span><br><span class="line">        builder.typeHandler(resolveTypeHandler(javaType, typeHandlerAlias));</span><br><span class="line">    &#125;</span><br><span class="line">    return builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="四、一级缓存处理过程"><a href="#四、一级缓存处理过程" class="headerlink" title="四、一级缓存处理过程"></a>四、一级缓存处理过程</h3><h4 id="1、接（三、2）BaseExecutor的createCacheKey方法"><a href="#1、接（三、2）BaseExecutor的createCacheKey方法" class="headerlink" title="1、接（三、2）BaseExecutor的createCacheKey方法"></a>1、接（三、2）BaseExecutor的createCacheKey方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public CacheKey createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) &#123;</span><br><span class="line">    if (closed) throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    //创建缓存key</span><br><span class="line">    CacheKey cacheKey = new CacheKey();</span><br><span class="line">    //sql的id</span><br><span class="line">    cacheKey.update(ms.getId());</span><br><span class="line">    //查询的开始条数</span><br><span class="line">    cacheKey.update(rowBounds.getOffset());</span><br><span class="line">    //查询的结束条数</span><br><span class="line">    cacheKey.update(rowBounds.getLimit());</span><br><span class="line">    //可执行的sql，不包含参数</span><br><span class="line">    cacheKey.update(boundSql.getSql());</span><br><span class="line">    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">    if (parameterMappings.size() &gt; 0 &amp;&amp; parameterObject != null) &#123;</span><br><span class="line">        TypeHandlerRegistry typeHandlerRegistry = ms.getConfiguration().getTypeHandlerRegistry();</span><br><span class="line">        if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">            //查询参数</span><br><span class="line">            cacheKey.update(parameterObject);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">            for (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">                String propertyName = parameterMapping.getProperty();</span><br><span class="line">                if (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">                    cacheKey.update(metaObject.getValue(propertyName));</span><br><span class="line">                &#125; else if (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                    cacheKey.update(boundSql.getAdditionalParameter(propertyName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return cacheKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、接（三、2）BaseExecutor的query方法"><a href="#2、接（三、2）BaseExecutor的query方法" class="headerlink" title="2、接（三、2）BaseExecutor的query方法"></a>2、接（三、2）BaseExecutor的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, </span><br><span class="line">      BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing a query&quot;).object(ms.getId());</span><br><span class="line">    if (closed) throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    if (queryStack == 0 &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">        clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    try &#123;</span><br><span class="line">        queryStack++;</span><br><span class="line">        //从缓存中取出数据</span><br><span class="line">        list = resultHandler == null ? (List&lt;E&gt;) localCache.getObject(key) : null;</span><br><span class="line">        if (list != null) &#123;</span><br><span class="line">            //如果缓存中有数据，处理过程的缓存</span><br><span class="line">            handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //如果缓存中没有数据，将sql执行生成结果，并加入localCache中</span><br><span class="line">            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    if (queryStack == 0) &#123;</span><br><span class="line">        for (DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">            deferredLoad.load();</span><br><span class="line">        &#125;</span><br><span class="line">        deferredLoads.clear(); // issue #601</span><br><span class="line">        if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">            //如果配置为STATEMENT时，将清除所有缓存。说明STATEMENT类型的查询只有queryFromDatabase方法中有效。</span><br><span class="line">            clearLocalCache(); // issue #482</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一级缓存的生命周期与SqlSession的生命周期一样。一级缓存是BaseExecutor中管理的，为PerpetualCache对象，对象有一个Map对象管理缓存数据。<br>一级缓存配置示例如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;setting name=&quot;localCacheScope&quot; value=&quot;SESSION|STATEMENT&quot;/&gt;</span><br></pre></td></tr></table></figure></p><h4 id="3、BaseExecutor的queryFromDatabase方法"><a href="#3、BaseExecutor的queryFromDatabase方法" class="headerlink" title="3、BaseExecutor的queryFromDatabase方法"></a>3、BaseExecutor的queryFromDatabase方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private &lt;E&gt; List&lt;E&gt; queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, </span><br><span class="line">      CacheKey key, BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">    try &#123;</span><br><span class="line">        //执行sql返回数据</span><br><span class="line">        list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        localCache.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">    //将缓存加入到localCache中 </span><br><span class="line">    localCache.putObject(key, list);</span><br><span class="line">    if (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">        localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="五、获取数据库连接过程"><a href="#五、获取数据库连接过程" class="headerlink" title="五、获取数据库连接过程"></a>五、获取数据库连接过程</h3><h4 id="1、SimpleExecutor的doQuery方法"><a href="#1、SimpleExecutor的doQuery方法" class="headerlink" title="1、SimpleExecutor的doQuery方法"></a>1、SimpleExecutor的doQuery方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql </span><br><span class="line">      boundSql) throws SQLException &#123;</span><br><span class="line">    Statement stmt = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        //生成一个StatementHandler</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">        //执行之前的准备</span><br><span class="line">        stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        //执行sql </span><br><span class="line">        return handler.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、SimpleExecutor的prepareStatement方法"><a href="#2、SimpleExecutor的prepareStatement方法" class="headerlink" title="2、SimpleExecutor的prepareStatement方法"></a>2、SimpleExecutor的prepareStatement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException &#123;</span><br><span class="line">    Statement stmt;</span><br><span class="line">    //获取一个连接</span><br><span class="line">    Connection connection = getConnection(statementLog);</span><br><span class="line">    //获取一个statement</span><br><span class="line">    stmt = handler.prepare(connection);</span><br><span class="line">    //设置执行参数</span><br><span class="line">    handler.parameterize(stmt);</span><br><span class="line">    return stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、SimpleExecutor的getConnection方法"><a href="#3、SimpleExecutor的getConnection方法" class="headerlink" title="3、SimpleExecutor的getConnection方法"></a>3、SimpleExecutor的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected Connection getConnection(Log statementLog) throws SQLException &#123;</span><br><span class="line">    //获取连接</span><br><span class="line">    Connection connection = transaction.getConnection();</span><br><span class="line">    if (statementLog.isDebugEnabled()) &#123;</span><br><span class="line">        return ConnectionLogger.newInstance(connection, statementLog);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、JdbcTransaction的getConnection方法"><a href="#4、JdbcTransaction的getConnection方法" class="headerlink" title="4、JdbcTransaction的getConnection方法"></a>4、JdbcTransaction的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection() throws SQLException &#123;</span><br><span class="line">    if (connection == null) &#123;</span><br><span class="line">        //获取连接</span><br><span class="line">        openConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected void openConnection() throws SQLException &#123;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Opening JDBC Connection&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //从数据源中获取连接</span><br><span class="line">    connection = dataSource.getConnection();</span><br><span class="line">    if (level != null) &#123;</span><br><span class="line">        //设置事务级别</span><br><span class="line">        connection.setTransactionIsolation(level.getLevel());</span><br><span class="line">    &#125;</span><br><span class="line">    setDesiredAutoCommit(autoCommmit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、PooledDataSource的getConnection方法"><a href="#5、PooledDataSource的getConnection方法" class="headerlink" title="5、PooledDataSource的getConnection方法"></a>5、PooledDataSource的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection() throws SQLException &#123;</span><br><span class="line">    return popConnection(dataSource.getUsername(), dataSource.getPassword()).getProxyConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">private PooledConnection popConnection(String username, String password) throws SQLException &#123;</span><br><span class="line">    boolean countedWait = false;</span><br><span class="line">    //封装后的连接</span><br><span class="line">    PooledConnection conn = null;</span><br><span class="line">    long t = System.currentTimeMillis();</span><br><span class="line">    //无效连接个数</span><br><span class="line">    int localBadConnectionCount = 0;</span><br><span class="line">    while (conn == null) &#123;</span><br><span class="line">        synchronized (state) &#123;</span><br><span class="line">            if (state.idleConnections.size() &gt; 0) &#123;</span><br><span class="line">                //连接池有空闲的连接</span><br><span class="line">                //获取该连接</span><br><span class="line">                conn = state.idleConnections.remove(0);</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(&quot;Checked out connection &quot; + conn.getRealHashCode() + &quot; from pool.&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //连接池没有空闲连接，</span><br><span class="line">                if (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;</span><br><span class="line">                    //正在使用的连接数量小于最大数量</span><br><span class="line">                    //创建一个连接，实际连接是UnpooledDataSource的getConnection方法获取的</span><br><span class="line">                    conn = new PooledConnection(dataSource.getConnection(), this);</span><br><span class="line">                    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">                    //used in logging, if enabled</span><br><span class="line">                    Connection realConn = conn.getRealConnection();</span><br><span class="line">                    if (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(&quot;Created connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //正在使用的连接数量大于等于最大数量</span><br><span class="line">                    // Cannot create new connection</span><br><span class="line">                    PooledConnection oldestActiveConnection = state.activeConnections.get(0);</span><br><span class="line">                    //获取连接闲置时间</span><br><span class="line">                    long longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</span><br><span class="line">                    if (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;</span><br><span class="line">                        //连接闲置时间大于最大时间20秒</span><br><span class="line">                        //收回过期连接数加一</span><br><span class="line">                        state.claimedOverdueConnectionCount++;</span><br><span class="line">                        //连接闲置总时间</span><br><span class="line">                        state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</span><br><span class="line">                        state.accumulatedCheckoutTime += longestCheckoutTime;</span><br><span class="line">                        //回收该连接</span><br><span class="line">                        state.activeConnections.remove(oldestActiveConnection);</span><br><span class="line">                        //回滚该链接未提交事务</span><br><span class="line">                        if (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">                            oldestActiveConnection.getRealConnection().rollback();</span><br><span class="line">                        &#125;</span><br><span class="line">                        //重新封装一个连接</span><br><span class="line">                        conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this);</span><br><span class="line">                        //旧连接失效</span><br><span class="line">                        oldestActiveConnection.invalidate();</span><br><span class="line">                        if (log.isDebugEnabled()) &#123;</span><br><span class="line">                            log.debug(&quot;Claimed overdue connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // 连接闲置时间小于最大时间20秒</span><br><span class="line">                        // 无连接可用，必须等待</span><br><span class="line">                        try &#123;</span><br><span class="line">                            //等待次数加一</span><br><span class="line">                            if (!countedWait) &#123;</span><br><span class="line">                                state.hadToWaitCount++;</span><br><span class="line">                                countedWait = true;</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (log.isDebugEnabled()) &#123;</span><br><span class="line">                                log.debug(&quot;Waiting as long as &quot; + poolTimeToWait + &quot; milliseconds for connection.&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            long wt = System.currentTimeMillis();</span><br><span class="line">                            //等待最多20秒</span><br><span class="line">                            state.wait(poolTimeToWait);</span><br><span class="line">                            //等待总时间</span><br><span class="line">                            state.accumulatedWaitTime += System.currentTimeMillis() - wt;</span><br><span class="line">                        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (conn != null) &#123;</span><br><span class="line">                if (conn.isValid()) &#123;</span><br><span class="line">                    //连接有效</span><br><span class="line">                    //回滚未提交事务</span><br><span class="line">                    if (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">                        conn.getRealConnection().rollback();</span><br><span class="line">                    &#125;</span><br><span class="line">                    conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));</span><br><span class="line">                    //跟新连接的最后使用时间</span><br><span class="line">                    conn.setCheckoutTimestamp(System.currentTimeMillis());</span><br><span class="line">                    conn.setLastUsedTimestamp(System.currentTimeMillis());</span><br><span class="line">                    //连接加入正在使用集合</span><br><span class="line">                    state.activeConnections.add(conn);</span><br><span class="line">                    //请求次数加一</span><br><span class="line">                    state.requestCount++;</span><br><span class="line">                    //累计请求时间</span><br><span class="line">                    state.accumulatedRequestTime += System.currentTimeMillis() - t;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //连接无效</span><br><span class="line">                    if (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(&quot;A bad connection (&quot; + conn.getRealHashCode() + &quot;) was returned from the pool, getting another </span><br><span class="line">                              connection.&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //无效链接个数</span><br><span class="line">                    state.badConnectionCount++;</span><br><span class="line">                    localBadConnectionCount++;</span><br><span class="line">                    conn = null;</span><br><span class="line">                    //无效连接超过一定数量，抛出异常</span><br><span class="line">                    if (localBadConnectionCount &gt; (poolMaximumIdleConnections + 3)) &#123;</span><br><span class="line">                        if (log.isDebugEnabled()) &#123;</span><br><span class="line">                            log.debug(&quot;PooledDataSource: Could not get a good connection to the database.&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        throw new SQLException(&quot;PooledDataSource: Could not get a good connection to the database.&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (conn == null) &#123;</span><br><span class="line">        if (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        throw new SQLException(&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、UnpooledDataSource的getConnection方法"><a href="#6、UnpooledDataSource的getConnection方法" class="headerlink" title="6、UnpooledDataSource的getConnection方法"></a>6、UnpooledDataSource的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection() throws SQLException &#123;</span><br><span class="line">    return doGetConnection(username, password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private Connection doGetConnection(String username, String password) throws SQLException &#123;</span><br><span class="line">    Properties props = new Properties();</span><br><span class="line">    if (driverProperties != null) &#123;</span><br><span class="line">        props.putAll(driverProperties);</span><br><span class="line">    &#125;</span><br><span class="line">    if (username != null) &#123;</span><br><span class="line">        props.setProperty(&quot;user&quot;, username);</span><br><span class="line">    &#125;</span><br><span class="line">    if (password != null) &#123;</span><br><span class="line">        props.setProperty(&quot;password&quot;, password);</span><br><span class="line">    &#125;</span><br><span class="line">    return doGetConnection(props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private Connection doGetConnection(Properties properties) throws SQLException &#123;</span><br><span class="line">    //初始化数据库驱动</span><br><span class="line">    initializeDriver();</span><br><span class="line">    //获取实际的数据库连接</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, properties);</span><br><span class="line">    //配置是否自动提交，以及隔离级别</span><br><span class="line">    configureConnection(connection);</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="六、sql执行预处理过程"><a href="#六、sql执行预处理过程" class="headerlink" title="六、sql执行预处理过程"></a>六、sql执行预处理过程</h3><h4 id="1、接（五、2）RoutingStatementHandler的prepare方法"><a href="#1、接（五、2）RoutingStatementHandler的prepare方法" class="headerlink" title="1、接（五、2）RoutingStatementHandler的prepare方法"></a>1、接（五、2）RoutingStatementHandler的prepare方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Statement prepare(Connection connection) throws SQLException &#123;</span><br><span class="line">    //调的是PreparedStatementHandler的prepare方法</span><br><span class="line">    return delegate.prepare(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、实例化的PreparedStatementHandler"><a href="#2、实例化的PreparedStatementHandler" class="headerlink" title="2、实例化的PreparedStatementHandler"></a>2、实例化的PreparedStatementHandler</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public PreparedStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler </span><br><span class="line">      resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    super(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  protected BaseStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler </span><br><span class="line">        resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">      this.configuration = mappedStatement.getConfiguration();</span><br><span class="line">      this.executor = executor;</span><br><span class="line">      this.mappedStatement = mappedStatement;</span><br><span class="line">      this.rowBounds = rowBounds;</span><br><span class="line"></span><br><span class="line">      this.typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">      this.objectFactory = configuration.getObjectFactory();</span><br><span class="line"></span><br><span class="line">      if (boundSql == null) &#123; // issue #435, get the key before calculating the statement</span><br><span class="line">          //生成主键，没有则是NoKeyGenerator</span><br><span class="line">          generateKeys(parameterObject);</span><br><span class="line">          boundSql = mappedStatement.getBoundSql(parameterObject);</span><br><span class="line">      &#125;</span><br><span class="line">      this.boundSql = boundSql;</span><br><span class="line"></span><br><span class="line">      //创建参数处理器DefaultParameterHandler</span><br><span class="line">      this.parameterHandler = configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class="line">      //创建查询结果处理器DefaultResultSetHandler</span><br><span class="line">      this.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, rowBounds, parameterHandler, resultHandler, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、接（六、1）BaseStatementHandler的prepare方法"><a href="#3、接（六、1）BaseStatementHandler的prepare方法" class="headerlink" title="3、接（六、1）BaseStatementHandler的prepare方法"></a>3、接（六、1）BaseStatementHandler的prepare方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public Statement prepare(Connection connection) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().sql(boundSql.getSql());</span><br><span class="line">    Statement statement = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        //预处理</span><br><span class="line">        statement = instantiateStatement(connection);</span><br><span class="line">        //设置超时时间</span><br><span class="line">        setStatementTimeout(statement);</span><br><span class="line">        //设置查询条数</span><br><span class="line">        setFetchSize(statement);</span><br><span class="line">        return statement;</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">        closeStatement(statement);</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        closeStatement(statement);</span><br><span class="line">        throw new ExecutorException(&quot;Error preparing statement.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、PreparedStatementHandler的instantiateStatement方法"><a href="#4、PreparedStatementHandler的instantiateStatement方法" class="headerlink" title="4、PreparedStatementHandler的instantiateStatement方法"></a>4、PreparedStatementHandler的instantiateStatement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected Statement instantiateStatement(Connection connection) throws SQLException &#123;</span><br><span class="line">    String sql = boundSql.getSql();</span><br><span class="line">    //key生成器为Jdbc3KeyGenerator</span><br><span class="line">    if (mappedStatement.getKeyGenerator() instanceof Jdbc3KeyGenerator) &#123;</span><br><span class="line">        //生成的key对应的属性名</span><br><span class="line">        String[] keyColumnNames = mappedStatement.getKeyColumns();</span><br><span class="line">        if (keyColumnNames == null) &#123;</span><br><span class="line">            //执行预编译</span><br><span class="line">            return connection.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //执行预编译</span><br><span class="line">            return connection.prepareStatement(sql, keyColumnNames);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (mappedStatement.getResultSetType() != null) &#123;</span><br><span class="line">        return connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return connection.prepareStatement(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、接（五、2）RoutingStatementHandler的parameterize方法"><a href="#5、接（五、2）RoutingStatementHandler的parameterize方法" class="headerlink" title="5、接（五、2）RoutingStatementHandler的parameterize方法"></a>5、接（五、2）RoutingStatementHandler的parameterize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void parameterize(Statement statement) throws SQLException &#123;</span><br><span class="line">    delegate.parameterize(statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、PreparedStatementHandler的parameterize方法"><a href="#6、PreparedStatementHandler的parameterize方法" class="headerlink" title="6、PreparedStatementHandler的parameterize方法"></a>6、PreparedStatementHandler的parameterize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void parameterize(Statement statement) throws SQLException &#123;</span><br><span class="line">    parameterHandler.setParameters((PreparedStatement) statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、DefaultParameterHandler的setParameters"><a href="#7、DefaultParameterHandler的setParameters" class="headerlink" title="7、DefaultParameterHandler的setParameters"></a>7、DefaultParameterHandler的setParameters</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public void setParameters(PreparedStatement ps) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;setting parameters&quot;).object(mappedStatement.getParameterMap().getId());</span><br><span class="line">    //参数集合</span><br><span class="line">    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">    if (parameterMappings != null) &#123;</span><br><span class="line">        MetaObject metaObject = parameterObject == null ? null : configuration.newMetaObject(parameterObject);</span><br><span class="line">        for (int i = 0; i &lt; parameterMappings.size(); i++) &#123;</span><br><span class="line">            ParameterMapping parameterMapping = parameterMappings.get(i);</span><br><span class="line">            if (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">                Object value;</span><br><span class="line">                //参数属性名</span><br><span class="line">                String propertyName = parameterMapping.getProperty();</span><br><span class="line">                if (boundSql.hasAdditionalParameter(propertyName)) &#123; // issue #448 ask first for additional params</span><br><span class="line">                    value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                &#125; else if (parameterObject == null) &#123;</span><br><span class="line">                    value = null;</span><br><span class="line">                &#125; else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">                    //参数值</span><br><span class="line">                    value = parameterObject;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    value = metaObject == null ? null : metaObject.getValue(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line">                TypeHandler typeHandler = parameterMapping.getTypeHandler();</span><br><span class="line">                JdbcType jdbcType = parameterMapping.getJdbcType();</span><br><span class="line">                if (value == null &amp;&amp; jdbcType == null) jdbcType = configuration.getJdbcTypeForNull();</span><br><span class="line">                //往ps中设置参数</span><br><span class="line">                typeHandler.setParameter(ps, i + 1, value, jdbcType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="七、查询结果集映射"><a href="#七、查询结果集映射" class="headerlink" title="七、查询结果集映射"></a>七、查询结果集映射</h3><h4 id="1、接（五、1）RoutingStatementHandler的query方法"><a href="#1、接（五、1）RoutingStatementHandler的query方法" class="headerlink" title="1、接（五、1）RoutingStatementHandler的query方法"></a>1、接（五、1）RoutingStatementHandler的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    return delegate.&lt;E&gt;query(statement, resultHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2、PreparedStatementHandler的query方法"><a href="#2、PreparedStatementHandler的query方法" class="headerlink" title="2、PreparedStatementHandler的query方法"></a>2、PreparedStatementHandler的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    return resultSetHandler.&lt;E&gt; handleResultSets(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、DefaultResultSetHandler的handleResultSets方法"><a href="#3、DefaultResultSetHandler的handleResultSets方法" class="headerlink" title="3、DefaultResultSetHandler的handleResultSets方法"></a>3、DefaultResultSetHandler的handleResultSets方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException &#123;</span><br><span class="line">    final List&lt;Object&gt; multipleResults = new ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">    int resultSetCount = 0;</span><br><span class="line">    //获取第一个ResultSet,通常只会有一个</span><br><span class="line">    ResultSetWrapper rsw = getFirstResultSet(stmt);</span><br><span class="line">    //从配置中读取对应的ResultMap，通常也只会有一个</span><br><span class="line">    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();</span><br><span class="line"></span><br><span class="line">    int resultMapCount = resultMaps.size();</span><br><span class="line">    validateResultMapsCount(rsw, resultMapCount);</span><br><span class="line">    while (rsw != null &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</span><br><span class="line">        //依次获取resultMap</span><br><span class="line">        ResultMap resultMap = resultMaps.get(resultSetCount);</span><br><span class="line">        //完成映射，将结果加到入multipleResults中</span><br><span class="line">        handleResultSet(rsw, resultMap, multipleResults, null);</span><br><span class="line">        //获取下一个ResultSet</span><br><span class="line">        rsw = getNextResultSet(stmt);</span><br><span class="line">        cleanUpAfterHandlingResultSet();</span><br><span class="line">        //下一个ResultSet</span><br><span class="line">        resultSetCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    while (rsw != null &amp;&amp; resultSetCount &lt; mappedStatement.getResulSets().length) &#123;</span><br><span class="line">            ResultMapping parentMapping = nextResultMaps.get(mappedStatement.getResulSets()[resultSetCount]);</span><br><span class="line">            if (parentMapping != null) &#123;</span><br><span class="line">                String nestedResultMapId = parentMapping.getNestedResultMapId();</span><br><span class="line">                ResultMap resultMap = configuration.getResultMap(nestedResultMapId);</span><br><span class="line">                handleResultSet(rsw, resultMap, null, parentMapping);</span><br><span class="line">            &#125;</span><br><span class="line">            rsw = getNextResultSet(stmt);</span><br><span class="line">            cleanUpAfterHandlingResultSet();</span><br><span class="line">            resultSetCount++;</span><br><span class="line">        &#125;</span><br><span class="line">    //如果只有一个映射，返回第一个</span><br><span class="line">    return collapseSingleResultList(multipleResults);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>处理某一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private void handleResultSet(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Object&gt; multipleResults, ResultMapping parentMapping) </span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (parentMapping != null) &#123;</span><br><span class="line">            //子映射</span><br><span class="line">            handleRowValues(rsw, resultMap, null, RowBounds.DEFAULT, parentMapping);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //一般情况resultHandler都为空,见ResultHandler.NO_RESULT_HANDLER</span><br><span class="line">            if (resultHandler == null) &#123;</span><br><span class="line">                DefaultResultHandler defaultResultHandler = new DefaultResultHandler(objectFactory);</span><br><span class="line">                //生成对象，并加到defaultResultHandler.resultList集合中</span><br><span class="line">                handleRowValues(rsw, resultMap, defaultResultHandler, rowBounds, null);</span><br><span class="line">                //将结果加入multipleResults中</span><br><span class="line">                multipleResults.add(defaultResultHandler.getResultList());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                handleRowValues(rsw, resultMap, resultHandler, rowBounds, null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //关闭结果集</span><br><span class="line">        closeResultSet(rsw.getResultSet()); // issue #228 (close resultsets)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="4、DefaultResultSetHandler的handleRowValues方法"><a href="#4、DefaultResultSetHandler的handleRowValues方法" class="headerlink" title="4、DefaultResultSetHandler的handleRowValues方法"></a>4、DefaultResultSetHandler的handleRowValues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private void handleRowValues(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping </span><br><span class="line">      parentMapping) throws SQLException &#123;</span><br><span class="line">    if (resultMap.hasNestedResultMaps()) &#123;</span><br><span class="line">        //有子映射或内映射的情况</span><br><span class="line">        ensureNoRowBounds();</span><br><span class="line">        checkResultHandler();</span><br><span class="line">        handleRowValuesForNestedResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //没有子映射或内映射</span><br><span class="line">        handleRowValuesForSimpleResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法"><a href="#5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法" class="headerlink" title="5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法"></a>5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void handleRowValuesForSimpleResultMap(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds </span><br><span class="line">      rowBounds, ResultMapping parentMapping)throws SQLException &#123;</span><br><span class="line">    DefaultResultContext resultContext = new DefaultResultContext();</span><br><span class="line">    //跳过结果集前排行，直到查询开始位置，开始处理</span><br><span class="line">    skipRows(rsw.getResultSet(), rowBounds);</span><br><span class="line">    //依次处理待处理的行</span><br><span class="line">    while (shouldProcessMoreRows(rsw.getResultSet(), resultContext, rowBounds)) &#123;</span><br><span class="line">        //默认不处理返回resultMap</span><br><span class="line">        ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, null);</span><br><span class="line">        //真正从ResultSet中映射出一个对象  </span><br><span class="line">        Object rowValue = getRowValue(rsw, discriminatedResultMap, null);</span><br><span class="line">        storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、DefaultResultSetHandler的getRowValue方法"><a href="#6、DefaultResultSetHandler的getRowValue方法" class="headerlink" title="6、DefaultResultSetHandler的getRowValue方法"></a>6、DefaultResultSetHandler的getRowValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private Object getRowValue(ResultSetWrapper rsw, ResultMap resultMap, CacheKey rowKey) throws SQLException &#123;</span><br><span class="line">    final ResultLoaderMap lazyLoader = instantiateResultLoaderMap();</span><br><span class="line">    //实例化一个对象,类型为resultMap.getType(),最终调用了ObjectFactory.create()方法</span><br><span class="line">    Object resultObject = createResultObject(rsw, resultMap, lazyLoader, null);</span><br><span class="line">    if (resultObject != null &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;</span><br><span class="line">        //设置对象属性 </span><br><span class="line">        final MetaObject metaObject = configuration.newMetaObject(resultObject);</span><br><span class="line">        boolean foundValues = resultMap.getConstructorResultMappings().size() &gt; 0;</span><br><span class="line">        if (shouldApplyAutomaticMappings(resultMap, !AutoMappingBehavior.NONE.equals(configuration.getAutoMappingBehavior()))) &#123;  </span><br><span class="line">            //自动映射,结果集中有的column，但resultMap中并没有配置      </span><br><span class="line">            foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, null) || foundValues;</span><br><span class="line">        &#125;</span><br><span class="line">        //映射result节点</span><br><span class="line">        foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, null) || foundValues;</span><br><span class="line">        foundValues = (lazyLoader != null &amp;&amp; lazyLoader.size() &gt; 0) || foundValues;</span><br><span class="line">        resultObject = foundValues ? resultObject : null;</span><br><span class="line">        return resultObject;</span><br><span class="line">    &#125;</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="7、DefaultResultSetHandler的createResultObject方法"><a href="#7、DefaultResultSetHandler的createResultObject方法" class="headerlink" title="7、DefaultResultSetHandler的createResultObject方法"></a>7、DefaultResultSetHandler的createResultObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private Object createResultObject(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix) throws</span><br><span class="line">       SQLException &#123;</span><br><span class="line">    //构造方法中的参数类型  </span><br><span class="line">    final List&lt;Class&lt;?&gt;&gt; constructorArgTypes = new ArrayList&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">    //构造方法中具体值 </span><br><span class="line">    final List&lt;Object&gt; constructorArgs = new ArrayList&lt;Object&gt;();</span><br><span class="line">    //根据构造方法生成对象  </span><br><span class="line">    final Object resultObject = createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">    if (resultObject != null &amp;&amp; configuration.isLazyLoadingEnabled() &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;</span><br><span class="line">        final List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">        for (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">            //如果有子查询</span><br><span class="line">            if (propertyMapping.getNestedQueryId() != null) &#123; // issue #109 (avoid creating proxies for leaf objects)</span><br><span class="line">                //CglibProxyFactory给返回对象创建代理</span><br><span class="line">                return proxyFactory.createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private Object createResultObject(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    //结果集中配置的返回类</span><br><span class="line">    final Class&lt;?&gt; resultType = resultMap.getType();</span><br><span class="line">    //resultMap配置中的construnctor节点 </span><br><span class="line">    final List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();</span><br><span class="line">    if (typeHandlerRegistry.hasTypeHandler(resultType)) &#123;</span><br><span class="line">        return createPrimitiveResultObject(rsw, resultMap, columnPrefix);</span><br><span class="line">    &#125; else if (constructorMappings.size() &gt; 0) &#123;</span><br><span class="line">        //construnctor节点有配置 </span><br><span class="line">        return createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //construnctor节点没有配置，调用无参的构造方法  </span><br><span class="line">        return objectFactory.create(resultType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8、DefaultResultSetHandler的createPrimitiveResultObject方法"><a href="#8、DefaultResultSetHandler的createPrimitiveResultObject方法" class="headerlink" title="8、DefaultResultSetHandler的createPrimitiveResultObject方法"></a>8、DefaultResultSetHandler的createPrimitiveResultObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private Object createParameterizedResultObject(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; constructorMappings,</span><br><span class="line">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes,List&lt;Object&gt; constructorArgs, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    for (ResultMapping constructorMapping : constructorMappings) &#123;</span><br><span class="line">        final Class&lt;?&gt; parameterType = constructorMapping.getJavaType();</span><br><span class="line">        final String column = constructorMapping.getColumn();</span><br><span class="line">        final Object value;</span><br><span class="line">        //取出参数类型和具体的值</span><br><span class="line">        if (constructorMapping.getNestedQueryId() != null) &#123;</span><br><span class="line">            value = getNestedQueryConstructorValue(rsw.getResultSet(), constructorMapping, columnPrefix);</span><br><span class="line">        &#125; else if (constructorMapping.getNestedResultMapId() != null) &#123;</span><br><span class="line">            final ResultMap resultMap = configuration.getResultMap(constructorMapping.getNestedResultMapId());</span><br><span class="line">            final ResultLoaderMap lazyLoader = instantiateResultLoaderMap();</span><br><span class="line">            value = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            final TypeHandler&lt;?&gt; typeHandler = constructorMapping.getTypeHandler();</span><br><span class="line">            //从结果集中获取该属性对应的查询结果</span><br><span class="line">            value = typeHandler.getResult(rsw.getResultSet(), prependPrefix(column, columnPrefix));</span><br><span class="line">        &#125;</span><br><span class="line">        //构造器参数类型</span><br><span class="line">        constructorArgTypes.add(parameterType);</span><br><span class="line">        //构造器参数值</span><br><span class="line">        constructorArgs.add(value);</span><br><span class="line">        foundValues = value != null || foundValues;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建对象 </span><br><span class="line">    return foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="9、接（七、7）CglibProxyFactory的createProxy方法"><a href="#9、接（七、7）CglibProxyFactory的createProxy方法" class="headerlink" title="9、接（七、7）CglibProxyFactory的createProxy方法"></a>9、接（七、7）CglibProxyFactory的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object createProxy(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory,</span><br><span class="line">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123;</span><br><span class="line">    return EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10、EnhancedResultObjectProxyImpl的createProxy方法"><a href="#10、EnhancedResultObjectProxyImpl的createProxy方法" class="headerlink" title="10、EnhancedResultObjectProxyImpl的createProxy方法"></a>10、EnhancedResultObjectProxyImpl的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static Object createProxy(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, </span><br><span class="line">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123;</span><br><span class="line">    //被代理对象的类</span><br><span class="line">    final Class&lt;?&gt; type = target.getClass();</span><br><span class="line">    //创建回调</span><br><span class="line">    EnhancedResultObjectProxyImpl callback = new EnhancedResultObjectProxyImpl(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">    //创建代理对象</span><br><span class="line">    Object enhanced = crateProxy(type, callback, constructorArgTypes, constructorArgs);</span><br><span class="line">    //target是type的初始化对象  </span><br><span class="line">    //enhanced可能是type的代理对象  </span><br><span class="line">    //将target对象的值赋值到enhanced，包括父类的字段赋值</span><br><span class="line">    PropertyCopier.copyBeanProperties(type, target, enhanced);</span><br><span class="line">    //返回代理enhanced </span><br><span class="line">    return enhanced;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="11、CglibProxyFactory的createProxy方法"><a href="#11、CglibProxyFactory的createProxy方法" class="headerlink" title="11、CglibProxyFactory的createProxy方法"></a>11、CglibProxyFactory的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private static Object crateProxy(Class&lt;?&gt; type, Callback callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123;</span><br><span class="line">    Enhancer enhancer = new Enhancer();</span><br><span class="line">    //设置回调</span><br><span class="line">    enhancer.setCallback(callback);</span><br><span class="line">    //继承被代理的类</span><br><span class="line">    enhancer.setSuperclass(type);</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取目标类型的 writeReplace 方法，如果没有，异常中代理类设置enhancer.setInterfaces(new Class[]&#123;WriteReplaceInterface.class&#125;)</span><br><span class="line">        type.getDeclaredMethod(WRITE_REPLACE_METHOD);</span><br><span class="line">        // ObjectOutputStream will call writeReplace of objects returned by writeReplace</span><br><span class="line">        log.debug(WRITE_REPLACE_METHOD + &quot; method was found on bean &quot; + type + &quot;, make sure it returns this&quot;);</span><br><span class="line">    &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">        enhancer.setInterfaces(new Class[]&#123;WriteReplaceInterface.class&#125;);</span><br><span class="line">    &#125; catch (SecurityException e) &#123;</span><br><span class="line">        // nothing to do here</span><br><span class="line">    &#125;</span><br><span class="line">    Object enhanced = null;</span><br><span class="line">    if (constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">        //如果构造函数没有参数，创建代理对象</span><br><span class="line">        enhanced = enhancer.create();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //否则，初始化带有参数的构造函数</span><br><span class="line">        Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(new Class[constructorArgTypes.size()]);</span><br><span class="line">        Object[] valuesArray = constructorArgs.toArray(new Object[constructorArgs.size()]);</span><br><span class="line">        //创建带有参数的代理对象</span><br><span class="line">        enhanced = enhancer.create(typesArray, valuesArray);</span><br><span class="line">    &#125;</span><br><span class="line">    return enhanced;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="12、BaseTypeHandler的getResult方法"><a href="#12、BaseTypeHandler的getResult方法" class="headerlink" title="12、BaseTypeHandler的getResult方法"></a>12、BaseTypeHandler的getResult方法</h4><p>typeHandler以StringTypeHandler为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public T getResult(ResultSet rs, String columnName) throws SQLException &#123;</span><br><span class="line">    T result = getNullableResult(rs, columnName);</span><br><span class="line">    if (rs.wasNull()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="13、StringTypeHandler的getNullableResult方法"><a href="#13、StringTypeHandler的getNullableResult方法" class="headerlink" title="13、StringTypeHandler的getNullableResult方法"></a>13、StringTypeHandler的getNullableResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public String getNullableResult(ResultSet rs, String columnName) throws SQLException &#123;</span><br><span class="line">    //获取该字段对应的值</span><br><span class="line">    return rs.getString(columnName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法"><a href="#14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法" class="headerlink" title="14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法"></a>14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private boolean applyAutomaticMappings(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String columnPrefix) </span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    //获取结果集中在resultMap中没有配置的列名  </span><br><span class="line">    //如果resultMap中只设置了resultType=&quot;java.util.HashMap&quot;的话，全都会在这里完成映射 </span><br><span class="line">    final List&lt;String&gt; unmappedColumnNames = rsw.getUnmappedColumnNames(resultMap, columnPrefix);</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    for (String columnName : unmappedColumnNames) &#123;</span><br><span class="line">        //属性名就是列名</span><br><span class="line">        String propertyName = columnName;</span><br><span class="line">        if (columnPrefix != null &amp;&amp; columnPrefix.length() &gt; 0) &#123;</span><br><span class="line">            // When columnPrefix is specified,</span><br><span class="line">            // ignore columns without the prefix.</span><br><span class="line">            if (columnName.startsWith(columnPrefix)) &#123;</span><br><span class="line">                propertyName = columnName.substring(columnPrefix.length());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //是否有对应的属性</span><br><span class="line">        final String property = metaObject.findProperty(propertyName, configuration.isMapUnderscoreToCamelCase());</span><br><span class="line">        if (property != null &amp;&amp; metaObject.hasSetter(property)) &#123;</span><br><span class="line">            final Class&lt;?&gt; propertyType = metaObject.getSetterType(property);</span><br><span class="line">            if (typeHandlerRegistry.hasTypeHandler(propertyType)) &#123;</span><br><span class="line">                final TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(propertyType, columnName);</span><br><span class="line">                //获取该字段对应的值</span><br><span class="line">                final Object value = typeHandler.getResult(rsw.getResultSet(), columnName);</span><br><span class="line">                if (value != null || configuration.isCallSettersOnNulls()) &#123; // issue #377, call setter on nulls</span><br><span class="line">                    if (value != null || !propertyType.isPrimitive()) &#123;</span><br><span class="line">                        //直接设置</span><br><span class="line">                        metaObject.setValue(property, value);</span><br><span class="line">                    &#125;</span><br><span class="line">                    foundValues = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foundValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法"><a href="#15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法" class="headerlink" title="15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法"></a>15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">private boolean applyPropertyMappings(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, ResultLoaderMap lazyLoader, </span><br><span class="line">      String columnPrefix) throws SQLException &#123;</span><br><span class="line">    //有resultMap中配置过的字段名</span><br><span class="line">    final List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    //获取需要映射的ResultMapping</span><br><span class="line">    final List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">    for (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">        final String column = prependPrefix(propertyMapping.getColumn(), columnPrefix);</span><br><span class="line">        if (propertyMapping.isCompositeResult() </span><br><span class="line">              || (column != null &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) </span><br><span class="line">              || propertyMapping.getResultSet() != null) &#123;</span><br><span class="line">            //在结果中的获取对应的值</span><br><span class="line">            Object value = getPropertyMappingValue(rsw.getResultSet(), metaObject, propertyMapping, lazyLoader, columnPrefix);</span><br><span class="line">            //获取属性名</span><br><span class="line">            final String property = propertyMapping.getProperty(); // issue #541 make property optional</span><br><span class="line">            if (value != NO_VALUE &amp;&amp; property != null &amp;&amp; (value != null || configuration.isCallSettersOnNulls())) &#123; </span><br><span class="line">                if (value != null || !metaObject.getSetterType(property).isPrimitive()) &#123;</span><br><span class="line">                    //设置属性值</span><br><span class="line">                    metaObject.setValue(property, value);</span><br><span class="line">                &#125;</span><br><span class="line">                foundValues = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foundValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="16、DefaultResultSetHandler的getPropertyMappingValue方法"><a href="#16、DefaultResultSetHandler的getPropertyMappingValue方法" class="headerlink" title="16、DefaultResultSetHandler的getPropertyMappingValue方法"></a>16、DefaultResultSetHandler的getPropertyMappingValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private Object getPropertyMappingValue(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping, </span><br><span class="line">          ResultLoaderMap lazyLoader, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    if (propertyMapping.getNestedQueryId() != null) &#123;</span><br><span class="line">        //子查询</span><br><span class="line">        return getNestedQueryMappingValue(rs, metaResultObject, propertyMapping, lazyLoader, columnPrefix);</span><br><span class="line">    &#125; else if (propertyMapping.getResultSet() != null) &#123;</span><br><span class="line">        addPendingChildRelation(rs, metaResultObject, propertyMapping);</span><br><span class="line">        return NO_VALUE;</span><br><span class="line">    &#125; else if (propertyMapping.getNestedResultMapId() != null) &#123;</span><br><span class="line">        // the user added a column attribute to a nested result map, ignore it</span><br><span class="line">        return NO_VALUE;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final TypeHandler&lt;?&gt; typeHandler = propertyMapping.getTypeHandler();</span><br><span class="line">        final String column = prependPrefix(propertyMapping.getColumn(), columnPrefix);</span><br><span class="line">        //直接从结果集里获取值</span><br><span class="line">        return typeHandler.getResult(rs, column);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="17、DefaultResultSetHandler的getNestedQueryMappingValue方法"><a href="#17、DefaultResultSetHandler的getNestedQueryMappingValue方法" class="headerlink" title="17、DefaultResultSetHandler的getNestedQueryMappingValue方法"></a>17、DefaultResultSetHandler的getNestedQueryMappingValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private Object getNestedQueryMappingValue(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping,</span><br><span class="line">      ResultLoaderMap lazyLoader, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    //获取子查询id</span><br><span class="line">    final String nestedQueryId = propertyMapping.getNestedQueryId();</span><br><span class="line">    //获取属性名</span><br><span class="line">    final String property = propertyMapping.getProperty();</span><br><span class="line">    //子查询sql</span><br><span class="line">    final MappedStatement nestedQuery = configuration.getMappedStatement(nestedQueryId);</span><br><span class="line">    final Class&lt;?&gt; nestedQueryParameterType = nestedQuery.getParameterMap().getType();</span><br><span class="line">    //预处理子查询参数，从查询结果中取出column对应的值作为参数</span><br><span class="line">    final Object nestedQueryParameterObject = prepareParameterForNestedQuery(rs, propertyMapping, nestedQueryParameterType, columnPrefix);</span><br><span class="line">    Object value = NO_VALUE;</span><br><span class="line">    if (nestedQueryParameterObject != null) &#123;</span><br><span class="line">        //获取BoundSql</span><br><span class="line">        final BoundSql nestedBoundSql = nestedQuery.getBoundSql(nestedQueryParameterObject);</span><br><span class="line">        //缓存key</span><br><span class="line">        final CacheKey key = executor.createCacheKey(nestedQuery, nestedQueryParameterObject, RowBounds.DEFAULT, nestedBoundSql);</span><br><span class="line">        //属性类型</span><br><span class="line">        final Class&lt;?&gt; targetType = propertyMapping.getJavaType();</span><br><span class="line">        //从二级缓存中获取缓存值</span><br><span class="line">        final List&lt;Object&gt; nestedQueryCacheObject = getNestedQueryCacheObject(nestedQuery, key);</span><br><span class="line">        if (nestedQueryCacheObject != null) &#123;</span><br><span class="line">            //从缓存中获取值</span><br><span class="line">            value = resultExtractor.extractObjectFromList(nestedQueryCacheObject, targetType);</span><br><span class="line">        &#125; else if (executor.isCached(nestedQuery, key)) &#123;</span><br><span class="line">            //一级缓存存在，从一级缓存中获取值</span><br><span class="line">            executor.deferLoad(nestedQuery, metaResultObject, property, key, targetType);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            final ResultLoader resultLoader = new ResultLoader(configuration, executor, nestedQuery, nestedQueryParameterObject, targetType, key, nestedBoundSql);</span><br><span class="line">            if (configuration.isLazyLoadingEnabled()) &#123;</span><br><span class="line">                //开启懒加载，创建一个LoadPair对象加入loaderMap中，key为属性名</span><br><span class="line">                lazyLoader.addLoader(property, metaResultObject, resultLoader);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //未开启懒加载，立即执行子查询</span><br><span class="line">                value = resultLoader.loadResult();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="18、接（七、5）DefaultResultSetHandler的storeObject方法"><a href="#18、接（七、5）DefaultResultSetHandler的storeObject方法" class="headerlink" title="18、接（七、5）DefaultResultSetHandler的storeObject方法"></a>18、接（七、5）DefaultResultSetHandler的storeObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void storeObject(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue, ResultMapping parentMapping, </span><br><span class="line">    ResultSet rs) throws SQLException &#123;</span><br><span class="line">    if (parentMapping != null) &#123;</span><br><span class="line">        linkToParent(rs, parentMapping, rowValue);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //将查询出的对象加入返回集合</span><br><span class="line">        callResultHandler(resultHandler, resultContext, rowValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="19、DefaultResultHandler的callResultHandler方法"><a href="#19、DefaultResultHandler的callResultHandler方法" class="headerlink" title="19、DefaultResultHandler的callResultHandler方法"></a>19、DefaultResultHandler的callResultHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void callResultHandler(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue) &#123;</span><br><span class="line">    //rowValue加入DefaultResultContext中</span><br><span class="line">    resultContext.nextResultObject(rowValue);</span><br><span class="line">    //DefaultResultHandler把rowValue加入DefaultResultHandler的List集合</span><br><span class="line">    resultHandler.handleResult(resultContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法"><a href="#20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法" class="headerlink" title="20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法"></a>20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法</h4><p>处理有内部映射的复杂映射<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void handleRowValuesForNestedResultMap(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler,</span><br><span class="line">      RowBounds rowBounds, ResultMapping parentMapping) throws SQLException &#123;</span><br><span class="line">    final DefaultResultContext resultContext = new DefaultResultContext();</span><br><span class="line">    skipRows(rsw.getResultSet(), rowBounds);</span><br><span class="line">    Object rowValue = null;</span><br><span class="line">    while (shouldProcessMoreRows(rsw.getResultSet(), resultContext, rowBounds)) &#123;</span><br><span class="line">        final ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, null);</span><br><span class="line">        //为这行记录生成一个key,createRowKey方法会利用idResultMapping(即idArg,和id节点)和resultMap的id来生成key</span><br><span class="line">        final CacheKey rowKey = createRowKey(discriminatedResultMap, rsw, null);</span><br><span class="line">        //nestedResultObjects是一个HashMap对象，在映射过程中所有生成的映射对象(包括内映射对象)，都会生成一个key并保存在这里</span><br><span class="line">        Object partialObject = nestedResultObjects.get(rowKey);</span><br><span class="line">        if (mappedStatement.isResultOrdered()) &#123; // issue #577 &amp;&amp; #542</span><br><span class="line">            if (partialObject == null &amp;&amp; rowValue != null) &#123;</span><br><span class="line">                nestedResultObjects.clear();</span><br><span class="line">                storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">            &#125;</span><br><span class="line">            rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, null, partialObject);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //这个方法把结果集的记录映射成java对象</span><br><span class="line">            rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, null, partialObject);</span><br><span class="line">            if (partialObject == null) &#123;</span><br><span class="line">                storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (rowValue != null &amp;&amp; mappedStatement.isResultOrdered()) &#123;</span><br><span class="line">      storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="21、DefaultResultSetHandler的createRowKey方法"><a href="#21、DefaultResultSetHandler的createRowKey方法" class="headerlink" title="21、DefaultResultSetHandler的createRowKey方法"></a>21、DefaultResultSetHandler的createRowKey方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private CacheKey createRowKey(ResultMap resultMap, ResultSetWrapper rsw, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    final CacheKey cacheKey = new CacheKey();</span><br><span class="line">    //加入resultmap的id</span><br><span class="line">    cacheKey.update(resultMap.getId());</span><br><span class="line">    //有id则获取id映射，没有则获取所有映射</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = getResultMappingsForRowKey(resultMap);</span><br><span class="line">    if (resultMappings.size() == 0) &#123;</span><br><span class="line">        if (Map.class.isAssignableFrom(resultMap.getType())) &#123;</span><br><span class="line">            createRowKeyForMap(rsw, cacheKey);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            createRowKeyForUnmappedProperties(resultMap, rsw, cacheKey, columnPrefix);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //将resultMappings的字段名和值，依次放入cacheKey</span><br><span class="line">        createRowKeyForMappedProperties(resultMap, rsw, cacheKey, resultMappings, columnPrefix);</span><br><span class="line">    &#125;</span><br><span class="line">    return cacheKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="22、DefaultResultSetHandler的createRowKeyForMappedProperties方法"><a href="#22、DefaultResultSetHandler的createRowKeyForMappedProperties方法" class="headerlink" title="22、DefaultResultSetHandler的createRowKeyForMappedProperties方法"></a>22、DefaultResultSetHandler的createRowKeyForMappedProperties方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void createRowKeyForMappedProperties(ResultMap resultMap, ResultSetWrapper rsw, CacheKey cacheKey, </span><br><span class="line">      List&lt;ResultMapping&gt; resultMappings, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    for (ResultMapping resultMapping : resultMappings) &#123;</span><br><span class="line">        if (resultMapping.getNestedResultMapId() != null &amp;&amp; resultMapping.getResultSet() == null) &#123; // Issue #392</span><br><span class="line">            //该映射是一个内映射</span><br><span class="line">            final ResultMap nestedResultMap = configuration.getResultMap(resultMapping.getNestedResultMapId());</span><br><span class="line">            //递归调用本方法处理内映射</span><br><span class="line">            createRowKeyForMappedProperties(nestedResultMap, rsw, cacheKey, nestedResultMap.getConstructorResultMappings(),</span><br><span class="line">            prependPrefix(resultMapping.getColumnPrefix(), columnPrefix));</span><br><span class="line">        &#125; else if (resultMapping.getNestedQueryId() == null) &#123;</span><br><span class="line">            //该映射为属性映射</span><br><span class="line">            final String column = prependPrefix(resultMapping.getColumn(), columnPrefix);</span><br><span class="line">            final TypeHandler&lt;?&gt; th = resultMapping.getTypeHandler();</span><br><span class="line">            List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);</span><br><span class="line">            if (column != null &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) &#123; // Issue #114</span><br><span class="line">                //获取该字段对应的值</span><br><span class="line">                final Object value = th.getResult(rsw.getResultSet(), column);</span><br><span class="line">                if (value != null) &#123;</span><br><span class="line">                    //将字段名和值，加载进cacheKey</span><br><span class="line">                    cacheKey.update(column);</span><br><span class="line">                    cacheKey.update(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="23、接（七、20）DefaultResultSetHandler的getRowValue方法"><a href="#23、接（七、20）DefaultResultSetHandler的getRowValue方法" class="headerlink" title="23、接（七、20）DefaultResultSetHandler的getRowValue方法"></a>23、接（七、20）DefaultResultSetHandler的getRowValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private Object getRowValue(ResultSetWrapper rsw, ResultMap resultMap, CacheKey combinedKey, CacheKey absoluteKey, String columnPrefix, </span><br><span class="line">      Object partialObject) throws SQLException &#123;</span><br><span class="line">    Object resultObject = partialObject;</span><br><span class="line">    if (resultObject != null) &#123;</span><br><span class="line">        //缓存中获取的对象不为空</span><br><span class="line">        final MetaObject metaObject = configuration.newMetaObject(resultObject);</span><br><span class="line">        ancestorObjects.put(absoluteKey, resultObject);</span><br><span class="line">        //处理内映射</span><br><span class="line">        applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, false);</span><br><span class="line">        ancestorObjects.remove(absoluteKey);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //缓存中获取的对象为空</span><br><span class="line">        //懒加载模式则返回ResultLoaderMap对象，否则返回null</span><br><span class="line">        final ResultLoaderMap lazyLoader = instantiateResultLoaderMap();</span><br><span class="line">        //创建返回的对象与（七、7）相同</span><br><span class="line">        resultObject = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">        if (resultObject != null &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;</span><br><span class="line">            final MetaObject metaObject = configuration.newMetaObject(resultObject);</span><br><span class="line">            boolean foundValues = resultMap.getConstructorResultMappings().size() &gt; 0;</span><br><span class="line">            if (shouldApplyAutomaticMappings(resultMap, AutoMappingBehavior.FULL.equals(configuration.getAutoMappingBehavior()))) &#123;</span><br><span class="line">                //自动映射，跟简单映射的处理方式一样,跟简单映射的处理方式一样</span><br><span class="line">                foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;</span><br><span class="line">            &#125;</span><br><span class="line">            //映射reulstMap节点，跟简单映射的处理方式一样,跟简单映射的处理方式一样        </span><br><span class="line">            foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;</span><br><span class="line">            ancestorObjects.put(absoluteKey, resultObject);</span><br><span class="line">            //处理内映射</span><br><span class="line">            foundValues = applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, true) || foundValues;</span><br><span class="line">            ancestorObjects.remove(absoluteKey);</span><br><span class="line">            //取到对象的值，或者懒加载开启，都返回true</span><br><span class="line">            foundValues = (lazyLoader != null &amp;&amp; lazyLoader.size() &gt; 0) || foundValues;</span><br><span class="line">            resultObject = foundValues ? resultObject : null;</span><br><span class="line">        &#125;</span><br><span class="line">        //对象加入缓存</span><br><span class="line">        if (combinedKey != CacheKey.NULL_CACHE_KEY) nestedResultObjects.put(combinedKey, resultObject);</span><br><span class="line">    &#125;</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="24、DefaultResultSetHandler的applyNestedResultMappings方法"><a href="#24、DefaultResultSetHandler的applyNestedResultMappings方法" class="headerlink" title="24、DefaultResultSetHandler的applyNestedResultMappings方法"></a>24、DefaultResultSetHandler的applyNestedResultMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">private boolean applyNestedResultMappings(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String parentPrefix, </span><br><span class="line">      CacheKey parentRowKey, boolean newObject) &#123;</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    for (ResultMapping resultMapping : resultMap.getPropertyResultMappings()) &#123;</span><br><span class="line">        //获取子ResultMapId</span><br><span class="line">        final String nestedResultMapId = resultMapping.getNestedResultMapId();</span><br><span class="line">        if (nestedResultMapId != null &amp;&amp; resultMapping.getResultSet() == null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                final String columnPrefix = getColumnPrefix(parentPrefix, resultMapping);</span><br><span class="line">                //获取子ResultMap</span><br><span class="line">                final ResultMap nestedResultMap = getNestedResultMap(rsw.getResultSet(), nestedResultMapId, columnPrefix);</span><br><span class="line">                //创建缓存key</span><br><span class="line">                final CacheKey rowKey = createRowKey(nestedResultMap, rsw, columnPrefix);</span><br><span class="line">                //获取该对象的缓存</span><br><span class="line">                final Object ancestorObject = ancestorObjects.get(rowKey);</span><br><span class="line">                if (ancestorObject != null) &#123; </span><br><span class="line">                    //存在,则直接放入上级对象，解决循环依赖</span><br><span class="line">                    if (newObject) metaObject.setValue(resultMapping.getProperty(), ancestorObject);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //不存在</span><br><span class="line">                    //将上级对象的key与本对象key结合，作为本对象的新的key</span><br><span class="line">                    final CacheKey combinedKey = combineKeys(rowKey, parentRowKey);</span><br><span class="line">                    //再次从缓存中获取该对象            </span><br><span class="line">                    Object rowValue = nestedResultObjects.get(combinedKey);</span><br><span class="line">                    boolean knownValue = (rowValue != null);</span><br><span class="line">                    //实例化集合属性，并加入到上级对象中</span><br><span class="line">                    final Object collectionProperty = instantiateCollectionPropertyIfAppropriate(resultMapping, metaObject);</span><br><span class="line">                    //检查是否所有非空字段均有值            </span><br><span class="line">                    if (anyNotNullColumnHasValue(resultMapping, columnPrefix, rsw.getResultSet())) &#123;</span><br><span class="line">                        //生成对象</span><br><span class="line">                        rowValue = getRowValue(rsw, nestedResultMap, combinedKey, rowKey, columnPrefix, rowValue);</span><br><span class="line">                        if (rowValue != null &amp;&amp; !knownValue) &#123;</span><br><span class="line">                            if (collectionProperty != null) &#123;</span><br><span class="line">                                final MetaObject targetMetaObject = configuration.newMetaObject(collectionProperty);</span><br><span class="line">                                //对象放入刚刚创建的集合中</span><br><span class="line">                                targetMetaObject.add(rowValue);</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                //对象放入上级对象中</span><br><span class="line">                                metaObject.setValue(resultMapping.getProperty(), rowValue);</span><br><span class="line">                            &#125;</span><br><span class="line">                            foundValues = true;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (SQLException e) &#123;</span><br><span class="line">                throw new ExecutorException(&quot;Error getting nested result map values for &apos;&quot; + resultMapping.getProperty() + &quot;&apos;.  Cause: &quot; + e, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foundValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法"><a href="#25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法" class="headerlink" title="25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法"></a>25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private Object instantiateCollectionPropertyIfAppropriate(ResultMapping resultMapping, MetaObject metaObject) &#123;</span><br><span class="line">    //属性名</span><br><span class="line">    final String propertyName = resultMapping.getProperty();</span><br><span class="line">    //设置值</span><br><span class="line">    Object propertyValue = metaObject.getValue(propertyName);</span><br><span class="line">    if (propertyValue == null) &#123;</span><br><span class="line">        //如果为空，取出类型</span><br><span class="line">        Class&lt;?&gt; type = resultMapping.getJavaType();</span><br><span class="line">        if (type == null) &#123;</span><br><span class="line">            type = metaObject.getSetterType(propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //如果是集合类型</span><br><span class="line">            if (objectFactory.isCollection(type)) &#123;</span><br><span class="line">                //生成一个集合对象</span><br><span class="line">                propertyValue = objectFactory.create(type);</span><br><span class="line">                //设置到上一级对象中去 </span><br><span class="line">                metaObject.setValue(propertyName, propertyValue);</span><br><span class="line">                return propertyValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new ExecutorException(&quot;Error instantiating collection property for result &apos;&quot; + resultMapping.getProperty() + &quot;&apos;.  Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (objectFactory.isCollection(propertyValue.getClass())) &#123;</span><br><span class="line">        return propertyValue;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="八、懒加载过程"><a href="#八、懒加载过程" class="headerlink" title="八、懒加载过程"></a>八、懒加载过程</h3><h4 id="1、EnhancedResultObjectProxyImpl的intercept方法"><a href="#1、EnhancedResultObjectProxyImpl的intercept方法" class="headerlink" title="1、EnhancedResultObjectProxyImpl的intercept方法"></a>1、EnhancedResultObjectProxyImpl的intercept方法</h4><p>有子查询，返回的是代理对象，执行对象的get方法，会先经过intercept方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public Object intercept(Object enhanced, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">    //调用的方法</span><br><span class="line">    final String methodName = method.getName();</span><br><span class="line">    try &#123;</span><br><span class="line">        synchronized (lazyLoader) &#123;</span><br><span class="line">            if (WRITE_REPLACE_METHOD.equals(methodName)) &#123;</span><br><span class="line">                //writeReplace方法可以使对象被写入流以前，用一个对象来替换自己</span><br><span class="line">                //将要序列化的对象</span><br><span class="line">                Object original = null;</span><br><span class="line">                if (constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">                    //创建原始对象</span><br><span class="line">                    original = objectFactory.create(type);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    original = objectFactory.create(type, constructorArgTypes, constructorArgs);</span><br><span class="line">                &#125;</span><br><span class="line">                PropertyCopier.copyBeanProperties(type, enhanced, original);   </span><br><span class="line">                if (lazyLoader.size() &gt; 0) &#123;</span><br><span class="line">                    //有懒加载方法</span><br><span class="line">                    //创建代理对象</span><br><span class="line">                    return new CglibSerialStateHolder(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //返回原始对象</span><br><span class="line">                    return original;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //有懒加载方法，且本方法不为finalize方法</span><br><span class="line">                if (lazyLoader.size() &gt; 0 &amp;&amp; !FINALIZE_METHOD.equals(methodName)) &#123;</span><br><span class="line">                    if (aggressive || lazyLoadTriggerMethods.contains(methodName)) &#123;</span><br><span class="line">                        //加载所有子查询</span><br><span class="line">                        lazyLoader.loadAll();</span><br><span class="line">                    &#125; else if (PropertyNamer.isProperty(methodName)) &#123;</span><br><span class="line">                        //由get或set方法名获取property字段名</span><br><span class="line">                        final String property = PropertyNamer.methodToProperty(methodName);</span><br><span class="line">                        if (lazyLoader.hasLoader(property)) &#123;</span><br><span class="line">                            //查询该字段</span><br><span class="line">                            lazyLoader.load(property);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return methodProxy.invokeSuper(enhanced, args);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>懒加载配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 查询时，关闭关联对象即时加载以提高性能 --&gt;  </span><br><span class="line">&lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot; /&gt;  </span><br><span class="line">&lt;!-- 该属性为true，则在访问任何一个懒加载属性时，加载所有懒加载属性 --&gt;  </span><br><span class="line">&lt;setting name=&quot;aggressiveLazyLoading&quot; value=&quot;false&quot; /&gt;  </span><br><span class="line">&lt;!-- 配置该方法，触发所有懒加载 --&gt;  </span><br><span class="line">&lt;setting name=&quot;lazyLoadTriggerMethods&quot; value=&quot;doLazyLoadingNow,equals,clone,hashCode,toString&quot; /&gt;</span><br></pre></td></tr></table></figure></p><h4 id="2、ResultLoaderMap的loadAll方法"><a href="#2、ResultLoaderMap的loadAll方法" class="headerlink" title="2、ResultLoaderMap的loadAll方法"></a>2、ResultLoaderMap的loadAll方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void loadAll() throws SQLException &#123;</span><br><span class="line">    //获取所有懒加载方法名</span><br><span class="line">    final Set&lt;String&gt; methodNameSet = loaderMap.keySet();</span><br><span class="line">    String[] methodNames = methodNameSet.toArray(new String[methodNameSet.size()]);</span><br><span class="line">    for (String methodName : methodNames) &#123;</span><br><span class="line">        //加载</span><br><span class="line">        load(methodName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3、ResultLoaderMap的load方法"><a href="#3、ResultLoaderMap的load方法" class="headerlink" title="3、ResultLoaderMap的load方法"></a>3、ResultLoaderMap的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean load(String property) throws SQLException &#123;</span><br><span class="line">    LoadPair pair = loaderMap.remove(property.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    if (pair != null) &#123;</span><br><span class="line">        //加载</span><br><span class="line">        pair.load();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4、LoadPair的load方法"><a href="#4、LoadPair的load方法" class="headerlink" title="4、LoadPair的load方法"></a>4、LoadPair的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void load() throws SQLException &#123;</span><br><span class="line">    /* These field should not be null unless the loadpair was serialized.</span><br><span class="line">     * Yet in that case this method should not be called. */</span><br><span class="line">    if (this.metaResultObject == null) throw new IllegalArgumentException(&quot;metaResultObject is null&quot;);</span><br><span class="line">    if (this.resultLoader == null) throw new IllegalArgumentException(&quot;resultLoader is null&quot;);</span><br><span class="line"></span><br><span class="line">    this.load(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public void load(final Object userObject) throws SQLException &#123;</span><br><span class="line">    if (this.metaResultObject == null || this.resultLoader == null) &#123;</span><br><span class="line">        if (this.mappedParameter == null) &#123;</span><br><span class="line">            throw new ExecutorException(&quot;Property [&quot; + this.property + &quot;] cannot be loaded because &quot;</span><br><span class="line">                  + &quot;required parameter of mapped statement [&quot;</span><br><span class="line">                  + this.mappedStatement + &quot;] is not serializable.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final Configuration config = this.getConfiguration();</span><br><span class="line">        //获取子查询的MappedStatement</span><br><span class="line">        final MappedStatement ms = config.getMappedStatement(this.mappedStatement);</span><br><span class="line">        if (ms == null) &#123;</span><br><span class="line">            throw new ExecutorException(&quot;Cannot lazy load property [&quot; + this.property</span><br><span class="line">                  + &quot;] of deserialized object [&quot; + userObject.getClass()</span><br><span class="line">                  + &quot;] because configuration does not contain statement [&quot;</span><br><span class="line">                  + this.mappedStatement + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.metaResultObject = config.newMetaObject(userObject);</span><br><span class="line">        this.resultLoader = new ResultLoader(config, new ClosedExecutor(), ms, this.mappedParameter,</span><br><span class="line">            metaResultObject.getSetterType(this.property), null, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* We are using a new executor because we may be (and likely are) on a new thread</span><br><span class="line">     * and executors aren&apos;t thread safe. (Is this sufficient?)</span><br><span class="line">     *</span><br><span class="line">     * A better approach would be making executors thread safe. */</span><br><span class="line">    if (this.serializationCheck == null) &#123;</span><br><span class="line">        //正在序列化过程中,关闭原先的执行器</span><br><span class="line">        final ResultLoader old = this.resultLoader;</span><br><span class="line">        this.resultLoader = new ResultLoader(old.configuration, new ClosedExecutor(), old.mappedStatement,</span><br><span class="line">                old.parameterObject, old.targetType, old.cacheKey, old.boundSql);</span><br><span class="line">    &#125;</span><br><span class="line">    //查询出结果，并放入对象中</span><br><span class="line">    this.metaResultObject.setValue(property, this.resultLoader.loadResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5、ResultLoader的loadResult方法"><a href="#5、ResultLoader的loadResult方法" class="headerlink" title="5、ResultLoader的loadResult方法"></a>5、ResultLoader的loadResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public Object loadResult() throws SQLException &#123;</span><br><span class="line">    //查询</span><br><span class="line">    List&lt;Object&gt; list = selectList();</span><br><span class="line">    //处理查询结果</span><br><span class="line">    resultObject = resultExtractor.extractObjectFromList(list, targetType);</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6、ResultLoader的selectList方法"><a href="#6、ResultLoader的selectList方法" class="headerlink" title="6、ResultLoader的selectList方法"></a>6、ResultLoader的selectList方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private &lt;E&gt; List&lt;E&gt; selectList() throws SQLException &#123;</span><br><span class="line">    Executor localExecutor = executor;</span><br><span class="line">    if (Thread.currentThread().getId() != this.creatorThreadId || localExecutor.isClosed()) &#123;</span><br><span class="line">        //新线程，创建新的执行器</span><br><span class="line">        localExecutor = newExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //查询</span><br><span class="line">        return localExecutor.&lt;E&gt; query(mappedStatement, parameterObject, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER, cacheKey, boundSql);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (localExecutor != executor) &#123;</span><br><span class="line">            localExecutor.close(false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;一、获取SqlSession过程&quot;&gt;&lt;a href=&quot;#一、获取SqlSession过程&quot; class=&quot;headerlink&quot; title=&quot;一、获取SqlSession过程&quot;&gt;&lt;/a&gt;一、获取SqlSession过程&lt;/h3&gt;&lt;h4 id=&quot;1、Default
      
    
    </summary>
    
      <category term="mybatis3" scheme="http://yoursite.com/categories/mybatis3/"/>
    
    
  </entry>
  
</feed>
