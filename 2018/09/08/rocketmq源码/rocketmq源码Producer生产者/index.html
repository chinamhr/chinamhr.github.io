<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="demo1234567891011121314151617181920212223242526272829303132333435363738394041424344public class Producer &amp;#123;    public static void main(String[] ar"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="rocketmq源码Producer生产者"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="demo1234567891011121314151617181920212223242526272829303132333435363738394041424344public class Producer &amp;#123;    public static void main(String[] ar"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>rocketmq源码Producer生产者 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>rocketmq源码Producer生产者</h1>
                    
                    <h2 class="post-subheading">
                        生产者启动、推送消息
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-09-08
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/rocketmq/">rocketmq</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class Producer &#123;</span><br><span class="line">    public static void main(String[] args) throws MQClientException&#123;</span><br><span class="line">        /**</span><br><span class="line">         * 一个应用创建一个Producer，由应用来维护此对象，可以设置为全局对象或者单例&lt;br&gt;</span><br><span class="line">         * 注意：ProducerGroupName需要由应用来保证唯一&lt;br&gt;</span><br><span class="line">         * ProducerGroup这个概念发送普通的消息时，作用不大，但是发送分布式事务消息时，比较关键，</span><br><span class="line">         * 因为服务器会回查这个Group下的任意一个Producer</span><br><span class="line">         */</span><br><span class="line">        DefaultMQProducer producer = new DefaultMQProducer(&quot;ProducerGroupTest&quot;);</span><br><span class="line">        </span><br><span class="line">        producer.setNamesrvAddr(&quot;ip:port&quot;);</span><br><span class="line">        /**</span><br><span class="line">         * Producer对象在使用之前必须要调用start初始化，初始化一次即可&lt;br&gt;</span><br><span class="line">         * 注意：切记不可以在每次发送消息时，都调用start方法</span><br><span class="line">         */</span><br><span class="line">        producer.start();</span><br><span class="line"> </span><br><span class="line">        /**</span><br><span class="line">         * 下面这段代码表明一个Producer对象可以发送多个topic，多个tag的消息。</span><br><span class="line">         * 注意：send方法是同步调用，只要不抛异常就标识成功。但是发送成功也可会有多种状态，&lt;br&gt;</span><br><span class="line">         * 例如消息写入Master成功，但是Slave不成功，这种情况消息属于成功，但是对于个别应用如果对消息可靠性要求极高，&lt;br&gt;</span><br><span class="line">         * 需要对这种情况做处理。另外，消息可能会存在发送失败的情况，失败重试由应用来处理。</span><br><span class="line">         */</span><br><span class="line">        try &#123;</span><br><span class="line">              &#123;</span><br><span class="line">                Message msg = new Message(&quot;broker-a&quot;,// topic</span><br><span class="line">                    &quot;TagB&quot;,// tag</span><br><span class="line">                    &quot;OrderID002&quot;,// key</span><br><span class="line">                    (&quot;Hello MetaQ2&quot;).getBytes());// body</span><br><span class="line">                SendResult sendResult = producer.send(msg);</span><br><span class="line">                System.out.println(sendResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        /**</span><br><span class="line">         * 应用退出时，要调用shutdown来清理资源，关闭网络连接，从MetaQ服务器上注销自己</span><br><span class="line">         * 注意：我们建议应用在JBOSS、Tomcat等容器的退出钩子里调用shutdown方法</span><br><span class="line">         */</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一、Producer启动过程"><a href="#一、Producer启动过程" class="headerlink" title="一、Producer启动过程"></a>一、Producer启动过程</h3><h4 id="1、实例化DefaultMQProducer"><a href="#1、实例化DefaultMQProducer" class="headerlink" title="1、实例化DefaultMQProducer"></a>1、实例化DefaultMQProducer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public DefaultMQProducer(String producerGroup) &#123;</span><br><span class="line">    this(producerGroup, (RPCHook) null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public DefaultMQProducer(final String producerGroup, RPCHook rpcHook) &#123;</span><br><span class="line">    this.producerGroup = producerGroup;</span><br><span class="line">    defaultMQProducerImpl = new DefaultMQProducerImpl(this, rpcHook);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DefaultMQProducer的start方法"><a href="#2、DefaultMQProducer的start方法" class="headerlink" title="2、DefaultMQProducer的start方法"></a>2、DefaultMQProducer的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void start() throws MQClientException &#123;</span><br><span class="line">    this.defaultMQProducerImpl.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultMQProducerImpl的start方法"><a href="#3、DefaultMQProducerImpl的start方法" class="headerlink" title="3、DefaultMQProducerImpl的start方法"></a>3、DefaultMQProducerImpl的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws MQClientException &#123;</span><br><span class="line">    this.start(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public void start(final boolean startFactory) throws MQClientException &#123;</span><br><span class="line">    switch (this.serviceState) &#123;</span><br><span class="line">        case CREATE_JUST:</span><br><span class="line">            //切换Producer状态</span><br><span class="line">            this.serviceState = ServiceState.START_FAILED;</span><br><span class="line">            //检查生产者组名是否正确配置</span><br><span class="line">            this.checkConfig();</span><br><span class="line">            //jvm进程id作为producer的intancename名</span><br><span class="line">            if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) &#123;</span><br><span class="line">                this.defaultMQProducer.changeInstanceNameToPID();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //初始化mQClientFactory为MQClientInstance，并将该实例加入factoryTable</span><br><span class="line">            this.mQClientFactory = MQClientManager.getInstance().getAndCreateMQClientInstance(this.defaultMQProducer, rpcHook);</span><br><span class="line">            //将producer注册到MQClientInstance.producerTbale</span><br><span class="line">            boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);</span><br><span class="line">            //注册失败</span><br><span class="line">            if (!registerOK) &#123;</span><br><span class="line">                this.serviceState = ServiceState.CREATE_JUST;</span><br><span class="line">                throw new MQClientException(&quot;The producer group[&quot; + this.defaultMQProducer.getProducerGroup()</span><br><span class="line">                    + &quot;] has been created before, specify another name please.&quot; + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br><span class="line">                    null);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //保存topic对应的routeInfo</span><br><span class="line">            this.topicPublishInfoTable.put(this.defaultMQProducer.getCreateTopicKey(), new TopicPublishInfo());</span><br><span class="line"></span><br><span class="line">            if (startFactory) &#123;</span><br><span class="line">                //启动MQClientInstance</span><br><span class="line">                mQClientFactory.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            log.info(&quot;the producer [&#123;&#125;] start OK. sendMessageWithVIPChannel=&#123;&#125;&quot;, this.defaultMQProducer.getProducerGroup(),</span><br><span class="line">                this.defaultMQProducer.isSendMessageWithVIPChannel());</span><br><span class="line">            //切换Producer状态</span><br><span class="line">            this.serviceState = ServiceState.RUNNING;</span><br><span class="line">            break;</span><br><span class="line">        case RUNNING:</span><br><span class="line">        case START_FAILED:</span><br><span class="line">        case SHUTDOWN_ALREADY:</span><br><span class="line">            throw new MQClientException(&quot;The producer service state not OK, maybe started once, &quot;</span><br><span class="line">                + this.serviceState</span><br><span class="line">                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),</span><br><span class="line">                null);</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    //启动的时候向所有的broker发送heartbeat</span><br><span class="line">    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、MQClientInstance的start方法"><a href="#4、MQClientInstance的start方法" class="headerlink" title="4、MQClientInstance的start方法"></a>4、MQClientInstance的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws MQClientException &#123;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        switch (this.serviceState) &#123;</span><br><span class="line">            case CREATE_JUST:</span><br><span class="line">                this.serviceState = ServiceState.START_FAILED;</span><br><span class="line">                // If not specified,looking address from name server</span><br><span class="line">                //获取注册中心地址</span><br><span class="line">                if (null == this.clientConfig.getNamesrvAddr()) &#123;</span><br><span class="line">                    this.mQClientAPIImpl.fetchNameServerAddr();</span><br><span class="line">                &#125;</span><br><span class="line">                // Start request-response channel</span><br><span class="line">                //启动client与注册中心的通讯,ClientRemotingProcessor处理请求</span><br><span class="line">                this.mQClientAPIImpl.start();</span><br><span class="line">                // Start various schedule tasks</span><br><span class="line">                //启动调度服务</span><br><span class="line">                this.startScheduledTask();</span><br><span class="line">                // Start pull service</span><br><span class="line">                //启动拉服务</span><br><span class="line">                this.pullMessageService.start();</span><br><span class="line">                // Start rebalance service</span><br><span class="line">                //启动负载均衡</span><br><span class="line">                this.rebalanceService.start();</span><br><span class="line">                // Start push service</span><br><span class="line">                //启动推服务</span><br><span class="line">                this.defaultMQProducer.getDefaultMQProducerImpl().start(false);</span><br><span class="line">                log.info(&quot;the client factory [&#123;&#125;] start OK&quot;, this.clientId);</span><br><span class="line">                this.serviceState = ServiceState.RUNNING;</span><br><span class="line">                break;</span><br><span class="line">            case RUNNING:</span><br><span class="line">                break;</span><br><span class="line">            case SHUTDOWN_ALREADY:</span><br><span class="line">                break;</span><br><span class="line">            case START_FAILED:</span><br><span class="line">                throw new MQClientException(&quot;The Factory object[&quot; + this.getClientId() + &quot;] has been created before, and failed.&quot;, null);</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、MQClientInstance的startScheduledTask方法"><a href="#5、MQClientInstance的startScheduledTask方法" class="headerlink" title="5、MQClientInstance的startScheduledTask方法"></a>5、MQClientInstance的startScheduledTask方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">private void startScheduledTask() &#123;</span><br><span class="line">    if (null == this.clientConfig.getNamesrvAddr()) &#123;</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //获取nameServer的地址</span><br><span class="line">                    MQClientInstance.this.mQClientAPIImpl.fetchNameServerAddr();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    log.error(&quot;ScheduledTask fetchNameServerAddr exception&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 1000 * 10, 1000 * 60 * 2, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //更新topicRouteData</span><br><span class="line">                MQClientInstance.this.updateTopicRouteInfoFromNameServer();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;ScheduledTask updateTopicRouteInfoFromNameServer exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 10, this.clientConfig.getPollNameServerInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //清理掉线的broker</span><br><span class="line">                MQClientInstance.this.cleanOfflineBroker();</span><br><span class="line">                //给broker发送心跳</span><br><span class="line">                MQClientInstance.this.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;ScheduledTask sendHeartbeatToAllBroker exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 1000, this.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //保存consumerOffset</span><br><span class="line">                MQClientInstance.this.persistAllConsumerOffset();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;ScheduledTask persistAllConsumerOffset exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 1000 * 10, this.clientConfig.getPersistConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //根据processQueueTable的大小决定是否需要增加或者减少threadPool的大小</span><br><span class="line">                MQClientInstance.this.adjustThreadPool();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(&quot;ScheduledTask adjustThreadPool exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 1, 1, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、Producer推送消息"><a href="#二、Producer推送消息" class="headerlink" title="二、Producer推送消息"></a>二、Producer推送消息</h3><h4 id="1、DefaultMQProducer的send方法"><a href="#1、DefaultMQProducer的send方法" class="headerlink" title="1、DefaultMQProducer的send方法"></a>1、DefaultMQProducer的send方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    return this.defaultMQProducerImpl.send(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DefaultMQProducerImpl的send方法"><a href="#2、DefaultMQProducerImpl的send方法" class="headerlink" title="2、DefaultMQProducerImpl的send方法"></a>2、DefaultMQProducerImpl的send方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SendResult send(Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    return send(msg, this.defaultMQProducer.getSendMsgTimeout());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SendResult send(Message msg,long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultMQProducerImpl的sendDefaultImpl方法"><a href="#3、DefaultMQProducerImpl的sendDefaultImpl方法" class="headerlink" title="3、DefaultMQProducerImpl的sendDefaultImpl方法"></a>3、DefaultMQProducerImpl的sendDefaultImpl方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">private SendResult sendDefaultImpl(</span><br><span class="line">    Message msg,</span><br><span class="line">    final CommunicationMode communicationMode,</span><br><span class="line">    final SendCallback sendCallback,</span><br><span class="line">    final long timeout</span><br><span class="line">) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    //检查运行状态</span><br><span class="line">    this.makeSureStateOK();</span><br><span class="line">    Validators.checkMessage(msg, this.defaultMQProducer);</span><br><span class="line"></span><br><span class="line">    final long invokeID = random.nextLong();</span><br><span class="line">    long beginTimestampFirst = System.currentTimeMillis();</span><br><span class="line">    long beginTimestampPrev = beginTimestampFirst;</span><br><span class="line">    long endTimestamp = beginTimestampFirst;</span><br><span class="line">    //根据消息的topic来获取相关topicd的路由信息</span><br><span class="line">    TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class="line">    if (topicPublishInfo != null &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class="line">        MessageQueue mq = null;</span><br><span class="line">        Exception exception = null;</span><br><span class="line">        SendResult sendResult = null;</span><br><span class="line">        int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1;</span><br><span class="line">        int times = 0;</span><br><span class="line">        String[] brokersSent = new String[timesTotal];</span><br><span class="line">        //消息发送失败重发次数</span><br><span class="line">        for (; times &lt; timesTotal; times++) &#123;</span><br><span class="line">            String lastBrokerName = null == mq ? null : mq.getBrokerName();</span><br><span class="line">            //根据lastBrokerName选择发送队列</span><br><span class="line">            MessageQueue mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName);</span><br><span class="line">            if (mqSelected != null) &#123;</span><br><span class="line">                mq = mqSelected;</span><br><span class="line">                brokersSent[times] = mq.getBrokerName();</span><br><span class="line">                try &#123;</span><br><span class="line">                    //发送start时间</span><br><span class="line">                    beginTimestampPrev = System.currentTimeMillis();</span><br><span class="line">                    //发送消息</span><br><span class="line">                    sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</span><br><span class="line">                    //发送结束时间</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    //更新broker的延迟情况</span><br><span class="line">                    this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);</span><br><span class="line">                    switch (communicationMode) &#123;</span><br><span class="line">                        case ASYNC:</span><br><span class="line">                            return null;</span><br><span class="line">                        case ONEWAY:</span><br><span class="line">                            return null;</span><br><span class="line">                        case SYNC:</span><br><span class="line">                            if (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;</span><br><span class="line">                                //同步发送成功但存储有问题时&amp;&amp;配置存储异常时重新发送时，进行重试</span><br><span class="line">                                if (this.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123;</span><br><span class="line">                                    continue;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            return sendResult;</span><br><span class="line">                        default:</span><br><span class="line">                            break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (RemotingException e) &#123;</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);</span><br><span class="line">                    log.warn(String.format(&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq), e);</span><br><span class="line">                    log.warn(msg.toString());</span><br><span class="line">                    exception = e;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125; catch (MQClientException e) &#123;</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);</span><br><span class="line">                    log.warn(String.format(&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq), e);</span><br><span class="line">                    log.warn(msg.toString());</span><br><span class="line">                    exception = e;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125; catch (MQBrokerException e) &#123;</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, true);</span><br><span class="line">                    log.warn(String.format(&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq), e);</span><br><span class="line">                    log.warn(msg.toString());</span><br><span class="line">                    exception = e;</span><br><span class="line">                    switch (e.getResponseCode()) &#123;</span><br><span class="line">                        case ResponseCode.TOPIC_NOT_EXIST:</span><br><span class="line">                        case ResponseCode.SERVICE_NOT_AVAILABLE:</span><br><span class="line">                        case ResponseCode.SYSTEM_ERROR:</span><br><span class="line">                        case ResponseCode.NO_PERMISSION:</span><br><span class="line">                        case ResponseCode.NO_BUYER_ID:</span><br><span class="line">                        case ResponseCode.NOT_IN_CURRENT_UNIT:</span><br><span class="line">                            continue;</span><br><span class="line">                        default:</span><br><span class="line">                            if (sendResult != null) &#123;</span><br><span class="line">                                return sendResult;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            throw e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);</span><br><span class="line">                    log.warn(String.format(&quot;sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s&quot;, invokeID, endTimestamp - beginTimestampPrev, mq), e);</span><br><span class="line">                    log.warn(msg.toString());</span><br><span class="line"></span><br><span class="line">                    log.warn(&quot;sendKernelImpl exception&quot;, e);</span><br><span class="line">                    log.warn(msg.toString());</span><br><span class="line">                    throw e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //返回发送结果</span><br><span class="line">        if (sendResult != null) &#123;</span><br><span class="line">            return sendResult;</span><br><span class="line">        &#125;</span><br><span class="line">        //根据不同情况，抛出不同的异常</span><br><span class="line">        String info = String.format(&quot;Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s&quot;,</span><br><span class="line">            times,</span><br><span class="line">            System.currentTimeMillis() - beginTimestampFirst,</span><br><span class="line">            msg.getTopic(),</span><br><span class="line">            Arrays.toString(brokersSent));</span><br><span class="line"></span><br><span class="line">        info += FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);</span><br><span class="line"></span><br><span class="line">        MQClientException mqClientException = new MQClientException(info, exception);</span><br><span class="line">        if (exception instanceof MQBrokerException) &#123;</span><br><span class="line">            mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());</span><br><span class="line">        &#125; else if (exception instanceof RemotingConnectException) &#123;</span><br><span class="line">            mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);</span><br><span class="line">        &#125; else if (exception instanceof RemotingTimeoutException) &#123;</span><br><span class="line">            mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);</span><br><span class="line">        &#125; else if (exception instanceof MQClientException) &#123;</span><br><span class="line">            mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        throw mqClientException;</span><br><span class="line">    &#125;</span><br><span class="line">    //Namesrv找不到异常</span><br><span class="line">    List&lt;String&gt; nsList = this.getmQClientFactory().getMQClientAPIImpl().getNameServerAddressList();</span><br><span class="line">    if (null == nsList || nsList.isEmpty()) &#123;</span><br><span class="line">        throw new MQClientException(</span><br><span class="line">            &quot;No name server address, please set it.&quot; + FAQUrl.suggestTodo(FAQUrl.NAME_SERVER_ADDR_NOT_EXIST_URL), null).setResponseCode(ClientErrorCode.NO_NAME_SERVER_EXCEPTION);</span><br><span class="line">    &#125;</span><br><span class="line">    //消息路由找不到异常</span><br><span class="line">    throw new MQClientException(&quot;No route info of this topic, &quot; + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),</span><br><span class="line">        null).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DefaultMQProducerImpl的tryToFindTopicPublishInfo方法"><a href="#4、DefaultMQProducerImpl的tryToFindTopicPublishInfo方法" class="headerlink" title="4、DefaultMQProducerImpl的tryToFindTopicPublishInfo方法"></a>4、DefaultMQProducerImpl的tryToFindTopicPublishInfo方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) &#123;</span><br><span class="line">    //缓存中获取Topic发布信息</span><br><span class="line">    TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);</span><br><span class="line">    //从Namesrv获取</span><br><span class="line">    if (null == topicPublishInfo || !topicPublishInfo.ok()) &#123;</span><br><span class="line">        this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());</span><br><span class="line">        this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</span><br><span class="line">        topicPublishInfo = this.topicPublishInfoTable.get(topic);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取的Topic发布信息时候可用，则返回</span><br><span class="line">    if (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) &#123;</span><br><span class="line">        return topicPublishInfo;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //使用&#123;@link DefaultMQProducer#createTopicKey&#125; 对应的Topic发布信息。</span><br><span class="line">        //用于Topic发布信息不存在&amp;&amp;Broker支持自动创建Topic</span><br><span class="line">        this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, true, this.defaultMQProducer);</span><br><span class="line">        topicPublishInfo = this.topicPublishInfoTable.get(topic);</span><br><span class="line">        return topicPublishInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（二、3）DefaultMQProducerImpl的selectOneMessageQueue方法"><a href="#5、接（二、3）DefaultMQProducerImpl的selectOneMessageQueue方法" class="headerlink" title="5、接（二、3）DefaultMQProducerImpl的selectOneMessageQueue方法"></a>5、接（二、3）DefaultMQProducerImpl的selectOneMessageQueue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public MessageQueue selectOneMessageQueue(final TopicPublishInfo tpInfo, final String lastBrokerName) &#123;</span><br><span class="line">    return this.mqFaultStrategy.selectOneMessageQueue(tpInfo, lastBrokerName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、MQFaultStrategy的selectOneMessageQueue方法"><a href="#6、MQFaultStrategy的selectOneMessageQueue方法" class="headerlink" title="6、MQFaultStrategy的selectOneMessageQueue方法"></a>6、MQFaultStrategy的selectOneMessageQueue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public MessageQueue selectOneMessageQueue(final TopicPublishInfo tpInfo, final String lastBrokerName) &#123;</span><br><span class="line">    //判断是否开启了容错策略,默认关闭</span><br><span class="line">    if (this.sendLatencyFaultEnable) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取一个可用的并且brokerName=lastBrokerName的消息队列</span><br><span class="line">            int index = tpInfo.getSendWhichQueue().getAndIncrement();</span><br><span class="line">            for (int i = 0; i &lt; tpInfo.getMessageQueueList().size(); i++) &#123;</span><br><span class="line">                int pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();</span><br><span class="line">                if (pos &lt; 0)</span><br><span class="line">                    pos = 0;</span><br><span class="line">                MessageQueue mq = tpInfo.getMessageQueueList().get(pos);</span><br><span class="line">                if (latencyFaultTolerance.isAvailable(mq.getBrokerName())) &#123;</span><br><span class="line">                    if (null == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))</span><br><span class="line">                        return mq;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //选择一个相对好的broker，不考虑可用性的消息队列</span><br><span class="line">            final String notBestBroker = latencyFaultTolerance.pickOneAtLeast();</span><br><span class="line">            int writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);</span><br><span class="line">            if (writeQueueNums &gt; 0) &#123;</span><br><span class="line">                final MessageQueue mq = tpInfo.selectOneMessageQueue();</span><br><span class="line">                if (notBestBroker != null) &#123;</span><br><span class="line">                    mq.setBrokerName(notBestBroker);</span><br><span class="line">                    mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);</span><br><span class="line">                &#125;</span><br><span class="line">                return mq;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                latencyFaultTolerance.remove(notBestBroker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(&quot;Error occurred when selecting message queue&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">        //随机选择一个消息队列</span><br><span class="line">        return tpInfo.selectOneMessageQueue();</span><br><span class="line">    &#125;</span><br><span class="line">    //获得lastBrokerName对应的一个消息队列，不考虑该队列的可用性</span><br><span class="line">    return tpInfo.selectOneMessageQueue(lastBrokerName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（二、3）DefaultMQProducerImpl的sendKernelImpl方法"><a href="#7、接（二、3）DefaultMQProducerImpl的sendKernelImpl方法" class="headerlink" title="7、接（二、3）DefaultMQProducerImpl的sendKernelImpl方法"></a>7、接（二、3）DefaultMQProducerImpl的sendKernelImpl方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">private SendResult sendKernelImpl(final Message msg,</span><br><span class="line">    final MessageQueue mq,</span><br><span class="line">    final CommunicationMode communicationMode,</span><br><span class="line">    final SendCallback sendCallback,</span><br><span class="line">    final TopicPublishInfo topicPublishInfo,</span><br><span class="line">    final long timeout) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line">    //获取 broker地址</span><br><span class="line">    String brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</span><br><span class="line">    if (null == brokerAddr) &#123;</span><br><span class="line">        tryToFindTopicPublishInfo(mq.getTopic());</span><br><span class="line">        brokerAddr = this.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SendMessageContext context = null;</span><br><span class="line">    if (brokerAddr != null) &#123;</span><br><span class="line">        //是否使用broker vip通道。broker会开启两个端口对外服务。</span><br><span class="line">        brokerAddr = MixAll.brokerVIPChannel(this.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);</span><br><span class="line"></span><br><span class="line">        byte[] prevBody = msg.getBody();</span><br><span class="line">        try &#123;</span><br><span class="line">            //for MessageBatch,ID has been set in the generating process</span><br><span class="line">            //设置唯一编号</span><br><span class="line">            if (!(msg instanceof MessageBatch)) &#123;</span><br><span class="line">                MessageClientIDSetter.setUniqID(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            //消息压缩</span><br><span class="line">            int sysFlag = 0;</span><br><span class="line">            if (this.tryToCompressMessage(msg)) &#123;</span><br><span class="line">                sysFlag |= MessageSysFlag.COMPRESSED_FLAG;</span><br><span class="line">            &#125;</span><br><span class="line">            //事务</span><br><span class="line">            final String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">            if (tranMsg != null &amp;&amp; Boolean.parseBoolean(tranMsg)) &#123;</span><br><span class="line">                sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;</span><br><span class="line">            &#125;</span><br><span class="line">            //hook：发送消息校验</span><br><span class="line">            if (hasCheckForbiddenHook()) &#123;</span><br><span class="line">                CheckForbiddenContext checkForbiddenContext = new CheckForbiddenContext();</span><br><span class="line">                checkForbiddenContext.setNameSrvAddr(this.defaultMQProducer.getNamesrvAddr());</span><br><span class="line">                checkForbiddenContext.setGroup(this.defaultMQProducer.getProducerGroup());</span><br><span class="line">                checkForbiddenContext.setCommunicationMode(communicationMode);</span><br><span class="line">                checkForbiddenContext.setBrokerAddr(brokerAddr);</span><br><span class="line">                checkForbiddenContext.setMessage(msg);</span><br><span class="line">                checkForbiddenContext.setMq(mq);</span><br><span class="line">                checkForbiddenContext.setUnitMode(this.isUnitMode());</span><br><span class="line">                this.executeCheckForbiddenHook(checkForbiddenContext);</span><br><span class="line">            &#125;</span><br><span class="line">            //hook：发送消息前逻辑</span><br><span class="line">            if (this.hasSendMessageHook()) &#123;</span><br><span class="line">                context = new SendMessageContext();</span><br><span class="line">                context.setProducer(this);</span><br><span class="line">                context.setProducerGroup(this.defaultMQProducer.getProducerGroup());</span><br><span class="line">                context.setCommunicationMode(communicationMode);</span><br><span class="line">                context.setBornHost(this.defaultMQProducer.getClientIP());</span><br><span class="line">                context.setBrokerAddr(brokerAddr);</span><br><span class="line">                context.setMessage(msg);</span><br><span class="line">                context.setMq(mq);</span><br><span class="line">                String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">                if (isTrans != null &amp;&amp; isTrans.equals(&quot;true&quot;)) &#123;</span><br><span class="line">                    context.setMsgType(MessageType.Trans_Msg_Half);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (msg.getProperty(&quot;__STARTDELIVERTIME&quot;) != null || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != null) &#123;</span><br><span class="line">                    context.setMsgType(MessageType.Delay_Msg);</span><br><span class="line">                &#125;</span><br><span class="line">                this.executeSendMessageHookBefore(context);</span><br><span class="line">            &#125;</span><br><span class="line">            //构建发送消息请求</span><br><span class="line">            SendMessageRequestHeader requestHeader = new SendMessageRequestHeader();</span><br><span class="line">            requestHeader.setProducerGroup(this.defaultMQProducer.getProducerGroup());</span><br><span class="line">            requestHeader.setTopic(msg.getTopic());</span><br><span class="line">            requestHeader.setDefaultTopic(this.defaultMQProducer.getCreateTopicKey());</span><br><span class="line">            requestHeader.setDefaultTopicQueueNums(this.defaultMQProducer.getDefaultTopicQueueNums());</span><br><span class="line">            requestHeader.setQueueId(mq.getQueueId());</span><br><span class="line">            requestHeader.setSysFlag(sysFlag);</span><br><span class="line">            requestHeader.setBornTimestamp(System.currentTimeMillis());</span><br><span class="line">            requestHeader.setFlag(msg.getFlag());</span><br><span class="line">            requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line">            requestHeader.setReconsumeTimes(0);</span><br><span class="line">            requestHeader.setUnitMode(this.isUnitMode());</span><br><span class="line">            requestHeader.setBatch(msg instanceof MessageBatch);</span><br><span class="line">            if (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);</span><br><span class="line">                if (reconsumeTimes != null) &#123;</span><br><span class="line">                    requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));</span><br><span class="line">                    MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);</span><br><span class="line">                if (maxReconsumeTimes != null) &#123;</span><br><span class="line">                    requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));</span><br><span class="line">                    MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //发送消息</span><br><span class="line">            SendResult sendResult = null;</span><br><span class="line">            switch (communicationMode) &#123;</span><br><span class="line">                case ASYNC:</span><br><span class="line">                    sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                        brokerAddr,</span><br><span class="line">                        mq.getBrokerName(),</span><br><span class="line">                        msg,</span><br><span class="line">                        requestHeader,</span><br><span class="line">                        timeout,</span><br><span class="line">                        communicationMode,</span><br><span class="line">                        sendCallback,</span><br><span class="line">                        topicPublishInfo,</span><br><span class="line">                        this.mQClientFactory,</span><br><span class="line">                        this.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),</span><br><span class="line">                        context,</span><br><span class="line">                        this);</span><br><span class="line">                    break;</span><br><span class="line">                case ONEWAY:</span><br><span class="line">                case SYNC:</span><br><span class="line">                    sendResult = this.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                        brokerAddr,</span><br><span class="line">                        mq.getBrokerName(),</span><br><span class="line">                        msg,</span><br><span class="line">                        requestHeader,</span><br><span class="line">                        timeout,</span><br><span class="line">                        communicationMode,</span><br><span class="line">                        context,</span><br><span class="line">                        this);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    assert false;</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">            //hook：发送消息后逻辑</span><br><span class="line">            if (this.hasSendMessageHook()) &#123;</span><br><span class="line">                context.setSendResult(sendResult);</span><br><span class="line">                this.executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line">            //返回发送结果</span><br><span class="line">            return sendResult;</span><br><span class="line">        &#125; catch (RemotingException e) &#123;</span><br><span class="line">            if (this.hasSendMessageHook()) &#123;</span><br><span class="line">                context.setException(e);</span><br><span class="line">                this.executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch (MQBrokerException e) &#123;</span><br><span class="line">            if (this.hasSendMessageHook()) &#123;</span><br><span class="line">                context.setException(e);</span><br><span class="line">                this.executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            if (this.hasSendMessageHook()) &#123;</span><br><span class="line">                context.setException(e);</span><br><span class="line">                this.executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line">            throw e;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            msg.setBody(prevBody);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //broker为空抛出异常</span><br><span class="line">    throw new MQClientException(&quot;The broker[&quot; + mq.getBrokerName() + &quot;] not exist&quot;, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>