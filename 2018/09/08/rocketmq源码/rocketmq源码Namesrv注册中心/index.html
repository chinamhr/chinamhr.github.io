<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="一、Namesrv启动过程1、NamesrvStartup的main方法123public static void main(String[] args) &amp;#123;    main0(args);&amp;#125;
1234567891011121314151617181920212223242526"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="rocketmq源码Namesrv注册中心"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="一、Namesrv启动过程1、NamesrvStartup的main方法123public static void main(String[] args) &amp;#123;    main0(args);&amp;#125;
1234567891011121314151617181920212223242526"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>rocketmq源码Namesrv注册中心 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>rocketmq源码Namesrv注册中心</h1>
                    
                    <h2 class="post-subheading">
                        Namesrv启动、注册borker及获取topic路由信息
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-09-08
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/rocketmq/">rocketmq</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="一、Namesrv启动过程"><a href="#一、Namesrv启动过程" class="headerlink" title="一、Namesrv启动过程"></a>一、Namesrv启动过程</h3><h4 id="1、NamesrvStartup的main方法"><a href="#1、NamesrvStartup的main方法" class="headerlink" title="1、NamesrvStartup的main方法"></a>1、NamesrvStartup的main方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    main0(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">public static NamesrvController main0(String[] args) &#123;</span><br><span class="line">    System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">    try &#123;</span><br><span class="line">        //PackageConflictDetect.detectFastjson();</span><br><span class="line"></span><br><span class="line">        Options options = ServerUtil.buildCommandlineOptions(new Options());</span><br><span class="line">        commandLine = ServerUtil.parseCmdLine(&quot;mqnamesrv&quot;, args, buildCommandlineOptions(options), new PosixParser());</span><br><span class="line">        if (null == commandLine) &#123;</span><br><span class="line">            System.exit(-1);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        //初始化配置文件</span><br><span class="line">        final NamesrvConfig namesrvConfig = new NamesrvConfig();</span><br><span class="line">        //初始化nettyServerConfig配置项</span><br><span class="line">        final NettyServerConfig nettyServerConfig = new NettyServerConfig();</span><br><span class="line">        //设置netty监听端口为9876</span><br><span class="line">        nettyServerConfig.setListenPort(9876);</span><br><span class="line">        if (commandLine.hasOption(&apos;c&apos;)) &#123;</span><br><span class="line">            String file = commandLine.getOptionValue(&apos;c&apos;);</span><br><span class="line">            if (file != null) &#123;</span><br><span class="line">                InputStream in = new BufferedInputStream(new FileInputStream(file));</span><br><span class="line">                properties = new Properties();</span><br><span class="line">                properties.load(in);</span><br><span class="line">                MixAll.properties2Object(properties, namesrvConfig);</span><br><span class="line">                MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">                namesrvConfig.setConfigStorePath(file);</span><br><span class="line"></span><br><span class="line">                System.out.printf(&quot;load config properties file OK, &quot; + file + &quot;%n&quot;);</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (commandLine.hasOption(&apos;p&apos;)) &#123;</span><br><span class="line">            MixAll.printObjectProperties(null, namesrvConfig);</span><br><span class="line">            MixAll.printObjectProperties(null, nettyServerConfig);</span><br><span class="line">            System.exit(0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), namesrvConfig);</span><br><span class="line"></span><br><span class="line">        if (null == namesrvConfig.getRocketmqHome()) &#123;</span><br><span class="line">            System.out.printf(&quot;Please set the %s variable in your environment to match the location of the RocketMQ installation%n&quot;, MixAll.ROCKETMQ_HOME_ENV);</span><br><span class="line">            System.exit(-2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</span><br><span class="line">        JoranConfigurator configurator = new JoranConfigurator();</span><br><span class="line">        configurator.setContext(lc);</span><br><span class="line">        lc.reset();</span><br><span class="line">        configurator.doConfigure(namesrvConfig.getRocketmqHome() + &quot;/conf/logback_namesrv.xml&quot;);</span><br><span class="line">        final Logger log = LoggerFactory.getLogger(LoggerName.NAMESRV_LOGGER_NAME);</span><br><span class="line"></span><br><span class="line">        MixAll.printObjectProperties(log, namesrvConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">        //初始化服务控制对象</span><br><span class="line">        final NamesrvController controller = new NamesrvController(namesrvConfig, nettyServerConfig);</span><br><span class="line"></span><br><span class="line">        // remember all configs to prevent discard</span><br><span class="line">        controller.getConfiguration().registerConfig(properties);</span><br><span class="line">        //初始化controller</span><br><span class="line">        boolean initResult = controller.initialize();</span><br><span class="line">        if (!initResult) &#123;</span><br><span class="line">            controller.shutdown();</span><br><span class="line">            System.exit(-3);</span><br><span class="line">        &#125;</span><br><span class="line">        //设置一个jvm退出勾子函数，jvm退出时，调用controller.shutdown()，清理controller相关资源</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new ShutdownHookThread(log, new Callable&lt;Void&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Void call() throws Exception &#123;</span><br><span class="line">                controller.shutdown();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        //启动controller</span><br><span class="line">        controller.start();</span><br><span class="line"></span><br><span class="line">        String tip = &quot;The Name Server boot success. serializeType=&quot; + RemotingCommand.getSerializeTypeConfigInThisServer();</span><br><span class="line">        log.info(tip);</span><br><span class="line">        System.out.printf(tip + &quot;%n&quot;);</span><br><span class="line"></span><br><span class="line">        return controller;</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、实例化NamesrvController"><a href="#2、实例化NamesrvController" class="headerlink" title="2、实例化NamesrvController"></a>2、实例化NamesrvController</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public NamesrvController(NamesrvConfig namesrvConfig, NettyServerConfig nettyServerConfig) &#123;</span><br><span class="line">    //namesrv相关配置</span><br><span class="line">    this.namesrvConfig = namesrvConfig;</span><br><span class="line">    //netty相关配置</span><br><span class="line">    this.nettyServerConfig = nettyServerConfig;</span><br><span class="line">    //KV配置管理</span><br><span class="line">    this.kvConfigManager = new KVConfigManager(this);</span><br><span class="line">    //路由信息、topic信息管理</span><br><span class="line">    this.routeInfoManager = new RouteInfoManager();</span><br><span class="line">    //broker管理服务</span><br><span class="line">    this.brokerHousekeepingService = new BrokerHousekeepingService(this);</span><br><span class="line">    this.configuration = new Configuration(</span><br><span class="line">        log,</span><br><span class="line">        this.namesrvConfig, this.nettyServerConfig</span><br><span class="line">    );</span><br><span class="line">    this.configuration.setStorePathFromConfig(this.namesrvConfig, &quot;configStorePath&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、接（一、1）NamesrvController的initialize方法"><a href="#3、接（一、1）NamesrvController的initialize方法" class="headerlink" title="3、接（一、1）NamesrvController的initialize方法"></a>3、接（一、1）NamesrvController的initialize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public boolean initialize() &#123;</span><br><span class="line">    //加载kvConfig.json至KVConfigManager的configTable</span><br><span class="line">    this.kvConfigManager.load();</span><br><span class="line">    //初始化Netty服务器，用于与其他模块通信</span><br><span class="line">    this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.brokerHousekeepingService);</span><br><span class="line">    //初始化线程池（根据getServerWorkerThreads值，启动相应数量线程）</span><br><span class="line">    this.remotingExecutor =</span><br><span class="line">        Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), new ThreadFactoryImpl(&quot;RemotingExecutorThread_&quot;));</span><br><span class="line">    //注册处理器DefaultRequestProcessor</span><br><span class="line">    this.registerProcessor();</span><br><span class="line">    //增加定时任务（延时5秒，每间隔10s钟，定时扫描一次）</span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            //定时扫描notActive的broker（则清除过期broker与namesrv之间的socketChanel通道）</span><br><span class="line">            NamesrvController.this.routeInfoManager.scanNotActiveBroker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 5, 10, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            //定时将configTable相关信息记录到日志文件中</span><br><span class="line">            NamesrvController.this.kvConfigManager.printAllPeriodically();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 1, 10, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、实例化NettyRemotingServer"><a href="#4、实例化NettyRemotingServer" class="headerlink" title="4、实例化NettyRemotingServer"></a>4、实例化NettyRemotingServer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">public NettyRemotingServer(final NettyServerConfig nettyServerConfig,</span><br><span class="line">    final ChannelEventListener channelEventListener) &#123;</span><br><span class="line">    super(nettyServerConfig.getServerOnewaySemaphoreValue(), nettyServerConfig.getServerAsyncSemaphoreValue());</span><br><span class="line">    //创建netty服务器实例</span><br><span class="line">    this.serverBootstrap = new ServerBootstrap();</span><br><span class="line">    this.nettyServerConfig = nettyServerConfig;</span><br><span class="line">    //该监听器为BrokerHousekeepingService</span><br><span class="line">    this.channelEventListener = channelEventListener;</span><br><span class="line">    //线程数</span><br><span class="line">    int publicThreadNums = nettyServerConfig.getServerCallbackExecutorThreads();</span><br><span class="line">    if (publicThreadNums &lt;= 0) &#123;</span><br><span class="line">        publicThreadNums = 4;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建线程池</span><br><span class="line">    this.publicExecutor = Executors.newFixedThreadPool(publicThreadNums, new ThreadFactory() &#123;</span><br><span class="line">        private AtomicInteger threadIndex = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public Thread newThread(Runnable r) &#123;</span><br><span class="line">            return new Thread(r, &quot;NettyServerPublicExecutor_&quot; + this.threadIndex.incrementAndGet());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //工作线程池</span><br><span class="line">    this.eventLoopGroupBoss = new NioEventLoopGroup(1, new ThreadFactory() &#123;</span><br><span class="line">        private AtomicInteger threadIndex = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public Thread newThread(Runnable r) &#123;</span><br><span class="line">            return new Thread(r, String.format(&quot;NettyBoss_%d&quot;, this.threadIndex.incrementAndGet()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //工作线程池</span><br><span class="line">    if (useEpoll()) &#123;</span><br><span class="line">        this.eventLoopGroupSelector = new EpollEventLoopGroup(nettyServerConfig.getServerSelectorThreads(), new ThreadFactory() &#123;</span><br><span class="line">            private AtomicInteger threadIndex = new AtomicInteger(0);</span><br><span class="line">            private int threadTotal = nettyServerConfig.getServerSelectorThreads();</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Thread newThread(Runnable r) &#123;</span><br><span class="line">                return new Thread(r, String.format(&quot;NettyServerEPOLLSelector_%d_%d&quot;, threadTotal, this.threadIndex.incrementAndGet()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.eventLoopGroupSelector = new NioEventLoopGroup(nettyServerConfig.getServerSelectorThreads(), new ThreadFactory() &#123;</span><br><span class="line">            private AtomicInteger threadIndex = new AtomicInteger(0);</span><br><span class="line">            private int threadTotal = nettyServerConfig.getServerSelectorThreads();</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Thread newThread(Runnable r) &#123;</span><br><span class="line">                return new Thread(r, String.format(&quot;NettyServerNIOSelector_%d_%d&quot;, threadTotal, this.threadIndex.incrementAndGet()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TlsMode tlsMode = TlsSystemConfig.tlsMode;</span><br><span class="line">    log.info(&quot;Server is running in TLS &#123;&#125; mode&quot;, tlsMode.getName());</span><br><span class="line"></span><br><span class="line">    if (tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            sslContext = TlsHelper.buildSslContext(false);</span><br><span class="line">            log.info(&quot;SSLContext created for server&quot;);</span><br><span class="line">        &#125; catch (CertificateException e) &#123;</span><br><span class="line">            log.error(&quot;Failed to create SSLContext for server&quot;, e);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(&quot;Failed to create SSLContext for server&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（一、1）NamesrvController的start方法"><a href="#5、接（一、1）NamesrvController的start方法" class="headerlink" title="5、接（一、1）NamesrvController的start方法"></a>5、接（一、1）NamesrvController的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws Exception &#123;</span><br><span class="line">    //启动netty服务器</span><br><span class="line">    this.remotingServer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、NettyRemotingServer的start方法"><a href="#6、NettyRemotingServer的start方法" class="headerlink" title="6、NettyRemotingServer的start方法"></a>6、NettyRemotingServer的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void start() &#123;</span><br><span class="line">    //工作线程池</span><br><span class="line">    this.defaultEventExecutorGroup = new DefaultEventExecutorGroup(</span><br><span class="line">        nettyServerConfig.getServerWorkerThreads(),</span><br><span class="line">        new ThreadFactory() &#123;</span><br><span class="line"></span><br><span class="line">            private AtomicInteger threadIndex = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public Thread newThread(Runnable r) &#123;</span><br><span class="line">                return new Thread(r, &quot;NettyServerCodecThread_&quot; + this.threadIndex.incrementAndGet());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    ServerBootstrap childHandler =</span><br><span class="line">        this.serverBootstrap.group(this.eventLoopGroupBoss, this.eventLoopGroupSelector)</span><br><span class="line">            .channel(useEpoll() ? EpollServerSocketChannel.class : NioServerSocketChannel.class)</span><br><span class="line">            //最大等待连接数</span><br><span class="line">            .option(ChannelOption.SO_BACKLOG, 1024)</span><br><span class="line">            //端口释放后立即就可以被再次使用</span><br><span class="line">            .option(ChannelOption.SO_REUSEADDR, true)</span><br><span class="line">            .option(ChannelOption.SO_KEEPALIVE, false)</span><br><span class="line">            //关闭Nagle算法</span><br><span class="line">            .childOption(ChannelOption.TCP_NODELAY, true)</span><br><span class="line">            //发送缓冲区大小</span><br><span class="line">            .childOption(ChannelOption.SO_SNDBUF, nettyServerConfig.getServerSocketSndBufSize())</span><br><span class="line">            //接收缓冲区大小</span><br><span class="line">            .childOption(ChannelOption.SO_RCVBUF, nettyServerConfig.getServerSocketRcvBufSize())</span><br><span class="line">            //监听地址</span><br><span class="line">            .localAddress(new InetSocketAddress(this.nettyServerConfig.getListenPort()))</span><br><span class="line">            //接入连接的处理器</span><br><span class="line">            .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void initChannel(SocketChannel ch) throws Exception &#123;</span><br><span class="line">                    ch.pipeline()</span><br><span class="line">                        .addLast(defaultEventExecutorGroup, HANDSHAKE_HANDLER_NAME,</span><br><span class="line">                            new HandshakeHandler(TlsSystemConfig.tlsMode))</span><br><span class="line">                        .addLast(defaultEventExecutorGroup,</span><br><span class="line">                            //编码器</span><br><span class="line">                            new NettyEncoder(),</span><br><span class="line">                            //解码器</span><br><span class="line">                            new NettyDecoder(),</span><br><span class="line">                            //心跳检测，检查120s未进行读写，则发送IdleStateEvent事件</span><br><span class="line">                            new IdleStateHandler(0, 0, nettyServerConfig.getServerChannelMaxIdleTimeSeconds()),</span><br><span class="line">                            //事件处理器</span><br><span class="line">                            new NettyConnectManageHandler(),</span><br><span class="line">                            //客户端请求处理器</span><br><span class="line">                            new NettyServerHandler()</span><br><span class="line">                        );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    //使用堆外内存</span><br><span class="line">    if (nettyServerConfig.isServerPooledByteBufAllocatorEnable()) &#123;</span><br><span class="line">        childHandler.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //服务端绑定端口</span><br><span class="line">        ChannelFuture sync = this.serverBootstrap.bind().sync();</span><br><span class="line">        InetSocketAddress addr = (InetSocketAddress) sync.channel().localAddress();</span><br><span class="line">        this.port = addr.getPort();</span><br><span class="line">    &#125; catch (InterruptedException e1) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;this.serverBootstrap.bind().sync() InterruptedException&quot;, e1);</span><br><span class="line">    &#125;</span><br><span class="line">    //启动nettyEventExecutor</span><br><span class="line">    if (this.channelEventListener != null) &#123;</span><br><span class="line">        this.nettyEventExecutor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //每隔1秒扫描下异步调用超时情况</span><br><span class="line">    this.timer.scheduleAtFixedRate(new TimerTask() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                NettyRemotingServer.this.scanResponseTable();</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                log.error(&quot;scanResponseTable exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 1000 * 3, 1000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、处理客户端请求"><a href="#二、处理客户端请求" class="headerlink" title="二、处理客户端请求"></a>二、处理客户端请求</h3><h4 id="1、NettyServerHandler的channelRead0方法"><a href="#1、NettyServerHandler的channelRead0方法" class="headerlink" title="1、NettyServerHandler的channelRead0方法"></a>1、NettyServerHandler的channelRead0方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void channelRead0(ChannelHandlerContext ctx, RemotingCommand msg) throws Exception &#123;</span><br><span class="line">    //处理客户端请求</span><br><span class="line">    processMessageReceived(ctx, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、NettyRemotingAbstract的processMessageReceived方法"><a href="#2、NettyRemotingAbstract的processMessageReceived方法" class="headerlink" title="2、NettyRemotingAbstract的processMessageReceived方法"></a>2、NettyRemotingAbstract的processMessageReceived方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void processMessageReceived(ChannelHandlerContext ctx, RemotingCommand msg) throws Exception &#123;</span><br><span class="line">    final RemotingCommand cmd = msg;</span><br><span class="line">    if (cmd != null) &#123;</span><br><span class="line">        switch (cmd.getType()) &#123;</span><br><span class="line">            case REQUEST_COMMAND:</span><br><span class="line">                //处理客户端请求</span><br><span class="line">                processRequestCommand(ctx, cmd);</span><br><span class="line">                break;</span><br><span class="line">            case RESPONSE_COMMAND:</span><br><span class="line">                processResponseCommand(ctx, cmd);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、NettyRemotingAbstract的processRequestCommand方法"><a href="#3、NettyRemotingAbstract的processRequestCommand方法" class="headerlink" title="3、NettyRemotingAbstract的processRequestCommand方法"></a>3、NettyRemotingAbstract的processRequestCommand方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">public void processRequestCommand(final ChannelHandlerContext ctx, final RemotingCommand cmd) &#123;</span><br><span class="line">    //获取匹配处理器，默认DefaultRequestProcessor</span><br><span class="line">    final Pair&lt;NettyRequestProcessor, ExecutorService&gt; matched = this.processorTable.get(cmd.getCode());</span><br><span class="line">    final Pair&lt;NettyRequestProcessor, ExecutorService&gt; pair = null == matched ? this.defaultRequestProcessor : matched;</span><br><span class="line">    final int opaque = cmd.getOpaque();</span><br><span class="line"></span><br><span class="line">    if (pair != null) &#123;</span><br><span class="line">        //创建线程</span><br><span class="line">        Runnable run = new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    RPCHook rpcHook = NettyRemotingAbstract.this.getRPCHook();</span><br><span class="line">                    if (rpcHook != null) &#123;</span><br><span class="line">                        rpcHook.doBeforeRequest(RemotingHelper.parseChannelRemoteAddr(ctx.channel()), cmd);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //获取处理器DefaultRequestProcessor处理请求</span><br><span class="line">                    final RemotingCommand response = pair.getObject1().processRequest(ctx, cmd);</span><br><span class="line">                    if (rpcHook != null) &#123;</span><br><span class="line">                        rpcHook.doAfterResponse(RemotingHelper.parseChannelRemoteAddr(ctx.channel()), cmd, response);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //需要返回值</span><br><span class="line">                    if (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                        if (response != null) &#123;</span><br><span class="line">                            response.setOpaque(opaque);</span><br><span class="line">                            response.markResponseType();</span><br><span class="line">                            try &#123;</span><br><span class="line">                                ctx.writeAndFlush(response);</span><br><span class="line">                            &#125; catch (Throwable e) &#123;</span><br><span class="line">                                log.error(&quot;process request over, but response failed&quot;, e);</span><br><span class="line">                                log.error(cmd.toString());</span><br><span class="line">                                log.error(response.toString());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;process request exception&quot;, e);</span><br><span class="line">                    log.error(cmd.toString());</span><br><span class="line"></span><br><span class="line">                    if (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                        final RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_ERROR,</span><br><span class="line">                            RemotingHelper.exceptionSimpleDesc(e));</span><br><span class="line">                        response.setOpaque(opaque);</span><br><span class="line">                        ctx.writeAndFlush(response);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //是否拒绝请求</span><br><span class="line">        if (pair.getObject1().rejectRequest()) &#123;</span><br><span class="line">            final RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_BUSY,</span><br><span class="line">                &quot;[REJECTREQUEST]system busy, start flow control for a while&quot;);</span><br><span class="line">            response.setOpaque(opaque);</span><br><span class="line">            ctx.writeAndFlush(response);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //向线程池提交任务</span><br><span class="line">            final RequestTask requestTask = new RequestTask(run, ctx.channel(), cmd);</span><br><span class="line">            pair.getObject2().submit(requestTask);</span><br><span class="line">        &#125; catch (RejectedExecutionException e) &#123;</span><br><span class="line">            if ((System.currentTimeMillis() % 10000) == 0) &#123;</span><br><span class="line">                log.warn(RemotingHelper.parseChannelRemoteAddr(ctx.channel())</span><br><span class="line">                    + &quot;, too many requests and system thread pool busy, RejectedExecutionException &quot;</span><br><span class="line">                    + pair.getObject2().toString()</span><br><span class="line">                    + &quot; request code: &quot; + cmd.getCode());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!cmd.isOnewayRPC()) &#123;</span><br><span class="line">                final RemotingCommand response = RemotingCommand.createResponseCommand(RemotingSysResponseCode.SYSTEM_BUSY,</span><br><span class="line">                    &quot;[OVERLOAD]system busy, start flow control for a while&quot;);</span><br><span class="line">                response.setOpaque(opaque);</span><br><span class="line">                ctx.writeAndFlush(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        String error = &quot; request type &quot; + cmd.getCode() + &quot; not supported&quot;;</span><br><span class="line">        //找不到处理器</span><br><span class="line">        final RemotingCommand response =</span><br><span class="line">            RemotingCommand.createResponseCommand(RemotingSysResponseCode.REQUEST_CODE_NOT_SUPPORTED, error);</span><br><span class="line">        response.setOpaque(opaque);</span><br><span class="line">        ctx.writeAndFlush(response);</span><br><span class="line">        log.error(RemotingHelper.parseChannelRemoteAddr(ctx.channel()) + error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DefaultRequestProcessor的processRequest方法"><a href="#4、DefaultRequestProcessor的processRequest方法" class="headerlink" title="4、DefaultRequestProcessor的processRequest方法"></a>4、DefaultRequestProcessor的processRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public RemotingCommand processRequest(ChannelHandlerContext ctx,</span><br><span class="line">    RemotingCommand request) throws RemotingCommandException &#123;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;receive request, &#123;&#125; &#123;&#125; &#123;&#125;&quot;,</span><br><span class="line">            request.getCode(),</span><br><span class="line">            RemotingHelper.parseChannelRemoteAddr(ctx.channel()),</span><br><span class="line">            request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (request.getCode()) &#123;</span><br><span class="line">        case RequestCode.PUT_KV_CONFIG:</span><br><span class="line">            return this.putKVConfig(ctx, request);</span><br><span class="line">        case RequestCode.GET_KV_CONFIG:</span><br><span class="line">            return this.getKVConfig(ctx, request);</span><br><span class="line">        case RequestCode.DELETE_KV_CONFIG:</span><br><span class="line">            return this.deleteKVConfig(ctx, request);</span><br><span class="line">        //注册borker信息</span><br><span class="line">        case RequestCode.REGISTER_BROKER:</span><br><span class="line">            Version brokerVersion = MQVersion.value2Version(request.getVersion());</span><br><span class="line">            if (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;</span><br><span class="line">                return this.registerBrokerWithFilterServer(ctx, request);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return this.registerBroker(ctx, request);</span><br><span class="line">            &#125;</span><br><span class="line">        //注销broker</span><br><span class="line">        case RequestCode.UNREGISTER_BROKER:</span><br><span class="line">            return this.unregisterBroker(ctx, request);</span><br><span class="line">        //根据topic获取路由信息，在producer发送消息和consumer在pull消息的时候的时候会从nameServer中获取</span><br><span class="line">        case RequestCode.GET_ROUTEINTO_BY_TOPIC:</span><br><span class="line">            return this.getRouteInfoByTopic(ctx, request);</span><br><span class="line">        case RequestCode.GET_BROKER_CLUSTER_INFO:</span><br><span class="line">            return this.getBrokerClusterInfo(ctx, request);</span><br><span class="line">        case RequestCode.WIPE_WRITE_PERM_OF_BROKER:</span><br><span class="line">            return this.wipeWritePermOfBroker(ctx, request);</span><br><span class="line">        case RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER:</span><br><span class="line">            return getAllTopicListFromNameserver(ctx, request);</span><br><span class="line">        case RequestCode.DELETE_TOPIC_IN_NAMESRV:</span><br><span class="line">            return deleteTopicInNamesrv(ctx, request);</span><br><span class="line">        case RequestCode.GET_KVLIST_BY_NAMESPACE:</span><br><span class="line">            return this.getKVListByNamespace(ctx, request);</span><br><span class="line">        case RequestCode.GET_TOPICS_BY_CLUSTER:</span><br><span class="line">            return this.getTopicsByCluster(ctx, request);</span><br><span class="line">        case RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:</span><br><span class="line">            return this.getSystemTopicListFromNs(ctx, request);</span><br><span class="line">        case RequestCode.GET_UNIT_TOPIC_LIST:</span><br><span class="line">            return this.getUnitTopicList(ctx, request);</span><br><span class="line">        case RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:</span><br><span class="line">            return this.getHasUnitSubTopicList(ctx, request);</span><br><span class="line">        case RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:</span><br><span class="line">            return this.getHasUnitSubUnUnitTopicList(ctx, request);</span><br><span class="line">        case RequestCode.UPDATE_NAMESRV_CONFIG:</span><br><span class="line">            return this.updateConfig(ctx, request);</span><br><span class="line">        case RequestCode.GET_NAMESRV_CONFIG:</span><br><span class="line">            return this.getConfig(ctx, request);</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、DefaultRequestProcessor的registerBroker方法"><a href="#5、DefaultRequestProcessor的registerBroker方法" class="headerlink" title="5、DefaultRequestProcessor的registerBroker方法"></a>5、DefaultRequestProcessor的registerBroker方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public RemotingCommand registerBroker(ChannelHandlerContext ctx,</span><br><span class="line">    RemotingCommand request) throws RemotingCommandException &#123;</span><br><span class="line">    //创建返回</span><br><span class="line">    final RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);</span><br><span class="line">    //创建返回头</span><br><span class="line">    final RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();</span><br><span class="line">    //解析请求头</span><br><span class="line">    final RegisterBrokerRequestHeader requestHeader =</span><br><span class="line">        (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);</span><br><span class="line">    TopicConfigSerializeWrapper topicConfigWrapper;</span><br><span class="line">    //解析请求体</span><br><span class="line">    if (request.getBody() != null) &#123;</span><br><span class="line">        topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper.class);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        topicConfigWrapper = new TopicConfigSerializeWrapper();</span><br><span class="line">        topicConfigWrapper.getDataVersion().setCounter(new AtomicLong(0));</span><br><span class="line">        topicConfigWrapper.getDataVersion().setTimestamp(0);</span><br><span class="line">    &#125;</span><br><span class="line">    //向RouteInfoManager中注册Broker</span><br><span class="line">    RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker(</span><br><span class="line">        requestHeader.getClusterName(),</span><br><span class="line">        requestHeader.getBrokerAddr(),</span><br><span class="line">        requestHeader.getBrokerName(),</span><br><span class="line">        requestHeader.getBrokerId(),</span><br><span class="line">        requestHeader.getHaServerAddr(),</span><br><span class="line">        topicConfigWrapper,</span><br><span class="line">        null,</span><br><span class="line">        ctx.channel()</span><br><span class="line">    );</span><br><span class="line">    //设置haServerAddr、masterAddr信息</span><br><span class="line">    responseHeader.setHaServerAddr(result.getHaServerAddr());</span><br><span class="line">    responseHeader.setMasterAddr(result.getMasterAddr());</span><br><span class="line"></span><br><span class="line">    byte[] jsonValue = this.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);</span><br><span class="line">    response.setBody(jsonValue);</span><br><span class="line">    response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">    response.setRemark(null);</span><br><span class="line">    return response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、DefaultRequestProcessor的registerBroker方法"><a href="#6、DefaultRequestProcessor的registerBroker方法" class="headerlink" title="6、DefaultRequestProcessor的registerBroker方法"></a>6、DefaultRequestProcessor的registerBroker方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">public RegisterBrokerResult registerBroker(</span><br><span class="line">    final String clusterName,</span><br><span class="line">    final String brokerAddr,</span><br><span class="line">    final String brokerName,</span><br><span class="line">    final long brokerId,</span><br><span class="line">    final String haServerAddr,</span><br><span class="line">    final TopicConfigSerializeWrapper topicConfigWrapper,</span><br><span class="line">    final List&lt;String&gt; filterServerList,</span><br><span class="line">    final Channel channel) &#123;</span><br><span class="line">    RegisterBrokerResult result = new RegisterBrokerResult();</span><br><span class="line">    try &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.lock.writeLock().lockInterruptibly();</span><br><span class="line">            //更新集群信息（根据集群名字，获取当前集群下面的所有brokerName）</span><br><span class="line">            Set&lt;String&gt; brokerNames = this.clusterAddrTable.get(clusterName);</span><br><span class="line">            if (null == brokerNames) &#123;</span><br><span class="line">                brokerNames = new HashSet&lt;String&gt;();</span><br><span class="line">                this.clusterAddrTable.put(clusterName, brokerNames);</span><br><span class="line">            &#125;</span><br><span class="line">            brokerNames.add(brokerName);</span><br><span class="line"></span><br><span class="line">            boolean registerFirst = false;</span><br><span class="line">            //更新主备信息（在brokerAddrTable中获取所有的brokerDAte）</span><br><span class="line">            BrokerData brokerData = this.brokerAddrTable.get(brokerName);</span><br><span class="line">            if (null == brokerData) &#123;</span><br><span class="line">                registerFirst = true;</span><br><span class="line">                brokerData = new BrokerData(clusterName, brokerName, new HashMap&lt;Long, String&gt;());</span><br><span class="line">                this.brokerAddrTable.put(brokerName, brokerData);</span><br><span class="line">            &#125;</span><br><span class="line">            //通过BrokerId区分主备</span><br><span class="line">            String oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);</span><br><span class="line">            registerFirst = registerFirst || (null == oldAddr);</span><br><span class="line">            //topic的配置不为空，且该Broker是主用（即 brokerId=0）</span><br><span class="line">            if (null != topicConfigWrapper &amp;&amp; MixAll.MASTER_ID == brokerId) &#123;</span><br><span class="line">                //如果Topic配置信息发生变更或者该broker为第一次注册</span><br><span class="line">                if (this.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion())</span><br><span class="line">                    || registerFirst) &#123;</span><br><span class="line">                    // 获取所有topic信息</span><br><span class="line">                    ConcurrentMap&lt;String, TopicConfig&gt; tcTable = topicConfigWrapper.getTopicConfigTable();</span><br><span class="line">                    if (tcTable != null) &#123;</span><br><span class="line">                        //遍历所有Topic</span><br><span class="line">                        for (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) &#123;</span><br><span class="line">                            //根据brokername将topicconfig（read、write queue数量等）新增或者更新到topicQueueTable中</span><br><span class="line">                            this.createAndUpdateQueueData(brokerName, entry.getValue());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //更新最后变更时间（将brokerLiveTable中保存的对应的broker的更新时间戳，设置为当前时间）</span><br><span class="line">            BrokerLiveInfo prevBrokerLiveInfo = this.brokerLiveTable.put(brokerAddr,</span><br><span class="line">                new BrokerLiveInfo(</span><br><span class="line">                    System.currentTimeMillis(),</span><br><span class="line">                    topicConfigWrapper.getDataVersion(),</span><br><span class="line">                    channel,</span><br><span class="line">                    haServerAddr));</span><br><span class="line">            if (null == prevBrokerLiveInfo) &#123;</span><br><span class="line">                log.info(&quot;new broker registered, &#123;&#125; HAServer: &#123;&#125;&quot;, brokerAddr, haServerAddr);</span><br><span class="line">            &#125;</span><br><span class="line">            //更新Filter Server列表</span><br><span class="line">            if (filterServerList != null) &#123;</span><br><span class="line">                if (filterServerList.isEmpty()) &#123;</span><br><span class="line">                    this.filterServerTable.remove(brokerAddr);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    this.filterServerTable.put(brokerAddr, filterServerList);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //如果当前broker为slave节点，则将haServerAddr、masterAddr等信息设置到result返回值中</span><br><span class="line">            if (MixAll.MASTER_ID != brokerId) &#123;</span><br><span class="line">                String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);</span><br><span class="line">                if (masterAddr != null) &#123;</span><br><span class="line">                    BrokerLiveInfo brokerLiveInfo = this.brokerLiveTable.get(masterAddr);</span><br><span class="line">                    if (brokerLiveInfo != null) &#123;</span><br><span class="line">                        result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());</span><br><span class="line">                        result.setMasterAddr(masterAddr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;registerBroker Exception&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（二、4）DefaultRequestProcessor的getRouteInfoByTopic方法"><a href="#7、接（二、4）DefaultRequestProcessor的getRouteInfoByTopic方法" class="headerlink" title="7、接（二、4）DefaultRequestProcessor的getRouteInfoByTopic方法"></a>7、接（二、4）DefaultRequestProcessor的getRouteInfoByTopic方法</h4><p>获取topic路由信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public RemotingCommand getRouteInfoByTopic(ChannelHandlerContext ctx,</span><br><span class="line">    RemotingCommand request) throws RemotingCommandException &#123;</span><br><span class="line">    final RemotingCommand response = RemotingCommand.createResponseCommand(null);</span><br><span class="line">    final GetRouteInfoRequestHeader requestHeader =</span><br><span class="line">        (GetRouteInfoRequestHeader) request.decodeCommandCustomHeader(GetRouteInfoRequestHeader.class);</span><br><span class="line">    //获取topic路由信息</span><br><span class="line">    TopicRouteData topicRouteData = this.namesrvController.getRouteInfoManager().pickupTopicRouteData(requestHeader.getTopic());</span><br><span class="line">    </span><br><span class="line">    if (topicRouteData != null) &#123;</span><br><span class="line">        //设置orderTopicConf</span><br><span class="line">        if (this.namesrvController.getNamesrvConfig().isOrderMessageEnable()) &#123;</span><br><span class="line">            String orderTopicConf =</span><br><span class="line">                this.namesrvController.getKvConfigManager().getKVConfig(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG,</span><br><span class="line">                    requestHeader.getTopic());</span><br><span class="line">            topicRouteData.setOrderTopicConf(orderTopicConf);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        byte[] content = topicRouteData.encode();</span><br><span class="line">        response.setBody(content);</span><br><span class="line">        response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">        response.setRemark(null);</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //不存在topic路由信息</span><br><span class="line">    response.setCode(ResponseCode.TOPIC_NOT_EXIST);</span><br><span class="line">    response.setRemark(&quot;No topic route info in name server for the topic: &quot; + requestHeader.getTopic()</span><br><span class="line">        + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));</span><br><span class="line">    return response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="8、RouteInfoManager的pickupTopicRouteData方法"><a href="#8、RouteInfoManager的pickupTopicRouteData方法" class="headerlink" title="8、RouteInfoManager的pickupTopicRouteData方法"></a>8、RouteInfoManager的pickupTopicRouteData方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public TopicRouteData pickupTopicRouteData(final String topic) &#123;</span><br><span class="line">    TopicRouteData topicRouteData = new TopicRouteData();</span><br><span class="line">    boolean foundQueueData = false;</span><br><span class="line">    boolean foundBrokerData = false;</span><br><span class="line">    Set&lt;String&gt; brokerNameSet = new HashSet&lt;String&gt;();</span><br><span class="line">    List&lt;BrokerData&gt; brokerDataList = new LinkedList&lt;BrokerData&gt;();</span><br><span class="line">    topicRouteData.setBrokerDatas(brokerDataList);</span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, List&lt;String&gt;&gt; filterServerMap = new HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">    topicRouteData.setFilterServerTable(filterServerMap);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.lock.readLock().lockInterruptibly();</span><br><span class="line">            //获取topic路由信息集合</span><br><span class="line">            List&lt;QueueData&gt; queueDataList = this.topicQueueTable.get(topic);</span><br><span class="line">            if (queueDataList != null) &#123;</span><br><span class="line">                topicRouteData.setQueueDatas(queueDataList);</span><br><span class="line">                foundQueueData = true;</span><br><span class="line"></span><br><span class="line">                Iterator&lt;QueueData&gt; it = queueDataList.iterator();</span><br><span class="line">                while (it.hasNext()) &#123;</span><br><span class="line">                    QueueData qd = it.next();</span><br><span class="line">                    brokerNameSet.add(qd.getBrokerName());</span><br><span class="line">                &#125;</span><br><span class="line">                //遍历topic所在的brokerName，设置brokerData及filterServer</span><br><span class="line">                for (String brokerName : brokerNameSet) &#123;</span><br><span class="line">                    BrokerData brokerData = this.brokerAddrTable.get(brokerName);</span><br><span class="line">                    if (null != brokerData) &#123;</span><br><span class="line">                        BrokerData brokerDataClone = new BrokerData(brokerData.getCluster(), brokerData.getBrokerName(), (HashMap&lt;Long, String&gt;) brokerData</span><br><span class="line">                            .getBrokerAddrs().clone());</span><br><span class="line">                        brokerDataList.add(brokerDataClone);</span><br><span class="line">                        foundBrokerData = true;</span><br><span class="line">                        for (final String brokerAddr : brokerDataClone.getBrokerAddrs().values()) &#123;</span><br><span class="line">                            List&lt;String&gt; filterServerList = this.filterServerTable.get(brokerAddr);</span><br><span class="line">                            filterServerMap.put(brokerAddr, filterServerList);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.lock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;pickupTopicRouteData Exception&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;pickupTopicRouteData &#123;&#125; &#123;&#125;&quot;, topic, topicRouteData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (foundBrokerData &amp;&amp; foundQueueData) &#123;</span><br><span class="line">        return topicRouteData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>