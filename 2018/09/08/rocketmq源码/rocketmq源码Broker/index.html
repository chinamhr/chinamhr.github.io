<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="一、Broker启动过程1、BrokerStartup的main方法1234public static void main(String[] args) &amp;#123;    //创建BrokerController并启动    start(createBrokerController(args));"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="rocketmq源码Broker"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="一、Broker启动过程1、BrokerStartup的main方法1234public static void main(String[] args) &amp;#123;    //创建BrokerController并启动    start(createBrokerController(args));"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>rocketmq源码Broker - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>rocketmq源码Broker</h1>
                    
                    <h2 class="post-subheading">
                        Broker启动、接受/拉取消息、主从同步
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-09-08
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/rocketmq/">rocketmq</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="一、Broker启动过程"><a href="#一、Broker启动过程" class="headerlink" title="一、Broker启动过程"></a>一、Broker启动过程</h3><h4 id="1、BrokerStartup的main方法"><a href="#1、BrokerStartup的main方法" class="headerlink" title="1、BrokerStartup的main方法"></a>1、BrokerStartup的main方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    //创建BrokerController并启动</span><br><span class="line">    start(createBrokerController(args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、BrokerStartup的createBrokerController方法"><a href="#2、BrokerStartup的createBrokerController方法" class="headerlink" title="2、BrokerStartup的createBrokerController方法"></a>2、BrokerStartup的createBrokerController方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">public static BrokerController createBrokerController(String[] args) &#123;</span><br><span class="line">    System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line"></span><br><span class="line">    if (null == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_SNDBUF_SIZE)) &#123;</span><br><span class="line">        NettySystemConfig.socketSndbufSize = 131072;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (null == System.getProperty(NettySystemConfig.COM_ROCKETMQ_REMOTING_SOCKET_RCVBUF_SIZE)) &#123;</span><br><span class="line">        NettySystemConfig.socketRcvbufSize = 131072;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //PackageConflictDetect.detectFastjson();</span><br><span class="line">        Options options = ServerUtil.buildCommandlineOptions(new Options());</span><br><span class="line">        commandLine = ServerUtil.parseCmdLine(&quot;mqbroker&quot;, args, buildCommandlineOptions(options),</span><br><span class="line">            new PosixParser());</span><br><span class="line">        if (null == commandLine) &#123;</span><br><span class="line">            System.exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final BrokerConfig brokerConfig = new BrokerConfig();</span><br><span class="line">        final NettyServerConfig nettyServerConfig = new NettyServerConfig();</span><br><span class="line">        final NettyClientConfig nettyClientConfig = new NettyClientConfig();</span><br><span class="line"></span><br><span class="line">        nettyClientConfig.setUseTLS(Boolean.parseBoolean(System.getProperty(TLS_ENABLE,</span><br><span class="line">            String.valueOf(TlsSystemConfig.tlsMode == TlsMode.ENFORCING))));</span><br><span class="line">        //设置监听端口为10911</span><br><span class="line">        nettyServerConfig.setListenPort(10911);</span><br><span class="line">        final MessageStoreConfig messageStoreConfig = new MessageStoreConfig();</span><br><span class="line"></span><br><span class="line">        if (BrokerRole.SLAVE == messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">            int ratio = messageStoreConfig.getAccessMessageInMemoryMaxRatio() - 10;</span><br><span class="line">            messageStoreConfig.setAccessMessageInMemoryMaxRatio(ratio);</span><br><span class="line">        &#125;</span><br><span class="line">        //判断是否有-c参数，如果有-c参数，后面一般带的是Broker启动脚本文件，那么就可以解析Broker启动配置文件</span><br><span class="line">        if (commandLine.hasOption(&apos;c&apos;)) &#123;</span><br><span class="line">            String file = commandLine.getOptionValue(&apos;c&apos;);</span><br><span class="line">            if (file != null) &#123;</span><br><span class="line">                configFile = file;</span><br><span class="line">                InputStream in = new BufferedInputStream(new FileInputStream(file));</span><br><span class="line">                properties = new Properties();</span><br><span class="line">                properties.load(in);</span><br><span class="line"></span><br><span class="line">                properties2SystemEnv(properties);</span><br><span class="line">                MixAll.properties2Object(properties, brokerConfig);</span><br><span class="line">                MixAll.properties2Object(properties, nettyServerConfig);</span><br><span class="line">                MixAll.properties2Object(properties, nettyClientConfig);</span><br><span class="line">                MixAll.properties2Object(properties, messageStoreConfig);</span><br><span class="line"></span><br><span class="line">                BrokerPathConfigHelper.setBrokerConfigPath(file);</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MixAll.properties2Object(ServerUtil.commandLine2Properties(commandLine), brokerConfig);</span><br><span class="line"></span><br><span class="line">        if (null == brokerConfig.getRocketmqHome()) &#123;</span><br><span class="line">            System.out.printf(&quot;Please set the &quot; + MixAll.ROCKETMQ_HOME_ENV</span><br><span class="line">                + &quot; variable in your environment to match the location of the RocketMQ installation&quot;);</span><br><span class="line">            System.exit(-2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String namesrvAddr = brokerConfig.getNamesrvAddr();</span><br><span class="line">        if (null != namesrvAddr) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                String[] addrArray = namesrvAddr.split(&quot;;&quot;);</span><br><span class="line">                for (String addr : addrArray) &#123;</span><br><span class="line">                    RemotingUtil.string2SocketAddress(addr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                System.out.printf(</span><br><span class="line">                    &quot;The Name Server Address[%s] illegal, please set it as follows, \&quot;127.0.0.1:9876;192.168.0.1:9876\&quot;%n&quot;,</span><br><span class="line">                    namesrvAddr);</span><br><span class="line">                System.exit(-3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        switch (messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">            case ASYNC_MASTER:</span><br><span class="line">            case SYNC_MASTER:</span><br><span class="line">                brokerConfig.setBrokerId(MixAll.MASTER_ID);</span><br><span class="line">                break;</span><br><span class="line">            case SLAVE:</span><br><span class="line">                if (brokerConfig.getBrokerId() &lt;= 0) &#123;</span><br><span class="line">                    System.out.printf(&quot;Slave&apos;s brokerId must be &gt; 0&quot;);</span><br><span class="line">                    System.exit(-3);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置服务端口为10912</span><br><span class="line">        messageStoreConfig.setHaListenPort(nettyServerConfig.getListenPort() + 1);</span><br><span class="line">        LoggerContext lc = (LoggerContext) LoggerFactory.getILoggerFactory();</span><br><span class="line">        JoranConfigurator configurator = new JoranConfigurator();</span><br><span class="line">        configurator.setContext(lc);</span><br><span class="line">        lc.reset();</span><br><span class="line">        configurator.doConfigure(brokerConfig.getRocketmqHome() + &quot;/conf/logback_broker.xml&quot;);</span><br><span class="line"></span><br><span class="line">        if (commandLine.hasOption(&apos;p&apos;)) &#123;</span><br><span class="line">            Logger console = LoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">            MixAll.printObjectProperties(console, brokerConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyServerConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyClientConfig);</span><br><span class="line">            MixAll.printObjectProperties(console, messageStoreConfig);</span><br><span class="line">            System.exit(0);</span><br><span class="line">        &#125; else if (commandLine.hasOption(&apos;m&apos;)) &#123;</span><br><span class="line">            Logger console = LoggerFactory.getLogger(LoggerName.BROKER_CONSOLE_NAME);</span><br><span class="line">            MixAll.printObjectProperties(console, brokerConfig, true);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyServerConfig, true);</span><br><span class="line">            MixAll.printObjectProperties(console, nettyClientConfig, true);</span><br><span class="line">            MixAll.printObjectProperties(console, messageStoreConfig, true);</span><br><span class="line">            System.exit(0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</span><br><span class="line">        MixAll.printObjectProperties(log, brokerConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyServerConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, nettyClientConfig);</span><br><span class="line">        MixAll.printObjectProperties(log, messageStoreConfig);</span><br><span class="line">        //创建BrokerController</span><br><span class="line">        final BrokerController controller = new BrokerController(</span><br><span class="line">            brokerConfig,</span><br><span class="line">            nettyServerConfig,</span><br><span class="line">            nettyClientConfig,</span><br><span class="line">            messageStoreConfig);</span><br><span class="line">        // remember all configs to prevent discard</span><br><span class="line">        controller.getConfiguration().registerConfig(properties);</span><br><span class="line">        //初始化controller</span><br><span class="line">        boolean initResult = controller.initialize();</span><br><span class="line">        if (!initResult) &#123;</span><br><span class="line">            controller.shutdown();</span><br><span class="line">            System.exit(-3);</span><br><span class="line">        &#125;</span><br><span class="line">        //设置进程退出钩子</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() &#123;</span><br><span class="line">            private volatile boolean hasShutdown = false;</span><br><span class="line">            private AtomicInteger shutdownTimes = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                synchronized (this) &#123;</span><br><span class="line">                    log.info(&quot;Shutdown hook was invoked, &#123;&#125;&quot;, this.shutdownTimes.incrementAndGet());</span><br><span class="line">                    if (!this.hasShutdown) &#123;</span><br><span class="line">                        this.hasShutdown = true;</span><br><span class="line">                        long beginTime = System.currentTimeMillis();</span><br><span class="line">                        controller.shutdown();</span><br><span class="line">                        long consumingTimeTotal = System.currentTimeMillis() - beginTime;</span><br><span class="line">                        log.info(&quot;Shutdown hook over, consuming total time(ms): &#123;&#125;&quot;, consumingTimeTotal);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, &quot;ShutdownHook&quot;));</span><br><span class="line"></span><br><span class="line">        return controller;</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、实例化BrokerController"><a href="#3、实例化BrokerController" class="headerlink" title="3、实例化BrokerController"></a>3、实例化BrokerController</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public BrokerController(</span><br><span class="line">            final BrokerConfig brokerConfig,</span><br><span class="line">            final NettyServerConfig nettyServerConfig,</span><br><span class="line">            final NettyClientConfig nettyClientConfig,</span><br><span class="line">            final MessageStoreConfig messageStoreConfig</span><br><span class="line">        ) &#123;</span><br><span class="line">    //broker服务器配置</span><br><span class="line">    this.brokerConfig = brokerConfig;</span><br><span class="line">    //通信层配置</span><br><span class="line">    this.nettyServerConfig = nettyServerConfig;</span><br><span class="line">    this.nettyClientConfig = nettyClientConfig;</span><br><span class="line">    //消息存储器配置</span><br><span class="line">    this.messageStoreConfig = messageStoreConfig;</span><br><span class="line">    //消费进度管理器</span><br><span class="line">    this.consumerOffsetManager = new ConsumerOffsetManager(this);</span><br><span class="line">    //topic配置管理器</span><br><span class="line">    this.topicConfigManager = new TopicConfigManager(this);</span><br><span class="line">    this.pullMessageProcessor = new PullMessageProcessor(this);</span><br><span class="line">    this.pullRequestHoldService = new PullRequestHoldService(this);</span><br><span class="line">    this.messageArrivingListener = new NotifyMessageArrivingListener(this.pullRequestHoldService);</span><br><span class="line">    //订阅组内成员发生变化，立刻通知所有成员</span><br><span class="line">    this.consumerIdsChangeListener = new DefaultConsumerIdsChangeListener(this);</span><br><span class="line">    //Consumer连接、订阅关系管理</span><br><span class="line">    this.consumerManager = new ConsumerManager(this.consumerIdsChangeListener);</span><br><span class="line">    this.consumerFilterManager = new ConsumerFilterManager(this);</span><br><span class="line">    //Producer连接管理</span><br><span class="line">    this.producerManager = new ProducerManager();</span><br><span class="line">    this.clientHousekeepingService = new ClientHousekeepingService(this);</span><br><span class="line">     </span><br><span class="line">    this.broker2Client = new Broker2Client(this);</span><br><span class="line">    //订阅组配置管理</span><br><span class="line">    this.subscriptionGroupManager = new SubscriptionGroupManager(this);</span><br><span class="line">    //Broker的netty客户端,与注册中心通信</span><br><span class="line">    this.brokerOuterAPI = new BrokerOuterAPI(nettyClientConfig);</span><br><span class="line">    //FilterServer管理</span><br><span class="line">    this.filterServerManager = new FilterServerManager(this);</span><br><span class="line">    //Slave定期从Master同步信息</span><br><span class="line">    this.slaveSynchronize = new SlaveSynchronize(this);</span><br><span class="line">    //对消息写入进行流控</span><br><span class="line">    this.sendThreadPoolQueue = new LinkedBlockingQueue&lt;Runnable&gt;(this.brokerConfig.getSendThreadPoolQueueCapacity());</span><br><span class="line">    //对消息读取进行流控</span><br><span class="line">    this.pullThreadPoolQueue = new LinkedBlockingQueue&lt;Runnable&gt;(this.brokerConfig.getPullThreadPoolQueueCapacity());</span><br><span class="line">    this.queryThreadPoolQueue = new LinkedBlockingQueue&lt;Runnable&gt;(this.brokerConfig.getQueryThreadPoolQueueCapacity());</span><br><span class="line">    this.clientManagerThreadPoolQueue = new LinkedBlockingQueue&lt;Runnable&gt;(this.brokerConfig.getClientManagerThreadPoolQueueCapacity());</span><br><span class="line">    this.consumerManagerThreadPoolQueue = new LinkedBlockingQueue&lt;Runnable&gt;(this.brokerConfig.getConsumerManagerThreadPoolQueueCapacity());</span><br><span class="line"></span><br><span class="line">    this.brokerStatsManager = new BrokerStatsManager(this.brokerConfig.getBrokerClusterName());</span><br><span class="line">    this.setStoreHost(new InetSocketAddress(this.getBrokerConfig().getBrokerIP1(), this.getNettyServerConfig().getListenPort()));</span><br><span class="line"></span><br><span class="line">    this.brokerFastFailure = new BrokerFastFailure(this);</span><br><span class="line">    this.configuration = new Configuration(</span><br><span class="line">        log,</span><br><span class="line">        BrokerPathConfigHelper.getBrokerConfigPath(),</span><br><span class="line">        this.brokerConfig, this.nettyServerConfig, this.nettyClientConfig, this.messageStoreConfig</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、接-一、2-BrokerController的initialize方法"><a href="#4、接-一、2-BrokerController的initialize方法" class="headerlink" title="4、接(一、2)BrokerController的initialize方法"></a>4、接(一、2)BrokerController的initialize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">public boolean initialize() throws CloneNotSupportedException &#123;</span><br><span class="line">    //加载Topic配置，默认在根目录/store/config/topics.json中</span><br><span class="line">    boolean result = this.topicConfigManager.load();</span><br><span class="line">    //加载Consumer Offset</span><br><span class="line">    result = result &amp;&amp; this.consumerOffsetManager.load();</span><br><span class="line">    //加载Consumer subscription</span><br><span class="line">    result = result &amp;&amp; this.subscriptionGroupManager.load();</span><br><span class="line">    //加载Consumer Filter</span><br><span class="line">    result = result &amp;&amp; this.consumerFilterManager.load();</span><br><span class="line"></span><br><span class="line">    if (result) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //初始化消息存储器</span><br><span class="line">            this.messageStore =</span><br><span class="line">                new DefaultMessageStore(this.messageStoreConfig, this.brokerStatsManager, this.messageArrivingListener,</span><br><span class="line">                    this.brokerConfig);</span><br><span class="line">            this.brokerStats = new BrokerStats((DefaultMessageStore) this.messageStore);</span><br><span class="line">            //load plugin</span><br><span class="line">            MessageStorePluginContext context = new MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">            this.messageStore = MessageStoreFactory.build(context, this.messageStore);</span><br><span class="line">            this.messageStore.getDispatcherList().addFirst(new CommitLogDispatcherCalcBitMap(this.brokerConfig, this.consumerFilterManager));</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            result = false;</span><br><span class="line">            log.error(&quot;Failed to initialize&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //加载本地消息数据</span><br><span class="line">    result = result &amp;&amp; this.messageStore.load();</span><br><span class="line"></span><br><span class="line">    if (result) &#123;</span><br><span class="line">        //初始化netty服务器</span><br><span class="line">        this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.clientHousekeepingService);</span><br><span class="line">        //初始化vip通道 fastRemotingServer 10909端口</span><br><span class="line">        NettyServerConfig fastConfig = (NettyServerConfig) this.nettyServerConfig.clone();</span><br><span class="line">        fastConfig.setListenPort(nettyServerConfig.getListenPort() - 2);</span><br><span class="line">        this.fastRemotingServer = new NettyRemotingServer(fastConfig, this.clientHousekeepingService);</span><br><span class="line">        //初始化线程池</span><br><span class="line">        this.sendMessageExecutor = new BrokerFixedThreadPoolExecutor(</span><br><span class="line">            this.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">            this.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">            1000 * 60,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            this.sendThreadPoolQueue,</span><br><span class="line">            new ThreadFactoryImpl(&quot;SendMessageThread_&quot;));</span><br><span class="line"></span><br><span class="line">        this.pullMessageExecutor = new BrokerFixedThreadPoolExecutor(</span><br><span class="line">            this.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">            this.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">            1000 * 60,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            this.pullThreadPoolQueue,</span><br><span class="line">            new ThreadFactoryImpl(&quot;PullMessageThread_&quot;));</span><br><span class="line"></span><br><span class="line">        this.queryMessageExecutor = new BrokerFixedThreadPoolExecutor(</span><br><span class="line">            this.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">            this.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">            1000 * 60,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            this.queryThreadPoolQueue,</span><br><span class="line">            new ThreadFactoryImpl(&quot;QueryMessageThread_&quot;));</span><br><span class="line"></span><br><span class="line">        this.adminBrokerExecutor =</span><br><span class="line">            Executors.newFixedThreadPool(this.brokerConfig.getAdminBrokerThreadPoolNums(), new ThreadFactoryImpl(</span><br><span class="line">                &quot;AdminBrokerThread_&quot;));</span><br><span class="line"></span><br><span class="line">        this.clientManageExecutor = new ThreadPoolExecutor(</span><br><span class="line">            this.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">            this.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">            1000 * 60,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            this.clientManagerThreadPoolQueue,</span><br><span class="line">            new ThreadFactoryImpl(&quot;ClientManageThread_&quot;));</span><br><span class="line"></span><br><span class="line">        this.consumerManageExecutor =</span><br><span class="line">            Executors.newFixedThreadPool(this.brokerConfig.getConsumerManageThreadPoolNums(), new ThreadFactoryImpl(</span><br><span class="line">                &quot;ConsumerManageThread_&quot;));</span><br><span class="line">        //注册处理器</span><br><span class="line">        this.registerProcessor();</span><br><span class="line">        //每天凌晨00:00:00统计消息量</span><br><span class="line">        final long initialDelay = UtilAll.computNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line">        final long period = 1000 * 60 * 60 * 24;</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    BrokerController.this.getBrokerStats().record();</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;schedule record error.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line">        //定时持久化消费进度</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    BrokerController.this.consumerOffsetManager.persist();</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;schedule persist consumerOffset error.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 1000 * 10, this.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">        //持久化comsumer fileter</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    BrokerController.this.consumerFilterManager.persist();</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;schedule persist consumer filter error.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 1000 * 10, 1000 * 10, TimeUnit.MILLISECONDS);</span><br><span class="line">        //定时清理消费太慢的消费者，以保护Broker</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    BrokerController.this.protectBroker();</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;protectBroker error.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 3, 3, TimeUnit.MINUTES);</span><br><span class="line">        //打印发送消费线程运行状态</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    BrokerController.this.printWaterMark();</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;printWaterMark error.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 10, 1, TimeUnit.SECONDS);</span><br><span class="line">        //打印分发消息比接收消息延迟多少</span><br><span class="line">        this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    log.info(&quot;dispatch behind commit log &#123;&#125; bytes&quot;, BrokerController.this.getMessageStore().dispatchBehindBytes());</span><br><span class="line">                &#125; catch (Throwable e) &#123;</span><br><span class="line">                    log.error(&quot;schedule dispatchBehindBytes error.&quot;, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, 1000 * 10, 1000 * 60, TimeUnit.MILLISECONDS);</span><br><span class="line">        //定时获取Namesrv地址</span><br><span class="line">        if (this.brokerConfig.getNamesrvAddr() != null) &#123;</span><br><span class="line">            this.brokerOuterAPI.updateNameServerAddressList(this.brokerConfig.getNamesrvAddr());</span><br><span class="line">            log.info(&quot;Set user specified name server address: &#123;&#125;&quot;, this.brokerConfig.getNamesrvAddr());</span><br><span class="line">        &#125; else if (this.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">            this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        BrokerController.this.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                    &#125; catch (Throwable e) &#123;</span><br><span class="line">                        log.error(&quot;ScheduledTask fetchNameServerAddr exception&quot;, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, 1000 * 10, 1000 * 60 * 2, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        //如果当前broker是slave，那么定时从master同步消息；如果是master，那么定时打印slave和master差别。</span><br><span class="line">        if (BrokerRole.SLAVE == this.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">            if (this.messageStoreConfig.getHaMasterAddress() != null &amp;&amp; this.messageStoreConfig.getHaMasterAddress().length() &gt;= 6) &#123;</span><br><span class="line">                this.messageStore.updateHaMasterAddress(this.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                this.updateMasterHAServerAddrPeriodically = false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.updateMasterHAServerAddrPeriodically = true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        //从Master同步信息</span><br><span class="line">                        BrokerController.this.slaveSynchronize.syncAll();</span><br><span class="line">                    &#125; catch (Throwable e) &#123;</span><br><span class="line">                        log.error(&quot;ScheduledTask syncAll slave exception&quot;, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, 1000 * 10, 1000 * 60, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        BrokerController.this.printMasterAndSlaveDiff();</span><br><span class="line">                    &#125; catch (Throwable e) &#123;</span><br><span class="line">                        log.error(&quot;schedule printMasterAndSlaveDiff error.&quot;, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, 1000 * 10, 1000 * 60, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>topics.json示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;dataVersion&quot;:&#123;</span><br><span class="line">        &quot;counter&quot;:2,</span><br><span class="line">        &quot;timestatmp&quot;:1393729865073</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;topicConfigTable&quot;:&#123;</span><br><span class="line">        &quot;TopicTest&quot;:&#123;</span><br><span class="line">            &quot;perm&quot;:6, // 100 读权限 , 10 写权限 6 是 110 读写权限</span><br><span class="line">            &quot;readQueueNums&quot;:8,</span><br><span class="line">            &quot;topicFilterType&quot;:&quot;SINGLE_TAG&quot;,</span><br><span class="line">            &quot;topicName&quot;:&quot;TopicTest&quot;,</span><br><span class="line">            &quot;writeQueueNums&quot;:8</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5、DefaultMessageStore的load方法"><a href="#5、DefaultMessageStore的load方法" class="headerlink" title="5、DefaultMessageStore的load方法"></a>5、DefaultMessageStore的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public boolean load() &#123;</span><br><span class="line">    boolean result = true;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //是否存在零时文件，$HOME/store/abort</span><br><span class="line">        boolean lastExitOK = !this.isTempFileExist();</span><br><span class="line">        log.info(&quot;last shutdown &#123;&#125;&quot;, lastExitOK ? &quot;normally&quot; : &quot;abnormally&quot;);</span><br><span class="line"></span><br><span class="line">        //加载延时消息，$HOME/store/config/delayOffset.json</span><br><span class="line">        if (null != scheduleMessageService) &#123;</span><br><span class="line">            result = result &amp;&amp; this.scheduleMessageService.load();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // load Commit Log</span><br><span class="line">        //加载物理消息， $HOME\store\commitlog\$&#123;fileName&#125;.每个文件的大小默认为1G</span><br><span class="line">        //文件名长度为20位，左边补0，剩余为起始偏移量，比如 00000000000000000000 代表了第一个文件，起始偏移量为 0， </span><br><span class="line">        //文件大小为 1G=1073741824； 当这个文件满了，第二个文件名字为 00000000001073741824</span><br><span class="line">        result = result &amp;&amp; this.commitLog.load();</span><br><span class="line"></span><br><span class="line">        // load Consume Queue</span><br><span class="line">        //加载逻辑队列,对应每个topic和queueid下面的所有文件,$HOME/store/consumequeue/&#123;topic&#125;/&#123;queueId&#125;/&#123;fileName&#125;</span><br><span class="line">        //每条数据的结构：消息起始物理偏移量(physical offset, long 8字节)+消息大小(int,4字节)+tagsCode(long 8字节)(和storeTimestamp相关) </span><br><span class="line">        //每个 cosumequeue 文件的名称 fileName，名字长度为 20 位，左边补零，剩余为起始偏量</span><br><span class="line">        result = result &amp;&amp; this.loadConsumeQueue();</span><br><span class="line"></span><br><span class="line">        if (result) &#123;</span><br><span class="line">            //加载时间戳，$HOME/store/checkpoint</span><br><span class="line">            //数据结构：physicMsgTimestamp(8)+logicsMsgTimestamp(8)+ indexMsgTimestamp(8)</span><br><span class="line">            //进行消息写入commitlog、物理偏移量/消息大小写入 consumequeue、创建 Index 索引这三个操作之后</span><br><span class="line">            //都要分别更新 physicMsgTimestamp、logicsMsgTimestamp、indexMsgTimestamp 字段</span><br><span class="line">            this.storeCheckpoint =</span><br><span class="line">                new StoreCheckpoint(StorePathConfigHelper.getStoreCheckpoint(this.messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">            //加载索引，$HOME \store\index\$&#123;fileName&#125;</span><br><span class="line">            this.indexService.load(lastExitOK);</span><br><span class="line">            //恢复数据</span><br><span class="line">            this.recover(lastExitOK);</span><br><span class="line"></span><br><span class="line">            log.info(&quot;load over, and the max phy offset = &#123;&#125;&quot;, this.getMaxPhyOffset());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;load exception&quot;, e);</span><br><span class="line">        result = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!result) &#123;</span><br><span class="line">        this.allocateMappedFileService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、DefaultMessageStore的recover方法"><a href="#6、DefaultMessageStore的recover方法" class="headerlink" title="6、DefaultMessageStore的recover方法"></a>6、DefaultMessageStore的recover方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void recover(final boolean lastExitOK) &#123;</span><br><span class="line">    //恢复cosumequeue</span><br><span class="line">    this.recoverConsumeQueue();</span><br><span class="line"></span><br><span class="line">    if (lastExitOK) &#123;</span><br><span class="line">        //正常恢复CommitLog内存数据</span><br><span class="line">        this.commitLog.recoverNormally();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //异常恢复CommitLog内存数据,从最后的文件开始往前寻找与checkpoint文件的记录相匹配的一个文件,开始恢复</span><br><span class="line">        this.commitLog.recoverAbnormally();</span><br><span class="line">    &#125;</span><br><span class="line">    //</span><br><span class="line">    this.recoverTopicQueueTable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、DefaultMessageStore的recoverConsumeQueue方法"><a href="#7、DefaultMessageStore的recoverConsumeQueue方法" class="headerlink" title="7、DefaultMessageStore的recoverConsumeQueue方法"></a>7、DefaultMessageStore的recoverConsumeQueue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void recoverConsumeQueue() &#123;</span><br><span class="line">    for (ConcurrentMap&lt;Integer, ConsumeQueue&gt; maps : this.consumeQueueTable.values()) &#123;</span><br><span class="line">        for (ConsumeQueue logic : maps.values()) &#123;</span><br><span class="line">            logic.recover();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、ConsumeQueue的recover方法"><a href="#8、ConsumeQueue的recover方法" class="headerlink" title="8、ConsumeQueue的recover方法"></a>8、ConsumeQueue的recover方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">public void recover() &#123;</span><br><span class="line">    //获取该消息队列的所有内存映射文件</span><br><span class="line">    final List&lt;MappedFile&gt; mappedFiles = this.mappedFileQueue.getMappedFiles();</span><br><span class="line">    if (!mappedFiles.isEmpty()) &#123;</span><br><span class="line">        //从倒数第3个文件开始</span><br><span class="line">        int index = mappedFiles.size() - 3;</span><br><span class="line">        if (index &lt; 0)</span><br><span class="line">            index = 0;</span><br><span class="line">        //consumequeue 逻辑大小</span><br><span class="line">        int mappedFileSizeLogics = this.mappedFileSize;</span><br><span class="line">        //对应的内存映射文件</span><br><span class="line">        MappedFile mappedFile = mappedFiles.get(index);</span><br><span class="line">        //内存映射文件对应的ByteBuffer</span><br><span class="line">        ByteBuffer byteBuffer = mappedFile.sliceByteBuffer();</span><br><span class="line">        //处理的offset,默认从consumequeue中存放的第一个条目开始</span><br><span class="line">        long processOffset = mappedFile.getFileFromOffset();</span><br><span class="line">        long mappedFileOffset = 0;</span><br><span class="line">        long maxExtAddr = 1;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            //循环验证consumeque包含条目的有效性（如果offset大于0并且size大于0，则表示是一个有效的条目）</span><br><span class="line">            for (int i = 0; i &lt; mappedFileSizeLogics; i += CQ_STORE_UNIT_SIZE) &#123;</span><br><span class="line">                //commitlog中的物理偏移量</span><br><span class="line">                long offset = byteBuffer.getLong();</span><br><span class="line">                //该条消息的消息总长度</span><br><span class="line">                int size = byteBuffer.getInt();</span><br><span class="line">                //tag hashcode</span><br><span class="line">                long tagsCode = byteBuffer.getLong();</span><br><span class="line"></span><br><span class="line">                //如果offset大于0并且size大于0，则表示是一个有效的条目，设置consumequeue中有效的mappedFileOffset </span><br><span class="line">                //继续下一个条目的验证，如果发现不正常的条目，则跳出循环。</span><br><span class="line">                if (offset &gt;= 0 &amp;&amp; size &gt; 0) &#123;</span><br><span class="line">                    mappedFileOffset = i + CQ_STORE_UNIT_SIZE;</span><br><span class="line">                    this.maxPhysicOffset = offset;</span><br><span class="line">                    if (isExtAddr(tagsCode)) &#123;</span><br><span class="line">                        maxExtAddr = tagsCode;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    log.info(&quot;recover current consume queue file over,  &quot; + mappedFile.getFileName() + &quot; &quot;</span><br><span class="line">                        + offset + &quot; &quot; + size + &quot; &quot; + tagsCode);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //如果该consumeque文件中所有条目全部有效，则继续验证下一个文件</span><br><span class="line">            if (mappedFileOffset == mappedFileSizeLogics) &#123;</span><br><span class="line">                index++;</span><br><span class="line">                if (index &gt;= mappedFiles.size()) &#123;</span><br><span class="line"></span><br><span class="line">                    log.info(&quot;recover last consume queue file over, last mapped file &quot;</span><br><span class="line">                        + mappedFile.getFileName());</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    mappedFile = mappedFiles.get(index);</span><br><span class="line">                    byteBuffer = mappedFile.sliceByteBuffer();</span><br><span class="line">                    processOffset = mappedFile.getFileFromOffset();</span><br><span class="line">                    mappedFileOffset = 0;</span><br><span class="line">                    log.info(&quot;recover next consume queue file, &quot; + mappedFile.getFileName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.info(&quot;recover current consume queue queue over &quot; + mappedFile.getFileName() + &quot; &quot;</span><br><span class="line">                    + (processOffset + mappedFileOffset));</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //processOffset 代表了当前consuemque有效的偏移量</span><br><span class="line">        processOffset += mappedFileOffset;</span><br><span class="line">        //设置setFlushedWhere，setCommittedWhere为当前有效的偏移量</span><br><span class="line">        this.mappedFileQueue.setFlushedWhere(processOffset);</span><br><span class="line">        this.mappedFileQueue.setCommittedWhere(processOffset);</span><br><span class="line">        //截断无效的consumeque文件</span><br><span class="line">        this.mappedFileQueue.truncateDirtyFiles(processOffset);</span><br><span class="line"></span><br><span class="line">        if (isExtReadEnable()) &#123;</span><br><span class="line">            this.consumeQueueExt.recover();</span><br><span class="line">            log.info(&quot;Truncate consume queue extend file by max &#123;&#125;&quot;, maxExtAddr);</span><br><span class="line">            this.consumeQueueExt.truncateByMaxAddress(maxExtAddr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（一、6）CommitLog的recoverNormally方法"><a href="#9、接（一、6）CommitLog的recoverNormally方法" class="headerlink" title="9、接（一、6）CommitLog的recoverNormally方法"></a>9、接（一、6）CommitLog的recoverNormally方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">public void recoverNormally() &#123;</span><br><span class="line">    boolean checkCRCOnRecover = this.defaultMessageStore.getMessageStoreConfig().isCheckCRCOnRecover();</span><br><span class="line">    //获取该CommitLog的所有内存映射文件</span><br><span class="line">    final List&lt;MappedFile&gt; mappedFiles = this.mappedFileQueue.getMappedFiles();</span><br><span class="line">    if (!mappedFiles.isEmpty()) &#123;</span><br><span class="line">        // Began to recover from the last third file</span><br><span class="line">        //从倒数第3个文件开始</span><br><span class="line">        int index = mappedFiles.size() - 3;</span><br><span class="line">        if (index &lt; 0)</span><br><span class="line">            index = 0;</span><br><span class="line">        //对应的内存映射文件</span><br><span class="line">        MappedFile mappedFile = mappedFiles.get(index);</span><br><span class="line">        //内存映射文件对应的ByteBuffer</span><br><span class="line">        ByteBuffer byteBuffer = mappedFile.sliceByteBuffer();</span><br><span class="line">        //处理的offset，从第一个消息开始</span><br><span class="line">        long processOffset = mappedFile.getFileFromOffset();</span><br><span class="line">        long mappedFileOffset = 0;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            //检查消息并返回消息大小</span><br><span class="line">            //检查到第 5 至 8 字节 MAGICCODE 字段等于 BlankMagicCode （ cbd43194）则返回 msgSize=0的 DispatchRequest 对象；</span><br><span class="line">            //若校验未通过或者读取到的信息为空则返回msgSize=-1 的 DispatchRequest 对象；</span><br><span class="line">            DispatchRequest dispatchRequest = this.checkMessageAndReturnSize(byteBuffer, checkCRCOnRecover);</span><br><span class="line">            //消息大小</span><br><span class="line">            int size = dispatchRequest.getMsgSize();</span><br><span class="line">            // Normal data</span><br><span class="line">            // 对于 msgSize 大于零，则读取的偏移量 mapedFileOffset 累加 msgSize；</span><br><span class="line">            if (dispatchRequest.isSuccess() &amp;&amp; size &gt; 0) &#123;</span><br><span class="line">                mappedFileOffset += size;</span><br><span class="line">            &#125;</span><br><span class="line">            // Come the end of the file, switch to the next file Since the</span><br><span class="line">            // return 0 representatives met last hole,</span><br><span class="line">            // this can not be included in truncate offset</span><br><span class="line">            //若等于零，则表示读取到了文件的最后一块信息，则继续读取下一个 MapedFile对象的文件</span><br><span class="line">            else if (dispatchRequest.isSuccess() &amp;&amp; size == 0) &#123;</span><br><span class="line">                index++;</span><br><span class="line">                if (index &gt;= mappedFiles.size()) &#123;</span><br><span class="line">                    // Current branch can not happen</span><br><span class="line">                    log.info(&quot;recover last 3 physics file over, last mapped file &quot; + mappedFile.getFileName());</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    mappedFile = mappedFiles.get(index);</span><br><span class="line">                    byteBuffer = mappedFile.sliceByteBuffer();</span><br><span class="line">                    processOffset = mappedFile.getFileFromOffset();</span><br><span class="line">                    mappedFileOffset = 0;</span><br><span class="line">                    log.info(&quot;recover next physics file, &quot; + mappedFile.getFileName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Intermediate file read error</span><br><span class="line">            else if (!dispatchRequest.isSuccess()) &#123;</span><br><span class="line">                log.info(&quot;recover physics file end, &quot; + mappedFile.getFileName());</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //计算有效信息的最后位置 processOffset</span><br><span class="line">        processOffset += mappedFileOffset;</span><br><span class="line">        //更新数据</span><br><span class="line">        this.mappedFileQueue.setFlushedWhere(processOffset);</span><br><span class="line">        this.mappedFileQueue.setCommittedWhere(processOffset);</span><br><span class="line">        //截断无效数据</span><br><span class="line">        this.mappedFileQueue.truncateDirtyFiles(processOffset);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、BrokerController的registerProcessor方法"><a href="#10、BrokerController的registerProcessor方法" class="headerlink" title="10、BrokerController的registerProcessor方法"></a>10、BrokerController的registerProcessor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public void registerProcessor() &#123;</span><br><span class="line">    /**</span><br><span class="line">     * SendMessageProcessor</span><br><span class="line">     */</span><br><span class="line">    SendMessageProcessor sendProcessor = new SendMessageProcessor(this);</span><br><span class="line">    sendProcessor.registerSendMessageHook(sendMessageHookList);</span><br><span class="line">    sendProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line">    //注册SendMessageProcessor处理器，处理Producer发送消息</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    //注册SendMessageProcessor处理器，处理Consumer消费失败的消息发回broker</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    //注册SendMessageProcessor处理器，处理Producer发送消息</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    //注册SendMessageProcessor处理器，处理Consumer消费失败的消息发回broker</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, this.sendMessageExecutor);</span><br><span class="line">    /**</span><br><span class="line">     * PullMessageProcessor</span><br><span class="line">     */</span><br><span class="line">    //注册PullMessageProcessor处理器，处理Consumer拉取消息</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.PULL_MESSAGE, this.pullMessageProcessor, this.pullMessageExecutor);</span><br><span class="line">    this.pullMessageProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * QueryMessageProcessor</span><br><span class="line">     */</span><br><span class="line">    NettyRequestProcessor queryProcessor = new QueryMessageProcessor(this);</span><br><span class="line">    //注册QueryMessageProcessor处理器，处理Consumer查询消息</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.QUERY_MESSAGE, queryProcessor, this.queryMessageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.VIEW_MESSAGE_BY_ID, queryProcessor, this.queryMessageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.QUERY_MESSAGE, queryProcessor, this.queryMessageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.VIEW_MESSAGE_BY_ID, queryProcessor, this.queryMessageExecutor);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ClientManageProcessor</span><br><span class="line">     */</span><br><span class="line">    ClientManageProcessor clientProcessor = new ClientManageProcessor(this);</span><br><span class="line">    //注册ClientManageProcessor处理器，处理心跳、注销客户端等请求</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.HEART_BEAT, clientProcessor, this.clientManageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.UNREGISTER_CLIENT, clientProcessor, this.clientManageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.CHECK_CLIENT_CONFIG, clientProcessor, this.clientManageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.HEART_BEAT, clientProcessor, this.clientManageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.UNREGISTER_CLIENT, clientProcessor, this.clientManageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.CHECK_CLIENT_CONFIG, clientProcessor, this.clientManageExecutor);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ConsumerManageProcessor</span><br><span class="line">     */</span><br><span class="line">    ConsumerManageProcessor consumerManageProcessor = new ConsumerManageProcessor(this);</span><br><span class="line">    //注册ConsumerManageProcessor处理器，处理消费端信息等请求</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.GET_CONSUMER_LIST_BY_GROUP, consumerManageProcessor, this.consumerManageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.UPDATE_CONSUMER_OFFSET, consumerManageProcessor, this.consumerManageExecutor);</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.QUERY_CONSUMER_OFFSET, consumerManageProcessor, this.consumerManageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.GET_CONSUMER_LIST_BY_GROUP, consumerManageProcessor, this.consumerManageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.UPDATE_CONSUMER_OFFSET, consumerManageProcessor, this.consumerManageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.QUERY_CONSUMER_OFFSET, consumerManageProcessor, this.consumerManageExecutor);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * EndTransactionProcessor</span><br><span class="line">     */</span><br><span class="line">    //注册EndTransactionProcessor处理器</span><br><span class="line">    this.remotingServer.registerProcessor(RequestCode.END_TRANSACTION, new EndTransactionProcessor(this), this.sendMessageExecutor);</span><br><span class="line">    this.fastRemotingServer.registerProcessor(RequestCode.END_TRANSACTION, new EndTransactionProcessor(this), this.sendMessageExecutor);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Default</span><br><span class="line">     */</span><br><span class="line">    AdminBrokerProcessor adminProcessor = new AdminBrokerProcessor(this);</span><br><span class="line">    this.remotingServer.registerDefaultProcessor(adminProcessor, this.adminBrokerExecutor);</span><br><span class="line">    this.fastRemotingServer.registerDefaultProcessor(adminProcessor, this.adminBrokerExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、接（一、1）BrokerStartup的start方法"><a href="#11、接（一、1）BrokerStartup的start方法" class="headerlink" title="11、接（一、1）BrokerStartup的start方法"></a>11、接（一、1）BrokerStartup的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public static BrokerController start(BrokerController controller) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line"></span><br><span class="line">        controller.start();</span><br><span class="line"></span><br><span class="line">        String tip = &quot;The broker[&quot; + controller.getBrokerConfig().getBrokerName() + &quot;, &quot;</span><br><span class="line">            + controller.getBrokerAddr() + &quot;] boot success. serializeType=&quot; + RemotingCommand.getSerializeTypeConfigInThisServer();</span><br><span class="line"></span><br><span class="line">        if (null != controller.getBrokerConfig().getNamesrvAddr()) &#123;</span><br><span class="line">            tip += &quot; and name server is &quot; + controller.getBrokerConfig().getNamesrvAddr();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(tip);</span><br><span class="line">        return controller;</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、BrokerController的start方法"><a href="#12、BrokerController的start方法" class="headerlink" title="12、BrokerController的start方法"></a>12、BrokerController的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws Exception &#123;</span><br><span class="line">    //启动消息存储器</span><br><span class="line">    if (this.messageStore != null) &#123;</span><br><span class="line">        this.messageStore.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //启动netty服务器</span><br><span class="line">    if (this.remotingServer != null) &#123;</span><br><span class="line">        this.remotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //启动netty服务器</span><br><span class="line">    if (this.fastRemotingServer != null) &#123;</span><br><span class="line">        this.fastRemotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //启动netty客户端，与注册中心通信</span><br><span class="line">    if (this.brokerOuterAPI != null) &#123;</span><br><span class="line">        this.brokerOuterAPI.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //长轮询</span><br><span class="line">    if (this.pullRequestHoldService != null) &#123;</span><br><span class="line">        this.pullRequestHoldService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //线程定时清除不活动的连接</span><br><span class="line">    if (this.clientHousekeepingService != null) &#123;</span><br><span class="line">        this.clientHousekeepingService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //FilterServer管理</span><br><span class="line">    if (this.filterServerManager != null) &#123;</span><br><span class="line">        this.filterServerManager.start();</span><br><span class="line">    &#125;</span><br><span class="line">    //定时向注册中心注册Broker</span><br><span class="line">    this.registerBrokerAll(true, false);</span><br><span class="line">    this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                BrokerController.this.registerBrokerAll(true, false);</span><br><span class="line">            &#125; catch (Throwable e) &#123;</span><br><span class="line">                log.error(&quot;registerBrokerAll Exception&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 1000 * 10, 1000 * 30, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    if (this.brokerStatsManager != null) &#123;</span><br><span class="line">        this.brokerStatsManager.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.brokerFastFailure != null) &#123;</span><br><span class="line">        this.brokerFastFailure.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、DefaultMessageStore的start方法"><a href="#13、DefaultMessageStore的start方法" class="headerlink" title="13、DefaultMessageStore的start方法"></a>13、DefaultMessageStore的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    lock = lockFile.getChannel().tryLock(0, 1, false);</span><br><span class="line">    if (lock == null || lock.isShared() || !lock.isValid()) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Lock failed,MQ already started&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lockFile.getChannel().write(ByteBuffer.wrap(&quot;lock&quot;.getBytes()));</span><br><span class="line">    lockFile.getChannel().force(true);</span><br><span class="line">    //该线程将消息刷盘，依次循环consumeQueueTable，将每个consumeQueue中的mapedFileQueue commit</span><br><span class="line">    this.flushConsumeQueueService.start();</span><br><span class="line">    //启动消息刷盘任务</span><br><span class="line">    this.commitLog.start();</span><br><span class="line">    //该线程定期统计当前的数据储存状况</span><br><span class="line">    this.storeStatsService.start();</span><br><span class="line">    //发送的消息设置了延时多久消费，那么这个任务会将延时到期的任务正式写到mq中</span><br><span class="line">    if (this.scheduleMessageService != null &amp;&amp; SLAVE != messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">        this.scheduleMessageService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //当Slave模式时，会启动这个模块，首先设置reputFormOffset为初始值0；不断遍历commitLog，得到其SelectMapedBufferResult，</span><br><span class="line">    //然后对每一个Message创建DispatchRequest，创建对应的ConsumeQueue和IndexFile，</span><br><span class="line">    //相关的类如下：CommitLogDispatcherBuildConsumeQueue，CommitLogDispatcherBuildIndex，CommitLogDispatcherCalcBitMap</span><br><span class="line">    if (this.getMessageStoreConfig().isDuplicationEnable()) &#123;</span><br><span class="line">        this.reputMessageService.setReputFromOffset(this.commitLog.getConfirmOffset());</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.reputMessageService.setReputFromOffset(this.commitLog.getMaxOffset());</span><br><span class="line">    &#125;</span><br><span class="line">    this.reputMessageService.start();</span><br><span class="line">    //该线程定时处理和slave之间的信息备份</span><br><span class="line">    this.haService.start();</span><br><span class="line"></span><br><span class="line">    this.createTempFile();</span><br><span class="line">    this.addScheduleTask();</span><br><span class="line">    this.shutdown = false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、接收消息"><a href="#二、接收消息" class="headerlink" title="二、接收消息"></a>二、接收消息</h3><h4 id="1、SendMessageProcessor的processRequest方法"><a href="#1、SendMessageProcessor的processRequest方法" class="headerlink" title="1、SendMessageProcessor的processRequest方法"></a>1、SendMessageProcessor的processRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public RemotingCommand processRequest(ChannelHandlerContext ctx,</span><br><span class="line">    RemotingCommand request) throws RemotingCommandException &#123;</span><br><span class="line">    SendMessageContext mqtraceContext;</span><br><span class="line">    switch (request.getCode()) &#123;</span><br><span class="line">        case RequestCode.CONSUMER_SEND_MSG_BACK:</span><br><span class="line">            //处理消费端，消费失败发回的消息</span><br><span class="line">            return this.consumerSendMsgBack(ctx, request);</span><br><span class="line">        default:</span><br><span class="line">            //解析请求</span><br><span class="line">            SendMessageRequestHeader requestHeader = parseRequestHeader(request);</span><br><span class="line">            if (requestHeader == null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            //发送请求Context,在 hook 场景下使用</span><br><span class="line">            mqtraceContext = buildMsgContext(ctx, requestHeader);</span><br><span class="line">            //hook：处理发送消息前逻辑</span><br><span class="line">            this.executeSendMessageHookBefore(ctx, request, mqtraceContext);</span><br><span class="line"></span><br><span class="line">            RemotingCommand response;</span><br><span class="line">            //处理发送消息逻辑</span><br><span class="line">            if (requestHeader.isBatch()) &#123;</span><br><span class="line">                response = this.sendBatchMessage(ctx, request, mqtraceContext, requestHeader);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                response = this.sendMessage(ctx, request, mqtraceContext, requestHeader);</span><br><span class="line">            &#125;</span><br><span class="line">            //hook：处理发送消息后逻辑</span><br><span class="line">            this.executeSendMessageHookAfter(response, mqtraceContext);</span><br><span class="line">            return response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、SendMessageProcessor的sendMessage方法"><a href="#2、SendMessageProcessor的sendMessage方法" class="headerlink" title="2、SendMessageProcessor的sendMessage方法"></a>2、SendMessageProcessor的sendMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">private RemotingCommand sendMessage(final ChannelHandlerContext ctx,</span><br><span class="line">    final RemotingCommand request,</span><br><span class="line">    final SendMessageContext sendMessageContext,</span><br><span class="line">    final SendMessageRequestHeader requestHeader) throws RemotingCommandException &#123;</span><br><span class="line">    //初始化响应</span><br><span class="line">    final RemotingCommand response = RemotingCommand.createResponseCommand(SendMessageResponseHeader.class);</span><br><span class="line">    final SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();</span><br><span class="line"></span><br><span class="line">    response.setOpaque(request.getOpaque());</span><br><span class="line"></span><br><span class="line">    response.addExtField(MessageConst.PROPERTY_MSG_REGION, this.brokerController.getBrokerConfig().getRegionId());</span><br><span class="line">    response.addExtField(MessageConst.PROPERTY_TRACE_SWITCH, String.valueOf(this.brokerController.getBrokerConfig().isTraceOn()));</span><br><span class="line"></span><br><span class="line">    log.debug(&quot;receive SendMessage request command, &#123;&#125;&quot;, request);</span><br><span class="line">    //如果未开始接收消息，抛出系统异常</span><br><span class="line">    final long startTimstamp = this.brokerController.getBrokerConfig().getStartAcceptSendRequestTimeStamp();</span><br><span class="line">    if (this.brokerController.getMessageStore().now() &lt; startTimstamp) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(String.format(&quot;broker unable to service, until %s&quot;, UtilAll.timeMillisToHumanString2(startTimstamp)));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.setCode(-1);</span><br><span class="line">    //消息配置(Topic配置）校验</span><br><span class="line">    super.msgCheck(ctx, requestHeader, response);</span><br><span class="line">    if (response.getCode() != -1) &#123;</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final byte[] body = request.getBody();</span><br><span class="line">    //如果队列小于0，从可用队列随机选择</span><br><span class="line">    int queueIdInt = requestHeader.getQueueId();</span><br><span class="line">    TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</span><br><span class="line"></span><br><span class="line">    if (queueIdInt &lt; 0) &#123;</span><br><span class="line">        queueIdInt = Math.abs(this.random.nextInt() % 99999999) % topicConfig.getWriteQueueNums();</span><br><span class="line">    &#125;</span><br><span class="line">    //创建MessageExtBrokerInner</span><br><span class="line">    MessageExtBrokerInner msgInner = new MessageExtBrokerInner();</span><br><span class="line">    msgInner.setTopic(requestHeader.getTopic());</span><br><span class="line">    msgInner.setQueueId(queueIdInt);</span><br><span class="line"></span><br><span class="line">    if (!handleRetryAndDLQ(requestHeader, response, request, msgInner, topicConfig)) &#123;</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msgInner.setBody(body);</span><br><span class="line">    msgInner.setFlag(requestHeader.getFlag());</span><br><span class="line">    MessageAccessor.setProperties(msgInner, MessageDecoder.string2messageProperties(requestHeader.getProperties()));</span><br><span class="line">    msgInner.setPropertiesString(requestHeader.getProperties());</span><br><span class="line">    msgInner.setBornTimestamp(requestHeader.getBornTimestamp());</span><br><span class="line">    msgInner.setBornHost(ctx.channel().remoteAddress());</span><br><span class="line">    msgInner.setStoreHost(this.getStoreHost());</span><br><span class="line">    msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == null ? 0 : requestHeader.getReconsumeTimes());</span><br><span class="line">    //校验是否不允许发送事务消息</span><br><span class="line">    if (this.brokerController.getBrokerConfig().isRejectTransactionMessage()) &#123;</span><br><span class="line">        String traFlag = msgInner.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">        if (traFlag != null) &#123;</span><br><span class="line">            response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">            response.setRemark(</span><br><span class="line">                &quot;the broker[&quot; + this.brokerController.getBrokerConfig().getBrokerIP1() + &quot;] sending transaction message is forbidden&quot;);</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加消息</span><br><span class="line">    PutMessageResult putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);</span><br><span class="line">    //处理返回</span><br><span class="line">    return handlePutMessageResult(putMessageResult, response, request, msgInner, responseHeader, sendMessageContext, ctx, queueIdInt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultMessageStore的putMessage方法"><a href="#3、DefaultMessageStore的putMessage方法" class="headerlink" title="3、DefaultMessageStore的putMessage方法"></a>3、DefaultMessageStore的putMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public PutMessageResult putMessages(MessageExtBatch messageExtBatch) &#123;</span><br><span class="line">    if (this.shutdown) &#123;</span><br><span class="line">        log.warn(&quot;DefaultMessageStore has shutdown, so putMessages is forbidden&quot;);</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);</span><br><span class="line">    &#125;</span><br><span class="line">    //从节点不允许写入</span><br><span class="line">    if (BrokerRole.SLAVE == this.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">        long value = this.printTimes.getAndIncrement();</span><br><span class="line">        if ((value % 50000) == 0) &#123;</span><br><span class="line">            log.warn(&quot;DefaultMessageStore is in slave mode, so putMessages is forbidden &quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);</span><br><span class="line">    &#125;</span><br><span class="line">    //store是否允许写入</span><br><span class="line">    if (!this.runningFlags.isWriteable()) &#123;</span><br><span class="line">        long value = this.printTimes.getAndIncrement();</span><br><span class="line">        if ((value % 50000) == 0) &#123;</span><br><span class="line">            log.warn(&quot;DefaultMessageStore is not writable, so putMessages is forbidden &quot; + this.runningFlags.getFlagBits());</span><br><span class="line">        &#125;</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, null);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.printTimes.set(0);</span><br><span class="line">    &#125;</span><br><span class="line">    //消息过长</span><br><span class="line">    if (messageExtBatch.getTopic().length() &gt; Byte.MAX_VALUE) &#123;</span><br><span class="line">        log.warn(&quot;PutMessages topic length too long &quot; + messageExtBatch.getTopic().length());</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);</span><br><span class="line">    &#125;</span><br><span class="line">    //消息附加属性过长</span><br><span class="line">    if (messageExtBatch.getBody().length &gt; messageStoreConfig.getMaxMessageSize()) &#123;</span><br><span class="line">        log.warn(&quot;PutMessages body length too long &quot; + messageExtBatch.getBody().length);</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.isOSPageCacheBusy()) &#123;</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long beginTime = this.getSystemClock().now();</span><br><span class="line">    //添加消息到commitLog</span><br><span class="line">    PutMessageResult result = this.commitLog.putMessages(messageExtBatch);</span><br><span class="line"></span><br><span class="line">    long eclipseTime = this.getSystemClock().now() - beginTime;</span><br><span class="line">    if (eclipseTime &gt; 500) &#123;</span><br><span class="line">        log.warn(&quot;not in lock eclipse time(ms)=&#123;&#125;, bodyLength=&#123;&#125;&quot;, eclipseTime, messageExtBatch.getBody().length);</span><br><span class="line">    &#125;</span><br><span class="line">    this.storeStatsService.setPutMessageEntireTimeMax(eclipseTime);</span><br><span class="line"></span><br><span class="line">    if (null == result || !result.isOk()) &#123;</span><br><span class="line">        this.storeStatsService.getPutMessageFailedTimes().incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、CommitLog的putMessage方法"><a href="#4、CommitLog的putMessage方法" class="headerlink" title="4、CommitLog的putMessage方法"></a>4、CommitLog的putMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">public PutMessageResult putMessages(final MessageExtBatch messageExtBatch) &#123;</span><br><span class="line">    messageExtBatch.setStoreTimestamp(System.currentTimeMillis());</span><br><span class="line">    AppendMessageResult result;</span><br><span class="line"></span><br><span class="line">    StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();</span><br><span class="line">    //获取消息类型（事务消息，非事务消息，Commit消息）</span><br><span class="line">    final int tranType = MessageSysFlag.getTransactionValue(messageExtBatch.getSysFlag());</span><br><span class="line"></span><br><span class="line">    if (tranType != MessageSysFlag.TRANSACTION_NOT_TYPE) &#123;</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);</span><br><span class="line">    &#125;</span><br><span class="line">    if (messageExtBatch.getDelayTimeLevel() &gt; 0) &#123;</span><br><span class="line">        return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long eclipseTimeInLock = 0;</span><br><span class="line">    //获取写入映射文件</span><br><span class="line">    MappedFile unlockMappedFile = null;</span><br><span class="line">    MappedFile mappedFile = this.mappedFileQueue.getLastMappedFile();</span><br><span class="line"></span><br><span class="line">    //fine-grained lock instead of the coarse-grained</span><br><span class="line">    MessageExtBatchEncoder batchEncoder = batchEncoderThreadLocal.get();</span><br><span class="line"></span><br><span class="line">    messageExtBatch.setEncodedBuff(batchEncoder.encode(messageExtBatch));</span><br><span class="line">    //获取写入锁</span><br><span class="line">    putMessageLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();</span><br><span class="line">        this.beginTimeInLock = beginLockTimestamp;</span><br><span class="line"></span><br><span class="line">        // Here settings are stored timestamp, in order to ensure an orderly</span><br><span class="line">        // global</span><br><span class="line">        messageExtBatch.setStoreTimestamp(beginLockTimestamp);</span><br><span class="line">        //当不存在映射文件时，进行创建</span><br><span class="line">        if (null == mappedFile || mappedFile.isFull()) &#123;</span><br><span class="line">            mappedFile = this.mappedFileQueue.getLastMappedFile(0); // Mark: NewFile may be cause noise</span><br><span class="line">        &#125;</span><br><span class="line">        if (null == mappedFile) &#123;</span><br><span class="line">            log.error(&quot;Create mapped file1 error, topic: &#123;&#125; clientAddr: &#123;&#125;&quot;, messageExtBatch.getTopic(), messageExtBatch.getBornHostString());</span><br><span class="line">            beginTimeInLock = 0;</span><br><span class="line">            return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, null);</span><br><span class="line">        &#125;</span><br><span class="line">        //存储消息</span><br><span class="line">        result = mappedFile.appendMessages(messageExtBatch, this.appendMessageCallback);</span><br><span class="line">        switch (result.getStatus()) &#123;</span><br><span class="line">            case PUT_OK:</span><br><span class="line">                break;</span><br><span class="line">            case END_OF_FILE:</span><br><span class="line">                unlockMappedFile = mappedFile;</span><br><span class="line">                // Create a new file, re-write the message</span><br><span class="line">                //当文件尾时，获取新的映射文件</span><br><span class="line">                mappedFile = this.mappedFileQueue.getLastMappedFile(0);</span><br><span class="line">                if (null == mappedFile) &#123;</span><br><span class="line">                    // XXX: warn and notify me</span><br><span class="line">                    log.error(&quot;Create mapped file2 error, topic: &#123;&#125; clientAddr: &#123;&#125;&quot;, messageExtBatch.getTopic(), messageExtBatch.getBornHostString());</span><br><span class="line">                    beginTimeInLock = 0;</span><br><span class="line">                    return new PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);</span><br><span class="line">                &#125;</span><br><span class="line">                //存储消息</span><br><span class="line">                result = mappedFile.appendMessages(messageExtBatch, this.appendMessageCallback);</span><br><span class="line">                break;</span><br><span class="line">            case MESSAGE_SIZE_EXCEEDED:</span><br><span class="line">            case PROPERTIES_SIZE_EXCEEDED:</span><br><span class="line">                beginTimeInLock = 0;</span><br><span class="line">                return new PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</span><br><span class="line">            case UNKNOWN_ERROR:</span><br><span class="line">                beginTimeInLock = 0;</span><br><span class="line">                return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</span><br><span class="line">            default:</span><br><span class="line">                beginTimeInLock = 0;</span><br><span class="line">                return new PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eclipseTimeInLock = this.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;</span><br><span class="line">        beginTimeInLock = 0;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">         //释放写入锁</span><br><span class="line">        putMessageLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (eclipseTimeInLock &gt; 500) &#123;</span><br><span class="line">        log.warn(&quot;[NOTIFYME]putMessages in lock cost time(ms)=&#123;&#125;, bodyLength=&#123;&#125; AppendMessageResult=&#123;&#125;&quot;, eclipseTimeInLock, messageExtBatch.getBody().length, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (null != unlockMappedFile &amp;&amp; this.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) &#123;</span><br><span class="line">        this.defaultMessageStore.unlockMappedFile(unlockMappedFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PutMessageResult putMessageResult = new PutMessageResult(PutMessageStatus.PUT_OK, result);</span><br><span class="line"></span><br><span class="line">    // Statistics</span><br><span class="line">    storeStatsService.getSinglePutMessageTopicTimesTotal(messageExtBatch.getTopic()).addAndGet(result.getMsgNum());</span><br><span class="line">    storeStatsService.getSinglePutMessageTopicSizeTotal(messageExtBatch.getTopic()).addAndGet(result.getWroteBytes());</span><br><span class="line">    //根据刷盘策略刷盘</span><br><span class="line">    handleDiskFlush(result, putMessageResult, messageExtBatch);</span><br><span class="line">    //若该Broker为同步双写主用(SYNC_MASTER)，同步到从节点</span><br><span class="line">    handleHA(result, putMessageResult, messageExtBatch);</span><br><span class="line"></span><br><span class="line">    return putMessageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、CommitLog的handleDiskFlush方法"><a href="#5、CommitLog的handleDiskFlush方法" class="headerlink" title="5、CommitLog的handleDiskFlush方法"></a>5、CommitLog的handleDiskFlush方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public void handleDiskFlush(AppendMessageResult result, PutMessageResult putMessageResult, MessageExt messageExt) &#123;</span><br><span class="line">    // Synchronization flush</span><br><span class="line">    //同步刷盘</span><br><span class="line">    if (FlushDiskType.SYNC_FLUSH == this.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) &#123;</span><br><span class="line">        //获取刷盘服务</span><br><span class="line">        final GroupCommitService service = (GroupCommitService) this.flushCommitLogService;</span><br><span class="line">        //消息属性WAIT为true,等待服务器将消息存储完毕再返回</span><br><span class="line">        if (messageExt.isWaitStoreMsgOK()) &#123;</span><br><span class="line">            //创建刷盘请求，offset为写CommitLog之后的offset</span><br><span class="line">            GroupCommitRequest request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</span><br><span class="line">            //加入GroupCommitService.requestsWrite集合</span><br><span class="line">            service.putRequest(request);</span><br><span class="line">            //等待同步刷盘</span><br><span class="line">            boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</span><br><span class="line">            if (!flushOK) &#123;</span><br><span class="line">                log.error(&quot;do groupcommit, wait for flush failed, topic: &quot; + messageExt.getTopic() + &quot; tags: &quot; + messageExt.getTags()</span><br><span class="line">                    + &quot; client address: &quot; + messageExt.getBornHostString());</span><br><span class="line">                putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            service.wakeup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Asynchronous flush</span><br><span class="line">    else &#123;</span><br><span class="line">        //异步刷盘，唤醒刷盘线程</span><br><span class="line">        if (!this.defaultMessageStore.getMessageStoreConfig().isTransientStorePoolEnable()) &#123;</span><br><span class="line">            flushCommitLogService.wakeup();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            commitLogService.wakeup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、CommitLog的handleHA方法"><a href="#6、CommitLog的handleHA方法" class="headerlink" title="6、CommitLog的handleHA方法"></a>6、CommitLog的handleHA方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public void handleHA(AppendMessageResult result, PutMessageResult putMessageResult, MessageExt messageExt) &#123;</span><br><span class="line">    //同步master</span><br><span class="line">    if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</span><br><span class="line">        //主从同步服务</span><br><span class="line">        HAService service = this.defaultMessageStore.getHaService();</span><br><span class="line">        if (messageExt.isWaitStoreMsgOK()) &#123;</span><br><span class="line">            // Determine whether to wait</span><br><span class="line">            if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</span><br><span class="line">                //创建同步请求</span><br><span class="line">                GroupCommitRequest request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</span><br><span class="line">                //加入GroupTransferService.requestsWrite中</span><br><span class="line">                service.putRequest(request);</span><br><span class="line">                //唤醒线程</span><br><span class="line">                service.getWaitNotifyObject().wakeupAll();</span><br><span class="line">                //等待主从同步</span><br><span class="line">                boolean flushOK =</span><br><span class="line">                    request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</span><br><span class="line">                if (!flushOK) &#123;</span><br><span class="line">                    log.error(&quot;do sync transfer other node, wait return, but failed, topic: &quot; + messageExt.getTopic() + &quot; tags: &quot;</span><br><span class="line">                        + messageExt.getTags() + &quot; client address: &quot; + messageExt.getBornHostNameString());</span><br><span class="line">                    putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Slave problem</span><br><span class="line">            else &#123;</span><br><span class="line">                // Tell the producer, slave not available</span><br><span class="line">                putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、拉取消息"><a href="#三、拉取消息" class="headerlink" title="三、拉取消息"></a>三、拉取消息</h3><h4 id="1、PullMessageProcessor的processRequest方法"><a href="#1、PullMessageProcessor的processRequest方法" class="headerlink" title="1、PullMessageProcessor的processRequest方法"></a>1、PullMessageProcessor的processRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public RemotingCommand processRequest(final ChannelHandlerContext ctx,</span><br><span class="line">    RemotingCommand request) throws RemotingCommandException &#123;</span><br><span class="line">    return this.processRequest(ctx.channel(), request, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br></pre></td><td class="code"><pre><span class="line">private RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean brokerAllowSuspend)</span><br><span class="line">    throws RemotingCommandException &#123;</span><br><span class="line">    RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</span><br><span class="line">    final PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</span><br><span class="line">    final PullMessageRequestHeader requestHeader =</span><br><span class="line">        (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</span><br><span class="line"></span><br><span class="line">    response.setOpaque(request.getOpaque());</span><br><span class="line"></span><br><span class="line">    log.debug(&quot;receive PullMessage request command, &#123;&#125;&quot;, request);</span><br><span class="line">    //校验broker是否可读</span><br><span class="line">    if (!PermName.isReadable(this.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</span><br><span class="line">        response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">        response.setRemark(String.format(&quot;the broker[%s] pulling message is forbidden&quot;, this.brokerController.getBrokerConfig().getBrokerIP1()));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //校验consumer分组配置是否存在</span><br><span class="line">    SubscriptionGroupConfig subscriptionGroupConfig =</span><br><span class="line">        this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</span><br><span class="line">    if (null == subscriptionGroupConfig) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</span><br><span class="line">        response.setRemark(String.format(&quot;subscription group [%s] does not exist, %s&quot;, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //校验consumer分组配置是否可消费</span><br><span class="line">    if (!subscriptionGroupConfig.isConsumeEnable()) &#123;</span><br><span class="line">        response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">        response.setRemark(&quot;subscription group no permission, &quot; + requestHeader.getConsumerGroup());</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final boolean hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag());</span><br><span class="line">    final boolean hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag());</span><br><span class="line">    final boolean hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag());</span><br><span class="line"></span><br><span class="line">    final long suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : 0;</span><br><span class="line">    //校验topic配置存在</span><br><span class="line">    TopicConfig topicConfig = this.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</span><br><span class="line">    if (null == topicConfig) &#123;</span><br><span class="line">        log.error(&quot;the topic &#123;&#125; not exist, consumer: &#123;&#125;&quot;, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</span><br><span class="line">        response.setCode(ResponseCode.TOPIC_NOT_EXIST);</span><br><span class="line">        response.setRemark(String.format(&quot;topic[%s] not exist, apply first please! %s&quot;, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //校验topic配置权限可读</span><br><span class="line">    if (!PermName.isReadable(topicConfig.getPerm())) &#123;</span><br><span class="line">        response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">        response.setRemark(&quot;the topic[&quot; + requestHeader.getTopic() + &quot;] pulling message is forbidden&quot;);</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //校验读取队列在topic配置队列范围内</span><br><span class="line">    if (requestHeader.getQueueId() &lt; 0 || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) &#123;</span><br><span class="line">        String errorInfo = String.format(&quot;queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]&quot;,</span><br><span class="line">            requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</span><br><span class="line">        log.warn(errorInfo);</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(errorInfo);</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //校验订阅关系</span><br><span class="line">    SubscriptionData subscriptionData = null;</span><br><span class="line">    ConsumerFilterData consumerFilterData = null;</span><br><span class="line">    if (hasSubscriptionFlag) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            subscriptionData = FilterAPI.build(</span><br><span class="line">                requestHeader.getTopic(), requestHeader.getSubscription(), requestHeader.getExpressionType()</span><br><span class="line">            );</span><br><span class="line">            if (!ExpressionType.isTagType(subscriptionData.getExpressionType())) &#123;</span><br><span class="line">                consumerFilterData = ConsumerFilterManager.build(</span><br><span class="line">                    requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getSubscription(),</span><br><span class="line">                    requestHeader.getExpressionType(), requestHeader.getSubVersion()</span><br><span class="line">                );</span><br><span class="line">                assert consumerFilterData != null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(&quot;Parse the consumer&apos;s subscription[&#123;&#125;] failed, group: &#123;&#125;&quot;, requestHeader.getSubscription(),</span><br><span class="line">                requestHeader.getConsumerGroup());</span><br><span class="line">            response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</span><br><span class="line">            response.setRemark(&quot;parse the consumer&apos;s subscription failed&quot;);</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //校验消费分组信息是否存在</span><br><span class="line">        ConsumerGroupInfo consumerGroupInfo =</span><br><span class="line">            this.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</span><br><span class="line">        if (null == consumerGroupInfo) &#123;</span><br><span class="line">            log.warn(&quot;the consumer&apos;s group info not exist, group: &#123;&#125;&quot;, requestHeader.getConsumerGroup());</span><br><span class="line">            response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</span><br><span class="line">            response.setRemark(&quot;the consumer&apos;s group info not exist&quot; + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">        //校验消费分组信息消息模型是否匹配</span><br><span class="line">        if (!subscriptionGroupConfig.isConsumeBroadcastEnable()</span><br><span class="line">            &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) &#123;</span><br><span class="line">            response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">            response.setRemark(&quot;the consumer group[&quot; + requestHeader.getConsumerGroup() + &quot;] can not consume by broadcast way&quot;);</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">        //校验订阅信息是否存在</span><br><span class="line">        subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</span><br><span class="line">        if (null == subscriptionData) &#123;</span><br><span class="line">            log.warn(&quot;the consumer&apos;s subscription not exist, group: &#123;&#125;, topic:&#123;&#125;&quot;, requestHeader.getConsumerGroup(), requestHeader.getTopic());</span><br><span class="line">            response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</span><br><span class="line">            response.setRemark(&quot;the consumer&apos;s subscription not exist&quot; + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">        //校验订阅信息版本是否合法</span><br><span class="line">        if (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) &#123;</span><br><span class="line">            log.warn(&quot;The broker&apos;s subscription is not latest, group: &#123;&#125; &#123;&#125;&quot;, requestHeader.getConsumerGroup(),</span><br><span class="line">                subscriptionData.getSubString());</span><br><span class="line">            response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</span><br><span class="line">            response.setRemark(&quot;the consumer&apos;s subscription not latest&quot;);</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!ExpressionType.isTagType(subscriptionData.getExpressionType())) &#123;</span><br><span class="line">            consumerFilterData = this.brokerController.getConsumerFilterManager().get(requestHeader.getTopic(),</span><br><span class="line">                requestHeader.getConsumerGroup());</span><br><span class="line">            if (consumerFilterData == null) &#123;</span><br><span class="line">                response.setCode(ResponseCode.FILTER_DATA_NOT_EXIST);</span><br><span class="line">                response.setRemark(&quot;The broker&apos;s consumer filter data is not exist!Your expression may be wrong!&quot;);</span><br><span class="line">                return response;</span><br><span class="line">            &#125;</span><br><span class="line">            if (consumerFilterData.getClientVersion() &lt; requestHeader.getSubVersion()) &#123;</span><br><span class="line">                log.warn(&quot;The broker&apos;s consumer filter data is not latest, group: &#123;&#125;, topic: &#123;&#125;, serverV: &#123;&#125;, clientV: &#123;&#125;&quot;,</span><br><span class="line">                    requestHeader.getConsumerGroup(), requestHeader.getTopic(), consumerFilterData.getClientVersion(), requestHeader.getSubVersion());</span><br><span class="line">                response.setCode(ResponseCode.FILTER_DATA_NOT_LATEST);</span><br><span class="line">                response.setRemark(&quot;the consumer&apos;s consumer filter data not latest&quot;);</span><br><span class="line">                return response;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!ExpressionType.isTagType(subscriptionData.getExpressionType())</span><br><span class="line">        &amp;&amp; !this.brokerController.getBrokerConfig().isEnablePropertyFilter()) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(&quot;The broker does not support consumer to filter message by &quot; + subscriptionData.getExpressionType());</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MessageFilter messageFilter;</span><br><span class="line">    if (this.brokerController.getBrokerConfig().isFilterSupportRetry()) &#123;</span><br><span class="line">        messageFilter = new ExpressionForRetryMessageFilter(subscriptionData, consumerFilterData,</span><br><span class="line">            this.brokerController.getConsumerFilterManager());</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        messageFilter = new ExpressionMessageFilter(subscriptionData, consumerFilterData,</span><br><span class="line">            this.brokerController.getConsumerFilterManager());</span><br><span class="line">    &#125;</span><br><span class="line">    //获取消息</span><br><span class="line">    final GetMessageResult getMessageResult =</span><br><span class="line">        this.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</span><br><span class="line">            requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), messageFilter);</span><br><span class="line">    if (getMessageResult != null) &#123;</span><br><span class="line">        response.setRemark(getMessageResult.getStatus().name());</span><br><span class="line">        responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</span><br><span class="line">        responseHeader.setMinOffset(getMessageResult.getMinOffset());</span><br><span class="line">        responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</span><br><span class="line">        //获取建议读取放的brokerId</span><br><span class="line">        if (getMessageResult.isSuggestPullingFromSlave()) &#123;</span><br><span class="line">            responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        switch (this.brokerController.getMessageStoreConfig().getBrokerRole()) &#123;</span><br><span class="line">            case ASYNC_MASTER:</span><br><span class="line">            case SYNC_MASTER:</span><br><span class="line">                break;</span><br><span class="line">            case SLAVE:</span><br><span class="line">                //从节点不允许读取，通知consumer读取主节点</span><br><span class="line">                if (!this.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123;</span><br><span class="line">                    response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br><span class="line">                    responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (this.brokerController.getBrokerConfig().isSlaveReadEnable()) &#123;</span><br><span class="line">            // consume too slow ,redirect to another machine</span><br><span class="line">            if (getMessageResult.isSuggestPullingFromSlave()) &#123;</span><br><span class="line">                responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</span><br><span class="line">            &#125;</span><br><span class="line">            // consume ok</span><br><span class="line">            else &#123;</span><br><span class="line">                responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        switch (getMessageResult.getStatus()) &#123;</span><br><span class="line">            case FOUND:</span><br><span class="line">                response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">                break;</span><br><span class="line">            case MESSAGE_WAS_REMOVING:</span><br><span class="line">                response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br><span class="line">                break;</span><br><span class="line">            case NO_MATCHED_LOGIC_QUEUE:</span><br><span class="line">            case NO_MESSAGE_IN_QUEUE:</span><br><span class="line">                if (0 != requestHeader.getQueueOffset()) &#123;</span><br><span class="line">                    response.setCode(ResponseCode.PULL_OFFSET_MOVED);</span><br><span class="line"></span><br><span class="line">                    // XXX: warn and notify me</span><br><span class="line">                    log.info(&quot;the broker store no queue data, fix the request offset &#123;&#125; to &#123;&#125;, Topic: &#123;&#125; QueueId: &#123;&#125; Consumer Group: &#123;&#125;&quot;,</span><br><span class="line">                        requestHeader.getQueueOffset(),</span><br><span class="line">                        getMessageResult.getNextBeginOffset(),</span><br><span class="line">                        requestHeader.getTopic(),</span><br><span class="line">                        requestHeader.getQueueId(),</span><br><span class="line">                        requestHeader.getConsumerGroup()</span><br><span class="line">                    );</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    response.setCode(ResponseCode.PULL_NOT_FOUND);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case NO_MATCHED_MESSAGE:</span><br><span class="line">                response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br><span class="line">                break;</span><br><span class="line">            case OFFSET_FOUND_NULL:</span><br><span class="line">                response.setCode(ResponseCode.PULL_NOT_FOUND);</span><br><span class="line">                break;</span><br><span class="line">            case OFFSET_OVERFLOW_BADLY:</span><br><span class="line">                response.setCode(ResponseCode.PULL_OFFSET_MOVED);</span><br><span class="line">                // XXX: warn and notify me</span><br><span class="line">                log.info(&quot;the request offset: &#123;&#125; over flow badly, broker max offset: &#123;&#125;, consumer: &#123;&#125;&quot;,</span><br><span class="line">                    requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</span><br><span class="line">                break;</span><br><span class="line">            case OFFSET_OVERFLOW_ONE:</span><br><span class="line">                response.setCode(ResponseCode.PULL_NOT_FOUND);</span><br><span class="line">                break;</span><br><span class="line">            case OFFSET_TOO_SMALL:</span><br><span class="line">                response.setCode(ResponseCode.PULL_OFFSET_MOVED);</span><br><span class="line">                log.info(&quot;the request offset too small. group=&#123;&#125;, topic=&#123;&#125;, requestOffset=&#123;&#125;, brokerMinOffset=&#123;&#125;, clientIp=&#123;&#125;&quot;,</span><br><span class="line">                    requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</span><br><span class="line">                    getMessageResult.getMinOffset(), channel.remoteAddress());</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                assert false;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        //hook：before</span><br><span class="line">        if (this.hasConsumeMessageHook()) &#123;</span><br><span class="line">            ConsumeMessageContext context = new ConsumeMessageContext();</span><br><span class="line">            context.setConsumerGroup(requestHeader.getConsumerGroup());</span><br><span class="line">            context.setTopic(requestHeader.getTopic());</span><br><span class="line">            context.setQueueId(requestHeader.getQueueId());</span><br><span class="line"></span><br><span class="line">            String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</span><br><span class="line"></span><br><span class="line">            switch (response.getCode()) &#123;</span><br><span class="line">                case ResponseCode.SUCCESS:</span><br><span class="line">                    int commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</span><br><span class="line">                    int incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</span><br><span class="line"></span><br><span class="line">                    context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</span><br><span class="line">                    context.setCommercialRcvTimes(incValue);</span><br><span class="line">                    context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</span><br><span class="line">                    context.setCommercialOwner(owner);</span><br><span class="line"></span><br><span class="line">                    break;</span><br><span class="line">                case ResponseCode.PULL_NOT_FOUND:</span><br><span class="line">                    if (!brokerAllowSuspend) &#123;</span><br><span class="line"></span><br><span class="line">                        context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</span><br><span class="line">                        context.setCommercialRcvTimes(1);</span><br><span class="line">                        context.setCommercialOwner(owner);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case ResponseCode.PULL_RETRY_IMMEDIATELY:</span><br><span class="line">                case ResponseCode.PULL_OFFSET_MOVED:</span><br><span class="line">                    context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</span><br><span class="line">                    context.setCommercialRcvTimes(1);</span><br><span class="line">                    context.setCommercialOwner(owner);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    assert false;</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.executeConsumeMessageHookBefore(context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        switch (response.getCode()) &#123;</span><br><span class="line">            case ResponseCode.SUCCESS:</span><br><span class="line"></span><br><span class="line">                this.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</span><br><span class="line">                    getMessageResult.getMessageCount());</span><br><span class="line"></span><br><span class="line">                this.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</span><br><span class="line">                    getMessageResult.getBufferTotalSize());</span><br><span class="line"></span><br><span class="line">                this.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</span><br><span class="line">                // 读取消息</span><br><span class="line">                if (this.brokerController.getBrokerConfig().isTransferMsgByHeap()) &#123;</span><br><span class="line">                    final long beginTimeMills = this.brokerController.getMessageStore().now();</span><br><span class="line">                    final byte[] r = this.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</span><br><span class="line">                    this.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</span><br><span class="line">                        requestHeader.getTopic(), requestHeader.getQueueId(),</span><br><span class="line">                        (int) (this.brokerController.getMessageStore().now() - beginTimeMills));</span><br><span class="line">                    response.setBody(r);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        FileRegion fileRegion =</span><br><span class="line">                            new ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</span><br><span class="line">                        channel.writeAndFlush(fileRegion).addListener(new ChannelFutureListener() &#123;</span><br><span class="line">                            @Override</span><br><span class="line">                            public void operationComplete(ChannelFuture future) throws Exception &#123;</span><br><span class="line">                                getMessageResult.release();</span><br><span class="line">                                if (!future.isSuccess()) &#123;</span><br><span class="line">                                    log.error(&quot;transfer many message by pagecache failed, &#123;&#125;&quot;, channel.remoteAddress(), future.cause());</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125; catch (Throwable e) &#123;</span><br><span class="line">                        log.error(&quot;transfer many message by pagecache exception&quot;, e);</span><br><span class="line">                        getMessageResult.release();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    response = null;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case ResponseCode.PULL_NOT_FOUND:</span><br><span class="line">                //消息未查询到&amp;&amp;broker允许挂起请求&amp;&amp;请求允许挂起</span><br><span class="line">                if (brokerAllowSuspend &amp;&amp; hasSuspendFlag) &#123;</span><br><span class="line">                    long pollingTimeMills = suspendTimeoutMillisLong;</span><br><span class="line">                    //长轮询或短轮循</span><br><span class="line">                    if (!this.brokerController.getBrokerConfig().isLongPollingEnable()) &#123;</span><br><span class="line">                        pollingTimeMills = this.brokerController.getBrokerConfig().getShortPollingTimeMills();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String topic = requestHeader.getTopic();</span><br><span class="line">                    long offset = requestHeader.getQueueOffset();</span><br><span class="line">                    int queueId = requestHeader.getQueueId();</span><br><span class="line">                    //创建PullRequest,然后提交给PullRequestHoldService线程调度，触发消息拉取</span><br><span class="line">                    PullRequest pullRequest = new PullRequest(request, channel, pollingTimeMills,</span><br><span class="line">                        this.brokerController.getMessageStore().now(), offset, subscriptionData, messageFilter);</span><br><span class="line">                    this.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</span><br><span class="line">                    response = null;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            case ResponseCode.PULL_RETRY_IMMEDIATELY:</span><br><span class="line">                break;</span><br><span class="line">            case ResponseCode.PULL_OFFSET_MOVED:</span><br><span class="line">                if (this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</span><br><span class="line">                    || this.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) &#123;</span><br><span class="line">                    MessageQueue mq = new MessageQueue();</span><br><span class="line">                    mq.setTopic(requestHeader.getTopic());</span><br><span class="line">                    mq.setQueueId(requestHeader.getQueueId());</span><br><span class="line">                    mq.setBrokerName(this.brokerController.getBrokerConfig().getBrokerName());</span><br><span class="line"></span><br><span class="line">                    OffsetMovedEvent event = new OffsetMovedEvent();</span><br><span class="line">                    event.setConsumerGroup(requestHeader.getConsumerGroup());</span><br><span class="line">                    event.setMessageQueue(mq);</span><br><span class="line">                    event.setOffsetRequest(requestHeader.getQueueOffset());</span><br><span class="line">                    event.setOffsetNew(getMessageResult.getNextBeginOffset());</span><br><span class="line">                    this.generateOffsetMovedEvent(event);</span><br><span class="line">                    log.warn(</span><br><span class="line">                        &quot;PULL_OFFSET_MOVED:correction offset. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, newOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;&quot;,</span><br><span class="line">                        requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</span><br><span class="line">                        responseHeader.getSuggestWhichBrokerId());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</span><br><span class="line">                    response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</span><br><span class="line">                    log.warn(&quot;PULL_OFFSET_MOVED:none correction. topic=&#123;&#125;, groupId=&#123;&#125;, requestOffset=&#123;&#125;, suggestBrokerId=&#123;&#125;&quot;,</span><br><span class="line">                        requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</span><br><span class="line">                        responseHeader.getSuggestWhichBrokerId());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                assert false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(&quot;store getMessage return null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //请求要求持久化进度&amp;&amp;broker非主，进行持久化进度。</span><br><span class="line">    boolean storeOffsetEnable = brokerAllowSuspend;</span><br><span class="line">    storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</span><br><span class="line">    storeOffsetEnable = storeOffsetEnable</span><br><span class="line">        &amp;&amp; this.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</span><br><span class="line">    if (storeOffsetEnable) &#123;</span><br><span class="line">        this.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</span><br><span class="line">            requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</span><br><span class="line">    &#125;</span><br><span class="line">    return response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DefaultMessageStore的getMessage方法"><a href="#2、DefaultMessageStore的getMessage方法" class="headerlink" title="2、DefaultMessageStore的getMessage方法"></a>2、DefaultMessageStore的getMessage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">public GetMessageResult getMessage(final String group, final String topic, final int queueId, final long offset,</span><br><span class="line">    final int maxMsgNums,</span><br><span class="line">    final MessageFilter messageFilter) &#123;</span><br><span class="line">    //是否关闭</span><br><span class="line">    if (this.shutdown) &#123;</span><br><span class="line">        log.warn(&quot;message store has shutdown, so getMessage is forbidden&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //是否可读</span><br><span class="line">    if (!this.runningFlags.isReadable()) &#123;</span><br><span class="line">        log.warn(&quot;message store is not readable, so getMessage is forbidden &quot; + this.runningFlags.getFlagBits());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long beginTime = this.getSystemClock().now();</span><br><span class="line"></span><br><span class="line">    GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</span><br><span class="line">    //设置拉取偏移量，从PullRequest中获取，初始从消费进度中获取</span><br><span class="line">    long nextBeginOffset = offset;</span><br><span class="line">    long minOffset = 0;</span><br><span class="line">    long maxOffset = 0;</span><br><span class="line"></span><br><span class="line">    GetMessageResult getResult = new GetMessageResult();</span><br><span class="line">    //获取commitlog文件中的最大偏移量</span><br><span class="line">    final long maxOffsetPy = this.commitLog.getMaxOffset();</span><br><span class="line">    //根据topic,queueId获取消息队列</span><br><span class="line">    ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</span><br><span class="line">    if (consumeQueue != null) &#123;</span><br><span class="line">        //获取该消息队列中最小偏移量(minOffset)，最大偏移量(maxOffset)</span><br><span class="line">        minOffset = consumeQueue.getMinOffsetInQueue();</span><br><span class="line">        maxOffset = consumeQueue.getMaxOffsetInQueue();</span><br><span class="line">        //需要拉取消息的偏移量与队列最小，最大偏移量进行对比</span><br><span class="line">        if (maxOffset == 0) &#123;</span><br><span class="line">            //消费队列无消息</span><br><span class="line">            status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</span><br><span class="line">            //下一个获取队列offset修正</span><br><span class="line">            nextBeginOffset = nextOffsetCorrection(offset, 0);</span><br><span class="line">        &#125; else if (offset &lt; minOffset) &#123;</span><br><span class="line">            //要拉取的偏移量小于队列最小的偏移量</span><br><span class="line">            status = GetMessageStatus.OFFSET_TOO_SMALL;</span><br><span class="line">            nextBeginOffset = nextOffsetCorrection(offset, minOffset);</span><br><span class="line">        &#125; else if (offset == maxOffset) &#123;</span><br><span class="line">            //查询offset超过消费队列一个位置</span><br><span class="line">            status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</span><br><span class="line">            nextBeginOffset = nextOffsetCorrection(offset, offset);</span><br><span class="line">        &#125; else if (offset &gt; maxOffset) &#123;</span><br><span class="line">            //查询offset超过消费队列太多(大于一个位置)</span><br><span class="line">            status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</span><br><span class="line">            if (0 == minOffset) &#123;</span><br><span class="line">                nextBeginOffset = nextOffsetCorrection(offset, minOffset);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //offset大于minOffset并小于maxOffset,正常情况</span><br><span class="line">            //从consuequeue中从当前offset到当前consueque中最大可读消息内存</span><br><span class="line">            SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</span><br><span class="line">            if (bufferConsumeQueue != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    status = GetMessageStatus.NO_MATCHED_MESSAGE;</span><br><span class="line">                    //commitLog下一个文件(MappedFile)对应的开始offset。</span><br><span class="line">                    long nextPhyFileStartOffset = Long.MIN_VALUE;</span><br><span class="line">                    //消息物理位置拉取到的最大offset</span><br><span class="line">                    long maxPhyOffsetPulling = 0;</span><br><span class="line"></span><br><span class="line">                    int i = 0;</span><br><span class="line">                    //最大过滤消息字节数</span><br><span class="line">                    final int maxFilterMessageCount = Math.max(16000, maxMsgNums * ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br><span class="line">                    final boolean diskFallRecorded = this.messageStoreConfig.isDiskFallRecorded();</span><br><span class="line">                    ConsumeQueueExt.CqExtUnit cqExtUnit = new ConsumeQueueExt.CqExtUnit();</span><br><span class="line">                    //循环获取消息位置信息</span><br><span class="line">                    for (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</span><br><span class="line">                        //消息物理位置offset</span><br><span class="line">                        long offsetPy = bufferConsumeQueue.getByteBuffer().getLong();</span><br><span class="line">                        //消息长度</span><br><span class="line">                        int sizePy = bufferConsumeQueue.getByteBuffer().getInt();</span><br><span class="line">                        //消息tag hashcode</span><br><span class="line">                        long tagsCode = bufferConsumeQueue.getByteBuffer().getLong();</span><br><span class="line">                        //当前拉取的物理偏移量</span><br><span class="line">                        maxPhyOffsetPulling = offsetPy;</span><br><span class="line">                        //拉取到的消息偏移量小于下一个要拉取的物理偏移量，直接跳过该条消息</span><br><span class="line">                        if (nextPhyFileStartOffset != Long.MIN_VALUE) &#123;</span><br><span class="line">                            if (offsetPy &lt; nextPhyFileStartOffset)</span><br><span class="line">                                continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //检查该offsetPy，拉取的偏移量是否在磁盘上</span><br><span class="line">                        boolean isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</span><br><span class="line">                        //判断获取消息是否已经拉满</span><br><span class="line">                        if (this.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</span><br><span class="line">                            isInDisk)) &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        boolean extRet = false, isTagsCodeLegal = true;</span><br><span class="line">                        if (consumeQueue.isExtAddr(tagsCode)) &#123;</span><br><span class="line">                            extRet = consumeQueue.getExt(tagsCode, cqExtUnit);</span><br><span class="line">                            if (extRet) &#123;</span><br><span class="line">                                tagsCode = cqExtUnit.getTagsCode();</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                // can&apos;t find ext content.Client will filter messages by tag also.</span><br><span class="line">                                log.error(&quot;[BUG] can&apos;t find consume queue extend file content!addr=&#123;&#125;, offsetPy=&#123;&#125;, sizePy=&#123;&#125;, topic=&#123;&#125;, group=&#123;&#125;&quot;,</span><br><span class="line">                                    tagsCode, offsetPy, sizePy, topic, group);</span><br><span class="line">                                isTagsCodeLegal = false;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //执行消息过滤，如果符合过滤条件。则直接进行下一条的拉取</span><br><span class="line">                        //如果不符合过滤条件，则进入继续执行，并如果最终符合条件，则将该消息添加到拉取结果中</span><br><span class="line">                        if (messageFilter != null</span><br><span class="line">                            &amp;&amp; !messageFilter.isMatchedByConsumeQueue(isTagsCodeLegal ? tagsCode : null, extRet ? cqExtUnit : null)) &#123;</span><br><span class="line">                            //从commitLog无法读取到消息，说明该消息对应的文件（MappedFile）已经删除，计算下一个MappedFile的起始位置</span><br><span class="line">                            if (getResult.getBufferTotalSize() == 0) &#123;</span><br><span class="line">                                status = GetMessageStatus.NO_MATCHED_MESSAGE;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //从commitlog文件中读取消息，根据偏移量与消息大小</span><br><span class="line">                        SelectMappedBufferResult selectResult = this.commitLog.getMessage(offsetPy, sizePy);</span><br><span class="line">                        //如果该偏移量没有找到正确的消息，则说明已经到文件末尾了</span><br><span class="line">                        if (null == selectResult) &#123;</span><br><span class="line">                            if (getResult.getBufferTotalSize() == 0) &#123;</span><br><span class="line">                                status = GetMessageStatus.MESSAGE_WAS_REMOVING;</span><br><span class="line">                            &#125;</span><br><span class="line">                            //下一次切换到下一个commitlog文件读取</span><br><span class="line">                            nextPhyFileStartOffset = this.commitLog.rollNextFile(offsetPy);</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        //从commitlog（全量消息）再次过滤</span><br><span class="line">                        if (messageFilter != null</span><br><span class="line">                            &amp;&amp; !messageFilter.isMatchedByCommitLog(selectResult.getByteBuffer().slice(), null)) &#123;</span><br><span class="line">                            if (getResult.getBufferTotalSize() == 0) &#123;</span><br><span class="line">                                status = GetMessageStatus.NO_MATCHED_MESSAGE;</span><br><span class="line">                            &#125;</span><br><span class="line">                            // release...</span><br><span class="line">                            selectResult.release();</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        this.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</span><br><span class="line">                        //将消息加入到拉取结果中</span><br><span class="line">                        getResult.addMessage(selectResult);</span><br><span class="line">                        status = GetMessageStatus.FOUND;</span><br><span class="line">                        nextPhyFileStartOffset = Long.MIN_VALUE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //是否记录磁盘活动图，默认为false</span><br><span class="line">                    if (diskFallRecorded) &#123;</span><br><span class="line">                        long fallBehind = maxOffsetPy - maxPhyOffsetPulling;</span><br><span class="line">                        brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //计算下次拉取消息的消息队列编号</span><br><span class="line">                    nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br><span class="line">                    //当前commitlog中的偏移量 - 当前最大拉取消息偏移量,则允许消息在内存中存在大小时，建议下一次拉取任务，从从节点拉取</span><br><span class="line">                    long diff = maxOffsetPy - maxPhyOffsetPulling;</span><br><span class="line">                    long memory = (long) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</span><br><span class="line">                        * (this.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / 100.0));</span><br><span class="line">                    getResult.setSuggestPullingFromSlave(diff &gt; memory);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line"></span><br><span class="line">                    bufferConsumeQueue.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                status = GetMessageStatus.OFFSET_FOUND_NULL;</span><br><span class="line">                nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</span><br><span class="line">                log.warn(&quot;consumer request topic: &quot; + topic + &quot;offset: &quot; + offset + &quot; minOffset: &quot; + minOffset + &quot; maxOffset: &quot;</span><br><span class="line">                    + maxOffset + &quot;, but access logic queue failed.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</span><br><span class="line">        nextBeginOffset = nextOffsetCorrection(offset, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    //统计</span><br><span class="line">    if (GetMessageStatus.FOUND == status) &#123;</span><br><span class="line">        this.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">    long eclipseTime = this.getSystemClock().now() - beginTime;</span><br><span class="line">    this.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);</span><br><span class="line">    //设置下一次拉取偏移量，然后返回拉取结果</span><br><span class="line">    getResult.setStatus(status);</span><br><span class="line">    getResult.setNextBeginOffset(nextBeginOffset);</span><br><span class="line">    getResult.setMaxOffset(maxOffset);</span><br><span class="line">    getResult.setMinOffset(minOffset);</span><br><span class="line">    return getResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、消息重试"><a href="#四、消息重试" class="headerlink" title="四、消息重试"></a>四、消息重试</h3><h4 id="1、SendMessageProcessor的consumerSendMsgBack方法"><a href="#1、SendMessageProcessor的consumerSendMsgBack方法" class="headerlink" title="1、SendMessageProcessor的consumerSendMsgBack方法"></a>1、SendMessageProcessor的consumerSendMsgBack方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">private RemotingCommand consumerSendMsgBack(final ChannelHandlerContext ctx, final RemotingCommand request)</span><br><span class="line">    throws RemotingCommandException &#123;</span><br><span class="line"></span><br><span class="line">    //初始化响应</span><br><span class="line">    final RemotingCommand response = RemotingCommand.createResponseCommand(null);</span><br><span class="line">    final ConsumerSendMsgBackRequestHeader requestHeader =</span><br><span class="line">        (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);</span><br><span class="line">    /hook</span><br><span class="line">    if (this.hasConsumeMessageHook() &amp;&amp; !UtilAll.isBlank(requestHeader.getOriginMsgId())) &#123;</span><br><span class="line"></span><br><span class="line">        ConsumeMessageContext context = new ConsumeMessageContext();</span><br><span class="line">        context.setConsumerGroup(requestHeader.getGroup());</span><br><span class="line">        context.setTopic(requestHeader.getOriginTopic());</span><br><span class="line">        context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);</span><br><span class="line">        context.setCommercialRcvTimes(1);</span><br><span class="line">        context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));</span><br><span class="line"></span><br><span class="line">        this.executeConsumeMessageHookAfter(context);</span><br><span class="line">    &#125;</span><br><span class="line">    //判断消费分组是否存在</span><br><span class="line">    SubscriptionGroupConfig subscriptionGroupConfig =</span><br><span class="line">        this.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());</span><br><span class="line">    if (null == subscriptionGroupConfig) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</span><br><span class="line">        response.setRemark(&quot;subscription group not exist, &quot; + requestHeader.getGroup() + &quot; &quot;</span><br><span class="line">            + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //检查broker是否有写入权限</span><br><span class="line">    if (!PermName.isWriteable(this.brokerController.getBrokerConfig().getBrokerPermission())) &#123;</span><br><span class="line">        response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">        response.setRemark(&quot;the broker[&quot; + this.brokerController.getBrokerConfig().getBrokerIP1() + &quot;] sending message is forbidden&quot;);</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //检查重试队列数是否大于0</span><br><span class="line">    if (subscriptionGroupConfig.getRetryQueueNums() &lt;= 0) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">        response.setRemark(null);</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //计算retry Topic</span><br><span class="line">    String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</span><br><span class="line">    //计算队列编号</span><br><span class="line">    int queueIdInt = Math.abs(this.random.nextInt() % 99999999) % subscriptionGroupConfig.getRetryQueueNums();</span><br><span class="line">    //计算sysFlag</span><br><span class="line">    int topicSysFlag = 0;</span><br><span class="line">    if (requestHeader.isUnitMode()) &#123;</span><br><span class="line">        topicSysFlag = TopicSysFlag.buildSysFlag(false, true);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取topicConfig。如果获取不到，则进行创建</span><br><span class="line">    TopicConfig topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(</span><br><span class="line">        newTopic,</span><br><span class="line">        subscriptionGroupConfig.getRetryQueueNums(),</span><br><span class="line">        PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);</span><br><span class="line">    if (null == topicConfig) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(&quot;topic[&quot; + newTopic + &quot;] not exist&quot;);</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!PermName.isWriteable(topicConfig.getPerm())) &#123;</span><br><span class="line">        response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">        response.setRemark(String.format(&quot;the topic[%s] sending message is forbidden&quot;, newTopic));</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //查询消息。若不存在，返回异常错误。</span><br><span class="line">    MessageExt msgExt = this.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</span><br><span class="line">    if (null == msgExt) &#123;</span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(&quot;look message by offset failed, &quot; + requestHeader.getOffset());</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置retryTopic到拓展属性</span><br><span class="line">    final String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</span><br><span class="line">    if (null == retryTopic) &#123;</span><br><span class="line">        MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());</span><br><span class="line">    &#125;</span><br><span class="line">    //设置消息不等待存储完成</span><br><span class="line">    msgExt.setWaitStoreMsgOK(false);</span><br><span class="line">    //处理 delayLevel</span><br><span class="line">    int delayLevel = requestHeader.getDelayLevel();</span><br><span class="line">    int maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</span><br><span class="line">    if (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) &#123;</span><br><span class="line">        maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes</span><br><span class="line">        || delayLevel &lt; 0) &#123;</span><br><span class="line">        //如果超过最大消费次数，则topic修改成&quot;%DLQ%&quot; + 分组名，即加入 死信队列(Dead Letter Queue)</span><br><span class="line">        newTopic = MixAll.getDLQTopic(requestHeader.getGroup());</span><br><span class="line">        queueIdInt = Math.abs(this.random.nextInt() % 99999999) % DLQ_NUMS_PER_GROUP;</span><br><span class="line"></span><br><span class="line">        topicConfig = this.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic,</span><br><span class="line">            DLQ_NUMS_PER_GROUP,</span><br><span class="line">            PermName.PERM_WRITE, 0</span><br><span class="line">        );</span><br><span class="line">        if (null == topicConfig) &#123;</span><br><span class="line">            response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">            response.setRemark(&quot;topic[&quot; + newTopic + &quot;] not exist&quot;);</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (0 == delayLevel) &#123;</span><br><span class="line">            delayLevel = 3 + msgExt.getReconsumeTimes();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        msgExt.setDelayTimeLevel(delayLevel);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建MessageExtBrokerInner</span><br><span class="line">    MessageExtBrokerInner msgInner = new MessageExtBrokerInner();</span><br><span class="line">    msgInner.setTopic(newTopic);</span><br><span class="line">    msgInner.setBody(msgExt.getBody());</span><br><span class="line">    msgInner.setFlag(msgExt.getFlag());</span><br><span class="line">    MessageAccessor.setProperties(msgInner, msgExt.getProperties());</span><br><span class="line">    msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</span><br><span class="line">    msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(null, msgExt.getTags()));</span><br><span class="line"></span><br><span class="line">    msgInner.setQueueId(queueIdInt);</span><br><span class="line">    msgInner.setSysFlag(msgExt.getSysFlag());</span><br><span class="line">    msgInner.setBornTimestamp(msgExt.getBornTimestamp());</span><br><span class="line">    msgInner.setBornHost(msgExt.getBornHost());</span><br><span class="line">    msgInner.setStoreHost(this.getStoreHost());</span><br><span class="line">    msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + 1);</span><br><span class="line">    //设置原始消息编号到拓展字段</span><br><span class="line">    String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</span><br><span class="line">    MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</span><br><span class="line">    //添加消息</span><br><span class="line">    PutMessageResult putMessageResult = this.brokerController.getMessageStore().putMessage(msgInner);</span><br><span class="line">    if (putMessageResult != null) &#123;</span><br><span class="line">        switch (putMessageResult.getPutMessageStatus()) &#123;</span><br><span class="line">            case PUT_OK:</span><br><span class="line">                String backTopic = msgExt.getTopic();</span><br><span class="line">                String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</span><br><span class="line">                if (correctTopic != null) &#123;</span><br><span class="line">                    backTopic = correctTopic;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                this.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);</span><br><span class="line"></span><br><span class="line">                response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">                response.setRemark(null);</span><br><span class="line"></span><br><span class="line">                return response;</span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">        response.setRemark(putMessageResult.getPutMessageStatus().name());</span><br><span class="line">        return response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.setCode(ResponseCode.SYSTEM_ERROR);</span><br><span class="line">    response.setRemark(&quot;putMessageResult is null&quot;);</span><br><span class="line">    return response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="五、主从同步"><a href="#五、主从同步" class="headerlink" title="五、主从同步"></a>五、主从同步</h3><h4 id="1、HAService的start方法"><a href="#1、HAService的start方法" class="headerlink" title="1、HAService的start方法"></a>1、HAService的start方法</h4><p>Master部份<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws Exception &#123;</span><br><span class="line">    //接收Slave的连接并构建HAConnection实例</span><br><span class="line">    this.acceptSocketService.beginAccept();</span><br><span class="line">    this.acceptSocketService.start();</span><br><span class="line">    //Master中，GroupTransferService会作为一个中间的服务，设置一个标志位，用来判断Slave是否已经同步完成 </span><br><span class="line">    this.groupTransferService.start();</span><br><span class="line">    //Slave客户端</span><br><span class="line">    this.haClient.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、AcceptSocketService的start方法"><a href="#2、AcceptSocketService的start方法" class="headerlink" title="2、AcceptSocketService的start方法"></a>2、AcceptSocketService的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void beginAccept() throws Exception &#123;</span><br><span class="line">    //nio服务端</span><br><span class="line">    this.serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">    this.selector = RemotingUtil.openSelector();</span><br><span class="line">    this.serverSocketChannel.socket().setReuseAddress(true);</span><br><span class="line">    this.serverSocketChannel.socket().bind(this.socketAddressListen);</span><br><span class="line">    this.serverSocketChannel.configureBlocking(false);</span><br><span class="line">    //将Channel注册到Selector，等待OP_ACCEPT就绪</span><br><span class="line">    this.serverSocketChannel.register(this.selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AcceptSocketService的run方法"><a href="#3、AcceptSocketService的run方法" class="headerlink" title="3、AcceptSocketService的run方法"></a>3、AcceptSocketService的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">    while (!this.isStopped()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.selector.select(1000);</span><br><span class="line">            //获取已就绪通道的集合</span><br><span class="line">            Set&lt;SelectionKey&gt; selected = this.selector.selectedKeys();</span><br><span class="line"></span><br><span class="line">            if (selected != null) &#123;</span><br><span class="line">                for (SelectionKey k : selected) &#123;</span><br><span class="line">                    if ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != 0) &#123;</span><br><span class="line">                        //获取通道</span><br><span class="line">                        SocketChannel sc = ((ServerSocketChannel) k.channel()).accept();</span><br><span class="line"></span><br><span class="line">                        if (sc != null) &#123;</span><br><span class="line">                            HAService.log.info(&quot;HAService receive new connection, &quot;</span><br><span class="line">                                + sc.socket().getRemoteSocketAddress());</span><br><span class="line"></span><br><span class="line">                            try &#123;</span><br><span class="line">                                //创建HAConnection，并加入HAService</span><br><span class="line">                                HAConnection conn = new HAConnection(HAService.this, sc);</span><br><span class="line">                                //启动readSocketService、writeSocketService</span><br><span class="line">                                conn.start();</span><br><span class="line">                                //连接添加到connectionList中</span><br><span class="line">                                HAService.this.addConnection(conn);</span><br><span class="line">                            &#125; catch (Exception e) &#123;</span><br><span class="line">                                log.error(&quot;new HAConnection exception&quot;, e);</span><br><span class="line">                                sc.close();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        log.warn(&quot;Unexpected ops in select &quot; + k.readyOps());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                selected.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(this.getServiceName() + &quot; service has exception.&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、ReadSocketService的run方法"><a href="#4、ReadSocketService的run方法" class="headerlink" title="4、ReadSocketService的run方法"></a>4、ReadSocketService的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    HAConnection.log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">    while (!this.isStopped()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.selector.select(1000);</span><br><span class="line">            //处理读取到的数据</span><br><span class="line">            boolean ok = this.processReadEvent();</span><br><span class="line">            if (!ok) &#123;</span><br><span class="line">                HAConnection.log.error(&quot;processReadEvent error&quot;);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            //检测心跳间隔时间</span><br><span class="line">            long interval = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now() - this.lastReadTimestamp;</span><br><span class="line">            //超时</span><br><span class="line">            if (interval &gt; HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaHousekeepingInterval()) &#123;</span><br><span class="line">                log.warn(&quot;ha housekeeping, found this connection[&quot; + HAConnection.this.clientAddr + &quot;] expired, &quot; + interval);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            HAConnection.log.error(this.getServiceName() + &quot; service has exception.&quot;, e);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //关闭readSocketService</span><br><span class="line">    this.makeStop();</span><br><span class="line">    //关闭writeSocketService</span><br><span class="line">    writeSocketService.makeStop();</span><br><span class="line">    //移除本HAConnection</span><br><span class="line">    haService.removeConnection(HAConnection.this);</span><br><span class="line">    //HAConnection数量减一</span><br><span class="line">    HAConnection.this.haService.getConnectionCount().decrementAndGet();</span><br><span class="line">    //注销socketChannel</span><br><span class="line">    SelectionKey sk = this.socketChannel.keyFor(this.selector);</span><br><span class="line">    if (sk != null) &#123;</span><br><span class="line">        sk.cancel();</span><br><span class="line">    &#125;</span><br><span class="line">    //关闭通道</span><br><span class="line">    try &#123;</span><br><span class="line">        this.selector.close();</span><br><span class="line">        this.socketChannel.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        HAConnection.log.error(&quot;&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HAConnection.log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、ReadSocketService的processReadEvent方法"><a href="#5、ReadSocketService的processReadEvent方法" class="headerlink" title="5、ReadSocketService的processReadEvent方法"></a>5、ReadSocketService的processReadEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">private boolean processReadEvent() &#123;</span><br><span class="line">    int readSizeZeroTimes = 0;</span><br><span class="line">    //缓冲区已处理完</span><br><span class="line">    if (!this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line">        this.byteBufferRead.flip();</span><br><span class="line">        this.processPostion = 0;</span><br><span class="line">    &#125;</span><br><span class="line">    //有待处理数据</span><br><span class="line">    while (this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            int readSize = this.socketChannel.read(this.byteBufferRead);</span><br><span class="line">            if (readSize &gt; 0) &#123;</span><br><span class="line">                readSizeZeroTimes = 0;</span><br><span class="line">                this.lastReadTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();</span><br><span class="line">                //接收Slave上传的offset</span><br><span class="line">                if ((this.byteBufferRead.position() - this.processPostion) &gt;= 8) &#123;</span><br><span class="line">                    int pos = this.byteBufferRead.position() - (this.byteBufferRead.position() % 8);</span><br><span class="line">                    long readOffset = this.byteBufferRead.getLong(pos - 8);</span><br><span class="line">                    this.processPostion = pos;</span><br><span class="line">                    //更新slaveAckOffset，每次Slave上传的Offset </span><br><span class="line">                    HAConnection.this.slaveAckOffset = readOffset;</span><br><span class="line">                    if (HAConnection.this.slaveRequestOffset &lt; 0) &#123;</span><br><span class="line">                        //更新slaveRequestOffset,第一次Slave上传的offset</span><br><span class="line">                        HAConnection.this.slaveRequestOffset = readOffset;</span><br><span class="line">                        log.info(&quot;slave[&quot; + HAConnection.this.clientAddr + &quot;] request offset &quot; + readOffset);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //通知GroupTransferService线程</span><br><span class="line">                    HAConnection.this.haService.notifyTransferSome(HAConnection.this.slaveAckOffset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (readSize == 0) &#123;</span><br><span class="line">                if (++readSizeZeroTimes &gt;= 3) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.error(&quot;read socket[&quot; + HAConnection.this.clientAddr + &quot;] &lt; 0&quot;);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.error(&quot;processReadEvent exception&quot;, e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、WriteSocketService的run方法"><a href="#6、WriteSocketService的run方法" class="headerlink" title="6、WriteSocketService的run方法"></a>6、WriteSocketService的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    HAConnection.log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">    while (!this.isStopped()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.selector.select(1000);</span><br><span class="line">            //等待slave同步Offset</span><br><span class="line">            if (-1 == HAConnection.this.slaveRequestOffset) &#123;</span><br><span class="line">                Thread.sleep(10);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            //计算下次同步的偏移位置开始量</span><br><span class="line">            if (-1 == this.nextTransferFromWhere) &#123;</span><br><span class="line">                if (0 == HAConnection.this.slaveRequestOffset) &#123;</span><br><span class="line">                    long masterOffset = HAConnection.this.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();</span><br><span class="line">                    masterOffset =</span><br><span class="line">                        masterOffset</span><br><span class="line">                            - (masterOffset % HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig()</span><br><span class="line">                            .getMapedFileSizeCommitLog());</span><br><span class="line"></span><br><span class="line">                    if (masterOffset &lt; 0) &#123;</span><br><span class="line">                        masterOffset = 0;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    this.nextTransferFromWhere = masterOffset;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    this.nextTransferFromWhere = HAConnection.this.slaveRequestOffset;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                log.info(&quot;master transfer data from &quot; + this.nextTransferFromWhere + &quot; to slave[&quot; + HAConnection.this.clientAddr</span><br><span class="line">                    + &quot;], and slave request &quot; + HAConnection.this.slaveRequestOffset);</span><br><span class="line">            &#125;</span><br><span class="line">            //是否传输完成</span><br><span class="line">            if (this.lastWriteOver) &#123;</span><br><span class="line">                //同步间隔时间</span><br><span class="line">                long interval =</span><br><span class="line">                    HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;</span><br><span class="line">                //间隔大于五秒</span><br><span class="line">                if (interval &gt; HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig()</span><br><span class="line">                    .getHaSendHeartbeatInterval()) &#123;</span><br><span class="line"></span><br><span class="line">                    // Build Header</span><br><span class="line">                    //构造header</span><br><span class="line">                    this.byteBufferHeader.position(0);</span><br><span class="line">                    this.byteBufferHeader.limit(headerSize);</span><br><span class="line">                    this.byteBufferHeader.putLong(this.nextTransferFromWhere);</span><br><span class="line">                    this.byteBufferHeader.putInt(0);</span><br><span class="line">                    this.byteBufferHeader.flip();</span><br><span class="line">                    //传输数据</span><br><span class="line">                    this.lastWriteOver = this.transferData();</span><br><span class="line">                    if (!this.lastWriteOver)</span><br><span class="line">                        continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.lastWriteOver = this.transferData();</span><br><span class="line">                if (!this.lastWriteOver)</span><br><span class="line">                    continue;</span><br><span class="line">            &#125;</span><br><span class="line">            //传入一个offset，从CommitLog去拉取消息，和消费者拉取消息类似</span><br><span class="line">            SelectMappedBufferResult selectResult =</span><br><span class="line">                HAConnection.this.haService.getDefaultMessageStore().getCommitLogData(this.nextTransferFromWhere);</span><br><span class="line">            if (selectResult != null) &#123;</span><br><span class="line">                int size = selectResult.getSize();</span><br><span class="line">                //每次只同步32K的数据</span><br><span class="line">                if (size &gt; HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) &#123;</span><br><span class="line">                    size = HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                long thisOffset = this.nextTransferFromWhere;</span><br><span class="line">                this.nextTransferFromWhere += size;</span><br><span class="line">                //限制byteBuf最多只能操作32K的数据</span><br><span class="line">                selectResult.getByteBuffer().limit(size);</span><br><span class="line">                this.selectMappedBufferResult = selectResult;</span><br><span class="line"></span><br><span class="line">                // Build Header</span><br><span class="line">                //构造header</span><br><span class="line">                this.byteBufferHeader.position(0);</span><br><span class="line">                this.byteBufferHeader.limit(headerSize);</span><br><span class="line">                this.byteBufferHeader.putLong(thisOffset);</span><br><span class="line">                this.byteBufferHeader.putInt(size);</span><br><span class="line">                this.byteBufferHeader.flip();</span><br><span class="line">                //传输数据</span><br><span class="line">                this.lastWriteOver = this.transferData();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line"></span><br><span class="line">                HAConnection.this.haService.getWaitNotifyObject().allWaitForRunning(100);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            HAConnection.log.error(this.getServiceName() + &quot; service has exception.&quot;, e);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HAConnection.this.haService.getWaitNotifyObject().removeFromWaitingThreadTable();</span><br><span class="line"></span><br><span class="line">    if (this.selectMappedBufferResult != null) &#123;</span><br><span class="line">        this.selectMappedBufferResult.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.makeStop();</span><br><span class="line"></span><br><span class="line">    readSocketService.makeStop();</span><br><span class="line"></span><br><span class="line">    haService.removeConnection(HAConnection.this);</span><br><span class="line"></span><br><span class="line">    SelectionKey sk = this.socketChannel.keyFor(this.selector);</span><br><span class="line">    if (sk != null) &#123;</span><br><span class="line">        sk.cancel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.selector.close();</span><br><span class="line">        this.socketChannel.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        HAConnection.log.error(&quot;&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HAConnection.log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、GroupTransferService的run方法"><a href="#7、GroupTransferService的run方法" class="headerlink" title="7、GroupTransferService的run方法"></a>7、GroupTransferService的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">     log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">     while (!this.isStopped()) &#123;</span><br><span class="line">         try &#123;</span><br><span class="line">             //运行间隔</span><br><span class="line">             this.waitForRunning(10);</span><br><span class="line">             //标记同步完成</span><br><span class="line">             this.doWaitTransfer();</span><br><span class="line">         &#125; catch (Exception e) &#123;</span><br><span class="line">             log.warn(this.getServiceName() + &quot; service has exception. &quot;, e);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、GroupTransferService的doWaitTransfer方法"><a href="#8、GroupTransferService的doWaitTransfer方法" class="headerlink" title="8、GroupTransferService的doWaitTransfer方法"></a>8、GroupTransferService的doWaitTransfer方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private void doWaitTransfer() &#123;</span><br><span class="line">    synchronized (this.requestsRead) &#123;</span><br><span class="line">        if (!this.requestsRead.isEmpty()) &#123;</span><br><span class="line">            //等待同步完成的请求</span><br><span class="line">            for (CommitLog.GroupCommitRequest req : this.requestsRead) &#123;</span><br><span class="line">                boolean transferOK = HAService.this.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</span><br><span class="line">                //重试5次，每次条件不符合都等待Slave上传同步结果</span><br><span class="line">                for (int i = 0; !transferOK &amp;&amp; i &lt; 5; i++) &#123;</span><br><span class="line">                    this.notifyTransferObject.waitForRunning(1000);</span><br><span class="line">                    transferOK = HAService.this.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (!transferOK) &#123;</span><br><span class="line">                    log.warn(&quot;transfer messsage to slave timeout, &quot; + req.getNextOffset());</span><br><span class="line">                &#125;</span><br><span class="line">                //标记同步完成</span><br><span class="line">                req.wakeupCustomer(transferOK);</span><br><span class="line">            &#125;</span><br><span class="line">            this.requestsRead.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、HAClient的run方法"><a href="#9、HAClient的run方法" class="headerlink" title="9、HAClient的run方法"></a>9、HAClient的run方法</h4><p>Slave部份<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"></span><br><span class="line">    while (!this.isStopped()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //如果masterAddress不为空，会进行连接并返回SocketChannel，Master没有masterAddress所以这里直接跳过</span><br><span class="line">            if (this.connectMaster()) &#123;</span><br><span class="line">                //先汇报最大物理Offset，定时心跳方式汇报，默认5s进行同步</span><br><span class="line">                if (this.isTimeToReportOffset()) &#123;</span><br><span class="line">                    //将同步进度发送回Master</span><br><span class="line">                    boolean result = this.reportSlaveMaxOffset(this.currentReportedOffset);</span><br><span class="line">                    if (!result) &#123;</span><br><span class="line">                        this.closeMaster();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //等待应答</span><br><span class="line">                this.selector.select(1000);</span><br><span class="line">                //接收数据</span><br><span class="line">                boolean ok = this.processReadEvent();</span><br><span class="line">                if (!ok) &#123;</span><br><span class="line">                    this.closeMaster();</span><br><span class="line">                &#125;</span><br><span class="line">                //只要本地有更新，就汇报最大物理Offset</span><br><span class="line">                if (!reportSlaveMaxOffsetPlus()) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //检查Master的反向心跳</span><br><span class="line">                long interval =</span><br><span class="line">                    HAService.this.getDefaultMessageStore().getSystemClock().now()</span><br><span class="line">                        - this.lastWriteTimestamp;</span><br><span class="line">                if (interval &gt; HAService.this.getDefaultMessageStore().getMessageStoreConfig()</span><br><span class="line">                    .getHaHousekeepingInterval()) &#123;</span><br><span class="line">                    log.warn(&quot;HAClient, housekeeping, found this connection[&quot; + this.masterAddress</span><br><span class="line">                        + &quot;] expired, &quot; + interval);</span><br><span class="line">                    this.closeMaster();</span><br><span class="line">                    log.warn(&quot;HAClient, master not response some time, so close connection&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.waitForRunning(1000 * 5);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(this.getServiceName() + &quot; service has exception. &quot;, e);</span><br><span class="line">            this.waitForRunning(1000 * 5);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="10、HAClient的processReadEvent方法"><a href="#10、HAClient的processReadEvent方法" class="headerlink" title="10、HAClient的processReadEvent方法"></a>10、HAClient的processReadEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private boolean processReadEvent() &#123;</span><br><span class="line">    int readSizeZeroTimes = 0;</span><br><span class="line">    while (this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //读取Master发送的消息</span><br><span class="line">            int readSize = this.socketChannel.read(this.byteBufferRead);</span><br><span class="line">            if (readSize &gt; 0) &#123;</span><br><span class="line">                lastWriteTimestamp = HAService.this.defaultMessageStore.getSystemClock().now();</span><br><span class="line">                readSizeZeroTimes = 0;</span><br><span class="line">                //对读取的数据进行处理</span><br><span class="line">                boolean result = this.dispatchReadRequest();</span><br><span class="line">                if (!result) &#123;</span><br><span class="line">                    log.error(&quot;HAClient, dispatchReadRequest error&quot;);</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (readSize == 0) &#123;</span><br><span class="line">                if (++readSizeZeroTimes &gt;= 3) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                log.info(&quot;HAClient, processReadEvent read socket &lt; 0&quot;);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            log.info(&quot;HAClient, processReadEvent read socket exception&quot;, e);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、HAClient的dispatchReadRequest方法"><a href="#11、HAClient的dispatchReadRequest方法" class="headerlink" title="11、HAClient的dispatchReadRequest方法"></a>11、HAClient的dispatchReadRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">private boolean dispatchReadRequest() &#123;</span><br><span class="line">    final int msgHeaderSize = 8 + 4; // phyoffset + size</span><br><span class="line">    int readSocketPos = this.byteBufferRead.position();</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">        //读取数据的位置与上次读取位置的差</span><br><span class="line">        int diff = this.byteBufferRead.position() - this.dispatchPostion;</span><br><span class="line">        //diff大于Head的大小</span><br><span class="line">        if (diff &gt;= msgHeaderSize) &#123;</span><br><span class="line">            long masterPhyOffset = this.byteBufferRead.getLong(this.dispatchPostion);</span><br><span class="line">            int bodySize = this.byteBufferRead.getInt(this.dispatchPostion + 8);</span><br><span class="line"></span><br><span class="line">            long slavePhyOffset = HAService.this.defaultMessageStore.getMaxPhyOffset();</span><br><span class="line">            //检验Master和Slave之间的Offset</span><br><span class="line">            if (slavePhyOffset != 0) &#123;</span><br><span class="line">                if (slavePhyOffset != masterPhyOffset) &#123;</span><br><span class="line">                    log.error(&quot;master pushed offset not equal the max phy offset in slave, SLAVE: &quot;</span><br><span class="line">                        + slavePhyOffset + &quot; MASTER: &quot; + masterPhyOffset);</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //diff大于msgHeaderSize+bodySize的值，拆包</span><br><span class="line">            if (diff &gt;= (msgHeaderSize + bodySize)) &#123;</span><br><span class="line">                byte[] bodyData = new byte[bodySize];</span><br><span class="line">                this.byteBufferRead.position(this.dispatchPostion + msgHeaderSize);</span><br><span class="line">                this.byteBufferRead.get(bodyData);</span><br><span class="line">                //将Master发送的消息写到CommitLog</span><br><span class="line">                HAService.this.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);</span><br><span class="line"></span><br><span class="line">                this.byteBufferRead.position(readSocketPos);</span><br><span class="line">                //更新读取位置</span><br><span class="line">                this.dispatchPostion += msgHeaderSize + bodySize;</span><br><span class="line">                //将同步进度发送回Master</span><br><span class="line">                if (!reportSlaveMaxOffsetPlus()) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line">            this.reallocateByteBuffer();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>