<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="qq"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="MyBatis的sql执行过程（1）"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="qq"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>MyBatis的sql执行过程（1） - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>MyBatis的sql执行过程（1）</h1>
                    
                    <h2 class="post-subheading">
                        MyBatis查询selectOneById方法的执行过程
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-04-20
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/mybatis3/">mybatis3</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="一、获取SqlSession过程"><a href="#一、获取SqlSession过程" class="headerlink" title="一、获取SqlSession过程"></a>一、获取SqlSession过程</h3><h4 id="1、DefaultSqlSessionFactory的openSession方法"><a href="#1、DefaultSqlSessionFactory的openSession方法" class="headerlink" title="1、DefaultSqlSessionFactory的openSession方法"></a>1、DefaultSqlSessionFactory的openSession方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSession openSession() &#123;</span><br><span class="line">    return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DefaultSqlSessionFactory的openSession方法"><a href="#2、DefaultSqlSessionFactory的openSession方法" class="headerlink" title="2、DefaultSqlSessionFactory的openSession方法"></a>2、DefaultSqlSessionFactory的openSession方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSession openSession() &#123;</span><br><span class="line">    return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultSqlSessionFactory的openSessionFromDataSource方法"><a href="#3、DefaultSqlSessionFactory的openSessionFromDataSource方法" class="headerlink" title="3、DefaultSqlSessionFactory的openSessionFromDataSource方法"></a>3、DefaultSqlSessionFactory的openSessionFromDataSource方法</h4><h5 id="这个是最终创建SqlSession对象的方法，需要三个参数。"><a href="#这个是最终创建SqlSession对象的方法，需要三个参数。" class="headerlink" title="这个是最终创建SqlSession对象的方法，需要三个参数。"></a>这个是最终创建SqlSession对象的方法，需要三个参数。</h5><h5 id="execType-这个示例使用的是configuration-getDefaultExecutorType-默认ExecutorType-SIMPLE。"><a href="#execType-这个示例使用的是configuration-getDefaultExecutorType-默认ExecutorType-SIMPLE。" class="headerlink" title="execType,这个示例使用的是configuration.getDefaultExecutorType(),默认ExecutorType.SIMPLE。"></a>execType,这个示例使用的是configuration.getDefaultExecutorType(),默认ExecutorType.SIMPLE。</h5><h5 id="事务隔离等级，我们对数据库操作里一般都不会带这个属性，这个属性由数据库分配即可。"><a href="#事务隔离等级，我们对数据库操作里一般都不会带这个属性，这个属性由数据库分配即可。" class="headerlink" title="事务隔离等级，我们对数据库操作里一般都不会带这个属性，这个属性由数据库分配即可。"></a>事务隔离等级，我们对数据库操作里一般都不会带这个属性，这个属性由数据库分配即可。</h5><h5 id="autoCommit-这个一般都是false，不然事务将没有意义。"><a href="#autoCommit-这个一般都是false，不然事务将没有意义。" class="headerlink" title="autoCommit:这个一般都是false，不然事务将没有意义。"></a>autoCommit:这个一般都是false，不然事务将没有意义。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        final Environment environment = configuration.getEnvironment();</span><br><span class="line">        //获取一个事务工厂,配置文件中配置,默认ManagedTransactionFactory</span><br><span class="line">        final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">        //通过事务工厂获取一个事务，默认ManagedTransaction 这个配置从来都不提交和回滚一个连接，而是让容器来管理事务的整个生命周期（比如JEE应用服务的上下文）。</span><br><span class="line">        //默认情况下他会关闭连接，closeConnection属性设置为false来阻止它默认的关闭行为</span><br><span class="line">        //JdbcTransactionFactory,这个配置就是直接使用了JDBC 的提交和回滚设置，它依赖于从数据源得到的连接来管理事务范围。</span><br><span class="line">        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">        //根据execType获取一个Executor，默认SimpleExecutor</span><br><span class="line">        final Executor executor = configuration.newExecutor(tx, execType, autoCommit);</span><br><span class="line">        return new DefaultSqlSession(configuration, executor);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        closeTransaction(tx); // may have fetched a connection so lets call close()</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、Configuration的newExecutor方法"><a href="#4、Configuration的newExecutor方法" class="headerlink" title="4、Configuration的newExecutor方法"></a>4、Configuration的newExecutor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Executor newExecutor(Transaction transaction, ExecutorType executorType, boolean autoCommit) &#123;</span><br><span class="line">    executorType = executorType == null ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    if (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">        executor = new BatchExecutor(this, transaction);</span><br><span class="line">    &#125; else if (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">        executor = new ReuseExecutor(this, transaction);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //默认</span><br><span class="line">        executor = new SimpleExecutor(this, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    if (cacheEnabled) &#123;</span><br><span class="line">         executor = new CachingExecutor(executor, autoCommit);</span><br><span class="line">    &#125;</span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    return executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、Configuration的newExecutor方法"><a href="#5、Configuration的newExecutor方法" class="headerlink" title="5、Configuration的newExecutor方法"></a>5、Configuration的newExecutor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public Executor newExecutor(Transaction transaction, ExecutorType executorType, boolean autoCommit) &#123;</span><br><span class="line">    executorType = executorType == null ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    if (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">        //批量执行器</span><br><span class="line">        executor = new BatchExecutor(this, transaction);</span><br><span class="line">    &#125; else if (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">        executor = new ReuseExecutor(this, transaction);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //默认执行器</span><br><span class="line">        executor = new SimpleExecutor(this, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    if (cacheEnabled) &#123;</span><br><span class="line">        //使用二级缓存，则用该执行器封装一层</span><br><span class="line">        executor = new CachingExecutor(executor, autoCommit);</span><br><span class="line">    &#125;</span><br><span class="line">    //拦截器</span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    return executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###二、创建Mapper代理对象过程</p>
<h4 id="1、DefaultSqlSession的getMapper方法"><a href="#1、DefaultSqlSession的getMapper方法" class="headerlink" title="1、DefaultSqlSession的getMapper方法"></a>1、DefaultSqlSession的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type) &#123;</span><br><span class="line">    return configuration.&lt;T&gt;getMapper(type, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、Configuration的getMapper方法"><a href="#2、Configuration的getMapper方法" class="headerlink" title="2、Configuration的getMapper方法"></a>2、Configuration的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type) &#123;</span><br><span class="line">    return configuration.&lt;T&gt;getMapper(type, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、mapperRegistry的getMapper方法"><a href="#3、mapperRegistry的getMapper方法" class="headerlink" title="3、mapperRegistry的getMapper方法"></a>3、mapperRegistry的getMapper方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line">    //代理工厂</span><br><span class="line">    final MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    if (mapperProxyFactory == null)</span><br><span class="line">        //说明这个Mapper接口没有注册 </span><br><span class="line">        throw new BindingException(&quot;Type &quot; + type + &quot; is not known to the MapperRegistry.&quot;);</span><br><span class="line">    try &#123;</span><br><span class="line">        //生成一个MapperProxy对象</span><br><span class="line">        return mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new BindingException(&quot;Error getting mapper instance. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、MapperProxyFactory的newInstance方法"><a href="#4、MapperProxyFactory的newInstance方法" class="headerlink" title="4、MapperProxyFactory的newInstance方法"></a>4、MapperProxyFactory的newInstance方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public T newInstance(SqlSession sqlSession) &#123;</span><br><span class="line">    //JDK动态代理InvocationHandler的实现类，在该类methodCache管理了被代理的方法，methodCache在整个应用中是共享的</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    return newInstance(mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    //创建Mapper接口子类的代理类</span><br><span class="line">    return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、DemoMapper的selectOneById方法"><a href="#5、DemoMapper的selectOneById方法" class="headerlink" title="5、DemoMapper的selectOneById方法"></a>5、DemoMapper的selectOneById方法</h4><h5 id="自动创建的代理类，执行MapperProxy的invoke方法"><a href="#自动创建的代理类，执行MapperProxy的invoke方法" class="headerlink" title="自动创建的代理类，执行MapperProxy的invoke方法"></a>自动创建的代理类，执行MapperProxy的invoke方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        //如果是Object中定义的方法，直接执行。如toString(),hashCode()等。  </span><br><span class="line">        return method.invoke(this, args);</span><br><span class="line">    &#125;</span><br><span class="line">    //其他Mapper接口定义的方法交由mapperMethod来执行</span><br><span class="line">    final MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    return mapperMethod.execute(sqlSession, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、MapperMethod的execute方法"><a href="#6、MapperMethod的execute方法" class="headerlink" title="6、MapperMethod的execute方法"></a>6、MapperMethod的execute方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    //判断这个方法被注解里的Sql类型</span><br><span class="line">    if (SqlCommandType.INSERT == command.getType()) &#123;</span><br><span class="line">        //增</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">    &#125; else if (SqlCommandType.UPDATE == command.getType()) &#123;</span><br><span class="line">        //改</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">    &#125; else if (SqlCommandType.DELETE == command.getType()) &#123;</span><br><span class="line">        //删</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">    &#125; else if (SqlCommandType.SELECT == command.getType()) &#123;</span><br><span class="line">        //查</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">            //没有返回值，并且有ResultHandler的情况</span><br><span class="line">            executeWithResultHandler(sqlSession, args);</span><br><span class="line">            result = null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">            //返回一个List</span><br><span class="line">            result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">            //返回一个Map</span><br><span class="line">            result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //返回一个对象</span><br><span class="line">            Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">            result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">        throw new BindingException(&quot;Mapper method &apos;&quot; + command.getName() </span><br><span class="line">              + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、MapperMethod的executeForMany方法"><a href="#7、MapperMethod的executeForMany方法" class="headerlink" title="7、MapperMethod的executeForMany方法"></a>7、MapperMethod的executeForMany方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private &lt;E&gt; Object executeForMany(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    List&lt;E&gt; result;</span><br><span class="line">    //解析传入参数</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    if (method.hasRowBounds()) &#123;</span><br><span class="line">        //结果有数量限制</span><br><span class="line">        RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">        result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        result = sqlSession.&lt;E&gt;selectList(command.getName(), param);</span><br><span class="line">    &#125;</span><br><span class="line">    // issue #510 Collections &amp; arrays support</span><br><span class="line">    if (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">        if (method.getReturnType().isArray()) &#123;</span><br><span class="line">            return convertToArray(result);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //sql返回的集合，转化为方法声明的集合</span><br><span class="line">            return convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、MapperMethod的convertArgsToSqlCommandParam方法"><a href="#8、MapperMethod的convertArgsToSqlCommandParam方法" class="headerlink" title="8、MapperMethod的convertArgsToSqlCommandParam方法"></a>8、MapperMethod的convertArgsToSqlCommandParam方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public Object convertArgsToSqlCommandParam(Object[] args) &#123;</span><br><span class="line">    //参数个数，配置加载的时候，parameterType只能有一个参数</span><br><span class="line">    final int paramCount = params.size();</span><br><span class="line">    if (args == null || paramCount == 0) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else if (!hasNamedParameters &amp;&amp; paramCount == 1) &#123;</span><br><span class="line">        //获取并返回参数</span><br><span class="line">        return args[params.keySet().iterator().next()];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final Map&lt;String, Object&gt; param = new ParamMap&lt;Object&gt;();</span><br><span class="line">        int i = 0;</span><br><span class="line">        for (Map.Entry&lt;Integer, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">            //按照对应顺序获取参数</span><br><span class="line">            param.put(entry.getValue(), args[entry.getKey()]);</span><br><span class="line">            final String genericParamName = &quot;param&quot; + String.valueOf(i + 1);</span><br><span class="line">            if (!param.containsKey(genericParamName)) &#123;</span><br><span class="line">                param.put(genericParamName, args[entry.getKey()]);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        return param;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###三、获取可执行sql过程</p>
<h4 id="1、DefaultSqlSession的selectList方法"><a href="#1、DefaultSqlSession的selectList方法" class="headerlink" title="1、DefaultSqlSession的selectList方法"></a>1、DefaultSqlSession的selectList方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //statement是命名空间+sql的id(等于mapper名+sql的id),获取sql的MappedStatement</span><br><span class="line">        MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">        List&lt;E&gt; result = executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">        return result;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error querying database.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、BaseExecutor的query方法"><a href="#2、BaseExecutor的query方法" class="headerlink" title="2、BaseExecutor的query方法"></a>2、BaseExecutor的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    //BoundSql包含可执行的sql和参数集合 </span><br><span class="line">    BoundSql boundSql = ms.getBoundSql(parameter);</span><br><span class="line">    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">    return query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、MappedStatement的getBoundSql方法"><a href="#3、MappedStatement的getBoundSql方法" class="headerlink" title="3、MappedStatement的getBoundSql方法"></a>3、MappedStatement的getBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  public BoundSql getBoundSql(Object parameterObject) &#123;</span><br><span class="line">      //通过sqlSource对象获取 </span><br><span class="line">      BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">      /parameterMap一般不会配置</span><br><span class="line">      List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">      if (parameterMappings == null || parameterMappings.size() &lt;= 0) &#123;</span><br><span class="line">          boundSql = new BoundSql(configuration, boundSql.getSql(), parameterMap.getParameterMappings(), parameterObject);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // check for nested result maps in parameter mappings (issue #30)</span><br><span class="line">      for (ParameterMapping pm : boundSql.getParameterMappings()) &#123;</span><br><span class="line">          String rmId = pm.getResultMapId();</span><br><span class="line">          if (rmId != null) &#123;</span><br><span class="line">              ResultMap rm = configuration.getResultMap(rmId);</span><br><span class="line">              if (rm != null) &#123;</span><br><span class="line">                  hasNestedResultMaps |= rm.hasNestedResultMaps();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DynamicSqlSource的getBoundSql方法"><a href="#4、DynamicSqlSource的getBoundSql方法" class="headerlink" title="4、DynamicSqlSource的getBoundSql方法"></a>4、DynamicSqlSource的getBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  public BoundSql getBoundSql(Object parameterObject) &#123;</span><br><span class="line">      DynamicContext context = new DynamicContext(configuration, parameterObject);</span><br><span class="line">      //sqlNode使用组合模式实现，他有多个SqlNode对象  </span><br><span class="line">      //每个SqlNode的apply方法调用时，都为将sql加到context中，最终通过context.getSql()得到完整的sql </span><br><span class="line">      rootSqlNode.apply(context);</span><br><span class="line">      SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration);</span><br><span class="line">      //参数类型</span><br><span class="line">      Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass();</span><br><span class="line">      //这里就是处理&quot;#&#123;&#125;&quot;占位符的地方，返回的StaticSqlSource中包含了可执行的sql </span><br><span class="line">      SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">      //这个BoundSql就是数据库可执行的Sql,同时还包含了运行时的参数  </span><br><span class="line">      BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">      for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">          boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">      return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、SqlNode的apply方法"><a href="#5、SqlNode的apply方法" class="headerlink" title="5、SqlNode的apply方法"></a>5、SqlNode的apply方法</h4><h5 id="MixedSqlNode的apply"><a href="#MixedSqlNode的apply" class="headerlink" title="MixedSqlNode的apply"></a>MixedSqlNode的apply</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    for (SqlNode sqlNode : contents) &#123;</span><br><span class="line">        sqlNode.apply(context);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="混合节点MixedSqlNode的apply"><a href="#混合节点MixedSqlNode的apply" class="headerlink" title="混合节点MixedSqlNode的apply"></a>混合节点MixedSqlNode的apply</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    for (SqlNode sqlNode : contents) &#123;</span><br><span class="line">        sqlNode.apply(context);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="文本节点TextSqlNode的apply"><a href="#文本节点TextSqlNode的apply" class="headerlink" title="文本节点TextSqlNode的apply"></a>文本节点TextSqlNode的apply</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    //解析$&#123;tab_name&#125;这种占位符</span><br><span class="line">    GenericTokenParser parser = new GenericTokenParser(&quot;$&#123;&quot;, &quot;&#125;&quot;, new BindingTokenParser(context));</span><br><span class="line">    //BindingTokenParser的handleToken方法将$&#123;tab_name&#125;替换为传入参数，并将sql加入context中</span><br><span class="line">    context.appendSql(parser.parse(text));</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="if节点IfSqlNode的apply"><a href="#if节点IfSqlNode的apply" class="headerlink" title="if节点IfSqlNode的apply"></a>if节点IfSqlNode的apply</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean apply(DynamicContext context) &#123;</span><br><span class="line">    //test表达式成立</span><br><span class="line">    if (evaluator.evaluateBoolean(test, context.getBindings())) &#123;</span><br><span class="line">        //继续执行子sql节点的apply</span><br><span class="line">        contents.apply(context);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（三、4）SqlSourceBuilder的parse方法"><a href="#6、接（三、4）SqlSourceBuilder的parse方法" class="headerlink" title="6、接（三、4）SqlSourceBuilder的parse方法"></a>6、接（三、4）SqlSourceBuilder的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public SqlSource parse(String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters) &#123;</span><br><span class="line">    //处理占位符的handler </span><br><span class="line">    ParameterMappingTokenHandler handler = new ParameterMappingTokenHandler(configuration, parameterType, additionalParameters);</span><br><span class="line">    //要处理什么样的占位符</span><br><span class="line">    GenericTokenParser parser = new GenericTokenParser(&quot;#&#123;&quot;, &quot;&#125;&quot;, handler);</span><br><span class="line">    //开始处理</span><br><span class="line">    String sql = parser.parse(originalSql);</span><br><span class="line">    //这个SqlSource就是一个简单的java对象</span><br><span class="line">    return new StaticSqlSource(configuration, sql, handler.getParameterMappings());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、ParameterMappingTokenHandler的handleToken方法"><a href="#7、ParameterMappingTokenHandler的handleToken方法" class="headerlink" title="7、ParameterMappingTokenHandler的handleToken方法"></a>7、ParameterMappingTokenHandler的handleToken方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public String handleToken(String content) &#123;</span><br><span class="line">    parameterMappings.add(buildParameterMapping(content));</span><br><span class="line">    return &quot;?&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ParameterMappingTokenHandler的buildParameterMapping方法"><a href="#ParameterMappingTokenHandler的buildParameterMapping方法" class="headerlink" title="ParameterMappingTokenHandler的buildParameterMapping方法"></a>ParameterMappingTokenHandler的buildParameterMapping方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">private ParameterMapping buildParameterMapping(String content) &#123;</span><br><span class="line">    //这里content可以是这样子的:#&#123;height,javaType=double,jdbcType=NUMERIC,numericScale=2&#125;  </span><br><span class="line">    //parseParameterMapping()就是把这种复杂的复杂解析成Map方式</span><br><span class="line">    Map&lt;String, String&gt; propertiesMap = parseParameterMapping(content);</span><br><span class="line">    String property = propertiesMap.get(&quot;property&quot;);</span><br><span class="line">    //解析参数的类型,String,int or boolean ...</span><br><span class="line">    Class&lt;?&gt; propertyType;</span><br><span class="line">    if (metaParameters.hasGetter(property)) &#123; // issue #448 get type from additional params</span><br><span class="line">        propertyType = metaParameters.getGetterType(property);</span><br><span class="line">    &#125; else if (typeHandlerRegistry.hasTypeHandler(parameterType)) &#123;</span><br><span class="line">        propertyType = parameterType;</span><br><span class="line">    &#125; else if (JdbcType.CURSOR.name().equals(propertiesMap.get(&quot;jdbcType&quot;))) &#123;</span><br><span class="line">        propertyType = java.sql.ResultSet.class;</span><br><span class="line">    &#125; else if (property != null) &#123;</span><br><span class="line">        MetaClass metaClass = MetaClass.forClass(parameterType);</span><br><span class="line">        if (metaClass.hasGetter(property)) &#123;</span><br><span class="line">            propertyType = metaClass.getGetterType(property);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            propertyType = Object.class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        propertyType = Object.class;</span><br><span class="line">    &#125;</span><br><span class="line">    //构建一个ParameterMapping对象，ParameterMapping描述的是java对象的属性与sql执行参数的对应关系。跟ResultMapping对象差不多</span><br><span class="line">    ParameterMapping.Builder builder = new ParameterMapping.Builder(configuration, property, propertyType);</span><br><span class="line">    Class&lt;?&gt; javaType = propertyType;</span><br><span class="line">    String typeHandlerAlias = null;</span><br><span class="line">    for (Map.Entry&lt;String, String&gt; entry : propertiesMap.entrySet()) &#123;</span><br><span class="line">        String name = entry.getKey();</span><br><span class="line">        String value = entry.getValue();</span><br><span class="line">        //示例:#&#123;height,javaType=double,jdbcType=NUMERIC,numericScale=2&#125;</span><br><span class="line">        if (&quot;javaType&quot;.equals(name)) &#123;</span><br><span class="line">            javaType = resolveClass(value);</span><br><span class="line">            builder.javaType(javaType);</span><br><span class="line">        &#125; else if (&quot;jdbcType&quot;.equals(name)) &#123;</span><br><span class="line">            builder.jdbcType(resolveJdbcType(value));</span><br><span class="line">        &#125; else if (&quot;mode&quot;.equals(name)) &#123;</span><br><span class="line">            builder.mode(resolveParameterMode(value));</span><br><span class="line">        &#125; else if (&quot;numericScale&quot;.equals(name)) &#123;</span><br><span class="line">            builder.numericScale(Integer.valueOf(value));</span><br><span class="line">        &#125; else if (&quot;resultMap&quot;.equals(name)) &#123;</span><br><span class="line">            builder.resultMapId(value);</span><br><span class="line">        &#125; else if (&quot;typeHandler&quot;.equals(name)) &#123;</span><br><span class="line">            typeHandlerAlias = value;</span><br><span class="line">        &#125; else if (&quot;jdbcTypeName&quot;.equals(name)) &#123;</span><br><span class="line">            builder.jdbcTypeName(value);</span><br><span class="line">        &#125; else if (&quot;property&quot;.equals(name)) &#123;</span><br><span class="line">            // Do Nothing</span><br><span class="line">        &#125; else if (&quot;expression&quot;.equals(name)) &#123;</span><br><span class="line">            throw new BuilderException(&quot;Expression based parameters are not supported yet&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new BuilderException(&quot;An invalid property &apos;&quot; + name + &quot;&apos; was found in mapping #&#123;&quot; + content + &quot;&#125;.  Valid properties are &quot; + parameterProperties);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (typeHandlerAlias != null) &#123;</span><br><span class="line">        builder.typeHandler(resolveTypeHandler(javaType, typeHandlerAlias));</span><br><span class="line">    &#125;</span><br><span class="line">    return builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、一级缓存处理过程"><a href="#四、一级缓存处理过程" class="headerlink" title="四、一级缓存处理过程"></a>四、一级缓存处理过程</h3><h4 id="1、接（三、2）BaseExecutor的createCacheKey方法"><a href="#1、接（三、2）BaseExecutor的createCacheKey方法" class="headerlink" title="1、接（三、2）BaseExecutor的createCacheKey方法"></a>1、接（三、2）BaseExecutor的createCacheKey方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public CacheKey createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) &#123;</span><br><span class="line">    if (closed) throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    //创建缓存key</span><br><span class="line">    CacheKey cacheKey = new CacheKey();</span><br><span class="line">    //sql的id</span><br><span class="line">    cacheKey.update(ms.getId());</span><br><span class="line">    //查询的开始条数</span><br><span class="line">    cacheKey.update(rowBounds.getOffset());</span><br><span class="line">    //查询的结束条数</span><br><span class="line">    cacheKey.update(rowBounds.getLimit());</span><br><span class="line">    //可执行的sql，不包含参数</span><br><span class="line">    cacheKey.update(boundSql.getSql());</span><br><span class="line">    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">    if (parameterMappings.size() &gt; 0 &amp;&amp; parameterObject != null) &#123;</span><br><span class="line">        TypeHandlerRegistry typeHandlerRegistry = ms.getConfiguration().getTypeHandlerRegistry();</span><br><span class="line">        if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">            //查询参数</span><br><span class="line">            cacheKey.update(parameterObject);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            MetaObject metaObject = configuration.newMetaObject(parameterObject);</span><br><span class="line">            for (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line">                String propertyName = parameterMapping.getProperty();</span><br><span class="line">                if (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">                    cacheKey.update(metaObject.getValue(propertyName));</span><br><span class="line">                &#125; else if (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                    cacheKey.update(boundSql.getAdditionalParameter(propertyName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return cacheKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、接（三、2）BaseExecutor的query方法"><a href="#2、接（三、2）BaseExecutor的query方法" class="headerlink" title="2、接（三、2）BaseExecutor的query方法"></a>2、接（三、2）BaseExecutor的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, </span><br><span class="line">      BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing a query&quot;).object(ms.getId());</span><br><span class="line">    if (closed) throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    if (queryStack == 0 &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">        clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    try &#123;</span><br><span class="line">        queryStack++;</span><br><span class="line">        //从缓存中取出数据</span><br><span class="line">        list = resultHandler == null ? (List&lt;E&gt;) localCache.getObject(key) : null;</span><br><span class="line">        if (list != null) &#123;</span><br><span class="line">            //如果缓存中有数据，处理过程的缓存</span><br><span class="line">            handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //如果缓存中没有数据，将sql执行生成结果，并加入localCache中</span><br><span class="line">            list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    if (queryStack == 0) &#123;</span><br><span class="line">        for (DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">            deferredLoad.load();</span><br><span class="line">        &#125;</span><br><span class="line">        deferredLoads.clear(); // issue #601</span><br><span class="line">        if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">            //如果配置为STATEMENT时，将清除所有缓存。说明STATEMENT类型的查询只有queryFromDatabase方法中有效。</span><br><span class="line">            clearLocalCache(); // issue #482</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="一级缓存的生命周期与SqlSession的生命周期一样。一级缓存是BaseExecutor中管理的，为PerpetualCache对象，对象有一个Map对象管理缓存数据。"><a href="#一级缓存的生命周期与SqlSession的生命周期一样。一级缓存是BaseExecutor中管理的，为PerpetualCache对象，对象有一个Map对象管理缓存数据。" class="headerlink" title="一级缓存的生命周期与SqlSession的生命周期一样。一级缓存是BaseExecutor中管理的，为PerpetualCache对象，对象有一个Map对象管理缓存数据。"></a>一级缓存的生命周期与SqlSession的生命周期一样。一级缓存是BaseExecutor中管理的，为PerpetualCache对象，对象有一个Map对象管理缓存数据。</h5><h5 id="一级缓存配置示例如下"><a href="#一级缓存配置示例如下" class="headerlink" title="一级缓存配置示例如下"></a>一级缓存配置示例如下</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;setting name=&quot;localCacheScope&quot; value=&quot;SESSION|STATEMENT&quot;/&gt;</span><br></pre></td></tr></table></figure>
<h4 id="3、BaseExecutor的queryFromDatabase方法"><a href="#3、BaseExecutor的queryFromDatabase方法" class="headerlink" title="3、BaseExecutor的queryFromDatabase方法"></a>3、BaseExecutor的queryFromDatabase方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private &lt;E&gt; List&lt;E&gt; queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, </span><br><span class="line">      CacheKey key, BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">    try &#123;</span><br><span class="line">        //执行sql返回数据</span><br><span class="line">        list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        localCache.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">    //将缓存加入到localCache中 </span><br><span class="line">    localCache.putObject(key, list);</span><br><span class="line">    if (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">        localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="五、获取数据库连接过程"><a href="#五、获取数据库连接过程" class="headerlink" title="五、获取数据库连接过程"></a>五、获取数据库连接过程</h3><h4 id="1、SimpleExecutor的doQuery方法"><a href="#1、SimpleExecutor的doQuery方法" class="headerlink" title="1、SimpleExecutor的doQuery方法"></a>1、SimpleExecutor的doQuery方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql </span><br><span class="line">      boundSql) throws SQLException &#123;</span><br><span class="line">    Statement stmt = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        //生成一个StatementHandler</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">        //执行之前的准备</span><br><span class="line">        stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        //执行sql </span><br><span class="line">        return handler.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、SimpleExecutor的prepareStatement方法"><a href="#2、SimpleExecutor的prepareStatement方法" class="headerlink" title="2、SimpleExecutor的prepareStatement方法"></a>2、SimpleExecutor的prepareStatement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException &#123;</span><br><span class="line">    Statement stmt;</span><br><span class="line">    //获取一个连接</span><br><span class="line">    Connection connection = getConnection(statementLog);</span><br><span class="line">    //获取一个statement</span><br><span class="line">    stmt = handler.prepare(connection);</span><br><span class="line">    //设置执行参数</span><br><span class="line">    handler.parameterize(stmt);</span><br><span class="line">    return stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、SimpleExecutor的getConnection方法"><a href="#3、SimpleExecutor的getConnection方法" class="headerlink" title="3、SimpleExecutor的getConnection方法"></a>3、SimpleExecutor的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected Connection getConnection(Log statementLog) throws SQLException &#123;</span><br><span class="line">    //获取连接</span><br><span class="line">    Connection connection = transaction.getConnection();</span><br><span class="line">    if (statementLog.isDebugEnabled()) &#123;</span><br><span class="line">        return ConnectionLogger.newInstance(connection, statementLog);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、JdbcTransaction的getConnection方法"><a href="#4、JdbcTransaction的getConnection方法" class="headerlink" title="4、JdbcTransaction的getConnection方法"></a>4、JdbcTransaction的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection() throws SQLException &#123;</span><br><span class="line">    if (connection == null) &#123;</span><br><span class="line">        //获取连接</span><br><span class="line">        openConnection();</span><br><span class="line">    &#125;</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected void openConnection() throws SQLException &#123;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Opening JDBC Connection&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //从数据源中获取连接</span><br><span class="line">    connection = dataSource.getConnection();</span><br><span class="line">    if (level != null) &#123;</span><br><span class="line">        //设置事务级别</span><br><span class="line">        connection.setTransactionIsolation(level.getLevel());</span><br><span class="line">    &#125;</span><br><span class="line">    setDesiredAutoCommit(autoCommmit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、PooledDataSource的getConnection方法"><a href="#5、PooledDataSource的getConnection方法" class="headerlink" title="5、PooledDataSource的getConnection方法"></a>5、PooledDataSource的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection() throws SQLException &#123;</span><br><span class="line">    return popConnection(dataSource.getUsername(), dataSource.getPassword()).getProxyConnection();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">private PooledConnection popConnection(String username, String password) throws SQLException &#123;</span><br><span class="line">    boolean countedWait = false;</span><br><span class="line">    //封装后的连接</span><br><span class="line">    PooledConnection conn = null;</span><br><span class="line">    long t = System.currentTimeMillis();</span><br><span class="line">    //无效连接个数</span><br><span class="line">    int localBadConnectionCount = 0;</span><br><span class="line">    while (conn == null) &#123;</span><br><span class="line">        synchronized (state) &#123;</span><br><span class="line">            if (state.idleConnections.size() &gt; 0) &#123;</span><br><span class="line">                //连接池有空闲的连接</span><br><span class="line">                //获取该连接</span><br><span class="line">                conn = state.idleConnections.remove(0);</span><br><span class="line">                if (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(&quot;Checked out connection &quot; + conn.getRealHashCode() + &quot; from pool.&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //连接池没有空闲连接，</span><br><span class="line">                if (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;</span><br><span class="line">                    //正在使用的连接数量小于最大数量</span><br><span class="line">                    //创建一个连接，实际连接是UnpooledDataSource的getConnection方法获取的</span><br><span class="line">                    conn = new PooledConnection(dataSource.getConnection(), this);</span><br><span class="line">                    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">                    //used in logging, if enabled</span><br><span class="line">                    Connection realConn = conn.getRealConnection();</span><br><span class="line">                    if (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(&quot;Created connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //正在使用的连接数量大于等于最大数量</span><br><span class="line">                    // Cannot create new connection</span><br><span class="line">                    PooledConnection oldestActiveConnection = state.activeConnections.get(0);</span><br><span class="line">                    //获取连接闲置时间</span><br><span class="line">                    long longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</span><br><span class="line">                    if (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;</span><br><span class="line">                        //连接闲置时间大于最大时间20秒</span><br><span class="line">                        //收回过期连接数加一</span><br><span class="line">                        state.claimedOverdueConnectionCount++;</span><br><span class="line">                        //连接闲置总时间</span><br><span class="line">                        state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</span><br><span class="line">                        state.accumulatedCheckoutTime += longestCheckoutTime;</span><br><span class="line">                        //回收该连接</span><br><span class="line">                        state.activeConnections.remove(oldestActiveConnection);</span><br><span class="line">                        //回滚该链接未提交事务</span><br><span class="line">                        if (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">                            oldestActiveConnection.getRealConnection().rollback();</span><br><span class="line">                        &#125;</span><br><span class="line">                        //重新封装一个连接</span><br><span class="line">                        conn = new PooledConnection(oldestActiveConnection.getRealConnection(), this);</span><br><span class="line">                        //旧连接失效</span><br><span class="line">                        oldestActiveConnection.invalidate();</span><br><span class="line">                        if (log.isDebugEnabled()) &#123;</span><br><span class="line">                            log.debug(&quot;Claimed overdue connection &quot; + conn.getRealHashCode() + &quot;.&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // 连接闲置时间小于最大时间20秒</span><br><span class="line">                        // 无连接可用，必须等待</span><br><span class="line">                        try &#123;</span><br><span class="line">                            //等待次数加一</span><br><span class="line">                            if (!countedWait) &#123;</span><br><span class="line">                                state.hadToWaitCount++;</span><br><span class="line">                                countedWait = true;</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (log.isDebugEnabled()) &#123;</span><br><span class="line">                                log.debug(&quot;Waiting as long as &quot; + poolTimeToWait + &quot; milliseconds for connection.&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            long wt = System.currentTimeMillis();</span><br><span class="line">                            //等待最多20秒</span><br><span class="line">                            state.wait(poolTimeToWait);</span><br><span class="line">                            //等待总时间</span><br><span class="line">                            state.accumulatedWaitTime += System.currentTimeMillis() - wt;</span><br><span class="line">                        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (conn != null) &#123;</span><br><span class="line">                if (conn.isValid()) &#123;</span><br><span class="line">                    //连接有效</span><br><span class="line">                    //回滚未提交事务</span><br><span class="line">                    if (!conn.getRealConnection().getAutoCommit()) &#123;</span><br><span class="line">                        conn.getRealConnection().rollback();</span><br><span class="line">                    &#125;</span><br><span class="line">                    conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));</span><br><span class="line">                    //跟新连接的最后使用时间</span><br><span class="line">                    conn.setCheckoutTimestamp(System.currentTimeMillis());</span><br><span class="line">                    conn.setLastUsedTimestamp(System.currentTimeMillis());</span><br><span class="line">                    //连接加入正在使用集合</span><br><span class="line">                    state.activeConnections.add(conn);</span><br><span class="line">                    //请求次数加一</span><br><span class="line">                    state.requestCount++;</span><br><span class="line">                    //累计请求时间</span><br><span class="line">                    state.accumulatedRequestTime += System.currentTimeMillis() - t;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //连接无效</span><br><span class="line">                    if (log.isDebugEnabled()) &#123;</span><br><span class="line">                        log.debug(&quot;A bad connection (&quot; + conn.getRealHashCode() + &quot;) was returned from the pool, getting another </span><br><span class="line">                              connection.&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //无效链接个数</span><br><span class="line">                    state.badConnectionCount++;</span><br><span class="line">                    localBadConnectionCount++;</span><br><span class="line">                    conn = null;</span><br><span class="line">                    //无效连接超过一定数量，抛出异常</span><br><span class="line">                    if (localBadConnectionCount &gt; (poolMaximumIdleConnections + 3)) &#123;</span><br><span class="line">                        if (log.isDebugEnabled()) &#123;</span><br><span class="line">                            log.debug(&quot;PooledDataSource: Could not get a good connection to the database.&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        throw new SQLException(&quot;PooledDataSource: Could not get a good connection to the database.&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (conn == null) &#123;</span><br><span class="line">        if (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        throw new SQLException(&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、UnpooledDataSource的getConnection方法"><a href="#6、UnpooledDataSource的getConnection方法" class="headerlink" title="6、UnpooledDataSource的getConnection方法"></a>6、UnpooledDataSource的getConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Connection getConnection() throws SQLException &#123;</span><br><span class="line">    return doGetConnection(username, password);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private Connection doGetConnection(String username, String password) throws SQLException &#123;</span><br><span class="line">    Properties props = new Properties();</span><br><span class="line">    if (driverProperties != null) &#123;</span><br><span class="line">        props.putAll(driverProperties);</span><br><span class="line">    &#125;</span><br><span class="line">    if (username != null) &#123;</span><br><span class="line">        props.setProperty(&quot;user&quot;, username);</span><br><span class="line">    &#125;</span><br><span class="line">    if (password != null) &#123;</span><br><span class="line">        props.setProperty(&quot;password&quot;, password);</span><br><span class="line">    &#125;</span><br><span class="line">    return doGetConnection(props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private Connection doGetConnection(Properties properties) throws SQLException &#123;</span><br><span class="line">    //初始化数据库驱动</span><br><span class="line">    initializeDriver();</span><br><span class="line">    //获取实际的数据库连接</span><br><span class="line">    Connection connection = DriverManager.getConnection(url, properties);</span><br><span class="line">    //配置是否自动提交，以及隔离级别</span><br><span class="line">    configureConnection(connection);</span><br><span class="line">    return connection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="六、sql执行预处理过程"><a href="#六、sql执行预处理过程" class="headerlink" title="六、sql执行预处理过程"></a>六、sql执行预处理过程</h3><h4 id="1、接（五、2）RoutingStatementHandler的prepare方法"><a href="#1、接（五、2）RoutingStatementHandler的prepare方法" class="headerlink" title="1、接（五、2）RoutingStatementHandler的prepare方法"></a>1、接（五、2）RoutingStatementHandler的prepare方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Statement prepare(Connection connection) throws SQLException &#123;</span><br><span class="line">    //调的是PreparedStatementHandler的prepare方法</span><br><span class="line">    return delegate.prepare(connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、实例化的PreparedStatementHandler"><a href="#2、实例化的PreparedStatementHandler" class="headerlink" title="2、实例化的PreparedStatementHandler"></a>2、实例化的PreparedStatementHandler</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public PreparedStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler </span><br><span class="line">      resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    super(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  protected BaseStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler </span><br><span class="line">        resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">      this.configuration = mappedStatement.getConfiguration();</span><br><span class="line">      this.executor = executor;</span><br><span class="line">      this.mappedStatement = mappedStatement;</span><br><span class="line">      this.rowBounds = rowBounds;</span><br><span class="line"></span><br><span class="line">      this.typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">      this.objectFactory = configuration.getObjectFactory();</span><br><span class="line"></span><br><span class="line">      if (boundSql == null) &#123; // issue #435, get the key before calculating the statement</span><br><span class="line">          //生成主键，没有则是NoKeyGenerator</span><br><span class="line">          generateKeys(parameterObject);</span><br><span class="line">          boundSql = mappedStatement.getBoundSql(parameterObject);</span><br><span class="line">      &#125;</span><br><span class="line">      this.boundSql = boundSql;</span><br><span class="line"></span><br><span class="line">      //创建参数处理器DefaultParameterHandler</span><br><span class="line">      this.parameterHandler = configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class="line">      //创建查询结果处理器DefaultResultSetHandler</span><br><span class="line">      this.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, rowBounds, parameterHandler, resultHandler, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、接（六、1）BaseStatementHandler的prepare方法"><a href="#3、接（六、1）BaseStatementHandler的prepare方法" class="headerlink" title="3、接（六、1）BaseStatementHandler的prepare方法"></a>3、接（六、1）BaseStatementHandler的prepare方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public Statement prepare(Connection connection) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().sql(boundSql.getSql());</span><br><span class="line">    Statement statement = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        //预处理</span><br><span class="line">        statement = instantiateStatement(connection);</span><br><span class="line">        //设置超时时间</span><br><span class="line">        setStatementTimeout(statement);</span><br><span class="line">        //设置查询条数</span><br><span class="line">        setFetchSize(statement);</span><br><span class="line">        return statement;</span><br><span class="line">    &#125; catch (SQLException e) &#123;</span><br><span class="line">        closeStatement(statement);</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        closeStatement(statement);</span><br><span class="line">        throw new ExecutorException(&quot;Error preparing statement.  Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、PreparedStatementHandler的instantiateStatement方法"><a href="#4、PreparedStatementHandler的instantiateStatement方法" class="headerlink" title="4、PreparedStatementHandler的instantiateStatement方法"></a>4、PreparedStatementHandler的instantiateStatement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected Statement instantiateStatement(Connection connection) throws SQLException &#123;</span><br><span class="line">    String sql = boundSql.getSql();</span><br><span class="line">    //key生成器为Jdbc3KeyGenerator</span><br><span class="line">    if (mappedStatement.getKeyGenerator() instanceof Jdbc3KeyGenerator) &#123;</span><br><span class="line">        //生成的key对应的属性名</span><br><span class="line">        String[] keyColumnNames = mappedStatement.getKeyColumns();</span><br><span class="line">        if (keyColumnNames == null) &#123;</span><br><span class="line">            //执行预编译</span><br><span class="line">            return connection.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //执行预编译</span><br><span class="line">            return connection.prepareStatement(sql, keyColumnNames);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (mappedStatement.getResultSetType() != null) &#123;</span><br><span class="line">        return connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return connection.prepareStatement(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（五、2）RoutingStatementHandler的parameterize方法"><a href="#5、接（五、2）RoutingStatementHandler的parameterize方法" class="headerlink" title="5、接（五、2）RoutingStatementHandler的parameterize方法"></a>5、接（五、2）RoutingStatementHandler的parameterize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void parameterize(Statement statement) throws SQLException &#123;</span><br><span class="line">    delegate.parameterize(statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、PreparedStatementHandler的parameterize方法"><a href="#6、PreparedStatementHandler的parameterize方法" class="headerlink" title="6、PreparedStatementHandler的parameterize方法"></a>6、PreparedStatementHandler的parameterize方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void parameterize(Statement statement) throws SQLException &#123;</span><br><span class="line">    parameterHandler.setParameters((PreparedStatement) statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、DefaultParameterHandler的setParameters"><a href="#7、DefaultParameterHandler的setParameters" class="headerlink" title="7、DefaultParameterHandler的setParameters"></a>7、DefaultParameterHandler的setParameters</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public void setParameters(PreparedStatement ps) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;setting parameters&quot;).object(mappedStatement.getParameterMap().getId());</span><br><span class="line">    //参数集合</span><br><span class="line">    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line">    if (parameterMappings != null) &#123;</span><br><span class="line">        MetaObject metaObject = parameterObject == null ? null : configuration.newMetaObject(parameterObject);</span><br><span class="line">        for (int i = 0; i &lt; parameterMappings.size(); i++) &#123;</span><br><span class="line">            ParameterMapping parameterMapping = parameterMappings.get(i);</span><br><span class="line">            if (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">                Object value;</span><br><span class="line">                //参数属性名</span><br><span class="line">                String propertyName = parameterMapping.getProperty();</span><br><span class="line">                if (boundSql.hasAdditionalParameter(propertyName)) &#123; // issue #448 ask first for additional params</span><br><span class="line">                    value = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                &#125; else if (parameterObject == null) &#123;</span><br><span class="line">                    value = null;</span><br><span class="line">                &#125; else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">                    //参数值</span><br><span class="line">                    value = parameterObject;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    value = metaObject == null ? null : metaObject.getValue(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line">                TypeHandler typeHandler = parameterMapping.getTypeHandler();</span><br><span class="line">                JdbcType jdbcType = parameterMapping.getJdbcType();</span><br><span class="line">                if (value == null &amp;&amp; jdbcType == null) jdbcType = configuration.getJdbcTypeForNull();</span><br><span class="line">                //往ps中设置参数</span><br><span class="line">                typeHandler.setParameter(ps, i + 1, value, jdbcType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="七、查询结果集映射"><a href="#七、查询结果集映射" class="headerlink" title="七、查询结果集映射"></a>七、查询结果集映射</h3><h4 id="1、接（五、1）RoutingStatementHandler的query方法"><a href="#1、接（五、1）RoutingStatementHandler的query方法" class="headerlink" title="1、接（五、1）RoutingStatementHandler的query方法"></a>1、接（五、1）RoutingStatementHandler的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    return delegate.&lt;E&gt;query(statement, resultHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、PreparedStatementHandler的query方法"><a href="#2、PreparedStatementHandler的query方法" class="headerlink" title="2、PreparedStatementHandler的query方法"></a>2、PreparedStatementHandler的query方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    return resultSetHandler.&lt;E&gt; handleResultSets(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DefaultResultSetHandler的handleResultSets方法"><a href="#3、DefaultResultSetHandler的handleResultSets方法" class="headerlink" title="3、DefaultResultSetHandler的handleResultSets方法"></a>3、DefaultResultSetHandler的handleResultSets方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException &#123;</span><br><span class="line">    final List&lt;Object&gt; multipleResults = new ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">    int resultSetCount = 0;</span><br><span class="line">    //获取第一个ResultSet,通常只会有一个</span><br><span class="line">    ResultSetWrapper rsw = getFirstResultSet(stmt);</span><br><span class="line">    //从配置中读取对应的ResultMap，通常也只会有一个</span><br><span class="line">    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();</span><br><span class="line"></span><br><span class="line">    int resultMapCount = resultMaps.size();</span><br><span class="line">    validateResultMapsCount(rsw, resultMapCount);</span><br><span class="line">    while (rsw != null &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</span><br><span class="line">        //依次获取resultMap</span><br><span class="line">        ResultMap resultMap = resultMaps.get(resultSetCount);</span><br><span class="line">        //完成映射，将结果加到入multipleResults中</span><br><span class="line">        handleResultSet(rsw, resultMap, multipleResults, null);</span><br><span class="line">        //获取下一个ResultSet</span><br><span class="line">        rsw = getNextResultSet(stmt);</span><br><span class="line">        cleanUpAfterHandlingResultSet();</span><br><span class="line">        //下一个ResultSet</span><br><span class="line">        resultSetCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    while (rsw != null &amp;&amp; resultSetCount &lt; mappedStatement.getResulSets().length) &#123;</span><br><span class="line">            ResultMapping parentMapping = nextResultMaps.get(mappedStatement.getResulSets()[resultSetCount]);</span><br><span class="line">            if (parentMapping != null) &#123;</span><br><span class="line">                String nestedResultMapId = parentMapping.getNestedResultMapId();</span><br><span class="line">                ResultMap resultMap = configuration.getResultMap(nestedResultMapId);</span><br><span class="line">                handleResultSet(rsw, resultMap, null, parentMapping);</span><br><span class="line">            &#125;</span><br><span class="line">            rsw = getNextResultSet(stmt);</span><br><span class="line">            cleanUpAfterHandlingResultSet();</span><br><span class="line">            resultSetCount++;</span><br><span class="line">        &#125;</span><br><span class="line">    //如果只有一个映射，返回第一个</span><br><span class="line">    return collapseSingleResultList(multipleResults);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="处理某一行"><a href="#处理某一行" class="headerlink" title="处理某一行"></a>处理某一行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private void handleResultSet(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Object&gt; multipleResults, ResultMapping parentMapping) </span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (parentMapping != null) &#123;</span><br><span class="line">            //子映射</span><br><span class="line">            handleRowValues(rsw, resultMap, null, RowBounds.DEFAULT, parentMapping);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //一般情况resultHandler都为空,见ResultHandler.NO_RESULT_HANDLER</span><br><span class="line">            if (resultHandler == null) &#123;</span><br><span class="line">                DefaultResultHandler defaultResultHandler = new DefaultResultHandler(objectFactory);</span><br><span class="line">                //生成对象，并加到defaultResultHandler.resultList集合中</span><br><span class="line">                handleRowValues(rsw, resultMap, defaultResultHandler, rowBounds, null);</span><br><span class="line">                //将结果加入multipleResults中</span><br><span class="line">                multipleResults.add(defaultResultHandler.getResultList());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                handleRowValues(rsw, resultMap, resultHandler, rowBounds, null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //关闭结果集</span><br><span class="line">        closeResultSet(rsw.getResultSet()); // issue #228 (close resultsets)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DefaultResultSetHandler的handleRowValues方法"><a href="#4、DefaultResultSetHandler的handleRowValues方法" class="headerlink" title="4、DefaultResultSetHandler的handleRowValues方法"></a>4、DefaultResultSetHandler的handleRowValues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private void handleRowValues(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping </span><br><span class="line">      parentMapping) throws SQLException &#123;</span><br><span class="line">    if (resultMap.hasNestedResultMaps()) &#123;</span><br><span class="line">        //有子映射或内映射的情况</span><br><span class="line">        ensureNoRowBounds();</span><br><span class="line">        checkResultHandler();</span><br><span class="line">        handleRowValuesForNestedResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //没有子映射或内映射</span><br><span class="line">        handleRowValuesForSimpleResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法"><a href="#5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法" class="headerlink" title="5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法"></a>5、DefaultResultSetHandler的handleRowValuesForSimpleResultMap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void handleRowValuesForSimpleResultMap(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds </span><br><span class="line">      rowBounds, ResultMapping parentMapping)throws SQLException &#123;</span><br><span class="line">    DefaultResultContext resultContext = new DefaultResultContext();</span><br><span class="line">    //跳过结果集前排行，直到查询开始位置，开始处理</span><br><span class="line">    skipRows(rsw.getResultSet(), rowBounds);</span><br><span class="line">    //依次处理待处理的行</span><br><span class="line">    while (shouldProcessMoreRows(rsw.getResultSet(), resultContext, rowBounds)) &#123;</span><br><span class="line">        //默认不处理返回resultMap</span><br><span class="line">        ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, null);</span><br><span class="line">        //真正从ResultSet中映射出一个对象  </span><br><span class="line">        Object rowValue = getRowValue(rsw, discriminatedResultMap, null);</span><br><span class="line">        storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、DefaultResultSetHandler的getRowValue方法"><a href="#6、DefaultResultSetHandler的getRowValue方法" class="headerlink" title="6、DefaultResultSetHandler的getRowValue方法"></a>6、DefaultResultSetHandler的getRowValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private Object getRowValue(ResultSetWrapper rsw, ResultMap resultMap, CacheKey rowKey) throws SQLException &#123;</span><br><span class="line">    final ResultLoaderMap lazyLoader = instantiateResultLoaderMap();</span><br><span class="line">    //实例化一个对象,类型为resultMap.getType(),最终调用了ObjectFactory.create()方法</span><br><span class="line">    Object resultObject = createResultObject(rsw, resultMap, lazyLoader, null);</span><br><span class="line">    if (resultObject != null &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;</span><br><span class="line">        //设置对象属性 </span><br><span class="line">        final MetaObject metaObject = configuration.newMetaObject(resultObject);</span><br><span class="line">        boolean foundValues = resultMap.getConstructorResultMappings().size() &gt; 0;</span><br><span class="line">        if (shouldApplyAutomaticMappings(resultMap, !AutoMappingBehavior.NONE.equals(configuration.getAutoMappingBehavior()))) &#123;  </span><br><span class="line">            //自动映射,结果集中有的column，但resultMap中并没有配置      </span><br><span class="line">            foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, null) || foundValues;</span><br><span class="line">        &#125;</span><br><span class="line">        //映射result节点</span><br><span class="line">        foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, null) || foundValues;</span><br><span class="line">        foundValues = (lazyLoader != null &amp;&amp; lazyLoader.size() &gt; 0) || foundValues;</span><br><span class="line">        resultObject = foundValues ? resultObject : null;</span><br><span class="line">        return resultObject;</span><br><span class="line">    &#125;</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、DefaultResultSetHandler的createResultObject方法"><a href="#7、DefaultResultSetHandler的createResultObject方法" class="headerlink" title="7、DefaultResultSetHandler的createResultObject方法"></a>7、DefaultResultSetHandler的createResultObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private Object createResultObject(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix) throws</span><br><span class="line">       SQLException &#123;</span><br><span class="line">    //构造方法中的参数类型  </span><br><span class="line">    final List&lt;Class&lt;?&gt;&gt; constructorArgTypes = new ArrayList&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">    //构造方法中具体值 </span><br><span class="line">    final List&lt;Object&gt; constructorArgs = new ArrayList&lt;Object&gt;();</span><br><span class="line">    //根据构造方法生成对象  </span><br><span class="line">    final Object resultObject = createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">    if (resultObject != null &amp;&amp; configuration.isLazyLoadingEnabled() &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;</span><br><span class="line">        final List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">        for (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">            //如果有子查询</span><br><span class="line">            if (propertyMapping.getNestedQueryId() != null) &#123; // issue #109 (avoid creating proxies for leaf objects)</span><br><span class="line">                //CglibProxyFactory给返回对象创建代理</span><br><span class="line">                return proxyFactory.createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private Object createResultObject(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    //结果集中配置的返回类</span><br><span class="line">    final Class&lt;?&gt; resultType = resultMap.getType();</span><br><span class="line">    //resultMap配置中的construnctor节点 </span><br><span class="line">    final List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();</span><br><span class="line">    if (typeHandlerRegistry.hasTypeHandler(resultType)) &#123;</span><br><span class="line">        return createPrimitiveResultObject(rsw, resultMap, columnPrefix);</span><br><span class="line">    &#125; else if (constructorMappings.size() &gt; 0) &#123;</span><br><span class="line">        //construnctor节点有配置 </span><br><span class="line">        return createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //construnctor节点没有配置，调用无参的构造方法  </span><br><span class="line">        return objectFactory.create(resultType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、DefaultResultSetHandler的createPrimitiveResultObject方法"><a href="#8、DefaultResultSetHandler的createPrimitiveResultObject方法" class="headerlink" title="8、DefaultResultSetHandler的createPrimitiveResultObject方法"></a>8、DefaultResultSetHandler的createPrimitiveResultObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private Object createParameterizedResultObject(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; constructorMappings,</span><br><span class="line">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes,List&lt;Object&gt; constructorArgs, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    for (ResultMapping constructorMapping : constructorMappings) &#123;</span><br><span class="line">        final Class&lt;?&gt; parameterType = constructorMapping.getJavaType();</span><br><span class="line">        final String column = constructorMapping.getColumn();</span><br><span class="line">        final Object value;</span><br><span class="line">        //取出参数类型和具体的值</span><br><span class="line">        if (constructorMapping.getNestedQueryId() != null) &#123;</span><br><span class="line">            value = getNestedQueryConstructorValue(rsw.getResultSet(), constructorMapping, columnPrefix);</span><br><span class="line">        &#125; else if (constructorMapping.getNestedResultMapId() != null) &#123;</span><br><span class="line">            final ResultMap resultMap = configuration.getResultMap(constructorMapping.getNestedResultMapId());</span><br><span class="line">            final ResultLoaderMap lazyLoader = instantiateResultLoaderMap();</span><br><span class="line">            value = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            final TypeHandler&lt;?&gt; typeHandler = constructorMapping.getTypeHandler();</span><br><span class="line">            //从结果集中获取该属性对应的查询结果</span><br><span class="line">            value = typeHandler.getResult(rsw.getResultSet(), prependPrefix(column, columnPrefix));</span><br><span class="line">        &#125;</span><br><span class="line">        //构造器参数类型</span><br><span class="line">        constructorArgTypes.add(parameterType);</span><br><span class="line">        //构造器参数值</span><br><span class="line">        constructorArgs.add(value);</span><br><span class="line">        foundValues = value != null || foundValues;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建对象 </span><br><span class="line">    return foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（七、7）CglibProxyFactory的createProxy方法"><a href="#9、接（七、7）CglibProxyFactory的createProxy方法" class="headerlink" title="9、接（七、7）CglibProxyFactory的createProxy方法"></a>9、接（七、7）CglibProxyFactory的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object createProxy(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory,</span><br><span class="line">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123;</span><br><span class="line">    return EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、EnhancedResultObjectProxyImpl的createProxy方法"><a href="#10、EnhancedResultObjectProxyImpl的createProxy方法" class="headerlink" title="10、EnhancedResultObjectProxyImpl的createProxy方法"></a>10、EnhancedResultObjectProxyImpl的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static Object createProxy(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, </span><br><span class="line">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123;</span><br><span class="line">    //被代理对象的类</span><br><span class="line">    final Class&lt;?&gt; type = target.getClass();</span><br><span class="line">    //创建回调</span><br><span class="line">    EnhancedResultObjectProxyImpl callback = new EnhancedResultObjectProxyImpl(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">    //创建代理对象</span><br><span class="line">    Object enhanced = crateProxy(type, callback, constructorArgTypes, constructorArgs);</span><br><span class="line">    //target是type的初始化对象  </span><br><span class="line">    //enhanced可能是type的代理对象  </span><br><span class="line">    //将target对象的值赋值到enhanced，包括父类的字段赋值</span><br><span class="line">    PropertyCopier.copyBeanProperties(type, target, enhanced);</span><br><span class="line">    //返回代理enhanced </span><br><span class="line">    return enhanced;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、CglibProxyFactory的createProxy方法"><a href="#11、CglibProxyFactory的createProxy方法" class="headerlink" title="11、CglibProxyFactory的createProxy方法"></a>11、CglibProxyFactory的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private static Object crateProxy(Class&lt;?&gt; type, Callback callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs) &#123;</span><br><span class="line">    Enhancer enhancer = new Enhancer();</span><br><span class="line">    //设置回调</span><br><span class="line">    enhancer.setCallback(callback);</span><br><span class="line">    //继承被代理的类</span><br><span class="line">    enhancer.setSuperclass(type);</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取目标类型的 writeReplace 方法，如果没有，异常中代理类设置enhancer.setInterfaces(new Class[]&#123;WriteReplaceInterface.class&#125;)</span><br><span class="line">        type.getDeclaredMethod(WRITE_REPLACE_METHOD);</span><br><span class="line">        // ObjectOutputStream will call writeReplace of objects returned by writeReplace</span><br><span class="line">        log.debug(WRITE_REPLACE_METHOD + &quot; method was found on bean &quot; + type + &quot;, make sure it returns this&quot;);</span><br><span class="line">    &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">        enhancer.setInterfaces(new Class[]&#123;WriteReplaceInterface.class&#125;);</span><br><span class="line">    &#125; catch (SecurityException e) &#123;</span><br><span class="line">        // nothing to do here</span><br><span class="line">    &#125;</span><br><span class="line">    Object enhanced = null;</span><br><span class="line">    if (constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">        //如果构造函数没有参数，创建代理对象</span><br><span class="line">        enhanced = enhancer.create();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //否则，初始化带有参数的构造函数</span><br><span class="line">        Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(new Class[constructorArgTypes.size()]);</span><br><span class="line">        Object[] valuesArray = constructorArgs.toArray(new Object[constructorArgs.size()]);</span><br><span class="line">        //创建带有参数的代理对象</span><br><span class="line">        enhanced = enhancer.create(typesArray, valuesArray);</span><br><span class="line">    &#125;</span><br><span class="line">    return enhanced;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、BaseTypeHandler的getResult方法"><a href="#12、BaseTypeHandler的getResult方法" class="headerlink" title="12、BaseTypeHandler的getResult方法"></a>12、BaseTypeHandler的getResult方法</h4><h5 id="typeHandler以StringTypeHandler为例"><a href="#typeHandler以StringTypeHandler为例" class="headerlink" title="typeHandler以StringTypeHandler为例"></a>typeHandler以StringTypeHandler为例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public T getResult(ResultSet rs, String columnName) throws SQLException &#123;</span><br><span class="line">    T result = getNullableResult(rs, columnName);</span><br><span class="line">    if (rs.wasNull()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、StringTypeHandler的getNullableResult方法"><a href="#13、StringTypeHandler的getNullableResult方法" class="headerlink" title="13、StringTypeHandler的getNullableResult方法"></a>13、StringTypeHandler的getNullableResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public String getNullableResult(ResultSet rs, String columnName) throws SQLException &#123;</span><br><span class="line">    //获取该字段对应的值</span><br><span class="line">    return rs.getString(columnName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法"><a href="#14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法" class="headerlink" title="14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法"></a>14、接（七、6）DefaultResultSetHandler的applyAutomaticMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private boolean applyAutomaticMappings(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String columnPrefix) </span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    //获取结果集中在resultMap中没有配置的列名  </span><br><span class="line">    //如果resultMap中只设置了resultType=&quot;java.util.HashMap&quot;的话，全都会在这里完成映射 </span><br><span class="line">    final List&lt;String&gt; unmappedColumnNames = rsw.getUnmappedColumnNames(resultMap, columnPrefix);</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    for (String columnName : unmappedColumnNames) &#123;</span><br><span class="line">        //属性名就是列名</span><br><span class="line">        String propertyName = columnName;</span><br><span class="line">        if (columnPrefix != null &amp;&amp; columnPrefix.length() &gt; 0) &#123;</span><br><span class="line">            // When columnPrefix is specified,</span><br><span class="line">            // ignore columns without the prefix.</span><br><span class="line">            if (columnName.startsWith(columnPrefix)) &#123;</span><br><span class="line">                propertyName = columnName.substring(columnPrefix.length());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //是否有对应的属性</span><br><span class="line">        final String property = metaObject.findProperty(propertyName, configuration.isMapUnderscoreToCamelCase());</span><br><span class="line">        if (property != null &amp;&amp; metaObject.hasSetter(property)) &#123;</span><br><span class="line">            final Class&lt;?&gt; propertyType = metaObject.getSetterType(property);</span><br><span class="line">            if (typeHandlerRegistry.hasTypeHandler(propertyType)) &#123;</span><br><span class="line">                final TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(propertyType, columnName);</span><br><span class="line">                //获取该字段对应的值</span><br><span class="line">                final Object value = typeHandler.getResult(rsw.getResultSet(), columnName);</span><br><span class="line">                if (value != null || configuration.isCallSettersOnNulls()) &#123; // issue #377, call setter on nulls</span><br><span class="line">                    if (value != null || !propertyType.isPrimitive()) &#123;</span><br><span class="line">                        //直接设置</span><br><span class="line">                        metaObject.setValue(property, value);</span><br><span class="line">                    &#125;</span><br><span class="line">                    foundValues = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foundValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法"><a href="#15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法" class="headerlink" title="15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法"></a>15、接（七、6）DefaultResultSetHandler的applyPropertyMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">private boolean applyPropertyMappings(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, ResultLoaderMap lazyLoader, </span><br><span class="line">      String columnPrefix) throws SQLException &#123;</span><br><span class="line">    //有resultMap中配置过的字段名</span><br><span class="line">    final List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    //获取需要映射的ResultMapping</span><br><span class="line">    final List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();</span><br><span class="line">    for (ResultMapping propertyMapping : propertyMappings) &#123;</span><br><span class="line">        final String column = prependPrefix(propertyMapping.getColumn(), columnPrefix);</span><br><span class="line">        if (propertyMapping.isCompositeResult() </span><br><span class="line">              || (column != null &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) </span><br><span class="line">              || propertyMapping.getResultSet() != null) &#123;</span><br><span class="line">            //在结果中的获取对应的值</span><br><span class="line">            Object value = getPropertyMappingValue(rsw.getResultSet(), metaObject, propertyMapping, lazyLoader, columnPrefix);</span><br><span class="line">            //获取属性名</span><br><span class="line">            final String property = propertyMapping.getProperty(); // issue #541 make property optional</span><br><span class="line">            if (value != NO_VALUE &amp;&amp; property != null &amp;&amp; (value != null || configuration.isCallSettersOnNulls())) &#123; </span><br><span class="line">                if (value != null || !metaObject.getSetterType(property).isPrimitive()) &#123;</span><br><span class="line">                    //设置属性值</span><br><span class="line">                    metaObject.setValue(property, value);</span><br><span class="line">                &#125;</span><br><span class="line">                foundValues = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foundValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、DefaultResultSetHandler的getPropertyMappingValue方法"><a href="#16、DefaultResultSetHandler的getPropertyMappingValue方法" class="headerlink" title="16、DefaultResultSetHandler的getPropertyMappingValue方法"></a>16、DefaultResultSetHandler的getPropertyMappingValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private Object getPropertyMappingValue(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping, </span><br><span class="line">          ResultLoaderMap lazyLoader, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    if (propertyMapping.getNestedQueryId() != null) &#123;</span><br><span class="line">        //子查询</span><br><span class="line">        return getNestedQueryMappingValue(rs, metaResultObject, propertyMapping, lazyLoader, columnPrefix);</span><br><span class="line">    &#125; else if (propertyMapping.getResultSet() != null) &#123;</span><br><span class="line">        addPendingChildRelation(rs, metaResultObject, propertyMapping);</span><br><span class="line">        return NO_VALUE;</span><br><span class="line">    &#125; else if (propertyMapping.getNestedResultMapId() != null) &#123;</span><br><span class="line">        // the user added a column attribute to a nested result map, ignore it</span><br><span class="line">        return NO_VALUE;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final TypeHandler&lt;?&gt; typeHandler = propertyMapping.getTypeHandler();</span><br><span class="line">        final String column = prependPrefix(propertyMapping.getColumn(), columnPrefix);</span><br><span class="line">        //直接从结果集里获取值</span><br><span class="line">        return typeHandler.getResult(rs, column);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、DefaultResultSetHandler的getNestedQueryMappingValue方法"><a href="#17、DefaultResultSetHandler的getNestedQueryMappingValue方法" class="headerlink" title="17、DefaultResultSetHandler的getNestedQueryMappingValue方法"></a>17、DefaultResultSetHandler的getNestedQueryMappingValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private Object getNestedQueryMappingValue(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping,</span><br><span class="line">      ResultLoaderMap lazyLoader, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    //获取子查询id</span><br><span class="line">    final String nestedQueryId = propertyMapping.getNestedQueryId();</span><br><span class="line">    //获取属性名</span><br><span class="line">    final String property = propertyMapping.getProperty();</span><br><span class="line">    //子查询sql</span><br><span class="line">    final MappedStatement nestedQuery = configuration.getMappedStatement(nestedQueryId);</span><br><span class="line">    final Class&lt;?&gt; nestedQueryParameterType = nestedQuery.getParameterMap().getType();</span><br><span class="line">    //预处理子查询参数，从查询结果中取出column对应的值作为参数</span><br><span class="line">    final Object nestedQueryParameterObject = prepareParameterForNestedQuery(rs, propertyMapping, nestedQueryParameterType, columnPrefix);</span><br><span class="line">    Object value = NO_VALUE;</span><br><span class="line">    if (nestedQueryParameterObject != null) &#123;</span><br><span class="line">        //获取BoundSql</span><br><span class="line">        final BoundSql nestedBoundSql = nestedQuery.getBoundSql(nestedQueryParameterObject);</span><br><span class="line">        //缓存key</span><br><span class="line">        final CacheKey key = executor.createCacheKey(nestedQuery, nestedQueryParameterObject, RowBounds.DEFAULT, nestedBoundSql);</span><br><span class="line">        //属性类型</span><br><span class="line">        final Class&lt;?&gt; targetType = propertyMapping.getJavaType();</span><br><span class="line">        //从二级缓存中获取缓存值</span><br><span class="line">        final List&lt;Object&gt; nestedQueryCacheObject = getNestedQueryCacheObject(nestedQuery, key);</span><br><span class="line">        if (nestedQueryCacheObject != null) &#123;</span><br><span class="line">            //从缓存中获取值</span><br><span class="line">            value = resultExtractor.extractObjectFromList(nestedQueryCacheObject, targetType);</span><br><span class="line">        &#125; else if (executor.isCached(nestedQuery, key)) &#123;</span><br><span class="line">            //一级缓存存在，从一级缓存中获取值</span><br><span class="line">            executor.deferLoad(nestedQuery, metaResultObject, property, key, targetType);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            final ResultLoader resultLoader = new ResultLoader(configuration, executor, nestedQuery, nestedQueryParameterObject, targetType, key, nestedBoundSql);</span><br><span class="line">            if (configuration.isLazyLoadingEnabled()) &#123;</span><br><span class="line">                //开启懒加载，创建一个LoadPair对象加入loaderMap中，key为属性名</span><br><span class="line">                lazyLoader.addLoader(property, metaResultObject, resultLoader);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //未开启懒加载，立即执行子查询</span><br><span class="line">                value = resultLoader.loadResult();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、接（七、5）DefaultResultSetHandler的storeObject方法"><a href="#18、接（七、5）DefaultResultSetHandler的storeObject方法" class="headerlink" title="18、接（七、5）DefaultResultSetHandler的storeObject方法"></a>18、接（七、5）DefaultResultSetHandler的storeObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private void storeObject(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue, ResultMapping parentMapping, </span><br><span class="line">    ResultSet rs) throws SQLException &#123;</span><br><span class="line">    if (parentMapping != null) &#123;</span><br><span class="line">        linkToParent(rs, parentMapping, rowValue);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //将查询出的对象加入返回集合</span><br><span class="line">        callResultHandler(resultHandler, resultContext, rowValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、DefaultResultHandler的callResultHandler方法"><a href="#19、DefaultResultHandler的callResultHandler方法" class="headerlink" title="19、DefaultResultHandler的callResultHandler方法"></a>19、DefaultResultHandler的callResultHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void callResultHandler(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue) &#123;</span><br><span class="line">    //rowValue加入DefaultResultContext中</span><br><span class="line">    resultContext.nextResultObject(rowValue);</span><br><span class="line">    //DefaultResultHandler把rowValue加入DefaultResultHandler的List集合</span><br><span class="line">    resultHandler.handleResult(resultContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法"><a href="#20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法" class="headerlink" title="20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法"></a>20、接（七、4）DefaultResultSetHandler的handleRowValuesForNestedResultMap方法</h4><h5 id="处理有内部映射的复杂映射"><a href="#处理有内部映射的复杂映射" class="headerlink" title="处理有内部映射的复杂映射"></a>处理有内部映射的复杂映射</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">private void handleRowValuesForNestedResultMap(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler,</span><br><span class="line">      RowBounds rowBounds, ResultMapping parentMapping) throws SQLException &#123;</span><br><span class="line">    final DefaultResultContext resultContext = new DefaultResultContext();</span><br><span class="line">    skipRows(rsw.getResultSet(), rowBounds);</span><br><span class="line">    Object rowValue = null;</span><br><span class="line">    while (shouldProcessMoreRows(rsw.getResultSet(), resultContext, rowBounds)) &#123;</span><br><span class="line">        final ResultMap discriminatedResultMap = resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, null);</span><br><span class="line">        //为这行记录生成一个key,createRowKey方法会利用idResultMapping(即idArg,和id节点)和resultMap的id来生成key</span><br><span class="line">        final CacheKey rowKey = createRowKey(discriminatedResultMap, rsw, null);</span><br><span class="line">        //nestedResultObjects是一个HashMap对象，在映射过程中所有生成的映射对象(包括内映射对象)，都会生成一个key并保存在这里</span><br><span class="line">        Object partialObject = nestedResultObjects.get(rowKey);</span><br><span class="line">        if (mappedStatement.isResultOrdered()) &#123; // issue #577 &amp;&amp; #542</span><br><span class="line">            if (partialObject == null &amp;&amp; rowValue != null) &#123;</span><br><span class="line">                nestedResultObjects.clear();</span><br><span class="line">                storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">            &#125;</span><br><span class="line">            rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, null, partialObject);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //这个方法把结果集的记录映射成java对象</span><br><span class="line">            rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, null, partialObject);</span><br><span class="line">            if (partialObject == null) &#123;</span><br><span class="line">                storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (rowValue != null &amp;&amp; mappedStatement.isResultOrdered()) &#123;</span><br><span class="line">      storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、DefaultResultSetHandler的createRowKey方法"><a href="#21、DefaultResultSetHandler的createRowKey方法" class="headerlink" title="21、DefaultResultSetHandler的createRowKey方法"></a>21、DefaultResultSetHandler的createRowKey方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private CacheKey createRowKey(ResultMap resultMap, ResultSetWrapper rsw, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    final CacheKey cacheKey = new CacheKey();</span><br><span class="line">    //加入resultmap的id</span><br><span class="line">    cacheKey.update(resultMap.getId());</span><br><span class="line">    //有id则获取id映射，没有则获取所有映射</span><br><span class="line">    List&lt;ResultMapping&gt; resultMappings = getResultMappingsForRowKey(resultMap);</span><br><span class="line">    if (resultMappings.size() == 0) &#123;</span><br><span class="line">        if (Map.class.isAssignableFrom(resultMap.getType())) &#123;</span><br><span class="line">            createRowKeyForMap(rsw, cacheKey);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            createRowKeyForUnmappedProperties(resultMap, rsw, cacheKey, columnPrefix);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //将resultMappings的字段名和值，依次放入cacheKey</span><br><span class="line">        createRowKeyForMappedProperties(resultMap, rsw, cacheKey, resultMappings, columnPrefix);</span><br><span class="line">    &#125;</span><br><span class="line">    return cacheKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="22、DefaultResultSetHandler的createRowKeyForMappedProperties方法"><a href="#22、DefaultResultSetHandler的createRowKeyForMappedProperties方法" class="headerlink" title="22、DefaultResultSetHandler的createRowKeyForMappedProperties方法"></a>22、DefaultResultSetHandler的createRowKeyForMappedProperties方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void createRowKeyForMappedProperties(ResultMap resultMap, ResultSetWrapper rsw, CacheKey cacheKey, </span><br><span class="line">      List&lt;ResultMapping&gt; resultMappings, String columnPrefix) throws SQLException &#123;</span><br><span class="line">    for (ResultMapping resultMapping : resultMappings) &#123;</span><br><span class="line">        if (resultMapping.getNestedResultMapId() != null &amp;&amp; resultMapping.getResultSet() == null) &#123; // Issue #392</span><br><span class="line">            //该映射是一个内映射</span><br><span class="line">            final ResultMap nestedResultMap = configuration.getResultMap(resultMapping.getNestedResultMapId());</span><br><span class="line">            //递归调用本方法处理内映射</span><br><span class="line">            createRowKeyForMappedProperties(nestedResultMap, rsw, cacheKey, nestedResultMap.getConstructorResultMappings(),</span><br><span class="line">            prependPrefix(resultMapping.getColumnPrefix(), columnPrefix));</span><br><span class="line">        &#125; else if (resultMapping.getNestedQueryId() == null) &#123;</span><br><span class="line">            //该映射为属性映射</span><br><span class="line">            final String column = prependPrefix(resultMapping.getColumn(), columnPrefix);</span><br><span class="line">            final TypeHandler&lt;?&gt; th = resultMapping.getTypeHandler();</span><br><span class="line">            List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);</span><br><span class="line">            if (column != null &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) &#123; // Issue #114</span><br><span class="line">                //获取该字段对应的值</span><br><span class="line">                final Object value = th.getResult(rsw.getResultSet(), column);</span><br><span class="line">                if (value != null) &#123;</span><br><span class="line">                    //将字段名和值，加载进cacheKey</span><br><span class="line">                    cacheKey.update(column);</span><br><span class="line">                    cacheKey.update(value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="23、接（七、20）DefaultResultSetHandler的getRowValue方法"><a href="#23、接（七、20）DefaultResultSetHandler的getRowValue方法" class="headerlink" title="23、接（七、20）DefaultResultSetHandler的getRowValue方法"></a>23、接（七、20）DefaultResultSetHandler的getRowValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private Object getRowValue(ResultSetWrapper rsw, ResultMap resultMap, CacheKey combinedKey, CacheKey absoluteKey, String columnPrefix, </span><br><span class="line">      Object partialObject) throws SQLException &#123;</span><br><span class="line">    Object resultObject = partialObject;</span><br><span class="line">    if (resultObject != null) &#123;</span><br><span class="line">        //缓存中获取的对象不为空</span><br><span class="line">        final MetaObject metaObject = configuration.newMetaObject(resultObject);</span><br><span class="line">        ancestorObjects.put(absoluteKey, resultObject);</span><br><span class="line">        //处理内映射</span><br><span class="line">        applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, false);</span><br><span class="line">        ancestorObjects.remove(absoluteKey);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //缓存中获取的对象为空</span><br><span class="line">        //懒加载模式则返回ResultLoaderMap对象，否则返回null</span><br><span class="line">        final ResultLoaderMap lazyLoader = instantiateResultLoaderMap();</span><br><span class="line">        //创建返回的对象与（七、7）相同</span><br><span class="line">        resultObject = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);</span><br><span class="line">        if (resultObject != null &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;</span><br><span class="line">            final MetaObject metaObject = configuration.newMetaObject(resultObject);</span><br><span class="line">            boolean foundValues = resultMap.getConstructorResultMappings().size() &gt; 0;</span><br><span class="line">            if (shouldApplyAutomaticMappings(resultMap, AutoMappingBehavior.FULL.equals(configuration.getAutoMappingBehavior()))) &#123;</span><br><span class="line">                //自动映射，跟简单映射的处理方式一样,跟简单映射的处理方式一样</span><br><span class="line">                foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;</span><br><span class="line">            &#125;</span><br><span class="line">            //映射reulstMap节点，跟简单映射的处理方式一样,跟简单映射的处理方式一样        </span><br><span class="line">            foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;</span><br><span class="line">            ancestorObjects.put(absoluteKey, resultObject);</span><br><span class="line">            //处理内映射</span><br><span class="line">            foundValues = applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, true) || foundValues;</span><br><span class="line">            ancestorObjects.remove(absoluteKey);</span><br><span class="line">            //取到对象的值，或者懒加载开启，都返回true</span><br><span class="line">            foundValues = (lazyLoader != null &amp;&amp; lazyLoader.size() &gt; 0) || foundValues;</span><br><span class="line">            resultObject = foundValues ? resultObject : null;</span><br><span class="line">        &#125;</span><br><span class="line">        //对象加入缓存</span><br><span class="line">        if (combinedKey != CacheKey.NULL_CACHE_KEY) nestedResultObjects.put(combinedKey, resultObject);</span><br><span class="line">    &#125;</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="24、DefaultResultSetHandler的applyNestedResultMappings方法"><a href="#24、DefaultResultSetHandler的applyNestedResultMappings方法" class="headerlink" title="24、DefaultResultSetHandler的applyNestedResultMappings方法"></a>24、DefaultResultSetHandler的applyNestedResultMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">private boolean applyNestedResultMappings(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String parentPrefix, </span><br><span class="line">      CacheKey parentRowKey, boolean newObject) &#123;</span><br><span class="line">    boolean foundValues = false;</span><br><span class="line">    for (ResultMapping resultMapping : resultMap.getPropertyResultMappings()) &#123;</span><br><span class="line">        //获取子ResultMapId</span><br><span class="line">        final String nestedResultMapId = resultMapping.getNestedResultMapId();</span><br><span class="line">        if (nestedResultMapId != null &amp;&amp; resultMapping.getResultSet() == null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                final String columnPrefix = getColumnPrefix(parentPrefix, resultMapping);</span><br><span class="line">                //获取子ResultMap</span><br><span class="line">                final ResultMap nestedResultMap = getNestedResultMap(rsw.getResultSet(), nestedResultMapId, columnPrefix);</span><br><span class="line">                //创建缓存key</span><br><span class="line">                final CacheKey rowKey = createRowKey(nestedResultMap, rsw, columnPrefix);</span><br><span class="line">                //获取该对象的缓存</span><br><span class="line">                final Object ancestorObject = ancestorObjects.get(rowKey);</span><br><span class="line">                if (ancestorObject != null) &#123; </span><br><span class="line">                    //存在,则直接放入上级对象，解决循环依赖</span><br><span class="line">                    if (newObject) metaObject.setValue(resultMapping.getProperty(), ancestorObject);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //不存在</span><br><span class="line">                    //将上级对象的key与本对象key结合，作为本对象的新的key</span><br><span class="line">                    final CacheKey combinedKey = combineKeys(rowKey, parentRowKey);</span><br><span class="line">                    //再次从缓存中获取该对象            </span><br><span class="line">                    Object rowValue = nestedResultObjects.get(combinedKey);</span><br><span class="line">                    boolean knownValue = (rowValue != null);</span><br><span class="line">                    //实例化集合属性，并加入到上级对象中</span><br><span class="line">                    final Object collectionProperty = instantiateCollectionPropertyIfAppropriate(resultMapping, metaObject);</span><br><span class="line">                    //检查是否所有非空字段均有值            </span><br><span class="line">                    if (anyNotNullColumnHasValue(resultMapping, columnPrefix, rsw.getResultSet())) &#123;</span><br><span class="line">                        //生成对象</span><br><span class="line">                        rowValue = getRowValue(rsw, nestedResultMap, combinedKey, rowKey, columnPrefix, rowValue);</span><br><span class="line">                        if (rowValue != null &amp;&amp; !knownValue) &#123;</span><br><span class="line">                            if (collectionProperty != null) &#123;</span><br><span class="line">                                final MetaObject targetMetaObject = configuration.newMetaObject(collectionProperty);</span><br><span class="line">                                //对象放入刚刚创建的集合中</span><br><span class="line">                                targetMetaObject.add(rowValue);</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                //对象放入上级对象中</span><br><span class="line">                                metaObject.setValue(resultMapping.getProperty(), rowValue);</span><br><span class="line">                            &#125;</span><br><span class="line">                            foundValues = true;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (SQLException e) &#123;</span><br><span class="line">                throw new ExecutorException(&quot;Error getting nested result map values for &apos;&quot; + resultMapping.getProperty() + &quot;&apos;.  Cause: &quot; + e, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foundValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法"><a href="#25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法" class="headerlink" title="25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法"></a>25、DefaultResultSetHandler的instantiateCollectionPropertyIfAppropriate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private Object instantiateCollectionPropertyIfAppropriate(ResultMapping resultMapping, MetaObject metaObject) &#123;</span><br><span class="line">    //属性名</span><br><span class="line">    final String propertyName = resultMapping.getProperty();</span><br><span class="line">    //设置值</span><br><span class="line">    Object propertyValue = metaObject.getValue(propertyName);</span><br><span class="line">    if (propertyValue == null) &#123;</span><br><span class="line">        //如果为空，取出类型</span><br><span class="line">        Class&lt;?&gt; type = resultMapping.getJavaType();</span><br><span class="line">        if (type == null) &#123;</span><br><span class="line">            type = metaObject.getSetterType(propertyName);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //如果是集合类型</span><br><span class="line">            if (objectFactory.isCollection(type)) &#123;</span><br><span class="line">                //生成一个集合对象</span><br><span class="line">                propertyValue = objectFactory.create(type);</span><br><span class="line">                //设置到上一级对象中去 </span><br><span class="line">                metaObject.setValue(propertyName, propertyValue);</span><br><span class="line">                return propertyValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new ExecutorException(&quot;Error instantiating collection property for result &apos;&quot; + resultMapping.getProperty() + &quot;&apos;.  Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (objectFactory.isCollection(propertyValue.getClass())) &#123;</span><br><span class="line">        return propertyValue;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="八、懒加载过程"><a href="#八、懒加载过程" class="headerlink" title="八、懒加载过程"></a>八、懒加载过程</h3><h4 id="1、EnhancedResultObjectProxyImpl的intercept方法"><a href="#1、EnhancedResultObjectProxyImpl的intercept方法" class="headerlink" title="1、EnhancedResultObjectProxyImpl的intercept方法"></a>1、EnhancedResultObjectProxyImpl的intercept方法</h4><h5 id="有子查询，返回的是代理对象，执行对象的get方法，会先经过intercept方法"><a href="#有子查询，返回的是代理对象，执行对象的get方法，会先经过intercept方法" class="headerlink" title="有子查询，返回的是代理对象，执行对象的get方法，会先经过intercept方法"></a>有子查询，返回的是代理对象，执行对象的get方法，会先经过intercept方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public Object intercept(Object enhanced, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">    //调用的方法</span><br><span class="line">    final String methodName = method.getName();</span><br><span class="line">    try &#123;</span><br><span class="line">        synchronized (lazyLoader) &#123;</span><br><span class="line">            if (WRITE_REPLACE_METHOD.equals(methodName)) &#123;</span><br><span class="line">                //writeReplace方法可以使对象被写入流以前，用一个对象来替换自己</span><br><span class="line">                //将要序列化的对象</span><br><span class="line">                Object original = null;</span><br><span class="line">                if (constructorArgTypes.isEmpty()) &#123;</span><br><span class="line">                    //创建原始对象</span><br><span class="line">                    original = objectFactory.create(type);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    original = objectFactory.create(type, constructorArgTypes, constructorArgs);</span><br><span class="line">                &#125;</span><br><span class="line">                PropertyCopier.copyBeanProperties(type, enhanced, original);   </span><br><span class="line">                if (lazyLoader.size() &gt; 0) &#123;</span><br><span class="line">                    //有懒加载方法</span><br><span class="line">                    //创建代理对象</span><br><span class="line">                    return new CglibSerialStateHolder(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //返回原始对象</span><br><span class="line">                    return original;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //有懒加载方法，且本方法不为finalize方法</span><br><span class="line">                if (lazyLoader.size() &gt; 0 &amp;&amp; !FINALIZE_METHOD.equals(methodName)) &#123;</span><br><span class="line">                    if (aggressive || lazyLoadTriggerMethods.contains(methodName)) &#123;</span><br><span class="line">                        //加载所有子查询</span><br><span class="line">                        lazyLoader.loadAll();</span><br><span class="line">                    &#125; else if (PropertyNamer.isProperty(methodName)) &#123;</span><br><span class="line">                        //由get或set方法名获取property字段名</span><br><span class="line">                        final String property = PropertyNamer.methodToProperty(methodName);</span><br><span class="line">                        if (lazyLoader.hasLoader(property)) &#123;</span><br><span class="line">                            //查询该字段</span><br><span class="line">                            lazyLoader.load(property);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return methodProxy.invokeSuper(enhanced, args);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="懒加载配置示例"><a href="#懒加载配置示例" class="headerlink" title="懒加载配置示例"></a>懒加载配置示例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 查询时，关闭关联对象即时加载以提高性能 --&gt;  </span><br><span class="line">&lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot; /&gt;  </span><br><span class="line">&lt;!-- 该属性为true，则在访问任何一个懒加载属性时，加载所有懒加载属性 --&gt;  </span><br><span class="line">&lt;setting name=&quot;aggressiveLazyLoading&quot; value=&quot;false&quot; /&gt;  </span><br><span class="line">&lt;!-- 配置该方法，触发所有懒加载 --&gt;  </span><br><span class="line">&lt;setting name=&quot;lazyLoadTriggerMethods&quot; value=&quot;doLazyLoadingNow,equals,clone,hashCode,toString&quot; /&gt;</span><br></pre></td></tr></table></figure>
<h4 id="2、ResultLoaderMap的loadAll方法"><a href="#2、ResultLoaderMap的loadAll方法" class="headerlink" title="2、ResultLoaderMap的loadAll方法"></a>2、ResultLoaderMap的loadAll方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void loadAll() throws SQLException &#123;</span><br><span class="line">    //获取所有懒加载方法名</span><br><span class="line">    final Set&lt;String&gt; methodNameSet = loaderMap.keySet();</span><br><span class="line">    String[] methodNames = methodNameSet.toArray(new String[methodNameSet.size()]);</span><br><span class="line">    for (String methodName : methodNames) &#123;</span><br><span class="line">        //加载</span><br><span class="line">        load(methodName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、ResultLoaderMap的load方法"><a href="#3、ResultLoaderMap的load方法" class="headerlink" title="3、ResultLoaderMap的load方法"></a>3、ResultLoaderMap的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean load(String property) throws SQLException &#123;</span><br><span class="line">    LoadPair pair = loaderMap.remove(property.toUpperCase(Locale.ENGLISH));</span><br><span class="line">    if (pair != null) &#123;</span><br><span class="line">        //加载</span><br><span class="line">        pair.load();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、LoadPair的load方法"><a href="#4、LoadPair的load方法" class="headerlink" title="4、LoadPair的load方法"></a>4、LoadPair的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void load() throws SQLException &#123;</span><br><span class="line">    /* These field should not be null unless the loadpair was serialized.</span><br><span class="line">     * Yet in that case this method should not be called. */</span><br><span class="line">    if (this.metaResultObject == null) throw new IllegalArgumentException(&quot;metaResultObject is null&quot;);</span><br><span class="line">    if (this.resultLoader == null) throw new IllegalArgumentException(&quot;resultLoader is null&quot;);</span><br><span class="line"></span><br><span class="line">    this.load(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public void load(final Object userObject) throws SQLException &#123;</span><br><span class="line">    if (this.metaResultObject == null || this.resultLoader == null) &#123;</span><br><span class="line">        if (this.mappedParameter == null) &#123;</span><br><span class="line">            throw new ExecutorException(&quot;Property [&quot; + this.property + &quot;] cannot be loaded because &quot;</span><br><span class="line">                  + &quot;required parameter of mapped statement [&quot;</span><br><span class="line">                  + this.mappedStatement + &quot;] is not serializable.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final Configuration config = this.getConfiguration();</span><br><span class="line">        //获取子查询的MappedStatement</span><br><span class="line">        final MappedStatement ms = config.getMappedStatement(this.mappedStatement);</span><br><span class="line">        if (ms == null) &#123;</span><br><span class="line">            throw new ExecutorException(&quot;Cannot lazy load property [&quot; + this.property</span><br><span class="line">                  + &quot;] of deserialized object [&quot; + userObject.getClass()</span><br><span class="line">                  + &quot;] because configuration does not contain statement [&quot;</span><br><span class="line">                  + this.mappedStatement + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.metaResultObject = config.newMetaObject(userObject);</span><br><span class="line">        this.resultLoader = new ResultLoader(config, new ClosedExecutor(), ms, this.mappedParameter,</span><br><span class="line">            metaResultObject.getSetterType(this.property), null, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* We are using a new executor because we may be (and likely are) on a new thread</span><br><span class="line">     * and executors aren&apos;t thread safe. (Is this sufficient?)</span><br><span class="line">     *</span><br><span class="line">     * A better approach would be making executors thread safe. */</span><br><span class="line">    if (this.serializationCheck == null) &#123;</span><br><span class="line">        //正在序列化过程中,关闭原先的执行器</span><br><span class="line">        final ResultLoader old = this.resultLoader;</span><br><span class="line">        this.resultLoader = new ResultLoader(old.configuration, new ClosedExecutor(), old.mappedStatement,</span><br><span class="line">                old.parameterObject, old.targetType, old.cacheKey, old.boundSql);</span><br><span class="line">    &#125;</span><br><span class="line">    //查询出结果，并放入对象中</span><br><span class="line">    this.metaResultObject.setValue(property, this.resultLoader.loadResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、ResultLoader的loadResult方法"><a href="#5、ResultLoader的loadResult方法" class="headerlink" title="5、ResultLoader的loadResult方法"></a>5、ResultLoader的loadResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public Object loadResult() throws SQLException &#123;</span><br><span class="line">    //查询</span><br><span class="line">    List&lt;Object&gt; list = selectList();</span><br><span class="line">    //处理查询结果</span><br><span class="line">    resultObject = resultExtractor.extractObjectFromList(list, targetType);</span><br><span class="line">    return resultObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、ResultLoader的selectList方法"><a href="#6、ResultLoader的selectList方法" class="headerlink" title="6、ResultLoader的selectList方法"></a>6、ResultLoader的selectList方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private &lt;E&gt; List&lt;E&gt; selectList() throws SQLException &#123;</span><br><span class="line">    Executor localExecutor = executor;</span><br><span class="line">    if (Thread.currentThread().getId() != this.creatorThreadId || localExecutor.isClosed()) &#123;</span><br><span class="line">        //新线程，创建新的执行器</span><br><span class="line">        localExecutor = newExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //查询</span><br><span class="line">        return localExecutor.&lt;E&gt; query(mappedStatement, parameterObject, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER, cacheKey, boundSql);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (localExecutor != executor) &#123;</span><br><span class="line">            localExecutor.close(false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>