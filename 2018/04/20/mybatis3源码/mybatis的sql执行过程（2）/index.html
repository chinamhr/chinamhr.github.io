<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="一、insert执行过程1、DefaultSqlSession的insert方法123public int insert(String statement) &amp;#123;    return insert(statement, null);&amp;#125;
123public int insert(St"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="MyBatis的sql执行过程（2）"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="一、insert执行过程1、DefaultSqlSession的insert方法123public int insert(String statement) &amp;#123;    return insert(statement, null);&amp;#125;
123public int insert(St"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.comhttp://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.comhttp://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>MyBatis的sql执行过程（2） - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('http://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>MyBatis的sql执行过程（2）</h1>
                    
                    <h2 class="post-subheading">
                        MyBatis插入insert方法的执行过程、二级缓存、分页插件、元对象的解析
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-04-20
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/mybatis3/">mybatis3</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="一、insert执行过程"><a href="#一、insert执行过程" class="headerlink" title="一、insert执行过程"></a>一、insert执行过程</h3><h4 id="1、DefaultSqlSession的insert方法"><a href="#1、DefaultSqlSession的insert方法" class="headerlink" title="1、DefaultSqlSession的insert方法"></a>1、DefaultSqlSession的insert方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int insert(String statement) &#123;</span><br><span class="line">    return insert(statement, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int insert(String statement, Object parameter) &#123;</span><br><span class="line">    return update(statement, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DefaultSqlSession的update方法"><a href="#2、DefaultSqlSession的update方法" class="headerlink" title="2、DefaultSqlSession的update方法"></a>2、DefaultSqlSession的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public int update(String statement, Object parameter) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        dirty = true;</span><br><span class="line">        MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">        //执行</span><br><span class="line">        return executor.update(ms, wrapCollection(parameter));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error updating database.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、BaseExecutor的update方法"><a href="#3、BaseExecutor的update方法" class="headerlink" title="3、BaseExecutor的update方法"></a>3、BaseExecutor的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public int update(MappedStatement ms, Object parameter) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing an update&quot;).object(ms.getId());</span><br><span class="line">    if (closed) throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    //清空一级缓存</span><br><span class="line">    clearLocalCache();</span><br><span class="line">    return doUpdate(ms, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、SimpleExecutor的doUpdate方法"><a href="#4、SimpleExecutor的doUpdate方法" class="headerlink" title="4、SimpleExecutor的doUpdate方法"></a>4、SimpleExecutor的doUpdate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public int doUpdate(MappedStatement ms, Object parameter) throws SQLException &#123;</span><br><span class="line">    Statement stmt = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, null, null);</span><br><span class="line">        //预处理</span><br><span class="line">        stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        //执行sql</span><br><span class="line">        return handler.update(stmt);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、RoutingStatementHandler的update方法"><a href="#5、RoutingStatementHandler的update方法" class="headerlink" title="5、RoutingStatementHandler的update方法"></a>5、RoutingStatementHandler的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int update(Statement statement) throws SQLException &#123;</span><br><span class="line">    return delegate.update(statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、实例化PreparedStatementHandler"><a href="#6、实例化PreparedStatementHandler" class="headerlink" title="6、实例化PreparedStatementHandler"></a>6、实例化PreparedStatementHandler</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public PreparedStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler </span><br><span class="line">      resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    super(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected BaseStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, </span><br><span class="line">      ResultHandler resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    this.configuration = mappedStatement.getConfiguration();</span><br><span class="line">    this.executor = executor;</span><br><span class="line">    this.mappedStatement = mappedStatement;</span><br><span class="line">    this.rowBounds = rowBounds;</span><br><span class="line"></span><br><span class="line">    this.typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class="line">    this.objectFactory = configuration.getObjectFactory();</span><br><span class="line"></span><br><span class="line">    if (boundSql == null) &#123; // issue #435, get the key before calculating the statement</span><br><span class="line">        generateKeys(parameterObject);</span><br><span class="line">        boundSql = mappedStatement.getBoundSql(parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.boundSql = boundSql;</span><br><span class="line"></span><br><span class="line">    this.parameterHandler = configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class="line">    this.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, rowBounds, parameterHandler, resultHandler, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、BaseStatementHandler的generateKeys"><a href="#7、BaseStatementHandler的generateKeys" class="headerlink" title="7、BaseStatementHandler的generateKeys"></a>7、BaseStatementHandler的generateKeys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protected void generateKeys(Object parameter) &#123;</span><br><span class="line">    KeyGenerator keyGenerator = mappedStatement.getKeyGenerator();</span><br><span class="line">    ErrorContext.instance().store();</span><br><span class="line">    keyGenerator.processBefore(executor, mappedStatement, null, parameter);</span><br><span class="line">    ErrorContext.instance().recall();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、SelectKeyGenerator的processBefore"><a href="#8、SelectKeyGenerator的processBefore" class="headerlink" title="8、SelectKeyGenerator的processBefore"></a>8、SelectKeyGenerator的processBefore</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void processBefore(Executor executor, MappedStatement ms, Statement stmt, Object parameter) &#123;</span><br><span class="line">    if (executeBefore) &#123;</span><br><span class="line">        processGeneratedKeys(executor, ms, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、SelectKeyGenerator的processGeneratedKeys"><a href="#9、SelectKeyGenerator的processGeneratedKeys" class="headerlink" title="9、SelectKeyGenerator的processGeneratedKeys"></a>9、SelectKeyGenerator的processGeneratedKeys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private void processGeneratedKeys(Executor executor, MappedStatement ms, Object parameter) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (parameter != null &amp;&amp; keyStatement != null &amp;&amp; keyStatement.getKeyProperties() != null) &#123;</span><br><span class="line">            //主键的属性名</span><br><span class="line">            String keyProperty = keyStatement.getKeyProperties()[0]; // just one key property is supported</span><br><span class="line">            final Configuration configuration = ms.getConfiguration();</span><br><span class="line">            final MetaObject metaParam = configuration.newMetaObject(parameter);</span><br><span class="line">            if (keyProperty != null &amp;&amp; metaParam.hasSetter(keyProperty)) &#123;</span><br><span class="line">                // Do not close keyExecutor.</span><br><span class="line">                // The transaction will be closed by parent executor.</span><br><span class="line">                //获取执行器</span><br><span class="line">                Executor keyExecutor = configuration.newExecutor(executor.getTransaction(), ExecutorType.SIMPLE);</span><br><span class="line">                //执行查询sql，获取主键</span><br><span class="line">                List&lt;Object&gt; values = keyExecutor.query(keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);</span><br><span class="line">                if (values.size() == 0) &#123;</span><br><span class="line">                    throw new ExecutorException(&quot;SelectKey returned no data.&quot;);            </span><br><span class="line">                &#125; else if (values.size() &gt; 1) &#123;</span><br><span class="line">                    throw new ExecutorException(&quot;SelectKey returned more than one value.&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //将获取的主键值设置到参数中</span><br><span class="line">                    metaParam.setValue(keyProperty, values.get(0));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (ExecutorException e) &#123;</span><br><span class="line">        throw e;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new ExecutorException(&quot;Error selecting key or setting result to parameter object. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（一、6）PreparedStatementHandler的update方法"><a href="#10、接（一、6）PreparedStatementHandler的update方法" class="headerlink" title="10、接（一、6）PreparedStatementHandler的update方法"></a>10、接（一、6）PreparedStatementHandler的update方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public int update(Statement statement) throws SQLException &#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    //执行条数</span><br><span class="line">    int rows = ps.getUpdateCount();</span><br><span class="line">    Object parameterObject = boundSql.getParameterObject();</span><br><span class="line">    KeyGenerator keyGenerator = mappedStatement.getKeyGenerator();</span><br><span class="line">    //executeBefore为true，processAfter不会执行</span><br><span class="line">    keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);</span><br><span class="line">    return rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、二级缓存"><a href="#二、二级缓存" class="headerlink" title="二、二级缓存"></a>二、二级缓存</h3><h4 id="1、CachingExecutor的query方法"><a href="#1、CachingExecutor的query方法" class="headerlink" title="1、CachingExecutor的query方法"></a>1、CachingExecutor的query方法</h4><h5 id="配置二级缓存-会用CachingExecutor封装SimpleExecutor"><a href="#配置二级缓存-会用CachingExecutor封装SimpleExecutor" class="headerlink" title="配置二级缓存,会用CachingExecutor封装SimpleExecutor"></a>配置二级缓存,会用CachingExecutor封装SimpleExecutor</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler) </span><br><span class="line">      throws   SQLException &#123;</span><br><span class="line">    BoundSql boundSql = ms.getBoundSql(parameterObject);</span><br><span class="line">    //创建缓存key，与一级缓存一样</span><br><span class="line">    CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">    return query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, </span><br><span class="line">      BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    //从MappedStatement获取一个Cache，如果对象的命名空间没有配置cache或cache-ref节点,cache将为空，表示不使用缓存，</span><br><span class="line">    //缓存创建过程见配置加载过程（二、8）</span><br><span class="line">    Cache cache = ms.getCache();</span><br><span class="line">    if (cache != null) &#123;</span><br><span class="line">        //如果需要刷新缓存的话就刷新：flushCache=&quot;true&quot;</span><br><span class="line">        flushCacheIfRequired(ms);</span><br><span class="line">        //useCache=&quot;true&quot;</span><br><span class="line">        if (ms.isUseCache() &amp;&amp; resultHandler == null) &#123;</span><br><span class="line">            //检查是否是带ParameterMode.OUT输出参数的存储过程</span><br><span class="line">            ensureNoOutParams(ms, parameterObject, boundSql);</span><br><span class="line">            //如果缓存数据可继续使用</span><br><span class="line">            if (!dirty) &#123;</span><br><span class="line">                //获取读锁</span><br><span class="line">                cache.getReadWriteLock().readLock().lock();</span><br><span class="line">                try &#123;</span><br><span class="line">                    //从缓存中获取数据</span><br><span class="line">                    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">                    List&lt;E&gt; cachedList = (List&lt;E&gt;) cache.getObject(key);</span><br><span class="line">                    //如果存在，返回缓存数据</span><br><span class="line">                    if (cachedList != null) return cachedList;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    //释放读锁</span><br><span class="line">                    cache.getReadWriteLock().readLock().unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //如果缓存中没有，执行查询</span><br><span class="line">            List&lt;E&gt; list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">            //数据添加进缓存</span><br><span class="line">            tcm.putObject(cache, key, list); // issue #578. Query must be not synchronized to prevent deadlocks</span><br><span class="line">            return list;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有二级缓存，直接查询</span><br><span class="line">    return delegate.&lt;E&gt;query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、CachingExecutor的flushCacheIfRequired方法"><a href="#2、CachingExecutor的flushCacheIfRequired方法" class="headerlink" title="2、CachingExecutor的flushCacheIfRequired方法"></a>2、CachingExecutor的flushCacheIfRequired方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void flushCacheIfRequired(MappedStatement ms) &#123;</span><br><span class="line">    Cache cache = ms.getCache();</span><br><span class="line">    //执行该sql，缓存需刷新</span><br><span class="line">    if (cache != null &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">        //表示缓存数据不可继续使用</span><br><span class="line">        dirty = true; // issue #524. Disable using cached data for this session</span><br><span class="line">        //清空缓存</span><br><span class="line">        tcm.clear(cache);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、TransactionalCacheManager的clear方法"><a href="#3、TransactionalCacheManager的clear方法" class="headerlink" title="3、TransactionalCacheManager的clear方法"></a>3、TransactionalCacheManager的clear方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void clear(Cache cache) &#123;</span><br><span class="line">    getTransactionalCache(cache).clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、TransactionalCacheManager的getTransactionalCache方法"><a href="#4、TransactionalCacheManager的getTransactionalCache方法" class="headerlink" title="4、TransactionalCacheManager的getTransactionalCache方法"></a>4、TransactionalCacheManager的getTransactionalCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private TransactionalCache getTransactionalCache(Cache cache) &#123;</span><br><span class="line">    //由cache做key获取TransactionalCache</span><br><span class="line">    TransactionalCache txCache = transactionalCaches.get(cache);</span><br><span class="line">    if (txCache == null) &#123;</span><br><span class="line">        //没有则封装一个</span><br><span class="line">        txCache = new TransactionalCache(cache);</span><br><span class="line">        //存入该Map</span><br><span class="line">        transactionalCaches.put(cache, txCache);</span><br><span class="line">    &#125;</span><br><span class="line">    return txCache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（二、3）TransactionalCache的clear方法"><a href="#5、接（二、3）TransactionalCache的clear方法" class="headerlink" title="5、接（二、3）TransactionalCache的clear方法"></a>5、接（二、3）TransactionalCache的clear方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //清空临时数据</span><br><span class="line">    reset();</span><br><span class="line">    //commit时先清空缓存，在执行后续操作</span><br><span class="line">    clearOnCommit = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、TransactionalCache的reset方法"><a href="#6、TransactionalCache的reset方法" class="headerlink" title="6、TransactionalCache的reset方法"></a>6、TransactionalCache的reset方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void reset() &#123;</span><br><span class="line">    clearOnCommit = false;</span><br><span class="line">    //清空临时数据队列</span><br><span class="line">    entriesToRemoveOnCommit.clear();</span><br><span class="line">    entriesToAddOnCommit.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（二、1）SynchronizedCache的getObject方法"><a href="#7、接（二、1）SynchronizedCache的getObject方法" class="headerlink" title="7、接（二、1）SynchronizedCache的getObject方法"></a>7、接（二、1）SynchronizedCache的getObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //获取读锁</span><br><span class="line">    acquireReadLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //继续从下级获取</span><br><span class="line">        return delegate.getObject(key);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放读锁</span><br><span class="line">        releaseReadLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="LoggingCache的getObject方法"><a href="#LoggingCache的getObject方法" class="headerlink" title="LoggingCache的getObject方法"></a>LoggingCache的getObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //请求次数加一</span><br><span class="line">    requests++;</span><br><span class="line">    //继续从下级获取</span><br><span class="line">    final Object value = delegate.getObject(key);</span><br><span class="line">    if (value != null) &#123;</span><br><span class="line">        //获取成功，命中次数加一</span><br><span class="line">        hits++;</span><br><span class="line">    &#125;</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Cache Hit Ratio [&quot; + getId() + &quot;]: &quot; + getHitRatio());</span><br><span class="line">    &#125;</span><br><span class="line">    return value;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h5 id="SerializedCache的getObject方法"><a href="#SerializedCache的getObject方法" class="headerlink" title="SerializedCache的getObject方法"></a>SerializedCache的getObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //继续从下级获取</span><br><span class="line">    Object object = delegate.getObject(key);</span><br><span class="line">    //反序列化</span><br><span class="line">    return object == null ? null : deserialize((byte[]) object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ScheduledCache的getObject"><a href="#ScheduledCache的getObject" class="headerlink" title="ScheduledCache的getObject"></a>ScheduledCache的getObject</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    if (clearWhenStale()) &#123;</span><br><span class="line">        //当上次清空时间与当前时间差，大于最大缓存清空间隔时间</span><br><span class="line">        //清空缓存，返回null</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //继续从下级获取</span><br><span class="line">        return delegate.getObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="LruCache的getObject方法"><a href="#LruCache的getObject方法" class="headerlink" title="LruCache的getObject方法"></a>LruCache的getObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  public Object getObject(Object key) &#123;</span><br><span class="line">      //将key对应的Node移至队尾</span><br><span class="line">      keyMap.get(key); //touch</span><br><span class="line">      //继续从下级获取</span><br><span class="line">      return delegate.getObject(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PerpetualCache的getObject方法"><a href="#PerpetualCache的getObject方法" class="headerlink" title="PerpetualCache的getObject方法"></a>PerpetualCache的getObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object getObject(Object key) &#123;</span><br><span class="line">    //从Map中获取缓存数据</span><br><span class="line">    return cache.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、接（二、1）TransactionalCacheManager的putObject方法"><a href="#8、接（二、1）TransactionalCacheManager的putObject方法" class="headerlink" title="8、接（二、1）TransactionalCacheManager的putObject方法"></a>8、接（二、1）TransactionalCacheManager的putObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Cache cache, CacheKey key, Object value) &#123;</span><br><span class="line">    getTransactionalCache(cache).putObject(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、TransactionalCache的putObject方法"><a href="#9、TransactionalCache的putObject方法" class="headerlink" title="9、TransactionalCache的putObject方法"></a>9、TransactionalCache的putObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    //commit时从缓存中删除</span><br><span class="line">    entriesToRemoveOnCommit.remove(key);</span><br><span class="line">    //commit时添加进缓存</span><br><span class="line">    entriesToAddOnCommit.put(key, new AddEntry(delegate, key, object));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、CachingExecutor的close方法"><a href="#10、CachingExecutor的close方法" class="headerlink" title="10、CachingExecutor的close方法"></a>10、CachingExecutor的close方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void close(boolean forceRollback) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //issue #499. Unresolved session handling</span><br><span class="line">        //issue #573. Autocommit sessions should commit</span><br><span class="line">        if (dirty &amp;&amp; !autoCommit) &#123;</span><br><span class="line">            //缓存失效（说明执行的是update之类方法），并且不是自动提交的</span><br><span class="line">            //回滚未提交的缓存 </span><br><span class="line">            tcm.rollback();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //提交缓存</span><br><span class="line">            tcm.commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        delegate.close(forceRollback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、TransactionalCacheManager的rollback方法"><a href="#11、TransactionalCacheManager的rollback方法" class="headerlink" title="11、TransactionalCacheManager的rollback方法"></a>11、TransactionalCacheManager的rollback方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void rollback() &#123;</span><br><span class="line">    for (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">        //回滚缓存数据</span><br><span class="line">        txCache.rollback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、TransactionalCache的rollback方法"><a href="#12、TransactionalCache的rollback方法" class="headerlink" title="12、TransactionalCache的rollback方法"></a>12、TransactionalCache的rollback方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void rollback() &#123;</span><br><span class="line">    //临时数据区域</span><br><span class="line">    reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、接（二、10）TransactionalCacheManager的commit方法"><a href="#11、接（二、10）TransactionalCacheManager的commit方法" class="headerlink" title="11、接（二、10）TransactionalCacheManager的commit方法"></a>11、接（二、10）TransactionalCacheManager的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    delegate.getReadWriteLock().writeLock().lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        if (clearOnCommit) &#123;</span><br><span class="line">            //清空缓存</span><br><span class="line">            delegate.clear();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            for (RemoveEntry entry : entriesToRemoveOnCommit.values()) &#123;</span><br><span class="line">                //删除该key对应的缓存数据</span><br><span class="line">                entry.commit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        for (AddEntry entry : entriesToAddOnCommit.values()) &#123;</span><br><span class="line">            //添加该key对应的缓存数据</span><br><span class="line">            entry.commit();</span><br><span class="line">        &#125;</span><br><span class="line">        //清空队列</span><br><span class="line">        reset();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        delegate.getReadWriteLock().writeLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、SynchronizedCache的clear方法"><a href="#12、SynchronizedCache的clear方法" class="headerlink" title="12、SynchronizedCache的clear方法"></a>12、SynchronizedCache的clear方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //一层一层，最后获取的是PerpetualCache中的readWriteLock锁，获取写锁</span><br><span class="line">    acquireWriteLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        delegate.clear();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        releaseWriteLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="clear方法一层一层调用，LoggingCache（记录缓存命中率）、SerializedCache（流）、ScheduledCache（定时清空Cache）、LruCache（默认的淘汰包装器），"><a href="#clear方法一层一层调用，LoggingCache（记录缓存命中率）、SerializedCache（流）、ScheduledCache（定时清空Cache）、LruCache（默认的淘汰包装器），" class="headerlink" title="clear方法一层一层调用，LoggingCache（记录缓存命中率）、SerializedCache（流）、ScheduledCache（定时清空Cache）、LruCache（默认的淘汰包装器），"></a>clear方法一层一层调用，LoggingCache（记录缓存命中率）、SerializedCache（流）、ScheduledCache（定时清空Cache）、LruCache（默认的淘汰包装器），</h5><h5 id="直到LruCache的clear方法"><a href="#直到LruCache的clear方法" class="headerlink" title="直到LruCache的clear方法"></a>直到LruCache的clear方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //下一层clear</span><br><span class="line">    delegate.clear();</span><br><span class="line">    // 清空keyMap</span><br><span class="line">    keyMap.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="keyMap为LinkedHashMap先看下"><a href="#keyMap为LinkedHashMap先看下" class="headerlink" title="keyMap为LinkedHashMap先看下"></a>keyMap为LinkedHashMap先看下</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void setSize(final int size) &#123;</span><br><span class="line">    //size默认1024</span><br><span class="line">    //为Map加锁synchronized</span><br><span class="line">    keyMap = Collections.synchronizedMap(new LinkedHashMap&lt;Object, Object&gt;(size, .75F, true) &#123;</span><br><span class="line">        private static final long serialVersionUID = 4267176411845948333L;</span><br><span class="line">        //实现该方法，将队首节点设置为待删除节点，立即删除keyMap中该节点</span><br><span class="line">        protected boolean removeEldestEntry(Map.Entry&lt;Object, Object&gt; eldest) &#123;</span><br><span class="line">            //当前保存数据数量是否大于size</span><br><span class="line">            boolean tooBig = size() &gt; size;</span><br><span class="line">            if (tooBig) &#123;</span><br><span class="line">                //更新最久未使用的缓存数据</span><br><span class="line">                eldestKey = eldest.getKey();</span><br><span class="line">            &#125;</span><br><span class="line">            return tooBig;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PerpetualCache的clear方法"><a href="#PerpetualCache的clear方法" class="headerlink" title="PerpetualCache的clear方法"></a>PerpetualCache的clear方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void clear() &#123;</span><br><span class="line">    //清空该Map</span><br><span class="line">    cache.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（二、11）RemoveEntry的commit方法"><a href="#12、接（二、11）RemoveEntry的commit方法" class="headerlink" title="12、接（二、11）RemoveEntry的commit方法"></a>12、接（二、11）RemoveEntry的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    cache.removeObject(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、SynchronizedCache的removeObject方法"><a href="#13、SynchronizedCache的removeObject方法" class="headerlink" title="13、SynchronizedCache的removeObject方法"></a>13、SynchronizedCache的removeObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public Object removeObject(Object key) &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    acquireWriteLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //依次调用下级缓存删除该节点数据</span><br><span class="line">        return delegate.removeObject(key);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        releaseWriteLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（二、11）AddEntry的commit方法"><a href="#14、接（二、11）AddEntry的commit方法" class="headerlink" title="14、接（二、11）AddEntry的commit方法"></a>14、接（二、11）AddEntry的commit方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    cache.putObject(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、SynchronizedCache的putObject方法"><a href="#15、SynchronizedCache的putObject方法" class="headerlink" title="15、SynchronizedCache的putObject方法"></a>15、SynchronizedCache的putObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    //获取写锁</span><br><span class="line">    acquireWriteLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //数据添加进下级缓存</span><br><span class="line">        delegate.putObject(key, object);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放写锁</span><br><span class="line">        releaseWriteLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="SerializedCache的putObject方法"><a href="#SerializedCache的putObject方法" class="headerlink" title="SerializedCache的putObject方法"></a>SerializedCache的putObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    if (object == null || object instanceof Serializable) &#123;</span><br><span class="line">        //数据序列化后，添加进下级缓存</span><br><span class="line">        delegate.putObject(key, serialize((Serializable) object));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new CacheException(&quot;SharedCache failed to make a copy of a non-serializable object: &quot; + object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ScheduledCache的putObject方法"><a href="#ScheduledCache的putObject方法" class="headerlink" title="ScheduledCache的putObject方法"></a>ScheduledCache的putObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object object) &#123;</span><br><span class="line">    //超时则清空缓存</span><br><span class="line">    clearWhenStale();</span><br><span class="line">    //数据添加进下级缓存</span><br><span class="line">    delegate.putObject(key, object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="LruCache的putObject方法"><a href="#LruCache的putObject方法" class="headerlink" title="LruCache的putObject方法"></a>LruCache的putObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object value) &#123;</span><br><span class="line">    //数据添加进下级缓存</span><br><span class="line">    delegate.putObject(key, value);</span><br><span class="line">    //key加入keyMap中，并移至队尾，并检查是否有待删除节点</span><br><span class="line">    cycleKeyList(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PerpetualCache的putObject方法"><a href="#PerpetualCache的putObject方法" class="headerlink" title="PerpetualCache的putObject方法"></a>PerpetualCache的putObject方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void putObject(Object key, Object value) &#123;</span><br><span class="line">    //数据存入缓存</span><br><span class="line">    cache.put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、LruCache的cycleKeyList方法"><a href="#16、LruCache的cycleKeyList方法" class="headerlink" title="16、LruCache的cycleKeyList方法"></a>16、LruCache的cycleKeyList方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void cycleKeyList(Object key) &#123;</span><br><span class="line">    //key加入keyMap中，并移至队尾</span><br><span class="line">    keyMap.put(key, key);</span><br><span class="line">    //有待删除节点</span><br><span class="line">    if (eldestKey != null) &#123;</span><br><span class="line">        //下级缓存，删除待删除节点</span><br><span class="line">        delegate.removeObject(eldestKey);</span><br><span class="line">        eldestKey = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、PerpetualCache的removeObject方法"><a href="#17、PerpetualCache的removeObject方法" class="headerlink" title="17、PerpetualCache的removeObject方法"></a>17、PerpetualCache的removeObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public Object removeObject(Object key) &#123;</span><br><span class="line">    //删除该节点</span><br><span class="line">    return cache.remove(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、分页插件"><a href="#三、分页插件" class="headerlink" title="三、分页插件"></a>三、分页插件</h3><h4 id="1、XMLConfigBuilder的pluginElement方法"><a href="#1、XMLConfigBuilder的pluginElement方法" class="headerlink" title="1、XMLConfigBuilder的pluginElement方法"></a>1、XMLConfigBuilder的pluginElement方法</h4><h5 id="xml加载时，加载插件配置的方法"><a href="#xml加载时，加载插件配置的方法" class="headerlink" title="xml加载时，加载插件配置的方法"></a>xml加载时，加载插件配置的方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">private void pluginElement(XNode parent) throws Exception &#123;</span><br><span class="line">    if (parent != null) &#123;</span><br><span class="line">        for (XNode child : parent.getChildren()) &#123;</span><br><span class="line">            //插件全类名</span><br><span class="line">            String interceptor = child.getStringAttribute(&quot;interceptor&quot;);</span><br><span class="line">            //属性</span><br><span class="line">            Properties properties = child.getChildrenAsProperties();</span><br><span class="line">            //实例化插件</span><br><span class="line">            Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();</span><br><span class="line">            //设置插件属性</span><br><span class="line">            interceptorInstance.setProperties(properties);</span><br><span class="line">            //插件加载入configuration的interceptorChain中</span><br><span class="line">            configuration.addInterceptor(interceptorInstance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="分页插件配置示例"><a href="#分页插件配置示例" class="headerlink" title="分页插件配置示例"></a>分页插件配置示例</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line">    &lt;!-- com.github.pagehelper为PageHelper类所在包名 --&gt;</span><br><span class="line">    &lt;plugin interceptor=&quot;com.github.pagehelper.PageHelper&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dialect&quot; value=&quot;mysql&quot;/&gt;</span><br><span class="line">        &lt;!-- 该参数默认为false --&gt;</span><br><span class="line">        &lt;!-- 设置为true时，会将RowBounds第一个参数offset当成pageNum页码使用 --&gt;</span><br><span class="line">        &lt;!-- 和startPage中的pageNum效果一样--&gt;</span><br><span class="line">        &lt;property name=&quot;offsetAsPageNum&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 该参数默认为false --&gt;</span><br><span class="line">        &lt;!-- 设置为true时，使用RowBounds分页会进行count查询 --&gt;</span><br><span class="line">        &lt;property name=&quot;rowBoundsWithCount&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 设置为true时，如果pageSize=0或者RowBounds.limit = 0就会查询出全部的结果 --&gt;</span><br><span class="line">        &lt;!-- （相当于没有执行分页查询，但是返回结果仍然是Page类型）--&gt;</span><br><span class="line">        &lt;property name=&quot;pageSizeZero&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;!-- 3.3.0版本可用 - 分页参数合理化，默认false禁用 --&gt;</span><br><span class="line">        &lt;!-- 启用合理化时，如果pageNum&lt;1会查询第一页，如果pageNum&gt;pages会查询最后一页 --&gt;</span><br><span class="line">        &lt;!-- 禁用合理化时，如果pageNum&lt;1或pageNum&gt;pages会返回空数据 --&gt;</span><br><span class="line">        &lt;property name=&quot;reasonable&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">        &lt;!-- 3.5.0版本可用 - 为了支持startPage(Object params)方法 --&gt;</span><br><span class="line">        &lt;!-- 增加了一个`params`参数来配置参数映射，用于从Map或ServletRequest中取值 --&gt;</span><br><span class="line">        &lt;!-- 可以配置pageNum,pageSize,count,pageSizeZero,reasonable,不配置映射的用默认值 --&gt;</span><br><span class="line">        &lt;!-- 不理解该含义的前提下，不要随便复制该配置 --&gt;</span><br><span class="line">        &lt;property name=&quot;params&quot; value=&quot;pageNum=start;pageSize=limit;&quot;/&gt;</span><br><span class="line">        &lt;!-- always总是返回PageInfo类型,check检查返回类型是否为PageInfo,none返回Page --&gt;</span><br><span class="line">        &lt;property name=&quot;returnPageInfo&quot; value=&quot;check&quot;/&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure>
<h4 id="2、InterceptorChain的pluginAll方法"><a href="#2、InterceptorChain的pluginAll方法" class="headerlink" title="2、InterceptorChain的pluginAll方法"></a>2、InterceptorChain的pluginAll方法</h4><h5 id="上一篇中，Configuration的方法中newExecutor方法中调用了InterceptorChain的interceptorChain-pluginAll-executor-方法"><a href="#上一篇中，Configuration的方法中newExecutor方法中调用了InterceptorChain的interceptorChain-pluginAll-executor-方法" class="headerlink" title="上一篇中，Configuration的方法中newExecutor方法中调用了InterceptorChain的interceptorChain.pluginAll(executor)方法"></a>上一篇中，Configuration的方法中newExecutor方法中调用了InterceptorChain的interceptorChain.pluginAll(executor)方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Object pluginAll(Object target) &#123;</span><br><span class="line">    for (Interceptor interceptor : interceptors) &#123;</span><br><span class="line">        target = interceptor.plugin(target);</span><br><span class="line">    &#125;</span><br><span class="line">    return target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、PageHelper的plugin方法"><a href="#3、PageHelper的plugin方法" class="headerlink" title="3、PageHelper的plugin方法"></a>3、PageHelper的plugin方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Object plugin(Object target) &#123;</span><br><span class="line">    //传入对象是Executor，则用Plugin包装，否则返回原对象</span><br><span class="line">    if (target instanceof Executor) &#123;</span><br><span class="line">        return Plugin.wrap(target, this);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return target;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、Plugin的wrap方法"><a href="#4、Plugin的wrap方法" class="headerlink" title="4、Plugin的wrap方法"></a>4、Plugin的wrap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static Object wrap(Object target, Interceptor interceptor) &#123;</span><br><span class="line">    //过去，注解指定类及注解指定的类方法的Map</span><br><span class="line">    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = getSignatureMap(interceptor);</span><br><span class="line">    //Executor的类</span><br><span class="line">    Class&lt;?&gt; type = target.getClass();</span><br><span class="line">    Class&lt;?&gt;[] interfaces = getAllInterfaces(type, signatureMap);</span><br><span class="line">    if (interfaces.length &gt; 0) &#123;</span><br><span class="line">        //创建Executor的代理对象</span><br><span class="line">        return Proxy.newProxyInstance(</span><br><span class="line">          type.getClassLoader(),</span><br><span class="line">          interfaces,</span><br><span class="line">          //拦截器</span><br><span class="line">          new Plugin(target, interceptor, signatureMap));</span><br><span class="line">    &#125;</span><br><span class="line">    return target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、Plugin的getSignatureMap方法"><a href="#5、Plugin的getSignatureMap方法" class="headerlink" title="5、Plugin的getSignatureMap方法"></a>5、Plugin的getSignatureMap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private static Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; getSignatureMap(Interceptor interceptor) &#123;</span><br><span class="line">    //获取该类上的Intercepts注解</span><br><span class="line">    Intercepts interceptsAnnotation = interceptor.getClass().getAnnotation(Intercepts.class);</span><br><span class="line">    if (interceptsAnnotation == null) &#123; // issue #251</span><br><span class="line">        throw new PluginException(&quot;No @Intercepts annotation was found in interceptor &quot; + interceptor.getClass().getName());      </span><br><span class="line">    &#125;</span><br><span class="line">    //获取该注解值</span><br><span class="line">    Signature[] sigs = interceptsAnnotation.value();</span><br><span class="line">    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = new HashMap&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt;();</span><br><span class="line">    for (Signature sig : sigs) &#123;</span><br><span class="line">        //由注解指定的类，获取该类的被注解指定的方法</span><br><span class="line">        Set&lt;Method&gt; methods = signatureMap.get(sig.type());</span><br><span class="line">        if (methods == null) &#123;</span><br><span class="line">            methods = new HashSet&lt;Method&gt;();</span><br><span class="line">            //不存在，则添加进signatureMap</span><br><span class="line">            signatureMap.put(sig.type(), methods);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取注解指定类中的被注解指定方法</span><br><span class="line">            Method method = sig.type().getMethod(sig.method(), sig.args());</span><br><span class="line">            //添加进集合</span><br><span class="line">            methods.add(method);</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            throw new PluginException(&quot;Could not find method on &quot; + sig.type() + &quot; named &quot; + sig.method() + &quot;. Cause: &quot; + e, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return signatureMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（三、4）Plugin的invoke方法"><a href="#6、接（三、4）Plugin的invoke方法" class="headerlink" title="6、接（三、4）Plugin的invoke方法"></a>6、接（三、4）Plugin的invoke方法</h4><h5 id="返回的代理对象为Plugin"><a href="#返回的代理对象为Plugin" class="headerlink" title="返回的代理对象为Plugin"></a>返回的代理对象为Plugin</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取注解指定的方法</span><br><span class="line">        Set&lt;Method&gt; methods = signatureMap.get(method.getDeclaringClass());</span><br><span class="line">        if (methods != null &amp;&amp; methods.contains(method)) &#123;</span><br><span class="line">            //拦截注解指定的方法</span><br><span class="line">            return interceptor.intercept(new Invocation(target, method, args));</span><br><span class="line">        &#125;</span><br><span class="line">        //调用原对象的该方法</span><br><span class="line">        return method.invoke(target, args);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw ExceptionUtil.unwrapThrowable(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、PageHelper的intercept方法"><a href="#7、PageHelper的intercept方法" class="headerlink" title="7、PageHelper的intercept方法"></a>7、PageHelper的intercept方法</h4><h5 id="Executor的query方法会被PageHelper拦截"><a href="#Executor的query方法会被PageHelper拦截" class="headerlink" title="Executor的query方法会被PageHelper拦截"></a>Executor的query方法会被PageHelper拦截</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Object intercept(Invocation invocation) throws Throwable &#123;</span><br><span class="line">    //自动获取dialect，</span><br><span class="line">    if (autoDialect) &#123;</span><br><span class="line">        //初始化sqlUtil</span><br><span class="line">        initSqlUtil(invocation);</span><br><span class="line">    &#125;</span><br><span class="line">    return sqlUtil.processPage(invocation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、SqlUtil的processPage方法"><a href="#8、SqlUtil的processPage方法" class="headerlink" title="8、SqlUtil的processPage方法"></a>8、SqlUtil的processPage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Object processPage(Invocation invocation) throws Throwable &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Object result = _processPage(invocation);</span><br><span class="line">        return result;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        clearLocalPage();</span><br><span class="line">        OrderByHelper.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、SqlUtil的-processPage方法"><a href="#9、SqlUtil的-processPage方法" class="headerlink" title="9、SqlUtil的_processPage方法"></a>9、SqlUtil的_processPage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">private Object _processPage(Invocation invocation) throws Throwable &#123;</span><br><span class="line">    //获取参数</span><br><span class="line">    final Object[] args = invocation.getArgs();</span><br><span class="line">    //query方法的第三个参数是RowBounds</span><br><span class="line">    RowBounds rowBounds = (RowBounds) args[2];</span><br><span class="line">    if (SqlUtil.getLocalPage() == null &amp;&amp; rowBounds == RowBounds.DEFAULT) &#123;</span><br><span class="line">        //未设置查询数量限制，直接执行</span><br><span class="line">        //设置了排序</span><br><span class="line">        if (OrderByHelper.getOrderBy() != null) &#123;</span><br><span class="line">            //封装排序，返回OrderByDynamicSqlSource对象</span><br><span class="line">            OrderByHelper.processIntercept(invocation);</span><br><span class="line">        &#125;</span><br><span class="line">        //执行查询</span><br><span class="line">        return invocation.proceed();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //获取原始的ms</span><br><span class="line">        MappedStatement ms = (MappedStatement) args[0];</span><br><span class="line">        //判断并处理为PageSqlSource</span><br><span class="line">        if (!isPageSqlSource(ms)) &#123;</span><br><span class="line">            processMappedStatement(ms, parser);</span><br><span class="line">        &#125;</span><br><span class="line">        //忽略RowBounds-否则会进行Mybatis自带的内存分页</span><br><span class="line">        args[2] = RowBounds.DEFAULT;</span><br><span class="line">        //获取分页信息</span><br><span class="line">        Page page = getPage(rowBounds);</span><br><span class="line">        //pageSizeZero的判断</span><br><span class="line">        if ((page.getPageSizeZero() != null &amp;&amp; page.getPageSizeZero()) &amp;&amp; page.getPageSize() == 0) &#123;</span><br><span class="line">            COUNT.set(null);</span><br><span class="line">            //执行正常（不分页）查询</span><br><span class="line">            Object result = invocation.proceed();</span><br><span class="line">            //得到处理结果</span><br><span class="line">            page.addAll((List) result);</span><br><span class="line">            //相当于查询第一页</span><br><span class="line">            page.setPageNum(1);</span><br><span class="line">            //这种情况相当于pageSize=total</span><br><span class="line">            page.setPageSize(page.size());</span><br><span class="line">            //仍然要设置total</span><br><span class="line">            page.setTotal(page.size());</span><br><span class="line">            //返回结果仍然为Page类型 - 便于后面对接收类型的统一处理</span><br><span class="line">            return page;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //简单的通过total的值来判断是否进行count查询，total默认等于1</span><br><span class="line">        if (page.isCount()) &#123;</span><br><span class="line">            COUNT.set(Boolean.TRUE);</span><br><span class="line">            //替换MS</span><br><span class="line">            args[0] = msCountMap.get(ms.getId());</span><br><span class="line">            //查询总数</span><br><span class="line">            Object result = invocation.proceed();</span><br><span class="line">            //还原ms</span><br><span class="line">            args[0] = ms;</span><br><span class="line">            //设置总数</span><br><span class="line">            page.setTotal((Integer) ((List) result).get(0));</span><br><span class="line">            if (page.getTotal() == 0) &#123;</span><br><span class="line">                return page;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //pageSize&gt;0的时候执行分页查询，pageSize&lt;=0的时候不执行相当于可能只返回了一个count</span><br><span class="line">        if (page.getPageSize() &gt; 0 &amp;&amp;</span><br><span class="line">                ((rowBounds == RowBounds.DEFAULT &amp;&amp; page.getPageNum() &gt; 0)</span><br><span class="line">                        || rowBounds != RowBounds.DEFAULT)) &#123;</span><br><span class="line">            //将参数中的MappedStatement替换为新的qs</span><br><span class="line">            COUNT.set(null);</span><br><span class="line">            BoundSql boundSql = ms.getBoundSql(args[1]);</span><br><span class="line">            args[1] = parser.setPageParameter(ms, args[1], boundSql, page);</span><br><span class="line">            COUNT.set(Boolean.FALSE);</span><br><span class="line">            //执行分页查询</span><br><span class="line">            Object result = invocation.proceed();</span><br><span class="line">            //得到处理结果</span><br><span class="line">            page.addAll((List) result);</span><br><span class="line">        &#125;</span><br><span class="line">        //返回结果</span><br><span class="line">        return page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、SqlUtil的processMappedStatement方法"><a href="#10、SqlUtil的processMappedStatement方法" class="headerlink" title="10、SqlUtil的processMappedStatement方法"></a>10、SqlUtil的processMappedStatement方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public static void processMappedStatement(MappedStatement ms, Parser parser) throws Throwable &#123;</span><br><span class="line">    SqlSource sqlSource = ms.getSqlSource();</span><br><span class="line">    MetaObject msObject = SystemMetaObject.forObject(ms);</span><br><span class="line">    SqlSource tempSqlSource = sqlSource;</span><br><span class="line">    if (sqlSource instanceof OrderBySqlSource) &#123;</span><br><span class="line">        tempSqlSource = ((OrderBySqlSource) tempSqlSource).getOriginal();</span><br><span class="line">    &#125;</span><br><span class="line">    SqlSource pageSqlSource;</span><br><span class="line">    if (tempSqlSource instanceof StaticSqlSource) &#123;</span><br><span class="line">        pageSqlSource = new PageStaticSqlSource((StaticSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else if (tempSqlSource instanceof RawSqlSource) &#123;</span><br><span class="line">        pageSqlSource = new PageRawSqlSource((RawSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else if (tempSqlSource instanceof ProviderSqlSource) &#123;</span><br><span class="line">        pageSqlSource = new PageProviderSqlSource((ProviderSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else if (tempSqlSource instanceof DynamicSqlSource) &#123;</span><br><span class="line">        //默认DynamicSqlSource</span><br><span class="line">        pageSqlSource = new PageDynamicSqlSource((DynamicSqlSource) tempSqlSource, parser);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        throw new RuntimeException(&quot;无法处理该类型[&quot; + sqlSource.getClass() + &quot;]的SqlSource&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //替换原来的sqlSource</span><br><span class="line">    msObject.setValue(&quot;sqlSource&quot;, pageSqlSource);</span><br><span class="line">    //由于count查询需要修改返回值，因此这里要创建一个Count查询的MS</span><br><span class="line">    msCountMap.put(ms.getId(), MSUtils.newCountMappedStatement(ms));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、接（三、9）SqlUtil的getPage方法"><a href="#11、接（三、9）SqlUtil的getPage方法" class="headerlink" title="11、接（三、9）SqlUtil的getPage方法"></a>11、接（三、9）SqlUtil的getPage方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public Page getPage(Object params) &#123;</span><br><span class="line">    //获取本线程对应的page</span><br><span class="line">    Page page = getLocalPage();</span><br><span class="line">    //未设置page尝试从查询方法参数RowBounds中获取分页信息</span><br><span class="line">    if (page == null) &#123;</span><br><span class="line">        if (params instanceof RowBounds) &#123;</span><br><span class="line">            RowBounds rowBounds = (RowBounds) params;</span><br><span class="line">            if (offsetAsPageNum) &#123;</span><br><span class="line">                page = new Page(rowBounds.getOffset(), rowBounds.getLimit(), rowBoundsWithCount);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                page = new Page(rowBounds, rowBoundsWithCount);</span><br><span class="line">                //offsetAsPageNum=false的时候，由于PageNum问题，不能使用reasonable，这里会强制为false</span><br><span class="line">                page.setReasonable(false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            page = getPageFromObject(params);</span><br><span class="line">        &#125;</span><br><span class="line">        setLocalPage(page);</span><br><span class="line">    &#125;</span><br><span class="line">    //分页合理化</span><br><span class="line">    if (page.getReasonable() == null) &#123;</span><br><span class="line">        page.setReasonable(reasonable);</span><br><span class="line">    &#125;</span><br><span class="line">    //当设置为true的时候，如果pagesize设置为0（或RowBounds的limit=0），就不执行分页，返回全部结果</span><br><span class="line">    if (page.getPageSizeZero() == null) &#123;</span><br><span class="line">        page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    &#125;</span><br><span class="line">    return page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（三、9）MysqlParser的setPageParameter方法"><a href="#12、接（三、9）MysqlParser的setPageParameter方法" class="headerlink" title="12、接（三、9）MysqlParser的setPageParameter方法"></a>12、接（三、9）MysqlParser的setPageParameter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Map setPageParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql, Page page) &#123;</span><br><span class="line">    Map paramMap = super.setPageParameter(ms, parameterObject, boundSql, page);</span><br><span class="line">    paramMap.put(PAGEPARAMETER_FIRST, page.getStartRow());</span><br><span class="line">    paramMap.put(PAGEPARAMETER_SECOND, page.getPageSize());</span><br><span class="line">    return paramMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="MysqlParser父类AbstractParser的setPageParameter方法"><a href="#MysqlParser父类AbstractParser的setPageParameter方法" class="headerlink" title="MysqlParser父类AbstractParser的setPageParameter方法"></a>MysqlParser父类AbstractParser的setPageParameter方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Map setPageParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql, Page page) &#123;</span><br><span class="line">    return processParameter(ms, parameterObject, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、MysqlParser的processParameter方法"><a href="#13、MysqlParser的processParameter方法" class="headerlink" title="13、MysqlParser的processParameter方法"></a>13、MysqlParser的processParameter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public static Map&lt;String, Object&gt; processParameter(MappedStatement ms, Object parameterObject, BoundSql boundSql) &#123;</span><br><span class="line">    Map paramMap = null;</span><br><span class="line">    if (parameterObject == null) &#123;</span><br><span class="line">        paramMap = new HashMap();</span><br><span class="line">    &#125; else if (parameterObject instanceof Map) &#123;</span><br><span class="line">        //解决不可变Map的情况</span><br><span class="line">        paramMap = new HashMap();</span><br><span class="line">        paramMap.putAll((Map) parameterObject);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        paramMap = new HashMap();</span><br><span class="line">        //动态sql时的判断条件不会出现在ParameterMapping中，但是必须有，所以这里需要收集所有的getter属性</span><br><span class="line">        //TypeHandlerRegistry可以直接处理的会作为一个直接使用的对象进行处理</span><br><span class="line">        boolean hasTypeHandler = ms.getConfiguration().getTypeHandlerRegistry().hasTypeHandler(parameterObject.getClass());</span><br><span class="line">        MetaObject metaObject = SystemMetaObject.forObject(parameterObject);</span><br><span class="line">        //需要针对注解形式的MyProviderSqlSource保存原值</span><br><span class="line">        if (ms.getSqlSource() instanceof PageProviderSqlSource) &#123;</span><br><span class="line">            paramMap.put(PROVIDER_OBJECT, parameterObject);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!hasTypeHandler) &#123;</span><br><span class="line">            for (String name : metaObject.getGetterNames()) &#123;</span><br><span class="line">                paramMap.put(name, metaObject.getValue(name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //下面这段方法，主要解决一个常见类型的参数时的问题</span><br><span class="line">        if (boundSql.getParameterMappings() != null &amp;&amp; boundSql.getParameterMappings().size() &gt; 0) &#123;</span><br><span class="line">            for (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;</span><br><span class="line">                String name = parameterMapping.getProperty();</span><br><span class="line">                if (!name.equals(PAGEPARAMETER_FIRST)</span><br><span class="line">                        &amp;&amp; !name.equals(PAGEPARAMETER_SECOND)</span><br><span class="line">                        &amp;&amp; paramMap.get(name) == null) &#123;</span><br><span class="line">                    if (hasTypeHandler</span><br><span class="line">                            || parameterMapping.getJavaType().equals(parameterObject.getClass())) &#123;</span><br><span class="line">                        paramMap.put(name, parameterObject);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //备份原始参数对象</span><br><span class="line">    paramMap.put(ORIGINAL_PARAMETER_OBJECT, parameterObject);</span><br><span class="line">    return paramMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、PageSqlSource的getBoundSql方法"><a href="#14、PageSqlSource的getBoundSql方法" class="headerlink" title="14、PageSqlSource的getBoundSql方法"></a>14、PageSqlSource的getBoundSql方法</h4><h5 id="Invocation的proceed方法，实际是调用了被代理对象的query方法，与之前相同的方法略过"><a href="#Invocation的proceed方法，实际是调用了被代理对象的query方法，与之前相同的方法略过" class="headerlink" title="Invocation的proceed方法，实际是调用了被代理对象的query方法，与之前相同的方法略过"></a>Invocation的proceed方法，实际是调用了被代理对象的query方法，与之前相同的方法略过</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BoundSql getBoundSql(Object parameterObject) &#123;</span><br><span class="line">    Boolean count = getCount();</span><br><span class="line">    if(count == null)&#123;</span><br><span class="line">        //原始的sql</span><br><span class="line">        return getDefaultBoundSql(parameterObject);</span><br><span class="line">    &#125; else if(count)&#123;</span><br><span class="line">        //统计sql</span><br><span class="line">        return getCountBoundSql(parameterObject);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //分页sql</span><br><span class="line">        return getPageBoundSql(parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、PageDynamicSqlSource的getCountBoundSql方法"><a href="#15、PageDynamicSqlSource的getCountBoundSql方法" class="headerlink" title="15、PageDynamicSqlSource的getCountBoundSql方法"></a>15、PageDynamicSqlSource的getCountBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected BoundSql getCountBoundSql(Object parameterObject) &#123;</span><br><span class="line">    DynamicContext context = new DynamicContext(configuration, parameterObject);</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration);</span><br><span class="line">    Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass();</span><br><span class="line">    SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">    BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //sql修改为查询总量sql，AbstractParser.getCountSql方法</span><br><span class="line">    sqlSource = new StaticSqlSource(configuration, parser.getCountSql(boundSql.getSql()), boundSql.getParameterMappings());</span><br><span class="line">    boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //设置条件参数</span><br><span class="line">    for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">        boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法"><a href="#16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法" class="headerlink" title="16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法"></a>16、接（三、14）PageDynamicSqlSource的getPageBoundSql方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected BoundSql getPageBoundSql(Object parameterObject) &#123;</span><br><span class="line">    DynamicContext context;</span><br><span class="line">    //由于增加分页参数后会修改parameterObject的值，因此在前面处理时备份该值</span><br><span class="line">    //如果发现参数是Map并且包含该KEY，就使用备份的该值</span><br><span class="line">    //解决bug#25:http://git.oschina.net/free/Mybatis_PageHelper/issues/25</span><br><span class="line">    if (parameterObject != null</span><br><span class="line">            &amp;&amp; parameterObject instanceof Map</span><br><span class="line">            &amp;&amp; ((Map) parameterObject).containsKey(ORIGINAL_PARAMETER_OBJECT)) &#123;</span><br><span class="line">        context = new DynamicContext(configuration, ((Map) parameterObject).get(ORIGINAL_PARAMETER_OBJECT));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        context = new DynamicContext(configuration, parameterObject);</span><br><span class="line">    &#125;</span><br><span class="line">    rootSqlNode.apply(context);</span><br><span class="line">    SqlSourceBuilder sqlSourceParser = new SqlSourceBuilder(configuration);</span><br><span class="line">    Class&lt;?&gt; parameterType = parameterObject == null ? Object.class : parameterObject.getClass();</span><br><span class="line">    SqlSource sqlSource = sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());</span><br><span class="line">    sqlSource = new OrderByStaticSqlSource((StaticSqlSource) sqlSource);</span><br><span class="line">    BoundSql boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //sql修改为查询总量sql，AbstractParser.getPageSql方法</span><br><span class="line">    sqlSource = new StaticSqlSource(configuration, parser.getPageSql(boundSql.getSql()), parser.getPageParameterMapping(configuration, boundSql));</span><br><span class="line">    boundSql = sqlSource.getBoundSql(parameterObject);</span><br><span class="line">    //设置条件参数</span><br><span class="line">    for (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;</span><br><span class="line">        boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    return boundSql;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、PageHelper的startPage方法"><a href="#17、PageHelper的startPage方法" class="headerlink" title="17、PageHelper的startPage方法"></a>17、PageHelper的startPage方法</h4><h5 id="PageHelper的startPage方法设置本线程下次查询的参数"><a href="#PageHelper的startPage方法设置本线程下次查询的参数" class="headerlink" title="PageHelper的startPage方法设置本线程下次查询的参数"></a>PageHelper的startPage方法设置本线程下次查询的参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize) &#123;</span><br><span class="line">    return startPage(pageNum, pageSize, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize, boolean count) &#123;</span><br><span class="line">    return startPage(pageNum, pageSize, count, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize, boolean count, Boolean reasonable) &#123;</span><br><span class="line">    return startPage(pageNum, pageSize, count, reasonable, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static Page startPage(int pageNum, int pageSize, boolean count, Boolean reasonable, Boolean pageSizeZero) &#123;</span><br><span class="line">    Page page = new Page(pageNum, pageSize, count);</span><br><span class="line">    page.setReasonable(reasonable);</span><br><span class="line">    page.setPageSizeZero(pageSizeZero);</span><br><span class="line">    SqlUtil.setLocalPage(page);</span><br><span class="line">    return page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、SqlUtil的setLocalPage方法"><a href="#18、SqlUtil的setLocalPage方法" class="headerlink" title="18、SqlUtil的setLocalPage方法"></a>18、SqlUtil的setLocalPage方法</h4><h5 id="LOCAL-PAGE是一个线程局部变量"><a href="#LOCAL-PAGE是一个线程局部变量" class="headerlink" title="LOCAL_PAGE是一个线程局部变量"></a>LOCAL_PAGE是一个线程局部变量</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final ThreadLocal&lt;Page&gt; LOCAL_PAGE = new ThreadLocal&lt;Page&gt;();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void setLocalPage(Page page) &#123;</span><br><span class="line">    //将page添加进线程局部变量</span><br><span class="line">    LOCAL_PAGE.set(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、元对象MetaObject"><a href="#四、元对象MetaObject" class="headerlink" title="四、元对象MetaObject"></a>四、元对象MetaObject</h3><h4 id="1、Configuration的newMetaObject方法"><a href="#1、Configuration的newMetaObject方法" class="headerlink" title="1、Configuration的newMetaObject方法"></a>1、Configuration的newMetaObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public MetaObject newMetaObject(Object object) &#123;</span><br><span class="line">    return MetaObject.forObject(object, objectFactory, objectWrapperFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、MetaObject的forObject方法"><a href="#2、MetaObject的forObject方法" class="headerlink" title="2、MetaObject的forObject方法"></a>2、MetaObject的forObject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static MetaObject forObject(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory) &#123;</span><br><span class="line">    if (object == null) &#123;</span><br><span class="line">        return SystemMetaObject.NULL_META_OBJECT;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return new MetaObject(object, objectFactory, objectWrapperFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、实例化MetaObject"><a href="#3、实例化MetaObject" class="headerlink" title="3、实例化MetaObject"></a>3、实例化MetaObject</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private MetaObject(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory) &#123;</span><br><span class="line">    this.originalObject = object;</span><br><span class="line">    this.objectFactory = objectFactory;</span><br><span class="line">    this.objectWrapperFactory = objectWrapperFactory;</span><br><span class="line"></span><br><span class="line">    if (object instanceof ObjectWrapper) &#123;</span><br><span class="line">        this.objectWrapper = (ObjectWrapper) object;</span><br><span class="line">    &#125; else if (objectWrapperFactory.hasWrapperFor(object)) &#123;</span><br><span class="line">        this.objectWrapper = objectWrapperFactory.getWrapperFor(this, object);</span><br><span class="line">    &#125; else if (object instanceof Map) &#123;</span><br><span class="line">        this.objectWrapper = new MapWrapper(this, (Map) object);</span><br><span class="line">    &#125; else if (object instanceof Collection) &#123;</span><br><span class="line">        this.objectWrapper = new CollectionWrapper(this, (Collection) object);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //本例以object为bean</span><br><span class="line">        this.objectWrapper = new BeanWrapper(this, object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、实例化BeanWrapper"><a href="#3、实例化BeanWrapper" class="headerlink" title="3、实例化BeanWrapper"></a>3、实例化BeanWrapper</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public BeanWrapper(MetaObject metaObject, Object object) &#123;</span><br><span class="line">    super(metaObject);</span><br><span class="line">    this.object = object;</span><br><span class="line">    this.metaClass = MetaClass.forClass(object.getClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、MetaObject的hasSetter方法"><a href="#4、MetaObject的hasSetter方法" class="headerlink" title="4、MetaObject的hasSetter方法"></a>4、MetaObject的hasSetter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasSetter(String name) &#123;</span><br><span class="line">    return objectWrapper.hasSetter(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、BeanWrapper的hasSetter方法"><a href="#5、BeanWrapper的hasSetter方法" class="headerlink" title="5、BeanWrapper的hasSetter方法"></a>5、BeanWrapper的hasSetter方法</h4><h5 id="name为bean的属性，通常为name或user-name"><a href="#name为bean的属性，通常为name或user-name" class="headerlink" title="name为bean的属性，通常为name或user.name"></a>name为bean的属性，通常为name或user.name</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public boolean hasSetter(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = new PropertyTokenizer(name);</span><br><span class="line">    if (prop.hasNext()) &#123;</span><br><span class="line">        //name包含小数点，说明bean A的属性为另一个bean B</span><br><span class="line">        //检验bean A是否有bean B的set方法</span><br><span class="line">        if (metaClass.hasSetter(prop.getIndexedName())) &#123;</span><br><span class="line">            //获取bean B的MetaObject封装对象</span><br><span class="line">            MetaObject metaValue = metaObject.metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">            if (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;</span><br><span class="line">                return metaClass.hasSetter(name);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //检查bean B是否有该属性的set方法</span><br><span class="line">                return metaValue.hasSetter(prop.getChildren());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return metaClass.hasSetter(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、MetaObject的metaObjectForProperty方法"><a href="#6、MetaObject的metaObjectForProperty方法" class="headerlink" title="6、MetaObject的metaObjectForProperty方法"></a>6、MetaObject的metaObjectForProperty方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public MetaObject metaObjectForProperty(String name) &#123;</span><br><span class="line">    //获取name对象</span><br><span class="line">    Object value = getValue(name);</span><br><span class="line">    //MetaObject封装该对象</span><br><span class="line">    return MetaObject.forObject(value, objectFactory, objectWrapperFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、MetaObject的getValue方法"><a href="#7、MetaObject的getValue方法" class="headerlink" title="7、MetaObject的getValue方法"></a>7、MetaObject的getValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public Object getValue(String name) &#123;</span><br><span class="line">    PropertyTokenizer prop = new PropertyTokenizer(name);</span><br><span class="line">    //判断是否有第三层，有则递归调用</span><br><span class="line">    if (prop.hasNext()) &#123;</span><br><span class="line">            MetaObject metaValue = metaObjectForProperty(prop.getIndexedName());</span><br><span class="line">        if (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return metaValue.getValue(prop.getChildren());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //获取该对象</span><br><span class="line">        return objectWrapper.get(prop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/klugjo/hexo-theme-clean-blog" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>