<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>zookeeper源码分布式服务端（1） | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="zookeeper源码分布服务端（1） 服务端启动过程一、LEADER选举过程1、QuorumPeerMain的runFromConfig方法分布式zookeeper启动入口为QuorumPeerMain的main方法，之后调用了runFromConfig方法1234567891011121314151617181920212223242526272829303132333435363738394">
<meta property="og:type" content="article">
<meta property="og:title" content="zookeeper源码分布式服务端（1）">
<meta property="og:url" content="http://yoursite.com/2018/04/07/zookeeper源码/zookeeper源码分布式服务端（1）/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="zookeeper源码分布服务端（1） 服务端启动过程一、LEADER选举过程1、QuorumPeerMain的runFromConfig方法分布式zookeeper启动入口为QuorumPeerMain的main方法，之后调用了runFromConfig方法1234567891011121314151617181920212223242526272829303132333435363738394">
<meta property="og:updated_time" content="2018-04-07T05:22:15.800Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zookeeper源码分布式服务端（1）">
<meta name="twitter:description" content="zookeeper源码分布服务端（1） 服务端启动过程一、LEADER选举过程1、QuorumPeerMain的runFromConfig方法分布式zookeeper启动入口为QuorumPeerMain的main方法，之后调用了runFromConfig方法1234567891011121314151617181920212223242526272829303132333435363738394">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-zookeeper源码/zookeeper源码分布式服务端（1）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/07/zookeeper源码/zookeeper源码分布式服务端（1）/" class="article-date">
  <time datetime="2018-04-07T04:44:43.467Z" itemprop="datePublished">2018-04-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/zookeeper/">zookeeper</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      zookeeper源码分布式服务端（1）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="zookeeper源码分布服务端（1）-服务端启动过程"><a href="#zookeeper源码分布服务端（1）-服务端启动过程" class="headerlink" title="zookeeper源码分布服务端（1） 服务端启动过程"></a>zookeeper源码分布服务端（1） 服务端启动过程</h2><h3 id="一、LEADER选举过程"><a href="#一、LEADER选举过程" class="headerlink" title="一、LEADER选举过程"></a>一、LEADER选举过程</h3><h4 id="1、QuorumPeerMain的runFromConfig方法"><a href="#1、QuorumPeerMain的runFromConfig方法" class="headerlink" title="1、QuorumPeerMain的runFromConfig方法"></a>1、QuorumPeerMain的runFromConfig方法</h4><p>分布式zookeeper启动入口为QuorumPeerMain的main方法，之后调用了runFromConfig方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">public void runFromConfig(QuorumPeerConfig config)</span><br><span class="line">        throws IOException, AdminServerException</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  try &#123;</span><br><span class="line">      ServerCnxnFactory cnxnFactory = null;</span><br><span class="line">      ServerCnxnFactory secureCnxnFactory = null;</span><br><span class="line">      //创建连接工厂与单机版相同</span><br><span class="line">      if (config.getClientPortAddress() != null) &#123;</span><br><span class="line">          cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">          cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                  config.getMaxClientCnxns(),</span><br><span class="line">                  false);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (config.getSecureClientPortAddress() != null) &#123;</span><br><span class="line">          secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">          secureCnxnFactory.configure(config.getSecureClientPortAddress(),</span><br><span class="line">                  config.getMaxClientCnxns(),</span><br><span class="line">                  true);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      quorumPeer = getQuorumPeer();</span><br><span class="line">      //设置日志及快照文件</span><br><span class="line">      quorumPeer.setTxnFactory(new FileTxnSnapLog(</span><br><span class="line">                  config.getDataLogDir(),</span><br><span class="line">                  config.getDataDir()));</span><br><span class="line">      quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span><br><span class="line">      quorumPeer.enableLocalSessionsUpgrading(</span><br><span class="line">          config.isLocalSessionsUpgradingEnabled());</span><br><span class="line">      //集群机器地址</span><br><span class="line">      quorumPeer.setQuorumPeers(config.getAllMembers());</span><br><span class="line">      //leader选择器类型</span><br><span class="line">      quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">      //本机的集群编号</span><br><span class="line">      quorumPeer.setMyid(config.getServerId());</span><br><span class="line">      //服务器单位时间</span><br><span class="line">      quorumPeer.setTickTime(config.getTickTime());</span><br><span class="line">      quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());</span><br><span class="line">      quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());</span><br><span class="line">      //LF初始通信时限</span><br><span class="line">      quorumPeer.setInitLimit(config.getInitLimit());</span><br><span class="line">      //LF同步通信时限</span><br><span class="line">      quorumPeer.setSyncLimit(config.getSyncLimit());</span><br><span class="line">      quorumPeer.setConfigFileName(config.getConfigFilename());</span><br><span class="line">      //内存数据</span><br><span class="line">      quorumPeer.setZKDatabase(new ZKDatabase(quorumPeer.getTxnFactory()));</span><br><span class="line">      //投票决定方式，默认超过半数就通过  </span><br><span class="line">      quorumPeer.setQuorumVerifier(config.getQuorumVerifier(), false);</span><br><span class="line">      if (config.getLastSeenQuorumVerifier()!=null) &#123;</span><br><span class="line">          quorumPeer.setLastSeenQuorumVerifier(config.getLastSeenQuorumVerifier(), false);</span><br><span class="line">      &#125;</span><br><span class="line">      quorumPeer.initConfigInZKDatabase();</span><br><span class="line">      //设置连接工厂</span><br><span class="line">      quorumPeer.setCnxnFactory(cnxnFactory);</span><br><span class="line">      quorumPeer.setSecureCnxnFactory(secureCnxnFactory);</span><br><span class="line">      quorumPeer.setLearnerType(config.getPeerType());</span><br><span class="line">      quorumPeer.setSyncEnabled(config.getSyncEnabled());</span><br><span class="line">      quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());</span><br><span class="line"></span><br><span class="line">      // sets quorum sasl authentication configurations</span><br><span class="line">      quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);</span><br><span class="line">      if(quorumPeer.isQuorumSaslAuthEnabled())&#123;</span><br><span class="line">          quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);</span><br><span class="line">          quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);</span><br><span class="line">          quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);</span><br><span class="line">          quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);</span><br><span class="line">          quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);</span><br><span class="line">      &#125;</span><br><span class="line">      quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);</span><br><span class="line">      quorumPeer.initialize();</span><br><span class="line">      //启动主线程 </span><br><span class="line">      quorumPeer.start();</span><br><span class="line">      quorumPeer.join();</span><br><span class="line">  &#125; catch (InterruptedException e) &#123;</span><br><span class="line">      // warn, but generally this is ok</span><br><span class="line">      LOG.warn(&quot;Quorum Peer interrupted&quot;, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、QuorumPeer的start方法"><a href="#2、QuorumPeer的start方法" class="headerlink" title="2、QuorumPeer的start方法"></a>2、QuorumPeer的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public synchronized void start() &#123;</span><br><span class="line">    if (!getView().containsKey(myid)) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;My id &quot; + myid + &quot; not in the peer list&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //恢复本机数据</span><br><span class="line">    loadDataBase();</span><br><span class="line">    //启动连接工厂</span><br><span class="line">    startServerCnxnFactory();</span><br><span class="line">    try &#123;</span><br><span class="line">        //内嵌的管理控制台是通过jetty启动,占用8080 端口</span><br><span class="line">        adminServer.start();</span><br><span class="line">    &#125; catch (AdminServerException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    //开始投票</span><br><span class="line">    startLeaderElection();</span><br><span class="line">    //主流程</span><br><span class="line">    super.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、QuorumPeer的startLeaderElection方法"><a href="#3、QuorumPeer的startLeaderElection方法" class="headerlink" title="3、QuorumPeer的startLeaderElection方法"></a>3、QuorumPeer的startLeaderElection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">synchronized public void startLeaderElection() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (getPeerState() == ServerState.LOOKING) &#123;</span><br><span class="line">            //首次投票给自己</span><br><span class="line">            currentVote = new Vote(myid, getLastLoggedZxid(), getCurrentEpoch());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch(IOException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">        throw re;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建选举器</span><br><span class="line">    this.electionAlg = createElectionAlgorithm(electionType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、QuorumPeer的createElectionAlgorithm方法"><a href="#4、QuorumPeer的createElectionAlgorithm方法" class="headerlink" title="4、QuorumPeer的createElectionAlgorithm方法"></a>4、QuorumPeer的createElectionAlgorithm方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> protected Election createElectionAlgorithm(int electionAlgorithm)&#123;</span><br><span class="line">    Election le=null;</span><br><span class="line">    //TODO: use a factory rather than a switch</span><br><span class="line">    switch (electionAlgorithm) &#123;</span><br><span class="line">    case 1:</span><br><span class="line">        le = new AuthFastLeaderElection(this);</span><br><span class="line">        break;</span><br><span class="line">    case 2:</span><br><span class="line">        le = new AuthFastLeaderElection(this, true);</span><br><span class="line">        break;</span><br><span class="line">    case 3:</span><br><span class="line">        //leader选举通信管理类</span><br><span class="line">        qcm = createCnxnManager();</span><br><span class="line">        QuorumCnxManager.Listener listener = qcm.listener;</span><br><span class="line">        if(listener != null)&#123;</span><br><span class="line">            //启动已绑定3888端口的选举线程，等待集群其他机器连接</span><br><span class="line">            listener.start();</span><br><span class="line">            //基于TCP的选举算法</span><br><span class="line">            FastLeaderElection fle = new FastLeaderElection(this, qcm);</span><br><span class="line">            fle.start();</span><br><span class="line">            le = fle;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            LOG.error(&quot;Null listener when initializing cnx manager&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        assert false;</span><br><span class="line">    &#125;</span><br><span class="line">    return le;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、实例化QuorumCnxManager"><a href="#5、实例化QuorumCnxManager" class="headerlink" title="5、实例化QuorumCnxManager"></a>5、实例化QuorumCnxManager</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public QuorumCnxManager(QuorumPeer self,</span><br><span class="line">                        final long mySid,</span><br><span class="line">                        Map&lt;Long,QuorumPeer.QuorumServer&gt; view,</span><br><span class="line">                        QuorumAuthServer authServer,</span><br><span class="line">                        QuorumAuthLearner authLearner,</span><br><span class="line">                        int socketTimeout,</span><br><span class="line">                        boolean listenOnAllIPs,</span><br><span class="line">                        int quorumCnxnThreadsSize,</span><br><span class="line">                        boolean quorumSaslAuthEnabled) &#123;</span><br><span class="line">    //接收到的投票消息队列</span><br><span class="line">    this.recvQueue = new ArrayBlockingQueue&lt;Message&gt;(RECV_CAPACITY);</span><br><span class="line">    //往其他服务器待发送消息队列</span><br><span class="line">    this.queueSendMap = new ConcurrentHashMap&lt;Long, ArrayBlockingQueue&lt;ByteBuffer&gt;&gt;();</span><br><span class="line">    //往其他服务器发送消息线程</span><br><span class="line">    this.senderWorkerMap = new ConcurrentHashMap&lt;Long, SendWorker&gt;();</span><br><span class="line">    //往其他服务器发送的最新消息</span><br><span class="line">    this.lastMessageSent = new ConcurrentHashMap&lt;Long, ByteBuffer&gt;();</span><br><span class="line">    </span><br><span class="line">    String cnxToValue = System.getProperty(&quot;zookeeper.cnxTimeout&quot;);</span><br><span class="line">    if(cnxToValue != null)&#123;</span><br><span class="line">        this.cnxTO = Integer.parseInt(cnxToValue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    this.self = self;</span><br><span class="line"></span><br><span class="line">    this.mySid = mySid;</span><br><span class="line">    this.socketTimeout = socketTimeout;</span><br><span class="line">    this.view = view;</span><br><span class="line">    //各服务器ip</span><br><span class="line">    this.listenOnAllIPs = listenOnAllIPs;</span><br><span class="line"></span><br><span class="line">    initializeAuth(mySid, authServer, authLearner, quorumCnxnThreadsSize,</span><br><span class="line">            quorumSaslAuthEnabled);</span><br><span class="line"></span><br><span class="line">    //等待其他服务器连接的线程</span><br><span class="line">    listener = new Listener();</span><br><span class="line">    listener.setName(&quot;QuorumPeerListener&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（一、4）Listener的run方法"><a href="#6、接（一、4）Listener的run方法" class="headerlink" title="6、接（一、4）Listener的run方法"></a>6、接（一、4）Listener的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    //重连次数</span><br><span class="line">    int numRetries = 0;</span><br><span class="line">    InetSocketAddress addr;</span><br><span class="line">    Socket client = null;</span><br><span class="line">    while((!shutdown) &amp;&amp; (numRetries &lt; 3))&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //启动Socket服务端</span><br><span class="line">            ss = new ServerSocket();</span><br><span class="line">            ss.setReuseAddress(true);</span><br><span class="line">            if (self.getQuorumListenOnAllIPs()) &#123;</span><br><span class="line">                int port = self.getElectionAddress().getPort();</span><br><span class="line">                addr = new InetSocketAddress(port);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // Resolve hostname for this server in case the</span><br><span class="line">                // underlying ip address has changed.</span><br><span class="line">                self.recreateSocketAddresses(self.getId());</span><br><span class="line">                addr = self.getElectionAddress();</span><br><span class="line">            &#125;</span><br><span class="line">            setName(addr.toString());</span><br><span class="line">            ss.bind(addr);</span><br><span class="line">            while (!shutdown) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    client = ss.accept();</span><br><span class="line">                    setSockOpts(client);</span><br><span class="line">                    LOG.info(&quot;Received connection request &quot;</span><br><span class="line">                             + client.getRemoteSocketAddress());</span><br><span class="line">                    if (quorumSaslAuthEnabled) &#123;</span><br><span class="line">                        receiveConnectionAsync(client);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        //处理接收到的连接</span><br><span class="line">                        receiveConnection(client);</span><br><span class="line">                    &#125;</span><br><span class="line">                    numRetries = 0;</span><br><span class="line">                &#125; catch (SocketTimeoutException e) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            if (shutdown) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            numRetries++;</span><br><span class="line">            try &#123;</span><br><span class="line">                ss.close();</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">            &#125; catch </span><br><span class="line">            ...</span><br><span class="line">            closeSocket(client);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、Listener的receiveConnection方法"><a href="#7、Listener的receiveConnection方法" class="headerlink" title="7、Listener的receiveConnection方法"></a>7、Listener的receiveConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void receiveConnection(final Socket sock) &#123;</span><br><span class="line">    DataInputStream din = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        din = new DataInputStream(</span><br><span class="line">                new BufferedInputStream(sock.getInputStream()));</span><br><span class="line">        //处理收到连接的数据</span><br><span class="line">        handleConnection(sock, din);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、Listener的handleConnection方法"><a href="#8、Listener的handleConnection方法" class="headerlink" title="8、Listener的handleConnection方法"></a>8、Listener的handleConnection方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">private void handleConnection(Socket sock, DataInputStream din)</span><br><span class="line">        throws IOException &#123;</span><br><span class="line">    Long sid = null, protocolVersion = null;</span><br><span class="line">    InetSocketAddress electionAddr = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //协议版本号</span><br><span class="line">        protocolVersion = din.readLong();</span><br><span class="line">        if (protocolVersion &gt;= 0) &#123; // this is a server id and not a protocol version</span><br><span class="line">            sid = protocolVersion;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                InitialMessage init = InitialMessage.parse(protocolVersion, din);</span><br><span class="line">                sid = init.sid;</span><br><span class="line">                //连接地址</span><br><span class="line">                electionAddr = init.electionAddr;</span><br><span class="line">            &#125; catch (InitialMessage.InitialMessageException ex) &#123;</span><br><span class="line">                LOG.error(ex.toString());</span><br><span class="line">                closeSocket(sock);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //连接的是只读服务器</span><br><span class="line">        if (sid == QuorumPeer.OBSERVER_ID) &#123;</span><br><span class="line">            sid = observerCounter.getAndDecrement();</span><br><span class="line">            LOG.info(&quot;Setting arbitrary identifier to observer: &quot; + sid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // do authenticating learner</span><br><span class="line">    authServer.authenticate(sock, din);</span><br><span class="line"></span><br><span class="line">    //由序号大的服务器向小的发起连接</span><br><span class="line">    if (sid &lt; self.getId()) &#123;</span><br><span class="line">        //关掉发送消息线程</span><br><span class="line">        SendWorker sw = senderWorkerMap.get(sid);</span><br><span class="line">        if (sw != null) &#123;</span><br><span class="line">            sw.finish();</span><br><span class="line">        &#125;</span><br><span class="line">        //关闭连接</span><br><span class="line">        closeSocket(sock);</span><br><span class="line"></span><br><span class="line">        if (electionAddr != null) &#123;</span><br><span class="line">            //发起连接</span><br><span class="line">            connectOne(sid, electionAddr);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            connectOne(sid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123; // Otherwise start worker threads to receive data.</span><br><span class="line">        //发送消息线程</span><br><span class="line">        SendWorker sw = new SendWorker(sock, sid);</span><br><span class="line">        //接受消息线程</span><br><span class="line">        RecvWorker rw = new RecvWorker(sock, din, sid, sw);</span><br><span class="line">        sw.setRecv(rw);</span><br><span class="line"></span><br><span class="line">        SendWorker vsw = senderWorkerMap.get(sid);</span><br><span class="line">        //关闭旧线程</span><br><span class="line">        if (vsw != null) &#123;</span><br><span class="line">            vsw.finish();</span><br><span class="line">        &#125;</span><br><span class="line">        //添加新线程</span><br><span class="line">        senderWorkerMap.put(sid, sw);</span><br><span class="line">        //等待发送的投票信息</span><br><span class="line">        queueSendMap.putIfAbsent(sid,</span><br><span class="line">                new ArrayBlockingQueue&lt;ByteBuffer&gt;(SEND_CAPACITY));</span><br><span class="line">        </span><br><span class="line">        sw.start();</span><br><span class="line">        rw.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、Listener的connectOne方法"><a href="#9、Listener的connectOne方法" class="headerlink" title="9、Listener的connectOne方法"></a>9、Listener的connectOne方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">synchronized private boolean connectOne(long sid, InetSocketAddress electionAddr)&#123;</span><br><span class="line">    if (senderWorkerMap.get(sid) != null) &#123;</span><br><span class="line">        //发送消息线程已存在，则已连接上</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Socket sock = null;</span><br><span class="line">    try &#123;</span><br><span class="line">         sock = new Socket();</span><br><span class="line">         setSockOpts(sock);</span><br><span class="line">         //发起连接</span><br><span class="line">         sock.connect(electionAddr, cnxTO);</span><br><span class="line">        if (quorumSaslAuthEnabled) &#123;</span><br><span class="line">            initiateConnectionAsync(sock, sid);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //初始化连接</span><br><span class="line">            initiateConnection(sock, sid);</span><br><span class="line">        &#125;</span><br><span class="line">         return true;</span><br><span class="line">     &#125; catch (UnresolvedAddressException e) &#123;</span><br><span class="line">         closeSocket(sock);</span><br><span class="line">         throw e;</span><br><span class="line">     &#125; catch (IOException e) &#123;</span><br><span class="line">         closeSocket(sock);</span><br><span class="line">         return false;</span><br><span class="line">     &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、Listener的startConnection方法"><a href="#10、Listener的startConnection方法" class="headerlink" title="10、Listener的startConnection方法"></a>10、Listener的startConnection方法</h4><p>initiateConnection方法调用startConnection方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">private boolean startConnection(Socket sock, Long sid)</span><br><span class="line">        throws IOException &#123;</span><br><span class="line">    DataOutputStream dout = null;</span><br><span class="line">    DataInputStream din = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        BufferedOutputStream buf = new BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">        dout = new DataOutputStream(buf);</span><br><span class="line">        //发送协议版本号</span><br><span class="line">        dout.writeLong(PROTOCOL_VERSION);</span><br><span class="line">        //发送服务器编号</span><br><span class="line">        dout.writeLong(self.getId());</span><br><span class="line">        String addr = self.getElectionAddress().getHostString() + &quot;:&quot; + self.getElectionAddress().getPort();</span><br><span class="line">        byte[] addr_bytes = addr.getBytes();</span><br><span class="line">        //发送本机地址</span><br><span class="line">        dout.writeInt(addr_bytes.length);</span><br><span class="line">        dout.write(addr_bytes);</span><br><span class="line">        dout.flush();</span><br><span class="line"></span><br><span class="line">        din = new DataInputStream(</span><br><span class="line">                new BufferedInputStream(sock.getInputStream()));</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // authenticate learner</span><br><span class="line">    QuorumPeer.QuorumServer qps = self.getVotingView().get(sid);</span><br><span class="line">    if (qps != null) &#123;</span><br><span class="line">        // TODO - investigate why reconfig makes qps null.</span><br><span class="line">        authLearner.authenticate(sock, qps.hostname);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 序号大的服务器向序号小的服务器发起连接</span><br><span class="line">    if (sid &gt; self.getId()) &#123;</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">        // Otherwise proceed with the connection</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //发送数据线程</span><br><span class="line">        SendWorker sw = new SendWorker(sock, sid);</span><br><span class="line">        //接受数据线程</span><br><span class="line">        RecvWorker rw = new RecvWorker(sock, din, sid, sw);</span><br><span class="line">        sw.setRecv(rw);</span><br><span class="line"></span><br><span class="line">        SendWorker vsw = senderWorkerMap.get(sid);</span><br><span class="line">        </span><br><span class="line">        if(vsw != null)</span><br><span class="line">            vsw.finish();</span><br><span class="line">        //发送消息线程Map</span><br><span class="line">        senderWorkerMap.put(sid, sw);</span><br><span class="line">        queueSendMap.putIfAbsent(sid, new ArrayBlockingQueue&lt;ByteBuffer&gt;(</span><br><span class="line">                    SEND_CAPACITY));</span><br><span class="line">        </span><br><span class="line">        sw.start();</span><br><span class="line">        rw.start();</span><br><span class="line">        </span><br><span class="line">        return true;    </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="11、SendWorker的run方法"><a href="#11、SendWorker的run方法" class="headerlink" title="11、SendWorker的run方法"></a>11、SendWorker的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            //线程数量加一</span><br><span class="line">            threadCnt.incrementAndGet();</span><br><span class="line">            try &#123;</span><br><span class="line">                //待发送的数据队列</span><br><span class="line">                ArrayBlockingQueue&lt;ByteBuffer&gt; bq = queueSendMap.get(sid);</span><br><span class="line">                if (bq == null || isSendQueueEmpty(bq)) &#123;</span><br><span class="line">                    //无待发送数据，发送上次发送的数据</span><br><span class="line">                   ByteBuffer b = lastMessageSent.get(sid);</span><br><span class="line">                   if (b != null) &#123;</span><br><span class="line">                       send(b);</span><br><span class="line">                   &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                this.finish();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            try &#123;</span><br><span class="line">                while (running &amp;&amp; !shutdown &amp;&amp; sock != null) &#123;</span><br><span class="line"></span><br><span class="line">                    ByteBuffer b = null;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        ArrayBlockingQueue&lt;ByteBuffer&gt; bq = queueSendMap</span><br><span class="line">                                .get(sid);</span><br><span class="line">                        if (bq != null) &#123;</span><br><span class="line">                            //获取待发送数据</span><br><span class="line">                            b = pollSendQueue(bq, 1000, TimeUnit.MILLISECONDS);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if(b != null)&#123;</span><br><span class="line">                            lastMessageSent.put(sid, b);</span><br><span class="line">                            //发送数据</span><br><span class="line">                            send(b);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        ...</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125;</span><br><span class="line">            this.finish();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（一、10）RecvWorker的run方法"><a href="#12、接（一、10）RecvWorker的run方法" class="headerlink" title="12、接（一、10）RecvWorker的run方法"></a>12、接（一、10）RecvWorker的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    //线程数量加一</span><br><span class="line">    threadCnt.incrementAndGet();</span><br><span class="line">    try &#123;</span><br><span class="line">        while (running &amp;&amp; !shutdown &amp;&amp; sock != null) &#123;</span><br><span class="line">            //消息长度</span><br><span class="line">            int length = din.readInt();</span><br><span class="line">            if (length &lt;= 0 || length &gt; PACKETMAXSIZE) &#123;</span><br><span class="line">                throw new IOException(</span><br><span class="line">                        &quot;Received packet with invalid packet: &quot;</span><br><span class="line">                                + length);</span><br><span class="line">            &#125;</span><br><span class="line">            /**</span><br><span class="line">             * Allocates a new ByteBuffer to receive the message</span><br><span class="line">             */</span><br><span class="line">            byte[] msgArray = new byte[length];</span><br><span class="line">            din.readFully(msgArray, 0, length);</span><br><span class="line">            ByteBuffer message = ByteBuffer.wrap(msgArray);</span><br><span class="line">            //读取到的数据包转换成投票消息加入队列</span><br><span class="line">            addToRecvQueue(new Message(message.duplicate(), sid));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ...</span><br><span class="line">        sw.finish();</span><br><span class="line">        closeSocket(sock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、接（一、4）FastLeaderElection实例化"><a href="#13、接（一、4）FastLeaderElection实例化" class="headerlink" title="13、接（一、4）FastLeaderElection实例化"></a>13、接（一、4）FastLeaderElection实例化</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public FastLeaderElection(QuorumPeer self, QuorumCnxManager manager)&#123;</span><br><span class="line">    this.stop = false;</span><br><span class="line">    this.manager = manager;</span><br><span class="line">    starter(self, manager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、FastLeaderElection的starter方法"><a href="#14、FastLeaderElection的starter方法" class="headerlink" title="14、FastLeaderElection的starter方法"></a>14、FastLeaderElection的starter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void starter(QuorumPeer self, QuorumCnxManager manager) &#123;</span><br><span class="line">    this.self = self;</span><br><span class="line">    proposedLeader = -1;</span><br><span class="line">    proposedZxid = -1;</span><br><span class="line"></span><br><span class="line">    //待发送的消息队列</span><br><span class="line">    sendqueue = new LinkedBlockingQueue&lt;ToSend&gt;();</span><br><span class="line">    //接收到的消息队列</span><br><span class="line">    recvqueue = new LinkedBlockingQueue&lt;Notification&gt;();</span><br><span class="line">    this.messenger = new Messenger(manager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、Messenger的start方法"><a href="#15、Messenger的start方法" class="headerlink" title="15、Messenger的start方法"></a>15、Messenger的start方法</h4><p>FastLeaderElection的start方法调用Messenger的start方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void start()&#123;</span><br><span class="line">    //WorkerSender发送投票消息线程</span><br><span class="line">    this.wsThread.start();</span><br><span class="line">    //WorkerReceiver接受投票消息线程</span><br><span class="line">    this.wrThread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="16、WorkerSender的run方法"><a href="#16、WorkerSender的run方法" class="headerlink" title="16、WorkerSender的run方法"></a>16、WorkerSender的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    while (!stop) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //从待发送消息队列获取消息</span><br><span class="line">            ToSend m = sendqueue.poll(3000, TimeUnit.MILLISECONDS);</span><br><span class="line">            if(m == null) continue;</span><br><span class="line">            //处理待发送消息</span><br><span class="line">            process(m);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、WorkerSender的process方法"><a href="#17、WorkerSender的process方法" class="headerlink" title="17、WorkerSender的process方法"></a>17、WorkerSender的process方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void process(ToSend m) &#123;</span><br><span class="line">    //待发送投票消息转换为字节数据</span><br><span class="line">    ByteBuffer requestBuffer = buildMsg(m.state.ordinal(),</span><br><span class="line">                                        m.leader,</span><br><span class="line">                                        m.zxid,</span><br><span class="line">                                        m.electionEpoch,</span><br><span class="line">                                        m.peerEpoch,</span><br><span class="line">                                        m.configData);</span><br><span class="line">    //发送处理转换后的数据</span><br><span class="line">    manager.toSend(m.sid, requestBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、WorkerSender的toSend方法"><a href="#18、WorkerSender的toSend方法" class="headerlink" title="18、WorkerSender的toSend方法"></a>18、WorkerSender的toSend方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void toSend(Long sid, ByteBuffer b) &#123;</span><br><span class="line">    if (this.mySid == sid) &#123;</span><br><span class="line">        //发送给自己的数据，直接添加入接受到的数据队列</span><br><span class="line">         b.position(0);</span><br><span class="line">         addToRecvQueue(new Message(b.duplicate(), sid));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //Start a new connection if doesn&apos;t have one already.</span><br><span class="line">          </span><br><span class="line">        ArrayBlockingQueue&lt;ByteBuffer&gt; bq = new ArrayBlockingQueue&lt;ByteBuffer&gt;(</span><br><span class="line">            SEND_CAPACITY);</span><br><span class="line">        //如果没有，添加该服务器待发送数据队列</span><br><span class="line">        ArrayBlockingQueue&lt;ByteBuffer&gt; oldq = queueSendMap.putIfAbsent(sid, bq);</span><br><span class="line">        //将待发送数据加入队列</span><br><span class="line">        if (oldq != null) &#123;</span><br><span class="line">            addToSendQueue(oldq, b);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            addToSendQueue(bq, b);</span><br><span class="line">        &#125;</span><br><span class="line">        //发起连接</span><br><span class="line">        connectOne(sid);     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、（接一、15）WorkerReceiver的run方法"><a href="#19、（接一、15）WorkerReceiver的run方法" class="headerlink" title="19、（接一、15）WorkerReceiver的run方法"></a>19、（接一、15）WorkerReceiver的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    Message response;</span><br><span class="line">    while (!stop) &#123;</span><br><span class="line">        // Sleeps on receive</span><br><span class="line">        try &#123;</span><br><span class="line">            //接收到的数据</span><br><span class="line">            response = manager.pollRecvQueue(3000, TimeUnit.MILLISECONDS);</span><br><span class="line">            if(response == null) continue;</span><br><span class="line"></span><br><span class="line">            // The current protocol and two previous generations all send at least 28 bytes</span><br><span class="line">            if (response.buffer.capacity() &lt; 28) &#123;</span><br><span class="line">                LOG.error(&quot;Got a short response: &quot; + response.buffer.capacity());</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // this is the backwardCompatibility mode in place before ZK-107</span><br><span class="line">            // It is for a version of the protocol in which we didn&apos;t send peer epoch</span><br><span class="line">            // With peer epoch and version the message became 40 bytes</span><br><span class="line">            boolean backCompatibility28 = (response.buffer.capacity() == 28);</span><br><span class="line"></span><br><span class="line">            // this is the backwardCompatibility mode for no version information</span><br><span class="line">            boolean backCompatibility40 = (response.buffer.capacity() == 40);</span><br><span class="line">            </span><br><span class="line">            response.buffer.clear();</span><br><span class="line"></span><br><span class="line">            //实例化消息对象</span><br><span class="line">            Notification n = new Notification();</span><br><span class="line"></span><br><span class="line">            int rstate = response.buffer.getInt();</span><br><span class="line">            long rleader = response.buffer.getLong();</span><br><span class="line">            long rzxid = response.buffer.getLong();</span><br><span class="line">            long relectionEpoch = response.buffer.getLong();</span><br><span class="line">            long rpeerepoch;</span><br><span class="line"></span><br><span class="line">            int version = 0x0;</span><br><span class="line">            if (!backCompatibility28) &#123;</span><br><span class="line">                rpeerepoch = response.buffer.getLong();</span><br><span class="line">                if (!backCompatibility40) &#123;</span><br><span class="line">                    /*</span><br><span class="line">                     * Version added in 3.4.6</span><br><span class="line">                     */</span><br><span class="line">                    </span><br><span class="line">                    version = response.buffer.getInt();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    LOG.info(&quot;Backward compatibility mode (36 bits), server id: &#123;&#125;&quot;, response.sid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                LOG.info(&quot;Backward compatibility mode (28 bits), server id: &#123;&#125;&quot;, response.sid);</span><br><span class="line">                rpeerepoch = ZxidUtils.getEpochFromZxid(rzxid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            QuorumVerifier rqv = null;</span><br><span class="line"></span><br><span class="line">            //消息中含有配置文件</span><br><span class="line">            if (version &gt; 0x1) &#123;</span><br><span class="line">                ...  </span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                LOG.info(&quot;Backward compatibility mode (before reconfig), server id: &#123;&#125;&quot;, response.sid);</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">            //该服务器不具有选举权限</span><br><span class="line">            if(!self.getCurrentAndNextConfigVoters().contains(response.sid)) &#123;</span><br><span class="line">                Vote current = self.getCurrentVote();</span><br><span class="line">                QuorumVerifier qv = self.getQuorumVerifier();</span><br><span class="line">                ToSend notmsg = new ToSend(ToSend.mType.notification,</span><br><span class="line">                        current.getId(),</span><br><span class="line">                        current.getZxid(),</span><br><span class="line">                        logicalclock.get(),</span><br><span class="line">                        self.getPeerState(),</span><br><span class="line">                        response.sid,</span><br><span class="line">                        current.getPeerEpoch(),</span><br><span class="line">                        qv.toString().getBytes());</span><br><span class="line">                //直接发送本机的投票信息</span><br><span class="line">                sendqueue.offer(notmsg);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //投票服务器的状态</span><br><span class="line">                QuorumPeer.ServerState ackstate = QuorumPeer.ServerState.LOOKING;</span><br><span class="line">                switch (rstate) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                    ackstate = QuorumPeer.ServerState.LOOKING;</span><br><span class="line">                    break;</span><br><span class="line">                case 1:</span><br><span class="line">                    ackstate = QuorumPeer.ServerState.FOLLOWING;</span><br><span class="line">                    break;</span><br><span class="line">                case 2:</span><br><span class="line">                    ackstate = QuorumPeer.ServerState.LEADING;</span><br><span class="line">                    break;</span><br><span class="line">                case 3:</span><br><span class="line">                    ackstate = QuorumPeer.ServerState.OBSERVING;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //初始化投票信息</span><br><span class="line">                n.leader = rleader;</span><br><span class="line">                n.zxid = rzxid;</span><br><span class="line">                n.electionEpoch = relectionEpoch;</span><br><span class="line">                n.state = ackstate;</span><br><span class="line">                n.sid = response.sid;</span><br><span class="line">                n.peerEpoch = rpeerepoch;</span><br><span class="line">                n.version = version;</span><br><span class="line">                n.qv = rqv;</span><br><span class="line">                //本机是选举状态</span><br><span class="line">                if(self.getPeerState() == QuorumPeer.ServerState.LOOKING)&#123;</span><br><span class="line">                    //消息添加到接受队列</span><br><span class="line">                    recvqueue.offer(n);</span><br><span class="line">                    //发送消息的服务器为选举状态</span><br><span class="line">                    if((ackstate == QuorumPeer.ServerState.LOOKING)</span><br><span class="line">                            &amp;&amp; (n.electionEpoch &lt; logicalclock.get()))&#123;</span><br><span class="line">                        Vote v = getVote();</span><br><span class="line">                        QuorumVerifier qv = self.getQuorumVerifier();</span><br><span class="line">                        ToSend notmsg = new ToSend(ToSend.mType.notification,</span><br><span class="line">                                v.getId(),</span><br><span class="line">                                v.getZxid(),</span><br><span class="line">                                logicalclock.get(),</span><br><span class="line">                                self.getPeerState(),</span><br><span class="line">                                response.sid,</span><br><span class="line">                                v.getPeerEpoch(),</span><br><span class="line">                                qv.toString().getBytes());</span><br><span class="line">                        //发送本机的选票</span><br><span class="line">                        sendqueue.offer(notmsg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //本机非选举状态直接发送当前选举结果</span><br><span class="line">                    Vote current = self.getCurrentVote();</span><br><span class="line">                    if(ackstate == QuorumPeer.ServerState.LOOKING)&#123;</span><br><span class="line">                        if(LOG.isDebugEnabled())&#123;</span><br><span class="line">                            LOG.debug(&quot;Sending new notification. My id =&#123;&#125; recipient=&#123;&#125; zxid=0x&#123;&#125; leader=&#123;&#125; config version = &#123;&#125;&quot;,</span><br><span class="line">                                    self.getId(),</span><br><span class="line">                                    response.sid,</span><br><span class="line">                                    Long.toHexString(current.getZxid()),</span><br><span class="line">                                    current.getId(),</span><br><span class="line">                                    Long.toHexString(self.getQuorumVerifier().getVersion()));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        QuorumVerifier qv = self.getQuorumVerifier();</span><br><span class="line">                        ToSend notmsg = new ToSend(</span><br><span class="line">                                ToSend.mType.notification,</span><br><span class="line">                                current.getId(),</span><br><span class="line">                                current.getZxid(),</span><br><span class="line">                                current.getElectionEpoch(),</span><br><span class="line">                                self.getPeerState(),</span><br><span class="line">                                response.sid,</span><br><span class="line">                                current.getPeerEpoch(),</span><br><span class="line">                                qv.toString().getBytes());</span><br><span class="line">                        sendqueue.offer(notmsg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、接（一、2）QuorumPeer的run方法"><a href="#20、接（一、2）QuorumPeer的run方法" class="headerlink" title="20、接（一、2）QuorumPeer的run方法"></a>20、接（一、2）QuorumPeer的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    updateThreadName();</span><br><span class="line">    ...</span><br><span class="line">    try &#123;</span><br><span class="line">        /*</span><br><span class="line">         * Main loop</span><br><span class="line">         */</span><br><span class="line">        while (running) &#123;</span><br><span class="line">            //本机状态</span><br><span class="line">            switch (getPeerState()) &#123;</span><br><span class="line">            case LOOKING:</span><br><span class="line">                //本机为只读服务器</span><br><span class="line">                if (Boolean.getBoolean(&quot;readonlymode.enabled&quot;)) &#123;</span><br><span class="line">                    LOG.info(&quot;Attempting to start ReadOnlyZooKeeperServer&quot;);</span><br><span class="line"></span><br><span class="line">                    // Create read-only server but don&apos;t start it immediately</span><br><span class="line">                    final ReadOnlyZooKeeperServer roZk =</span><br><span class="line">                        new ReadOnlyZooKeeperServer(logFactory, this, this.zkDb);</span><br><span class="line"></span><br><span class="line">                    //等待两秒钟启动服务器</span><br><span class="line">                    Thread roZkMgr = new Thread() &#123;</span><br><span class="line">                        public void run() &#123;</span><br><span class="line">                            try &#123;</span><br><span class="line">                                // lower-bound grace period to 2 secs</span><br><span class="line">                                sleep(Math.max(2000, tickTime));</span><br><span class="line">                                if (ServerState.LOOKING.equals(getPeerState())) &#123;</span><br><span class="line">                                    roZk.startup();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                                LOG.info(&quot;Interrupted while attempting to start ReadOnlyZooKeeperServer, not started&quot;);</span><br><span class="line">                            &#125; catch (Exception e) &#123;</span><br><span class="line">                                LOG.error(&quot;FAILED to start ReadOnlyZooKeeperServer&quot;, e);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        roZkMgr.start();</span><br><span class="line">                        reconfigFlagClear();</span><br><span class="line">                        if (shuttingDownLE) &#123;</span><br><span class="line">                            shuttingDownLE = false;</span><br><span class="line">                            startLeaderElection();</span><br><span class="line">                        &#125;</span><br><span class="line">                        //选举并设置当前投票</span><br><span class="line">                        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        LOG.warn(&quot;Unexpected exception&quot;, e);</span><br><span class="line">                        setPeerState(ServerState.LOOKING);</span><br><span class="line">                    &#125; finally &#123;</span><br><span class="line">                        roZkMgr.interrupt();</span><br><span class="line">                        roZk.shutdown();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        reconfigFlagClear();</span><br><span class="line">                        if (shuttingDownLE) &#123;</span><br><span class="line">                           shuttingDownLE = false;</span><br><span class="line">                           startLeaderElection();</span><br><span class="line">                           &#125;</span><br><span class="line">                        //选举并设置当前选举结果</span><br><span class="line">                        setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        LOG.warn(&quot;Unexpected exception&quot;, e);</span><br><span class="line">                        setPeerState(ServerState.LOOKING);</span><br><span class="line">                    &#125;                        </span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case OBSERVING:</span><br><span class="line">                try &#123;</span><br><span class="line">                    LOG.info(&quot;OBSERVING&quot;);</span><br><span class="line">                    setObserver(makeObserver(logFactory));</span><br><span class="line">                    //只读服务器初始化</span><br><span class="line">                    observer.observeLeader();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    LOG.warn(&quot;Unexpected exception&quot;,e );</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    observer.shutdown();</span><br><span class="line">                    setObserver(null);  </span><br><span class="line">                   updateServerState();</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case FOLLOWING:</span><br><span class="line">                try &#123;</span><br><span class="line">                   LOG.info(&quot;FOLLOWING&quot;);</span><br><span class="line">                    setFollower(makeFollower(logFactory));</span><br><span class="line">                    //初始化</span><br><span class="line">                    follower.followLeader();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                   LOG.warn(&quot;Unexpected exception&quot;,e);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                   follower.shutdown();</span><br><span class="line">                   setFollower(null);</span><br><span class="line">                   updateServerState();</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case LEADING:</span><br><span class="line">                LOG.info(&quot;LEADING&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    setLeader(makeLeader(logFactory));</span><br><span class="line">                    //初始化</span><br><span class="line">                    leader.lead();</span><br><span class="line">                    setLeader(null);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    LOG.warn(&quot;Unexpected exception&quot;,e);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    if (leader != null) &#123;</span><br><span class="line">                        leader.shutdown(&quot;Forcing shutdown&quot;);</span><br><span class="line">                        setLeader(null);</span><br><span class="line">                    &#125;</span><br><span class="line">                    updateServerState();</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            start_fle = Time.currentElapsedTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、FastLeaderElection的lookForLeader方法选举LEADER"><a href="#21、FastLeaderElection的lookForLeader方法选举LEADER" class="headerlink" title="21、FastLeaderElection的lookForLeader方法选举LEADER"></a>21、FastLeaderElection的lookForLeader方法选举LEADER</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">public Vote lookForLeader() throws InterruptedException &#123;</span><br><span class="line">    ...</span><br><span class="line">    //选举开始时间</span><br><span class="line">    if (self.start_fle == 0) &#123;</span><br><span class="line">       self.start_fle = Time.currentElapsedTime();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //收到的投票</span><br><span class="line">        Map&lt;Long, Vote&gt; recvset = new HashMap&lt;Long, Vote&gt;();</span><br><span class="line">        Map&lt;Long, Vote&gt; outofelection = new HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">        int notTimeout = finalizeWait;</span><br><span class="line"></span><br><span class="line">        synchronized(this)&#123;</span><br><span class="line">            //选举轮次加一</span><br><span class="line">            logicalclock.incrementAndGet();</span><br><span class="line">            //更新投票提议，默认投自己</span><br><span class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //广播本机选票</span><br><span class="line">        sendNotifications();</span><br><span class="line">        //本机处于选举状态且为停止</span><br><span class="line">        while ((self.getPeerState() == ServerState.LOOKING) &amp;&amp;</span><br><span class="line">                (!stop))&#123;</span><br><span class="line">            //取出接收到的消息</span><br><span class="line">            Notification n = recvqueue.poll(notTimeout,</span><br><span class="line">                    TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">            //未收到投票</span><br><span class="line">            if(n == null)&#123;</span><br><span class="line">                //投票已发送</span><br><span class="line">                if(manager.haveDelivered())&#123;</span><br><span class="line">                    //重新发送</span><br><span class="line">                    sendNotifications();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //投票未发送，重新连接</span><br><span class="line">                    manager.connectAll();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                /*</span><br><span class="line">                 * Exponential backoff</span><br><span class="line">                 */</span><br><span class="line">                int tmpTimeOut = notTimeout*2;</span><br><span class="line">                notTimeout = (tmpTimeOut &lt; maxNotificationInterval?</span><br><span class="line">                        tmpTimeOut : maxNotificationInterval);</span><br><span class="line">                LOG.info(&quot;Notification time out: &quot; + notTimeout);</span><br><span class="line">            &#125; </span><br><span class="line">            else if (self.getCurrentAndNextConfigVoters().contains(n.sid)) &#123;</span><br><span class="line">                switch (n.state) &#123;</span><br><span class="line">                //投票的服务器处于选举状态</span><br><span class="line">                case LOOKING:</span><br><span class="line">                    //-1说明加载数据出错，不处理</span><br><span class="line">                    if (getInitLastLoggedZxid() == -1) &#123;</span><br><span class="line">                        LOG.debug(&quot;Ignoring notification as our zxid is -1&quot;);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (n.zxid == -1) &#123;</span><br><span class="line">                        LOG.debug(&quot;Ignoring notification from member with -1 zxid&quot; + n.sid);</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //发消息的服务器选举轮次大于本机轮次</span><br><span class="line">                    if (n.electionEpoch &gt; logicalclock.get()) &#123;</span><br><span class="line">                        //更新轮次</span><br><span class="line">                        logicalclock.set(n.electionEpoch);</span><br><span class="line">                        //废弃所有收到的选票</span><br><span class="line">                        recvset.clear();</span><br><span class="line">                        //选举PK，更新当前的提议为胜出者</span><br><span class="line">                        if(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123;</span><br><span class="line">                            updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            updateProposal(getInitId(),</span><br><span class="line">                                    getInitLastLoggedZxid(),</span><br><span class="line">                                    getPeerEpoch());</span><br><span class="line">                        &#125;</span><br><span class="line">                        //发送选票</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125; else if (n.electionEpoch &lt; logicalclock.get()) &#123;</span><br><span class="line">                        //发消息的服务器选举轮次小于本机轮次，不处理，跳出switch</span><br><span class="line">                        break;</span><br><span class="line">                    &#125; else if (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                            proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                        //同一轮次，选票PK，更新胜出者为当前提议</span><br><span class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        //发送消息</span><br><span class="line">                        sendNotifications();</span><br><span class="line">                    &#125;</span><br><span class="line">                    //当前选票信息，添加到map中</span><br><span class="line">                    recvset.put(n.sid, new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line">                    //若当前提议超过半数</span><br><span class="line">                    if (termPredicate(recvset,</span><br><span class="line">                            new Vote(proposedLeader, proposedZxid,</span><br><span class="line">                                    logicalclock.get(), proposedEpoch))) &#123;</span><br><span class="line"></span><br><span class="line">                        //检查投票中，是否有PK胜出当前提议的投票</span><br><span class="line">                        while((n = recvqueue.poll(finalizeWait,</span><br><span class="line">                                TimeUnit.MILLISECONDS)) != null)&#123;</span><br><span class="line">                            if(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</span><br><span class="line">                                    proposedLeader, proposedZxid, proposedEpoch))&#123;</span><br><span class="line">                                recvqueue.put(n);</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (n == null) &#123;</span><br><span class="line">                            //当前提议为最终结果，若提以为自己，则本机当选LEADER</span><br><span class="line">                            self.setPeerState((proposedLeader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line">                            //设置最终选票</span><br><span class="line">                            Vote endVote = new Vote(proposedLeader,</span><br><span class="line">                                    proposedZxid, proposedEpoch);</span><br><span class="line">                            //清除选票容器</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            //返回最终选票</span><br><span class="line">                            return endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case OBSERVING:</span><br><span class="line">                    //当前状态为观察者，不参与处理</span><br><span class="line">                    break;</span><br><span class="line">                case FOLLOWING:</span><br><span class="line">                case LEADING:</span><br><span class="line">                    //发出消息的服务器，与本机轮次相同</span><br><span class="line">                    if(n.electionEpoch == logicalclock.get())&#123;</span><br><span class="line">                        //保存收到的选票</span><br><span class="line">                        recvset.put(n.sid, new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line">                        //若n的选票超过半数，并且n的状态为Leader，并且n不为本机，则更新本机状态、选举结果</span><br><span class="line">                        if(termPredicate(recvset, new Vote(n.leader,</span><br><span class="line">                                        n.zxid, n.electionEpoch, n.peerEpoch, n.state))</span><br><span class="line">                                        &amp;&amp; checkLeader(outofelection, n.leader, n.electionEpoch)) &#123;</span><br><span class="line">                            self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line"></span><br><span class="line">                            Vote endVote = new Vote(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            return endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    outofelection.put(n.sid, new Vote(n.leader, </span><br><span class="line">                            IGNOREVALUE, IGNOREVALUE, n.peerEpoch, n.state));</span><br><span class="line">                    if (termPredicate(outofelection, new Vote(n.leader,</span><br><span class="line">                            IGNOREVALUE, IGNOREVALUE, n.peerEpoch, n.state))</span><br><span class="line">                            &amp;&amp; checkLeader(outofelection, n.leader, IGNOREVALUE)) &#123;</span><br><span class="line">                        synchronized(this)&#123;</span><br><span class="line">                            logicalclock.set(n.electionEpoch);</span><br><span class="line">                            self.setPeerState((n.leader == self.getId()) ?</span><br><span class="line">                                    ServerState.LEADING: learningState());</span><br><span class="line">                        &#125;</span><br><span class="line">                        Vote endVote = new Vote(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                        leaveInstance(endVote);</span><br><span class="line">                        return endVote;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    LOG.warn(&quot;Notification state unrecoginized: &quot; + n.state</span><br><span class="line">                          + &quot; (n.state), &quot; + n.sid + &quot; (n.sid)&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                LOG.warn(&quot;Ignoring notification from non-cluster member &quot; + n.sid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此leader选举就完成了;</p>
<h3 id="二、LEADER初始化过程"><a href="#二、LEADER初始化过程" class="headerlink" title="二、LEADER初始化过程"></a>二、LEADER初始化过程</h3><h4 id="1、实例化Leader"><a href="#1、实例化Leader" class="headerlink" title="1、实例化Leader"></a>1、实例化Leader</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Leader(QuorumPeer self,LeaderZooKeeperServer zk) throws IOException &#123;</span><br><span class="line">    this.self = self;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (self.getQuorumListenOnAllIPs()) &#123;</span><br><span class="line">            ss = new ServerSocket(self.getQuorumAddress().getPort());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //socket服务器等待follower连接</span><br><span class="line">            ss = new ServerSocket();</span><br><span class="line">        &#125;</span><br><span class="line">        ss.setReuseAddress(true);</span><br><span class="line">        if (!self.getQuorumListenOnAllIPs()) &#123;</span><br><span class="line">            //监听地址</span><br><span class="line">            ss.bind(self.getQuorumAddress());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (BindException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line">    //leader服务器</span><br><span class="line">    this.zk = zk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、LEADER的lead方法"><a href="#2、LEADER的lead方法" class="headerlink" title="2、LEADER的lead方法"></a>2、LEADER的lead方法</h4><p>lead方法实现初始化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">void lead() throws IOException, InterruptedException &#123;</span><br><span class="line">    self.end_fle = Time.currentElapsedTime();</span><br><span class="line">    //leader选举所花的时间</span><br><span class="line">    long electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">    self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">    self.start_fle = 0;</span><br><span class="line">    self.end_fle = 0;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //leader计时器</span><br><span class="line">        self.tick.set(0);</span><br><span class="line">        //恢复数据</span><br><span class="line">        zk.loadData();</span><br><span class="line">        //leader服务器最新的事务状态</span><br><span class="line">        leaderStateSummary = new StateSummary(self.getCurrentEpoch(), zk.getLastProcessedZxid());</span><br><span class="line"></span><br><span class="line">        // 等待follower接入的线程</span><br><span class="line">        cnxAcceptor = new LearnerCnxAcceptor();</span><br><span class="line">        cnxAcceptor.start();</span><br><span class="line">        //等待足够多的follower进来，代表自己确实是leader，此处lead线程可能会等待 </span><br><span class="line">        //返回最新的批次加一</span><br><span class="line">        long epoch = getEpochToPropose(self.getId(), self.getAcceptedEpoch());</span><br><span class="line">        //用最新的批次创建事务序号</span><br><span class="line">        zk.setZxid(ZxidUtils.makeZxid(epoch, 0));</span><br><span class="line"></span><br><span class="line">        synchronized(this)&#123;</span><br><span class="line">            //最新提交的事务序号</span><br><span class="line">            lastProposed = zk.getZxid();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        newLeaderProposal.packet = new QuorumPacket(NEWLEADER, zk.getZxid(),</span><br><span class="line">               null, null);</span><br><span class="line"></span><br><span class="line">        //新批次的事务序号不是从零开始</span><br><span class="line">        if ((newLeaderProposal.packet.getZxid() &amp; 0xffffffffL) != 0) &#123;</span><br><span class="line">            LOG.info(&quot;NEWLEADER proposal has Zxid of &quot;</span><br><span class="line">                    + Long.toHexString(newLeaderProposal.packet.getZxid()));</span><br><span class="line">        &#125;</span><br><span class="line">        //校验器</span><br><span class="line">        QuorumVerifier lastSeenQV = self.getLastSeenQuorumVerifier();</span><br><span class="line">        QuorumVerifier curQV = self.getQuorumVerifier();</span><br><span class="line">        if (curQV.getVersion() == 0 &amp;&amp; curQV.getVersion() == lastSeenQV.getVersion()) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               QuorumVerifier newQV = self.configFromString(curQV.toString());</span><br><span class="line">               newQV.setVersion(zk.getZxid());</span><br><span class="line">               self.setLastSeenQuorumVerifier(newQV, true);    </span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               throw new IOException(e);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        newLeaderProposal.addQuorumVerifier(self.getQuorumVerifier());</span><br><span class="line">        if (self.getLastSeenQuorumVerifier().getVersion() &gt; self.getQuorumVerifier().getVersion())&#123;</span><br><span class="line">           newLeaderProposal.addQuorumVerifier(self.getLastSeenQuorumVerifier());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         //等待足够多的follower确认，leader的事务为最新的事务</span><br><span class="line">         waitForEpochAck(self.getId(), leaderStateSummary);</span><br><span class="line">         //设置当前批次</span><br><span class="line">         self.setCurrentEpoch(epoch);    </span><br><span class="line">        </span><br><span class="line">         try &#123;</span><br><span class="line">             //等待最少半数follower同步数据完成</span><br><span class="line">             waitForNewLeaderAck(self.getId(), zk.getZxid(), LearnerType.PARTICIPANT);</span><br><span class="line">         &#125; catch (InterruptedException e) &#123;</span><br><span class="line">             ...</span><br><span class="line">             return;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         //启动LeaderZooKeeperServer</span><br><span class="line">         startZkServer();</span><br><span class="line">         ...</span><br><span class="line"></span><br><span class="line">        // We ping twice a tick, so we only update the tick every other</span><br><span class="line">        // iteration</span><br><span class="line">        boolean tickSkip = true;</span><br><span class="line">        // If not null then shutdown this leader</span><br><span class="line">        String shutdownMessage = null;</span><br><span class="line"></span><br><span class="line">        while (true) &#123;</span><br><span class="line">            synchronized (this) &#123;</span><br><span class="line">                long start = Time.currentElapsedTime();</span><br><span class="line">                long cur = start;</span><br><span class="line">                long end = start + self.tickTime / 2;</span><br><span class="line">                while (cur &lt; end) &#123;</span><br><span class="line">                    //等待</span><br><span class="line">                    wait(end - cur);</span><br><span class="line">                    cur = Time.currentElapsedTime();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (!tickSkip) &#123;</span><br><span class="line">                    计时器加一</span><br><span class="line">                    self.tick.incrementAndGet();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                //未超时的服务器的id集合</span><br><span class="line">                SyncedLearnerTracker syncedAckSet = new SyncedLearnerTracker();</span><br><span class="line">                syncedAckSet.addQuorumVerifier(self.getQuorumVerifier());</span><br><span class="line">                if (self.getLastSeenQuorumVerifier() != null</span><br><span class="line">                        &amp;&amp; self.getLastSeenQuorumVerifier().getVersion() &gt; self</span><br><span class="line">                                .getQuorumVerifier().getVersion()) &#123;</span><br><span class="line">                    syncedAckSet.addQuorumVerifier(self</span><br><span class="line">                            .getLastSeenQuorumVerifier());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                syncedAckSet.addAck(self.getId());</span><br><span class="line"></span><br><span class="line">                for (LearnerHandler f : getLearners()) &#123;</span><br><span class="line">                    //连接未超时</span><br><span class="line">                    if (f.synced()) &#123;</span><br><span class="line">                        syncedAckSet.addAck(f.getSid());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // check leader running status</span><br><span class="line">                if (!this.isRunning()) &#123;</span><br><span class="line">                    // set shutdown flag</span><br><span class="line">                    shutdownMessage = &quot;Unexpected internal error&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                //未超时的连接小于半数，则退出主循环</span><br><span class="line">                if (!tickSkip &amp;&amp; !syncedAckSet.hasAllQuorums()) &#123;</span><br><span class="line">                    shutdownMessage = &quot;Not sufficient followers synced, only synced with sids: [ &quot;</span><br><span class="line">                            + syncedAckSet.ackSetsToString() + &quot; ]&quot;;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                tickSkip = !tickSkip;</span><br><span class="line">            &#125;</span><br><span class="line">            for (LearnerHandler f : getLearners()) &#123;</span><br><span class="line">                //心跳检测</span><br><span class="line">                f.ping();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (shutdownMessage != null) &#123;</span><br><span class="line">            shutdown(shutdownMessage);</span><br><span class="line">            // leader goes in looking state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        zk.unregisterJMX(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、LearnerCnxAcceptor线程的run方法"><a href="#3、LearnerCnxAcceptor线程的run方法" class="headerlink" title="3、LearnerCnxAcceptor线程的run方法"></a>3、LearnerCnxAcceptor线程的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        while (!stop) &#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                //接受follower连接</span><br><span class="line">                Socket s = ss.accept();</span><br><span class="line">                // start with the initLimit, once the ack is processed</span><br><span class="line">                // in LearnerHandler switch to the syncLimit</span><br><span class="line">                s.setSoTimeout(self.tickTime * self.initLimit);</span><br><span class="line">                s.setTcpNoDelay(nodelay);</span><br><span class="line"></span><br><span class="line">                BufferedInputStream is = new BufferedInputStream(</span><br><span class="line">                        s.getInputStream());</span><br><span class="line">                //处理follower数据的线程</span><br><span class="line">                LearnerHandler fh = new LearnerHandler(s, is, Leader.this);</span><br><span class="line">                fh.start();</span><br><span class="line">            &#125; catch</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        LOG.warn(&quot;Exception while accepting follower&quot;, e.getMessage());</span><br><span class="line">        handleException(this.getName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、LearnerHandler线程的run方法"><a href="#4、LearnerHandler线程的run方法" class="headerlink" title="4、LearnerHandler线程的run方法"></a>4、LearnerHandler线程的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        leader.addLearnerHandler(this);</span><br><span class="line">        //超时时间</span><br><span class="line">        tickOfNextAckDeadline = leader.self.tick.get()</span><br><span class="line">                + leader.self.initLimit + leader.self.syncLimit;</span><br><span class="line"></span><br><span class="line">        ia = BinaryInputArchive.getArchive(bufferedInput);</span><br><span class="line">        bufferedOutput = new BufferedOutputStream(sock.getOutputStream());</span><br><span class="line">        oa = BinaryOutputArchive.getArchive(bufferedOutput);</span><br><span class="line"></span><br><span class="line">        QuorumPacket qp = new QuorumPacket();</span><br><span class="line">        ia.readRecord(qp, &quot;packet&quot;);</span><br><span class="line">        //检查数据类型</span><br><span class="line">        if(qp.getType() != Leader.FOLLOWERINFO &amp;&amp; qp.getType() != Leader.OBSERVERINFO)&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        byte learnerInfoData[] = qp.getData();</span><br><span class="line">        if (learnerInfoData != null) &#123;</span><br><span class="line">            ByteBuffer bbsid = ByteBuffer.wrap(learnerInfoData);</span><br><span class="line">            if (learnerInfoData.length &gt;= 8) &#123;</span><br><span class="line">                this.sid = bbsid.getLong();</span><br><span class="line">            &#125;</span><br><span class="line">            if (learnerInfoData.length &gt;= 12) &#123;</span><br><span class="line">                this.version = bbsid.getInt(); // protocolVersion</span><br><span class="line">            &#125;</span><br><span class="line">            if (learnerInfoData.length &gt;= 20) &#123;</span><br><span class="line">                long configVersion = bbsid.getLong();</span><br><span class="line">                if (configVersion &gt; leader.self.getQuorumVerifier().getVersion()) &#123;</span><br><span class="line">                    throw new IOException(&quot;Follower is ahead of the leader (has a later activated configuration)&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.sid = leader.followerCounter.getAndDecrement();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        if (qp.getType() == Leader.OBSERVERINFO) &#123;</span><br><span class="line">              learnerType = LearnerType.OBSERVER;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //follwer的最新批次</span><br><span class="line">        long lastAcceptedEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line"></span><br><span class="line">        long peerLastZxid;</span><br><span class="line">        StateSummary ss = null;</span><br><span class="line">        long zxid = qp.getZxid();</span><br><span class="line">        //等待足够多的follower进来，代表自己确实是leader，此处lead线程可能会等待 </span><br><span class="line">        //返回最新的批次加一</span><br><span class="line">        long newEpoch = leader.getEpochToPropose(this.getSid(), lastAcceptedEpoch);</span><br><span class="line">        //最新批次事务序号</span><br><span class="line">        long newLeaderZxid = ZxidUtils.makeZxid(newEpoch, 0);</span><br><span class="line"></span><br><span class="line">        if (this.getVersion() &lt; 0x10000) &#123;</span><br><span class="line">            // we are going to have to extrapolate the epoch information</span><br><span class="line">            long epoch = ZxidUtils.getEpochFromZxid(zxid);</span><br><span class="line">            //该follower的最新事务批次、最大事务序号</span><br><span class="line">            ss = new StateSummary(epoch, zxid);</span><br><span class="line">            //确认follower的事务序号小于leader，需等待半数follower完成</span><br><span class="line">            leader.waitForEpochAck(this.getSid(), ss);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            byte ver[] = new byte[4];</span><br><span class="line">            ByteBuffer.wrap(ver).putInt(0x10000);</span><br><span class="line">            QuorumPacket newEpochPacket = new QuorumPacket(Leader.LEADERINFO, newLeaderZxid, ver, null);</span><br><span class="line">            oa.writeRecord(newEpochPacket, &quot;packet&quot;);</span><br><span class="line">            bufferedOutput.flush();</span><br><span class="line">            QuorumPacket ackEpochPacket = new QuorumPacket();</span><br><span class="line">            ia.readRecord(ackEpochPacket, &quot;packet&quot;);</span><br><span class="line">            if (ackEpochPacket.getType() != Leader.ACKEPOCH) &#123;</span><br><span class="line">                LOG.error(ackEpochPacket.toString()</span><br><span class="line">                        + &quot; is not ACKEPOCH&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">            ss = new StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">            leader.waitForEpochAck(this.getSid(), ss);</span><br><span class="line">        &#125;</span><br><span class="line">        //该follwer最新的事务序号</span><br><span class="line">        peerLastZxid = ss.getLastZxid();</span><br><span class="line">       </span><br><span class="line">        //向该follower同步数据</span><br><span class="line">        boolean needSnap = syncFollower(peerLastZxid, leader.zk.getZKDatabase(), leader);</span><br><span class="line">    </span><br><span class="line">        // 发送newleader给follower</span><br><span class="line">        if (getVersion() &lt; 0x10000) &#123;</span><br><span class="line">            QuorumPacket newLeaderQP = new QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    newLeaderZxid, null, null);</span><br><span class="line">            oa.writeRecord(newLeaderQP, &quot;packet&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            QuorumPacket newLeaderQP = new QuorumPacket(Leader.NEWLEADER,</span><br><span class="line">                    newLeaderZxid, leader.self.getLastSeenQuorumVerifier()</span><br><span class="line">                            .toString().getBytes(), null);</span><br><span class="line">            queuedPackets.add(newLeaderQP);</span><br><span class="line">        &#125;</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line">        /* if we are not truncating or sending a diff just send a snapshot */</span><br><span class="line">        if (needSnap) &#123;</span><br><span class="line">            boolean exemptFromThrottle = getLearnerType() != LearnerType.OBSERVER;</span><br><span class="line">            LearnerSnapshot snapshot = </span><br><span class="line">                    leader.getLearnerSnapshotThrottler().beginSnapshot(exemptFromThrottle);</span><br><span class="line">            try &#123;</span><br><span class="line">                long zxidToSend = leader.zk.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">                oa.writeRecord(new QuorumPacket(Leader.SNAP, zxidToSend, null, null), &quot;packet&quot;);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line"></span><br><span class="line">                // 向follower发送快照</span><br><span class="line">                leader.zk.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">                oa.writeString(&quot;BenWasHere&quot;, &quot;signature&quot;);</span><br><span class="line">                bufferedOutput.flush();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                snapshot.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 启动发送数据包的线程,发送queuedPackets中数据</span><br><span class="line">        startSendingPackets();</span><br><span class="line">        </span><br><span class="line">        /*</span><br><span class="line">         * Have to wait for the first ACK, wait until</span><br><span class="line">         * the leader is ready, and only then we can</span><br><span class="line">         * start processing messages.</span><br><span class="line">         */</span><br><span class="line">        qp = new QuorumPacket();</span><br><span class="line">        ia.readRecord(qp, &quot;packet&quot;);</span><br><span class="line">        if(qp.getType() != Leader.ACK)&#123;</span><br><span class="line">            ...</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //follower同步数据完成，检查follower最新事务序号是否与leader相同，等待半数follower完成</span><br><span class="line">        leader.waitForNewLeaderAck(getSid(), qp.getZxid(), getLearnerType());</span><br><span class="line"></span><br><span class="line">        //等待时间限制</span><br><span class="line">        syncLimitCheck.start();</span><br><span class="line">        </span><br><span class="line">        // now that the ack has been processed expect the syncLimit</span><br><span class="line">        sock.setSoTimeout(leader.self.tickTime * leader.self.syncLimit);</span><br><span class="line"></span><br><span class="line">        //等待LeaderZooKeeperServer启动</span><br><span class="line">        synchronized(leader.zk)&#123;</span><br><span class="line">            while(!leader.zk.isRunning() &amp;&amp; !this.isInterrupted())&#123;</span><br><span class="line">                leader.zk.wait(20);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //通知follower退出同步数据循环     </span><br><span class="line">        queuedPackets.add(new QuorumPacket(Leader.UPTODATE, -1, null, null));</span><br><span class="line">        //主循环</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            qp = new QuorumPacket();</span><br><span class="line">            //读取follower发来的数据</span><br><span class="line">            ia.readRecord(qp, &quot;packet&quot;);</span><br><span class="line"></span><br><span class="line">            long traceMask = ZooTrace.SERVER_PACKET_TRACE_MASK;</span><br><span class="line">            if (qp.getType() == Leader.PING) &#123;</span><br><span class="line">                traceMask = ZooTrace.SERVER_PING_TRACE_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">            tickOfNextAckDeadline = leader.self.tick.get() + leader.self.syncLimit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ByteBuffer bb;</span><br><span class="line">            long sessionId;</span><br><span class="line">            int cxid;</span><br><span class="line">            int type;</span><br><span class="line"></span><br><span class="line">            switch (qp.getType()) &#123;</span><br><span class="line">            case Leader.ACK:</span><br><span class="line">                //刷新时间</span><br><span class="line">                syncLimitCheck.updateAck(qp.getZxid());</span><br><span class="line">                //处理follower对提议返回的投票</span><br><span class="line">                leader.processAck(this.sid, qp.getZxid(), sock.getLocalSocketAddress());</span><br><span class="line">                break;</span><br><span class="line">            case Leader.PING:</span><br><span class="line">                // 心跳信息</span><br><span class="line">                ByteArrayInputStream bis = new ByteArrayInputStream(qp</span><br><span class="line">                        .getData());</span><br><span class="line">                DataInputStream dis = new DataInputStream(bis);</span><br><span class="line">                while (dis.available() &gt; 0) &#123;</span><br><span class="line">                    long sess = dis.readLong();</span><br><span class="line">                    int to = dis.readInt();</span><br><span class="line">                    //更新session的有效时间</span><br><span class="line">                    leader.zk.touch(sess, to);</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case Leader.REVALIDATE:</span><br><span class="line">                bis = new ByteArrayInputStream(qp.getData());</span><br><span class="line">                dis = new DataInputStream(bis);</span><br><span class="line">                long id = dis.readLong();</span><br><span class="line">                int to = dis.readInt();</span><br><span class="line">                ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br><span class="line">                DataOutputStream dos = new DataOutputStream(bos);</span><br><span class="line">                dos.writeLong(id);</span><br><span class="line">                boolean valid = leader.zk.checkIfValidGlobalSession(id, to);</span><br><span class="line">                if (valid) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        //set the session owner</span><br><span class="line">                        // as the follower that</span><br><span class="line">                        // owns the session</span><br><span class="line">                        leader.zk.setOwner(id, this);</span><br><span class="line">                    &#125; catch (SessionExpiredException e) &#123;</span><br><span class="line">                        LOG.error(&quot;Somehow session &quot; + Long.toHexString(id) +</span><br><span class="line">                                &quot; expired right after being renewed! (impossible)&quot;, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                dos.writeBoolean(valid);</span><br><span class="line">                qp.setData(bos.toByteArray());</span><br><span class="line">                queuedPackets.add(qp);</span><br><span class="line">                break;</span><br><span class="line">            case Leader.REQUEST:</span><br><span class="line">	      //Follower转发过来的请求</span><br><span class="line">                bb = ByteBuffer.wrap(qp.getData());</span><br><span class="line">                sessionId = bb.getLong();</span><br><span class="line">                cxid = bb.getInt();</span><br><span class="line">                type = bb.getInt();</span><br><span class="line">                bb = bb.slice();</span><br><span class="line">                Request si;</span><br><span class="line">                if(type == OpCode.sync)&#123;</span><br><span class="line">                    si = new LearnerSyncRequest(this, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    si = new Request(null, sessionId, cxid, type, bb, qp.getAuthinfo());</span><br><span class="line">                &#125;</span><br><span class="line">                si.setOwner(this);</span><br><span class="line">                //调用prepRequestProcessor处理request</span><br><span class="line">                leader.zk.submitLearnerRequest(si);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                LOG.warn(&quot;unexpected quorum packet, type: &#123;&#125;&quot;, packetToString(qp));</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch</span><br><span class="line">    ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、Leader的getEpochToPropose方法"><a href="#5、Leader的getEpochToPropose方法" class="headerlink" title="5、Leader的getEpochToPropose方法"></a>5、Leader的getEpochToPropose方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public long getEpochToPropose(long sid, long lastAcceptedEpoch) throws InterruptedException, IOException &#123;</span><br><span class="line">        synchronized(connectingFollowers) &#123;</span><br><span class="line">            if (!waitingForNewEpoch) &#123;</span><br><span class="line">                return epoch;</span><br><span class="line">            &#125;</span><br><span class="line">            //follower最新批次大于等于当前批次</span><br><span class="line">            if (lastAcceptedEpoch &gt;= epoch) &#123;</span><br><span class="line">                epoch = lastAcceptedEpoch+1;</span><br><span class="line">            &#125;</span><br><span class="line">            //已连接的follower集合</span><br><span class="line">            connectingFollowers.add(sid);</span><br><span class="line">            QuorumVerifier verifier = self.getQuorumVerifier();</span><br><span class="line">            //已连接的follower是否超过半数</span><br><span class="line">            if (connectingFollowers.contains(self.getId()) &amp;&amp;</span><br><span class="line">                                            verifier.containsQuorum(connectingFollowers)) &#123;</span><br><span class="line">                waitingForNewEpoch = false;</span><br><span class="line">                self.setAcceptedEpoch(epoch);</span><br><span class="line">                connectingFollowers.notifyAll();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //不超过半数，则等待其他follower接入</span><br><span class="line">                long start = Time.currentElapsedTime();</span><br><span class="line">                long cur = start;</span><br><span class="line">                long end = start + self.getInitLimit()*self.getTickTime();</span><br><span class="line">                while(waitingForNewEpoch &amp;&amp; cur &lt; end) &#123;</span><br><span class="line">                    connectingFollowers.wait(end - cur);</span><br><span class="line">                    cur = Time.currentElapsedTime();</span><br><span class="line">                &#125;</span><br><span class="line">                if (waitingForNewEpoch) &#123;</span><br><span class="line">                    throw new InterruptedException(&quot;Timeout while waiting for epoch from quorum&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return epoch;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（二、4）Leader的waitForEpochAck方法"><a href="#6、接（二、4）Leader的waitForEpochAck方法" class="headerlink" title="6、接（二、4）Leader的waitForEpochAck方法"></a>6、接（二、4）Leader的waitForEpochAck方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public void waitForEpochAck(long id, StateSummary ss) throws IOException, InterruptedException &#123;</span><br><span class="line">    synchronized(electingFollowers) &#123;</span><br><span class="line">        if (electionFinished) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (ss.getCurrentEpoch() != -1) &#123;</span><br><span class="line">            //follower的事务大于leader</span><br><span class="line">            if (ss.isMoreRecentThan(leaderStateSummary)) &#123;</span><br><span class="line">                throw new IOException(&quot;Follower is ahead of the leader, leader summary: &quot; </span><br><span class="line">                                                + leaderStateSummary.getCurrentEpoch()</span><br><span class="line">                                                + &quot; (current epoch), &quot;</span><br><span class="line">                                                + leaderStateSummary.getLastZxid()</span><br><span class="line">                                                + &quot; (last zxid)&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (ss.getLastZxid() != -1) &#123;</span><br><span class="line">                //已完成确认的follower的集合</span><br><span class="line">                electingFollowers.add(id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        QuorumVerifier verifier = self.getQuorumVerifier();</span><br><span class="line">        //是否有半数的follower完成确认</span><br><span class="line">        if (electingFollowers.contains(self.getId()) &amp;&amp; verifier.containsQuorum(electingFollowers)) &#123;</span><br><span class="line">            electionFinished = true;</span><br><span class="line">            electingFollowers.notifyAll();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            long start = Time.currentElapsedTime();</span><br><span class="line">            long cur = start;</span><br><span class="line">            long end = start + self.getInitLimit()*self.getTickTime();</span><br><span class="line">            while(!electionFinished &amp;&amp; cur &lt; end) &#123;</span><br><span class="line">                electingFollowers.wait(end - cur);</span><br><span class="line">                cur = Time.currentElapsedTime();</span><br><span class="line">            &#125;</span><br><span class="line">            if (!electionFinished) &#123;</span><br><span class="line">                throw new InterruptedException(&quot;Timeout while waiting for epoch to be acked by quorum&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（二、4）LearnerHandler的syncFollower方法"><a href="#7、接（二、4）LearnerHandler的syncFollower方法" class="headerlink" title="7、接（二、4）LearnerHandler的syncFollower方法"></a>7、接（二、4）LearnerHandler的syncFollower方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">public boolean syncFollower(long peerLastZxid, ZKDatabase db, Leader leader) &#123;</span><br><span class="line">    //follower的事务于leader一致</span><br><span class="line">    boolean isPeerNewEpochZxid = (peerLastZxid &amp; 0xffffffffL) == 0;</span><br><span class="line">    //follower的当前事务序号</span><br><span class="line">    long currentZxid = peerLastZxid;</span><br><span class="line">    boolean needSnap = true;</span><br><span class="line">    boolean txnLogSyncEnabled = db.isTxnLogSyncEnabled();</span><br><span class="line">    ReentrantReadWriteLock lock = db.getLogLock();</span><br><span class="line">    ReadLock rl = lock.readLock();</span><br><span class="line">    try &#123;</span><br><span class="line">        rl.lock();</span><br><span class="line">        long maxCommittedLog = db.getmaxCommittedLog();</span><br><span class="line">        long minCommittedLog = db.getminCommittedLog();</span><br><span class="line">        long lastProcessedZxid = db.getDataTreeLastProcessedZxid();</span><br><span class="line"></span><br><span class="line">        //最近一段时间内执行的事务</span><br><span class="line">        if (db.getCommittedLog().isEmpty()) &#123;</span><br><span class="line">            minCommittedLog = lastProcessedZxid;</span><br><span class="line">            maxCommittedLog = lastProcessedZxid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (forceSnapSync) &#123;</span><br><span class="line">            // Force leader to use snapshot to sync with follower</span><br><span class="line">            LOG.warn(&quot;Forcing snapshot sync - should not see this in production&quot;);</span><br><span class="line">        &#125; else if (lastProcessedZxid == peerLastZxid) &#123;</span><br><span class="line">            //follower的事务与leader相等，无需同步，将Leader.DIFF类型的数据包，加入待发送队列</span><br><span class="line">            queueOpPacket(Leader.DIFF, peerLastZxid);</span><br><span class="line">            needOpPacket = false;</span><br><span class="line">            needSnap = false;</span><br><span class="line">        &#125; else if (peerLastZxid &gt; maxCommittedLog &amp;&amp; !isPeerNewEpochZxid) &#123;</span><br><span class="line">            // follower事务序号超出了leader，废弃掉超出的部分</span><br><span class="line">            queueOpPacket(Leader.TRUNC, maxCommittedLog);</span><br><span class="line">            currentZxid = maxCommittedLog;</span><br><span class="line">            needOpPacket = false;</span><br><span class="line">            needSnap = false;</span><br><span class="line">        &#125; else if ((maxCommittedLog &gt;= peerLastZxid)</span><br><span class="line">                &amp;&amp; (minCommittedLog &lt;= peerLastZxid)) &#123;</span><br><span class="line">            //Follower的事务序号在CommittedLog之间</span><br><span class="line">            Iterator&lt;Proposal&gt; itr = db.getCommittedLog().iterator();</span><br><span class="line">            //向follower同步事务</span><br><span class="line">            currentZxid = queueCommittedProposals(itr, peerLastZxid,</span><br><span class="line">                                                 null, maxCommittedLog);</span><br><span class="line">            needSnap = false;</span><br><span class="line">        &#125; else if (peerLastZxid &lt; minCommittedLog &amp;&amp; txnLogSyncEnabled) &#123;</span><br><span class="line">            //从事务日志中可取回的事务的数量限制</span><br><span class="line">            long sizeLimit = db.calculateTxnLogSizeLimit();</span><br><span class="line">            //若peerLastZxid超出当前限制，则返回null</span><br><span class="line">            Iterator&lt;Proposal&gt; txnLogItr = db.getProposalsFromTxnLog(</span><br><span class="line">                    peerLastZxid, sizeLimit);</span><br><span class="line">            if (txnLogItr.hasNext()) &#123;</span><br><span class="line">                //同步事务</span><br><span class="line">                currentZxid = queueCommittedProposals(txnLogItr, peerLastZxid,</span><br><span class="line">                                                     minCommittedLog, maxCommittedLog);</span><br><span class="line"></span><br><span class="line">                //同步事务</span><br><span class="line">                Iterator&lt;Proposal&gt; committedLogItr = db.getCommittedLog().iterator();</span><br><span class="line">                currentZxid = queueCommittedProposals(committedLogItr, currentZxid,</span><br><span class="line">                                                     null, maxCommittedLog);</span><br><span class="line">                needSnap = false;</span><br><span class="line">            &#125;</span><br><span class="line">            // closing the resources</span><br><span class="line">            if (txnLogItr instanceof TxnLogProposalIterator) &#123;</span><br><span class="line">                TxnLogProposalIterator txnProposalItr = (TxnLogProposalIterator) txnLogItr;</span><br><span class="line">                txnProposalItr.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            LOG.warn(&quot;Unhandled scenario for peer sid: &quot; +  getSid());</span><br><span class="line">        &#125;</span><br><span class="line">        //处理leader中未完成的事务，将handler加入集合</span><br><span class="line">        leaderLastZxid = leader.startForwarding(this, currentZxid);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        rl.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (needOpPacket &amp;&amp; !needSnap) &#123;</span><br><span class="line">        // This should never happen, but we should fall back to sending</span><br><span class="line">        // snapshot just in case. 事务同步失败，直接同步快照</span><br><span class="line">        needSnap = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return needSnap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、LearnerHandler的queueCommittedProposals方法"><a href="#8、LearnerHandler的queueCommittedProposals方法" class="headerlink" title="8、LearnerHandler的queueCommittedProposals方法"></a>8、LearnerHandler的queueCommittedProposals方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">protected long queueCommittedProposals(Iterator&lt;Proposal&gt; itr,</span><br><span class="line">        long peerLastZxid, Long maxZxid, Long lastCommittedZxid) &#123;</span><br><span class="line">    //follower的事务序号，已更新为最新</span><br><span class="line">    boolean isPeerNewEpochZxid = (peerLastZxid &amp; 0xffffffffL) == 0;</span><br><span class="line">    long queuedZxid = peerLastZxid;</span><br><span class="line">    // as we look through proposals, this variable keeps track of previous</span><br><span class="line">    // proposal Id.</span><br><span class="line">    long prevProposalZxid = -1;</span><br><span class="line">    while (itr.hasNext()) &#123;</span><br><span class="line">        //取出下个事务</span><br><span class="line">        Proposal propose = itr.next();</span><br><span class="line"></span><br><span class="line">        long packetZxid = propose.packet.getZxid();</span><br><span class="line">        //同步事务序号的上限</span><br><span class="line">        if ((maxZxid != null) &amp;&amp; (packetZxid &gt; maxZxid)) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        // 小于follower的事务无需同步</span><br><span class="line">        if (packetZxid &lt; peerLastZxid) &#123;</span><br><span class="line">            prevProposalZxid = packetZxid;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //默认true</span><br><span class="line">        if (needOpPacket) &#123;</span><br><span class="line"></span><br><span class="line">            // follower同步完成</span><br><span class="line">            if (packetZxid == peerLastZxid) &#123;</span><br><span class="line">                //通知follower，无需同步snaphot</span><br><span class="line">                queueOpPacket(Leader.DIFF, lastCommittedZxid);</span><br><span class="line">                needOpPacket = false;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //follower事务序号为最新批次序号，无需同步</span><br><span class="line">            if (isPeerNewEpochZxid) &#123;</span><br><span class="line">               queueOpPacket(Leader.DIFF, lastCommittedZxid);</span><br><span class="line">               needOpPacket = false;</span><br><span class="line">            &#125; else if (packetZxid &gt; peerLastZxid  ) &#123;</span><br><span class="line">                //不是同一批次，无法同步</span><br><span class="line">                if (ZxidUtils.getEpochFromZxid(packetZxid) !=</span><br><span class="line">                        ZxidUtils.getEpochFromZxid(peerLastZxid)) &#123;</span><br><span class="line">                    return queuedZxid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                //废弃掉follower的peerLastZxid之后的事务</span><br><span class="line">                queueOpPacket(Leader.TRUNC, prevProposalZxid);</span><br><span class="line">                needOpPacket = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (packetZxid &lt;= queuedZxid) &#123;</span><br><span class="line">            // We can get here, if we don&apos;t have op packet to queue</span><br><span class="line">            // or there is a duplicate txn in a given iterator</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //向follower发出事务提议</span><br><span class="line">        queuePacket(propose.packet);</span><br><span class="line">        //向follower发出事务确认</span><br><span class="line">        queueOpPacket(Leader.COMMIT, packetZxid);</span><br><span class="line">        queuedZxid = packetZxid;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (needOpPacket &amp;&amp; isPeerNewEpochZxid) &#123;</span><br><span class="line">        queueOpPacket(Leader.DIFF, lastCommittedZxid);</span><br><span class="line">        needOpPacket = false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return queuedZxid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（二、7）Leader的startForwarding方法"><a href="#9、接（二、7）Leader的startForwarding方法" class="headerlink" title="9、接（二、7）Leader的startForwarding方法"></a>9、接（二、7）Leader的startForwarding方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">synchronized public long startForwarding(LearnerHandler handler,</span><br><span class="line">        long lastSeenZxid) &#123;</span><br><span class="line">    //leader有尚未</span><br><span class="line">    if (lastProposed &gt; lastSeenZxid) &#123;</span><br><span class="line">        //leader中完成投票，并未commit的事务</span><br><span class="line">        for (Proposal p : toBeApplied) &#123;</span><br><span class="line">            if (p.packet.getZxid() &lt;= lastSeenZxid) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            handler.queuePacket(p.packet);</span><br><span class="line">            QuorumPacket qp = new QuorumPacket(Leader.COMMIT, p.packet</span><br><span class="line">                    .getZxid(), null, null);</span><br><span class="line">            handler.queuePacket(qp);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (handler.getLearnerType() == LearnerType.PARTICIPANT) &#123;</span><br><span class="line">            //尚未投票通过的提议</span><br><span class="line">            List&lt;Long&gt;zxids = new ArrayList&lt;Long&gt;(outstandingProposals.keySet());</span><br><span class="line">            Collections.sort(zxids);</span><br><span class="line">            for (Long zxid: zxids) &#123;</span><br><span class="line">                if (zxid &lt;= lastSeenZxid) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                handler.queuePacket(outstandingProposals.get(zxid).packet);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (handler.getLearnerType() == LearnerType.PARTICIPANT) </span><br><span class="line">        addForwardingFollower(handler);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        addObserverLearnerHandler(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return lastProposed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（二、2）Leader的startZkServer方法"><a href="#10、接（二、2）Leader的startZkServer方法" class="headerlink" title="10、接（二、2）Leader的startZkServer方法"></a>10、接（二、2）Leader的startZkServer方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private synchronized void startZkServer() &#123;</span><br><span class="line">    // Update lastCommitted and Db&apos;s zxid to a value representing the new epoch</span><br><span class="line">    lastCommitted = zk.getZxid();</span><br><span class="line"></span><br><span class="line">    QuorumVerifier newQV = self.getLastSeenQuorumVerifier();</span><br><span class="line">    </span><br><span class="line">    //获取最合适的备用Leader服务器的id</span><br><span class="line">    Long designatedLeader = getDesignatedLeader(newLeaderProposal, zk.getZxid());                                         </span><br><span class="line"></span><br><span class="line">    self.processReconfig(newQV, designatedLeader, zk.getZxid(), true);</span><br><span class="line">    if (designatedLeader != self.getId()) &#123;</span><br><span class="line">        allowedToCommit = false;</span><br><span class="line">    &#125;</span><br><span class="line">    //启动leader服务器</span><br><span class="line">    zk.startup();</span><br><span class="line">    self.updateElectionVote(getEpoch());</span><br><span class="line"></span><br><span class="line">    zk.getZKDatabase().setlastProcessedZxid(zk.getZxid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、ZooKeeperServer的startup方法"><a href="#11、ZooKeeperServer的startup方法" class="headerlink" title="11、ZooKeeperServer的startup方法"></a>11、ZooKeeperServer的startup方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  public synchronized void startup() &#123;</span><br><span class="line">    if (sessionTracker == null) &#123;</span><br><span class="line">        createSessionTracker();</span><br><span class="line">    &#125;</span><br><span class="line">    startSessionTracker();</span><br><span class="line">    //启动处理器</span><br><span class="line">    setupRequestProcessors();</span><br><span class="line"></span><br><span class="line">    registerJMX();</span><br><span class="line"></span><br><span class="line">    setState(State.RUNNING);</span><br><span class="line">    notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、LeaderZooKeeperServer的setupRequestProcessors方法"><a href="#12、LeaderZooKeeperServer的setupRequestProcessors方法" class="headerlink" title="12、LeaderZooKeeperServer的setupRequestProcessors方法"></a>12、LeaderZooKeeperServer的setupRequestProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void setupRequestProcessors() &#123;</span><br><span class="line">    RequestProcessor finalProcessor = new FinalRequestProcessor(this);</span><br><span class="line">    RequestProcessor toBeAppliedProcessor = new Leader.ToBeAppliedRequestProcessor(finalProcessor, getLeader());</span><br><span class="line">    commitProcessor = new CommitProcessor(toBeAppliedProcessor,</span><br><span class="line">            Long.toString(getServerId()), false,</span><br><span class="line">            getZooKeeperServerListener());</span><br><span class="line">    commitProcessor.start();</span><br><span class="line">    ProposalRequestProcessor proposalProcessor = new ProposalRequestProcessor(this,</span><br><span class="line">            commitProcessor);</span><br><span class="line">    proposalProcessor.initialize();</span><br><span class="line">    prepRequestProcessor = new PrepRequestProcessor(this, proposalProcessor);</span><br><span class="line">    prepRequestProcessor.start();</span><br><span class="line">    firstProcessor = new LeaderRequestProcessor(this, prepRequestProcessor);</span><br><span class="line"></span><br><span class="line">    setupContainerManager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>leader初始化结束</p>
<p>###三、FOLLOWER初始化过程</p>
<h4 id="1、FOLLOWER的followLeader方法"><a href="#1、FOLLOWER的followLeader方法" class="headerlink" title="1、FOLLOWER的followLeader方法"></a>1、FOLLOWER的followLeader方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">void followLeader() throws InterruptedException &#123;</span><br><span class="line">        self.end_fle = Time.currentElapsedTime();</span><br><span class="line">        long electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">        self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">        self.start_fle = 0;</span><br><span class="line">        self.end_fle = 0;</span><br><span class="line">        fzk.registerJMX(new FollowerBean(this, zk), self.jmxLocalPeerBean);</span><br><span class="line">        try &#123;</span><br><span class="line">            //找到leader服务器id</span><br><span class="line">            QuorumServer leaderServer = findLeader();</span><br><span class="line">            try &#123;</span><br><span class="line">                //连接leader服务器</span><br><span class="line">                connectToLeader(leaderServer.addr, leaderServer.hostname);</span><br><span class="line">                //follower注册到leader服务器，返回leader最新的事务zxid</span><br><span class="line">                long newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO);</span><br><span class="line"></span><br><span class="line">                //check to see if the leader zxid is lower than ours</span><br><span class="line">                //this should never happen but is just a safety check</span><br><span class="line">                long newEpoch = ZxidUtils.getEpochFromZxid(newEpochZxid);</span><br><span class="line">                if (newEpoch &lt; self.getAcceptedEpoch()) &#123;</span><br><span class="line">                    LOG.error(&quot;Proposed leader epoch &quot; + ZxidUtils.zxidToString(newEpochZxid)</span><br><span class="line">                            + &quot; is less than our accepted epoch &quot; + ZxidUtils.zxidToString(self.getAcceptedEpoch()));</span><br><span class="line">                    throw new IOException(&quot;Error: Epoch of leader is lower&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //和Leader同步数据</span><br><span class="line">                syncWithLeader(newEpochZxid);                </span><br><span class="line">                QuorumPacket qp = new QuorumPacket();</span><br><span class="line">                //主循环</span><br><span class="line">                while (this.isRunning()) &#123;</span><br><span class="line">                    readPacket(qp);</span><br><span class="line">                    processPacket(qp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                ...</span><br><span class="line">                // clear pending revalidations</span><br><span class="line">                pendingRevalidations.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            zk.unregisterJMX((Learner)this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、FOLLOWER的registerWithLeader方法"><a href="#2、FOLLOWER的registerWithLeader方法" class="headerlink" title="2、FOLLOWER的registerWithLeader方法"></a>2、FOLLOWER的registerWithLeader方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">protected long registerWithLeader(int pktType) throws IOException&#123;</span><br><span class="line">    //将follower的事务序号及follower的id</span><br><span class="line">    long lastLoggedZxid = self.getLastLoggedZxid();</span><br><span class="line">    QuorumPacket qp = new QuorumPacket();                </span><br><span class="line">    qp.setType(pktType);</span><br><span class="line">    qp.setZxid(ZxidUtils.makeZxid(self.getAcceptedEpoch(), 0));</span><br><span class="line"></span><br><span class="line">    //Add sid to payload</span><br><span class="line">    LearnerInfo li = new LearnerInfo(self.getId(), 0x10000, self.getQuorumVerifier().getVersion());</span><br><span class="line">    ByteArrayOutputStream bsid = new ByteArrayOutputStream();</span><br><span class="line">    BinaryOutputArchive boa = BinaryOutputArchive.getArchive(bsid);</span><br><span class="line">    boa.writeRecord(li, &quot;LearnerInfo&quot;);</span><br><span class="line">    qp.setData(bsid.toByteArray());</span><br><span class="line">    //发送数据包</span><br><span class="line">    writePacket(qp, true);</span><br><span class="line">    //读取返回信息</span><br><span class="line">    readPacket(qp);        </span><br><span class="line">    final long newEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line">    if (qp.getType() == Leader.LEADERINFO) &#123;</span><br><span class="line">        // we are connected to a 1.0 server so accept the new epoch and read the next packet</span><br><span class="line">        leaderProtocolVersion = ByteBuffer.wrap(qp.getData()).getInt();</span><br><span class="line">        byte epochBytes[] = new byte[4];</span><br><span class="line">        final ByteBuffer wrappedEpochBytes = ByteBuffer.wrap(epochBytes);</span><br><span class="line">        if (newEpoch &gt; self.getAcceptedEpoch()) &#123;</span><br><span class="line">            //更新事务批次</span><br><span class="line">            wrappedEpochBytes.putInt((int)self.getCurrentEpoch());</span><br><span class="line">            self.setAcceptedEpoch(newEpoch);</span><br><span class="line">        &#125; else if (newEpoch == self.getAcceptedEpoch()) &#123;</span><br><span class="line">            wrappedEpochBytes.putInt(-1);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new IOException(&quot;Leaders epoch, &quot; + newEpoch + &quot; is less than accepted epoch, &quot; + self.getAcceptedEpoch());</span><br><span class="line">        &#125;</span><br><span class="line">        QuorumPacket ackNewEpoch = new QuorumPacket(Leader.ACKEPOCH, lastLoggedZxid, epochBytes, null);</span><br><span class="line">        writePacket(ackNewEpoch, true);</span><br><span class="line">        //返回leader的最新事务zxid</span><br><span class="line">        return ZxidUtils.makeZxid(newEpoch, 0);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (newEpoch &gt; self.getAcceptedEpoch()) &#123;</span><br><span class="line">            //更新事务批次</span><br><span class="line">            self.setAcceptedEpoch(newEpoch);</span><br><span class="line">        &#125;</span><br><span class="line">        if (qp.getType() != Leader.NEWLEADER) &#123;</span><br><span class="line">            LOG.error(&quot;First packet should have been NEWLEADER&quot;);</span><br><span class="line">            throw new IOException(&quot;First packet should have been NEWLEADER&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //返回leader的最新事务zxid</span><br><span class="line">        return qp.getZxid();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、接（三、1）FOLLOWER的syncWithLeader方法"><a href="#3、接（三、1）FOLLOWER的syncWithLeader方法" class="headerlink" title="3、接（三、1）FOLLOWER的syncWithLeader方法"></a>3、接（三、1）FOLLOWER的syncWithLeader方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">protected void syncWithLeader(long newLeaderZxid) throws Exception&#123;</span><br><span class="line">    QuorumPacket ack = new QuorumPacket(Leader.ACK, 0, null, null);</span><br><span class="line">    QuorumPacket qp = new QuorumPacket();</span><br><span class="line">    long newEpoch = ZxidUtils.getEpochFromZxid(newLeaderZxid);</span><br><span class="line">    </span><br><span class="line">    QuorumVerifier newLeaderQV = null;</span><br><span class="line">    </span><br><span class="line">    boolean snapshotNeeded = true;</span><br><span class="line">    boolean syncSnapshot = false;</span><br><span class="line">    readPacket(qp);</span><br><span class="line">    LinkedList&lt;Long&gt; packetsCommitted = new LinkedList&lt;Long&gt;();</span><br><span class="line">    LinkedList&lt;PacketInFlight&gt; packetsNotCommitted = new LinkedList&lt;PacketInFlight&gt;();</span><br><span class="line">    synchronized (zk) &#123;</span><br><span class="line">        if (qp.getType() == Leader.DIFF) &#123;</span><br><span class="line">            //无需同步snaphot</span><br><span class="line">            snapshotNeeded = false;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (qp.getType() == Leader.SNAP) &#123;</span><br><span class="line">            //Leader给follower发送的是SNAP文件</span><br><span class="line">            //follower将SNAP文件替换到内存</span><br><span class="line">            zk.getZKDatabase().deserializeSnapshot(leaderIs);</span><br><span class="line">            ...</span><br><span class="line">            zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());</span><br><span class="line"></span><br><span class="line">            syncSnapshot = true;</span><br><span class="line">        &#125; else if (qp.getType() == Leader.TRUNC) &#123;</span><br><span class="line">            //follower废弃大于Zxid的事务</span><br><span class="line">            boolean truncated=zk.getZKDatabase().truncateLog(qp.getZxid());</span><br><span class="line">            zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        zk.getZKDatabase().initConfigInZKDatabase(self.getQuorumVerifier());</span><br><span class="line">        //创建Session管理器</span><br><span class="line">        zk.createSessionTracker();            </span><br><span class="line">        long lastQueued = 0;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        boolean isPreZAB1_0 = true;</span><br><span class="line">        //同步SNAP则不需要同步事务</span><br><span class="line">        boolean writeToTxnLog = !snapshotNeeded;</span><br><span class="line">        //开始同步事务</span><br><span class="line">        outerLoop:</span><br><span class="line">        while (self.isRunning()) &#123;</span><br><span class="line">            readPacket(qp);</span><br><span class="line">            switch(qp.getType()) &#123;</span><br><span class="line">            case Leader.PROPOSAL:</span><br><span class="line">                //leader发来的提议</span><br><span class="line">                PacketInFlight pif = new PacketInFlight();</span><br><span class="line">                pif.hdr = new TxnHeader();</span><br><span class="line">                pif.rec = SerializeUtils.deserializeTxn(qp.getData(), pif.hdr);</span><br><span class="line">                //加入到未commit队列</span><br><span class="line">                packetsNotCommitted.add(pif);</span><br><span class="line">                break;</span><br><span class="line">            case Leader.COMMIT:</span><br><span class="line">            case Leader.COMMITANDACTIVATE:</span><br><span class="line">                pif = packetsNotCommitted.peekFirst();</span><br><span class="line">                //已同步snaphot则不需同步事务</span><br><span class="line">                if (!writeToTxnLog) &#123;</span><br><span class="line">                    if (pif.hdr.getZxid() != qp.getZxid()) &#123;</span><br><span class="line">                        LOG.warn(&quot;Committing &quot; + qp.getZxid() + &quot;, but next proposal is &quot; + pif.hdr.getZxid());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        //事务处理到内存db</span><br><span class="line">                        zk.processTxn(pif.hdr, pif.rec);</span><br><span class="line">                        packetsNotCommitted.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    packetsCommitted.add(qp.getZxid());</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            case Leader.INFORM:</span><br><span class="line">            case Leader.INFORMANDACTIVATE:</span><br><span class="line">                ...                   </span><br><span class="line">                break;                </span><br><span class="line">            case Leader.UPTODATE:</span><br><span class="line">                ...</span><br><span class="line">                self.setZooKeeperServer(zk);</span><br><span class="line">                self.adminServer.setZooKeeperServer(zk);</span><br><span class="line">                //跳出同步数据循环</span><br><span class="line">                break outerLoop;</span><br><span class="line">            case Leader.NEWLEADER: // Getting NEWLEADER here instead of in discovery </span><br><span class="line">                // means this is Zab 1.0</span><br><span class="line">               if (qp.getData()!=null &amp;&amp; qp.getData().length &gt; 1) &#123;</span><br><span class="line">                   try &#123;                       </span><br><span class="line">                       QuorumVerifier qv = self.configFromString(new String(qp.getData()));</span><br><span class="line">                       self.setLastSeenQuorumVerifier(qv, true);</span><br><span class="line">                       newLeaderQV = qv;</span><br><span class="line">                   &#125; catch (Exception e) &#123;</span><br><span class="line">                       e.printStackTrace();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               //将从leader获取到的内存文件保存到磁盘</span><br><span class="line">               if (snapshotNeeded) &#123;</span><br><span class="line">                   zk.takeSnapshot(syncSnapshot);</span><br><span class="line">               &#125;</span><br><span class="line">               </span><br><span class="line">                self.setCurrentEpoch(newEpoch);</span><br><span class="line">                writeToTxnLog = true; //Anything after this needs to go to the transaction log, not applied directly in memory</span><br><span class="line">                isPreZAB1_0 = false;</span><br><span class="line">                //同步数据完成给leader发送确认信息</span><br><span class="line">                writePacket(new QuorumPacket(Leader.ACK, newLeaderZxid, null, null), true);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ack.setZxid(ZxidUtils.makeZxid(newEpoch, 0));</span><br><span class="line">    //同步数据完成给leader发送确认信息</span><br><span class="line">    writePacket(ack, true);</span><br><span class="line">    sock.setSoTimeout(self.tickTime * self.syncLimit);</span><br><span class="line">    //启动FollowerZooKeeperServer</span><br><span class="line">    zk.startup();</span><br><span class="line">    //更新选票事务批次</span><br><span class="line">    self.updateElectionVote(newEpoch);</span><br><span class="line"></span><br><span class="line">    // We need to log the stuff that came in between the snapshot and the uptodate</span><br><span class="line">    if (zk instanceof FollowerZooKeeperServer) &#123;</span><br><span class="line">        FollowerZooKeeperServer fzk = (FollowerZooKeeperServer)zk;</span><br><span class="line">        //处理未投票事务</span><br><span class="line">        for(PacketInFlight p: packetsNotCommitted) &#123;</span><br><span class="line">            fzk.logRequest(p.hdr, p.rec);</span><br><span class="line">        &#125;</span><br><span class="line">        for(Long zxid: packetsCommitted) &#123;</span><br><span class="line">            //处理已投票事务</span><br><span class="line">            fzk.commit(zxid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (zk instanceof ObserverZooKeeperServer) &#123;</span><br><span class="line">        ObserverZooKeeperServer ozk = (ObserverZooKeeperServer) zk;</span><br><span class="line">        for (PacketInFlight p : packetsNotCommitted) &#123;</span><br><span class="line">            Long zxid = packetsCommitted.peekFirst();</span><br><span class="line">            if (p.hdr.getZxid() != zxid) &#123;</span><br><span class="line">                // log warning message if there is no matching commit</span><br><span class="line">                // old leader send outstanding proposal to observer</span><br><span class="line">                LOG.warn(&quot;Committing &quot; + Long.toHexString(zxid)</span><br><span class="line">                        + &quot;, but next proposal is &quot;</span><br><span class="line">                        + Long.toHexString(p.hdr.getZxid()));</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            packetsCommitted.remove();</span><br><span class="line">            Request request = new Request(null, p.hdr.getClientId(),</span><br><span class="line">                    p.hdr.getCxid(), p.hdr.getType(), null, null);</span><br><span class="line">            request.setTxn(p.rec);</span><br><span class="line">            request.setHdr(p.hdr);</span><br><span class="line">            ozk.commitRequest(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // New server type need to handle in-flight packets</span><br><span class="line">        throw new UnsupportedOperationException(&quot;Unknown server type&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、FollowerZooKeeperServer的setupRequestProcessors方法"><a href="#2、FollowerZooKeeperServer的setupRequestProcessors方法" class="headerlink" title="2、FollowerZooKeeperServer的setupRequestProcessors方法"></a>2、FollowerZooKeeperServer的setupRequestProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void setupRequestProcessors() &#123;</span><br><span class="line">    RequestProcessor finalProcessor = new FinalRequestProcessor(this);</span><br><span class="line">    commitProcessor = new CommitProcessor(finalProcessor,</span><br><span class="line">            Long.toString(getServerId()), true, getZooKeeperServerListener());</span><br><span class="line">    commitProcessor.start();</span><br><span class="line">    firstProcessor = new FollowerRequestProcessor(this, commitProcessor);</span><br><span class="line">    ((FollowerRequestProcessor) firstProcessor).start();</span><br><span class="line">    syncProcessor = new SyncRequestProcessor(this,</span><br><span class="line">            new SendAckRequestProcessor((Learner)getFollower()));</span><br><span class="line">    syncProcessor.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>follower的初始化，到这儿就结束了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/07/zookeeper源码/zookeeper源码分布式服务端（1）/" data-id="cjix615gb001fosue512z4jb3" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/07/zookeeper源码/zookeeper源码分布式服务端（2）/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          zookeeper源码分布式服务端（2）
        
      </div>
    </a>
  
  
    <a href="/2018/02/21/helloworld/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java-util-concurrent/">java.util.concurrent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis3/">mybatis3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码整合MyBatis/">spring源码整合MyBatis</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(2) /">spring源码XmlBeanFactory(2)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(1)/">spring源码XmlBeanFactory(1)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码Transaction/">spring源码Transaction</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码SpringMVC/">spring源码SpringMVC</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>