<!DOCTYPE html>
<html lang="default">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="demo12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849//整个Tomcat容器,port为接受shutdown指令的端口号&amp;lt;Server port=&amp;quot;8"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Tomcat源码启动过程"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="demo12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849//整个Tomcat容器,port为接受shutdown指令的端口号&amp;lt;Server port=&amp;quot;8"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>Tomcat源码启动过程 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Tomcat源码启动过程</h1>
                    
                    <h2 class="post-subheading">
                        容器及连接器启动过程
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-07-11
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/tomcat/">tomcat</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">//整个Tomcat容器,port为接受shutdown指令的端口号</span><br><span class="line">&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">    //Tomcat启动时，该监听器记录Tomcat、Java和操作系统的信息。该监听器必须是配置的第一个监听器。</span><br><span class="line">    &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;</span><br><span class="line">    //Tomcat启动时，检查APR库，如果存在则加载。APR，即Apache Portable Runtime</span><br><span class="line">    &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;</span><br><span class="line">    //在Web应用启动之前初始化Jasper，Jasper是JSP引擎，把JVM不认识的JSP文件解析成java文件，</span><br><span class="line">    //然后编译成class文件供JVM使用</span><br><span class="line">    &lt;Listener className=&quot;org.apache.catalina.core.JasperListener&quot; /&gt;</span><br><span class="line">    //与类加载器导致的内存泄露有关</span><br><span class="line">    &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;</span><br><span class="line">    //通过该监听器，初始化&lt; GlobalNamingResources&gt;标签中定义的全局JNDI资源</span><br><span class="line">    &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;</span><br><span class="line">    //当Web应用因thread-local导致的内存泄露而要停止时，该监听器会触发线程池中线程的更新</span><br><span class="line">    &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;</span><br><span class="line">    //定义的全局JNDI资源</span><br><span class="line">    &lt;GlobalNamingResources&gt;</span><br><span class="line">        &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;</span><br><span class="line">                 type=&quot;org.apache.catalina.UserDatabase&quot;</span><br><span class="line">                 description=&quot;User database that can be updated and saved&quot;</span><br><span class="line">                 factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span><br><span class="line">                 pathname=&quot;conf/tomcat-users.xml&quot; /&gt;</span><br><span class="line">    &lt;/GlobalNamingResources&gt;</span><br><span class="line">    //Service的作用，是在Connector和Engine外面包了一层,Tomcat可以提供多个Service</span><br><span class="line">    &lt;Service name=&quot;Catalina&quot;&gt;</span><br><span class="line">        //连接器，客户端可以通过8080端口号使用http协议访问Tomcat</span><br><span class="line">        &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">                  connectionTimeout=&quot;20000&quot;</span><br><span class="line">                  redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">        //连接器，客户端可以通过8009端口号使用AJP协议访问Tomcat</span><br><span class="line">        &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line">        //Engine是Service组件中的请求处理组件</span><br><span class="line">        &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</span><br><span class="line">            //Realm提供了一种用户密码与web应用的映射关系，从而达到角色安全管理的作用</span><br><span class="line">            &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</span><br><span class="line">            &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span><br><span class="line">                  resourceName=&quot;UserDatabase&quot;/&gt;</span><br><span class="line">            &lt;/Realm&gt;</span><br><span class="line">            //每个Host组件代表Engine中的一个虚拟主机</span><br><span class="line">            &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">                  unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">                //AccessLogValve的作用是通过日志记录其所在的容器中处理的所有请求</span><br><span class="line">                &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">                      prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">                      pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line">            &lt;/Host&gt;</span><br><span class="line">        &lt;/Engine&gt;</span><br><span class="line">    &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br></pre></td></tr></table></figure>
<p>配置文件详解参考<a href="https://www.cnblogs.com/kismetv/p/7228274.html#title5-2" target="_blank" rel="noopener">https://www.cnblogs.com/kismetv/p/7228274.html#title5-2</a> </p>
<h3 id="一、容器启动过程"><a href="#一、容器启动过程" class="headerlink" title="一、容器启动过程"></a>一、容器启动过程</h3><h4 id="1、Bootstrap的main方法"><a href="#1、Bootstrap的main方法" class="headerlink" title="1、Bootstrap的main方法"></a>1、Bootstrap的main方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String args[]) &#123;</span><br><span class="line">    //创建Bootstrap</span><br><span class="line">    if (daemon == null) &#123;</span><br><span class="line">        // Don&apos;t set daemon until init() has completed</span><br><span class="line">        Bootstrap bootstrap = new Bootstrap();</span><br><span class="line">        try &#123;</span><br><span class="line">            //初始化bootstrap</span><br><span class="line">            bootstrap.init();</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        daemon = bootstrap;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // When running as a service the call to stop will be on a new</span><br><span class="line">        // thread so make sure the correct class loader is used to prevent</span><br><span class="line">        // a range of class not found exceptions.</span><br><span class="line">        //设置初始化tomcat环境类加载器</span><br><span class="line">        Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        String command = &quot;start&quot;;</span><br><span class="line">        if (args.length &gt; 0) &#123;</span><br><span class="line">            command = args[args.length - 1];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (command.equals(&quot;startd&quot;)) &#123;</span><br><span class="line">            args[args.length - 1] = &quot;start&quot;;</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">        &#125; else if (command.equals(&quot;stopd&quot;)) &#123;</span><br><span class="line">            args[args.length - 1] = &quot;stop&quot;;</span><br><span class="line">            daemon.stop();</span><br><span class="line">        &#125; else if (command.equals(&quot;start&quot;)) &#123;</span><br><span class="line">            //设置Catalina的await为true,阻塞主线程</span><br><span class="line">            daemon.setAwait(true);</span><br><span class="line">            //加载配置文件，初始化容器</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            //启动容器</span><br><span class="line">            daemon.start();</span><br><span class="line">        &#125; else if (command.equals(&quot;stop&quot;)) &#123;</span><br><span class="line">            //关闭Server</span><br><span class="line">            daemon.stopServer(args);</span><br><span class="line">        &#125; else if (command.equals(&quot;configtest&quot;)) &#123;</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            if (null==daemon.getServer()) &#123;</span><br><span class="line">                System.exit(1);</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(0);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            log.warn(&quot;Bootstrap: command \&quot;&quot; + command + &quot;\&quot; does not exist.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        // Unwrap the Exception for clearer error reporting</span><br><span class="line">        if (t instanceof InvocationTargetException &amp;&amp;</span><br><span class="line">                t.getCause() != null) &#123;</span><br><span class="line">            t = t.getCause();</span><br><span class="line">        &#125;</span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        t.printStackTrace();</span><br><span class="line">        System.exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、Bootstrap的init方法"><a href="#2、Bootstrap的init方法" class="headerlink" title="2、Bootstrap的init方法"></a>2、Bootstrap的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public void init() throws Exception &#123;</span><br><span class="line">    //初始化tomcat环境类加载器</span><br><span class="line">    initClassLoaders();</span><br><span class="line">    //设置初始化tomcat环境类加载器</span><br><span class="line">    Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line">    //加载tomcat环境</span><br><span class="line">    SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    // Load our startup class and call its process() method</span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Loading startup class&quot;);</span><br><span class="line">    //加载Catalina类</span><br><span class="line">    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(&quot;org.apache.catalina.startup.Catalina&quot;);</span><br><span class="line">    //实例化Catalina</span><br><span class="line">    Object startupInstance = startupClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    // Set the shared extensions class loader</span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Setting startup class properties&quot;);</span><br><span class="line">    String methodName = &quot;setParentClassLoader&quot;;</span><br><span class="line">    Class&lt;?&gt; paramTypes[] = new Class[1];</span><br><span class="line">    paramTypes[0] = Class.forName(&quot;java.lang.ClassLoader&quot;);</span><br><span class="line">    Object paramValues[] = new Object[1];</span><br><span class="line">    paramValues[0] = sharedLoader;</span><br><span class="line">    Method method =</span><br><span class="line">        startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    //为Catalina设置类加载器</span><br><span class="line">    method.invoke(startupInstance, paramValues);</span><br><span class="line">    //初始化catalinaDaemon</span><br><span class="line">    catalinaDaemon = startupInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、Bootstrap的initClassLoaders方法"><a href="#3、Bootstrap的initClassLoaders方法" class="headerlink" title="3、Bootstrap的initClassLoaders方法"></a>3、Bootstrap的initClassLoaders方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void initClassLoaders() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        //创建tomcat环境加载器</span><br><span class="line">        commonLoader = createClassLoader(&quot;common&quot;, null);</span><br><span class="line">        if( commonLoader == null ) &#123;</span><br><span class="line">            // no config file, default to this loader - we might be in a &apos;single&apos; env.</span><br><span class="line">            commonLoader=this.getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        //未配置</span><br><span class="line">        catalinaLoader = createClassLoader(&quot;server&quot;, commonLoader);</span><br><span class="line">        //未配置</span><br><span class="line">        sharedLoader = createClassLoader(&quot;shared&quot;, commonLoader);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        log.error(&quot;Class loader creation threw exception&quot;, t);</span><br><span class="line">        System.exit(1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>catalina.properties中配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">common.loader=&quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、接（一、1）Bootstrap的load方法"><a href="#4、接（一、1）Bootstrap的load方法" class="headerlink" title="4、接（一、1）Bootstrap的load方法"></a>4、接（一、1）Bootstrap的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private void load(String[] arguments)</span><br><span class="line">    throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    // Call the load() method</span><br><span class="line">    String methodName = &quot;load&quot;;</span><br><span class="line">    Object param[];</span><br><span class="line">    Class&lt;?&gt; paramTypes[];</span><br><span class="line">    if (arguments==null || arguments.length==0) &#123;</span><br><span class="line">        paramTypes = null;</span><br><span class="line">        param = null;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        paramTypes = new Class[1];</span><br><span class="line">        paramTypes[0] = arguments.getClass();</span><br><span class="line">        param = new Object[1];</span><br><span class="line">        param[0] = arguments;</span><br><span class="line">    &#125;</span><br><span class="line">    Method method =</span><br><span class="line">        catalinaDaemon.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;Calling startup class &quot; + method);</span><br><span class="line">    //执行Catalina的load方法</span><br><span class="line">    method.invoke(catalinaDaemon, param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、Catalina的load方法"><a href="#5、Catalina的load方法" class="headerlink" title="5、Catalina的load方法"></a>5、Catalina的load方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">public void load() &#123;</span><br><span class="line">    //已load，直接退出</span><br><span class="line">    if (loaded) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    loaded = true;</span><br><span class="line"></span><br><span class="line">    long t1 = System.nanoTime();</span><br><span class="line">    //查看临时文件夹是否存在</span><br><span class="line">    initDirs();</span><br><span class="line"></span><br><span class="line">    // Before digester - it may be needed</span><br><span class="line">    //初始化命名系统</span><br><span class="line">    initNaming();</span><br><span class="line"></span><br><span class="line">    // Create and execute our Digester</span><br><span class="line">    //创建配置文件解析器</span><br><span class="line">    Digester digester = createStartDigester();</span><br><span class="line"></span><br><span class="line">    InputSource inputSource = null;</span><br><span class="line">    InputStream inputStream = null;</span><br><span class="line">    File file = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取配置文件&quot;conf/server.xml&quot;</span><br><span class="line">            file = configFile();</span><br><span class="line">            //获取输入流</span><br><span class="line">            inputStream = new FileInputStream(file);</span><br><span class="line">            inputSource = new InputSource(file.toURI().toURL().toString());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            if (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(sm.getString(&quot;catalina.configFail&quot;, file), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        try &#123;</span><br><span class="line">            //设置输入流</span><br><span class="line">            inputSource.setByteStream(inputStream);</span><br><span class="line">            digester.push(this);</span><br><span class="line">            //解析配置文件</span><br><span class="line">            digester.parse(inputSource);</span><br><span class="line">        &#125; catch (SAXParseException spe) &#123;</span><br><span class="line">            log.warn(&quot;Catalina.start using &quot; + getConfigFile() + &quot;: &quot; +</span><br><span class="line">                    spe.getMessage());</span><br><span class="line">            return;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.warn(&quot;Catalina.start using &quot; + getConfigFile() + &quot;: &quot; , e);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (inputStream != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                // Ignore</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置Catalina</span><br><span class="line">    getServer().setCatalina(this);</span><br><span class="line">    //设置catalina.home</span><br><span class="line">    getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">    //设置catalina.base</span><br><span class="line">    getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">    // Stream redirection</span><br><span class="line">    initStreams();</span><br><span class="line"></span><br><span class="line">    // Start the new server</span><br><span class="line">    try &#123;</span><br><span class="line">        //初始化容器</span><br><span class="line">        getServer().init();</span><br><span class="line">    &#125; catch (LifecycleException e) &#123;</span><br><span class="line">        if (Boolean.getBoolean(&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;)) &#123;</span><br><span class="line">            throw new java.lang.Error(e);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            log.error(&quot;Catalina.start&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long t2 = System.nanoTime();</span><br><span class="line">    if(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(&quot;Initialization processed in &quot; + ((t2 - t1) / 1000000) + &quot; ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、Catalina的createStartDigester方法"><a href="#6、Catalina的createStartDigester方法" class="headerlink" title="6、Catalina的createStartDigester方法"></a>6、Catalina的createStartDigester方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">protected Digester createStartDigester() &#123;</span><br><span class="line">    long t1=System.currentTimeMillis();</span><br><span class="line">    // Initialize the digester</span><br><span class="line">    //创建digester</span><br><span class="line">    Digester digester = new Digester();</span><br><span class="line">    digester.setValidating(false);</span><br><span class="line">    digester.setRulesValidation(true);</span><br><span class="line">    HashMap&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = new HashMap&lt;&gt;();</span><br><span class="line">    ArrayList&lt;String&gt; attrs = new ArrayList&lt;&gt;();</span><br><span class="line">    attrs.add(&quot;className&quot;);</span><br><span class="line">    fakeAttributes.put(Object.class, attrs);</span><br><span class="line">    digester.setFakeAttributes(fakeAttributes);</span><br><span class="line">    digester.setUseContextClassLoader(true);</span><br><span class="line"></span><br><span class="line">    // Configure the actions we will be using</span><br><span class="line">    //创建Server的规则</span><br><span class="line">    digester.addObjectCreate(&quot;Server&quot;,</span><br><span class="line">                             &quot;org.apache.catalina.core.StandardServer&quot;,</span><br><span class="line">                             &quot;className&quot;);</span><br><span class="line">    //设置Server属性的规则</span><br><span class="line">    digester.addSetProperties(&quot;Server&quot;);</span><br><span class="line">    //Catalina添加Server规则</span><br><span class="line">    digester.addSetNext(&quot;Server&quot;,</span><br><span class="line">                        &quot;setServer&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.Server&quot;);</span><br><span class="line">    //创建GlobalNamingResources的规则</span><br><span class="line">    digester.addObjectCreate(&quot;Server/GlobalNamingResources&quot;,</span><br><span class="line">                             &quot;org.apache.catalina.deploy.NamingResourcesImpl&quot;);</span><br><span class="line">    digester.addSetProperties(&quot;Server/GlobalNamingResources&quot;);</span><br><span class="line">    digester.addSetNext(&quot;Server/GlobalNamingResources&quot;,</span><br><span class="line">                        &quot;setGlobalNamingResources&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.deploy.NamingResourcesImpl&quot;);</span><br><span class="line">    //创建Server的Listener的规则</span><br><span class="line">    digester.addObjectCreate(&quot;Server/Listener&quot;,</span><br><span class="line">                             null, // MUST be specified in the element</span><br><span class="line">                             &quot;className&quot;);</span><br><span class="line">    digester.addSetProperties(&quot;Server/Listener&quot;);</span><br><span class="line">    digester.addSetNext(&quot;Server/Listener&quot;,</span><br><span class="line">                        &quot;addLifecycleListener&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.LifecycleListener&quot;);</span><br><span class="line">    //创建Service的规则</span><br><span class="line">    digester.addObjectCreate(&quot;Server/Service&quot;,</span><br><span class="line">                             &quot;org.apache.catalina.core.StandardService&quot;,</span><br><span class="line">                             &quot;className&quot;);</span><br><span class="line">    digester.addSetProperties(&quot;Server/Service&quot;);</span><br><span class="line">    digester.addSetNext(&quot;Server/Service&quot;,</span><br><span class="line">                        &quot;addService&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.Service&quot;);</span><br><span class="line">    digester.addObjectCreate(&quot;Server/Service/Listener&quot;,</span><br><span class="line">                             null, // MUST be specified in the element</span><br><span class="line">                             &quot;className&quot;);</span><br><span class="line">    digester.addSetProperties(&quot;Server/Service/Listener&quot;);</span><br><span class="line">    digester.addSetNext(&quot;Server/Service/Listener&quot;,</span><br><span class="line">                        &quot;addLifecycleListener&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.LifecycleListener&quot;);</span><br><span class="line"></span><br><span class="line">    //Executor</span><br><span class="line">    digester.addObjectCreate(&quot;Server/Service/Executor&quot;,</span><br><span class="line">                     &quot;org.apache.catalina.core.StandardThreadExecutor&quot;,</span><br><span class="line">                     &quot;className&quot;);</span><br><span class="line">    digester.addSetProperties(&quot;Server/Service/Executor&quot;);</span><br><span class="line"></span><br><span class="line">    digester.addSetNext(&quot;Server/Service/Executor&quot;,</span><br><span class="line">                        &quot;addExecutor&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.Executor&quot;);</span><br><span class="line">    //创建Connector的规则</span><br><span class="line">    digester.addRule(&quot;Server/Service/Connector&quot;,</span><br><span class="line">                     new ConnectorCreateRule());</span><br><span class="line">    digester.addRule(&quot;Server/Service/Connector&quot;,</span><br><span class="line">                     new SetAllPropertiesRule(new String[]&#123;&quot;executor&quot;, &quot;sslImplementationName&quot;&#125;));</span><br><span class="line">    digester.addSetNext(&quot;Server/Service/Connector&quot;,</span><br><span class="line">                        &quot;addConnector&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.connector.Connector&quot;);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // Add RuleSets for nested elements</span><br><span class="line">    //批量添加规则</span><br><span class="line">    digester.addRuleSet(new NamingRuleSet(&quot;Server/GlobalNamingResources/&quot;));</span><br><span class="line">    digester.addRuleSet(new EngineRuleSet(&quot;Server/Service/&quot;));</span><br><span class="line">    digester.addRuleSet(new HostRuleSet(&quot;Server/Service/Engine/&quot;));</span><br><span class="line">    digester.addRuleSet(new ContextRuleSet(&quot;Server/Service/Engine/Host/&quot;));</span><br><span class="line">    addClusterRuleSet(digester, &quot;Server/Service/Engine/Host/Cluster/&quot;);</span><br><span class="line">    digester.addRuleSet(new NamingRuleSet(&quot;Server/Service/Engine/Host/Context/&quot;));</span><br><span class="line"></span><br><span class="line">    // When the &apos;engine&apos; is found, set the parentClassLoader.</span><br><span class="line">    digester.addRule(&quot;Server/Service/Engine&quot;,</span><br><span class="line">                     new SetParentClassLoaderRule(parentClassLoader));</span><br><span class="line">    addClusterRuleSet(digester, &quot;Server/Service/Engine/Cluster/&quot;);</span><br><span class="line"></span><br><span class="line">    long t2=System.currentTimeMillis();</span><br><span class="line">    if (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(&quot;Digester for server.xml created &quot; + ( t2-t1 ));</span><br><span class="line">    &#125;</span><br><span class="line">    return (digester);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、HostRuleSet的createStartDigester方法"><a href="#7、HostRuleSet的createStartDigester方法" class="headerlink" title="7、HostRuleSet的createStartDigester方法"></a>7、HostRuleSet的createStartDigester方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void addRuleInstances(Digester digester) &#123;</span><br><span class="line">    //创建Host规则</span><br><span class="line">    digester.addObjectCreate(prefix + &quot;Host&quot;,</span><br><span class="line">                             &quot;org.apache.catalina.core.StandardHost&quot;,</span><br><span class="line">                             &quot;className&quot;);</span><br><span class="line">    digester.addSetProperties(prefix + &quot;Host&quot;);</span><br><span class="line">    digester.addRule(prefix + &quot;Host&quot;,</span><br><span class="line">                     new CopyParentClassLoaderRule());</span><br><span class="line">    //创建HostConfig监听器，添加到Host中</span><br><span class="line">    digester.addRule(prefix + &quot;Host&quot;,</span><br><span class="line">                     new LifecycleListenerRule</span><br><span class="line">                     (&quot;org.apache.catalina.startup.HostConfig&quot;,</span><br><span class="line">                      &quot;hostConfigClass&quot;));</span><br><span class="line">    //Engine中添加Host子容器</span><br><span class="line">    digester.addSetNext(prefix + &quot;Host&quot;,</span><br><span class="line">                        &quot;addChild&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.Container&quot;);</span><br><span class="line">    ... </span><br><span class="line">    //创建AccessLogValve规则</span><br><span class="line">    digester.addObjectCreate(prefix + &quot;Host/Valve&quot;,</span><br><span class="line">                             null, // MUST be specified in the element</span><br><span class="line">                             &quot;className&quot;);</span><br><span class="line">    digester.addSetProperties(prefix + &quot;Host/Valve&quot;);</span><br><span class="line">    digester.addSetNext(prefix + &quot;Host/Valve&quot;,</span><br><span class="line">                        &quot;addValve&quot;,</span><br><span class="line">                        &quot;org.apache.catalina.Valve&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、接（一、5）LifecycleBase的init方法"><a href="#8、接（一、5）LifecycleBase的init方法" class="headerlink" title="8、接（一、5）LifecycleBase的init方法"></a>8、接（一、5）LifecycleBase的init方法</h4><p>StandardServer的父类，实现生命周期管理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final synchronized void init() throws LifecycleException &#123;</span><br><span class="line">    //state默认为LifecycleState.NEW</span><br><span class="line">    if (!state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        //状态有误，抛出异常</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //设置state为正在初始化，并广播事件</span><br><span class="line">        setStateInternal(LifecycleState.INITIALIZING, null, false);</span><br><span class="line">        //初始化</span><br><span class="line">        initInternal();</span><br><span class="line">        //设置state为初始化完成，并广播事件</span><br><span class="line">        setStateInternal(LifecycleState.INITIALIZED, null, false);</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, null, false);</span><br><span class="line">        throw new LifecycleException(</span><br><span class="line">                sm.getString(&quot;lifecycleBase.initFail&quot;,toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="9、StandardServer的initInternal方法"><a href="#9、StandardServer的initInternal方法" class="headerlink" title="9、StandardServer的initInternal方法"></a>9、StandardServer的initInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line">    //注册到MBeanServer中</span><br><span class="line">    super.initInternal();</span><br><span class="line"></span><br><span class="line">    // Register global String cache</span><br><span class="line">    // Note although the cache is global, if there are multiple Servers</span><br><span class="line">    // present in the JVM (may happen when embedding) then the same cache</span><br><span class="line">    // will be registered under multiple names</span><br><span class="line">    onameStringCache = register(new StringCache(), &quot;type=StringCache&quot;);</span><br><span class="line"></span><br><span class="line">    // Register the MBeanFactory</span><br><span class="line">    MBeanFactory factory = new MBeanFactory();</span><br><span class="line">    factory.setContainer(this);</span><br><span class="line">    onameMBeanFactory = register(factory, &quot;type=MBeanFactory&quot;);</span><br><span class="line"></span><br><span class="line">    // Register the naming resources</span><br><span class="line">    //初始化globalNamingResources，主要是相关资源注册到MBeanServer中</span><br><span class="line">    globalNamingResources.init();</span><br><span class="line"></span><br><span class="line">    // Populate the extension validator with JARs from common and shared</span><br><span class="line">    // class loaders</span><br><span class="line">    //获取jar包的Manifest文件</span><br><span class="line">    if (getCatalina() != null) &#123;</span><br><span class="line">        ClassLoader cl = getCatalina().getParentClassLoader();</span><br><span class="line">        // Walk the class loader hierarchy. Stop at the system class loader.</span><br><span class="line">        // This will add the shared (if present) and common class loaders</span><br><span class="line">        while (cl != null &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</span><br><span class="line">            if (cl instanceof URLClassLoader) &#123;</span><br><span class="line">                URL[] urls = ((URLClassLoader) cl).getURLs();</span><br><span class="line">                for (URL url : urls) &#123;</span><br><span class="line">                    if (url.getProtocol().equals(&quot;file&quot;)) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            File f = new File (url.toURI());</span><br><span class="line">                            if (f.isFile() &amp;&amp;</span><br><span class="line">                                    f.getName().endsWith(&quot;.jar&quot;)) &#123;</span><br><span class="line">                                ExtensionValidator.addSystemResource(f);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; catch (URISyntaxException e) &#123;</span><br><span class="line">                            // Ignore</span><br><span class="line">                        &#125; catch (IOException e) &#123;</span><br><span class="line">                            // Ignore</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cl = cl.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Initialize our defined Services</span><br><span class="line">    for (int i = 0; i &lt; services.length; i++) &#123;</span><br><span class="line">        //初始化service</span><br><span class="line">        services[i].init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、StandardService的initInternal方法"><a href="#10、StandardService的initInternal方法" class="headerlink" title="10、StandardService的initInternal方法"></a>10、StandardService的initInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line">    //注册到MBeanServer中</span><br><span class="line">    super.initInternal();</span><br><span class="line">    //初始化engine</span><br><span class="line">    if (engine != null) &#123;</span><br><span class="line">        engine.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize any Executors</span><br><span class="line">    //初始化executor，未配置</span><br><span class="line">    for (Executor executor : findExecutors()) &#123;</span><br><span class="line">        if (executor instanceof JmxEnabled) &#123;</span><br><span class="line">            ((JmxEnabled) executor).setDomain(getDomain());</span><br><span class="line">        &#125;</span><br><span class="line">        executor.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize mapper listener</span><br><span class="line">    //初始化mapperListener，注册到MBeanServer中</span><br><span class="line">    mapperListener.init();</span><br><span class="line"></span><br><span class="line">    // Initialize our defined Connectors</span><br><span class="line">    //初始化连接器</span><br><span class="line">    synchronized (connectorsLock) &#123;</span><br><span class="line">        for (Connector connector : connectors) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                connector.init();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                String message = sm.getString(</span><br><span class="line">                        &quot;standardService.connector.initFailed&quot;, connector);</span><br><span class="line">                log.error(message, e);</span><br><span class="line"></span><br><span class="line">                if (Boolean.getBoolean(&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;))</span><br><span class="line">                    throw new LifecycleException(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、StandardEngine的initInternal方法"><a href="#11、StandardEngine的initInternal方法" class="headerlink" title="11、StandardEngine的initInternal方法"></a>11、StandardEngine的initInternal方法</h4><p>实例化StandardEngine<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public StandardEngine() &#123;</span><br><span class="line">    super();</span><br><span class="line">    //处理request的管道，往valve队列中添加StandardEngineValve</span><br><span class="line">    pipeline.setBasic(new StandardEngineValve());</span><br><span class="line">    /* Set the jmvRoute using the system property jvmRoute */</span><br><span class="line">    try &#123;</span><br><span class="line">        //在负载匀衡中使用的标识符，必须唯一</span><br><span class="line">        setJvmRoute(System.getProperty(&quot;jvmRoute&quot;));</span><br><span class="line">    &#125; catch(Exception ex) &#123;</span><br><span class="line">        log.warn(sm.getString(&quot;standardEngine.jvmRouteFail&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    // By default, the engine will hold the reloading thread</span><br><span class="line">    //后台线程执行间隔</span><br><span class="line">    backgroundProcessorDelay = 10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>初始化方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line">    // Ensure that a Realm is present before any attempt is made to start</span><br><span class="line">    // one. This will create the default NullRealm if necessary.</span><br><span class="line">    getRealm();</span><br><span class="line">    super.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="12、ContainerBase的initInternal方法"><a href="#12、ContainerBase的initInternal方法" class="headerlink" title="12、ContainerBase的initInternal方法"></a>12、ContainerBase的initInternal方法</h4><p>StandardEngine的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line">    //任务队列</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; startStopQueue = new LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">    //启停线程池</span><br><span class="line">    startStopExecutor = new ThreadPoolExecutor(</span><br><span class="line">            getStartStopThreadsInternal(),</span><br><span class="line">            getStartStopThreadsInternal(), 10, TimeUnit.SECONDS,</span><br><span class="line">            startStopQueue,</span><br><span class="line">            new StartStopThreadFactory(getName() + &quot;-startStop-&quot;));</span><br><span class="line">    //核心线程会超时关闭</span><br><span class="line">    startStopExecutor.allowCoreThreadTimeOut(true);</span><br><span class="line">    super.initInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="13、接（一、1）Bootstrap的start方法"><a href="#13、接（一、1）Bootstrap的start方法" class="headerlink" title="13、接（一、1）Bootstrap的start方法"></a>13、接（一、1）Bootstrap的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void start()</span><br><span class="line">    throws Exception &#123;</span><br><span class="line">    if( catalinaDaemon==null ) init();</span><br><span class="line">    Method method = catalinaDaemon.getClass().getMethod(&quot;start&quot;, (Class [] )null);</span><br><span class="line">    //执行catalina的start方法</span><br><span class="line">    method.invoke(catalinaDaemon, (Object [])null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、Catalina的start方法"><a href="#14、Catalina的start方法" class="headerlink" title="14、Catalina的start方法"></a>14、Catalina的start方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">public void start() &#123;</span><br><span class="line">    //Server不存在，则初始化</span><br><span class="line">    if (getServer() == null) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line">    //Server不存在，退出</span><br><span class="line">    if (getServer() == null) &#123;</span><br><span class="line">        log.fatal(&quot;Cannot start server. Server instance is not configured.&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">    // Start the new server</span><br><span class="line">    try &#123;</span><br><span class="line">        //启动Server</span><br><span class="line">        getServer().start();</span><br><span class="line">    &#125; catch (LifecycleException e) &#123;</span><br><span class="line">        log.fatal(sm.getString(&quot;catalina.serverStartFail&quot;), e);</span><br><span class="line">        try &#123;</span><br><span class="line">            //销毁Server</span><br><span class="line">            getServer().destroy();</span><br><span class="line">        &#125; catch (LifecycleException e1) &#123;</span><br><span class="line">            log.debug(&quot;destroy() failed for failed Server &quot;, e1);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    long t2 = System.nanoTime();</span><br><span class="line">    if(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(&quot;Server startup in &quot; + ((t2 - t1) / 1000000) + &quot; ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Register shutdown hook</span><br><span class="line">    if (useShutdownHook) &#123;</span><br><span class="line">        if (shutdownHook == null) &#123;</span><br><span class="line">            //钩子函数，执行Catalina的stop方法</span><br><span class="line">            shutdownHook = new CatalinaShutdownHook();</span><br><span class="line">        &#125;</span><br><span class="line">        //添加钩子函数，jvm关闭时执行</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">        // If JULI is being used, disable JULI&apos;s shutdown hook since</span><br><span class="line">        // shutdown hooks run in parallel and log messages may be lost</span><br><span class="line">        // if JULI&apos;s hook completes before the CatalinaShutdownHook()</span><br><span class="line">        LogManager logManager = LogManager.getLogManager();</span><br><span class="line">        if (logManager instanceof ClassLoaderLogManager) &#123;</span><br><span class="line">            ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                    false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //是否阻塞主线程</span><br><span class="line">    if (await) &#123;</span><br><span class="line">        //阻塞本线程，创建ServerSocket监听8005端口，等待shutdown命令</span><br><span class="line">        await();</span><br><span class="line">        //停止Server</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、LifecycleBase的start方法"><a href="#15、LifecycleBase的start方法" class="headerlink" title="15、LifecycleBase的start方法"></a>15、LifecycleBase的start方法</h4><p>StandardServer的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final synchronized void start() throws LifecycleException &#123;</span><br><span class="line">    //已启动</span><br><span class="line">    if (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||</span><br><span class="line">            LifecycleState.STARTED.equals(state)) &#123;</span><br><span class="line"></span><br><span class="line">        if (log.isDebugEnabled()) &#123;</span><br><span class="line">            Exception e = new LifecycleException();</span><br><span class="line">            log.debug(sm.getString(&quot;lifecycleBase.alreadyStarted&quot;, toString()), e);</span><br><span class="line">        &#125; else if (log.isInfoEnabled()) &#123;</span><br><span class="line">            log.info(sm.getString(&quot;lifecycleBase.alreadyStarted&quot;, toString()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //尚未初始化</span><br><span class="line">    if (state.equals(LifecycleState.NEW)) &#123;</span><br><span class="line">        init();</span><br><span class="line">    //失败</span><br><span class="line">    &#125; else if (state.equals(LifecycleState.FAILED)) &#123;</span><br><span class="line">        stop();</span><br><span class="line">    //状态不对，抛出异常</span><br><span class="line">    &#125; else if (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</span><br><span class="line">            !state.equals(LifecycleState.STOPPED)) &#123;</span><br><span class="line">        invalidTransition(Lifecycle.BEFORE_START_EVENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //设置状态为准备启动，并广播事件</span><br><span class="line">        setStateInternal(LifecycleState.STARTING_PREP, null, false);</span><br><span class="line">        //启动server</span><br><span class="line">        startInternal();</span><br><span class="line">        //启动失败</span><br><span class="line">        if (state.equals(LifecycleState.FAILED)) &#123;</span><br><span class="line">            // This is a &apos;controlled&apos; failure. The component put itself into the</span><br><span class="line">            // FAILED state so call stop() to complete the clean-up.</span><br><span class="line">            //停止</span><br><span class="line">            stop();</span><br><span class="line">        &#125; else if (!state.equals(LifecycleState.STARTING)) &#123;</span><br><span class="line">            // Shouldn&apos;t be necessary but acts as a check that sub-classes are</span><br><span class="line">            // doing what they are supposed to.</span><br><span class="line">            //抛出异常</span><br><span class="line">            invalidTransition(Lifecycle.AFTER_START_EVENT);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //设置状态已启动，并广播事件</span><br><span class="line">            setStateInternal(LifecycleState.STARTED, null, false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">        // This is an &apos;uncontrolled&apos; failure so put the component into the</span><br><span class="line">        // FAILED state and throw an exception.</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        setStateInternal(LifecycleState.FAILED, null, false);</span><br><span class="line">        throw new LifecycleException(sm.getString(&quot;lifecycleBase.startFail&quot;, toString()), t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="16、StandardServer的startInternal方法"><a href="#16、StandardServer的startInternal方法" class="headerlink" title="16、StandardServer的startInternal方法"></a>16、StandardServer的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void startInternal() throws LifecycleException &#123;</span><br><span class="line">    //广播configure_start事件</span><br><span class="line">    fireLifecycleEvent(CONFIGURE_START_EVENT, null);</span><br><span class="line">    //设置状态为正在启动</span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line">    //广播configure_start事件</span><br><span class="line">    globalNamingResources.start();</span><br><span class="line"></span><br><span class="line">    // Start our defined Services</span><br><span class="line">    synchronized (servicesLock) &#123;</span><br><span class="line">        for (int i = 0; i &lt; services.length; i++) &#123;</span><br><span class="line">            //启动service</span><br><span class="line">            services[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、StandardService的startInternal方法"><a href="#17、StandardService的startInternal方法" class="headerlink" title="17、StandardService的startInternal方法"></a>17、StandardService的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    if(log.isInfoEnabled())</span><br><span class="line">        log.info(sm.getString(&quot;standardService.start.name&quot;, this.name));</span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    // Start our defined Container first</span><br><span class="line">    //启动engine</span><br><span class="line">    if (engine != null) &#123;</span><br><span class="line">        synchronized (engine) &#123;</span><br><span class="line">            engine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //启动executor</span><br><span class="line">    synchronized (executors) &#123;</span><br><span class="line">        for (Executor executor: executors) &#123;</span><br><span class="line">            executor.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //启动mapperListener</span><br><span class="line">    mapperListener.start();</span><br><span class="line"></span><br><span class="line">    // Start our defined Connectors second</span><br><span class="line">    //启动连接器</span><br><span class="line">    synchronized (connectorsLock) &#123;</span><br><span class="line">        for (Connector connector: connectors) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // If it has already failed, don&apos;t try and start it</span><br><span class="line">                if (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                    connector.start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(</span><br><span class="line">                        &quot;standardService.connector.startFailed&quot;,</span><br><span class="line">                        connector), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、StandardEngine的startInternal方法"><a href="#18、StandardEngine的startInternal方法" class="headerlink" title="18、StandardEngine的startInternal方法"></a>18、StandardEngine的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    // Log our server identification information</span><br><span class="line">    if(log.isInfoEnabled())</span><br><span class="line">        log.info( &quot;Starting Servlet Engine: &quot; + ServerInfo.getServerInfo());</span><br><span class="line"></span><br><span class="line">    // Standard container startup</span><br><span class="line">    //启动容器</span><br><span class="line">    super.startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、ContainerBase的startInternal方法"><a href="#19、ContainerBase的startInternal方法" class="headerlink" title="19、ContainerBase的startInternal方法"></a>19、ContainerBase的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    // Start our subordinate components, if any</span><br><span class="line">    logger = null;</span><br><span class="line">    getLogger();</span><br><span class="line">    //启动tomcat集群相关组件</span><br><span class="line">    Cluster cluster = getClusterInternal();</span><br><span class="line">    if (cluster instanceof Lifecycle) &#123;</span><br><span class="line">        ((Lifecycle) cluster).start();</span><br><span class="line">    &#125;</span><br><span class="line">    //启动安全域</span><br><span class="line">    Realm realm = getRealmInternal();</span><br><span class="line">    if (realm instanceof Lifecycle) &#123;</span><br><span class="line">        ((Lifecycle) realm).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Start our child containers, if any</span><br><span class="line">    //启动子容器</span><br><span class="line">    Container children[] = findChildren();</span><br><span class="line">    List&lt;Future&lt;Void&gt;&gt; results = new ArrayList&lt;&gt;();</span><br><span class="line">    for (int i = 0; i &lt; children.length; i++) &#123;</span><br><span class="line">        results.add(startStopExecutor.submit(new StartChild(children[i])));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boolean fail = false;</span><br><span class="line">    for (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            result.get();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            log.error(sm.getString(&quot;containerBase.threadedStartFailed&quot;), e);</span><br><span class="line">            fail = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    if (fail) &#123;</span><br><span class="line">        throw new LifecycleException(</span><br><span class="line">                sm.getString(&quot;containerBase.threadedStartFailed&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Start the Valves in our pipeline (including the basic), if any</span><br><span class="line">    //启动管道</span><br><span class="line">    if (pipeline instanceof Lifecycle)</span><br><span class="line">        ((Lifecycle) pipeline).start();</span><br><span class="line"></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    // Start our thread</span><br><span class="line">    //启动后台线程，ContainerBackgroundProcessor</span><br><span class="line">    threadStart();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、StandardHost的startInternal方法"><a href="#20、StandardHost的startInternal方法" class="headerlink" title="20、StandardHost的startInternal方法"></a>20、StandardHost的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected synchronized void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    // Set error report valve</span><br><span class="line">    //往pipeline的value队列中添加ErrorReportValve对象</span><br><span class="line">    String errorValve = getErrorReportValveClass();</span><br><span class="line">    if ((errorValve != null) &amp;&amp; (!errorValve.equals(&quot;&quot;))) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            boolean found = false;</span><br><span class="line">            Valve[] valves = getPipeline().getValves();</span><br><span class="line">            for (Valve valve : valves) &#123;</span><br><span class="line">                if (errorValve.equals(valve.getClass().getName())) &#123;</span><br><span class="line">                    found = true;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if(!found) &#123;</span><br><span class="line">                Valve valve =</span><br><span class="line">                    (Valve) Class.forName(errorValve).getConstructor().newInstance();</span><br><span class="line">                getPipeline().addValve(valve);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            log.error(sm.getString(</span><br><span class="line">                    &quot;standardHost.invalidErrorReportValveClass&quot;,</span><br><span class="line">                    errorValve), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //执行父类ContainerBase的startInternal方法</span><br><span class="line">    super.startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、接（一、17）MapperListener的startInternal方法"><a href="#21、接（一、17）MapperListener的startInternal方法" class="headerlink" title="21、接（一、17）MapperListener的startInternal方法"></a>21、接（一、17）MapperListener的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    Engine engine = service.getContainer();</span><br><span class="line">    if (engine == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //查找配置的&quot;defaultHost&quot;</span><br><span class="line">    findDefaultHost();</span><br><span class="line">    //往container及其子容器中添加该监听器</span><br><span class="line">    addListeners(engine);</span><br><span class="line"></span><br><span class="line">    Container[] conHosts = engine.findChildren();</span><br><span class="line">    for (Container conHost : conHosts) &#123;</span><br><span class="line">        Host host = (Host) conHost;</span><br><span class="line">        if (!LifecycleState.NEW.equals(host.getState())) &#123;</span><br><span class="line">            // Registering the host will register the context and wrappers</span><br><span class="line">            //注册主机，及其子容器，容器按name排序存放在Mapper中</span><br><span class="line">            registerHost(host);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、启动连接器"><a href="#二、启动连接器" class="headerlink" title="二、启动连接器"></a>二、启动连接器</h3><h4 id="1、实例化Connector"><a href="#1、实例化Connector" class="headerlink" title="1、实例化Connector"></a>1、实例化Connector</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Connector() &#123;</span><br><span class="line">    this(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public Connector(String protocol) &#123;</span><br><span class="line">    //设置协议</span><br><span class="line">    setProtocol(protocol);</span><br><span class="line">    // Instantiate protocol handler</span><br><span class="line">    ProtocolHandler p = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        //实例化协议处理器,默认Http11NioProtocol</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</span><br><span class="line">        p = (ProtocolHandler) clazz.getConstructor().newInstance();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(sm.getString(</span><br><span class="line">                &quot;coyoteConnector.protocolHandlerInstantiationFailed&quot;), e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //设置协议处理器</span><br><span class="line">        this.protocolHandler = p;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置编码格式</span><br><span class="line">    if (Globals.STRICT_SERVLET_COMPLIANCE) &#123;</span><br><span class="line">        uriCharset = StandardCharsets.ISO_8859_1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        uriCharset = StandardCharsets.UTF_8;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、接（一、10）Connector的initInternal方法"><a href="#2、接（一、10）Connector的initInternal方法" class="headerlink" title="2、接（一、10）Connector的initInternal方法"></a>2、接（一、10）Connector的initInternal方法</h4><p>初始化连接器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    super.initInternal();</span><br><span class="line"></span><br><span class="line">    // Initialize adapter</span><br><span class="line">    //连接器与容器的适配器</span><br><span class="line">    adapter = new CoyoteAdapter(this);</span><br><span class="line">    //设置适配器</span><br><span class="line">    protocolHandler.setAdapter(adapter);</span><br><span class="line"></span><br><span class="line">    // Make sure parseBodyMethodsSet has a default</span><br><span class="line">    if (null == parseBodyMethodsSet) &#123;</span><br><span class="line">        setParseBodyMethods(getParseBodyMethods());</span><br><span class="line">    &#125;</span><br><span class="line">    //设置apr环境</span><br><span class="line">    if (protocolHandler.isAprRequired() &amp;&amp; !AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">        throw new LifecycleException(sm.getString(&quot;coyoteConnector.protocolHandlerNoApr&quot;,</span><br><span class="line">                getProtocolHandlerClassName()));</span><br><span class="line">    &#125;</span><br><span class="line">    if (AprLifecycleListener.isAprAvailable() &amp;&amp; AprLifecycleListener.getUseOpenSSL() &amp;&amp;</span><br><span class="line">            protocolHandler instanceof AbstractHttp11JsseProtocol) &#123;</span><br><span class="line">        AbstractHttp11JsseProtocol&lt;?&gt; jsseProtocolHandler =</span><br><span class="line">                (AbstractHttp11JsseProtocol&lt;?&gt;) protocolHandler;</span><br><span class="line">        if (jsseProtocolHandler.isSSLEnabled() &amp;&amp;</span><br><span class="line">                jsseProtocolHandler.getSslImplementationName() == null) &#123;</span><br><span class="line">            // OpenSSL is compatible with the JSSE configuration, so use it if APR is available</span><br><span class="line">            jsseProtocolHandler.setSslImplementationName(OpenSSLImplementation.class.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //初始化协议</span><br><span class="line">        protocolHandler.init();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new LifecycleException(</span><br><span class="line">                sm.getString(&quot;coyoteConnector.protocolHandlerInitializationFailed&quot;), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、接（一、17）Connector的startInternal方法"><a href="#3、接（一、17）Connector的startInternal方法" class="headerlink" title="3、接（一、17）Connector的startInternal方法"></a>3、接（一、17）Connector的startInternal方法</h4><p>启动连接器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    // Validate settings before starting</span><br><span class="line">    if (getPort() &lt; 0) &#123;</span><br><span class="line">        throw new LifecycleException(sm.getString(</span><br><span class="line">                &quot;coyoteConnector.invalidPort&quot;, Integer.valueOf(getPort())));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //启动协议</span><br><span class="line">        protocolHandler.start();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        throw new LifecycleException(</span><br><span class="line">                sm.getString(&quot;coyoteConnector.protocolHandlerStartFailed&quot;), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、接（二、1）实例化Http11NioProtocol"><a href="#4、接（二、1）实例化Http11NioProtocol" class="headerlink" title="4、接（二、1）实例化Http11NioProtocol"></a>4、接（二、1）实例化Http11NioProtocol</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Http11NioProtocol() &#123;</span><br><span class="line">    super(new NioEndpoint());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Http11NioProtocol的父类AbstractHttp11Protocol<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public AbstractHttp11Protocol(AbstractEndpoint&lt;S&gt; endpoint) &#123;</span><br><span class="line">    super(endpoint);</span><br><span class="line">    setConnectionTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);</span><br><span class="line">    ConnectionHandler&lt;S&gt; cHandler = new ConnectionHandler&lt;&gt;(this);</span><br><span class="line">    setHandler(cHandler);</span><br><span class="line">    getEndpoint().setHandler(cHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5、接（二、3）AbstractProtocol的start方法"><a href="#5、接（二、3）AbstractProtocol的start方法" class="headerlink" title="5、接（二、3）AbstractProtocol的start方法"></a>5、接（二、3）AbstractProtocol<s>的start方法</s></h4><p>Http11NioProtocol的父类，启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void start() throws Exception &#123;</span><br><span class="line">    if (getLog().isInfoEnabled()) &#123;</span><br><span class="line">        getLog().info(sm.getString(&quot;abstractProtocolHandler.start&quot;, getName()));</span><br><span class="line">    &#125;</span><br><span class="line">    //启动NioEndpoint</span><br><span class="line">    endpoint.start();</span><br><span class="line"></span><br><span class="line">    // Start async timeout thread</span><br><span class="line">    //异步任务超时处理线程</span><br><span class="line">    asyncTimeout = new AsyncTimeout();</span><br><span class="line">    Thread timeoutThread = new Thread(asyncTimeout, getNameInternal() + &quot;-AsyncTimeout&quot;);</span><br><span class="line">    int priority = endpoint.getThreadPriority();</span><br><span class="line">    if (priority &lt; Thread.MIN_PRIORITY || priority &gt; Thread.MAX_PRIORITY) &#123;</span><br><span class="line">        priority = Thread.NORM_PRIORITY;</span><br><span class="line">    &#125;</span><br><span class="line">    timeoutThread.setPriority(priority);</span><br><span class="line">    timeoutThread.setDaemon(true);</span><br><span class="line">    timeoutThread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6、AbstractEndpoint的start方法"><a href="#6、AbstractEndpoint的start方法" class="headerlink" title="6、AbstractEndpoint的start方法"></a>6、AbstractEndpoint<s>的start方法</s></h4><p>NioEndpoint的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final void start() throws Exception &#123;</span><br><span class="line">    if (bindState == BindState.UNBOUND) &#123;</span><br><span class="line">        //绑定端口</span><br><span class="line">        bind();</span><br><span class="line">        bindState = BindState.BOUND_ON_START;</span><br><span class="line">    &#125;</span><br><span class="line">    //启动NioEndpoint</span><br><span class="line">    startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="7、NioEndpoint的bind方法"><a href="#7、NioEndpoint的bind方法" class="headerlink" title="7、NioEndpoint的bind方法"></a>7、NioEndpoint的bind方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void bind() throws Exception &#123;</span><br><span class="line">    //创建服务端通道ServerSocketChannel</span><br><span class="line">    serverSock = ServerSocketChannel.open();</span><br><span class="line">    //设置属性</span><br><span class="line">    socketProperties.setProperties(serverSock.socket());</span><br><span class="line">    //获取监听地址</span><br><span class="line">    InetSocketAddress addr = (getAddress()!=null?new InetSocketAddress(getAddress(),getPort()):new InetSocketAddress(getPort()));</span><br><span class="line">    //绑定监听地址，默认最大堆积连接100</span><br><span class="line">    serverSock.socket().bind(addr,getAcceptCount());</span><br><span class="line">    //设置模式为阻塞</span><br><span class="line">    serverSock.configureBlocking(true); //mimic APR behavior</span><br><span class="line"></span><br><span class="line">    // Initialize thread count defaults for acceptor, poller</span><br><span class="line">    // acceptor线程数量，默认1个</span><br><span class="line">    if (acceptorThreadCount == 0) &#123;</span><br><span class="line">        // FIXME: Doesn&apos;t seem to work that well with multiple accept threads</span><br><span class="line">        acceptorThreadCount = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    //Poller线程数量，默认处理器数量的一半</span><br><span class="line">    if (pollerThreadCount &lt;= 0) &#123;</span><br><span class="line">        //minimum one poller thread</span><br><span class="line">        pollerThreadCount = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    //关闭等待poller关闭</span><br><span class="line">    setStopLatch(new CountDownLatch(pollerThreadCount));</span><br><span class="line"></span><br><span class="line">    // Initialize SSL if needed</span><br><span class="line">    //初始化SSLHostConfig</span><br><span class="line">    initialiseSsl();</span><br><span class="line">    //创建共享的Selector</span><br><span class="line">    selectorPool.open();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、接（二、6）NioEndpoint的startInternal方法"><a href="#8、接（二、6）NioEndpoint的startInternal方法" class="headerlink" title="8、接（二、6）NioEndpoint的startInternal方法"></a>8、接（二、6）NioEndpoint的startInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void startInternal() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    if (!running) &#123;</span><br><span class="line">        //运行状态</span><br><span class="line">        running = true;</span><br><span class="line">        //挂起状态</span><br><span class="line">        paused = false;</span><br><span class="line">        //处理器缓存</span><br><span class="line">        processorCache = new SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                socketProperties.getProcessorCache());</span><br><span class="line">        //任务缓存</span><br><span class="line">        eventCache = new SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                        socketProperties.getEventCache());</span><br><span class="line">        //NioChannel缓存</span><br><span class="line">        nioChannels = new SynchronizedStack&lt;&gt;(SynchronizedStack.DEFAULT_SIZE,</span><br><span class="line">                socketProperties.getBufferPool());</span><br><span class="line"></span><br><span class="line">        // Create worker collection</span><br><span class="line">        //创建工作线程，默认最多200个工作线程</span><br><span class="line">        if ( getExecutor() == null ) &#123;</span><br><span class="line">            createExecutor();</span><br><span class="line">        &#125;</span><br><span class="line">        //初始化连接限制，默认最多1000个连接</span><br><span class="line">        initializeConnectionLatch();</span><br><span class="line"></span><br><span class="line">        // Start poller threads</span><br><span class="line">        //启动poller线程</span><br><span class="line">        pollers = new Poller[getPollerThreadCount()];</span><br><span class="line">        for (int i=0; i&lt;pollers.length; i++) &#123;</span><br><span class="line">            pollers[i] = new Poller();</span><br><span class="line">            Thread pollerThread = new Thread(pollers[i], getName() + &quot;-ClientPoller-&quot;+i);</span><br><span class="line">            pollerThread.setPriority(threadPriority);</span><br><span class="line">            pollerThread.setDaemon(true);</span><br><span class="line">            pollerThread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        //启动Acceptor线程</span><br><span class="line">        startAcceptorThreads();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、Acceptor的run方法"><a href="#9、Acceptor的run方法" class="headerlink" title="9、Acceptor的run方法"></a>9、Acceptor的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line"></span><br><span class="line">    int errorDelay = 0;</span><br><span class="line"></span><br><span class="line">    // Loop until we receive a shutdown command</span><br><span class="line">    while (running) &#123;</span><br><span class="line"></span><br><span class="line">        // Loop if endpoint is paused</span><br><span class="line">        while (paused &amp;&amp; running) &#123;</span><br><span class="line">            state = AcceptorState.PAUSED;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(50);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                // Ignore</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!running) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        state = AcceptorState.RUNNING;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //if we have reached max connections, wait</span><br><span class="line">            //连接数加一</span><br><span class="line">            countUpOrAwaitConnection();</span><br><span class="line"></span><br><span class="line">            SocketChannel socket = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                // Accept the next incoming connection from the server</span><br><span class="line">                // socket</span><br><span class="line">                //等待客户端连接</span><br><span class="line">                socket = serverSock.accept();</span><br><span class="line">            &#125; catch (IOException ioe) &#123;</span><br><span class="line">                // We didn&apos;t get a socket</span><br><span class="line">                countDownConnection();</span><br><span class="line">                if (running) &#123;</span><br><span class="line">                    // Introduce delay if necessary</span><br><span class="line">                    errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                    // re-throw</span><br><span class="line">                    throw ioe;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Successful accept, reset the error delay</span><br><span class="line">            errorDelay = 0;</span><br><span class="line"></span><br><span class="line">            // Configure the socket</span><br><span class="line">            if (running &amp;&amp; !paused) &#123;</span><br><span class="line">                // setSocketOptions() will hand the socket off to</span><br><span class="line">                // an appropriate processor if successful</span><br><span class="line">                //处理请求，失败则关闭socket</span><br><span class="line">                if (!setSocketOptions(socket)) &#123;</span><br><span class="line">                    closeSocket(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                closeSocket(socket);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            log.error(sm.getString(&quot;endpoint.accept.fail&quot;), t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    state = AcceptorState.ENDED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>