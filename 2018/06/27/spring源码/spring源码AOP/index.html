<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>spring源码AOP | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="spring源码AOP一、AOP动态代理配置文件加载####demo接口1234public interface Dao &amp;#123;        public void select();    public void insert();  &amp;#125; 被代理的类12345678910public class DaoImpl implements Dao &amp;#123;    @Overrid">
<meta property="og:type" content="article">
<meta property="og:title" content="spring源码AOP">
<meta property="og:url" content="http://yoursite.com/2018/06/27/spring源码/spring源码AOP/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="spring源码AOP一、AOP动态代理配置文件加载####demo接口1234public interface Dao &amp;#123;        public void select();    public void insert();  &amp;#125; 被代理的类12345678910public class DaoImpl implements Dao &amp;#123;    @Overrid">
<meta property="og:updated_time" content="2018-06-15T13:03:35.951Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="spring源码AOP">
<meta name="twitter:description" content="spring源码AOP一、AOP动态代理配置文件加载####demo接口1234public interface Dao &amp;#123;        public void select();    public void insert();  &amp;#125; 被代理的类12345678910public class DaoImpl implements Dao &amp;#123;    @Overrid">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-spring源码/spring源码AOP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/27/spring源码/spring源码AOP/" class="article-date">
  <time datetime="2018-06-27T13:10:29.016Z" itemprop="datePublished">2018-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      spring源码AOP
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="spring源码AOP"><a href="#spring源码AOP" class="headerlink" title="spring源码AOP"></a>spring源码AOP</h2><h3 id="一、AOP动态代理配置文件加载"><a href="#一、AOP动态代理配置文件加载" class="headerlink" title="一、AOP动态代理配置文件加载"></a>一、AOP动态代理配置文件加载</h3><p>####demo<br>接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public interface Dao &#123;    </span><br><span class="line">    public void select();</span><br><span class="line">    public void insert();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>被代理的类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class DaoImpl implements Dao &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void select() &#123;</span><br><span class="line">        System.out.println(&quot;Enter DaoImpl.select()&quot;);</span><br><span class="line">    ｝</span><br><span class="line">    @Override</span><br><span class="line">    public void insert() &#123;</span><br><span class="line">        System.out.println(&quot;Enter DaoImpl.insert()&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>切面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class TimeHandler &#123;</span><br><span class="line">   public void printTime() &#123;</span><br><span class="line">       System.out.println(&quot;CurrentTime:&quot; + System.currentTimeMillis());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>引介增强，将该类中的方法添加到被代理的类中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Mathematician &#123;  </span><br><span class="line">    public void calculate();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class MathematicianImpl implements Mathematician &#123;  </span><br><span class="line">  </span><br><span class="line">    @Override  </span><br><span class="line">    public void calculate() &#123;  </span><br><span class="line">        System.out.println(&quot;calculate the result of the formulae&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AOP配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop-3.0.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;daoImpl&quot; class=&quot;org.xrq.action.aop.DaoImpl&quot; /&gt;</span><br><span class="line">    &lt;bean id=&quot;Einstein&quot; class=&quot;org.xrq.action.aop.Einstein&quot;&gt;&lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;timeHandler&quot; class=&quot;org.xrq.action.aop.TimeHandler&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config proxy-target-class=&quot;true&quot;&gt;</span><br><span class="line">        &lt;aop:aspect id=&quot;time&quot; ref=&quot;timeHandler&quot;&gt;</span><br><span class="line">            &lt;aop:pointcut id=&quot;addAllMethod&quot; expression=&quot;execution(* org.xrq.action.aop.Dao.*(..))&quot; /&gt;</span><br><span class="line">            &lt;aop:before method=&quot;printTime&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt;</span><br><span class="line">            &lt;aop:after method=&quot;printTime&quot; pointcut-ref=&quot;addAllMethod&quot; /&gt;</span><br><span class="line">            &lt;aop:declare-parents types-matching=&quot;org.xrq.action.aop.Dao&quot;   </span><br><span class="line">                implement-interface=&quot;org.xrq.action.aop.Mathematician&quot;  </span><br><span class="line">                default-impl=&quot;org.xrq.action.aop.MathematicianImpl&quot;/&gt;  </span><br><span class="line">        &lt;/aop:aspect&gt;</span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<p>META-INF/spring.handlers<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http\://www.springframework.org/schema/aop=org.springframework.aop.config.AopNamespaceHandler</span><br></pre></td></tr></table></figure></p>
<h4 id="1、AopNamespaceHandler的init方法"><a href="#1、AopNamespaceHandler的init方法" class="headerlink" title="1、AopNamespaceHandler的init方法"></a>1、AopNamespaceHandler的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    // In 2.0 XSD as well as in 2.1 XSD.</span><br><span class="line">    registerBeanDefinitionParser(&quot;config&quot;, new ConfigBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;aspectj-autoproxy&quot;, new AspectJAutoProxyBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionDecorator(&quot;scoped-proxy&quot;, new ScopedProxyBeanDefinitionDecorator());</span><br><span class="line"></span><br><span class="line">    // Only in 2.0 XSD: moved to context namespace as of 2.1</span><br><span class="line">    registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、ConfigBeanDefinitionParser的parse方法"><a href="#2、ConfigBeanDefinitionParser的parse方法" class="headerlink" title="2、ConfigBeanDefinitionParser的parse方法"></a>2、ConfigBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    CompositeComponentDefinition compositeDef =</span><br><span class="line">            new CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));</span><br><span class="line">    parserContext.pushContainingComponent(compositeDef);</span><br><span class="line">    //注册AutoProxyCreator</span><br><span class="line">    configureAutoProxyCreator(parserContext, element);</span><br><span class="line">    //获取子元素</span><br><span class="line">    List&lt;Element&gt; childElts = DomUtils.getChildElements(element);</span><br><span class="line">    for (Element elt: childElts) &#123;</span><br><span class="line">        String localName = parserContext.getDelegate().getLocalName(elt);</span><br><span class="line">        if (POINTCUT.equals(localName)) &#123;</span><br><span class="line">            //解析pointcut元素</span><br><span class="line">            parsePointcut(elt, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ADVISOR.equals(localName)) &#123;</span><br><span class="line">            //解析advisor元素</span><br><span class="line">            parseAdvisor(elt, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ASPECT.equals(localName)) &#123;</span><br><span class="line">            //解析aspect元素</span><br><span class="line">            parseAspect(elt, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //注册综合组件并广播</span><br><span class="line">    parserContext.popAndRegisterContainingComponent();</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、ConfigBeanDefinitionParser的parse方法"><a href="#3、ConfigBeanDefinitionParser的parse方法" class="headerlink" title="3、ConfigBeanDefinitionParser的parse方法"></a>3、ConfigBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private void configureAutoProxyCreator(ParserContext parserContext, Element element) &#123;</span><br><span class="line">    AopNamespaceUtils.registerAspectJAutoProxyCreatorIfNecessary(parserContext, element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>4、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAspectJAutoProxyCreatorIfNecessary(</span><br><span class="line">        ParserContext parserContext, Element sourceElement) &#123;</span><br><span class="line">    //注册AspectJAwareAdvisorAutoProxyCreator</span><br><span class="line">    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAutoProxyCreatorIfNecessary(</span><br><span class="line">            parserContext.getRegistry(), parserContext.extractSource(sourceElement));</span><br><span class="line">    //设置proxy-target-class和expose-proxy属性</span><br><span class="line">    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</span><br><span class="line">    //把创建器组件注册到综合组件并广播</span><br><span class="line">    registerComponentIfNecessary(beanDefinition, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>5、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static BeanDefinition registerAspectJAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    return registerOrEscalateApcAsRequired(AspectJAwareAdvisorAutoProxyCreator.class, registry, source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"><a href="#6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法" class="headerlink" title="6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法"></a>6、AopNamespaceUtils的registerAspectJAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private static BeanDefinition registerOrEscalateApcAsRequired(Class&lt;?&gt; cls, BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">    //已存在创建器，根据优先级判断使用哪一个</span><br><span class="line">    if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        if (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;</span><br><span class="line">            int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName());</span><br><span class="line">            int requiredPriority = findPriorityForClass(cls);</span><br><span class="line">            if (currentPriority &lt; requiredPriority) &#123;</span><br><span class="line">                apcDefinition.setBeanClassName(cls.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);</span><br><span class="line">    beanDefinition.setSource(source);</span><br><span class="line">    beanDefinition.getPropertyValues().add(&quot;order&quot;, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //注册新的创建器</span><br><span class="line">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line">    return beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法"><a href="#7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法" class="headerlink" title="7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法"></a>7、接（一、2）ConfigBeanDefinitionParser的parsePointcut方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition parsePointcut(Element pointcutElement, ParserContext parserContext) &#123;</span><br><span class="line">    //获取id</span><br><span class="line">    String id = pointcutElement.getAttribute(ID);</span><br><span class="line">    //获取expression</span><br><span class="line">    String expression = pointcutElement.getAttribute(EXPRESSION);</span><br><span class="line"></span><br><span class="line">    AbstractBeanDefinition pointcutDefinition = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new PointcutEntry(id));</span><br><span class="line">        //创建切点BeanDefinition</span><br><span class="line">        pointcutDefinition = createPointcutDefinition(expression);</span><br><span class="line">        pointcutDefinition.setSource(parserContext.extractSource(pointcutElement));</span><br><span class="line"></span><br><span class="line">        String pointcutBeanName = id;</span><br><span class="line">        //注册切点BeanDefinition</span><br><span class="line">        if (StringUtils.hasText(pointcutBeanName)) &#123;</span><br><span class="line">            parserContext.getRegistry().registerBeanDefinition(pointcutBeanName, pointcutDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            pointcutBeanName = parserContext.getReaderContext().registerWithGeneratedName(pointcutDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">        //把切点组件注册到综合组件并广播</span><br><span class="line">        parserContext.registerComponent(</span><br><span class="line">                new PointcutComponentDefinition(pointcutBeanName, pointcutDefinition, expression));</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return pointcutDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法"><a href="#8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法" class="headerlink" title="8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法"></a>8、接（一、2）ConfigBeanDefinitionParser的parseAdvisor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private void parseAdvisor(Element advisorElement, ParserContext parserContext) &#123;</span><br><span class="line">    //创建通知器BeanDefinition</span><br><span class="line">    AbstractBeanDefinition advisorDef = createAdvisorBeanDefinition(advisorElement, parserContext);</span><br><span class="line">    String id = advisorElement.getAttribute(ID);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new AdvisorEntry(id));</span><br><span class="line">        String advisorBeanName = id;</span><br><span class="line">        //注册通知器BeanDefinition</span><br><span class="line">        if (StringUtils.hasText(advisorBeanName)) &#123;</span><br><span class="line">            parserContext.getRegistry().registerBeanDefinition(advisorBeanName, advisorDef);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            advisorBeanName = parserContext.getReaderContext().registerWithGeneratedName(advisorDef);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取切点</span><br><span class="line">        Object pointcut = parsePointcutProperty(advisorElement, parserContext);</span><br><span class="line">        //切点或切点引用加入通知器</span><br><span class="line">        //把通知器组件注册到综合组件并广播</span><br><span class="line">        if (pointcut instanceof BeanDefinition) &#123;</span><br><span class="line">            advisorDef.getPropertyValues().add(POINTCUT, pointcut);</span><br><span class="line">            parserContext.registerComponent(</span><br><span class="line">                    new AdvisorComponentDefinition(advisorBeanName, advisorDef, (BeanDefinition) pointcut));</span><br><span class="line">        &#125;</span><br><span class="line">        else if (pointcut instanceof String) &#123;</span><br><span class="line">            advisorDef.getPropertyValues().add(POINTCUT, new RuntimeBeanReference((String) pointcut));</span><br><span class="line">            parserContext.registerComponent(</span><br><span class="line">                    new AdvisorComponentDefinition(advisorBeanName, advisorDef));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法"><a href="#9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法" class="headerlink" title="9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法"></a>9、ConfigBeanDefinitionParser的createAdvisorBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition createAdvisorBeanDefinition(Element advisorElement, ParserContext parserContext) &#123;</span><br><span class="line">    //创建通知器BeanDefinition</span><br><span class="line">    RootBeanDefinition advisorDefinition = new RootBeanDefinition(DefaultBeanFactoryPointcutAdvisor.class);</span><br><span class="line">    advisorDefinition.setSource(parserContext.extractSource(advisorElement));</span><br><span class="line">    //获取advice引用</span><br><span class="line">    String adviceRef = advisorElement.getAttribute(ADVICE_REF);</span><br><span class="line">    //advice引用加入通知器BeanDefinition</span><br><span class="line">    if (!StringUtils.hasText(adviceRef)) &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;&apos;advice-ref&apos; attribute contains empty value.&quot;, advisorElement, this.parseState.snapshot());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        advisorDefinition.getPropertyValues().add(</span><br><span class="line">                ADVICE_BEAN_NAME, new RuntimeBeanNameReference(adviceRef));</span><br><span class="line">    &#125;</span><br><span class="line">    //通知器顺序</span><br><span class="line">    if (advisorElement.hasAttribute(ORDER_PROPERTY)) &#123;</span><br><span class="line">        advisorDefinition.getPropertyValues().add(</span><br><span class="line">                ORDER_PROPERTY, advisorElement.getAttribute(ORDER_PROPERTY));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return advisorDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法"><a href="#10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法" class="headerlink" title="10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法"></a>10、接（一、8）ConfigBeanDefinitionParser的parsePointcutProperty方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private Object parsePointcutProperty(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    if (element.hasAttribute(POINTCUT) &amp;&amp; element.hasAttribute(POINTCUT_REF)) &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;Cannot define both &apos;pointcut&apos; and &apos;pointcut-ref&apos; on &lt;advisor&gt; tag.&quot;,</span><br><span class="line">                element, this.parseState.snapshot());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(POINTCUT)) &#123;</span><br><span class="line">        // Create a pointcut for the anonymous pc and register it.</span><br><span class="line">        //获取切点表达式</span><br><span class="line">        String expression = element.getAttribute(POINTCUT);</span><br><span class="line">        //创建切点BeanDefinition</span><br><span class="line">        AbstractBeanDefinition pointcutDefinition = createPointcutDefinition(expression);</span><br><span class="line">        pointcutDefinition.setSource(parserContext.extractSource(element));</span><br><span class="line">        return pointcutDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(POINTCUT_REF)) &#123;</span><br><span class="line">        //获取切点bean的id</span><br><span class="line">        String pointcutRef = element.getAttribute(POINTCUT_REF);</span><br><span class="line">        if (!StringUtils.hasText(pointcutRef)) &#123;</span><br><span class="line">            parserContext.getReaderContext().error(</span><br><span class="line">                    &quot;&apos;pointcut-ref&apos; attribute contains empty value.&quot;, element, this.parseState.snapshot());</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return pointcutRef;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;Must define one of &apos;pointcut&apos; or &apos;pointcut-ref&apos; on &lt;advisor&gt; tag.&quot;,</span><br><span class="line">                element, this.parseState.snapshot());</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、ConfigBeanDefinitionParser的createPointcutDefinition方法"><a href="#11、ConfigBeanDefinitionParser的createPointcutDefinition方法" class="headerlink" title="11、ConfigBeanDefinitionParser的createPointcutDefinition方法"></a>11、ConfigBeanDefinitionParser的createPointcutDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected AbstractBeanDefinition createPointcutDefinition(String expression) &#123;</span><br><span class="line">    //创建切点BeanDefinition</span><br><span class="line">    RootBeanDefinition beanDefinition = new RootBeanDefinition(AspectJExpressionPointcut.class);</span><br><span class="line">    beanDefinition.setScope(BeanDefinition.SCOPE_PROTOTYPE);</span><br><span class="line">    beanDefinition.setSynthetic(true);</span><br><span class="line">    //添加切点表达式属性</span><br><span class="line">    beanDefinition.getPropertyValues().add(EXPRESSION, expression);</span><br><span class="line">    return beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法"><a href="#12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法" class="headerlink" title="12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法"></a>12、接（一、2）ConfigBeanDefinitionParser的parseAspect方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">private void parseAspect(Element aspectElement, ParserContext parserContext) &#123;</span><br><span class="line">    //获取切面名</span><br><span class="line">    String aspectId = aspectElement.getAttribute(ID);</span><br><span class="line">    //获取切面bean名</span><br><span class="line">    String aspectName = aspectElement.getAttribute(REF);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new AspectEntry(aspectId, aspectName));</span><br><span class="line">        List&lt;BeanDefinition&gt; beanDefinitions = new ArrayList&lt;BeanDefinition&gt;();</span><br><span class="line">        List&lt;BeanReference&gt; beanReferences = new ArrayList&lt;BeanReference&gt;();</span><br><span class="line">        //获取declare-parents类型的子元素</span><br><span class="line">        List&lt;Element&gt; declareParents = DomUtils.getChildElementsByTagName(aspectElement, DECLARE_PARENTS);</span><br><span class="line">        for (int i = METHOD_INDEX; i &lt; declareParents.size(); i++) &#123;</span><br><span class="line">            Element declareParentsElement = declareParents.get(i);</span><br><span class="line">            //解析declare-parents元素，并加入BeanDefinition集合</span><br><span class="line">            beanDefinitions.add(parseDeclareParents(declareParentsElement, parserContext));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // We have to parse &quot;advice&quot; and all the advice kinds in one loop, to get the</span><br><span class="line">        // ordering semantics right.</span><br><span class="line">        //获取子元素</span><br><span class="line">        NodeList nodeList = aspectElement.getChildNodes();</span><br><span class="line">        boolean adviceFoundAlready = false;</span><br><span class="line">        for (int i = 0; i &lt; nodeList.getLength(); i++) &#123;</span><br><span class="line">            Node node = nodeList.item(i);</span><br><span class="line">            //该元素节点为advice节点,如before等</span><br><span class="line">            if (isAdviceNode(node, parserContext)) &#123;</span><br><span class="line">                if (!adviceFoundAlready) &#123;</span><br><span class="line">                    adviceFoundAlready = true;</span><br><span class="line">                    if (!StringUtils.hasText(aspectName)) &#123;</span><br><span class="line">                        parserContext.getReaderContext().error(</span><br><span class="line">                                &quot;&lt;aspect&gt; tag needs aspect bean reference via &apos;ref&apos; attribute when declaring advices.&quot;,</span><br><span class="line">                                aspectElement, this.parseState.snapshot());</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //切面bean引用加入引用集合</span><br><span class="line">                    beanReferences.add(new RuntimeBeanReference(aspectName));</span><br><span class="line">                &#125;</span><br><span class="line">                //解析获取通知器BeanDefinition</span><br><span class="line">                AbstractBeanDefinition advisorDefinition = parseAdvice(</span><br><span class="line">                        aspectName, i, aspectElement, (Element) node, parserContext, beanDefinitions, beanReferences);</span><br><span class="line">                beanDefinitions.add(advisorDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //创建切面组件BeanDefinition</span><br><span class="line">        AspectComponentDefinition aspectComponentDefinition = createAspectComponentDefinition(</span><br><span class="line">                aspectElement, aspectId, beanDefinitions, beanReferences, parserContext);</span><br><span class="line">        parserContext.pushContainingComponent(aspectComponentDefinition);</span><br><span class="line">        //获取切点类型子元素</span><br><span class="line">        List&lt;Element&gt; pointcuts = DomUtils.getChildElementsByTagName(aspectElement, POINTCUT);</span><br><span class="line">        for (Element pointcutElement : pointcuts) &#123;</span><br><span class="line">            //解析切点元素</span><br><span class="line">            parsePointcut(pointcutElement, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">        //把切面组件注册到综合组件并广播</span><br><span class="line">        parserContext.popAndRegisterContainingComponent();</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、ConfigBeanDefinitionParser的parseDeclareParents方法"><a href="#13、ConfigBeanDefinitionParser的parseDeclareParents方法" class="headerlink" title="13、ConfigBeanDefinitionParser的parseDeclareParents方法"></a>13、ConfigBeanDefinitionParser的parseDeclareParents方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition parseDeclareParents(Element declareParentsElement, ParserContext parserContext) &#123;</span><br><span class="line">    //通知器BeanDefinition的创建器</span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(DeclareParentsAdvisor.class);</span><br><span class="line">    //添加构造函数的参数  </span><br><span class="line">    //这里的构造函数是指DeclareParentsAdvisor的构造函数  </span><br><span class="line">    builder.addConstructorArgValue(declareParentsElement.getAttribute(IMPLEMENT_INTERFACE));</span><br><span class="line">    //类型匹配表达式</span><br><span class="line">    builder.addConstructorArgValue(declareParentsElement.getAttribute(TYPE_PATTERN));</span><br><span class="line">    //接口的默认实现</span><br><span class="line">    String defaultImpl = declareParentsElement.getAttribute(DEFAULT_IMPL);</span><br><span class="line">    //接口的实现引用</span><br><span class="line">    String delegateRef = declareParentsElement.getAttribute(DELEGATE_REF);</span><br><span class="line">    //指定接口实现或引用</span><br><span class="line">    if (StringUtils.hasText(defaultImpl) &amp;&amp; !StringUtils.hasText(delegateRef)) &#123;</span><br><span class="line">        builder.addConstructorArgValue(defaultImpl);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (StringUtils.hasText(delegateRef) &amp;&amp; !StringUtils.hasText(defaultImpl)) &#123;</span><br><span class="line">        builder.addConstructorArgReference(delegateRef);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        parserContext.getReaderContext().error(</span><br><span class="line">                &quot;Exactly one of the &quot; + DEFAULT_IMPL + &quot; or &quot; + DELEGATE_REF + &quot; attributes must be specified&quot;,</span><br><span class="line">                declareParentsElement, this.parseState.snapshot());</span><br><span class="line">    &#125;</span><br><span class="line">    //创建DeclareParentsAdvisor的BeanDefinition</span><br><span class="line">    AbstractBeanDefinition definition = builder.getBeanDefinition();</span><br><span class="line">    definition.setSource(parserContext.extractSource(declareParentsElement));</span><br><span class="line">    //注册该BeanDefinition</span><br><span class="line">    parserContext.getReaderContext().registerWithGeneratedName(definition);</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法"><a href="#14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法" class="headerlink" title="14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法"></a>14、接（一、12）ConfigBeanDefinitionParser的parseAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition parseAdvice(</span><br><span class="line">        String aspectName, int order, Element aspectElement, Element adviceElement, ParserContext parserContext,</span><br><span class="line">        List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences) &#123;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.parseState.push(new AdviceEntry(parserContext.getDelegate().getLocalName(adviceElement)));</span><br><span class="line"></span><br><span class="line">        // create the method factory bean</span><br><span class="line">        //拦截方法工厂BeanDefinition</span><br><span class="line">        RootBeanDefinition methodDefinition = new RootBeanDefinition(MethodLocatingFactoryBean.class);</span><br><span class="line">        methodDefinition.getPropertyValues().add(&quot;targetBeanName&quot;, aspectName);</span><br><span class="line">        methodDefinition.getPropertyValues().add(&quot;methodName&quot;, adviceElement.getAttribute(&quot;method&quot;));</span><br><span class="line">        methodDefinition.setSynthetic(true);</span><br><span class="line"></span><br><span class="line">        // create instance factory definition</span><br><span class="line">        //切面工厂BeanDefinition</span><br><span class="line">        RootBeanDefinition aspectFactoryDef =</span><br><span class="line">                new RootBeanDefinition(SimpleBeanFactoryAwareAspectInstanceFactory.class);</span><br><span class="line">        aspectFactoryDef.getPropertyValues().add(&quot;aspectBeanName&quot;, aspectName);</span><br><span class="line">        aspectFactoryDef.setSynthetic(true);</span><br><span class="line"></span><br><span class="line">        // register the pointcut</span><br><span class="line">        //创建advice的BeanDefinition</span><br><span class="line">        AbstractBeanDefinition adviceDef = createAdviceDefinition(</span><br><span class="line">                adviceElement, parserContext, aspectName, order, methodDefinition, aspectFactoryDef,</span><br><span class="line">                beanDefinitions, beanReferences);</span><br><span class="line"></span><br><span class="line">        // configure the advisor</span><br><span class="line">        //创建通知BeanDefinition</span><br><span class="line">        RootBeanDefinition advisorDefinition = new RootBeanDefinition(AspectJPointcutAdvisor.class);</span><br><span class="line">        advisorDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">        //通知bean添加构造函数参数切面bean</span><br><span class="line">        advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef);</span><br><span class="line">        if (aspectElement.hasAttribute(ORDER_PROPERTY)) &#123;</span><br><span class="line">            advisorDefinition.getPropertyValues().add(</span><br><span class="line">                    ORDER_PROPERTY, aspectElement.getAttribute(ORDER_PROPERTY));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // register the final advisor</span><br><span class="line">        //注册通知BeanDefinition</span><br><span class="line">        parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition);</span><br><span class="line"></span><br><span class="line">        return advisorDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        this.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、ConfigBeanDefinitionParser的createAdviceDefinition方法"><a href="#15、ConfigBeanDefinitionParser的createAdviceDefinition方法" class="headerlink" title="15、ConfigBeanDefinitionParser的createAdviceDefinition方法"></a>15、ConfigBeanDefinitionParser的createAdviceDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">private AbstractBeanDefinition createAdviceDefinition(</span><br><span class="line">        Element adviceElement, ParserContext parserContext, String aspectName, int order,</span><br><span class="line">        RootBeanDefinition methodDef, RootBeanDefinition aspectFactoryDef,</span><br><span class="line">        List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences) &#123;</span><br><span class="line">    //创建advice的BeanDefinition，类为AspectJMethodBeforeAdvice或AspectJAfterAdvice等</span><br><span class="line">    RootBeanDefinition adviceDefinition = new RootBeanDefinition(getAdviceClass(adviceElement, parserContext));</span><br><span class="line">    adviceDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">    //添加切面名称</span><br><span class="line">    adviceDefinition.getPropertyValues().add(ASPECT_NAME_PROPERTY, aspectName);</span><br><span class="line">    //添加排序</span><br><span class="line">    adviceDefinition.getPropertyValues().add(DECLARATION_ORDER_PROPERTY, order);</span><br><span class="line"></span><br><span class="line">    if (adviceElement.hasAttribute(RETURNING)) &#123;</span><br><span class="line">        adviceDefinition.getPropertyValues().add(</span><br><span class="line">                RETURNING_PROPERTY, adviceElement.getAttribute(RETURNING));</span><br><span class="line">    &#125;</span><br><span class="line">    if (adviceElement.hasAttribute(THROWING)) &#123;</span><br><span class="line">        adviceDefinition.getPropertyValues().add(</span><br><span class="line">                THROWING_PROPERTY, adviceElement.getAttribute(THROWING));</span><br><span class="line">    &#125;</span><br><span class="line">    if (adviceElement.hasAttribute(ARG_NAMES)) &#123;</span><br><span class="line">        adviceDefinition.getPropertyValues().add(</span><br><span class="line">                ARG_NAMES_PROPERTY, adviceElement.getAttribute(ARG_NAMES));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //将拦截方法加入advice的bean的构造函数参数</span><br><span class="line">    ConstructorArgumentValues cav = adviceDefinition.getConstructorArgumentValues();</span><br><span class="line">    cav.addIndexedArgumentValue(METHOD_INDEX, methodDef);</span><br><span class="line">    //获取切点或切点引用并加入advice的bean的构造函数参数</span><br><span class="line">    Object pointcut = parsePointcutProperty(adviceElement, parserContext);</span><br><span class="line">    if (pointcut instanceof BeanDefinition) &#123;</span><br><span class="line">        cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcut);</span><br><span class="line">        beanDefinitions.add((BeanDefinition) pointcut);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (pointcut instanceof String) &#123;</span><br><span class="line">        RuntimeBeanReference pointcutRef = new RuntimeBeanReference((String) pointcut);</span><br><span class="line">        cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcutRef);</span><br><span class="line">        beanReferences.add(pointcutRef);</span><br><span class="line">    &#125;</span><br><span class="line">    //切面工厂加入advice的bean的构造函数参数</span><br><span class="line">    cav.addIndexedArgumentValue(ASPECT_INSTANCE_FACTORY_INDEX, aspectFactoryDef);</span><br><span class="line"></span><br><span class="line">    return adviceDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、AOP动态代理代理对象创建"><a href="#二、AOP动态代理代理对象创建" class="headerlink" title="二、AOP动态代理代理对象创建"></a>二、AOP动态代理代理对象创建</h3><h4 id="1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法"><a href="#1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法" class="headerlink" title="1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法"></a>1、AbstractAutoProxyCreator的postProcessBeforeInstantiation方法</h4><p>创建bean之前会执行InstantiationAwareBeanPostProcessor处理器的postProcessBeforeInstantiation方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) throws BeansException &#123;</span><br><span class="line">    //获取缓存key</span><br><span class="line">    Object cacheKey = getCacheKey(beanClass, beanName);</span><br><span class="line">    //当前targetSourcedBeans（通过自定义TargetSourceCreator创建的TargetSource）不包含cacheKey  </span><br><span class="line">    if (beanName == null || !this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        //基础设施类（如Advisor、Advice、AopInfrastructureBean的实现），不需要创建代理</span><br><span class="line">        if (this.advisedBeans.containsKey(cacheKey)) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) &#123;</span><br><span class="line">            this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy here if we have a custom TargetSource.</span><br><span class="line">    // Suppresses unnecessary default instantiation of the target bean:</span><br><span class="line">    // The TargetSource will handle target instances in a custom fashion.</span><br><span class="line">    if (beanName != null) &#123;</span><br><span class="line">        //配置的自定义的TargetSourceCreator创建TargetSource  </span><br><span class="line">        TargetSource targetSource = getCustomTargetSource(beanClass, beanName);</span><br><span class="line">        if (targetSource != null) &#123;</span><br><span class="line">            this.targetSourcedBeans.add(beanName);</span><br><span class="line">            //获取增强</span><br><span class="line">            Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</span><br><span class="line">            //创建代理对象</span><br><span class="line">            Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);</span><br><span class="line">            this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">            return proxy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法"><a href="#2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法" class="headerlink" title="2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法"></a>2、AspectJAwareAdvisorAutoProxyCreator的shouldSkip方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">    // TODO: Consider optimization by caching the list of the aspect names</span><br><span class="line">    //获取通知bean</span><br><span class="line">    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">    for (Advisor advisor : candidateAdvisors) &#123;</span><br><span class="line">        if (advisor instanceof AspectJPointcutAdvisor) &#123;</span><br><span class="line">            //类为切面类，返回true，不需要创建代理</span><br><span class="line">            if (((AbstractAspectJAdvice) advisor.getAdvice()).getAspectName().equals(beanName)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回false</span><br><span class="line">    return super.shouldSkip(beanClass, beanName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AbstractAutoProxyCreator的getEarlyBeanReference方法"><a href="#3、AbstractAutoProxyCreator的getEarlyBeanReference方法" class="headerlink" title="3、AbstractAutoProxyCreator的getEarlyBeanReference方法"></a>3、AbstractAutoProxyCreator的getEarlyBeanReference方法</h4><p>出现循环依赖会调用SmartInstantiationAwareBeanPostProcessor处理器的getEarlyBeanReference<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getEarlyBeanReference(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">    if (!this.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">        this.earlyProxyReferences.add(cacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建代理对象</span><br><span class="line">    return wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、AbstractAutoProxyCreator的postProcessAfterInitialization方法"><a href="#4、AbstractAutoProxyCreator的postProcessAfterInitialization方法" class="headerlink" title="4、AbstractAutoProxyCreator的postProcessAfterInitialization方法"></a>4、AbstractAutoProxyCreator的postProcessAfterInitialization方法</h4><p>执行完自定义初始化方法后会调用BeanPostProcessor处理器的postProcessAfterInitialization方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    if (bean != null) &#123;</span><br><span class="line">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">        //如发生循环依赖此处已经是代理对象</span><br><span class="line">        if (!this.earlyProxyReferences.contains(cacheKey)) &#123;</span><br><span class="line">            //创建代理对象</span><br><span class="line">            return wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5、AbstractAutoProxyCreator的wrapIfNecessary方法"><a href="#5、AbstractAutoProxyCreator的wrapIfNecessary方法" class="headerlink" title="5、AbstractAutoProxyCreator的wrapIfNecessary方法"></a>5、AbstractAutoProxyCreator的wrapIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">    //已经是代理对象</span><br><span class="line">    if (beanName != null &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy if we have advice.</span><br><span class="line">    //获取增强</span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">    if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">        //创建代理</span><br><span class="line">        Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">        this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        return proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有增强，不需要代理</span><br><span class="line">    this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、AbstractAutoProxyCreator的wrapIfNecessary方法"><a href="#6、AbstractAutoProxyCreator的wrapIfNecessary方法" class="headerlink" title="6、AbstractAutoProxyCreator的wrapIfNecessary方法"></a>6、AbstractAutoProxyCreator的wrapIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">    //已经是代理对象</span><br><span class="line">    if (beanName != null &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line">    //基础设施类或切面类，不需代理</span><br><span class="line">    if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">        return bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Create proxy if we have advice.</span><br><span class="line">    //获取增强</span><br><span class="line">    Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">    if (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">        this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">        //创建代理</span><br><span class="line">        Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">        this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">        return proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有增强，不需要代理</span><br><span class="line">    this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法"><a href="#7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法" class="headerlink" title="7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法"></a>7、AbstractAdvisorAutoProxyCreator的getAdvicesAndAdvisorsForBean方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object[] getAdvicesAndAdvisorsForBean(Class&lt;?&gt; beanClass, String beanName, TargetSource targetSource) &#123;</span><br><span class="line">    //获取通知</span><br><span class="line">    List&lt;Advisor&gt; advisors = findEligibleAdvisors(beanClass, beanName);</span><br><span class="line">    if (advisors.isEmpty()) &#123;</span><br><span class="line">        return DO_NOT_PROXY;</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors.toArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法"><a href="#8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法" class="headerlink" title="8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法"></a>8、AbstractAdvisorAutoProxyCreator的findEligibleAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findEligibleAdvisors(Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line">    //获取通知</span><br><span class="line">    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br><span class="line">    //晒选可应用的通知</span><br><span class="line">    List&lt;Advisor&gt; eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);</span><br><span class="line">    extendAdvisors(eligibleAdvisors);</span><br><span class="line">    if (!eligibleAdvisors.isEmpty()) &#123;</span><br><span class="line">        //通知排序</span><br><span class="line">        eligibleAdvisors = sortAdvisors(eligibleAdvisors);</span><br><span class="line">    &#125;</span><br><span class="line">    return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法"><a href="#9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法" class="headerlink" title="9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法"></a>9、AbstractAdvisorAutoProxyCreator的findCandidateAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findCandidateAdvisors() &#123;</span><br><span class="line">    return this.advisorRetrievalHelper.findAdvisorBeans();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法"><a href="#10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法" class="headerlink" title="10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法"></a>10、BeanFactoryAdvisorRetrievalHelper的findAdvisorBeans方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; findAdvisorBeans() &#123;</span><br><span class="line">    // Determine list of advisor bean names, if not cached already.</span><br><span class="line">    String[] advisorNames = null;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        advisorNames = this.cachedAdvisorBeanNames;</span><br><span class="line">        if (advisorNames == null) &#123;</span><br><span class="line">            // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">            // uninitialized to let the auto-proxy creator apply to them!</span><br><span class="line">            //从容器及其父容器获取所有Advisor类型的beanName</span><br><span class="line">            advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(</span><br><span class="line">                    this.beanFactory, Advisor.class, true, false);</span><br><span class="line">            this.cachedAdvisorBeanNames = advisorNames;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //不存在，返回空集合</span><br><span class="line">    if (advisorNames.length == 0) &#123;</span><br><span class="line">        return new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    //加载advisor类型的bean，并返回</span><br><span class="line">    List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    for (String name : advisorNames) &#123;</span><br><span class="line">        //该切面是否有效，即includePatterns是否包含此类</span><br><span class="line">        if (isEligibleBean(name)) &#123;</span><br><span class="line">            if (this.beanFactory.isCurrentlyInCreation(name)) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Skipping currently created advisor &apos;&quot; + name + &quot;&apos;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    advisors.add(this.beanFactory.getBean(name, Advisor.class));</span><br><span class="line">                &#125;</span><br><span class="line">                catch (BeanCreationException ex) &#123;</span><br><span class="line">                    Throwable rootCause = ex.getMostSpecificCause();</span><br><span class="line">                    if (rootCause instanceof BeanCurrentlyInCreationException) &#123;</span><br><span class="line">                        BeanCreationException bce = (BeanCreationException) rootCause;</span><br><span class="line">                        if (this.beanFactory.isCurrentlyInCreation(bce.getBeanName())) &#123;</span><br><span class="line">                            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                                logger.debug(&quot;Skipping advisor &apos;&quot; + name +</span><br><span class="line">                                        &quot;&apos; with dependency on currently created bean: &quot; + ex.getMessage());</span><br><span class="line">                            &#125;</span><br><span class="line">                            // Ignore: indicates a reference back to the bean we&apos;re trying to advise.</span><br><span class="line">                            // We want to find advisors other than the currently created bean itself.</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    throw ex;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法"><a href="#11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法" class="headerlink" title="11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法"></a>11、接（二、8）BeanFactoryAdvisorRetrievalHelper的findAdvisorsThatCanApply方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protected List&lt;Advisor&gt; findAdvisorsThatCanApply(</span><br><span class="line">        List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName) &#123;</span><br><span class="line"></span><br><span class="line">    ProxyCreationContext.setCurrentProxiedBeanName(beanName);</span><br><span class="line">    try &#123;</span><br><span class="line">        return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        ProxyCreationContext.setCurrentProxiedBeanName(null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、AopUtils的findAdvisorsThatCanApply方法"><a href="#12、AopUtils的findAdvisorsThatCanApply方法" class="headerlink" title="12、AopUtils的findAdvisorsThatCanApply方法"></a>12、AopUtils的findAdvisorsThatCanApply方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;Advisor&gt; findAdvisorsThatCanApply(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    if (candidateAdvisors.isEmpty()) &#123;</span><br><span class="line">        return candidateAdvisors;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Advisor&gt; eligibleAdvisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    //首先处理引介增强，如DeclareParentsAdvisor</span><br><span class="line">    for (Advisor candidate : candidateAdvisors) &#123;</span><br><span class="line">        if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123;</span><br><span class="line">            eligibleAdvisors.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    boolean hasIntroductions = !eligibleAdvisors.isEmpty();</span><br><span class="line">    //普通增强</span><br><span class="line">    for (Advisor candidate : candidateAdvisors) &#123;</span><br><span class="line">        if (candidate instanceof IntroductionAdvisor) &#123;</span><br><span class="line">            // already processed</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (canApply(candidate, clazz, hasIntroductions)) &#123;</span><br><span class="line">            eligibleAdvisors.add(candidate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return eligibleAdvisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、AopUtils的canApply方法"><a href="#13、AopUtils的canApply方法" class="headerlink" title="13、AopUtils的canApply方法"></a>13、AopUtils的canApply方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public static boolean canApply(Pointcut pc, Class&lt;?&gt; targetClass, boolean hasIntroductions) &#123;</span><br><span class="line">    Assert.notNull(pc, &quot;Pointcut must not be null&quot;);</span><br><span class="line">    //切点不匹配该类</span><br><span class="line">    if (!pc.getClassFilter().matches(targetClass)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MethodMatcher methodMatcher = pc.getMethodMatcher();</span><br><span class="line">    IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null;</span><br><span class="line">    if (methodMatcher instanceof IntroductionAwareMethodMatcher) &#123;</span><br><span class="line">        introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher;</span><br><span class="line">    &#125;</span><br><span class="line">    //切点只要匹配到一个方法就返回true</span><br><span class="line">    Set&lt;Class&lt;?&gt;&gt; classes = new LinkedHashSet&lt;Class&lt;?&gt;&gt;(ClassUtils.getAllInterfacesForClassAsSet(targetClass));</span><br><span class="line">    classes.add(targetClass);</span><br><span class="line">    for (Class&lt;?&gt; clazz : classes) &#123;</span><br><span class="line">        Method[] methods = clazz.getMethods();</span><br><span class="line">        for (Method method : methods) &#123;</span><br><span class="line">            if ((introductionAwareMethodMatcher != null &amp;&amp;</span><br><span class="line">                    introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions)) ||</span><br><span class="line">                    methodMatcher.matches(method, targetClass)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（二、5）AbstractAutoProxyCreator的createProxy方法"><a href="#14、接（二、5）AbstractAutoProxyCreator的createProxy方法" class="headerlink" title="14、接（二、5）AbstractAutoProxyCreator的createProxy方法"></a>14、接（二、5）AbstractAutoProxyCreator的createProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected Object createProxy(</span><br><span class="line">        Class&lt;?&gt; beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource) &#123;</span><br><span class="line"></span><br><span class="line">    ProxyFactory proxyFactory = new ProxyFactory();</span><br><span class="line">    proxyFactory.copyFrom(this);</span><br><span class="line">    //返回是否用cglib动态代理直接代理该类，用户配置</span><br><span class="line">    if (!proxyFactory.isProxyTargetClass()) &#123;</span><br><span class="line">        //判断是否用cglib动态代理代理该类</span><br><span class="line">        if (shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line">            proxyFactory.setProxyTargetClass(true);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //判断是否是有合适jdk动态代理的接口，将查找到的接口加入代理工厂</span><br><span class="line">            evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取通知</span><br><span class="line">    Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">    for (Advisor advisor : advisors) &#123;</span><br><span class="line">        //通知加入代理工厂，如果存在引介增强，则将引介增强的接口放入待实现接口集合</span><br><span class="line">        proxyFactory.addAdvisor(advisor);</span><br><span class="line">    &#125;</span><br><span class="line">    //要代理的类</span><br><span class="line">    proxyFactory.setTargetSource(targetSource);</span><br><span class="line">    //定制代理，待子类实现</span><br><span class="line">    customizeProxyFactory(proxyFactory);</span><br><span class="line">    //冻结代理工厂配置</span><br><span class="line">    proxyFactory.setFrozen(this.freezeProxy);</span><br><span class="line">    if (advisorsPreFiltered()) &#123;</span><br><span class="line">        proxyFactory.setPreFiltered(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建代理对象</span><br><span class="line">    return proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、AbstractAutoProxyCreator的buildAdvisors方法"><a href="#15、AbstractAutoProxyCreator的buildAdvisors方法" class="headerlink" title="15、AbstractAutoProxyCreator的buildAdvisors方法"></a>15、AbstractAutoProxyCreator的buildAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">protected Advisor[] buildAdvisors(String beanName, Object[] specificInterceptors) &#123;</span><br><span class="line">    // Handle prototypes correctly...</span><br><span class="line">    //解析注册到ProxyFactoryBean中的拦截器</span><br><span class="line">    Advisor[] commonInterceptors = resolveInterceptorNames();</span><br><span class="line">    //interceptorNames加入通知集合</span><br><span class="line">    List&lt;Object&gt; allInterceptors = new ArrayList&lt;Object&gt;();</span><br><span class="line">    if (specificInterceptors != null) &#123;</span><br><span class="line">        allInterceptors.addAll(Arrays.asList(specificInterceptors));</span><br><span class="line">        if (commonInterceptors != null) &#123;</span><br><span class="line">            if (this.applyCommonInterceptorsFirst) &#123;</span><br><span class="line">                allInterceptors.addAll(0, Arrays.asList(commonInterceptors));</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                allInterceptors.addAll(Arrays.asList(commonInterceptors));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        int nrOfCommonInterceptors = (commonInterceptors != null ? commonInterceptors.length : 0);</span><br><span class="line">        int nrOfSpecificInterceptors = (specificInterceptors != null ? specificInterceptors.length : 0);</span><br><span class="line">        logger.debug(&quot;Creating implicit proxy for bean &apos;&quot; + beanName + &quot;&apos; with &quot; + nrOfCommonInterceptors +</span><br><span class="line">                &quot; common interceptors and &quot; + nrOfSpecificInterceptors + &quot; specific interceptors&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Advisor[] advisors = new Advisor[allInterceptors.size()];</span><br><span class="line">    for (int i = 0; i &lt; allInterceptors.size(); i++) &#123;</span><br><span class="line">        //拦截器封装转化为Advisor</span><br><span class="line">        advisors[i] = this.advisorAdapterRegistry.wrap(allInterceptors.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、DefaultAdvisorAdapterRegistry的wrap方法"><a href="#16、DefaultAdvisorAdapterRegistry的wrap方法" class="headerlink" title="16、DefaultAdvisorAdapterRegistry的wrap方法"></a>16、DefaultAdvisorAdapterRegistry的wrap方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Advisor wrap(Object adviceObject) throws UnknownAdviceTypeException &#123;</span><br><span class="line">    //已经是Advisor类型无需转换</span><br><span class="line">    if (adviceObject instanceof Advisor) &#123;</span><br><span class="line">        return (Advisor) adviceObject;</span><br><span class="line">    &#125;</span><br><span class="line">    //不是Advice则抛出异常</span><br><span class="line">    if (!(adviceObject instanceof Advice)) &#123;</span><br><span class="line">        throw new UnknownAdviceTypeException(adviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    Advice advice = (Advice) adviceObject;</span><br><span class="line">    if (advice instanceof MethodInterceptor) &#123;</span><br><span class="line">        // So well-known it doesn&apos;t even need an adapter.</span><br><span class="line">        //使用默认切点，全部匹配</span><br><span class="line">        return new DefaultPointcutAdvisor(advice);</span><br><span class="line">    &#125;</span><br><span class="line">    //存在适配器</span><br><span class="line">    for (AdvisorAdapter adapter : this.adapters) &#123;</span><br><span class="line">        // Check that it is supported.</span><br><span class="line">        if (adapter.supportsAdvice(advice)) &#123;</span><br><span class="line">            return new DefaultPointcutAdvisor(advice);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    throw new UnknownAdviceTypeException(advice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、接（二、14）ProxyFactory的getProxy方法"><a href="#17、接（二、14）ProxyFactory的getProxy方法" class="headerlink" title="17、接（二、14）ProxyFactory的getProxy方法"></a>17、接（二、14）ProxyFactory的getProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Object getProxy() &#123;</span><br><span class="line">    return createAopProxy().getProxy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、ProxyFactory的createAopProxy方法"><a href="#18、ProxyFactory的createAopProxy方法" class="headerlink" title="18、ProxyFactory的createAopProxy方法"></a>18、ProxyFactory的createAopProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected final synchronized AopProxy createAopProxy() &#123;</span><br><span class="line">    if (!this.active) &#123;</span><br><span class="line">        //广播代理被创建</span><br><span class="line">        activate();</span><br><span class="line">    &#125;</span><br><span class="line">    //创建代理</span><br><span class="line">    return getAopProxyFactory().createAopProxy(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、DefaultAopProxyFactory的createAopProxy方法"><a href="#19、DefaultAopProxyFactory的createAopProxy方法" class="headerlink" title="19、DefaultAopProxyFactory的createAopProxy方法"></a>19、DefaultAopProxyFactory的createAopProxy方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123;</span><br><span class="line">    //optimize 设置Cglib是否使用激进优化策略</span><br><span class="line">    //proxyTargetClass 设置是否使用Cglib代理</span><br><span class="line">    //是否存在可代理接口</span><br><span class="line">    if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">        Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">        if (targetClass == null) &#123;</span><br><span class="line">            throw new AopConfigException(&quot;TargetSource cannot determine target class: &quot; +</span><br><span class="line">                    &quot;Either an interface or a target is required for proxy creation.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //目标类为接口</span><br><span class="line">        if (targetClass.isInterface()) &#123;</span><br><span class="line">            return new JdkDynamicAopProxy(config);</span><br><span class="line">        &#125;</span><br><span class="line">        return new ObjenesisCglibAopProxy(config);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return new JdkDynamicAopProxy(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、JdkDynamicAopProxy的getProxy方法"><a href="#20、JdkDynamicAopProxy的getProxy方法" class="headerlink" title="20、JdkDynamicAopProxy的getProxy方法"></a>20、JdkDynamicAopProxy的getProxy方法</h4><p>jdk动态代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy() &#123;</span><br><span class="line">    return getProxy(ClassUtils.getDefaultClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy(ClassLoader classLoader) &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Creating JDK dynamic proxy: target source is &quot; + this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line">    //获取要代理的全部接口,额外添加SpringProxy接口用以标识AOP代理对象，Advised接口用以操作该对象的advice</span><br><span class="line">    Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised);</span><br><span class="line">    //equals和hashCode方法是否被重写</span><br><span class="line">    findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</span><br><span class="line">    //创建代理对象</span><br><span class="line">    return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、JdkDynamicAopProxy的invoke方法"><a href="#21、JdkDynamicAopProxy的invoke方法" class="headerlink" title="21、JdkDynamicAopProxy的invoke方法"></a>21、JdkDynamicAopProxy的invoke方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    MethodInvocation invocation;</span><br><span class="line">    Object oldProxy = null;</span><br><span class="line">    boolean setProxyContext = false;</span><br><span class="line"></span><br><span class="line">    TargetSource targetSource = this.advised.targetSource;</span><br><span class="line">    Class&lt;?&gt; targetClass = null;</span><br><span class="line">    Object target = null;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //处理equals方法</span><br><span class="line">        if (!this.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">            // The target does not implement the equals(Object) method itself.</span><br><span class="line">            return equals(args[0]);</span><br><span class="line">        &#125;</span><br><span class="line">        //hash方法处理</span><br><span class="line">        if (!this.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">            // The target does not implement the hashCode() method itself.</span><br><span class="line">            return hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">        //Advised的方法或者其超类接口的方法，执行ProxyFactory对象的方法，用于操作增强</span><br><span class="line">        if (!this.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span><br><span class="line">                method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">            // Service invocations on ProxyConfig with the proxy config...</span><br><span class="line">            return AopUtils.invokeJoinpointUsingReflection(this.advised, method, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object retVal;</span><br><span class="line">        //支持对象内部自我调用时，可获取到代理对象，将该代理对象放入本地线程变量</span><br><span class="line">        if (this.advised.exposeProxy) &#123;</span><br><span class="line">            // Make invocation available if necessary.</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // May be null. Get as late as possible to minimize the time we &quot;own&quot; the target,</span><br><span class="line">        // in case it comes from a pool.</span><br><span class="line">        //被代理的对象</span><br><span class="line">        target = targetSource.getTarget();</span><br><span class="line">        if (target != null) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Get the interception chain for this method.</span><br><span class="line">        //获取当前方法的拦截器链</span><br><span class="line">        List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line"></span><br><span class="line">        // Check whether we have any advice. If we don&apos;t, we can fallback on direct</span><br><span class="line">        // reflective invocation of the target, and avoid creating a MethodInvocation.</span><br><span class="line">        if (chain.isEmpty()) &#123;</span><br><span class="line">            // We can skip creating a MethodInvocation: just invoke the target directly</span><br><span class="line">            // Note that the final invoker must be an InvokerInterceptor so we know it does</span><br><span class="line">            // nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span><br><span class="line">            //没有拦截器，直接调用对象方法</span><br><span class="line">            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, args);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // We need to create a method invocation...</span><br><span class="line">            //封装拦截器链</span><br><span class="line">            invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">            // Proceed to the joinpoint through the interceptor chain.</span><br><span class="line">            //执行拦截器链</span><br><span class="line">            retVal = invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Massage return value if necessary.</span><br><span class="line">        //返回结果</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        if (retVal != null &amp;&amp; retVal == target &amp;&amp; returnType.isInstance(proxy) &amp;&amp;</span><br><span class="line">                !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">            // Special case: it returned &quot;this&quot; and the return type of the method</span><br><span class="line">            // is type-compatible. Note that we can&apos;t help if the target sets</span><br><span class="line">            // a reference to itself in another returned object.</span><br><span class="line">            retVal = proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">            throw new AopInvocationException(</span><br><span class="line">                    &quot;Null return value from advice does not match primitive return type for: &quot; + method);</span><br><span class="line">        &#125;</span><br><span class="line">        return retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        if (target != null &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">            // Must have come from TargetSource.</span><br><span class="line">            targetSource.releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        if (setProxyContext) &#123;</span><br><span class="line">            // Restore old proxy.</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法"><a href="#22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法" class="headerlink" title="22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法"></a>22、JdkDynamicAopProxy的getInterceptorsAndDynamicInterceptionAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">    MethodCacheKey cacheKey = new MethodCacheKey(method);</span><br><span class="line">    List&lt;Object&gt; cached = this.methodCache.get(cacheKey);</span><br><span class="line">    if (cached == null) &#123;</span><br><span class="line">        //获取拦截器链</span><br><span class="line">        cached = this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice(</span><br><span class="line">                this, method, targetClass);</span><br><span class="line">        this.methodCache.put(cacheKey, cached);</span><br><span class="line">    &#125;</span><br><span class="line">    return cached;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法"><a href="#23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法" class="headerlink" title="23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法"></a>23、DefaultAdvisorChainFactory的getInterceptorsAndDynamicInterceptionAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(</span><br><span class="line">        Advised config, Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line"></span><br><span class="line">    // This is somewhat tricky... We have to process introductions first,</span><br><span class="line">    // but we need to preserve order in the ultimate list.</span><br><span class="line">    List&lt;Object&gt; interceptorList = new ArrayList&lt;Object&gt;(config.getAdvisors().length);</span><br><span class="line">    Class&lt;?&gt; actualClass = (targetClass != null ? targetClass : method.getDeclaringClass());</span><br><span class="line">    //是否有适合该类的引介增强</span><br><span class="line">    boolean hasIntroductions = hasMatchingIntroductions(config, actualClass);</span><br><span class="line">    AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance();</span><br><span class="line"></span><br><span class="line">    for (Advisor advisor : config.getAdvisors()) &#123;</span><br><span class="line">        if (advisor instanceof PointcutAdvisor) &#123;</span><br><span class="line">            // Add it conditionally.</span><br><span class="line">            PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor;</span><br><span class="line">            //通知匹配该类</span><br><span class="line">            if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) &#123;</span><br><span class="line">                MethodInterceptor[] interceptors = registry.getInterceptors(advisor);</span><br><span class="line">                MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher();</span><br><span class="line">                //通知匹配该方法</span><br><span class="line">                if (MethodMatchers.matches(mm, method, actualClass, hasIntroductions)) &#123;</span><br><span class="line">                    //动态匹配</span><br><span class="line">                    if (mm.isRuntime()) &#123;</span><br><span class="line">                        // Creating a new object instance in the getInterceptors() method</span><br><span class="line">                        // isn&apos;t a problem as we normally cache created chains.</span><br><span class="line">                        for (MethodInterceptor interceptor : interceptors) &#123;</span><br><span class="line">                            interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    //普通拦截器</span><br><span class="line">                    else &#123;</span><br><span class="line">                        interceptorList.addAll(Arrays.asList(interceptors));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //引介增强</span><br><span class="line">        else if (advisor instanceof IntroductionAdvisor) &#123;</span><br><span class="line">            IntroductionAdvisor ia = (IntroductionAdvisor) advisor;</span><br><span class="line">            if (config.isPreFiltered() || ia.getClassFilter().matches(actualClass)) &#123;</span><br><span class="line">                //获取引介增强的拦截器，如DelegatingIntroductionInterceptor，</span><br><span class="line">                //该拦截器会拦截引介增强接口中的方法处理然后返回，其余方法直接放行</span><br><span class="line">                Interceptor[] interceptors = registry.getInterceptors(advisor);</span><br><span class="line">                interceptorList.addAll(Arrays.asList(interceptors));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            Interceptor[] interceptors = registry.getInterceptors(advisor);</span><br><span class="line">            interceptorList.addAll(Arrays.asList(interceptors));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return interceptorList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="24、接（二、21）ReflectiveMethodInvocation的proceed方法"><a href="#24、接（二、21）ReflectiveMethodInvocation的proceed方法" class="headerlink" title="24、接（二、21）ReflectiveMethodInvocation的proceed方法"></a>24、接（二、21）ReflectiveMethodInvocation的proceed方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object proceed() throws Throwable &#123;</span><br><span class="line">    //  We start with an index of -1 and increment early.</span><br><span class="line">    //执行完所有的通知，执行目标方法</span><br><span class="line">    if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) &#123;</span><br><span class="line">        return invokeJoinpoint();</span><br><span class="line">    &#125;</span><br><span class="line">    //获取下一个要执行的拦截器</span><br><span class="line">    Object interceptorOrInterceptionAdvice =</span><br><span class="line">            this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</span><br><span class="line">    //动态匹配</span><br><span class="line">    if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">        // Evaluate dynamic method matcher here: static part will already have</span><br><span class="line">        // been evaluated and found to match.</span><br><span class="line">        InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">        if (dm.methodMatcher.matches(this.method, this.targetClass, this.arguments)) &#123;</span><br><span class="line">            return dm.interceptor.invoke(this);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Dynamic matching failed.</span><br><span class="line">            // Skip this interceptor and invoke the next in the chain.</span><br><span class="line">            //不匹配则不拦截</span><br><span class="line">            return proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // It&apos;s an interceptor, so we just invoke it: The pointcut will have</span><br><span class="line">        // been evaluated statically before this object was constructed.</span><br><span class="line">        //普通拦截器，递归调用proceed</span><br><span class="line">        return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="25、CglibAopProxy的getProxy方法"><a href="#25、CglibAopProxy的getProxy方法" class="headerlink" title="25、CglibAopProxy的getProxy方法"></a>25、CglibAopProxy的getProxy方法</h4><p>CglibAopProxy的动态代理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy() &#123;</span><br><span class="line">    return getProxy(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy(ClassLoader classLoader) &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Creating CGLIB proxy: target source is &quot; + this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //代理的目标类</span><br><span class="line">        Class&lt;?&gt; rootClass = this.advised.getTargetClass();</span><br><span class="line">        Assert.state(rootClass != null, &quot;Target class must be available for creating a CGLIB proxy&quot;);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; proxySuperClass = rootClass;</span><br><span class="line">        //该类已经是代理类</span><br><span class="line">        if (ClassUtils.isCglibProxyClass(rootClass)) &#123;</span><br><span class="line">            proxySuperClass = rootClass.getSuperclass();</span><br><span class="line">            Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();</span><br><span class="line">            for (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;</span><br><span class="line">                this.advised.addInterface(additionalInterface);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Validate the class, writing log messages as necessary.</span><br><span class="line">        //验证类及其父类有无不可被代理的方法</span><br><span class="line">        validateClassIfNecessary(proxySuperClass, classLoader);</span><br><span class="line"></span><br><span class="line">        // Configure CGLIB Enhancer...</span><br><span class="line">        Enhancer enhancer = createEnhancer();</span><br><span class="line">        if (classLoader != null) &#123;</span><br><span class="line">            enhancer.setClassLoader(classLoader);</span><br><span class="line">            if (classLoader instanceof SmartClassLoader &amp;&amp;</span><br><span class="line">                    ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">                enhancer.setUseCache(false);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //被代理的类</span><br><span class="line">        enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">        //代理类实现的接口</span><br><span class="line">        enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(this.advised));</span><br><span class="line">        enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">        enhancer.setStrategy(new UndeclaredThrowableStrategy(UndeclaredThrowableException.class));</span><br><span class="line">        //设置拦截器</span><br><span class="line">        Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">        Class&lt;?&gt;[] types = new Class&lt;?&gt;[callbacks.length];</span><br><span class="line">        for (int x = 0; x &lt; types.length; x++) &#123;</span><br><span class="line">            types[x] = callbacks[x].getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        // fixedInterceptorMap only populated at this point, after getCallbacks call above</span><br><span class="line">        //过滤器</span><br><span class="line">        enhancer.setCallbackFilter(new ProxyCallbackFilter(</span><br><span class="line">                this.advised.getConfigurationOnlyCopy(), this.fixedInterceptorMap, this.fixedInterceptorOffset));</span><br><span class="line">        enhancer.setCallbackTypes(types);</span><br><span class="line"></span><br><span class="line">        // Generate the proxy class and create a proxy instance.</span><br><span class="line">        //创建代理对象</span><br><span class="line">        return createProxyClassAndInstance(enhancer, callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (CodeGenerationException ex) &#123;</span><br><span class="line">        throw new AopConfigException(&quot;Could not generate CGLIB subclass of class [&quot; +</span><br><span class="line">                this.advised.getTargetClass() + &quot;]: &quot; +</span><br><span class="line">                &quot;Common causes of this problem include using a final class or a non-visible class&quot;,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IllegalArgumentException ex) &#123;</span><br><span class="line">        throw new AopConfigException(&quot;Could not generate CGLIB subclass of class [&quot; +</span><br><span class="line">                this.advised.getTargetClass() + &quot;]: &quot; +</span><br><span class="line">                &quot;Common causes of this problem include using a final class or a non-visible class&quot;,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        // TargetSource.getTarget() failed</span><br><span class="line">        throw new AopConfigException(&quot;Unexpected AOP exception&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="26、CglibAopProxy的getCallbacks方法"><a href="#26、CglibAopProxy的getCallbacks方法" class="headerlink" title="26、CglibAopProxy的getCallbacks方法"></a>26、CglibAopProxy的getCallbacks方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">private Callback[] getCallbacks(Class&lt;?&gt; rootClass) throws Exception &#123;</span><br><span class="line">    // Parameters used for optimisation choices...</span><br><span class="line">    boolean exposeProxy = this.advised.isExposeProxy();</span><br><span class="line">    boolean isFrozen = this.advised.isFrozen();</span><br><span class="line">    //getTarget每次获取的是同一个对象，默认true</span><br><span class="line">    boolean isStatic = this.advised.getTargetSource().isStatic();</span><br><span class="line"></span><br><span class="line">    // Choose an &quot;aop&quot; interceptor (used for AOP calls).</span><br><span class="line">    //拦截器</span><br><span class="line">    Callback aopInterceptor = new DynamicAdvisedInterceptor(this.advised);</span><br><span class="line"></span><br><span class="line">    // Choose a &quot;straight to target&quot; interceptor. (used for calls that are</span><br><span class="line">    // unadvised but can return this). May be required to expose the proxy.</span><br><span class="line">    Callback targetInterceptor;</span><br><span class="line">    //类内部调用时，是否增强</span><br><span class="line">    if (exposeProxy) &#123;</span><br><span class="line">        targetInterceptor = isStatic ?</span><br><span class="line">                new StaticUnadvisedExposedInterceptor(this.advised.getTargetSource().getTarget()) :</span><br><span class="line">                new DynamicUnadvisedExposedInterceptor(this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        targetInterceptor = isStatic ?</span><br><span class="line">                new StaticUnadvisedInterceptor(this.advised.getTargetSource().getTarget()) :</span><br><span class="line">                new DynamicUnadvisedInterceptor(this.advised.getTargetSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Choose a &quot;direct to target&quot; dispatcher (used for</span><br><span class="line">    // unadvised calls to static targets that cannot return this).</span><br><span class="line">    Callback targetDispatcher = isStatic ?</span><br><span class="line">            new StaticDispatcher(this.advised.getTargetSource().getTarget()) : new SerializableNoOp();</span><br><span class="line"></span><br><span class="line">    Callback[] mainCallbacks = new Callback[]&#123;</span><br><span class="line">        //aop增强</span><br><span class="line">        aopInterceptor, // for normal advice</span><br><span class="line">        //直接执行被代理对象的方法，不增强</span><br><span class="line">        targetInterceptor, // invoke target without considering advice, if optimized</span><br><span class="line">        //代理类无该方法，不处理</span><br><span class="line">        new SerializableNoOp(), // no override for methods mapped to this</span><br><span class="line">        //直接返回内部对象</span><br><span class="line">        targetDispatcher, this.advisedDispatcher,</span><br><span class="line">        //处理Equals方法</span><br><span class="line">        new EqualsInterceptor(this.advised),</span><br><span class="line">        //处理HashCode方法</span><br><span class="line">        new HashCodeInterceptor(this.advised)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Callback[] callbacks;</span><br><span class="line"></span><br><span class="line">    // If the target is a static one and the advice chain is frozen,</span><br><span class="line">    // then we can make some optimisations by sending the AOP calls</span><br><span class="line">    // direct to the target using the fixed chain for that method.</span><br><span class="line">    //getTarget每次获取同一对象且通知链不可被修改</span><br><span class="line">    if (isStatic &amp;&amp; isFrozen) &#123;</span><br><span class="line">        Method[] methods = rootClass.getMethods();</span><br><span class="line">        Callback[] fixedCallbacks = new Callback[methods.length];</span><br><span class="line">        this.fixedInterceptorMap = new HashMap&lt;String, Integer&gt;(methods.length);</span><br><span class="line"></span><br><span class="line">        // TODO: small memory optimisation here (can skip creation for methods with no advice)</span><br><span class="line">        //创建每个方法的拦截器链的缓存</span><br><span class="line">        for (int x = 0; x &lt; methods.length; x++) &#123;</span><br><span class="line">            List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(methods[x], rootClass);</span><br><span class="line">            fixedCallbacks[x] = new FixedChainStaticTargetInterceptor(</span><br><span class="line">                    chain, this.advised.getTargetSource().getTarget(), this.advised.getTargetClass());</span><br><span class="line">            this.fixedInterceptorMap.put(methods[x].toString(), x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Now copy both the callbacks from mainCallbacks</span><br><span class="line">        // and fixedCallbacks into the callbacks array.</span><br><span class="line">        callbacks = new Callback[mainCallbacks.length + fixedCallbacks.length];</span><br><span class="line">        System.arraycopy(mainCallbacks, 0, callbacks, 0, mainCallbacks.length);</span><br><span class="line">        System.arraycopy(fixedCallbacks, 0, callbacks, mainCallbacks.length, fixedCallbacks.length);</span><br><span class="line">        this.fixedInterceptorOffset = mainCallbacks.length;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        callbacks = mainCallbacks;</span><br><span class="line">    &#125;</span><br><span class="line">    return callbacks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="27、ProxyCallbackFilter的accept方法"><a href="#27、ProxyCallbackFilter的accept方法" class="headerlink" title="27、ProxyCallbackFilter的accept方法"></a>27、ProxyCallbackFilter的accept方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int accept(Method method) &#123;</span><br><span class="line">    //finalize方法 不处理</span><br><span class="line">    if (AopUtils.isFinalizeMethod(method)) &#123;</span><br><span class="line">        logger.debug(&quot;Found finalize() method - using NO_OVERRIDE&quot;);</span><br><span class="line">        return NO_OVERRIDE;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回advised对象</span><br><span class="line">    if (!this.advised.isOpaque() &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span><br><span class="line">            method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Method is declared on Advised interface: &quot; + method);</span><br><span class="line">        &#125;</span><br><span class="line">        return DISPATCH_ADVISED;</span><br><span class="line">    &#125;</span><br><span class="line">    // We must always proxy equals, to direct calls to this.</span><br><span class="line">    //equals方法</span><br><span class="line">    if (AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">        logger.debug(&quot;Found &apos;equals&apos; method: &quot; + method);</span><br><span class="line">        return INVOKE_EQUALS;</span><br><span class="line">    &#125;</span><br><span class="line">    // We must always calculate hashCode based on the proxy.</span><br><span class="line">    //hashCode方法</span><br><span class="line">    if (AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">        logger.debug(&quot;Found &apos;hashCode&apos; method: &quot; + method);</span><br><span class="line">        return INVOKE_HASHCODE;</span><br><span class="line">    &#125;</span><br><span class="line">    //代理目标类</span><br><span class="line">    Class&lt;?&gt; targetClass = this.advised.getTargetClass();</span><br><span class="line">    // Proxy is not yet available, but that shouldn&apos;t matter.</span><br><span class="line">    List&lt;?&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">    //是否有通知链</span><br><span class="line">    boolean haveAdvice = !chain.isEmpty();</span><br><span class="line">    //内部调用是否执行通知链</span><br><span class="line">    boolean exposeProxy = this.advised.isExposeProxy();</span><br><span class="line">    boolean isStatic = this.advised.getTargetSource().isStatic();</span><br><span class="line">    boolean isFrozen = this.advised.isFrozen();</span><br><span class="line">    if (haveAdvice || !isFrozen) &#123;</span><br><span class="line">        // If exposing the proxy, then AOP_PROXY must be used.</span><br><span class="line">        if (exposeProxy) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Must expose proxy on advised method: &quot; + method);</span><br><span class="line">            &#125;</span><br><span class="line">            //执行AOP增强</span><br><span class="line">            return AOP_PROXY;</span><br><span class="line">        &#125;</span><br><span class="line">        String key = method.toString();</span><br><span class="line">        // Check to see if we have fixed interceptor to serve this method.</span><br><span class="line">        // Else use the AOP_PROXY.</span><br><span class="line">        //使用缓存的方法通知链</span><br><span class="line">        if (isStatic &amp;&amp; isFrozen &amp;&amp; this.fixedInterceptorMap.containsKey(key)) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method has advice and optimisations are enabled: &quot; + method);</span><br><span class="line">            &#125;</span><br><span class="line">            // We know that we are optimising so we can use the</span><br><span class="line">            // FixedStaticChainInterceptors.</span><br><span class="line">            int index = this.fixedInterceptorMap.get(key);</span><br><span class="line">            return (index + this.fixedInterceptorOffset);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Unable to apply any optimisations to advised method: &quot; + method);</span><br><span class="line">            &#125;</span><br><span class="line">            //执行AOP增强</span><br><span class="line">            return AOP_PROXY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // See if the return type of the method is outside the class hierarchy</span><br><span class="line">        // of the target type. If so we know it never needs to have return type</span><br><span class="line">        // massage and can use a dispatcher.</span><br><span class="line">        // If the proxy is being exposed, then must use the interceptor the</span><br><span class="line">        // correct one is already configured. If the target is not static, then</span><br><span class="line">        // cannot use a dispatcher because the target cannot be released.</span><br><span class="line">        //直接执行方法</span><br><span class="line">        if (exposeProxy || !isStatic) &#123;</span><br><span class="line">            return INVOKE_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        //返回该代理对象</span><br><span class="line">        if (targetClass == returnType) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method &quot; + method +</span><br><span class="line">                        &quot;has return type same as target type (may return this) - using INVOKE_TARGET&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return INVOKE_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">        //直接返回被代理对象</span><br><span class="line">        else if (returnType.isPrimitive() || !returnType.isAssignableFrom(targetClass)) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method &quot; + method +</span><br><span class="line">                        &quot; has return type that ensures this cannot be returned- using DISPATCH_TARGET&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return DISPATCH_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Method &quot; + method +</span><br><span class="line">                        &quot;has return type that is assignable from the target type (may return this) - &quot; +</span><br><span class="line">                        &quot;using INVOKE_TARGET&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return INVOKE_TARGET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="28、DynamicAdvisedInterceptor的intercept方法"><a href="#28、DynamicAdvisedInterceptor的intercept方法" class="headerlink" title="28、DynamicAdvisedInterceptor的intercept方法"></a>28、DynamicAdvisedInterceptor的intercept方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">    Object oldProxy = null;</span><br><span class="line">    boolean setProxyContext = false;</span><br><span class="line">    Class&lt;?&gt; targetClass = null;</span><br><span class="line">    Object target = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        //内部调用代理</span><br><span class="line">        if (this.advised.exposeProxy) &#123;</span><br><span class="line">            // Make invocation available if necessary.</span><br><span class="line">            oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">            setProxyContext = true;</span><br><span class="line">        &#125;</span><br><span class="line">        // May be null. Get as late as possible to minimize the time we</span><br><span class="line">        // &quot;own&quot; the target, in case it comes from a pool...</span><br><span class="line">        target = getTarget();</span><br><span class="line">        if (target != null) &#123;</span><br><span class="line">            targetClass = target.getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        //获取通知链</span><br><span class="line">        List&lt;Object&gt; chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">        Object retVal;</span><br><span class="line">        // Check whether we only have one InvokerInterceptor: that is,</span><br><span class="line">        // no real advice, but just reflective invocation of the target.</span><br><span class="line">        if (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">            // We can skip creating a MethodInvocation: just invoke the target directly.</span><br><span class="line">            // Note that the final invoker must be an InvokerInterceptor, so we know</span><br><span class="line">            // it does nothing but a reflective operation on the target, and no hot</span><br><span class="line">            // swapping or fancy proxying.</span><br><span class="line">            //直接执行该方法</span><br><span class="line">            retVal = methodProxy.invoke(target, args);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // We need to create a method invocation...</span><br><span class="line">            //执行通知链</span><br><span class="line">            retVal = new CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        //处理返回结果</span><br><span class="line">        retVal = processReturnType(proxy, target, method, retVal);</span><br><span class="line">        return retVal;</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        if (target != null) &#123;</span><br><span class="line">            releaseTarget(target);</span><br><span class="line">        &#125;</span><br><span class="line">        if (setProxyContext) &#123;</span><br><span class="line">            // Restore old proxy.</span><br><span class="line">            AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、注解方式的AOP动态代理"><a href="#二、注解方式的AOP动态代理" class="headerlink" title="二、注解方式的AOP动态代理"></a>二、注解方式的AOP动态代理</h3><p>####demo<br>配置示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">    xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/context</span><br><span class="line">        http://www.springframework.org/schema/context/spring-context.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;  </span><br><span class="line">       </span><br><span class="line">    &lt;!-- 开启aop注解方式,默认为false --&gt;    </span><br><span class="line">    &lt;aop:aspectj-autoproxy&gt;</span><br><span class="line">        //切面类名</span><br><span class="line">        &lt;aop:include name=&quot;aop&quot;/&gt;</span><br><span class="line">    &lt;/aop:aspectj-autoproxy&gt;</span><br><span class="line">     </span><br><span class="line">    &lt;bean id=&quot;userDao&quot; class=&quot;com.baobaotao.simple.UserDao&quot;&gt;&lt;/bean&gt;</span><br><span class="line">    &lt;bean class=&quot;com.demo.aop.AOP&quot;&gt;&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<p>切面示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Aspect  //指定当前类为切面类</span><br><span class="line">public class Aop &#123;</span><br><span class="line"></span><br><span class="line">    //拦截该对象下所有方法</span><br><span class="line">    @Pointcut(&quot;execution(* com.demo.aop.UserDao.*(..))&quot;)</span><br><span class="line">    public void pointCut()&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Before(&quot;pointCut()&quot;)</span><br><span class="line">    public void begin()&#123;</span><br><span class="line">        System.out.println(&quot;开启事务&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @After(&quot;pointCut()&quot;)</span><br><span class="line">    public void close()&#123;</span><br><span class="line">        System.out.println(&quot;关闭事务&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      //&quot;+&quot;表示demo的所有子类；defaultImpl 表示默认需要添加的新的类</span><br><span class="line">    @DeclareParents(value = &quot;com.demo.Demo+&quot;, defaultImpl = Demo.class)</span><br><span class="line">    public UserDao userDao;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>被增强的对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class UserDao &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void save() &#123;</span><br><span class="line">        System.out.println(&quot;..核心业务--核心业务..&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="1、AspectJAutoProxyBeanDefinitionParser的parse方法"><a href="#1、AspectJAutoProxyBeanDefinitionParser的parse方法" class="headerlink" title="1、AspectJAutoProxyBeanDefinitionParser的parse方法"></a>1、AspectJAutoProxyBeanDefinitionParser的parse方法</h4><p>读取配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //注册AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">    AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);</span><br><span class="line">    //将子节点的相关信息添加到beanDefinition</span><br><span class="line">    extendBeanDefinition(element, parserContext);</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"><a href="#2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法" class="headerlink" title="2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"></a>2、AopNamespaceUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary(</span><br><span class="line">        ParserContext parserContext, Element sourceElement) &#123;</span><br><span class="line">    //注册AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">    BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(</span><br><span class="line">            parserContext.getRegistry(), parserContext.extractSource(sourceElement));</span><br><span class="line">    //设置proxyTargetClass和exposeProxy属性</span><br><span class="line">    useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);</span><br><span class="line">    //注册并广播AOP组件</span><br><span class="line">    registerComponentIfNecessary(beanDefinition, parserContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"><a href="#3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法" class="headerlink" title="3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法"></a>3、AopConfigUtils的registerAspectJAnnotationAutoProxyCreatorIfNecessary方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    return registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法"><a href="#4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法" class="headerlink" title="4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法"></a>4、AopNamespaceUtils的registerOrEscalateApcAsRequired方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private static BeanDefinition registerOrEscalateApcAsRequired(Class&lt;?&gt; cls, BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">    //已存在，选择优先级高的</span><br><span class="line">    if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;</span><br><span class="line">        BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">        if (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;</span><br><span class="line">            int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName());</span><br><span class="line">            int requiredPriority = findPriorityForClass(cls);</span><br><span class="line">            if (currentPriority &lt; requiredPriority) &#123;</span><br><span class="line">                apcDefinition.setBeanClassName(cls.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //AnnotationAwareAspectJAutoProxyCreator的BeanDefinition</span><br><span class="line">    RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);</span><br><span class="line">    beanDefinition.setSource(source);</span><br><span class="line">    //最高的优先级</span><br><span class="line">    beanDefinition.getPropertyValues().add(&quot;order&quot;, Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">    //基础设施</span><br><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //注册该BeanDefinition</span><br><span class="line">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br><span class="line">    return beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法"><a href="#5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法" class="headerlink" title="5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法"></a>5、接（三、1）AspectJAutoProxyBeanDefinitionParser的extendBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void extendBeanDefinition(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    BeanDefinition beanDef =</span><br><span class="line">            parserContext.getRegistry().getBeanDefinition(AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME);</span><br><span class="line">    if (element.hasChildNodes()) &#123;</span><br><span class="line">        //解析子节点</span><br><span class="line">        addIncludePatterns(element, parserContext, beanDef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法"><a href="#6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法" class="headerlink" title="6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法"></a>6、AspectJAutoProxyBeanDefinitionParser的addIncludePatterns方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void addIncludePatterns(Element element, ParserContext parserContext, BeanDefinition beanDef) &#123;</span><br><span class="line">    ManagedList&lt;TypedStringValue&gt; includePatterns = new ManagedList&lt;TypedStringValue&gt;();</span><br><span class="line">    NodeList childNodes = element.getChildNodes();</span><br><span class="line">    for (int i = 0; i &lt; childNodes.getLength(); i++) &#123;</span><br><span class="line">        Node node = childNodes.item(i);</span><br><span class="line">        if (node instanceof Element) &#123;</span><br><span class="line">            Element includeElement = (Element) node;</span><br><span class="line">            TypedStringValue valueHolder = new TypedStringValue(includeElement.getAttribute(&quot;name&quot;));</span><br><span class="line">            valueHolder.setSource(parserContext.extractSource(includeElement));</span><br><span class="line">            includePatterns.add(valueHolder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!includePatterns.isEmpty()) &#123;</span><br><span class="line">        includePatterns.setSource(parserContext.extractSource(element));</span><br><span class="line">        //子节点加入bean</span><br><span class="line">        beanDef.getPropertyValues().add(&quot;includePatterns&quot;, includePatterns);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法"><a href="#7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法" class="headerlink" title="7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法"></a>7、AnnotationAwareAspectJAutoProxyCreator的findCandidateAdvisors方法</h4><p>创建代理对象之前，首先获取通知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected List&lt;Advisor&gt; findCandidateAdvisors() &#123;</span><br><span class="line">    // Add all the Spring advisors found according to superclass rules.</span><br><span class="line">    //父类的获取通知方法，与上一节相同</span><br><span class="line">    List&lt;Advisor&gt; advisors = super.findCandidateAdvisors();</span><br><span class="line">    // Build Advisors for all AspectJ aspects in the bean factory.</span><br><span class="line">    //获取注解AspectJ的类的通知器</span><br><span class="line">    advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors());</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法"><a href="#8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法" class="headerlink" title="8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法"></a>8、BeanFactoryAspectJAdvisorsBuilder的buildAspectJAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Advisor&gt; buildAspectJAdvisors() &#123;</span><br><span class="line">    List&lt;String&gt; aspectNames = null;</span><br><span class="line"></span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        aspectNames = this.aspectBeanNames;</span><br><span class="line">        if (aspectNames == null) &#123;</span><br><span class="line">            List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">            aspectNames = new LinkedList&lt;String&gt;();</span><br><span class="line">            //获取所有beanName</span><br><span class="line">            String[] beanNames =</span><br><span class="line">                    BeanFactoryUtils.beanNamesForTypeIncludingAncestors(this.beanFactory, Object.class, true, false);</span><br><span class="line">            for (String beanName : beanNames) &#123;</span><br><span class="line">                //不合法的bean，默认true，子类定义规则</span><br><span class="line">                if (!isEligibleBean(beanName)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                // We must be careful not to instantiate beans eagerly as in this</span><br><span class="line">                // case they would be cached by the Spring container but would not</span><br><span class="line">                // have been weaved</span><br><span class="line">                Class&lt;?&gt; beanType = this.beanFactory.getType(beanName);</span><br><span class="line">                if (beanType == null) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //该类是否有Aspect注解</span><br><span class="line">                if (this.advisorFactory.isAspect(beanType)) &#123;</span><br><span class="line">                    aspectNames.add(beanName);</span><br><span class="line">                    AspectMetadata amd = new AspectMetadata(beanType, beanName);</span><br><span class="line">                    if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) &#123;</span><br><span class="line">                        MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">                                new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">                        //获取类中的增强方法</span><br><span class="line">                        List&lt;Advisor&gt; classAdvisors = this.advisorFactory.getAdvisors(factory);</span><br><span class="line">                        //添加缓存</span><br><span class="line">                        if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">                            this.advisorsCache.put(beanName, classAdvisors);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else &#123;</span><br><span class="line">                            this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">                        &#125;</span><br><span class="line">                        advisors.addAll(classAdvisors);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        // Per target or per this.</span><br><span class="line">                        if (this.beanFactory.isSingleton(beanName)) &#123;</span><br><span class="line">                            throw new IllegalArgumentException(&quot;Bean with name &apos;&quot; + beanName +</span><br><span class="line">                                    &quot;&apos; is a singleton, but aspect instantiation model is not singleton&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        MetadataAwareAspectInstanceFactory factory =</span><br><span class="line">                                new PrototypeAspectInstanceFactory(this.beanFactory, beanName);</span><br><span class="line">                        this.aspectFactoryCache.put(beanName, factory);</span><br><span class="line">                        advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            this.aspectBeanNames = aspectNames;</span><br><span class="line">            return advisors;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (aspectNames.isEmpty()) &#123;</span><br><span class="line">        return Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">    //获取缓存中的通知器</span><br><span class="line">    List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    for (String aspectName : aspectNames) &#123;</span><br><span class="line">        List&lt;Advisor&gt; cachedAdvisors = this.advisorsCache.get(aspectName);</span><br><span class="line">        if (cachedAdvisors != null) &#123;</span><br><span class="line">            advisors.addAll(cachedAdvisors);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            MetadataAwareAspectInstanceFactory factory = this.aspectFactoryCache.get(aspectName);</span><br><span class="line">            advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、ReflectiveAspectJAdvisorFactory的getAdvisors方法"><a href="#9、ReflectiveAspectJAdvisorFactory的getAdvisors方法" class="headerlink" title="9、ReflectiveAspectJAdvisorFactory的getAdvisors方法"></a>9、ReflectiveAspectJAdvisorFactory的getAdvisors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public List&lt;Advisor&gt; getAdvisors(MetadataAwareAspectInstanceFactory maaif) &#123;</span><br><span class="line">    final Class&lt;?&gt; aspectClass = maaif.getAspectMetadata().getAspectClass();</span><br><span class="line">    final String aspectName = maaif.getAspectMetadata().getAspectName();</span><br><span class="line">    //验证该类</span><br><span class="line">    validate(aspectClass);</span><br><span class="line"></span><br><span class="line">    // We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span><br><span class="line">    // so that it will only instantiate once.</span><br><span class="line">    final MetadataAwareAspectInstanceFactory lazySingletonAspectInstanceFactory =</span><br><span class="line">            new LazySingletonAspectInstanceFactoryDecorator(maaif);</span><br><span class="line"></span><br><span class="line">    final List&lt;Advisor&gt; advisors = new LinkedList&lt;Advisor&gt;();</span><br><span class="line">    //处理所有注解不为Pointcut的方法</span><br><span class="line">    for (Method method : getAdvisorMethods(aspectClass)) &#123;</span><br><span class="line">        //创建通知器</span><br><span class="line">        Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, advisors.size(), aspectName);</span><br><span class="line">        if (advisor != null) &#123;</span><br><span class="line">            advisors.add(advisor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If it&apos;s a per target aspect, emit the dummy instantiating aspect.</span><br><span class="line">    //通知延迟初始化</span><br><span class="line">    if (!advisors.isEmpty() &amp;&amp; lazySingletonAspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) &#123;</span><br><span class="line">        Advisor instantiationAdvisor = new SyntheticInstantiationAdvisor(lazySingletonAspectInstanceFactory);</span><br><span class="line">        advisors.add(0, instantiationAdvisor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Find introduction fields.</span><br><span class="line">    //处理DeclareParents注解</span><br><span class="line">    for (Field field : aspectClass.getDeclaredFields()) &#123;</span><br><span class="line">        Advisor advisor = getDeclareParentsAdvisor(field);</span><br><span class="line">        if (advisor != null) &#123;</span><br><span class="line">            advisors.add(advisor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return advisors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、ReflectiveAspectJAdvisorFactory的getAdvisor方法"><a href="#10、ReflectiveAspectJAdvisorFactory的getAdvisor方法" class="headerlink" title="10、ReflectiveAspectJAdvisorFactory的getAdvisor方法"></a>10、ReflectiveAspectJAdvisorFactory的getAdvisor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Advisor getAdvisor(Method candidateAdviceMethod, MetadataAwareAspectInstanceFactory aif,</span><br><span class="line">        int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">    validate(aif.getAspectMetadata().getAspectClass());</span><br><span class="line">    //获取切点</span><br><span class="line">    AspectJExpressionPointcut ajexp =</span><br><span class="line">            getPointcut(candidateAdviceMethod, aif.getAspectMetadata().getAspectClass());</span><br><span class="line">    if (ajexp == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建通知器</span><br><span class="line">    return new InstantiationModelAwarePointcutAdvisorImpl(</span><br><span class="line">            this, ajexp, aif, candidateAdviceMethod, declarationOrderInAspect, aspectName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、ReflectiveAspectJAdvisorFactory的getPointcut方法"><a href="#11、ReflectiveAspectJAdvisorFactory的getPointcut方法" class="headerlink" title="11、ReflectiveAspectJAdvisorFactory的getPointcut方法"></a>11、ReflectiveAspectJAdvisorFactory的getPointcut方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private AspectJExpressionPointcut getPointcut(Method candidateAdviceMethod, Class&lt;?&gt; candidateAspectClass) &#123;</span><br><span class="line">    //获取方法上的注解</span><br><span class="line">    AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br><span class="line">            AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br><span class="line">    if (aspectJAnnotation == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //切点类</span><br><span class="line">    AspectJExpressionPointcut ajexp =</span><br><span class="line">            new AspectJExpressionPointcut(candidateAspectClass, new String[0], new Class&lt;?&gt;[0]);</span><br><span class="line">    //设置节点表达式，例如@Before(&quot;pointCut()&quot;)的&quot;pointCut()&quot;</span><br><span class="line">    ajexp.setExpression(aspectJAnnotation.getPointcutExpression());</span><br><span class="line">    return ajexp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接-三、10-实例化InstantiationModelAwarePointcutAdvisorImpl"><a href="#12、接-三、10-实例化InstantiationModelAwarePointcutAdvisorImpl" class="headerlink" title="12、接(三、10)实例化InstantiationModelAwarePointcutAdvisorImpl"></a>12、接(三、10)实例化InstantiationModelAwarePointcutAdvisorImpl</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public InstantiationModelAwarePointcutAdvisorImpl(AspectJAdvisorFactory af, AspectJExpressionPointcut ajexp,</span><br><span class="line">        MetadataAwareAspectInstanceFactory aif, Method method, int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">    this.declaredPointcut = ajexp;</span><br><span class="line">    this.method = method;</span><br><span class="line">    this.atAspectJAdvisorFactory = af;</span><br><span class="line">    this.aspectInstanceFactory = aif;</span><br><span class="line">    this.declarationOrder = declarationOrderInAspect;</span><br><span class="line">    this.aspectName = aspectName;</span><br><span class="line"></span><br><span class="line">    if (aif.getAspectMetadata().isLazilyInstantiated()) &#123;</span><br><span class="line">        // Static part of the pointcut is a lazy type.</span><br><span class="line">        Pointcut preInstantiationPointcut =</span><br><span class="line">                Pointcuts.union(aif.getAspectMetadata().getPerClausePointcut(), this.declaredPointcut);</span><br><span class="line"></span><br><span class="line">        // Make it dynamic: must mutate from pre-instantiation to post-instantiation state.</span><br><span class="line">        // If it&apos;s not a dynamic pointcut, it may be optimized out</span><br><span class="line">        // by the Spring AOP infrastructure after the first evaluation.</span><br><span class="line">        this.pointcut = new PerTargetInstantiationModelPointcut(this.declaredPointcut, preInstantiationPointcut, aif);</span><br><span class="line">        this.lazy = true;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // A singleton aspect.</span><br><span class="line">        //创建增强器</span><br><span class="line">        this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut);</span><br><span class="line">        this.pointcut = declaredPointcut;</span><br><span class="line">        this.lazy = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法"><a href="#13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法" class="headerlink" title="13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法"></a>13、InstantiationModelAwarePointcutAdvisorImpl的instantiateAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private Advice instantiateAdvice(AspectJExpressionPointcut pcut) &#123;</span><br><span class="line">    return this.atAspectJAdvisorFactory.getAdvice(</span><br><span class="line">            this.method, pcut, this.aspectInstanceFactory, this.declarationOrder, this.aspectName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、ReflectiveAspectJAdvisorFactory的getAdvice方法"><a href="#14、ReflectiveAspectJAdvisorFactory的getAdvice方法" class="headerlink" title="14、ReflectiveAspectJAdvisorFactory的getAdvice方法"></a>14、ReflectiveAspectJAdvisorFactory的getAdvice方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Advice getAdvice(Method candidateAdviceMethod, AspectJExpressionPointcut ajexp,</span><br><span class="line">        MetadataAwareAspectInstanceFactory aif, int declarationOrderInAspect, String aspectName) &#123;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; candidateAspectClass = aif.getAspectMetadata().getAspectClass();</span><br><span class="line">    validate(candidateAspectClass);</span><br><span class="line">    //获取方法注解</span><br><span class="line">    AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br><span class="line">            AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br><span class="line">    if (aspectJAnnotation == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If we get here, we know we have an AspectJ method.</span><br><span class="line">    // Check that it&apos;s an AspectJ-annotated class</span><br><span class="line">    if (!isAspect(candidateAspectClass)) &#123;</span><br><span class="line">        throw new AopConfigException(&quot;Advice must be declared inside an aspect type: &quot; +</span><br><span class="line">                &quot;Offending method &apos;&quot; + candidateAdviceMethod + &quot;&apos; in class [&quot; +</span><br><span class="line">                candidateAspectClass.getName() + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Found AspectJ method: &quot; + candidateAdviceMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AbstractAspectJAdvice springAdvice;</span><br><span class="line">    //不同的注解类型，创建不同的增强器</span><br><span class="line">    switch (aspectJAnnotation.getAnnotationType()) &#123;</span><br><span class="line">        case AtBefore:</span><br><span class="line">            springAdvice = new AspectJMethodBeforeAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            break;</span><br><span class="line">        case AtAfter:</span><br><span class="line">            springAdvice = new AspectJAfterAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            break;</span><br><span class="line">        case AtAfterReturning:</span><br><span class="line">            springAdvice = new AspectJAfterReturningAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            AfterReturning afterReturningAnnotation = (AfterReturning) aspectJAnnotation.getAnnotation();</span><br><span class="line">            if (StringUtils.hasText(afterReturningAnnotation.returning())) &#123;</span><br><span class="line">                springAdvice.setReturningName(afterReturningAnnotation.returning());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case AtAfterThrowing:</span><br><span class="line">            springAdvice = new AspectJAfterThrowingAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            AfterThrowing afterThrowingAnnotation = (AfterThrowing) aspectJAnnotation.getAnnotation();</span><br><span class="line">            if (StringUtils.hasText(afterThrowingAnnotation.throwing())) &#123;</span><br><span class="line">                springAdvice.setThrowingName(afterThrowingAnnotation.throwing());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case AtAround:</span><br><span class="line">            springAdvice = new AspectJAroundAdvice(candidateAdviceMethod, ajexp, aif);</span><br><span class="line">            break;</span><br><span class="line">        case AtPointcut:</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Processing pointcut &apos;&quot; + candidateAdviceMethod.getName() + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        default:</span><br><span class="line">            throw new UnsupportedOperationException(</span><br><span class="line">                    &quot;Unsupported advice type on method &quot; + candidateAdviceMethod);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Now to configure the advice...</span><br><span class="line">    springAdvice.setAspectName(aspectName);</span><br><span class="line">    springAdvice.setDeclarationOrder(declarationOrderInAspect);</span><br><span class="line">    String[] argNames = this.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);</span><br><span class="line">    if (argNames != null) &#123;</span><br><span class="line">        springAdvice.setArgumentNamesFromStringArray(argNames);</span><br><span class="line">    &#125;</span><br><span class="line">    springAdvice.calculateArgumentBindings();</span><br><span class="line">    return springAdvice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、AOP静态代理"><a href="#四、AOP静态代理" class="headerlink" title="四、AOP静态代理"></a>四、AOP静态代理</h3><p>####demo<br>被代理的类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class DemoBean &#123;</span><br><span class="line">    public void run1() &#123;</span><br><span class="line">        System.out.println(&quot;run1...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public void run2() throws Exception &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(2);</span><br><span class="line">        System.out.println(&quot;run2...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>切面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">public class ProfileAspect &#123;</span><br><span class="line">    @Around(&quot;profileMethod()&quot;)</span><br><span class="line">    public Object profile(ProceedingJoinPoint pjp) throws Throwable &#123;</span><br><span class="line">        StopWatch sw = new StopWatch(getClass().getName());</span><br><span class="line">        try &#123;</span><br><span class="line">            sw.start(pjp.getSignature().getName());</span><br><span class="line">            return pjp.proceed();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            sw.stop();</span><br><span class="line">            System.err.println(sw.prettyPrint());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Pointcut(&quot;execution(public * org.codetree.core.spring.loadtimeweaver.*.*(..))&quot;)</span><br><span class="line">    public void profileMethod() &#123;</span><br><span class="line">        System.out.println(&quot;profileMethod..&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>META-INF/aop.xml的aop.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE aspectj PUBLIC &quot;-//AspectJ//DTD//EN&quot; &quot;http://www.eclipse.org/aspectj/dtd/aspectj.dtd&quot;&gt;</span><br><span class="line">&lt;aspectj&gt;</span><br><span class="line">    &lt;weaver&gt;</span><br><span class="line">        &lt;!-- only weave classes in your application-specific packages --&gt;</span><br><span class="line">        &lt;!--被代理的目标包--&gt;</span><br><span class="line">        &lt;include within=&quot;org.codetree.core.spring.loadtimeweaver.*&quot; /&gt;</span><br><span class="line">    &lt;/weaver&gt;</span><br><span class="line">    &lt;aspects&gt;</span><br><span class="line">        &lt;!-- weave in just these aspects --&gt;</span><br><span class="line">        &lt;aspect name=&quot;org.codetree.core.spring.loadtimeweaver.ProfileAspect&quot; /&gt;</span><br><span class="line">    &lt;/aspects&gt;</span><br><span class="line">&lt;/aspectj&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class ExtInstrumentationLoadTimeWeaver extends InstrumentationLoadTimeWeaver(默认的weaver) &#123;  </span><br><span class="line">    @Override  </span><br><span class="line">    public void addTransformer(ClassFileTransformer transformer) &#123;  </span><br><span class="line">       try &#123;  </span><br><span class="line">           super.addTransformer(transformer);  </span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AOP配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; </span><br><span class="line"></span><br><span class="line">        xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans </span><br><span class="line">    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">    http://www.springframework.org/schema/context</span><br><span class="line">    http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:load-time-weaver weaver-class=&quot;com.multidemo.spring.ExtInstrumentationLoadTimeWeaver&quot; aspectj-weaving=&quot;autodetect&quot; /&gt;  </span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.multidemo&quot;&gt;&lt;/context:component-scan&gt;  </span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="1、ContextNamespaceHandler的init方法"><a href="#1、ContextNamespaceHandler的init方法" class="headerlink" title="1、ContextNamespaceHandler的init方法"></a>1、ContextNamespaceHandler的init方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    registerBeanDefinitionParser(&quot;property-placeholder&quot;, new PropertyPlaceholderBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;property-override&quot;, new PropertyOverrideBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;annotation-config&quot;, new AnnotationConfigBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;component-scan&quot;, new ComponentScanBeanDefinitionParser());</span><br><span class="line">    //注册该标签的解析器</span><br><span class="line">    registerBeanDefinitionParser(&quot;load-time-weaver&quot;, new LoadTimeWeaverBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;spring-configured&quot;, new SpringConfiguredBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;mbean-export&quot;, new MBeanExportBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;mbean-server&quot;, new MBeanServerBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、AbstractBeanDefinitionParser的parse方法"><a href="#2、AbstractBeanDefinitionParser的parse方法" class="headerlink" title="2、AbstractBeanDefinitionParser的parse方法"></a>2、AbstractBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //解析配置文件</span><br><span class="line">    AbstractBeanDefinition definition = parseInternal(element, parserContext);</span><br><span class="line">    if (definition != null &amp;&amp; !parserContext.isNested()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //子类实现，返回&quot;loadTimeWeaver&quot;</span><br><span class="line">            String id = resolveId(element, definition, parserContext);</span><br><span class="line">            if (!StringUtils.hasText(id)) &#123;</span><br><span class="line">                parserContext.getReaderContext().error(</span><br><span class="line">                        &quot;Id is required for element &apos;&quot; + parserContext.getDelegate().getLocalName(element)</span><br><span class="line">                                + &quot;&apos; when used as a top-level tag&quot;, element);</span><br><span class="line">            &#125;</span><br><span class="line">            String[] aliases = null;</span><br><span class="line">            if (shouldParseNameAsAliases()) &#123;</span><br><span class="line">                String name = element.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">                if (StringUtils.hasLength(name)) &#123;</span><br><span class="line">                    aliases = StringUtils.trimArrayElements(StringUtils.commaDelimitedListToStringArray(name));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            BeanDefinitionHolder holder = new BeanDefinitionHolder(definition, id, aliases);</span><br><span class="line">            //注册该bean</span><br><span class="line">            registerBeanDefinition(holder, parserContext.getRegistry());</span><br><span class="line">            //注册并广播该组件</span><br><span class="line">            if (shouldFireEvents()) &#123;</span><br><span class="line">                BeanComponentDefinition componentDefinition = new BeanComponentDefinition(holder);</span><br><span class="line">                postProcessComponentDefinition(componentDefinition);</span><br><span class="line">                parserContext.registerComponent(componentDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            parserContext.getReaderContext().error(ex.getMessage(), element);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return definition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AbstractSingleBeanDefinitionParser的parseInternal方法"><a href="#3、AbstractSingleBeanDefinitionParser的parseInternal方法" class="headerlink" title="3、AbstractSingleBeanDefinitionParser的parseInternal方法"></a>3、AbstractSingleBeanDefinitionParser的parseInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final AbstractBeanDefinition parseInternal(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();</span><br><span class="line">    String parentName = getParentName(element);</span><br><span class="line">    if (parentName != null) &#123;</span><br><span class="line">        builder.getRawBeanDefinition().setParentName(parentName);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取weaver-class属性，子类实现，默认返回&quot;org.springframework.context.weaving.DefaultContextLoadTimeWeaver&quot;</span><br><span class="line">    //本例返回&quot;com.multidemo.spring.ExtInstrumentationLoadTimeWeaver&quot;</span><br><span class="line">    Class&lt;?&gt; beanClass = getBeanClass(element);</span><br><span class="line">    if (beanClass != null) &#123;</span><br><span class="line">        builder.getRawBeanDefinition().setBeanClass(beanClass);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        String beanClassName = getBeanClassName(element);</span><br><span class="line">        if (beanClassName != null) &#123;</span><br><span class="line">            builder.getRawBeanDefinition().setBeanClassName(beanClassName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    builder.getRawBeanDefinition().setSource(parserContext.extractSource(element));</span><br><span class="line">    if (parserContext.isNested()) &#123;</span><br><span class="line">        // Inner bean definition must receive same scope as containing bean.</span><br><span class="line">        builder.setScope(parserContext.getContainingBeanDefinition().getScope());</span><br><span class="line">    &#125;</span><br><span class="line">    if (parserContext.isDefaultLazyInit()) &#123;</span><br><span class="line">        // Default-lazy-init applies to custom bean definitions as well.</span><br><span class="line">        builder.setLazyInit(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //解析配置文件</span><br><span class="line">    doParse(element, parserContext, builder);</span><br><span class="line">    //创建BeanDefinition</span><br><span class="line">    return builder.getBeanDefinition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、LoadTimeWeaverBeanDefinitionParser的doParse方法"><a href="#4、LoadTimeWeaverBeanDefinitionParser的doParse方法" class="headerlink" title="4、LoadTimeWeaverBeanDefinitionParser的doParse方法"></a>4、LoadTimeWeaverBeanDefinitionParser的doParse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void doParse(Element element, ParserContext parserContext, BeanDefinitionBuilder builder) &#123;</span><br><span class="line">    builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //是否开启AspectJ</span><br><span class="line">    if (isAspectJWeavingEnabled(element.getAttribute(ASPECTJ_WEAVING_ATTRIBUTE), parserContext)) &#123;</span><br><span class="line">        RootBeanDefinition weavingEnablerDef = new RootBeanDefinition();</span><br><span class="line">        //&quot;org.springframework.context.weaving.AspectJWeavingEnabler&quot;</span><br><span class="line">        weavingEnablerDef.setBeanClassName(ASPECTJ_WEAVING_ENABLER_CLASS_NAME);</span><br><span class="line">        //注册该bean</span><br><span class="line">        parserContext.getReaderContext().registerWithGeneratedName(weavingEnablerDef);</span><br><span class="line">        //注册BeanDefinition</span><br><span class="line">        //类org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect</span><br><span class="line">        //bean的名字org.springframework.context.config.internalBeanConfigurerAspect</span><br><span class="line">        if (isBeanConfigurerAspectEnabled(parserContext.getReaderContext().getBeanClassLoader())) &#123;</span><br><span class="line">            new SpringConfiguredBeanDefinitionParser().parse(element, parserContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法"><a href="#5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法" class="headerlink" title="5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法"></a>5、LoadTimeWeaverBeanDefinitionParser的isAspectJWeavingEnabled方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected boolean isAspectJWeavingEnabled(String value, ParserContext parserContext) &#123;</span><br><span class="line">    if (&quot;on&quot;.equals(value)) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (&quot;off&quot;.equals(value)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Determine default...</span><br><span class="line">        //检查是否存在&quot;META-INF/aop.xml&quot;</span><br><span class="line">        ClassLoader cl = parserContext.getReaderContext().getResourceLoader().getClassLoader();</span><br><span class="line">        return (cl.getResource(AspectJWeavingEnabler.ASPECTJ_AOP_XML_RESOURCE) != null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法"><a href="#5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法" class="headerlink" title="5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法"></a>5、LoadTimeWeaverAwareProcessor的postProcessBeforeInitialization方法</h4><p>prepareBeanFactory时，会添加LoadTimeWeaverAwareProcessor以及一个临时的TempClassLoader，<br>用于类型比较或者校验的时候加载，bean实例化之前被清掉<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123;</span><br><span class="line">    //AspectJWeavingEnabler类实现了LoadTimeWeaverAware接口</span><br><span class="line">    if (bean instanceof LoadTimeWeaverAware) &#123;</span><br><span class="line">        LoadTimeWeaver ltw = this.loadTimeWeaver;//DefaultContextLoadTimeWeaver</span><br><span class="line">        if (ltw == null) &#123;</span><br><span class="line">            Assert.state(this.beanFactory != null,</span><br><span class="line">                    &quot;BeanFactory required if no LoadTimeWeaver explicitly specified&quot;);</span><br><span class="line">            ltw = this.beanFactory.getBean(</span><br><span class="line">                    ConfigurableApplicationContext.LOAD_TIME_WEAVER_BEAN_NAME, LoadTimeWeaver.class);</span><br><span class="line">        &#125;</span><br><span class="line">        ((LoadTimeWeaverAware) bean).setLoadTimeWeaver(ltw);</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法"><a href="#6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法" class="headerlink" title="6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法"></a>6、DefaultContextLoadTimeWeaver的setBeanClassLoader方法</h4><p>DefaultContextLoadTimeWeaver实现了BeanClassLoaderAware接口，在初始化的时候会执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setBeanClassLoader(ClassLoader classLoader) &#123;</span><br><span class="line">    LoadTimeWeaver serverSpecificLoadTimeWeaver = createServerSpecificLoadTimeWeaver(classLoader);</span><br><span class="line">    if (serverSpecificLoadTimeWeaver != null) &#123;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(&quot;Determined server-specific load-time weaver: &quot; +</span><br><span class="line">                    serverSpecificLoadTimeWeaver.getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        this.loadTimeWeaver = serverSpecificLoadTimeWeaver;</span><br><span class="line">    &#125;</span><br><span class="line">    //检查当前虚拟机中的Instrumentation实例是否可用</span><br><span class="line">    else if (InstrumentationLoadTimeWeaver.isInstrumentationAvailable()) &#123;</span><br><span class="line">        logger.info(&quot;Found Spring&apos;s JVM agent for instrumentation&quot;);</span><br><span class="line">        this.loadTimeWeaver = new InstrumentationLoadTimeWeaver(classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.loadTimeWeaver = new ReflectiveLoadTimeWeaver(classLoader);</span><br><span class="line">            logger.info(&quot;Using a reflective load-time weaver for class loader: &quot; +</span><br><span class="line">                    this.loadTimeWeaver.getInstrumentableClassLoader().getClass().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IllegalStateException ex) &#123;</span><br><span class="line">            throw new IllegalStateException(ex.getMessage() + &quot; Specify a custom LoadTimeWeaver or start your &quot; +</span><br><span class="line">                    &quot;Java virtual machine with Spring&apos;s agent: -javaagent:org.springframework.instrument.jar&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>7、AspectJWeavingEnabler的postProcessBeanFactory方法<br>AspectJWeavingEnabler实现了BeanFactoryPostProcessor接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123;</span><br><span class="line">    enableAspectJWeaving(this.loadTimeWeaver, this.beanClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>8、AspectJWeavingEnabler的enableAspectJWeaving方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static void enableAspectJWeaving(LoadTimeWeaver weaverToUse, ClassLoader beanClassLoader) &#123;</span><br><span class="line">    //此时已经被初始化为DefaultContextLoadTimeWeaver</span><br><span class="line">    if (weaverToUse == null) &#123;</span><br><span class="line">        if (InstrumentationLoadTimeWeaver.isInstrumentationAvailable()) &#123;</span><br><span class="line">            weaverToUse = new InstrumentationLoadTimeWeaver(beanClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;No LoadTimeWeaver available&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //使用DefaultContextLoadTimeWeaver类型的bean中的loadTimeWeaver属性注册转换器</span><br><span class="line">    weaverToUse.addTransformer(new AspectJClassBypassingClassFileTransformer(</span><br><span class="line">                new ClassPreProcessorAgentAdapter()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>9、InstrumentationLoadTimeWeaver的addTransformer方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void addTransformer(ClassFileTransformer transformer) &#123;</span><br><span class="line">    Assert.notNull(transformer, &quot;Transformer must not be null&quot;);</span><br><span class="line">    FilteringClassFileTransformer actualTransformer =</span><br><span class="line">            new FilteringClassFileTransformer(transformer, this.classLoader);</span><br><span class="line">    synchronized (this.transformers) &#123;</span><br><span class="line">        if (this.instrumentation == null) &#123;</span><br><span class="line">            throw new IllegalStateException(</span><br><span class="line">                    &quot;Must start with Java agent to use InstrumentationLoadTimeWeaver. See Spring documentation.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //加入到jdk的instrumentation中加载class时自动调用</span><br><span class="line">        this.instrumentation.addTransformer(actualTransformer);</span><br><span class="line">        this.transformers.add(actualTransformer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>10、FilteringClassFileTransformer的transform方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line"></span><br><span class="line">    if (!this.targetClassLoader.equals(loader)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    return this.targetTransformer.transform(</span><br><span class="line">            loader, className, classBeingRedefined, protectionDomain, classfileBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>11、AspectJClassBypassingClassFileTransformer的transform方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">        ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line">    //不处理这两个包下面的</span><br><span class="line">    if (className.startsWith(&quot;org.aspectj&quot;) || className.startsWith(&quot;org/aspectj&quot;)) &#123;</span><br><span class="line">        return classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line">    //委托给AspectJ代理继续处理</span><br><span class="line">    return this.delegate.transform(loader, className, classBeingRedefined, protectionDomain, classfileBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/27/spring源码/spring源码AOP/" data-id="cjix67net001ab0ue3qqc060s" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/06/27/spring源码/spring源码ClassPathXmlApplicationContext和AnnotationConfigApplicationContext/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          spring源码ClassPathXmlApplicationContext、AnnotationConfigApplicationContext
        
      </div>
    </a>
  
  
    <a href="/2018/06/27/spring源码/springboot源码默认注解/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">springboot源码@SpringBootApplication</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java-util-concurrent/">java.util.concurrent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis3/">mybatis3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码整合MyBatis/">spring源码整合MyBatis</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(2) /">spring源码XmlBeanFactory(2)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(1)/">spring源码XmlBeanFactory(1)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码Transaction/">spring源码Transaction</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码SpringMVC/">spring源码SpringMVC</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>