<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="一、ClassPathXmlApplicationContext容器启动1、实例化ClassPathXmlApplicationContext123public ClassPathXmlApplicationContext(String configLocation) throws BeansExc"/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Spring IOC容器"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="一、ClassPathXmlApplicationContext容器启动1、实例化ClassPathXmlApplicationContext123public ClassPathXmlApplicationContext(String configLocation) throws BeansExc"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.comhttp://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.comhttp://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>Spring IOC容器 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Configurable Title</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('http://www.codeblocq.com/assets/projects/hexo-theme-clean-blog/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Spring IOC容器</h1>
                    
                    <h2 class="post-subheading">
                        基于xml配置文件的容器ClassPathXmlApplicationContext和基于注解的容器AnnotationConfigApplicationContext
                    </h2>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-06-27
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/spring/">spring</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h3 id="一、ClassPathXmlApplicationContext容器启动"><a href="#一、ClassPathXmlApplicationContext容器启动" class="headerlink" title="一、ClassPathXmlApplicationContext容器启动"></a>一、ClassPathXmlApplicationContext容器启动</h3><h4 id="1、实例化ClassPathXmlApplicationContext"><a href="#1、实例化ClassPathXmlApplicationContext" class="headerlink" title="1、实例化ClassPathXmlApplicationContext"></a>1、实例化ClassPathXmlApplicationContext</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathXmlApplicationContext(String configLocation) throws BeansException &#123;</span><br><span class="line">    this(new String[] &#123;configLocation&#125;, true, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathXmlApplicationContext(String... configLocations) throws BeansException &#123;</span><br><span class="line">    this(configLocations, true, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line">    super(parent);</span><br><span class="line">    //获取配置文件</span><br><span class="line">    setConfigLocations(configLocations);</span><br><span class="line">    if (refresh) &#123;</span><br><span class="line">        //启动容器</span><br><span class="line">        refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法"><a href="#2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法" class="headerlink" title="2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法"></a>2、AbstractRefreshableConfigApplicationContext的setConfigLocations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void setConfigLocations(String... locations) &#123;</span><br><span class="line">    if (locations != null) &#123;</span><br><span class="line">        Assert.noNullElements(locations, &quot;Config locations must not be null&quot;);</span><br><span class="line">        this.configLocations = new String[locations.length];</span><br><span class="line">        //获取配置文件</span><br><span class="line">        for (int i = 0; i &lt; locations.length; i++) &#123;</span><br><span class="line">            this.configLocations[i] = resolvePath(locations[i]).trim();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        this.configLocations = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、接（一、1）AbstractApplicationContext的refresh方法"><a href="#3、接（一、1）AbstractApplicationContext的refresh方法" class="headerlink" title="3、接（一、1）AbstractApplicationContext的refresh方法"></a>3、接（一、1）AbstractApplicationContext的refresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        // Prepare this context for refreshing.</span><br><span class="line">        //准备刷新上下文环境</span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        // Tell the subclass to refresh the internal bean factory.</span><br><span class="line">        //初始化BeanFactory，并读取配置文件</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        // Prepare the bean factory for use in this context.</span><br><span class="line">        //对BeanFactory进行功能填充</span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Allows post-processing of the bean factory in context subclasses.</span><br><span class="line">            //空方法待子类实现</span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Invoke factory processors registered as beans in the context.</span><br><span class="line">            //激活BeanFactory处理器</span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Register bean processors that intercept bean creation.</span><br><span class="line">            //注册拦截bean的处理器</span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Initialize message source for this context.</span><br><span class="line">            //初始化国际化处理</span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            // Initialize event multicaster for this context.</span><br><span class="line">            //初始化应用消息广播器</span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            // Initialize other special beans in specific context subclasses.</span><br><span class="line">            //初始化其他特殊bean，留待子类实现</span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            // Check for listener beans and register them.</span><br><span class="line">            //注册监听器</span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            // Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">            //初始化剩下的单例（非懒加载的）</span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Last step: publish corresponding event.</span><br><span class="line">            //完成刷新过程</span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt&quot;, ex);</span><br><span class="line"></span><br><span class="line">            // Destroy already created singletons to avoid dangling resources.</span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            // Reset &apos;active&apos; flag.</span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            // Propagate exception to caller.</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、AbstractApplicationContext的prepareRefresh方法"><a href="#4、AbstractApplicationContext的prepareRefresh方法" class="headerlink" title="4、AbstractApplicationContext的prepareRefresh方法"></a>4、AbstractApplicationContext的prepareRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">protected void prepareRefresh() &#123;</span><br><span class="line">    this.startupDate = System.currentTimeMillis();</span><br><span class="line">    //容器激活</span><br><span class="line">    this.active.set(true);</span><br><span class="line"></span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Refreshing &quot; + this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize any placeholder property sources in the context environment</span><br><span class="line">    //待子类实现，处理个性化的属性</span><br><span class="line">    initPropertySources();</span><br><span class="line"></span><br><span class="line">    // Validate that all properties marked as required are resolvable</span><br><span class="line">    // see ConfigurablePropertyResolver#setRequiredProperties</span><br><span class="line">    //验证需要的属性文件是否都已放入环境中</span><br><span class="line">    getEnvironment().validateRequiredProperties();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法"><a href="#5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法" class="headerlink" title="5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法"></a>5、接（一、3）AbstractApplicationContext的obtainFreshBeanFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">    refreshBeanFactory();</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    return beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、AbstractRefreshableApplicationContext的refreshBeanFactory方法"><a href="#6、AbstractRefreshableApplicationContext的refreshBeanFactory方法" class="headerlink" title="6、AbstractRefreshableApplicationContext的refreshBeanFactory方法"></a>6、AbstractRefreshableApplicationContext的refreshBeanFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">    //关闭已有的BeanFactory</span><br><span class="line">    if (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //创建DefaultListableBeanFactory</span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        //设置序列化id</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        //设置是否允许循环依赖、覆盖</span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        //加载配置文件，</span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">            this.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、AbstractXmlApplicationContext的loadBeanDefinitions方法"><a href="#7、AbstractXmlApplicationContext的loadBeanDefinitions方法" class="headerlink" title="7、AbstractXmlApplicationContext的loadBeanDefinitions方法"></a>7、AbstractXmlApplicationContext的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">    //关闭已有的BeanFactory</span><br><span class="line">    if (hasBeanFactory()) &#123;</span><br><span class="line">        destroyBeans();</span><br><span class="line">        closeBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //创建DefaultListableBeanFactory</span><br><span class="line">        DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">        //设置序列化id</span><br><span class="line">        beanFactory.setSerializationId(getId());</span><br><span class="line">        //设置是否允许循环依赖、覆盖</span><br><span class="line">        customizeBeanFactory(beanFactory);</span><br><span class="line">        //加载配置文件，</span><br><span class="line">        loadBeanDefinitions(beanFactory);</span><br><span class="line">        synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">            this.beanFactory = beanFactory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、AbstractXmlApplicationContext的loadBeanDefinitions方法"><a href="#8、AbstractXmlApplicationContext的loadBeanDefinitions方法" class="headerlink" title="8、AbstractXmlApplicationContext的loadBeanDefinitions方法"></a>8、AbstractXmlApplicationContext的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123;</span><br><span class="line">    // Create a new XmlBeanDefinitionReader for the given BeanFactory.</span><br><span class="line">    //创建xml加载器</span><br><span class="line">    XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">    // Configure the bean definition reader with this context&apos;s</span><br><span class="line">    // resource loading environment.</span><br><span class="line">    beanDefinitionReader.setEnvironment(this.getEnvironment());</span><br><span class="line">    beanDefinitionReader.setResourceLoader(this);</span><br><span class="line">    beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this));</span><br><span class="line"></span><br><span class="line">    // Allow a subclass to provide custom initialization of the reader,</span><br><span class="line">    // then proceed with actually loading the bean definitions.</span><br><span class="line">    //初始化加载器，该方法可以被子类覆盖</span><br><span class="line">    initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">    //读取xml配置文件</span><br><span class="line">    loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法"><a href="#9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法" class="headerlink" title="9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法"></a>9、接（一、3）AbstractApplicationContext的prepareBeanFactory方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    // Tell the internal bean factory to use the context&apos;s class loader etc.</span><br><span class="line">    //设置context的类加载器为beanFactory的加载器</span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    //设置SPEL表达式语言处理器，例如#｛bean.xxx｝，</span><br><span class="line">    //加载bean的过程中如(DefaultListableBeanFactory的evaluateBeanDefinitionString方法)，</span><br><span class="line">    //会调用StandardBeanExpressionResolver的evaluate方法</span><br><span class="line">    beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">    //属性设置管理工具,</span><br><span class="line">    //bean加载过程中AbstractBeanFactory的initBeanWrapper方法会调用ResourceEditorRegistrar的registerCustomEditors方法</span><br><span class="line">    //注册自定义属性编辑器，覆盖PropertyEditorRegistrySupport中默认属性编辑器</span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    // Configure the bean factory with context callbacks.</span><br><span class="line">    //添加BeanPostProcessor，该处理器为实现了特殊接口的bean提供处理</span><br><span class="line">    beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));</span><br><span class="line">    //忽略自动装配的接口</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line"></span><br><span class="line">    // BeanFactory interface not registered as resolvable type in a plain factory.</span><br><span class="line">    // MessageSource registered (and found for autowiring) as a bean.</span><br><span class="line">    //设置特殊接口的注入对象</span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, this);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, this);</span><br><span class="line"></span><br><span class="line">    // Detect a LoadTimeWeaver and prepare for weaving, if found.</span><br><span class="line">    //增加对AspectJ的支持</span><br><span class="line">    if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">        // Set a temporary ClassLoader for type matching.</span><br><span class="line">        beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Register default environment beans.</span><br><span class="line">    注册默认的bean</span><br><span class="line">    if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法"><a href="#10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法" class="headerlink" title="10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法"></a>10、接（一、3）AbstractApplicationContext的invokeBeanFactoryPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法"><a href="#11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法" class="headerlink" title="11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法"></a>11、PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">public static void invokeBeanFactoryPostProcessors(</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors) &#123;</span><br><span class="line"></span><br><span class="line">    // Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br><span class="line">    Set&lt;String&gt; processedBeans = new HashSet&lt;String&gt;();</span><br><span class="line">    //对BeanDefinitionRegistry类型的处理</span><br><span class="line">    if (beanFactory instanceof BeanDefinitionRegistry) &#123;</span><br><span class="line">        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;</span><br><span class="line">        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = new LinkedList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryPostProcessors =</span><br><span class="line">                new LinkedList&lt;BeanDefinitionRegistryPostProcessor&gt;();</span><br><span class="line">        //硬编码注册的处理器</span><br><span class="line">        for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;</span><br><span class="line">            //该类型，在BeanFactoryPostProcessor的基础上还有自己定义的方法需要先调用</span><br><span class="line">            if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">                BeanDefinitionRegistryPostProcessor registryPostProcessor =</span><br><span class="line">                        (BeanDefinitionRegistryPostProcessor) postProcessor;</span><br><span class="line">                //调用自己定义的方法</span><br><span class="line">                registryPostProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                registryPostProcessors.add(registryPostProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">            //常规BeanFactoryPostProcessor</span><br><span class="line">            else &#123;</span><br><span class="line">                regularPostProcessors.add(postProcessor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">        // uninitialized to let the bean factory post-processors apply to them!</span><br><span class="line">        // Separate between BeanDefinitionRegistryPostProcessors that implement</span><br><span class="line">        // PriorityOrdered, Ordered, and the rest.</span><br><span class="line">        //配置注册的BeanDefinitionRegistryPostProcessor</span><br><span class="line">        String[] postProcessorNames =</span><br><span class="line">                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">        // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanDefinitionRegistryPostProcessor&gt;();</span><br><span class="line">        for (String ppName : postProcessorNames) &#123;</span><br><span class="line">            if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">                priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //排序</span><br><span class="line">        OrderComparator.sort(priorityOrderedPostProcessors);</span><br><span class="line">        //加入处理器集合</span><br><span class="line">        registryPostProcessors.addAll(priorityOrderedPostProcessors);</span><br><span class="line">        //调用自己定义的方法</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(priorityOrderedPostProcessors, registry);</span><br><span class="line"></span><br><span class="line">        // Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br><span class="line">        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);</span><br><span class="line">        List&lt;BeanDefinitionRegistryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanDefinitionRegistryPostProcessor&gt;();</span><br><span class="line">        for (String ppName : postProcessorNames) &#123;</span><br><span class="line">            if (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">                orderedPostProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));</span><br><span class="line">                processedBeans.add(ppName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //排序</span><br><span class="line">        OrderComparator.sort(orderedPostProcessors);</span><br><span class="line">        //加入处理器集合</span><br><span class="line">        registryPostProcessors.addAll(orderedPostProcessors);</span><br><span class="line">        //调用自己定义的方法</span><br><span class="line">        invokeBeanDefinitionRegistryPostProcessors(orderedPostProcessors, registry);</span><br><span class="line"></span><br><span class="line">        // Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span><br><span class="line">        //调用其他处理器的自己定义的方法</span><br><span class="line">        boolean reiterate = true;</span><br><span class="line">        while (reiterate) &#123;</span><br><span class="line">            reiterate = false;</span><br><span class="line">            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);</span><br><span class="line">            for (String ppName : postProcessorNames) &#123;</span><br><span class="line">                if (!processedBeans.contains(ppName)) &#123;</span><br><span class="line">                    BeanDefinitionRegistryPostProcessor pp = beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class);</span><br><span class="line">                    registryPostProcessors.add(pp);</span><br><span class="line">                    processedBeans.add(ppName);</span><br><span class="line">                    pp.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">                    reiterate = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span><br><span class="line">        //应用处理器</span><br><span class="line">        invokeBeanFactoryPostProcessors(registryPostProcessors, beanFactory);</span><br><span class="line">        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else &#123;</span><br><span class="line">        // Invoke factory processors registered with the context instance.</span><br><span class="line">        //直接应用处理器</span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">    // uninitialized to let the bean factory post-processors apply to them!</span><br><span class="line">    //配置注册的BeanFactoryPostProcessor</span><br><span class="line">    String[] postProcessorNames =</span><br><span class="line">            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">    // Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span><br><span class="line">    // Ordered, and the rest.</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    //对后处理器分类</span><br><span class="line">    for (String ppName : postProcessorNames) &#123;</span><br><span class="line">        if (processedBeans.contains(ppName)) &#123;</span><br><span class="line">            // skip - already processed in first phase above</span><br><span class="line">        &#125;</span><br><span class="line">        else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));</span><br><span class="line">        &#125;</span><br><span class="line">        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span><br><span class="line">    //排序并应用后处理器</span><br><span class="line">    OrderComparator.sort(priorityOrderedPostProcessors);</span><br><span class="line">    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    // Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">    for (String postProcessorName : orderedPostProcessorNames) &#123;</span><br><span class="line">        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">     //排序并应用后处理器</span><br><span class="line">    OrderComparator.sort(orderedPostProcessors);</span><br><span class="line">    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);</span><br><span class="line"></span><br><span class="line">    // Finally, invoke all other BeanFactoryPostProcessors.</span><br><span class="line">    //应用不用排序的后处理器</span><br><span class="line">    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;BeanFactoryPostProcessor&gt;();</span><br><span class="line">    for (String postProcessorName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));</span><br><span class="line">    &#125;</span><br><span class="line">    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法"><a href="#12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法" class="headerlink" title="12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法"></a>12、接（一、3）AbstractApplicationContext的registerBeanPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected void registerBeanPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.registerBeanPostProcessors(beanFactory, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法"><a href="#13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法" class="headerlink" title="13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法"></a>13、PostProcessorRegistrationDelegate的registerBeanPostProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public static void registerBeanPostProcessors(</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext) &#123;</span><br><span class="line">    //获取配置注册的BeanPostProcessor</span><br><span class="line">    String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, true, false);</span><br><span class="line"></span><br><span class="line">    // Register BeanPostProcessorChecker that logs an info message when</span><br><span class="line">    // a bean is created during BeanPostProcessor instantiation, i.e. when</span><br><span class="line">    // a bean is not eligible for getting processed by all BeanPostProcessors.</span><br><span class="line">    int beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + 1 + postProcessorNames.length;</span><br><span class="line">    //该处理器，在bean初始化时，检测到后处理器未注册完，打印日志</span><br><span class="line">    beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));</span><br><span class="line"></span><br><span class="line">    // Separate between BeanPostProcessors that implement PriorityOrdered,</span><br><span class="line">    // Ordered, and the rest.</span><br><span class="line">    List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    List&lt;BeanPostProcessor&gt; internalPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    List&lt;String&gt; orderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    List&lt;String&gt; nonOrderedPostProcessorNames = new ArrayList&lt;String&gt;();</span><br><span class="line">    //分类bean处理器</span><br><span class="line">    for (String ppName : postProcessorNames) &#123;</span><br><span class="line">        if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;</span><br><span class="line">            BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">            priorityOrderedPostProcessors.add(pp);</span><br><span class="line">            if (pp instanceof MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">                internalPostProcessors.add(pp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;</span><br><span class="line">            orderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            nonOrderedPostProcessorNames.add(ppName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // First, register the BeanPostProcessors that implement PriorityOrdered.</span><br><span class="line">    //排序并注册处理器</span><br><span class="line">    OrderComparator.sort(priorityOrderedPostProcessors);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    // Next, register the BeanPostProcessors that implement Ordered.</span><br><span class="line">    List&lt;BeanPostProcessor&gt; orderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    for (String ppName : orderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        orderedPostProcessors.add(pp);</span><br><span class="line">        if (pp instanceof MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //排序并注册处理器</span><br><span class="line">    OrderComparator.sort(orderedPostProcessors);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, orderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    // Now, register all regular BeanPostProcessors.</span><br><span class="line">    //注册无序处理器</span><br><span class="line">    List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = new ArrayList&lt;BeanPostProcessor&gt;();</span><br><span class="line">    for (String ppName : nonOrderedPostProcessorNames) &#123;</span><br><span class="line">        BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);</span><br><span class="line">        nonOrderedPostProcessors.add(pp);</span><br><span class="line">        if (pp instanceof MergedBeanDefinitionPostProcessor) &#123;</span><br><span class="line">            internalPostProcessors.add(pp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);</span><br><span class="line"></span><br><span class="line">    // Finally, re-register all internal BeanPostProcessors.</span><br><span class="line">    //注册MergedBeanDefinitionPostProcessor处理器，不会重复注册，会先删除</span><br><span class="line">    OrderComparator.sort(internalPostProcessors);</span><br><span class="line">    registerBeanPostProcessors(beanFactory, internalPostProcessors);</span><br><span class="line"></span><br><span class="line">    beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（一、3）AbstractApplicationContext的initMessageSource方法"><a href="#14、接（一、3）AbstractApplicationContext的initMessageSource方法" class="headerlink" title="14、接（一、3）AbstractApplicationContext的initMessageSource方法"></a>14、接（一、3）AbstractApplicationContext的initMessageSource方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected void initMessageSource() &#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME)) &#123;</span><br><span class="line">        //获取配置的messageSource记录在容器中</span><br><span class="line">        this.messageSource = beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class);</span><br><span class="line">        // Make MessageSource aware of parent MessageSource.</span><br><span class="line">        if (this.parent != null &amp;&amp; this.messageSource instanceof HierarchicalMessageSource) &#123;</span><br><span class="line">            HierarchicalMessageSource hms = (HierarchicalMessageSource) this.messageSource;</span><br><span class="line">            if (hms.getParentMessageSource() == null) &#123;</span><br><span class="line">                // Only set parent context as parent MessageSource if no parent MessageSource</span><br><span class="line">                // registered already.</span><br><span class="line">                hms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Using MessageSource [&quot; + this.messageSource + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Use empty MessageSource to be able to accept getMessage calls.</span><br><span class="line">        DelegatingMessageSource dms = new DelegatingMessageSource();</span><br><span class="line">        dms.setParentMessageSource(getInternalParentMessageSource());</span><br><span class="line">        this.messageSource = dms;</span><br><span class="line">        beanFactory.registerSingleton(MESSAGE_SOURCE_BEAN_NAME, this.messageSource);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Unable to locate MessageSource with name &apos;&quot; + MESSAGE_SOURCE_BEAN_NAME +</span><br><span class="line">                    &quot;&apos;: using default [&quot; + this.messageSource + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法"><a href="#15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法" class="headerlink" title="15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法"></a>15、接（一、3）AbstractApplicationContext的initApplicationEventMulticaster方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected void initApplicationEventMulticaster() &#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    //使用自定义广播器</span><br><span class="line">    if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">        this.applicationEventMulticaster =</span><br><span class="line">                beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //默认广播器</span><br><span class="line">    else &#123;</span><br><span class="line">        this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">        beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Unable to locate ApplicationEventMulticaster with name &apos;&quot; +</span><br><span class="line">                    APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">                    &quot;&apos;: using default [&quot; + this.applicationEventMulticaster + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、接（一、3）AbstractApplicationContext的registerListeners方法"><a href="#16、接（一、3）AbstractApplicationContext的registerListeners方法" class="headerlink" title="16、接（一、3）AbstractApplicationContext的registerListeners方法"></a>16、接（一、3）AbstractApplicationContext的registerListeners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected void registerListeners() &#123;</span><br><span class="line">    // Register statically specified listeners first.</span><br><span class="line">    //注册硬编码的监听器到广播器</span><br><span class="line">    for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    // Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">    // uninitialized to let post-processors apply to them!</span><br><span class="line">    //注册配置的监听器到广播器</span><br><span class="line">    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);</span><br><span class="line">    for (String lisName : listenerBeanNames) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListenerBean(lisName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法"><a href="#17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法" class="headerlink" title="17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法"></a>17、接（一、3）AbstractApplicationContext的finishBeanFactoryInitialization方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">    // Initialize conversion service for this context.</span><br><span class="line">    //初始化自定义类型转换器</span><br><span class="line">    if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">        beanFactory.setConversionService(</span><br><span class="line">                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br><span class="line">    //该接口，加载Spring Bean时织入第三方模块，如AspectJ</span><br><span class="line">    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);</span><br><span class="line">    for (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">        getBean(weaverAwareName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Stop using the temporary ClassLoader for type matching.</span><br><span class="line">    beanFactory.setTempClassLoader(null);</span><br><span class="line"></span><br><span class="line">    // Allow for caching all bean definition metadata, not expecting further changes.</span><br><span class="line">    //冻结bean的定义</span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    // Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">    //初始化剩下的单实例bean</span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、接（一、3）AbstractApplicationContext的finishRefresh方法"><a href="#18、接（一、3）AbstractApplicationContext的finishRefresh方法" class="headerlink" title="18、接（一、3）AbstractApplicationContext的finishRefresh方法"></a>18、接（一、3）AbstractApplicationContext的finishRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected void finishRefresh() &#123;</span><br><span class="line">    // Initialize lifecycle processor for this context.</span><br><span class="line">    //初始化bean生命周期处理器</span><br><span class="line">    initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">    // Propagate refresh to lifecycle processor first.</span><br><span class="line">    //启动实现了Lifecycle接口的bean</span><br><span class="line">    getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">    // Publish the final event.</span><br><span class="line">    publishEvent(new ContextRefreshedEvent(this));</span><br><span class="line"></span><br><span class="line">    // Participate in LiveBeansView MBean, if active.</span><br><span class="line">    //容器注册到MBeanServer中</span><br><span class="line">    LiveBeansView.registerApplicationContext(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、AbstractApplicationContext的initLifecycleProcessor方法"><a href="#19、AbstractApplicationContext的initLifecycleProcessor方法" class="headerlink" title="19、AbstractApplicationContext的initLifecycleProcessor方法"></a>19、AbstractApplicationContext的initLifecycleProcessor方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">protected void initLifecycleProcessor() &#123;</span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        this.lifecycleProcessor =</span><br><span class="line">                beanFactory.getBean(LIFECYCLE_PROCESSOR_BEAN_NAME, LifecycleProcessor.class);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Using LifecycleProcessor [&quot; + this.lifecycleProcessor + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //默认bean生命周期处理器</span><br><span class="line">        DefaultLifecycleProcessor defaultProcessor = new DefaultLifecycleProcessor();</span><br><span class="line">        defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">        this.lifecycleProcessor = defaultProcessor;</span><br><span class="line">        beanFactory.registerSingleton(LIFECYCLE_PROCESSOR_BEAN_NAME, this.lifecycleProcessor);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Unable to locate LifecycleProcessor with name &apos;&quot; +</span><br><span class="line">                    LIFECYCLE_PROCESSOR_BEAN_NAME +</span><br><span class="line">                    &quot;&apos;: using default [&quot; + this.lifecycleProcessor + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、接（一、18）DefaultLifecycleProcessor的onRefresh方法"><a href="#20、接（一、18）DefaultLifecycleProcessor的onRefresh方法" class="headerlink" title="20、接（一、18）DefaultLifecycleProcessor的onRefresh方法"></a>20、接（一、18）DefaultLifecycleProcessor的onRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onRefresh() &#123;</span><br><span class="line">    startBeans(true);</span><br><span class="line">    this.running = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、DefaultLifecycleProcessor的startBeans方法"><a href="#21、DefaultLifecycleProcessor的startBeans方法" class="headerlink" title="21、DefaultLifecycleProcessor的startBeans方法"></a>21、DefaultLifecycleProcessor的startBeans方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void startBeans(boolean autoStartupOnly) &#123;</span><br><span class="line">    //获取实现了Lifecycle接口的bean</span><br><span class="line">    Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">    Map&lt;Integer, LifecycleGroup&gt; phases = new HashMap&lt;Integer, LifecycleGroup&gt;();</span><br><span class="line">    //根据phases分组bean</span><br><span class="line">    for (Map.Entry&lt;String, ? extends Lifecycle&gt; entry : lifecycleBeans.entrySet()) &#123;</span><br><span class="line">        Lifecycle bean = entry.getValue();</span><br><span class="line">        if (!autoStartupOnly || (bean instanceof SmartLifecycle &amp;&amp; ((SmartLifecycle) bean).isAutoStartup())) &#123;</span><br><span class="line">            int phase = getPhase(bean);</span><br><span class="line">            LifecycleGroup group = phases.get(phase);</span><br><span class="line">            if (group == null) &#123;</span><br><span class="line">                group = new LifecycleGroup(phase, this.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly);</span><br><span class="line">                phases.put(phase, group);</span><br><span class="line">            &#125;</span><br><span class="line">            group.add(entry.getKey(), bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (phases.size() &gt; 0) &#123;</span><br><span class="line">        List&lt;Integer&gt; keys = new ArrayList&lt;Integer&gt;(phases.keySet());</span><br><span class="line">        Collections.sort(keys);</span><br><span class="line">        for (Integer key : keys) &#123;</span><br><span class="line">            //启动该分组的bean</span><br><span class="line">            phases.get(key).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="22、接（一、18）AbstractApplicationContext的publishEvent方法"><a href="#22、接（一、18）AbstractApplicationContext的publishEvent方法" class="headerlink" title="22、接（一、18）AbstractApplicationContext的publishEvent方法"></a>22、接（一、18）AbstractApplicationContext的publishEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void publishEvent(ApplicationEvent event) &#123;</span><br><span class="line">    Assert.notNull(event, &quot;Event must not be null&quot;);</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Publishing event in &quot; + getDisplayName() + &quot;: &quot; + event);</span><br><span class="line">    &#125;</span><br><span class="line">    //广播容器刷新完成事件</span><br><span class="line">    getApplicationEventMulticaster().multicastEvent(event);</span><br><span class="line">    if (this.parent != null) &#123;</span><br><span class="line">        this.parent.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="23、SimpleApplicationEventMulticaster的multicastEvent方法"><a href="#23、SimpleApplicationEventMulticaster的multicastEvent方法" class="headerlink" title="23、SimpleApplicationEventMulticaster的multicastEvent方法"></a>23、SimpleApplicationEventMulticaster的multicastEvent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void multicastEvent(final ApplicationEvent event) &#123;</span><br><span class="line">    //获取事件相关的监听器</span><br><span class="line">    for (final ApplicationListener&lt;?&gt; listener : getApplicationListeners(event)) &#123;</span><br><span class="line">        Executor executor = getTaskExecutor();</span><br><span class="line">        if (executor != null) &#123;</span><br><span class="line">            executor.execute(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    //监听器处理事件</span><br><span class="line">                    invokeListener(listener, event);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            invokeListener(listener, event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、ClassPathXmlApplicationContext容器关闭"><a href="#二、ClassPathXmlApplicationContext容器关闭" class="headerlink" title="二、ClassPathXmlApplicationContext容器关闭"></a>二、ClassPathXmlApplicationContext容器关闭</h3><h4 id="1、AbstractApplicationContext的close方法"><a href="#1、AbstractApplicationContext的close方法" class="headerlink" title="1、AbstractApplicationContext的close方法"></a>1、AbstractApplicationContext的close方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void close() &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        //关闭</span><br><span class="line">        doClose();</span><br><span class="line">        // If we registered a JVM shutdown hook, we don&apos;t need it anymore now:</span><br><span class="line">        // We&apos;ve already explicitly closed the context.</span><br><span class="line">        //移除关闭回调</span><br><span class="line">        if (this.shutdownHook != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Runtime.getRuntime().removeShutdownHook(this.shutdownHook);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (IllegalStateException ex) &#123;</span><br><span class="line">                // ignore - VM is already shutting down</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、AbstractApplicationContext的doClose方法"><a href="#2、AbstractApplicationContext的doClose方法" class="headerlink" title="2、AbstractApplicationContext的doClose方法"></a>2、AbstractApplicationContext的doClose方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">protected void doClose() &#123;</span><br><span class="line">    //更新状态为关闭</span><br><span class="line">    if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) &#123;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(&quot;Closing &quot; + this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LiveBeansView.unregisterApplicationContext(this);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Publish shutdown event.</span><br><span class="line">            //广播容器关闭事件</span><br><span class="line">            publishEvent(new ContextClosedEvent(this));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Stop all Lifecycle beans, to avoid delays during individual destruction.</span><br><span class="line">        try &#123;</span><br><span class="line">            //关闭实现了Lifecycle接口的bean</span><br><span class="line">            getLifecycleProcessor().onClose();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception thrown from LifecycleProcessor on context close&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Destroy all cached singletons in the context&apos;s BeanFactory.</span><br><span class="line">        //销毁bean</span><br><span class="line">        destroyBeans();</span><br><span class="line"></span><br><span class="line">        // Close the state of this context itself.</span><br><span class="line">        //销毁容器</span><br><span class="line">        closeBeanFactory();</span><br><span class="line"></span><br><span class="line">        // Let subclasses do some final clean-up if they wish...</span><br><span class="line">        //待子类实现</span><br><span class="line">        onClose();</span><br><span class="line">        //更新容器状态</span><br><span class="line">        this.active.set(false);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、AnnotationConfigApplicationContext容器启动"><a href="#三、AnnotationConfigApplicationContext容器启动" class="headerlink" title="三、AnnotationConfigApplicationContext容器启动"></a>三、AnnotationConfigApplicationContext容器启动</h3><h4 id="1、实例化AnnotationConfigApplicationContext"><a href="#1、实例化AnnotationConfigApplicationContext" class="headerlink" title="1、实例化AnnotationConfigApplicationContext"></a>1、实例化AnnotationConfigApplicationContext</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationConfigApplicationContext(String... basePackages) &#123;</span><br><span class="line">    this();</span><br><span class="line">    //扫描该包</span><br><span class="line">    scan(basePackages);</span><br><span class="line">    //启动容器</span><br><span class="line">    refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public AnnotationConfigApplicationContext() &#123;</span><br><span class="line">    this.reader = new AnnotatedBeanDefinitionReader(this);</span><br><span class="line">    this.scanner = new ClassPathBeanDefinitionScanner(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public GenericApplicationContext() &#123;</span><br><span class="line">    //内置的容器</span><br><span class="line">    this.beanFactory = new DefaultListableBeanFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、实例化AnnotatedBeanDefinitionReader"><a href="#2、实例化AnnotatedBeanDefinitionReader" class="headerlink" title="2、实例化AnnotatedBeanDefinitionReader"></a>2、实例化AnnotatedBeanDefinitionReader</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    this(registry, getOrCreateEnvironment(registry));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry, Environment environment) &#123;</span><br><span class="line">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br><span class="line">    Assert.notNull(environment, &quot;Environment must not be null&quot;);</span><br><span class="line">    this.registry = registry;</span><br><span class="line">    this.conditionEvaluator = new ConditionEvaluator(registry, environment, null);</span><br><span class="line">    AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法"><a href="#3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法" class="headerlink" title="3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法"></a>3、AnnotationConfigUtils的registerAnnotationConfigProcessors方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void registerAnnotationConfigProcessors(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    registerAnnotationConfigProcessors(registry, null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public static Set&lt;BeanDefinitionHolder&gt; registerAnnotationConfigProcessors(</span><br><span class="line">        BeanDefinitionRegistry registry, Object source) &#123;</span><br><span class="line">    //获取容器中的DefaultListableBeanFactory容器</span><br><span class="line">    DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);</span><br><span class="line">    if (beanFactory != null) &#123;</span><br><span class="line">        //比较器</span><br><span class="line">        if (!(beanFactory.getDependencyComparator() instanceof AnnotationAwareOrderComparator)) &#123;</span><br><span class="line">            beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">        &#125;</span><br><span class="line">        //确定一个bean是否要被注入的工具</span><br><span class="line">        if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) &#123;</span><br><span class="line">            beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefs = new LinkedHashSet&lt;BeanDefinitionHolder&gt;(4);</span><br><span class="line"></span><br><span class="line">    //配置类解析器</span><br><span class="line">    if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //@Autowired、@Value处理器</span><br><span class="line">    if (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //检查带有@Required注解的所有Bean属性是否设置</span><br><span class="line">    if (!registry.containsBeanDefinition(REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(RequiredAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span><br><span class="line">    //处理@Resource注解及WebService、EJB相关的注解</span><br><span class="line">    if (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span><br><span class="line">    //JPA相关注解的Bean后置处理器，主要解析和处理@PersistenceUnit、@PersistenceContext注解</span><br><span class="line">    if (jpaPresent &amp;&amp; !registry.containsBeanDefinition(PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition();</span><br><span class="line">        try &#123;</span><br><span class="line">            def.setBeanClass(ClassUtils.forName(PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME,</span><br><span class="line">                    AnnotationConfigUtils.class.getClassLoader()));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ClassNotFoundException ex) &#123;</span><br><span class="line">            throw new IllegalStateException(</span><br><span class="line">                    &quot;Cannot load optional framework class: &quot; + PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //容器加载完单例bean之后执行处理器的afterSingletonsInstantiated方法</span><br><span class="line">    //遍历bean将其中注解了@EventListener的方法转换成监听器注册到容器中</span><br><span class="line">    if (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(EventListenerMethodProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    //创建监听器的工厂类</span><br><span class="line">    if (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = new RootBeanDefinition(DefaultEventListenerFactory.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    return beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、接（三、1）ClassPathXmlApplicationContext的scan方法"><a href="#4、接（三、1）ClassPathXmlApplicationContext的scan方法" class="headerlink" title="4、接（三、1）ClassPathXmlApplicationContext的scan方法"></a>4、接（三、1）ClassPathXmlApplicationContext的scan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void scan(String... basePackages) &#123;</span><br><span class="line">    Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</span><br><span class="line">    //扫描该包</span><br><span class="line">    this.scanner.scan(basePackages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、ClassPathBeanDefinitionScanner的scan方法"><a href="#5、ClassPathBeanDefinitionScanner的scan方法" class="headerlink" title="5、ClassPathBeanDefinitionScanner的scan方法"></a>5、ClassPathBeanDefinitionScanner的scan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public int scan(String... basePackages) &#123;</span><br><span class="line">    int beanCountAtScanStart = this.registry.getBeanDefinitionCount();</span><br><span class="line">    //扫描包</span><br><span class="line">    doScan(basePackages);</span><br><span class="line"></span><br><span class="line">    // Register annotation config processors, if necessary.</span><br><span class="line">    //注册</span><br><span class="line">    if (this.includeAnnotationConfig) &#123;</span><br><span class="line">        AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (this.registry.getBeanDefinitionCount() - beanCountAtScanStart);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、ClassPathBeanDefinitionScanner的doScan方法"><a href="#6、ClassPathBeanDefinitionScanner的doScan方法" class="headerlink" title="6、ClassPathBeanDefinitionScanner的doScan方法"></a>6、ClassPathBeanDefinitionScanner的doScan方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) &#123;</span><br><span class="line">    Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</span><br><span class="line">    //创建一个集合，存放扫描到Bean定义的封装类</span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&lt;BeanDefinitionHolder&gt;();</span><br><span class="line">    //循环不同的包</span><br><span class="line">    for (String basePackage : basePackages) &#123;</span><br><span class="line">        //扫描给定包，获取符合条件的Bean定义，返回ScannedGenericBeanDefinition的集合</span><br><span class="line">        Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</span><br><span class="line">        for (BeanDefinition candidate : candidates) &#123;</span><br><span class="line">            //获取Bean定义类中@Scope注解的值，即获取Bean的作用域</span><br><span class="line">            ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);</span><br><span class="line">            //为Bean设置注解配置的作用域</span><br><span class="line">            candidate.setScope(scopeMetadata.getScopeName());</span><br><span class="line">            //为Bean生成名称，@Component(&quot;beanName&quot;)的值或类名</span><br><span class="line">            String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);</span><br><span class="line">            </span><br><span class="line">            if (candidate instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">                //设置Bean默认值，设置Bean是否将要被注入其他Bean</span><br><span class="line">                postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (candidate instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">                //处理注解Bean中通用的注解，在分析注解Bean定义类读取器时已经分析过</span><br><span class="line">                AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);</span><br><span class="line">            &#125;</span><br><span class="line">            //根据Bean名称检查指定的Bean是否需要在容器中注册，或者在容器中冲突</span><br><span class="line">            if (checkCandidate(beanName, candidate)) &#123;</span><br><span class="line">                BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);</span><br><span class="line">                //根据注解中配置的作用域，为Bean应用相应的代理模式</span><br><span class="line">                definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);</span><br><span class="line">                beanDefinitions.add(definitionHolder);</span><br><span class="line">                //向容器注册扫描到的Bean  </span><br><span class="line">                registerBeanDefinition(definitionHolder, this.registry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return beanDefinitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、ClassPathBeanDefinitionScanner的findCandidateComponents方法"><a href="#7、ClassPathBeanDefinitionScanner的findCandidateComponents方法" class="headerlink" title="7、ClassPathBeanDefinitionScanner的findCandidateComponents方法"></a>7、ClassPathBeanDefinitionScanner的findCandidateComponents方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public Set&lt;BeanDefinition&gt; findCandidateComponents(String basePackage) &#123;</span><br><span class="line">    Set&lt;BeanDefinition&gt; candidates = new LinkedHashSet&lt;BeanDefinition&gt;();</span><br><span class="line">    try &#123;</span><br><span class="line">        //解析给定的包路径，this.resourcePattern=” **/*.class”，  </span><br><span class="line">        //ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX=“classpath:”  </span><br><span class="line">        //resolveBasePackage方法将包名中的”.”转换为文件系统的”/”  </span><br><span class="line">        String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br><span class="line">                resolveBasePackage(basePackage) + &quot;/&quot; + this.resourcePattern;</span><br><span class="line">        //将给定的包路径解析为Spring资源对象 </span><br><span class="line">        Resource[] resources = this.resourcePatternResolver.getResources(packageSearchPath);</span><br><span class="line">        boolean traceEnabled = logger.isTraceEnabled();</span><br><span class="line">        boolean debugEnabled = logger.isDebugEnabled();</span><br><span class="line">        //遍历扫描到的资源</span><br><span class="line">        for (Resource resource : resources) &#123;</span><br><span class="line">            if (traceEnabled) &#123;</span><br><span class="line">                logger.trace(&quot;Scanning &quot; + resource);</span><br><span class="line">            &#125;</span><br><span class="line">            if (resource.isReadable()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //为指定资源获取元数据读取器，元信息读取器通过汇编(ASM)读取资源元信息 </span><br><span class="line">                    MetadataReader metadataReader = this.metadataReaderFactory.getMetadataReader(resource);</span><br><span class="line">                    //如果扫描到的类符合容器配置的过滤规则</span><br><span class="line">                    if (isCandidateComponent(metadataReader)) &#123;</span><br><span class="line">                        //通过汇编(ASM)读取资源字节码中的Bean定义元信息 </span><br><span class="line">                        ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);</span><br><span class="line">                        //设置Bean定义来源于resource</span><br><span class="line">                        sbd.setResource(resource);</span><br><span class="line">                        //为元数据元素设置配置资源对象</span><br><span class="line">                        sbd.setSource(resource);</span><br><span class="line">                        //检查Bean是否符合过滤器要求</span><br><span class="line">                        if (isCandidateComponent(sbd)) &#123;</span><br><span class="line">                            if (debugEnabled) &#123;</span><br><span class="line">                                logger.debug(&quot;Identified candidate component class: &quot; + resource);</span><br><span class="line">                            &#125;</span><br><span class="line">                            //添加BeanDefinition</span><br><span class="line">                            candidates.add(sbd);</span><br><span class="line">                        &#125;</span><br><span class="line">                        else &#123;</span><br><span class="line">                            if (debugEnabled) &#123;</span><br><span class="line">                                logger.debug(&quot;Ignored because not a concrete top-level class: &quot; + resource);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        if (traceEnabled) &#123;</span><br><span class="line">                            logger.trace(&quot;Ignored because not matching any filter: &quot; + resource);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Throwable ex) &#123;</span><br><span class="line">                    throw new BeanDefinitionStoreException(</span><br><span class="line">                            &quot;Failed to read candidate component class: &quot; + resource, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (traceEnabled) &#123;</span><br><span class="line">                    logger.trace(&quot;Ignored because not readable: &quot; + resource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        throw new BeanDefinitionStoreException(&quot;I/O failure during classpath scanning&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    return candidates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、ClassPathBeanDefinitionScanner的isCandidateComponent方法"><a href="#8、ClassPathBeanDefinitionScanner的isCandidateComponent方法" class="headerlink" title="8、ClassPathBeanDefinitionScanner的isCandidateComponent方法"></a>8、ClassPathBeanDefinitionScanner的isCandidateComponent方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException &#123;</span><br><span class="line">    //排除过滤器</span><br><span class="line">    for (TypeFilter tf : this.excludeFilters) &#123;</span><br><span class="line">        if (tf.match(metadataReader, this.metadataReaderFactory)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //过滤器</span><br><span class="line">    for (TypeFilter tf : this.includeFilters) &#123;</span><br><span class="line">        if (tf.match(metadataReader, this.metadataReaderFactory)) &#123;</span><br><span class="line">            return isConditionMatch(metadataReader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法"><a href="#9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法" class="headerlink" title="9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法"></a>9、ClassPathBeanDefinitionScanner的registerDefaultFilters方法</h4><h5 id="注册默认的过滤器，在父类构ClassPathScanningCandidateComponentProvider造器中"><a href="#注册默认的过滤器，在父类构ClassPathScanningCandidateComponentProvider造器中" class="headerlink" title="注册默认的过滤器，在父类构ClassPathScanningCandidateComponentProvider造器中"></a>注册默认的过滤器，在父类构ClassPathScanningCandidateComponentProvider造器中</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected void registerDefaultFilters() &#123;</span><br><span class="line">    //支持Component注解</span><br><span class="line">    this.includeFilters.add(new AnnotationTypeFilter(Component.class));</span><br><span class="line">    ClassLoader cl = ClassPathScanningCandidateComponentProvider.class.getClassLoader();</span><br><span class="line">    try &#123;</span><br><span class="line">        //支持JavaEE6的@ManagedBean  </span><br><span class="line">        this.includeFilters.add(new AnnotationTypeFilter(</span><br><span class="line">                ((Class&lt;? extends Annotation&gt;) ClassUtils.forName(&quot;javax.annotation.ManagedBean&quot;, cl)), false));</span><br><span class="line">        logger.debug(&quot;JSR-250 &apos;javax.annotation.ManagedBean&apos; found and supported for component scanning&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //支持JSR-330的@Named注解</span><br><span class="line">        this.includeFilters.add(new AnnotationTypeFilter(</span><br><span class="line">                ((Class&lt;? extends Annotation&gt;) ClassUtils.forName(&quot;javax.inject.Named&quot;, cl)), false));</span><br><span class="line">        logger.debug(&quot;JSR-330 &apos;javax.inject.Named&apos; annotation found and supported for component scanning&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // JSR-330 API not available - simply skip.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法"><a href="#10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法" class="headerlink" title="10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法"></a>10、接（三、4）AnnotationScopeMetadataResolver的resolveScopeMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ScopeMetadata resolveScopeMetadata(BeanDefinition definition) &#123;</span><br><span class="line">    ScopeMetadata metadata = new ScopeMetadata();</span><br><span class="line">    if (definition instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">        AnnotatedBeanDefinition annDef = (AnnotatedBeanDefinition) definition;</span><br><span class="line">        //从注解Bean定义类的属性中查找属性为”Scope”的值，即@Scope注解的值  </span><br><span class="line">        // annDef.getMetadata()方法获取StandardAnnotationMetadata，该对象维护了Bean中所有注解和注解的值</span><br><span class="line">        AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(annDef.getMetadata(), this.scopeAnnotationType);</span><br><span class="line">        //将获取到的@Scope注解的值设置到要返回的对象中</span><br><span class="line">        if (attributes != null) &#123;</span><br><span class="line">            metadata.setScopeName(attributes.getString(&quot;value&quot;));</span><br><span class="line">            //获取@Scope注解中的proxyMode属性值，在创建代理对象时会用到</span><br><span class="line">            ScopedProxyMode proxyMode = attributes.getEnum(&quot;proxyMode&quot;);</span><br><span class="line">            //如果@Scope的proxyMode属性值为null、DEFAULT或者NO  </span><br><span class="line">            if (proxyMode == null || proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">                proxyMode = this.defaultProxyMode;</span><br><span class="line">            &#125;</span><br><span class="line">            //为返回的元数据设置proxyMode</span><br><span class="line">            metadata.setScopedProxyMode(proxyMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //返回解析的作用域元信息对象</span><br><span class="line">    return metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法"><a href="#11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法" class="headerlink" title="11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法"></a>11、接（三、4）AnnotationConfigUtils的processCommonDefinitionAnnotations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd) &#123;</span><br><span class="line">    processCommonDefinitionAnnotations(abd, abd.getMetadata());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd, AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">    //如果Bean定义中有@Lazy注解，则将该Bean预实例化属性设置为@lazy注解的值</span><br><span class="line">    if (metadata.isAnnotated(Lazy.class.getName())) &#123;</span><br><span class="line">        abd.setLazyInit(attributesFor(metadata, Lazy.class).getBoolean(&quot;value&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    else if (abd.getMetadata() != metadata &amp;&amp; abd.getMetadata().isAnnotated(Lazy.class.getName())) &#123;</span><br><span class="line">        abd.setLazyInit(attributesFor(abd.getMetadata(), Lazy.class).getBoolean(&quot;value&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    //如果Bean定义中有@Primary注解，则为该Bean设置为autowiring自动依赖注入配的首选对象</span><br><span class="line">    if (metadata.isAnnotated(Primary.class.getName())) &#123;</span><br><span class="line">        abd.setPrimary(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //如果Bean定义中有@ DependsOn注解，则为该Bean设置所依赖的Bean名称，  </span><br><span class="line">    //容器将确保在实例化该Bean之前首先实例化所依赖的Bean</span><br><span class="line">    if (metadata.isAnnotated(DependsOn.class.getName())) &#123;</span><br><span class="line">        abd.setDependsOn(attributesFor(metadata, DependsOn.class).getStringArray(&quot;value&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (abd instanceof AbstractBeanDefinition) &#123;</span><br><span class="line">        AbstractBeanDefinition absBd = (AbstractBeanDefinition) abd;</span><br><span class="line">        //设置@Role的值</span><br><span class="line">        if (metadata.isAnnotated(Role.class.getName())) &#123;</span><br><span class="line">            absBd.setRole(attributesFor(metadata, Role.class).getNumber(&quot;value&quot;).intValue());</span><br><span class="line">        &#125;</span><br><span class="line">        //设置@Description得值</span><br><span class="line">        if (metadata.isAnnotated(Description.class.getName())) &#123;</span><br><span class="line">            absBd.setDescription(attributesFor(metadata, Description.class).getString(&quot;value&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（三、1）AbstractApplicationContext的refresh方法"><a href="#12、接（三、1）AbstractApplicationContext的refresh方法" class="headerlink" title="12、接（三、1）AbstractApplicationContext的refresh方法"></a>12、接（三、1）AbstractApplicationContext的refresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">    synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">        // Prepare this context for refreshing.</span><br><span class="line">        //清空scanner缓存，其余逻辑与一中容器相同</span><br><span class="line">        prepareRefresh();</span><br><span class="line"></span><br><span class="line">        // Tell the subclass to refresh the internal bean factory.</span><br><span class="line">        //直接获取容器父类GenericApplicationContext中的DefaultListableBeanFactory对象</span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">        // Prepare the bean factory for use in this context.</span><br><span class="line">        //与一中容器相同</span><br><span class="line">        prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Allows post-processing of the bean factory in context subclasses.</span><br><span class="line">            //待子类实现</span><br><span class="line">            postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Invoke factory processors registered as beans in the context.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Register bean processors that intercept bean creation.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Initialize message source for this context.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            initMessageSource();</span><br><span class="line"></span><br><span class="line">            // Initialize event multicaster for this context.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">            // Initialize other special beans in specific context subclasses.</span><br><span class="line">            //待子类实现</span><br><span class="line">            onRefresh();</span><br><span class="line"></span><br><span class="line">            // Check for listener beans and register them.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            registerListeners();</span><br><span class="line"></span><br><span class="line">            // Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">            // Last step: publish corresponding event.</span><br><span class="line">            //与一中容器相同</span><br><span class="line">            finishRefresh();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            logger.warn(&quot;Exception encountered during context initialization - cancelling refresh attempt&quot;, ex);</span><br><span class="line"></span><br><span class="line">            // Destroy already created singletons to avoid dangling resources.</span><br><span class="line">            destroyBeans();</span><br><span class="line"></span><br><span class="line">            // Reset &apos;active&apos; flag.</span><br><span class="line">            cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">            // Propagate exception to caller.</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"><a href="#13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器" class="headerlink" title="13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"></a>13、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">public AutowiredAnnotationBeanPostProcessor() &#123;</span><br><span class="line">    //将会处理@Autowire注解</span><br><span class="line">    this.autowiredAnnotationTypes.add(Autowired.class);</span><br><span class="line">    //将会处理@Value注解</span><br><span class="line">    this.autowiredAnnotationTypes.add(Value.class);</span><br><span class="line">    try &#123;</span><br><span class="line">        //将会处理javax.inject.Inject JSR-330注解</span><br><span class="line">        this.autowiredAnnotationTypes.add((Class&lt;? extends Annotation&gt;)</span><br><span class="line">                ClassUtils.forName(&quot;javax.inject.Inject&quot;, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));</span><br><span class="line">        logger.info(&quot;JSR-330 &apos;javax.inject.Inject&apos; annotation found and supported for autowiring&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // JSR-330 API not available - simply skip.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"><a href="#14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法" class="headerlink" title="14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"></a>14、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName) &#123;</span><br><span class="line">    //获取给定类的autowire相关注解的字段及方法</span><br><span class="line">    InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);</span><br><span class="line">    metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法"><a href="#15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法" class="headerlink" title="15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法"></a>15、AutowiredAnnotationBeanPostProcessor的findAutowiringMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata findAutowiringMetadata(String beanName, Class&lt;?&gt; clazz, @Nullable PropertyValues pvs) &#123;</span><br><span class="line">    // Fall back to class name as cache key, for backwards compatibility with custom callers.</span><br><span class="line">    //先从缓存中获取</span><br><span class="line">    String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());</span><br><span class="line">    // Quick check on the concurrent map first, with minimal locking.</span><br><span class="line">    InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">    if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">        synchronized (this.injectionMetadataCache) &#123;</span><br><span class="line">            metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">            if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">                if (metadata != null) &#123;</span><br><span class="line">                    metadata.clear(pvs);</span><br><span class="line">                &#125;</span><br><span class="line">                //解析@Autowired等注解的字段和方法</span><br><span class="line">                metadata = buildAutowiringMetadata(clazz);</span><br><span class="line">                //添加缓存</span><br><span class="line">                this.injectionMetadataCache.put(cacheKey, metadata);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法"><a href="#16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法" class="headerlink" title="16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法"></a>16、AutowiredAnnotationBeanPostProcessor的buildAutowiringMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata buildAutowiringMetadata(final Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    //存放注解信息的集合  </span><br><span class="line">    LinkedList&lt;InjectionMetadata.InjectedElement&gt; elements = new LinkedList&lt;&gt;();</span><br><span class="line">    Class&lt;?&gt; targetClass = clazz;</span><br><span class="line">    //递归遍历当前类及其所有父类，解析注解</span><br><span class="line">    do &#123;</span><br><span class="line">        //当前正在处理类注解信息的集合</span><br><span class="line">        final LinkedList&lt;InjectionMetadata.InjectedElement&gt; currElements = new LinkedList&lt;&gt;();</span><br><span class="line">        //获取字段上的注解信息</span><br><span class="line">        ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;</span><br><span class="line">            //遍历，获取字段上的注解</span><br><span class="line">            AnnotationAttributes ann = findAutowiredAnnotation(field);</span><br><span class="line">            if (ann != null) &#123;</span><br><span class="line">                //静态字段跳过</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Autowired annotation is not supported on static fields: &quot; + field);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                //判断注解的required属性值是否有效</span><br><span class="line">                boolean required = determineRequiredStatus(ann);</span><br><span class="line">                //字段信息加入集合</span><br><span class="line">                currElements.add(new AutowiredFieldElement(field, required));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //遍历，获取方法上的注解信息</span><br><span class="line">        ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;</span><br><span class="line">            //获取桥接方法的原始方法</span><br><span class="line">            Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method)</span><br><span class="line">            //方法参数和方法返回值类型不同，不处理</span><br><span class="line">            if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            //获取方法上的所有注解</span><br><span class="line">            AnnotationAttributes ann = findAutowiredAnnotation(bridgedMethod);</span><br><span class="line">            if (ann != null &amp;&amp; method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class="line">                //静态方法，不处理</span><br><span class="line">                if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Autowired annotation is not supported on static methods: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                if (method.getParameterCount() == 0) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Autowired annotation should only be used on methods with parameters: &quot; +</span><br><span class="line">                                method);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //判断注解的required属性值是否有效</span><br><span class="line">                boolean required = determineRequiredStatus(ann);</span><br><span class="line">                //获取当前方法的属性描述符，即方法是可读的(readable)getter方法，  </span><br><span class="line">                //还是可写的(writeable)setter方法  </span><br><span class="line">                PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                //方法信息加入集合</span><br><span class="line">                currElements.add(new AutowiredMethodElement(method, required, pd));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //当前类的注解信息存放到集合中</span><br><span class="line">        elements.addAll(0, currElements);</span><br><span class="line">        targetClass = targetClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    while (targetClass != null &amp;&amp; targetClass != Object.class);</span><br><span class="line"></span><br><span class="line">    return new InjectionMetadata(clazz, elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法"><a href="#17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法" class="headerlink" title="17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法"></a>17、AutowiredAnnotationBeanPostProcessor的findAutowiredAnnotation方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private AnnotationAttributes findAutowiredAnnotation(AccessibleObject ao) &#123;</span><br><span class="line">    if (ao.getAnnotations().length &gt; 0) &#123;</span><br><span class="line">        //遍历所有autowire相关的注解:@Autowire、@Value以及JSR-330等</span><br><span class="line">        for (Class&lt;? extends Annotation&gt; type : this.autowiredAnnotationTypes) &#123;</span><br><span class="line">            //获取指定类型的注解</span><br><span class="line">            AnnotationAttributes attributes = AnnotatedElementUtils.getMergedAnnotationAttributes(ao, type);</span><br><span class="line">            if (attributes != null) &#123;</span><br><span class="line">                return attributes;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法"><a href="#18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法" class="headerlink" title="18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法"></a>18、AutowiredAnnotationBeanPostProcessor的postProcessPropertyValues方法</h4><h5 id="获取bean时，在设置属性值之前会调用处理器的postProcessPropertyValues方法"><a href="#获取bean时，在设置属性值之前会调用处理器的postProcessPropertyValues方法" class="headerlink" title="获取bean时，在设置属性值之前会调用处理器的postProcessPropertyValues方法"></a>获取bean时，在设置属性值之前会调用处理器的postProcessPropertyValues方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public PropertyValues postProcessPropertyValues(  </span><br><span class="line">        PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeansException &#123;  </span><br><span class="line">    //获取@Autowired等注解信息 </span><br><span class="line">    InjectionMetadata metadata = findAutowiringMetadata(bean.getClass());  </span><br><span class="line">    try &#123;  </span><br><span class="line">        //自动注入Bean的属性</span><br><span class="line">        metadata.inject(bean, beanName, pvs);  </span><br><span class="line">    &#125;  </span><br><span class="line">    catch (Throwable ex) &#123;  </span><br><span class="line">        throw new BeanCreationException(beanName, &quot;Injection of autowired dependencies failed&quot;, ex);  </span><br><span class="line">    &#125;  </span><br><span class="line">    return pvs;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、InjectionMetadata的inject方法"><a href="#19、InjectionMetadata的inject方法" class="headerlink" title="19、InjectionMetadata的inject方法"></a>19、InjectionMetadata的inject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void inject(Object target, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable &#123;</span><br><span class="line">    Collection&lt;InjectedElement&gt; checkedElements = this.checkedElements;</span><br><span class="line">    Collection&lt;InjectedElement&gt; elementsToIterate =</span><br><span class="line">            (checkedElements != null ? checkedElements : this.injectedElements);</span><br><span class="line">    if (!elementsToIterate.isEmpty()) &#123;</span><br><span class="line">        boolean debug = logger.isDebugEnabled();</span><br><span class="line">        for (InjectedElement element : elementsToIterate) &#123;</span><br><span class="line">            if (debug) &#123;</span><br><span class="line">                logger.debug(&quot;Processing injected element of bean &apos;&quot; + beanName + &quot;&apos;: &quot; + element);</span><br><span class="line">            &#125;</span><br><span class="line">            //自动注入Bean的属性</span><br><span class="line">            element.inject(target, beanName, pvs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、AutowiredFieldElement的inject方法"><a href="#20、AutowiredFieldElement的inject方法" class="headerlink" title="20、AutowiredFieldElement的inject方法"></a>20、AutowiredFieldElement的inject方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) throws Throwable &#123;</span><br><span class="line">    //注入的字段</span><br><span class="line">    Field field = (Field) this.member;</span><br><span class="line">    Object value;</span><br><span class="line">    //有缓存使用缓存</span><br><span class="line">    if (this.cached) &#123;</span><br><span class="line">        value = resolvedCachedArgument(beanName, this.cachedFieldValue);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        DependencyDescriptor desc = new DependencyDescriptor(field, this.required);</span><br><span class="line">        desc.setContainingClass(bean.getClass());</span><br><span class="line">        Set&lt;String&gt; autowiredBeanNames = new LinkedHashSet&lt;&gt;(1);</span><br><span class="line">        Assert.state(beanFactory != null, &quot;No BeanFactory available&quot;);</span><br><span class="line">        TypeConverter typeConverter = beanFactory.getTypeConverter();</span><br><span class="line">        try &#123;</span><br><span class="line">            //获取依赖对象 </span><br><span class="line">            value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeansException ex) &#123;</span><br><span class="line">            throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(field), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            //添加缓存</span><br><span class="line">            if (!this.cached) &#123;</span><br><span class="line">                if (value != null || this.required) &#123;</span><br><span class="line">                    this.cachedFieldValue = desc;</span><br><span class="line">                    //注册依赖</span><br><span class="line">                    registerDependentBeans(beanName, autowiredBeanNames);</span><br><span class="line">                    if (autowiredBeanNames.size() == 1) &#123;</span><br><span class="line">                        String autowiredBeanName = autowiredBeanNames.iterator().next();</span><br><span class="line">                        //如果容器中有依赖对象且依赖对象类型和字段类型匹配</span><br><span class="line">                        if (beanFactory.containsBean(autowiredBeanName) &amp;&amp;</span><br><span class="line">                                beanFactory.isTypeMatch(autowiredBeanName, field.getType())) &#123;</span><br><span class="line">                            //创建缓存</span><br><span class="line">                            this.cachedFieldValue = new ShortcutDependencyDescriptor(</span><br><span class="line">                                    desc, autowiredBeanName, field.getType());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    this.cachedFieldValue = null;</span><br><span class="line">                &#125;</span><br><span class="line">                this.cached = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (value != null) &#123;</span><br><span class="line">        ReflectionUtils.makeAccessible(field);</span><br><span class="line">        field.set(bean, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、AutowiredFieldElement的resolvedCachedArgument方法"><a href="#21、AutowiredFieldElement的resolvedCachedArgument方法" class="headerlink" title="21、AutowiredFieldElement的resolvedCachedArgument方法"></a>21、AutowiredFieldElement的resolvedCachedArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private Object resolvedCachedArgument(@Nullable String beanName, @Nullable Object cachedArgument) &#123;</span><br><span class="line">    if (cachedArgument instanceof DependencyDescriptor) &#123;</span><br><span class="line">        DependencyDescriptor descriptor = (DependencyDescriptor) cachedArgument;</span><br><span class="line">        Assert.state(beanFactory != null, &quot;No BeanFactory available&quot;);</span><br><span class="line">        //获取依赖对象，该方法在XmlBeanFactory容器中已有介绍</span><br><span class="line">        return this.beanFactory.resolveDependency(descriptor, beanName, null, null);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return cachedArgument;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"><a href="#22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器" class="headerlink" title="22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器"></a>22、接（三、3）实例化AutowiredAnnotationBeanPostProcessor处理器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        //加载WebService相关的类</span><br><span class="line">        Class&lt;? extends Annotation&gt; clazz = (Class&lt;? extends Annotation&gt;)</span><br><span class="line">                ClassUtils.forName(&quot;javax.xml.ws.WebServiceRef&quot;, CommonAnnotationBeanPostProcessor.class.getClassLoader());</span><br><span class="line">        webServiceRefClass = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        webServiceRefClass = null;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        //加载EJB相关的类  </span><br><span class="line">        Class&lt;? extends Annotation&gt; clazz = (Class&lt;? extends Annotation&gt;)</span><br><span class="line">                ClassUtils.forName(&quot;javax.ejb.EJB&quot;, CommonAnnotationBeanPostProcessor.class.getClassLoader());</span><br><span class="line">        ejbRefClass = clazz;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        ejbRefClass = null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public CommonAnnotationBeanPostProcessor() &#123;</span><br><span class="line">    setOrder(Ordered.LOWEST_PRECEDENCE - 3);</span><br><span class="line">    //父类InitDestroyAnnotationBeanPostProcessor</span><br><span class="line">    //在bean初始化之前postProcessBeforeInitialization执行@PostConstruct注解方法</span><br><span class="line">    //在bean销毁之前postProcessBeforeDestruction执行@PreDestroy注解方法</span><br><span class="line">    setInitAnnotationType(PostConstruct.class);</span><br><span class="line">    setDestroyAnnotationType(PreDestroy.class);</span><br><span class="line">    //当使用@Resource注解时.忽略JAX-WS的资源类型 </span><br><span class="line">    ignoreResourceType(&quot;javax.xml.ws.WebServiceContext&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"><a href="#23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法" class="headerlink" title="23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法"></a>23、AutowiredAnnotationBeanPostProcessor的postProcessMergedBeanDefinition方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName) &#123;</span><br><span class="line">    super.postProcessMergedBeanDefinition(beanDefinition, beanType, beanName);</span><br><span class="line">    //获取@Resource注解的属性信息</span><br><span class="line">    InjectionMetadata metadata = findResourceMetadata(beanName, beanType, null);</span><br><span class="line">    metadata.checkConfigMembers(beanDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法"><a href="#24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法" class="headerlink" title="24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法"></a>24、AutowiredAnnotationBeanPostProcessor的findResourceMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata findResourceMetadata(String beanName, final Class&lt;?&gt; clazz, @Nullable PropertyValues pvs) &#123;</span><br><span class="line">    // Fall back to class name as cache key, for backwards compatibility with custom callers.</span><br><span class="line">    String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());</span><br><span class="line">    // Quick check on the concurrent map first, with minimal locking.</span><br><span class="line">    //首先从容器缓存中查找 </span><br><span class="line">    InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">    //缓存数据过期</span><br><span class="line">    if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">        synchronized (this.injectionMetadataCache) &#123;</span><br><span class="line">            metadata = this.injectionMetadataCache.get(cacheKey);</span><br><span class="line">            if (InjectionMetadata.needsRefresh(metadata, clazz)) &#123;</span><br><span class="line">                if (metadata != null) &#123;</span><br><span class="line">                    metadata.clear(pvs);</span><br><span class="line">                &#125;</span><br><span class="line">                //获取@Resource注解的属性信息</span><br><span class="line">                metadata = buildResourceMetadata(clazz);</span><br><span class="line">                this.injectionMetadataCache.put(cacheKey, metadata);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法"><a href="#25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法" class="headerlink" title="25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法"></a>25、AutowiredAnnotationBeanPostProcessor的buildResourceMetadata方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">private InjectionMetadata buildResourceMetadata(final Class&lt;?&gt; clazz) &#123;</span><br><span class="line">    //注解数据的集合</span><br><span class="line">    LinkedList&lt;InjectionMetadata.InjectedElement&gt; elements = new LinkedList&lt;&gt;();</span><br><span class="line">    Class&lt;?&gt; targetClass = clazz;</span><br><span class="line">    //递归地的解析给定类及其所有父类的注解信息</span><br><span class="line">    do &#123;</span><br><span class="line">        //存放当前类注解数据的集合</span><br><span class="line">        final LinkedList&lt;InjectionMetadata.InjectedElement&gt; currElements =</span><br><span class="line">                new LinkedList&lt;&gt;();</span><br><span class="line">        //遍历所有的字段，查找符合的注解 </span><br><span class="line">        ReflectionUtils.doWithLocalFields(targetClass, field -&gt; &#123;</span><br><span class="line">            //如果字段上配置了WebService相关的注解</span><br><span class="line">            if (webServiceRefClass != null &amp;&amp; field.isAnnotationPresent(webServiceRefClass)) &#123;</span><br><span class="line">                //静态不处理</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;@WebServiceRef annotation is not supported on static fields&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                currElements.add(new WebServiceRefElement(field, field, null));</span><br><span class="line">            &#125;</span><br><span class="line">            //如果当前字段上配置了EJB相关的注解</span><br><span class="line">            else if (ejbRefClass != null &amp;&amp; field.isAnnotationPresent(ejbRefClass)) &#123;</span><br><span class="line">                //静态不处理</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;@EJB annotation is not supported on static fields&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //加入当前注解数据的集合</span><br><span class="line">                currElements.add(new EjbRefElement(field, field, null));</span><br><span class="line">            &#125;</span><br><span class="line">            //如果当前字段上配置了@Resource注解  </span><br><span class="line">            else if (field.isAnnotationPresent(Resource.class)) &#123;</span><br><span class="line">                if (Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                    throw new IllegalStateException(&quot;@Resource annotation is not supported on static fields&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                //如果当前自动的类型不再被忽略的Resource类型中，  </span><br><span class="line">                //加入当前注解数据的集合</span><br><span class="line">                if (!ignoredResourceTypes.contains(field.getType().getName())) &#123;</span><br><span class="line">                    currElements.add(new ResourceElement(field, field, null));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //遍历所有方法，查找相关的注解</span><br><span class="line">        ReflectionUtils.doWithLocalMethods(targetClass, method -&gt; &#123;</span><br><span class="line">            //获取桥接方法</span><br><span class="line">            Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);</span><br><span class="line">            if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            //当前方法没有覆盖父类方法</span><br><span class="line">            if (method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) &#123;</span><br><span class="line">                //如果方法上配置了WebService相关的注解</span><br><span class="line">                if (webServiceRefClass != null &amp;&amp; bridgedMethod.isAnnotationPresent(webServiceRefClass)) &#123;</span><br><span class="line">                    if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@WebServiceRef annotation is not supported on static methods&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (method.getParameterCount() != 1) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@WebServiceRef annotation requires a single-arg method: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    //获取方法的属性描述 </span><br><span class="line">                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                    //加入当前注解数据的集合</span><br><span class="line">                    currElements.add(new WebServiceRefElement(method, bridgedMethod, pd));</span><br><span class="line">                &#125;</span><br><span class="line">                //如果方法上配置了EJB相关的注解  </span><br><span class="line">                else if (ejbRefClass != null &amp;&amp; bridgedMethod.isAnnotationPresent(ejbRefClass)) &#123;</span><br><span class="line">                    if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@EJB annotation is not supported on static methods&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (method.getParameterCount() != 1) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@EJB annotation requires a single-arg method: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                    currElements.add(new EjbRefElement(method, bridgedMethod, pd));</span><br><span class="line">                &#125;</span><br><span class="line">                //如果方法上配置了EJB相关的注解  </span><br><span class="line">                else if (bridgedMethod.isAnnotationPresent(Resource.class)) &#123;</span><br><span class="line">                    if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@Resource annotation is not supported on static methods&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line">                    if (paramTypes.length != 1) &#123;</span><br><span class="line">                        throw new IllegalStateException(&quot;@Resource annotation requires a single-arg method: &quot; + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!ignoredResourceTypes.contains(paramTypes[0].getName())) &#123;</span><br><span class="line">                        PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);</span><br><span class="line">                        currElements.add(new ResourceElement(method, bridgedMethod, pd));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //将当前类注解数据存放到集合中 </span><br><span class="line">        elements.addAll(0, currElements);</span><br><span class="line">        targetClass = targetClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    while (targetClass != null &amp;&amp; targetClass != Object.class);</span><br><span class="line"></span><br><span class="line">    return new InjectionMetadata(clazz, elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/klugjo/hexo-theme-clean-blog" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>