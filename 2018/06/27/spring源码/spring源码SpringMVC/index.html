<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="spring源码SpringMVC###demoweb.xml配置文件12345678910111213141516171819&amp;lt;context-param&amp;gt;      &amp;lt;param-name&amp;gt;contextConfigLocation&amp;lt;/param-name&amp;gt; "/>
    

    <!--Author-->
    
        <meta name="author" content="小远"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="spring源码SpringMVC"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="spring源码SpringMVC###demoweb.xml配置文件12345678910111213141516171819&amp;lt;context-param&amp;gt;      &amp;lt;param-name&amp;gt;contextConfigLocation&amp;lt;/param-name&amp;gt; "/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>spring源码SpringMVC - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">menu</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/klugjo/hexo-theme-clean-blog">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>spring源码SpringMVC</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-06-27
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/spring/">spring</a>

                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 id="spring源码SpringMVC"><a href="#spring源码SpringMVC" class="headerlink" title="spring源码SpringMVC"></a>spring源码SpringMVC</h2><p>###demo<br>web.xml配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;context-param&gt;  </span><br><span class="line">    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;  </span><br><span class="line">    &lt;param-value&gt;  </span><br><span class="line">        classpath:applicationContext.xml  </span><br><span class="line">    &lt;/param-value&gt;  </span><br><span class="line">&lt;/context-param&gt;  </span><br><span class="line">&lt;listener&gt;  </span><br><span class="line">    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;  </span><br><span class="line">&lt;/listener&gt;</span><br><span class="line"></span><br><span class="line">&lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;appServlet&lt;/servlet-name&gt;</span><br><span class="line">    &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<p>applicationContext.xml配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans:beans xmlns:beans=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd</span><br><span class="line">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd &quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;mvc:annotation-driven /&gt;</span><br><span class="line">    &lt;!--对web包中的所有类进行扫描，以完成Bean创建和自动依赖注入的功能 --&gt;</span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.zjn&quot; /</span><br><span class="line"></span><br><span class="line">    &lt;!-- 这个类用于Spring MVC视图解析 --&gt;</span><br><span class="line">    &lt;beans:bean id=&quot;viewResolver&quot;</span><br><span class="line">        class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;</span><br><span class="line">        &lt;beans:property name=&quot;prefix&quot; value=&quot;/WEB-INF/pages/&quot; /&gt;</span><br><span class="line">        &lt;beans:property name=&quot;suffix&quot; value=&quot;.jsp&quot; /&gt;</span><br><span class="line">    &lt;/beans:bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 定义文件上传解析器 --&gt;</span><br><span class="line">    &lt;bean id=&quot;multipartResolver&quot; class=&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;&gt;</span><br><span class="line">        &lt;!-- 设定默认编码 --&gt;</span><br><span class="line">        &lt;property name=&quot;defaultEncoding&quot; value=&quot;UTF-8&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 设定文件上传的最大值为5MB，5*1024*1024 --&gt;</span><br><span class="line">        &lt;property name=&quot;maxUploadSize&quot; value=&quot;5242880&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 设定文件上传时写入内存的最大值，如果小于这个参数不会生成临时文件，默认为10240 --&gt;</span><br><span class="line">        &lt;property name=&quot;maxInMemorySize&quot; value=&quot;40960&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 上传文件的临时路径 --&gt;</span><br><span class="line">        &lt;property name=&quot;uploadTempDir&quot; value=&quot;fileUpload/temp&quot;&gt;&lt;/property&gt;</span><br><span class="line">        &lt;!-- 延迟文件解析 --&gt;</span><br><span class="line">        &lt;property name=&quot;resolveLazily&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans:beans&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="一、启动容器"><a href="#一、启动容器" class="headerlink" title="一、启动容器"></a>一、启动容器</h3><h4 id="1、ContextLoaderListener的contextInitialized方法"><a href="#1、ContextLoaderListener的contextInitialized方法" class="headerlink" title="1、ContextLoaderListener的contextInitialized方法"></a>1、ContextLoaderListener的contextInitialized方法</h4><p>tomcat启动时会初始化一个Servlet容器，这样ContextLoaderListener会监听到Servlet的初始化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override  </span><br><span class="line">public void contextInitialized(ServletContextEvent event) &#123;  </span><br><span class="line">    //初始化ioc容器 </span><br><span class="line">    initWebApplicationContext(event.getServletContext());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、ContextLoader的initWebApplicationContext方法"><a href="#2、ContextLoader的initWebApplicationContext方法" class="headerlink" title="2、ContextLoader的initWebApplicationContext方法"></a>2、ContextLoader的initWebApplicationContext方法</h4><p>ContextLoaderListener的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public WebApplicationContext initWebApplicationContext(ServletContext servletContext) &#123;</span><br><span class="line">    //servlet容器中已存在一个ioc容器</span><br><span class="line">    if (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;Cannot initialize context because there is already a root application context present - &quot; +</span><br><span class="line">                &quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log logger = LogFactory.getLog(ContextLoader.class);</span><br><span class="line">    servletContext.log(&quot;Initializing Spring root WebApplicationContext&quot;);</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Root WebApplicationContext: initialization started&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // Store context in local instance variable, to guarantee that</span><br><span class="line">        // it is available on ServletContext shutdown.</span><br><span class="line">        if (this.context == null) &#123;</span><br><span class="line">            //创建WebApplicationContext，默认为ContextLoader.properties中配置的XmlWebApplicationContext容器</span><br><span class="line">            this.context = createWebApplicationContext(servletContext);</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.context instanceof ConfigurableWebApplicationContext) &#123;</span><br><span class="line">            ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context;</span><br><span class="line">            //容器未激活或已关闭</span><br><span class="line">            if (!cwac.isActive()) &#123;</span><br><span class="line">                // The context has not yet been refreshed -&gt; provide services such as</span><br><span class="line">                // setting the parent context, setting the application context id, etc</span><br><span class="line">                if (cwac.getParent() == null) &#123;</span><br><span class="line">                    // The context instance was injected without an explicit parent -&gt;</span><br><span class="line">                    // determine parent for root web application context, if any.</span><br><span class="line">                    //从servlet容器中获取父容器，没有则返回null</span><br><span class="line">                    ApplicationContext parent = loadParentContext(servletContext);</span><br><span class="line">                    cwac.setParent(parent);</span><br><span class="line">                &#125;</span><br><span class="line">                //设置并刷新WebApplicationContext容器</span><br><span class="line">                configureAndRefreshWebApplicationContext(cwac, servletContext);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //将初始化的WebApplicationContext设置到servletContext中</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);</span><br><span class="line"></span><br><span class="line">        ClassLoader ccl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        if (ccl == ContextLoader.class.getClassLoader()) &#123;</span><br><span class="line">            currentContext = this.context;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ccl != null) &#123;</span><br><span class="line">            currentContextPerThread.put(ccl, this.context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Published root WebApplicationContext as ServletContext attribute with name [&quot; +</span><br><span class="line">                    WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isInfoEnabled()) &#123;</span><br><span class="line">            long elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">            logger.info(&quot;Root WebApplicationContext: initialization completed in &quot; + elapsedTime + &quot; ms&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return this.context;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (RuntimeException ex) &#123;</span><br><span class="line">        logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Error err) &#123;</span><br><span class="line">        logger.error(&quot;Context initialization failed&quot;, err);</span><br><span class="line">        servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, err);</span><br><span class="line">        throw err;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、ContextLoader的configureAndRefreshWebApplicationContext方法"><a href="#3、ContextLoader的configureAndRefreshWebApplicationContext方法" class="headerlink" title="3、ContextLoader的configureAndRefreshWebApplicationContext方法"></a>3、ContextLoader的configureAndRefreshWebApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc) &#123;</span><br><span class="line">    if (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123;</span><br><span class="line">        // The application context id is still set to its original default value</span><br><span class="line">        // -&gt; assign a more useful id based on available information</span><br><span class="line">        //设置容器id</span><br><span class="line">        String idParam = sc.getInitParameter(CONTEXT_ID_PARAM);</span><br><span class="line">        if (idParam != null) &#123;</span><br><span class="line">            wac.setId(idParam);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Generate default id...</span><br><span class="line">            wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +</span><br><span class="line">                    ObjectUtils.getDisplayString(sc.getContextPath()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置ServletContext到容器中</span><br><span class="line">    wac.setServletContext(sc);</span><br><span class="line">    //获得web.xml中配置的contextConfigLocation的值，一般是classpath:applicationContext.xml</span><br><span class="line">    String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM);</span><br><span class="line">    if (configLocationParam != null) &#123;</span><br><span class="line">        wac.setConfigLocation(configLocationParam);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The wac environment&apos;s #initPropertySources will be called in any case when the context</span><br><span class="line">    // is refreshed; do it eagerly here to ensure servlet property sources are in place for</span><br><span class="line">    // use in any post-processing or initialization that occurs below prior to #refresh</span><br><span class="line">    ConfigurableEnvironment env = wac.getEnvironment();</span><br><span class="line">    if (env instanceof ConfigurableWebEnvironment) &#123;</span><br><span class="line">        ((ConfigurableWebEnvironment) env).initPropertySources(sc, null);</span><br><span class="line">    &#125;</span><br><span class="line">    //执行容器初始化器</span><br><span class="line">    customizeContext(sc, wac);</span><br><span class="line">    //刷新容器上下文</span><br><span class="line">    wac.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、MvcNamespaceHandler的init方法"><a href="#4、MvcNamespaceHandler的init方法" class="headerlink" title="4、MvcNamespaceHandler的init方法"></a>4、MvcNamespaceHandler的init方法</h4><p>自定义标签解析器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void init() &#123;</span><br><span class="line">    registerBeanDefinitionParser(&quot;annotation-driven&quot;, new AnnotationDrivenBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;default-servlet-handler&quot;, new DefaultServletHandlerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;interceptors&quot;, new InterceptorsBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;resources&quot;, new ResourcesBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;view-controller&quot;, new ViewControllerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;redirect-view-controller&quot;, new ViewControllerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;status-controller&quot;, new ViewControllerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;view-resolvers&quot;, new ViewResolversBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;tiles-configurer&quot;, new TilesConfigurerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;freemarker-configurer&quot;, new FreeMarkerConfigurerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;velocity-configurer&quot;, new VelocityConfigurerBeanDefinitionParser());</span><br><span class="line">    registerBeanDefinitionParser(&quot;groovy-configurer&quot;, new GroovyMarkupConfigurerBeanDefinitionParser());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5、AnnotationDrivenBeanDefinitionParser的parse方法"><a href="#5、AnnotationDrivenBeanDefinitionParser的parse方法" class="headerlink" title="5、AnnotationDrivenBeanDefinitionParser的parse方法"></a>5、AnnotationDrivenBeanDefinitionParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public BeanDefinition parse(Element element, ParserContext parserContext) &#123;</span><br><span class="line">    Object source = parserContext.extractSource(element);</span><br><span class="line">    </span><br><span class="line">    CompositeComponentDefinition compDefinition = new CompositeComponentDefinition(element.getTagName(), source);</span><br><span class="line">    parserContext.pushContainingComponent(compDefinition);</span><br><span class="line"></span><br><span class="line">    //处理&quot;content-negotiation-manager&quot;属性,默认注册ContentNegotiationManagerFactoryBean</span><br><span class="line">    //ContentNegotiationStrategy为request和mediatypes解析的策略类</span><br><span class="line">    RuntimeBeanReference contentNegotiationManager = getContentNegotiationManager(element, source, parserContext);</span><br><span class="line"></span><br><span class="line">    RootBeanDefinition handlerMappingDef = new RootBeanDefinition(RequestMappingHandlerMapping.class);</span><br><span class="line">    handlerMappingDef.setSource(source);</span><br><span class="line">    handlerMappingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    //优先级设置为最高</span><br><span class="line">    handlerMappingDef.getPropertyValues().add(&quot;order&quot;, 0);</span><br><span class="line">    //添加contentNegotiationManager属性，处理MediaType </span><br><span class="line">    handlerMappingDef.getPropertyValues().add(&quot;contentNegotiationManager&quot;, contentNegotiationManager);</span><br><span class="line">    //注册RequestMappingHandlerMapping的bean</span><br><span class="line">    String methodMappingName = parserContext.getReaderContext().registerWithGeneratedName(handlerMappingDef);</span><br><span class="line">    //表示是否开启多变量映射</span><br><span class="line">    if (element.hasAttribute(&quot;enable-matrix-variables&quot;)) &#123;</span><br><span class="line">        Boolean enableMatrixVariables = Boolean.valueOf(element.getAttribute(&quot;enable-matrix-variables&quot;));</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;removeSemicolonContent&quot;, !enableMatrixVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(&quot;enableMatrixVariables&quot;)) &#123;</span><br><span class="line">        Boolean enableMatrixVariables = Boolean.valueOf(element.getAttribute(&quot;enableMatrixVariables&quot;));</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;removeSemicolonContent&quot;, !enableMatrixVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    //配置路径匹配解析器等属性</span><br><span class="line">    configurePathMatchingProperties(handlerMappingDef, element, parserContext);</span><br><span class="line"></span><br><span class="line">    //处理&quot;conversion-service&quot;属性，默认注册FormattingConversionServiceFactoryBean</span><br><span class="line">    //处理一些基本类的格式与转换，比如时间、数字等</span><br><span class="line">    RuntimeBeanReference conversionService = getConversionService(element, source, parserContext);</span><br><span class="line">    //处理&quot;validator&quot;属性,默认注册OptionalValidatorFactoryBean</span><br><span class="line">    //用于javabean的参数校验等</span><br><span class="line">    RuntimeBeanReference validator = getValidator(element, source, parserContext);</span><br><span class="line">    //处理&quot;message-codes-resolver&quot;属性，默认为null</span><br><span class="line">    RuntimeBeanReference messageCodesResolver = getMessageCodesResolver(element);</span><br><span class="line">    //注册ConfigurableWebBindingInitializer的bean，用于数据绑定</span><br><span class="line">    RootBeanDefinition bindingDef = new RootBeanDefinition(ConfigurableWebBindingInitializer.class);</span><br><span class="line">    bindingDef.setSource(source);</span><br><span class="line">    bindingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    bindingDef.getPropertyValues().add(&quot;conversionService&quot;, conversionService);</span><br><span class="line">    bindingDef.getPropertyValues().add(&quot;validator&quot;, validator);</span><br><span class="line">    bindingDef.getPropertyValues().add(&quot;messageCodesResolver&quot;, messageCodesResolver);</span><br><span class="line"></span><br><span class="line">    //处理&quot;message-converters&quot;子节点，消息转换器，可用于向前端发送数据再次自定义组装</span><br><span class="line">    //比如MappingJackson2HttpMessageConverter json转字符串</span><br><span class="line">    ManagedList&lt;?&gt; messageConverters = getMessageConverters(element, source, parserContext);</span><br><span class="line">    //处理&quot;argument-resolvers&quot;子节点,用于参数解析</span><br><span class="line">    ManagedList&lt;?&gt; argumentResolvers = getArgumentResolvers(element, parserContext);</span><br><span class="line">    //处理&quot;return-value-handlers&quot;子节点</span><br><span class="line">    ManagedList&lt;?&gt; returnValueHandlers = getReturnValueHandlers(element, parserContext);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;default-timeout&quot;属性，作为异步处理超时时间，默认null</span><br><span class="line">    String asyncTimeout = getAsyncTimeout(element);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;task-executor&quot;属性。异步任务线程池</span><br><span class="line">    RuntimeBeanReference asyncExecutor = getAsyncExecutor(element);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;callable-interceptors&quot;节点。异步处理callable类型拦截器，默认为空</span><br><span class="line">    ManagedList&lt;?&gt; callableInterceptors = getCallableInterceptors(element, source, parserContext);</span><br><span class="line">    //处理&quot;async-support&quot;子节点，获取其中的&quot;deferred-result-interceptors&quot;节点。拦截器，默认为空</span><br><span class="line">    ManagedList&lt;?&gt; deferredResultInterceptors = getDeferredResultInterceptors(element, source, parserContext);</span><br><span class="line">    //将上述的属性添加到RequestMappingHandlerAdapter中</span><br><span class="line">    RootBeanDefinition handlerAdapterDef = new RootBeanDefinition(RequestMappingHandlerAdapter.class);</span><br><span class="line">    handlerAdapterDef.setSource(source);</span><br><span class="line">    handlerAdapterDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;contentNegotiationManager&quot;, contentNegotiationManager);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;webBindingInitializer&quot;, bindingDef);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;messageConverters&quot;, messageConverters);</span><br><span class="line">    addResponseBodyAdvice(handlerAdapterDef);</span><br><span class="line">    //解析&quot;ignoreDefaultModelOnRedirect&quot;属性</span><br><span class="line">    if (element.hasAttribute(&quot;ignore-default-model-on-redirect&quot;)) &#123;</span><br><span class="line">        Boolean ignoreDefaultModel = Boolean.valueOf(element.getAttribute(&quot;ignore-default-model-on-redirect&quot;));</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;ignoreDefaultModelOnRedirect&quot;, ignoreDefaultModel);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (element.hasAttribute(&quot;ignoreDefaultModelOnRedirect&quot;)) &#123;</span><br><span class="line">        // &quot;ignoreDefaultModelOnRedirect&quot; spelling is deprecated</span><br><span class="line">        Boolean ignoreDefaultModel = Boolean.valueOf(element.getAttribute(&quot;ignoreDefaultModelOnRedirect&quot;));</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;ignoreDefaultModelOnRedirect&quot;, ignoreDefaultModel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (argumentResolvers != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;customArgumentResolvers&quot;, argumentResolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    if (returnValueHandlers != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;customReturnValueHandlers&quot;, returnValueHandlers);</span><br><span class="line">    &#125;</span><br><span class="line">    if (asyncTimeout != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;asyncRequestTimeout&quot;, asyncTimeout);</span><br><span class="line">    &#125;</span><br><span class="line">    if (asyncExecutor != null) &#123;</span><br><span class="line">        handlerAdapterDef.getPropertyValues().add(&quot;taskExecutor&quot;, asyncExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;callableInterceptors&quot;, callableInterceptors);</span><br><span class="line">    handlerAdapterDef.getPropertyValues().add(&quot;deferredResultInterceptors&quot;, deferredResultInterceptors);</span><br><span class="line">    //注册RequestMappingHandlerAdapter的bean</span><br><span class="line">    String handlerAdapterName = parserContext.getReaderContext().registerWithGeneratedName(handlerAdapterDef);</span><br><span class="line"></span><br><span class="line">    String uriCompContribName = MvcUriComponentsBuilder.MVC_URI_COMPONENTS_CONTRIBUTOR_BEAN_NAME;</span><br><span class="line">    RootBeanDefinition uriCompContribDef = new RootBeanDefinition(CompositeUriComponentsContributorFactoryBean.class);</span><br><span class="line">    uriCompContribDef.setSource(source);</span><br><span class="line">    uriCompContribDef.getPropertyValues().addPropertyValue(&quot;handlerAdapter&quot;, handlerAdapterDef);</span><br><span class="line">    uriCompContribDef.getPropertyValues().addPropertyValue(&quot;conversionService&quot;, conversionService);</span><br><span class="line">    parserContext.getReaderContext().getRegistry().registerBeanDefinition(uriCompContribName, uriCompContribDef);</span><br><span class="line"></span><br><span class="line">    //注册ConversionServiceExposingInterceptor的bean</span><br><span class="line">    RootBeanDefinition csInterceptorDef = new RootBeanDefinition(ConversionServiceExposingInterceptor.class);</span><br><span class="line">    csInterceptorDef.setSource(source);</span><br><span class="line">    csInterceptorDef.getConstructorArgumentValues().addIndexedArgumentValue(0, conversionService);</span><br><span class="line"></span><br><span class="line">    //注册MappedInterceptor的bean</span><br><span class="line">    RootBeanDefinition mappedCsInterceptorDef = new RootBeanDefinition(MappedInterceptor.class);</span><br><span class="line">    mappedCsInterceptorDef.setSource(source);</span><br><span class="line">    mappedCsInterceptorDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    mappedCsInterceptorDef.getConstructorArgumentValues().addIndexedArgumentValue(0, (Object) null);</span><br><span class="line">    mappedCsInterceptorDef.getConstructorArgumentValues().addIndexedArgumentValue(1, csInterceptorDef);</span><br><span class="line">    String mappedInterceptorName = parserContext.getReaderContext().registerWithGeneratedName(mappedCsInterceptorDef);</span><br><span class="line"></span><br><span class="line">    //注册ExceptionHandlerExceptionResolver的bean，处理@ExceptionHandler注解</span><br><span class="line">    RootBeanDefinition exceptionHandlerExceptionResolver = new RootBeanDefinition(ExceptionHandlerExceptionResolver.class);</span><br><span class="line">    exceptionHandlerExceptionResolver.setSource(source);</span><br><span class="line">    exceptionHandlerExceptionResolver.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    exceptionHandlerExceptionResolver.getPropertyValues().add(&quot;contentNegotiationManager&quot;, contentNegotiationManager);</span><br><span class="line">    exceptionHandlerExceptionResolver.getPropertyValues().add(&quot;messageConverters&quot;, messageConverters);</span><br><span class="line">    exceptionHandlerExceptionResolver.getPropertyValues().add(&quot;order&quot;, 0);</span><br><span class="line">    addResponseBodyAdvice(exceptionHandlerExceptionResolver);</span><br><span class="line">    String methodExceptionResolverName =</span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(exceptionHandlerExceptionResolver);</span><br><span class="line"></span><br><span class="line">    //注册ResponseStatusExceptionResolver的bean，处理异常类上的@ResponseStatus注解</span><br><span class="line">    RootBeanDefinition responseStatusExceptionResolver = new RootBeanDefinition(ResponseStatusExceptionResolver.class);</span><br><span class="line">    responseStatusExceptionResolver.setSource(source);</span><br><span class="line">    responseStatusExceptionResolver.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    responseStatusExceptionResolver.getPropertyValues().add(&quot;order&quot;, 1);</span><br><span class="line">    String responseStatusExceptionResolverName =</span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(responseStatusExceptionResolver);</span><br><span class="line"></span><br><span class="line">    //注册DefaultHandlerExceptionResolver的bean，异常处理器</span><br><span class="line">    RootBeanDefinition defaultExceptionResolver = new RootBeanDefinition(DefaultHandlerExceptionResolver.class);</span><br><span class="line">    defaultExceptionResolver.setSource(source);</span><br><span class="line">    defaultExceptionResolver.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">    defaultExceptionResolver.getPropertyValues().add(&quot;order&quot;, 2);</span><br><span class="line">    String defaultExceptionResolverName =</span><br><span class="line">            parserContext.getReaderContext().registerWithGeneratedName(defaultExceptionResolver);</span><br><span class="line">    //注册组件并广播</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(handlerMappingDef, methodMappingName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(handlerAdapterDef, handlerAdapterName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(uriCompContribDef, uriCompContribName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(exceptionHandlerExceptionResolver, methodExceptionResolverName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(responseStatusExceptionResolver, responseStatusExceptionResolverName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(defaultExceptionResolver, defaultExceptionResolverName));</span><br><span class="line">    parserContext.registerComponent(new BeanComponentDefinition(mappedCsInterceptorDef, mappedInterceptorName));</span><br><span class="line"></span><br><span class="line">    // Ensure BeanNameUrlHandlerMapping (SPR-8289) and default HandlerAdapters are not &quot;turned off&quot;</span><br><span class="line">    //注册BeanNameUrlHandlerMapping的bean</span><br><span class="line">    MvcNamespaceUtils.registerDefaultComponents(parserContext, source);</span><br><span class="line"></span><br><span class="line">    parserContext.popAndRegisterContainingComponent();</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"><a href="#6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法" class="headerlink" title="6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"></a>6、AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private void configurePathMatchingProperties(RootBeanDefinition handlerMappingDef,</span><br><span class="line">                                             Element element, ParserContext parserContext) &#123;</span><br><span class="line">    //获取&quot;mvc:annotation-driven&quot;下子节点&quot;mvc:path-matching&quot;                                           </span><br><span class="line">    Element pathMatchingElement = DomUtils.getChildElementByTagName(element, &quot;path-matching&quot;);</span><br><span class="line">    if (pathMatchingElement != null) &#123;</span><br><span class="line">        //是否采用suffix-pattern，即.*,比如/user也匹配/user.*。默认为true</span><br><span class="line">        Object source = parserContext.extractSource(element);</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;suffix-pattern&quot;)) &#123;</span><br><span class="line">            Boolean useSuffixPatternMatch = Boolean.valueOf(pathMatchingElement.getAttribute(&quot;suffix-pattern&quot;));</span><br><span class="line">            handlerMappingDef.getPropertyValues().add(&quot;useSuffixPatternMatch&quot;, useSuffixPatternMatch);</span><br><span class="line">        &#125;</span><br><span class="line">        //是否采用分隔符，特指/，比如/user也匹配/user/。默认为true</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;trailing-slash&quot;)) &#123;</span><br><span class="line">            Boolean useTrailingSlashMatch = Boolean.valueOf(pathMatchingElement.getAttribute(&quot;trailing-slash&quot;));</span><br><span class="line">            handlerMappingDef.getPropertyValues().add(&quot;useTrailingSlashMatch&quot;, useTrailingSlashMatch);</span><br><span class="line">        &#125;</span><br><span class="line">        //是否采用contentNegotiationManager中的格式，比如*.json/*.xml。默认为false</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;registered-suffixes-only&quot;)) &#123;</span><br><span class="line">            Boolean useRegisteredSuffixPatternMatch = Boolean.valueOf(pathMatchingElement.getAttribute(&quot;registered-suffixes-only&quot;));</span><br><span class="line">            handlerMappingDef.getPropertyValues().add(&quot;useRegisteredSuffixPatternMatch&quot;, useRegisteredSuffixPatternMatch);</span><br><span class="line">        &#125;</span><br><span class="line">        RuntimeBeanReference pathHelperRef = null;</span><br><span class="line">        //路径解析帮助类，可指定，默认为UrlPathHelper</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;path-helper&quot;)) &#123;</span><br><span class="line">            pathHelperRef = new RuntimeBeanReference(pathMatchingElement.getAttribute(&quot;path-helper&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        pathHelperRef = MvcNamespaceUtils.registerUrlPathHelper(pathHelperRef, parserContext, source);</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;urlPathHelper&quot;, pathHelperRef);</span><br><span class="line"></span><br><span class="line">        RuntimeBeanReference pathMatcherRef = null;</span><br><span class="line">        //路径解析器，默认为AntPathMatcher解析器</span><br><span class="line">        if (pathMatchingElement.hasAttribute(&quot;path-matcher&quot;)) &#123;</span><br><span class="line">            pathMatcherRef = new RuntimeBeanReference(pathMatchingElement.getAttribute(&quot;path-matcher&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        pathMatcherRef = MvcNamespaceUtils.registerPathMatcher(pathMatcherRef, parserContext, source);</span><br><span class="line">        handlerMappingDef.getPropertyValues().add(&quot;pathMatcher&quot;, pathMatcherRef);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"><a href="#7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法" class="headerlink" title="7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法"></a>7、接（二、5）AnnotationDrivenBeanDefinitionParser的configurePathMatchingProperties方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">private ManagedList&lt;?&gt; getMessageConverters(Element element, Object source, ParserContext parserContext) &#123;</span><br><span class="line">    Element convertersElement = DomUtils.getChildElementByTagName(element, &quot;message-converters&quot;);</span><br><span class="line">    ManagedList&lt;? super Object&gt; messageConverters = new ManagedList&lt;Object&gt;();</span><br><span class="line">    if (convertersElement != null) &#123;</span><br><span class="line">        messageConverters.setSource(source);</span><br><span class="line">        for (Element beanElement : DomUtils.getChildElementsByTagName(convertersElement, &quot;bean&quot;, &quot;ref&quot;)) &#123;</span><br><span class="line">            Object object = parserContext.getDelegate().parsePropertySubElement(beanElement, null);</span><br><span class="line">            messageConverters.add(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (convertersElement == null || Boolean.valueOf(convertersElement.getAttribute(&quot;register-defaults&quot;))) &#123;</span><br><span class="line">        messageConverters.setSource(source);</span><br><span class="line">        //读写二进制数据</span><br><span class="line">        messageConverters.add(createConverterDefinition(ByteArrayHttpMessageConverter.class, source));</span><br><span class="line"></span><br><span class="line">        //转换器,将请求信息转换为字符串</span><br><span class="line">        RootBeanDefinition stringConverterDef = createConverterDefinition(StringHttpMessageConverter.class, source);</span><br><span class="line">        stringConverterDef.getPropertyValues().add(&quot;writeAcceptCharset&quot;, false);</span><br><span class="line">        messageConverters.add(stringConverterDef);</span><br><span class="line">        //</span><br><span class="line">        messageConverters.add(createConverterDefinition(ResourceHttpMessageConverter.class, source));</span><br><span class="line">        messageConverters.add(createConverterDefinition(SourceHttpMessageConverter.class, source));</span><br><span class="line">        messageConverters.add(createConverterDefinition(AllEncompassingFormHttpMessageConverter.class, source));</span><br><span class="line"></span><br><span class="line">        if (romePresent) &#123;</span><br><span class="line">            messageConverters.add(createConverterDefinition(AtomFeedHttpMessageConverter.class, source));</span><br><span class="line">            messageConverters.add(createConverterDefinition(RssChannelHttpMessageConverter.class, source));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (jackson2XmlPresent) &#123;</span><br><span class="line">            RootBeanDefinition jacksonConverterDef = createConverterDefinition(MappingJackson2XmlHttpMessageConverter.class, source);</span><br><span class="line">            GenericBeanDefinition jacksonFactoryDef = createObjectMapperFactoryDefinition(source);</span><br><span class="line">            jacksonFactoryDef.getPropertyValues().add(&quot;createXmlMapper&quot;, true);</span><br><span class="line">            jacksonConverterDef.getConstructorArgumentValues().addIndexedArgumentValue(0, jacksonFactoryDef);</span><br><span class="line">            messageConverters.add(jacksonConverterDef);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (jaxb2Present) &#123;</span><br><span class="line">            messageConverters.add(createConverterDefinition(Jaxb2RootElementHttpMessageConverter.class, source));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (jackson2Present) &#123;</span><br><span class="line">            RootBeanDefinition jacksonConverterDef = createConverterDefinition(MappingJackson2HttpMessageConverter.class, source);</span><br><span class="line">            GenericBeanDefinition jacksonFactoryDef = createObjectMapperFactoryDefinition(source);</span><br><span class="line">            jacksonConverterDef.getConstructorArgumentValues().addIndexedArgumentValue(0, jacksonFactoryDef);</span><br><span class="line">            messageConverters.add(jacksonConverterDef);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (gsonPresent) &#123;</span><br><span class="line">            messageConverters.add(createConverterDefinition(GsonHttpMessageConverter.class, source));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return messageConverters;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、初始化DispatcherServlet"><a href="#二、初始化DispatcherServlet" class="headerlink" title="二、初始化DispatcherServlet"></a>二、初始化DispatcherServlet</h3><h4 id="1、HttpServletBean的init方法"><a href="#1、HttpServletBean的init方法" class="headerlink" title="1、HttpServletBean的init方法"></a>1、HttpServletBean的init方法</h4><p>Servlet被装载后，Servlet容器创建一个Servlet实例并且调用Servlet的init()方法进行初始化。DispatcherServlet父类HttpServletBean。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void init() throws ServletException &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Initializing servlet &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Set bean properties from init parameters.</span><br><span class="line">    try &#123;</span><br><span class="line">        //获得web.xml中的contextConfigLocation配置属性，就是spring MVC的配置文件</span><br><span class="line">        PropertyValues pvs = new ServletConfigPropertyValues(getServletConfig(), this.requiredProperties);</span><br><span class="line">        BeanWrapper bw = PropertyAccessorFactory.forBeanPropertyAccess(this);</span><br><span class="line">        //获取服务器的各种信息</span><br><span class="line">        ResourceLoader resourceLoader = new ServletContextResourceLoader(getServletContext());</span><br><span class="line">        bw.registerCustomEditor(Resource.class, new ResourceEditor(resourceLoader, getEnvironment()));</span><br><span class="line">        //待子类覆盖</span><br><span class="line">        initBeanWrapper(bw);</span><br><span class="line">        //将配置的初始化值设置到DispatcherServlet中</span><br><span class="line">        bw.setPropertyValues(pvs, true);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (BeansException ex) &#123;</span><br><span class="line">        logger.error(&quot;Failed to set bean properties on servlet &apos;&quot; + getServletName() + &quot;&apos;&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Let subclasses do whatever initialization they like.</span><br><span class="line">    //初始化ioc容器</span><br><span class="line">    initServletBean();</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Servlet &apos;&quot; + getServletName() + &quot;&apos; configured successfully&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、FrameworkServlet的initServletBean方法"><a href="#2、FrameworkServlet的initServletBean方法" class="headerlink" title="2、FrameworkServlet的initServletBean方法"></a>2、FrameworkServlet的initServletBean方法</h4><p>DispatcherServlet的父类FrameworkServlet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void initServletBean() throws ServletException &#123;</span><br><span class="line">    getServletContext().log(&quot;Initializing Spring FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">    if (this.logger.isInfoEnabled()) &#123;</span><br><span class="line">        this.logger.info(&quot;FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;: initialization started&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //初始化IOC容器</span><br><span class="line">        this.webApplicationContext = initWebApplicationContext();</span><br><span class="line">        //带子类实现</span><br><span class="line">        initFrameworkServlet();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ServletException ex) &#123;</span><br><span class="line">        this.logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (RuntimeException ex) &#123;</span><br><span class="line">        this.logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.logger.isInfoEnabled()) &#123;</span><br><span class="line">        long elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">        this.logger.info(&quot;FrameworkServlet &apos;&quot; + getServletName() + &quot;&apos;: initialization completed in &quot; +</span><br><span class="line">                elapsedTime + &quot; ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、FrameworkServlet的initWebApplicationContext方法"><a href="#3、FrameworkServlet的initWebApplicationContext方法" class="headerlink" title="3、FrameworkServlet的initWebApplicationContext方法"></a>3、FrameworkServlet的initWebApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">protected WebApplicationContext initWebApplicationContext() &#123;</span><br><span class="line">    //获取由ContextLoaderListener初始化并注册在ServletContext中的根IOC容器</span><br><span class="line">    WebApplicationContext rootContext =</span><br><span class="line">            WebApplicationContextUtils.getWebApplicationContext(getServletContext());</span><br><span class="line">    WebApplicationContext wac = null;</span><br><span class="line"></span><br><span class="line">    if (this.webApplicationContext != null) &#123;</span><br><span class="line">        // A context instance was injected at construction time -&gt; use it</span><br><span class="line">        wac = this.webApplicationContext;</span><br><span class="line">        if (wac instanceof ConfigurableWebApplicationContext) &#123;</span><br><span class="line">            ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) wac;</span><br><span class="line">            if (!cwac.isActive()) &#123;</span><br><span class="line">                // The context has not yet been refreshed -&gt; provide services such as</span><br><span class="line">                // setting the parent context, setting the application context id, etc</span><br><span class="line">                if (cwac.getParent() == null) &#123;</span><br><span class="line">                    // The context instance was injected without an explicit parent -&gt; set</span><br><span class="line">                    // the root application context (if any; may be null) as the parent</span><br><span class="line">                    cwac.setParent(rootContext);</span><br><span class="line">                &#125;</span><br><span class="line">                configureAndRefreshWebApplicationContext(cwac);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (wac == null) &#123;</span><br><span class="line">        // No context instance was injected at construction time -&gt; see if one</span><br><span class="line">        // has been registered in the servlet context. If one exists, it is assumed</span><br><span class="line">        // that the parent context (if any) has already been set and that the</span><br><span class="line">        // user has performed any initialization such as setting the context id</span><br><span class="line">        //如果为空，说明该Servlet不是由编程式注册到容器中的，在ServletContext中查找上下文，查找得到  </span><br><span class="line">        //说明上下文已经以别的方式初始化并注册在contextAttribute下，直接使用 </span><br><span class="line">        wac = findWebApplicationContext();</span><br><span class="line">    &#125;</span><br><span class="line">    if (wac == null) &#123;</span><br><span class="line">        // No context instance is defined for this servlet -&gt; create a local one</span><br><span class="line">        //创建ioc容器</span><br><span class="line">        wac = createWebApplicationContext(rootContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.refreshEventReceived) &#123;</span><br><span class="line">        // Either the context is not a ConfigurableApplicationContext with refresh</span><br><span class="line">        // support or the context injected at construction time had already been</span><br><span class="line">        // refreshed -&gt; trigger initial onRefresh manually here.</span><br><span class="line">        //初始化相关属性</span><br><span class="line">        onRefresh(wac);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.publishContext) &#123;</span><br><span class="line">        // Publish the context as a servlet context attribute.</span><br><span class="line">        //IOC容器设置为ServletContext的一个属性</span><br><span class="line">        String attrName = getServletContextAttributeName();</span><br><span class="line">        getServletContext().setAttribute(attrName, wac);</span><br><span class="line">        if (this.logger.isDebugEnabled()) &#123;</span><br><span class="line">            this.logger.debug(&quot;Published WebApplicationContext of servlet &apos;&quot; + getServletName() +</span><br><span class="line">                    &quot;&apos; as ServletContext attribute with name [&quot; + attrName + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return wac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DispatcherServlet的onRefresh方法"><a href="#4、DispatcherServlet的onRefresh方法" class="headerlink" title="4、DispatcherServlet的onRefresh方法"></a>4、DispatcherServlet的onRefresh方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onRefresh(ApplicationContext context) &#123;</span><br><span class="line">    initStrategies(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、DispatcherServlet的initStrategies方法"><a href="#5、DispatcherServlet的initStrategies方法" class="headerlink" title="5、DispatcherServlet的initStrategies方法"></a>5、DispatcherServlet的initStrategies方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void initStrategies(ApplicationContext context) &#123;</span><br><span class="line">    //文件上传解析器,配置文件中CommonsMultipartResolver</span><br><span class="line">    initMultipartResolver(context);</span><br><span class="line">    //本地化解析器,默认AcceptHeaderLocaleResolver</span><br><span class="line">    initLocaleResolver(context);</span><br><span class="line">    //主题解析器,默认FixedThemeResolver</span><br><span class="line">    initThemeResolver(context);</span><br><span class="line">    //HandlerMapping，将请求映射到处理器 </span><br><span class="line">    initHandlerMappings(context);</span><br><span class="line">    //HandlerAdapter支持多种类型的处理器 </span><br><span class="line">    initHandlerAdapters(context);</span><br><span class="line">    //HandlerExceptionResolver来解析执行过程中的遇到异常</span><br><span class="line">    initHandlerExceptionResolvers(context);</span><br><span class="line">    //解析请求到视图名,默认DefaultRequestToViewNameTranslator  </span><br><span class="line">    initRequestToViewNameTranslator(context);</span><br><span class="line">    //viewResolver解析逻辑视图到具体视图,默认InternalResourceViewResolver</span><br><span class="line">    initViewResolvers(context);</span><br><span class="line">    //flash映射管理器,默认SessionFlashMapManager</span><br><span class="line">    initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从配置文件DispatcherServlet.properties中获取默认的处理器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.servlet.LocaleResolver=org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ThemeResolver=org.springframework.web.servlet.theme.FixedThemeResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerMapping=org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping,\</span><br><span class="line">    org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerAdapter=org.springframework.web.servlet.mvc.HttpRequestHandlerAdapter,\</span><br><span class="line">    org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter,\</span><br><span class="line">    org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.HandlerExceptionResolver=org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerExceptionResolver,\</span><br><span class="line">    org.springframework.web.servlet.mvc.annotation.ResponseStatusExceptionResolver,\</span><br><span class="line">    org.springframework.web.servlet.mvc.support.DefaultHandlerExceptionResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.RequestToViewNameTranslator=org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.ViewResolver=org.springframework.web.servlet.view.InternalResourceViewResolver</span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.FlashMapManager=org.springframework.web.servlet.support.SessionFlashMapManager</span><br></pre></td></tr></table></figure></p>
<h4 id="6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法"><a href="#6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法" class="headerlink" title="6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法"></a>6、ContentNegotiationManagerFactoryBean的afterPropertiesSet方法</h4><p>ContentNegotiationManagerFactoryBean实现了InitializingBean接口，加载bean会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    List&lt;ContentNegotiationStrategy&gt; strategies = new ArrayList&lt;ContentNegotiationStrategy&gt;();</span><br><span class="line"></span><br><span class="line">    if (this.favorPathExtension) &#123;</span><br><span class="line">        PathExtensionContentNegotiationStrategy strategy;</span><br><span class="line">        if (this.servletContext != null) &#123;</span><br><span class="line">            //使用ServletContext.getMIMEType来匹配MediaType</span><br><span class="line">            strategy = new ServletPathExtensionContentNegotiationStrategy(this.servletContext, this.mediaTypes);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //根据请求路径的后缀名来判断用哪种MediaType</span><br><span class="line">            //常见的xx.html，xx.json,里的.html,.json都是已知的路径扩展名</span><br><span class="line">            strategy = new PathExtensionContentNegotiationStrategy(this.mediaTypes);</span><br><span class="line">        &#125;</span><br><span class="line">        //默认忽略未知的路径扩展名</span><br><span class="line">        strategy.setIgnoreUnknownExtensions(this.ignoreUnknownPathExtensions);</span><br><span class="line">        if (this.useJaf != null) &#123;</span><br><span class="line">            strategy.setUseJaf(this.useJaf);</span><br><span class="line">        &#125;</span><br><span class="line">        strategies.add(strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.favorParameter) &#123;</span><br><span class="line">        //根据request中的参数来判断mediaType的类型</span><br><span class="line">        //示例http://xxx.xxx.com/xx?format=json</span><br><span class="line">        ParameterContentNegotiationStrategy strategy = new ParameterContentNegotiationStrategy(this.mediaTypes);</span><br><span class="line">        //默认的参数名为format</span><br><span class="line">        strategy.setParameterName(this.parameterName);</span><br><span class="line">        strategies.add(strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!this.ignoreAcceptHeader) &#123;</span><br><span class="line">        //从request中取出Accept对应的字段，将其解析包装成MeidaType</span><br><span class="line">        strategies.add(new HeaderContentNegotiationStrategy());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(this.defaultNegotiationStrategy != null) &#123;</span><br><span class="line">        strategies.add(defaultNegotiationStrategy);</span><br><span class="line">    &#125;</span><br><span class="line">    this.contentNegotiationManager = new ContentNegotiationManager(strategies);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="7、接（二、5）ApplicationObjectSupport的setApplicationContext方法"><a href="#7、接（二、5）ApplicationObjectSupport的setApplicationContext方法" class="headerlink" title="7、接（二、5）ApplicationObjectSupport的setApplicationContext方法"></a>7、接（二、5）ApplicationObjectSupport的setApplicationContext方法</h4><p>RequestMappingHandlerMapping的父类，实现了ApplicationContextAware,加载bean时会执行setApplicationContext方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void setApplicationContext(ApplicationContext context) throws BeansException &#123;</span><br><span class="line">    if (context == null &amp;&amp; !isContextRequired()) &#123;</span><br><span class="line">        // Reset internal context state.</span><br><span class="line">        this.applicationContext = null;</span><br><span class="line">        this.messageSourceAccessor = null;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (this.applicationContext == null) &#123;</span><br><span class="line">        // Initialize with passed-in context.</span><br><span class="line">        if (!requiredContextClass().isInstance(context)) &#123;</span><br><span class="line">            throw new ApplicationContextException(</span><br><span class="line">                    &quot;Invalid application context: needs to be of type [&quot; + requiredContextClass().getName() + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        this.applicationContext = context;</span><br><span class="line">        this.messageSourceAccessor = new MessageSourceAccessor(context);</span><br><span class="line">        //初始化</span><br><span class="line">        initApplicationContext(context);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Ignore reinitialization if same context passed in.</span><br><span class="line">        if (this.applicationContext != context) &#123;</span><br><span class="line">            throw new ApplicationContextException(</span><br><span class="line">                    &quot;Cannot reinitialize with different application context: current one is [&quot; +</span><br><span class="line">                    this.applicationContext + &quot;], passed-in one is [&quot; + context + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="8、AbstractHandlerMapping的initApplicationContext方法"><a href="#8、AbstractHandlerMapping的initApplicationContext方法" class="headerlink" title="8、AbstractHandlerMapping的initApplicationContext方法"></a>8、AbstractHandlerMapping的initApplicationContext方法</h4><p>RequestMappingHandlerMapping的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void initApplicationContext() throws BeansException &#123;</span><br><span class="line">    //待子类实现</span><br><span class="line">    extendInterceptors(this.interceptors);</span><br><span class="line">    //获取ioc容器中注册的MappedInterceptor拦截器，加入mappedInterceptors集合</span><br><span class="line">    detectMappedInterceptors(this.mappedInterceptors);</span><br><span class="line">    //分类interceptors并加入集合</span><br><span class="line">    initInterceptors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="9、RequestMappingHandlerMapping的afterPropertiesSet方法"><a href="#9、RequestMappingHandlerMapping的afterPropertiesSet方法" class="headerlink" title="9、RequestMappingHandlerMapping的afterPropertiesSet方法"></a>9、RequestMappingHandlerMapping的afterPropertiesSet方法</h4><p>RequestMappingHandlerMapping实现了InitializingBean接口，加载bean会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    if (this.useRegisteredSuffixPatternMatch) &#123;</span><br><span class="line">        //默认为PathExtensionContentNegotiationStrategy</span><br><span class="line">        this.fileExtensions.addAll(this.contentNegotiationManager.getAllFileExtensions());</span><br><span class="line">    &#125;</span><br><span class="line">    super.afterPropertiesSet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="10、AbstractHandlerMethodMapping的afterPropertiesSet方法"><a href="#10、AbstractHandlerMethodMapping的afterPropertiesSet方法" class="headerlink" title="10、AbstractHandlerMethodMapping的afterPropertiesSet方法"></a>10、AbstractHandlerMethodMapping的afterPropertiesSet方法</h4><p>RequestMappingHandlerMapping的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    initHandlerMethods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="11、AbstractHandlerMethodMapping的initHandlerMethods方法"><a href="#11、AbstractHandlerMethodMapping的initHandlerMethods方法" class="headerlink" title="11、AbstractHandlerMethodMapping的initHandlerMethods方法"></a>11、AbstractHandlerMethodMapping的initHandlerMethods方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protected void initHandlerMethods() &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Looking for request mappings in application context: &quot; + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    //获取容器中注册的所有的beanName</span><br><span class="line">    String[] beanNames = (this.detectHandlerMethodsInAncestorContexts ?</span><br><span class="line">            BeanFactoryUtils.beanNamesForTypeIncludingAncestors(getApplicationContext(), Object.class) :</span><br><span class="line">            getApplicationContext().getBeanNamesForType(Object.class));</span><br><span class="line"></span><br><span class="line">    for (String beanName : beanNames) &#123;</span><br><span class="line">        //该类不是scoped代理且有@Controller或@RequestMapping注解</span><br><span class="line">        if (!beanName.startsWith(SCOPED_TARGET_NAME_PREFIX) &amp;&amp;</span><br><span class="line">                isHandler(getApplicationContext().getType(beanName)))&#123;</span><br><span class="line">            //查找并注册类中注解了@RequestMapping的方法</span><br><span class="line">            detectHandlerMethods(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //待子类实现</span><br><span class="line">    handlerMethodsInitialized(getHandlerMethods());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、AbstractHandlerMethodMapping的initHandlerMethods方法"><a href="#12、AbstractHandlerMethodMapping的initHandlerMethods方法" class="headerlink" title="12、AbstractHandlerMethodMapping的initHandlerMethods方法"></a>12、AbstractHandlerMethodMapping的initHandlerMethods方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">protected void detectHandlerMethods(final Object handler) &#123;</span><br><span class="line">    //获取类</span><br><span class="line">    Class&lt;?&gt; handlerType =</span><br><span class="line">            (handler instanceof String ? getApplicationContext().getType((String) handler) : handler.getClass());</span><br><span class="line"></span><br><span class="line">    // Avoid repeated calls to getMappingForMethod which would rebuild RequestMappingInfo instances</span><br><span class="line">    //该集合key可以相等，但不能为同一对象</span><br><span class="line">    final Map&lt;Method, T&gt; mappings = new IdentityHashMap&lt;Method, T&gt;();</span><br><span class="line"></span><br><span class="line">    //如果是CGLIB代理类，获取父类</span><br><span class="line">    final Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line">    //查找类中注解了@RequestMapping的方法</span><br><span class="line">    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, new MethodFilter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean matches(Method method) &#123;</span><br><span class="line">            //获取方法的@RequestMapping相关信息</span><br><span class="line">            T mapping = getMappingForMethod(method, userType);</span><br><span class="line">            if (mapping != null) &#123;</span><br><span class="line">                //加入集合</span><br><span class="line">                mappings.put(method, mapping);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    for (Method method : methods) &#123;</span><br><span class="line">        //</span><br><span class="line">        registerHandlerMethod(handler, method, mappings.get(method));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、AbstractHandlerMethodMapping的initHandlerMethods方法"><a href="#13、AbstractHandlerMethodMapping的initHandlerMethods方法" class="headerlink" title="13、AbstractHandlerMethodMapping的initHandlerMethods方法"></a>13、AbstractHandlerMethodMapping的initHandlerMethods方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">protected void detectHandlerMethods(final Object handler) &#123;</span><br><span class="line">    //获取类</span><br><span class="line">    Class&lt;?&gt; handlerType =</span><br><span class="line">            (handler instanceof String ? getApplicationContext().getType((String) handler) : handler.getClass());</span><br><span class="line"></span><br><span class="line">    // Avoid repeated calls to getMappingForMethod which would rebuild RequestMappingInfo instances</span><br><span class="line">    //该集合key可以相等，但不能为同一对象</span><br><span class="line">    final Map&lt;Method, T&gt; mappings = new IdentityHashMap&lt;Method, T&gt;();</span><br><span class="line"></span><br><span class="line">    //如果是CGLIB代理类，获取父类</span><br><span class="line">    final Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);</span><br><span class="line">    //查找类及其接口中注解了@RequestMapping的方法</span><br><span class="line">    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, new MethodFilter() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean matches(Method method) &#123;</span><br><span class="line">            //获取方法的@RequestMapping相关信息</span><br><span class="line">            T mapping = getMappingForMethod(method, userType);</span><br><span class="line">            if (mapping != null) &#123;</span><br><span class="line">                //加入集合</span><br><span class="line">                mappings.put(method, mapping);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    for (Method method : methods) &#123;</span><br><span class="line">        //注册方法及路径</span><br><span class="line">        registerHandlerMethod(handler, method, mappings.get(method));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、AbstractHandlerMethodMapping的registerHandlerMethod方法"><a href="#14、AbstractHandlerMethodMapping的registerHandlerMethod方法" class="headerlink" title="14、AbstractHandlerMethodMapping的registerHandlerMethod方法"></a>14、AbstractHandlerMethodMapping的registerHandlerMethod方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">protected void registerHandlerMethod(Object handler, Method method, T mapping) &#123;</span><br><span class="line">    //该对象存放处理该路径的bean及方法</span><br><span class="line">    HandlerMethod newHandlerMethod = createHandlerMethod(handler, method);</span><br><span class="line">    HandlerMethod oldHandlerMethod = this.handlerMethods.get(mapping);</span><br><span class="line">    //已注册</span><br><span class="line">    if (oldHandlerMethod != null &amp;&amp; !oldHandlerMethod.equals(newHandlerMethod)) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Ambiguous mapping found. Cannot map &apos;&quot; + newHandlerMethod.getBean() +</span><br><span class="line">                &quot;&apos; bean method \n&quot; + newHandlerMethod + &quot;\nto &quot; + mapping + &quot;: There is already &apos;&quot; +</span><br><span class="line">                oldHandlerMethod.getBean() + &quot;&apos; bean method\n&quot; + oldHandlerMethod + &quot; mapped.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //注册注解信息与方法映射</span><br><span class="line">    this.handlerMethods.put(mapping, newHandlerMethod);</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Mapped \&quot;&quot; + mapping + &quot;\&quot; onto &quot; + newHandlerMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取注解的路径</span><br><span class="line">    Set&lt;String&gt; patterns = getMappingPathPatterns(mapping);</span><br><span class="line">    for (String pattern : patterns) &#123;</span><br><span class="line">        //路径不是表达式</span><br><span class="line">        if (!getPathMatcher().isPattern(pattern)) &#123;</span><br><span class="line">            //添加路径与注解映射</span><br><span class="line">            this.urlMap.add(pattern, mapping);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建方法明与方法映射</span><br><span class="line">    if (this.namingStrategy != null) &#123;</span><br><span class="line">        String name = this.namingStrategy.getName(newHandlerMethod, mapping);</span><br><span class="line">        updateNameMap(name, newHandlerMethod);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法"><a href="#15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法" class="headerlink" title="15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法"></a>15、接（二、5）RequestMappingHandlerAdapter的afterPropertiesSet方法</h4><p>RequestMappingHandlerAdapter实现了InitializingBean接口,加载bean时会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    // Do this first, it may add ResponseBody advice beans</span><br><span class="line">    //处理@ControllerAdvice注解的类</span><br><span class="line">    initControllerAdviceCache();</span><br><span class="line">    //添加默认的参数解析器</span><br><span class="line">    if (this.argumentResolvers == null) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">        this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    //添加默认的initbinder方法参数解析器</span><br><span class="line">    if (this.initBinderArgumentResolvers == null) &#123;</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();</span><br><span class="line">        this.initBinderArgumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    //添加默认返回值解析器</span><br><span class="line">    if (this.returnValueHandlers == null) &#123;</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">        this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="16、RequestMappingHandlerAdapter的initControllerAdviceCache方法"><a href="#16、RequestMappingHandlerAdapter的initControllerAdviceCache方法" class="headerlink" title="16、RequestMappingHandlerAdapter的initControllerAdviceCache方法"></a>16、RequestMappingHandlerAdapter的initControllerAdviceCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private void initControllerAdviceCache() &#123;</span><br><span class="line">    if (getApplicationContext() == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isInfoEnabled()) &#123;</span><br><span class="line">        logger.info(&quot;Looking for @ControllerAdvice: &quot; + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    //查找容器中@ControllerAdvice注解的bean</span><br><span class="line">    List&lt;ControllerAdviceBean&gt; beans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">    OrderComparator.sort(beans);</span><br><span class="line"></span><br><span class="line">    List&lt;Object&gt; responseBodyAdviceBeans = new ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">    for (ControllerAdviceBean bean : beans) &#123;</span><br><span class="line">        //查找类中注解了@ModelAttribut的方法，不能同时注解@RequestMapping</span><br><span class="line">        Set&lt;Method&gt; attrMethods = HandlerMethodSelector.selectMethods(bean.getBeanType(), MODEL_ATTRIBUTE_METHODS);</span><br><span class="line">        if (!attrMethods.isEmpty()) &#123;</span><br><span class="line">            //加入缓存</span><br><span class="line">            this.modelAttributeAdviceCache.put(bean, attrMethods);</span><br><span class="line">            logger.info(&quot;Detected @ModelAttribute methods in &quot; + bean);</span><br><span class="line">        &#125;</span><br><span class="line">        //查找类中注解了@InitBinder的方法</span><br><span class="line">        Set&lt;Method&gt; binderMethods = HandlerMethodSelector.selectMethods(bean.getBeanType(), INIT_BINDER_METHODS);</span><br><span class="line">        if (!binderMethods.isEmpty()) &#123;</span><br><span class="line">            //加入缓存</span><br><span class="line">            this.initBinderAdviceCache.put(bean, binderMethods);</span><br><span class="line">            logger.info(&quot;Detected @InitBinder methods in &quot; + bean);</span><br><span class="line">        &#125;</span><br><span class="line">        //查找类中实现了ResponseBodyAdvice接口的</span><br><span class="line">        if (ResponseBodyAdvice.class.isAssignableFrom(bean.getBeanType())) &#123;</span><br><span class="line">            //加入缓存</span><br><span class="line">            responseBodyAdviceBeans.add(bean);</span><br><span class="line">            logger.info(&quot;Detected ResponseBodyAdvice bean in &quot; + bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!responseBodyAdviceBeans.isEmpty()) &#123;</span><br><span class="line">        this.responseBodyAdvice.addAll(0, responseBodyAdviceBeans);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法"><a href="#17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法" class="headerlink" title="17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法"></a>17、接（二、5）ExceptionHandlerExceptionResolver的afterPropertiesSet方法</h4><p>ExceptionHandlerExceptionResolver实现了InitializingBean接口,加载bean时会执行afterPropertiesSet方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void afterPropertiesSet() &#123;</span><br><span class="line">    // Do this first, it may add ResponseBodyAdvice beans</span><br><span class="line">    //处理@ControllerAdvice注解的类</span><br><span class="line">    initExceptionHandlerAdviceCache();</span><br><span class="line"></span><br><span class="line">    if (this.argumentResolvers == null) &#123;</span><br><span class="line">        //获取默认的参数解析器</span><br><span class="line">        List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">        this.argumentResolvers = new HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">    &#125;</span><br><span class="line">    if (this.returnValueHandlers == null) &#123;</span><br><span class="line">        //获取默认的返回值解析器</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">        this.returnValueHandlers = new HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法"><a href="#18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法" class="headerlink" title="18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法"></a>18、ExceptionHandlerExceptionResolver的initExceptionHandlerAdviceCache方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">private void initExceptionHandlerAdviceCache() &#123;</span><br><span class="line">    if (getApplicationContext() == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Looking for exception mappings: &quot; + getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line">    //查找容器中@ControllerAdvice注解的bean</span><br><span class="line">    List&lt;ControllerAdviceBean&gt; adviceBeans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());</span><br><span class="line">    OrderComparator.sort(adviceBeans);</span><br><span class="line"></span><br><span class="line">    for (ControllerAdviceBean adviceBean : adviceBeans) &#123;</span><br><span class="line">        //获取bean中注解了@ExceptionHandler的方法，并建立该方法处理的异常类和该方法的映射</span><br><span class="line">        ExceptionHandlerMethodResolver resolver = new ExceptionHandlerMethodResolver(adviceBean.getBeanType());</span><br><span class="line">        if (resolver.hasExceptionMappings()) &#123;</span><br><span class="line">            this.exceptionHandlerAdviceCache.put(adviceBean, resolver);</span><br><span class="line">            logger.info(&quot;Detected @ExceptionHandler methods in &quot; + adviceBean);</span><br><span class="line">        &#125;</span><br><span class="line">        //查找类中实现了ResponseBodyAdvice接口的</span><br><span class="line">        if (ResponseBodyAdvice.class.isAssignableFrom(adviceBean.getBeanType())) &#123;</span><br><span class="line">            this.responseBodyAdvice.add(adviceBean);</span><br><span class="line">            logger.info(&quot;Detected ResponseBodyAdvice implementation in &quot; + adviceBean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、DispatcherServlet处理逻辑"><a href="#三、DispatcherServlet处理逻辑" class="headerlink" title="三、DispatcherServlet处理逻辑"></a>三、DispatcherServlet处理逻辑</h3><h4 id="1、FrameworkServlet的doGet、doPost方法"><a href="#1、FrameworkServlet的doGet、doPost方法" class="headerlink" title="1、FrameworkServlet的doGet、doPost方法"></a>1、FrameworkServlet的doGet、doPost方法</h4><p>常用的post和get请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void doGet(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">        throws ServletException, IOException &#123;</span><br><span class="line">    //处理请求</span><br><span class="line">    processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void doPost(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">        throws ServletException, IOException &#123;</span><br><span class="line">    //处理请求</span><br><span class="line">    processRequest(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、FrameworkServlet的processRequest方法"><a href="#2、FrameworkServlet的processRequest方法" class="headerlink" title="2、FrameworkServlet的processRequest方法"></a>2、FrameworkServlet的processRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">protected final void processRequest(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">        throws ServletException, IOException &#123;</span><br><span class="line">    //处理web请求开始时间</span><br><span class="line">    long startTime = System.currentTimeMillis();</span><br><span class="line">    Throwable failureCause = null;</span><br><span class="line">    //获取当前线程中的LocaleContext </span><br><span class="line">    LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();</span><br><span class="line">    //创建本次request的LocaleContext</span><br><span class="line">    LocaleContext localeContext = buildLocaleContext(request);</span><br><span class="line">    //获取当前线程中的RequestAttributes</span><br><span class="line">    RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();</span><br><span class="line">    //创建本次request的ServletRequestAttributes</span><br><span class="line">    ServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);</span><br><span class="line">    //获取request的异步任务管理器WebAsyncManager,不存在则创建一个存入该request</span><br><span class="line">    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    //往asyncManager中添加一个RequestBindingInterceptor</span><br><span class="line">    asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), new RequestBindingInterceptor());</span><br><span class="line">    //localeContext和requestAttributes,绑定到当前线程</span><br><span class="line">    initContextHolders(request, localeContext, requestAttributes);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //进一步处理</span><br><span class="line">        doService(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ServletException ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (IOException ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        failureCause = ex;</span><br><span class="line">        throw new NestedServletException(&quot;Request processing failed&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    finally &#123;</span><br><span class="line">        //把原先的previousLocaleContext、previousAttributes重新绑定当前线程</span><br><span class="line">        resetContextHolders(request, previousLocaleContext, previousAttributes);</span><br><span class="line">        if (requestAttributes != null) &#123;</span><br><span class="line">            //标记请求处理结束</span><br><span class="line">            requestAttributes.requestCompleted();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            if (failureCause != null) &#123;</span><br><span class="line">                this.logger.debug(&quot;Could not complete request&quot;, failureCause);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                    logger.debug(&quot;Leaving response open for concurrent processing&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    this.logger.debug(&quot;Successfully completed request&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //广播请求完成事件</span><br><span class="line">        publishRequestHandledEvent(request, response, startTime, failureCause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、DispatcherServlet的doService方法"><a href="#3、DispatcherServlet的doService方法" class="headerlink" title="3、DispatcherServlet的doService方法"></a>3、DispatcherServlet的doService方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void doService(HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        String resumed = WebAsyncUtils.getAsyncManager(request).hasConcurrentResult() ? &quot; resumed&quot; : &quot;&quot;;</span><br><span class="line">        logger.debug(&quot;DispatcherServlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot; + resumed +</span><br><span class="line">                &quot; processing &quot; + request.getMethod() + &quot; request for [&quot; + getRequestUri(request) + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Keep a snapshot of the request attributes in case of an include,</span><br><span class="line">    // to be able to restore the original attributes after the include.</span><br><span class="line">    //对于IncludeRequest，创建request属性快照</span><br><span class="line">    Map&lt;String, Object&gt; attributesSnapshot = null;</span><br><span class="line">    if (WebUtils.isIncludeRequest(request)) &#123;</span><br><span class="line">        attributesSnapshot = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        Enumeration&lt;?&gt; attrNames = request.getAttributeNames();</span><br><span class="line">        while (attrNames.hasMoreElements()) &#123;</span><br><span class="line">            String attrName = (String) attrNames.nextElement();</span><br><span class="line">            if (this.cleanupAfterInclude || attrName.startsWith(&quot;org.springframework.web.servlet&quot;)) &#123;</span><br><span class="line">                attributesSnapshot.put(attrName, request.getAttribute(attrName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Make framework objects available to handlers and view objects.</span><br><span class="line">    //设置web容器</span><br><span class="line">    request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());</span><br><span class="line">    //设置本地化解析器</span><br><span class="line">    request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);</span><br><span class="line">    //设置样式解析器</span><br><span class="line">    request.setAttribute(THEME_RESOLVER_ATTRIBUTE, this.themeResolver);</span><br><span class="line">    //设置样式资源 </span><br><span class="line">    request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());</span><br><span class="line">    //默认SessionFlashMapManager从Session中取出当前request对应的FlashMap，即重定向的参数</span><br><span class="line">    FlashMap inputFlashMap = this.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">    //添加到request</span><br><span class="line">    if (inputFlashMap != null) &#123;</span><br><span class="line">        request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">    &#125;</span><br><span class="line">    //Flash attributes 在对请求的重定向生效之前被临时存储（通常是在session)中，并且在重定向之后被立即移除</span><br><span class="line">    request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, new FlashMap());</span><br><span class="line">    //FlashMap 被用来管理 flash attributes 而 FlashMapManager 则被用来存储，获取和管理 FlashMap 实体</span><br><span class="line">    request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, this.flashMapManager);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //进一步处理请求</span><br><span class="line">        doDispatch(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        //没有正在处理的异步任务</span><br><span class="line">        if (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            // Restore the original attribute snapshot, in case of an include.</span><br><span class="line">            if (attributesSnapshot != null) &#123;</span><br><span class="line">                //更新request的属性值</span><br><span class="line">                restoreAttributesAfterInclude(request, attributesSnapshot);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DispatcherServlet的doDispatch方法"><a href="#4、DispatcherServlet的doDispatch方法" class="headerlink" title="4、DispatcherServlet的doDispatch方法"></a>4、DispatcherServlet的doDispatch方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    HttpServletRequest processedRequest = request;</span><br><span class="line">    HandlerExecutionChain mappedHandler = null;</span><br><span class="line">    boolean multipartRequestParsed = false;</span><br><span class="line">    //获取request的asyncManager</span><br><span class="line">    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        ModelAndView mv = null;</span><br><span class="line">        Exception dispatchException = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            //判断是否有文件上传,有文件上传request转换为MultipartHttpServletRequest</span><br><span class="line">            processedRequest = checkMultipart(request);</span><br><span class="line">            multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">            // Determine handler for the current request.</span><br><span class="line">            //根据request获取对应的处理器链</span><br><span class="line">            mappedHandler = getHandler(processedRequest);</span><br><span class="line">            if (mappedHandler == null || mappedHandler.getHandler() == null) &#123;</span><br><span class="line">                //没有对应的Handler，通过response返回错误信息</span><br><span class="line">                noHandlerFound(processedRequest, response);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Determine handler adapter for the current request.</span><br><span class="line">            //根据request获取对应的HandlerAdapter</span><br><span class="line">            HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            // Process last-modified header, if supported by the handler.</span><br><span class="line">            //获得HTTP请求方法</span><br><span class="line">            String method = request.getMethod();</span><br><span class="line">            boolean isGet = &quot;GET&quot;.equals(method);</span><br><span class="line">            if (isGet || &quot;HEAD&quot;.equals(method)) &#123;</span><br><span class="line">                long lastModified = ha.getLastModified(request, mappedHandler.getHandler());</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Last-Modified value for [&quot; + getRequestUri(request) + &quot;] is: &quot; + lastModified);</span><br><span class="line">                &#125;</span><br><span class="line">                if (new ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //如果有拦截器的话，会执行拦截器的preHandler方法 </span><br><span class="line">            //如ConversionServiceExposingInterceptor拦截器，会将conversionService对象添加到request中</span><br><span class="line">            if (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Actually invoke the handler.</span><br><span class="line">            //返回ModelAndView  </span><br><span class="line">            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">            if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            //当view为空时，根据request的path设置默认view  </span><br><span class="line">            applyDefaultViewName(request, mv);</span><br><span class="line">            //执行拦截器的postHandle</span><br><span class="line">            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception ex) &#123;</span><br><span class="line">            dispatchException = ex;</span><br><span class="line">        &#125;</span><br><span class="line">        //处理异常、渲染视图</span><br><span class="line">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        //调用拦截器的afterCompletion方法</span><br><span class="line">        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Error err) &#123;</span><br><span class="line">        //调用拦截器的afterCompletion方法</span><br><span class="line">        triggerAfterCompletionWithError(processedRequest, response, mappedHandler, err);</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        //判断是否正在处理异步请求  </span><br><span class="line">        if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">            // Instead of postHandle and afterCompletion</span><br><span class="line">            //调用拦截器的afterConcurrentHandlingStarted方法</span><br><span class="line">            if (mappedHandler != null) &#123;</span><br><span class="line">                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Clean up any resources used by a multipart request.</span><br><span class="line">            //删除上传资源</span><br><span class="line">            if (multipartRequestParsed) &#123;</span><br><span class="line">                cleanupMultipart(processedRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、DispatcherServlet的checkMultipart方法"><a href="#5、DispatcherServlet的checkMultipart方法" class="headerlink" title="5、DispatcherServlet的checkMultipart方法"></a>5、DispatcherServlet的checkMultipart方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">protected HttpServletRequest checkMultipart(HttpServletRequest request) throws MultipartException &#123;</span><br><span class="line">    //有multipartResolver解析器,且request为POST请求、contentType以&quot;multipart/&quot;开头</span><br><span class="line">    if (this.multipartResolver != null &amp;&amp; this.multipartResolver.isMultipart(request)) &#123;</span><br><span class="line">        //request已经转换为MultipartHttpServletRequest</span><br><span class="line">        if (WebUtils.getNativeRequest(request, MultipartHttpServletRequest.class) != null) &#123;</span><br><span class="line">            logger.debug(&quot;Request is already a MultipartHttpServletRequest - if not in a forward, &quot; +</span><br><span class="line">                    &quot;this typically results from an additional MultipartFilter in web.xml&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //request转换MultipartHttpServletRequest出错</span><br><span class="line">        else if (request.getAttribute(WebUtils.ERROR_EXCEPTION_ATTRIBUTE) instanceof MultipartException) &#123;</span><br><span class="line">            logger.debug(&quot;Multipart resolution failed for current request before - &quot; +</span><br><span class="line">                    &quot;skipping re-resolution for undisturbed error rendering&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            //处理request,转换为MultipartHttpServletRequest</span><br><span class="line">            return this.multipartResolver.resolveMultipart(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // If not returned before: return original request.</span><br><span class="line">    return request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、CommonsMultipartResolver的resolveMultipart方法"><a href="#6、CommonsMultipartResolver的resolveMultipart方法" class="headerlink" title="6、CommonsMultipartResolver的resolveMultipart方法"></a>6、CommonsMultipartResolver的resolveMultipart方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public MultipartHttpServletRequest resolveMultipart(final HttpServletRequest request) throws MultipartException &#123;</span><br><span class="line">    Assert.notNull(request, &quot;Request must not be null&quot;);</span><br><span class="line">    //待用到再解析</span><br><span class="line">    if (this.resolveLazily) &#123;</span><br><span class="line">        return new DefaultMultipartHttpServletRequest(request) &#123;</span><br><span class="line">            @Override</span><br><span class="line">            protected void initializeMultipart() &#123;</span><br><span class="line">                MultipartParsingResult parsingResult = parseRequest(request);</span><br><span class="line">                setMultipartFiles(parsingResult.getMultipartFiles());</span><br><span class="line">                setMultipartParameters(parsingResult.getMultipartParameters());</span><br><span class="line">                setMultipartParameterContentTypes(parsingResult.getMultipartParameterContentTypes());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //解析request</span><br><span class="line">        MultipartParsingResult parsingResult = parseRequest(request);</span><br><span class="line">        return new DefaultMultipartHttpServletRequest(request, parsingResult.getMultipartFiles(),</span><br><span class="line">                parsingResult.getMultipartParameters(), parsingResult.getMultipartParameterContentTypes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、CommonsMultipartResolver的parseRequest方法"><a href="#7、CommonsMultipartResolver的parseRequest方法" class="headerlink" title="7、CommonsMultipartResolver的parseRequest方法"></a>7、CommonsMultipartResolver的parseRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected MultipartParsingResult parseRequest(HttpServletRequest request) throws MultipartException &#123;</span><br><span class="line">    //获取编码方式,配置中UTF-8</span><br><span class="line">    String encoding = determineEncoding(request);</span><br><span class="line">    //获取文件上载器，默认ServletFileUpload</span><br><span class="line">    FileUpload fileUpload = prepareFileUpload(encoding);</span><br><span class="line">    try &#123;</span><br><span class="line">        //将multipart/form-data的文件按boundary分割,分别创建FileItem对象</span><br><span class="line">        List&lt;FileItem&gt; fileItems = ((ServletFileUpload) fileUpload).parseRequest(request);</span><br><span class="line">        return parseFileItems(fileItems, encoding);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (FileUploadBase.SizeLimitExceededException ex) &#123;</span><br><span class="line">        throw new MaxUploadSizeExceededException(fileUpload.getSizeMax(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (FileUploadException ex) &#123;</span><br><span class="line">        throw new MultipartException(&quot;Could not parse multipart servlet request&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、CommonsFileUploadSupport的parseFileItems方法"><a href="#8、CommonsFileUploadSupport的parseFileItems方法" class="headerlink" title="8、CommonsFileUploadSupport的parseFileItems方法"></a>8、CommonsFileUploadSupport的parseFileItems方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">protected MultipartParsingResult parseFileItems(List&lt;FileItem&gt; fileItems, String encoding) &#123;</span><br><span class="line">    MultiValueMap&lt;String, MultipartFile&gt; multipartFiles = new LinkedMultiValueMap&lt;String, MultipartFile&gt;();</span><br><span class="line">    Map&lt;String, String[]&gt; multipartParameters = new HashMap&lt;String, String[]&gt;();</span><br><span class="line">    Map&lt;String, String&gt; multipartParameterContentTypes = new HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    // Extract multipart files and multipart parameters.</span><br><span class="line">    for (FileItem fileItem : fileItems) &#123;</span><br><span class="line">        //form字段</span><br><span class="line">        if (fileItem.isFormField()) &#123;</span><br><span class="line">            String value;</span><br><span class="line">            String partEncoding = determineEncoding(fileItem.getContentType(), encoding);</span><br><span class="line">            if (partEncoding != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    //获取字段值</span><br><span class="line">                    value = fileItem.getString(partEncoding);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (UnsupportedEncodingException ex) &#123;</span><br><span class="line">                    if (logger.isWarnEnabled()) &#123;</span><br><span class="line">                        logger.warn(&quot;Could not decode multipart item &apos;&quot; + fileItem.getFieldName() +</span><br><span class="line">                                &quot;&apos; with encoding &apos;&quot; + partEncoding + &quot;&apos;: using platform default&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    value = fileItem.getString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                value = fileItem.getString();</span><br><span class="line">            &#125;</span><br><span class="line">            //字段集合</span><br><span class="line">            String[] curParam = multipartParameters.get(fileItem.getFieldName());</span><br><span class="line">            if (curParam == null) &#123;</span><br><span class="line">                // simple form field</span><br><span class="line">                multipartParameters.put(fileItem.getFieldName(), new String[] &#123;value&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // array of simple form fields</span><br><span class="line">                String[] newParam = StringUtils.addStringToArray(curParam, value);</span><br><span class="line">                multipartParameters.put(fileItem.getFieldName(), newParam);</span><br><span class="line">            &#125;</span><br><span class="line">            //字段类型集合</span><br><span class="line">            multipartParameterContentTypes.put(fileItem.getFieldName(), fileItem.getContentType());</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // multipart file field</span><br><span class="line">            //上传文件</span><br><span class="line">            CommonsMultipartFile file = new CommonsMultipartFile(fileItem);</span><br><span class="line">            //上传文件集合</span><br><span class="line">            multipartFiles.add(file.getName(), file);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Found multipart file [&quot; + file.getName() + &quot;] of size &quot; + file.getSize() +</span><br><span class="line">                        &quot; bytes with original filename [&quot; + file.getOriginalFilename() + &quot;], stored &quot; +</span><br><span class="line">                        file.getStorageDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return new MultipartParsingResult(multipartFiles, multipartParameters, multipartParameterContentTypes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（三、4）DispatcherServlet的getHandler方法"><a href="#9、接（三、4）DispatcherServlet的getHandler方法" class="headerlink" title="9、接（三、4）DispatcherServlet的getHandler方法"></a>9、接（三、4）DispatcherServlet的getHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //配置为RequestMappingHandlerMapping</span><br><span class="line">    for (HandlerMapping hm : this.handlerMappings) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(</span><br><span class="line">                    &quot;Testing handler map [&quot; + hm + &quot;] in DispatcherServlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取处理器链</span><br><span class="line">        HandlerExecutionChain handler = hm.getHandler(request);</span><br><span class="line">        if (handler != null) &#123;</span><br><span class="line">            return handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、AbstractHandlerMapping的getHandler方法"><a href="#10、AbstractHandlerMapping的getHandler方法" class="headerlink" title="10、AbstractHandlerMapping的getHandler方法"></a>10、AbstractHandlerMapping的getHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //获取处理器</span><br><span class="line">    Object handler = getHandlerInternal(request);</span><br><span class="line">    if (handler == null) &#123;</span><br><span class="line">        handler = getDefaultHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    if (handler == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // Bean name or resolved handler?</span><br><span class="line">    if (handler instanceof String) &#123;</span><br><span class="line">        String handlerName = (String) handler;</span><br><span class="line">        handler = getApplicationContext().getBean(handlerName);</span><br><span class="line">    &#125;</span><br><span class="line">    //创建处理器链</span><br><span class="line">    return getHandlerExecutionChain(handler, request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、AbstractHandlerMethodMapping的getHandlerInternal方法"><a href="#11、AbstractHandlerMethodMapping的getHandlerInternal方法" class="headerlink" title="11、AbstractHandlerMethodMapping的getHandlerInternal方法"></a>11、AbstractHandlerMethodMapping的getHandlerInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected HandlerMethod getHandlerInternal(HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //获取request的path</span><br><span class="line">    String lookupPath = getUrlPathHelper().getLookupPathForRequest(request);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Looking up handler method for path &quot; + lookupPath);</span><br><span class="line">    &#125;</span><br><span class="line">    //由path查找handlerMethod</span><br><span class="line">    HandlerMethod handlerMethod = lookupHandlerMethod(lookupPath, request);</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        if (handlerMethod != null) &#123;</span><br><span class="line">            logger.debug(&quot;Returning handler method [&quot; + handlerMethod + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            logger.debug(&quot;Did not find handler method for [&quot; + lookupPath + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建含有bean的handlerMethod</span><br><span class="line">    return (handlerMethod != null ? handlerMethod.createWithResolvedBean() : null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、AbstractHandlerMethodMapping的lookupHandler方法"><a href="#12、AbstractHandlerMethodMapping的lookupHandler方法" class="headerlink" title="12、AbstractHandlerMethodMapping的lookupHandler方法"></a>12、AbstractHandlerMethodMapping的lookupHandler方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerMethod lookupHandlerMethod(String lookupPath, HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    List&lt;Match&gt; matches = new ArrayList&lt;Match&gt;();</span><br><span class="line">    //由path查找注解信息</span><br><span class="line">    List&lt;T&gt; directPathMatches = this.urlMap.get(lookupPath);</span><br><span class="line">    //通过path直接匹配</span><br><span class="line">    if (directPathMatches != null) &#123;</span><br><span class="line">        addMatchingMappings(directPathMatches, matches, request);</span><br><span class="line">    &#125;</span><br><span class="line">    if (matches.isEmpty()) &#123;</span><br><span class="line">        // No choice but to go through all mappings...</span><br><span class="line">        //通过表达式模糊匹配</span><br><span class="line">        addMatchingMappings(this.handlerMethods.keySet(), matches, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!matches.isEmpty()) &#123;</span><br><span class="line">        //比较器</span><br><span class="line">        Comparator&lt;Match&gt; comparator = new MatchComparator(getMappingComparator(request));</span><br><span class="line">        //匹配多个时，排序</span><br><span class="line">        Collections.sort(matches, comparator);</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(&quot;Found &quot; + matches.size() + &quot; matching mapping(s) for [&quot; + lookupPath + &quot;] : &quot; + matches);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取最匹配的</span><br><span class="line">        Match bestMatch = matches.get(0);</span><br><span class="line">        //匹配程度相等</span><br><span class="line">        if (matches.size() &gt; 1) &#123;</span><br><span class="line">            Match secondBestMatch = matches.get(1);</span><br><span class="line">            if (comparator.compare(bestMatch, secondBestMatch) == 0) &#123;</span><br><span class="line">                Method m1 = bestMatch.handlerMethod.getMethod();</span><br><span class="line">                Method m2 = secondBestMatch.handlerMethod.getMethod();</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Ambiguous handler methods mapped for HTTP path &apos;&quot; + request.getRequestURL() + &quot;&apos;: &#123;&quot; +</span><br><span class="line">                        m1 + &quot;, &quot; + m2 + &quot;&#125;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //匹配相关信息设置到request中，包括解析后的@pathvariable参数集合</span><br><span class="line">        handleMatch(bestMatch.mapping, lookupPath, request);</span><br><span class="line">        //返回最匹配的处理方法</span><br><span class="line">        return bestMatch.handlerMethod;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return handleNoMatch(handlerMethods.keySet(), lookupPath, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、AbstractHandlerMethodMapping的addMatchingMappings方法"><a href="#13、AbstractHandlerMethodMapping的addMatchingMappings方法" class="headerlink" title="13、AbstractHandlerMethodMapping的addMatchingMappings方法"></a>13、AbstractHandlerMethodMapping的addMatchingMappings方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void addMatchingMappings(Collection&lt;T&gt; mappings, List&lt;Match&gt; matches, HttpServletRequest request) &#123;</span><br><span class="line">    for (T mapping : mappings) &#123;</span><br><span class="line">        //验证注解的条件与请求是否匹配，比如method、patterns等</span><br><span class="line">        T match = getMatchingMapping(mapping, request);</span><br><span class="line">        if (match != null) &#123;</span><br><span class="line">            //创建注解信息与方法的配对</span><br><span class="line">            matches.add(new Match(match, this.handlerMethods.get(mapping)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法"><a href="#14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法" class="headerlink" title="14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法"></a>14、接（三、10）AbstractHandlerMapping的getHandlerExecutionChain方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerExecutionChain getHandlerExecutionChain(Object handler, HttpServletRequest request) &#123;</span><br><span class="line">    HandlerExecutionChain chain = (handler instanceof HandlerExecutionChain ?</span><br><span class="line">            (HandlerExecutionChain) handler : new HandlerExecutionChain(handler));</span><br><span class="line">    //添加拦截器</span><br><span class="line">    chain.addInterceptors(getAdaptedInterceptors());</span><br><span class="line"></span><br><span class="line">    String lookupPath = this.urlPathHelper.getLookupPathForRequest(request);</span><br><span class="line">    //由路径添加拦截器</span><br><span class="line">    for (MappedInterceptor mappedInterceptor : this.mappedInterceptors) &#123;</span><br><span class="line">        if (mappedInterceptor.matches(lookupPath, this.pathMatcher)) &#123;</span><br><span class="line">            //默认注册ConversionServiceExposingInterceptor拦截器</span><br><span class="line">            chain.addInterceptor(mappedInterceptor.getInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、MappedInterceptor的matches方法"><a href="#15、MappedInterceptor的matches方法" class="headerlink" title="15、MappedInterceptor的matches方法"></a>15、MappedInterceptor的matches方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public boolean matches(String lookupPath, PathMatcher pathMatcher) &#123;</span><br><span class="line">    PathMatcher pathMatcherToUse = (this.pathMatcher != null) ? this.pathMatcher : pathMatcher;</span><br><span class="line">    //排除的path表达式</span><br><span class="line">    if (this.excludePatterns != null) &#123;</span><br><span class="line">        for (String pattern : this.excludePatterns) &#123;</span><br><span class="line">            if (pathMatcherToUse.match(pattern, lookupPath)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //包含的path表达式</span><br><span class="line">    if (this.includePatterns == null) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        for (String pattern : this.includePatterns) &#123;</span><br><span class="line">            if (pathMatcherToUse.match(pattern, lookupPath)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、接（三、4）DispatcherServlet的getHandlerAdapter方法"><a href="#16、接（三、4）DispatcherServlet的getHandlerAdapter方法" class="headerlink" title="16、接（三、4）DispatcherServlet的getHandlerAdapter方法"></a>16、接（三、4）DispatcherServlet的getHandlerAdapter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException &#123;</span><br><span class="line">    //默认配置了RequestMappingHandlerAdapter</span><br><span class="line">    for (HandlerAdapter ha : this.handlerAdapters) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(&quot;Testing handler adapter [&quot; + ha + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //RequestMappingHandlerAdapter处理HandlerMethod类型的handler</span><br><span class="line">        if (ha.supports(handler)) &#123;</span><br><span class="line">            return ha;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    throw new ServletException(&quot;No adapter for handler [&quot; + handler +</span><br><span class="line">            &quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、AbstractHandlerMethodAdapter的supports方法"><a href="#17、AbstractHandlerMethodAdapter的supports方法" class="headerlink" title="17、AbstractHandlerMethodAdapter的supports方法"></a>17、AbstractHandlerMethodAdapter的supports方法</h4><p>RequestMappingHandlerAdapter的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final boolean supports(Object handler) &#123;</span><br><span class="line">    return (handler instanceof HandlerMethod &amp;&amp; supportsInternal((HandlerMethod) handler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="18、接（三、4）AbstractHandlerMethodAdapter的handle方法"><a href="#18、接（三、4）AbstractHandlerMethodAdapter的handle方法" class="headerlink" title="18、接（三、4）AbstractHandlerMethodAdapter的handle方法"></a>18、接（三、4）AbstractHandlerMethodAdapter的handle方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final ModelAndView handle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">    return handleInternal(request, response, (HandlerMethod) handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、RequestMappingHandlerAdapter的handleInternal方法"><a href="#19、RequestMappingHandlerAdapter的handleInternal方法" class="headerlink" title="19、RequestMappingHandlerAdapter的handleInternal方法"></a>19、RequestMappingHandlerAdapter的handleInternal方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView handleInternal(HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123;</span><br><span class="line">    //获取该类的@SessionAttributes注解处理器,并且判断有无该注解信息</span><br><span class="line">    if (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;</span><br><span class="line">        // Always prevent caching in case of session attribute management.</span><br><span class="line">        //通过设置http头，指定过期时间</span><br><span class="line">        checkAndPrepare(request, response, this.cacheSecondsForSessionAttributeHandlers, true);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // Uses configured default cacheSeconds setting.</span><br><span class="line">        checkAndPrepare(request, response, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Execute invokeHandlerMethod in synchronized block if required.</span><br><span class="line">    //执行invokeHandlerMethod时，是否获取session锁</span><br><span class="line">    if (this.synchronizeOnSession) &#123;</span><br><span class="line">        HttpSession session = request.getSession(false);</span><br><span class="line">        if (session != null) &#123;</span><br><span class="line">            Object mutex = WebUtils.getSessionMutex(session);</span><br><span class="line">            synchronized (mutex) &#123;</span><br><span class="line">                return invokeHandleMethod(request, response, handlerMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //进一步处理request</span><br><span class="line">    return invokeHandleMethod(request, response, handlerMethod);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、RequestMappingHandlerAdapter的invokeHandleMethod方法"><a href="#20、RequestMappingHandlerAdapter的invokeHandleMethod方法" class="headerlink" title="20、RequestMappingHandlerAdapter的invokeHandleMethod方法"></a>20、RequestMappingHandlerAdapter的invokeHandleMethod方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">private ModelAndView invokeHandleMethod(HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    ServletWebRequest webRequest = new ServletWebRequest(request, response);</span><br><span class="line">    //获取适用于当前handler的类的@InitBinder注解的方法，创建ServletRequestDataBinderFactory</span><br><span class="line">    WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br><span class="line">    //获取适用于当前handler的类的@ModelAttribute注解的方法，获取缓存的sessionAttributes，创建ModelFactory</span><br><span class="line">    ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br><span class="line">    //创建ServletInvocableHandlerMethod</span><br><span class="line">    ServletInvocableHandlerMethod requestMappingMethod = createRequestMappingMethod(handlerMethod, binderFactory);</span><br><span class="line">    //ModelAndView容器</span><br><span class="line">    ModelAndViewContainer mavContainer = new ModelAndViewContainer();</span><br><span class="line">    //获取request中的FlashMap，加入mavContainer</span><br><span class="line">    mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br><span class="line">    //初始化Model</span><br><span class="line">    modelFactory.initModel(webRequest, mavContainer, requestMappingMethod);</span><br><span class="line">    //请求重定向时忽略model参数</span><br><span class="line">    mavContainer.setIgnoreDefaultModelOnRedirect(this.ignoreDefaultModelOnRedirect);</span><br><span class="line">    //Servlet容器是否支持异步处理请求，返回StandardServletAsyncWebRequest或NoSupportAsyncWebRequest</span><br><span class="line">    AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br><span class="line">    asyncWebRequest.setTimeout(this.asyncRequestTimeout);</span><br><span class="line">    //获取request的asyncManager</span><br><span class="line">    final WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br><span class="line">    //设置异步处理线程池</span><br><span class="line">    asyncManager.setTaskExecutor(this.taskExecutor);</span><br><span class="line">    //设置请求</span><br><span class="line">    asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br><span class="line">    //设置拦截器</span><br><span class="line">    asyncManager.registerCallableInterceptors(this.callableInterceptors);</span><br><span class="line">    asyncManager.registerDeferredResultInterceptors(this.deferredResultInterceptors);</span><br><span class="line">    //有异步请求处理完成</span><br><span class="line">    if (asyncManager.hasConcurrentResult()) &#123;</span><br><span class="line">        //获取处理结果</span><br><span class="line">        Object result = asyncManager.getConcurrentResult();</span><br><span class="line">        //获取处理返回的mavContainer</span><br><span class="line">        mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0];</span><br><span class="line">        //清除ConcurrentResult与ConcurrentResultContext</span><br><span class="line">        asyncManager.clearConcurrentResult();</span><br><span class="line"></span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Found concurrent result value [&quot; + result + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //创建ConcurrentResultHandlerMethod</span><br><span class="line">        requestMappingMethod = requestMappingMethod.wrapConcurrentResult(result);</span><br><span class="line">    &#125;</span><br><span class="line">    //处理请求</span><br><span class="line">    requestMappingMethod.invokeAndHandle(webRequest, mavContainer);</span><br><span class="line">    //正在异步处理请求</span><br><span class="line">    if (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //处理并返回ModelAndView</span><br><span class="line">    return getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、ModelFactory的initModel方法"><a href="#21、ModelFactory的initModel方法" class="headerlink" title="21、ModelFactory的initModel方法"></a>21、ModelFactory的initModel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public void initModel(NativeWebRequest request, ModelAndViewContainer mavContainer, HandlerMethod handlerMethod)</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">    //从request中获取该类的@SessionAttributes注解的且作用域为session属性</span><br><span class="line">    Map&lt;String, ?&gt; sessionAttributes = this.sessionAttributesHandler.retrieveAttributes(request);</span><br><span class="line">    mavContainer.mergeAttributes(sessionAttributes);</span><br><span class="line">    //执行@ModelAttribute注解的方法,将返回值加入model中</span><br><span class="line">    invokeModelAttributeMethods(request, mavContainer);</span><br><span class="line">    //从request中获取方法注解@ModelAttribute的参数,将返回值加入model中</span><br><span class="line">    for (String name : findSessionAttributeArguments(handlerMethod)) &#123;</span><br><span class="line">        if (!mavContainer.containsAttribute(name)) &#123;</span><br><span class="line">            Object value = this.sessionAttributesHandler.retrieveAttribute(request, name);</span><br><span class="line">            if (value == null) &#123;</span><br><span class="line">                throw new HttpSessionRequiredException(&quot;Expected session attribute &apos;&quot; + name + &quot;&apos;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            mavContainer.addAttribute(name, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法"><a href="#22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法" class="headerlink" title="22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法"></a>22、接（三、20）ServletInvocableHandlerMethod的invokeAndHandle方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public void invokeAndHandle(ServletWebRequest webRequest,</span><br><span class="line">        ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception &#123;</span><br><span class="line">    //处理请求</span><br><span class="line">    Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">    //如方法上有@ResponseStatus注解，将注解值放入request或response</span><br><span class="line">    setResponseStatus(webRequest);</span><br><span class="line">    //没有返回值</span><br><span class="line">    if (returnValue == null) &#123;</span><br><span class="line">        if (isRequestNotModified(webRequest) || hasResponseStatus() || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">            //设置请求已被处理完</span><br><span class="line">            mavContainer.setRequestHandled(true);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (StringUtils.hasText(this.responseReason)) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(false);</span><br><span class="line">    try &#123;</span><br><span class="line">        //处理器处理返回值</span><br><span class="line">        this.returnValueHandlers.handleReturnValue(</span><br><span class="line">                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(getReturnValueHandlingErrorMessage(&quot;Error handling return value&quot;, returnValue), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="23、InvocableHandlerMethod的invokeForRequest方法"><a href="#23、InvocableHandlerMethod的invokeForRequest方法" class="headerlink" title="23、InvocableHandlerMethod的invokeForRequest方法"></a>23、InvocableHandlerMethod的invokeForRequest方法</h4><p>ServletInvocableHandlerMethod的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public Object invokeForRequest(NativeWebRequest request, ModelAndViewContainer mavContainer,</span><br><span class="line">        Object... providedArgs) throws Exception &#123;</span><br><span class="line">    //获取并处理方法参数，即Controller方法中的参数  </span><br><span class="line">    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        StringBuilder sb = new StringBuilder(&quot;Invoking [&quot;);</span><br><span class="line">        sb.append(getBeanType().getSimpleName()).append(&quot;.&quot;);</span><br><span class="line">        sb.append(getMethod().getName()).append(&quot;] method with arguments &quot;);</span><br><span class="line">        sb.append(Arrays.asList(args));</span><br><span class="line">        logger.trace(sb.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    //执行Controller中的方法</span><br><span class="line">    Object returnValue = doInvoke(args);</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Method [&quot; + getMethod().getName() + &quot;] returned [&quot; + returnValue + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法"><a href="#24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法" class="headerlink" title="24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法"></a>24、接（三、20）RequestMappingHandlerAdapter的getModelAndView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private ModelAndView getModelAndView(ModelAndViewContainer mavContainer,</span><br><span class="line">        ModelFactory modelFactory, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    //将model中的属性,设置到request中，作用域session，如不存在则往model中添加绑定后的属性值</span><br><span class="line">    modelFactory.updateModel(webRequest, mavContainer);</span><br><span class="line">    if (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    ModelMap model = mavContainer.getModel();</span><br><span class="line">    ModelAndView mav = new ModelAndView(mavContainer.getViewName(), model);</span><br><span class="line">    //设置view</span><br><span class="line">    if (!mavContainer.isViewReference()) &#123;</span><br><span class="line">        mav.setView((View) mavContainer.getView());</span><br><span class="line">    &#125;</span><br><span class="line">    //重定向参数</span><br><span class="line">    if (model instanceof RedirectAttributes) &#123;</span><br><span class="line">        Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br><span class="line">        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        //flashAttributes存入request</span><br><span class="line">        RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">    &#125;</span><br><span class="line">    return mav;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="25、接（三、4）DispatcherServlet的processDispatchResult方法"><a href="#25、接（三、4）DispatcherServlet的processDispatchResult方法" class="headerlink" title="25、接（三、4）DispatcherServlet的processDispatchResult方法"></a>25、接（三、4）DispatcherServlet的processDispatchResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">private void processDispatchResult(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    boolean errorView = false;</span><br><span class="line">    //存在异常</span><br><span class="line">    if (exception != null) &#123;</span><br><span class="line">        //处理ModelAndViewDefiningException</span><br><span class="line">        if (exception instanceof ModelAndViewDefiningException) &#123;</span><br><span class="line">            logger.debug(&quot;ModelAndViewDefiningException encountered&quot;, exception);</span><br><span class="line">            mv = ((ModelAndViewDefiningException) exception).getModelAndView();</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            Object handler = (mappedHandler != null ? mappedHandler.getHandler() : null);</span><br><span class="line">            //处理其他异常</span><br><span class="line">            mv = processHandlerException(request, response, handler, exception);</span><br><span class="line">            errorView = (mv != null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Did the handler return a view to render?</span><br><span class="line">    if (mv != null &amp;&amp; !mv.wasCleared()) &#123;</span><br><span class="line">        //渲染视图</span><br><span class="line">        render(mv, request, response);</span><br><span class="line">        if (errorView) &#123;</span><br><span class="line">            WebUtils.clearErrorRequestAttributes(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Null ModelAndView returned to DispatcherServlet with name &apos;&quot; + getServletName() +</span><br><span class="line">                    &quot;&apos;: assuming HandlerAdapter completed request handling&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) &#123;</span><br><span class="line">        // Concurrent handling started during a forward</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mappedHandler != null) &#123;</span><br><span class="line">        //</span><br><span class="line">        mappedHandler.triggerAfterCompletion(request, response, null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、参数解析器"><a href="#四、参数解析器" class="headerlink" title="四、参数解析器"></a>四、参数解析器</h3><h4 id="1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法"><a href="#1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法" class="headerlink" title="1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法"></a>1、接（二、15）RequestMappingHandlerAdapter的getDefaultArgumentResolvers方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;HandlerMethodArgumentResolver&gt; getDefaultArgumentResolvers() &#123;</span><br><span class="line">    List&lt;HandlerMethodArgumentResolver&gt; resolvers = new ArrayList&lt;HandlerMethodArgumentResolver&gt;();</span><br><span class="line"></span><br><span class="line">    // Annotation-based argument resolution</span><br><span class="line">    //处理注解了@RequestParam的参数或者没有注解的MultipartFile类型的参数</span><br><span class="line">    resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), false));</span><br><span class="line">    //处理注解了@RequestParam的参数</span><br><span class="line">    resolvers.add(new RequestParamMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@PathVariable的参数</span><br><span class="line">    resolvers.add(new PathVariableMethodArgumentResolver());</span><br><span class="line">    //处理注解了@PathVariable的Map类型的参数</span><br><span class="line">    resolvers.add(new PathVariableMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@MatrixVariable的参数</span><br><span class="line">    resolvers.add(new MatrixVariableMethodArgumentResolver());</span><br><span class="line">    //处理注解了@MatrixVariable的Map类型参数</span><br><span class="line">    resolvers.add(new MatrixVariableMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@ModelAttribute的参数</span><br><span class="line">    resolvers.add(new ServletModelAttributeMethodProcessor(false));</span><br><span class="line">    //处理注解了@RequestBody的参数</span><br><span class="line">    resolvers.add(new RequestResponseBodyMethodProcessor(getMessageConverters()));</span><br><span class="line">    //处理注解了@RequestPart的参数或者没有注解的MultipartFile类型的参数或者没有注解的&quot;javax.servlet.http.Part&quot;类型的参数</span><br><span class="line">    resolvers.add(new RequestPartMethodArgumentResolver(getMessageConverters()));</span><br><span class="line">    //处理注解了@RequestHeader的非Map类型的参数</span><br><span class="line">    resolvers.add(new RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">    //处理注解了@RequestHeader的Map类型的参数</span><br><span class="line">    resolvers.add(new RequestHeaderMapMethodArgumentResolver());</span><br><span class="line">    //处理注解了@CookieValue的参数</span><br><span class="line">    resolvers.add(new ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">    //处理注解了@Value的参数</span><br><span class="line">    resolvers.add(new ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line"></span><br><span class="line">    // Type-based argument resolution</span><br><span class="line">    //处理以下类型的参数，如WebRequest、ServletRequest、MultipartRequest、HttpSession、Principal</span><br><span class="line">    //Locale、TimeZone、&quot;java.time.ZoneId&quot;、InputStream、Reader、HttpMethod</span><br><span class="line">    resolvers.add(new ServletRequestMethodArgumentResolver());</span><br><span class="line">    //处理以下类型的参数,如ServletResponse、OutputStream、Writer</span><br><span class="line">    resolvers.add(new ServletResponseMethodArgumentResolver());</span><br><span class="line">    //处理HttpEntity、RequestEntity类型的参数</span><br><span class="line">    resolvers.add(new HttpEntityMethodProcessor(getMessageConverters()));</span><br><span class="line">    //处理RedirectAttributes类型的参数</span><br><span class="line">    resolvers.add(new RedirectAttributesMethodArgumentResolver());</span><br><span class="line">    //处理Model类型的参数</span><br><span class="line">    resolvers.add(new ModelMethodProcessor());</span><br><span class="line">    //处理Map类型的参数</span><br><span class="line">    resolvers.add(new MapMethodProcessor());</span><br><span class="line">    //处理Errors类型的参数</span><br><span class="line">    resolvers.add(new ErrorsMethodArgumentResolver());</span><br><span class="line">    //处理SessionStatus类型的参数</span><br><span class="line">    resolvers.add(new SessionStatusMethodArgumentResolver());</span><br><span class="line">    //处理UriComponentsBuilder类型的参数</span><br><span class="line">    resolvers.add(new UriComponentsBuilderMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">    // Custom arguments</span><br><span class="line">    //自定义的参数处理器</span><br><span class="line">    if (getCustomArgumentResolvers() != null) &#123;</span><br><span class="line">        resolvers.addAll(getCustomArgumentResolvers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Catch-all</span><br><span class="line">    //处理以下类型的参数，如基本数据类型及包装类、枚举类、CharSequence、Number、Date、</span><br><span class="line">    //URI、URL、Locale、Class</span><br><span class="line">    resolvers.add(new RequestParamMethodArgumentResolver(getBeanFactory(), true));</span><br><span class="line">    //处理不是以下类型的参数，如基本数据类型及包装类、枚举类、CharSequence、Number、Date、</span><br><span class="line">    //URI、URL、Locale、Class</span><br><span class="line">    resolvers.add(new ServletModelAttributeMethodProcessor(true));</span><br><span class="line"></span><br><span class="line">    return resolvers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法"><a href="#2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法" class="headerlink" title="2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法"></a>2、接（三、23）InvocableHandlerMethod的getMethodArgumentValues方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private Object[] getMethodArgumentValues(NativeWebRequest request, ModelAndViewContainer mavContainer,</span><br><span class="line">        Object... providedArgs) throws Exception &#123;</span><br><span class="line">    //获取方法参数</span><br><span class="line">    MethodParameter[] parameters = getMethodParameters();</span><br><span class="line">    Object[] args = new Object[parameters.length];</span><br><span class="line">    for (int i = 0; i &lt; parameters.length; i++) &#123;</span><br><span class="line">        MethodParameter parameter = parameters[i];</span><br><span class="line">        parameter.initParameterNameDiscovery(this.parameterNameDiscoverer);</span><br><span class="line">        //获取参数类型</span><br><span class="line">        GenericTypeResolver.resolveParameterType(parameter, getBean().getClass());</span><br><span class="line">        args[i] = resolveProvidedArgument(parameter, providedArgs);</span><br><span class="line">        if (args[i] != null) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //获取参数解析器</span><br><span class="line">        if (this.argumentResolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                //解析参数</span><br><span class="line">                args[i] = this.argumentResolvers.resolveArgument(</span><br><span class="line">                        parameter, mavContainer, request, this.dataBinderFactory);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(getArgumentResolutionErrorMessage(&quot;Error resolving argument&quot;, i), ex);</span><br><span class="line">                &#125;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (args[i] == null) &#123;</span><br><span class="line">            String msg = getArgumentResolutionErrorMessage(&quot;No suitable resolver for argument&quot;, i);</span><br><span class="line">            throw new IllegalStateException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法"><a href="#3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法" class="headerlink" title="3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法"></a>3、AbstractNamedValueMethodArgumentResolver的resolveArgument方法</h4><p>RequestParamMethodArgumentResolver、PathVariableMethodArgumentResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123;</span><br><span class="line">    //获取参数类型</span><br><span class="line">    Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line">    //获取参数名</span><br><span class="line">    NamedValueInfo namedValueInfo = getNamedValueInfo(parameter);</span><br><span class="line">    //获取参数值</span><br><span class="line">    Object arg = resolveName(namedValueInfo.name, parameter, webRequest);</span><br><span class="line">    if (arg == null) &#123;</span><br><span class="line">        //未获取到值，获取注解中的默认值</span><br><span class="line">        if (namedValueInfo.defaultValue != null) &#123;</span><br><span class="line">            arg = resolveDefaultValue(namedValueInfo.defaultValue);</span><br><span class="line">        &#125;</span><br><span class="line">        //Optional允许为null</span><br><span class="line">        else if (namedValueInfo.required &amp;&amp; !parameter.getParameterType().getName().equals(&quot;java.util.Optional&quot;)) &#123;</span><br><span class="line">            handleMissingValue(namedValueInfo.name, parameter);</span><br><span class="line">        &#125;</span><br><span class="line">        //参数值为null</span><br><span class="line">        arg = handleNullValue(namedValueInfo.name, arg, paramType);</span><br><span class="line">    &#125;</span><br><span class="line">    //空字符串,使用默认值</span><br><span class="line">    else if (&quot;&quot;.equals(arg) &amp;&amp; namedValueInfo.defaultValue != null) &#123;</span><br><span class="line">        arg = resolveDefaultValue(namedValueInfo.defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (binderFactory != null) &#123;</span><br><span class="line">        WebDataBinder binder = binderFactory.createBinder(webRequest, null, namedValueInfo.name);</span><br><span class="line">        arg = binder.convertIfNecessary(arg, paramType, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    //空方法，只有PathVariableMethodArgumentResolver覆盖了该方法</span><br><span class="line">    handleResolvedValue(arg, namedValueInfo.name, parameter, mavContainer, webRequest);</span><br><span class="line"></span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法"><a href="#4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法" class="headerlink" title="4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法"></a>4、AbstractNamedValueMethodArgumentResolver的getNamedValueInfo方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    private NamedValueInfo getNamedValueInfo(MethodParameter parameter) &#123;</span><br><span class="line">    NamedValueInfo namedValueInfo = this.namedValueInfoCache.get(parameter);</span><br><span class="line">    if (namedValueInfo == null) &#123;</span><br><span class="line">        //从注解中获取参数名</span><br><span class="line">        namedValueInfo = createNamedValueInfo(parameter);</span><br><span class="line">        //注解中参数名不存在，从参数中获取参数名</span><br><span class="line">        namedValueInfo = updateNamedValueInfo(parameter, namedValueInfo);</span><br><span class="line">        this.namedValueInfoCache.put(parameter, namedValueInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    return namedValueInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法"><a href="#5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法" class="headerlink" title="5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法"></a>5、接（四、3）RequestParamMethodArgumentResolver的resolveArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected Object resolveName(String name, MethodParameter parameter, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    HttpServletRequest servletRequest = webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">    MultipartHttpServletRequest multipartRequest =</span><br><span class="line">            WebUtils.getNativeRequest(servletRequest, MultipartHttpServletRequest.class);</span><br><span class="line">    Object arg;</span><br><span class="line">    //MultipartFile类型的参数</span><br><span class="line">    if (MultipartFile.class.equals(parameter.getParameterType())) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        Assert.notNull(multipartRequest, &quot;Expected MultipartHttpServletRequest: is a MultipartResolver configured?&quot;);</span><br><span class="line">        //从request中获取参数值</span><br><span class="line">        arg = multipartRequest.getFile(name);</span><br><span class="line">    &#125;</span><br><span class="line">    //MultipartFile集合类型的参数</span><br><span class="line">    else if (isMultipartFileCollection(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        Assert.notNull(multipartRequest, &quot;Expected MultipartHttpServletRequest: is a MultipartResolver configured?&quot;);</span><br><span class="line">        //从request中获取参数值</span><br><span class="line">        arg = multipartRequest.getFiles(name);</span><br><span class="line">    &#125;</span><br><span class="line">    //MultipartFile数组类型的参数</span><br><span class="line">    else if (isMultipartFileArray(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        Assert.notNull(multipartRequest, &quot;Expected MultipartHttpServletRequest: is a MultipartResolver configured?&quot;);</span><br><span class="line">        //从request中获取参数值</span><br><span class="line">        List&lt;MultipartFile&gt; multipartFiles = multipartRequest.getFiles(name);</span><br><span class="line">        arg = multipartFiles.toArray(new MultipartFile[multipartFiles.size()]);</span><br><span class="line">    &#125;</span><br><span class="line">    //Part类型的参数</span><br><span class="line">    else if (&quot;javax.servlet.http.Part&quot;.equals(parameter.getParameterType().getName())) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        arg = servletRequest.getPart(name);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (isPartCollection(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        arg = new ArrayList&lt;Object&gt;(servletRequest.getParts());</span><br><span class="line">    &#125;</span><br><span class="line">    else if (isPartArray(parameter)) &#123;</span><br><span class="line">        assertIsMultipartRequest(servletRequest);</span><br><span class="line">        arg = RequestPartResolver.resolvePart(servletRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        arg = null;</span><br><span class="line">        //上传文件</span><br><span class="line">        if (multipartRequest != null) &#123;</span><br><span class="line">            List&lt;MultipartFile&gt; files = multipartRequest.getFiles(name);</span><br><span class="line">            if (!files.isEmpty()) &#123;</span><br><span class="line">                arg = (files.size() == 1 ? files.get(0) : files);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (arg == null) &#123;</span><br><span class="line">            //获取参数值</span><br><span class="line">            String[] paramValues = webRequest.getParameterValues(name);</span><br><span class="line">            if (paramValues != null) &#123;</span><br><span class="line">                arg = (paramValues.length == 1 ? paramValues[0] : paramValues);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法"><a href="#6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法" class="headerlink" title="6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法"></a>6、接（四、3）PathVariableMethodArgumentResolver的resolveArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">protected Object resolveName(String name, MethodParameter parameter, NativeWebRequest request) throws Exception &#123;</span><br><span class="line">    //获取path中的参数</span><br><span class="line">    Map&lt;String, String&gt; uriTemplateVars =</span><br><span class="line">        (Map&lt;String, String&gt;) request.getAttribute(</span><br><span class="line">                HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">    return (uriTemplateVars != null) ? uriTemplateVars.get(name) : null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法"><a href="#7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法" class="headerlink" title="7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法"></a>7、接（四、2）RequestResponseBodyMethodProcessor的resolveArgument方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123;</span><br><span class="line">    //使用消息转换器读取数据</span><br><span class="line">    Object arg = readWithMessageConverters(webRequest, parameter, parameter.getGenericParameterType());</span><br><span class="line">    //获取参数类名，参数为集合则获取集合内类名</span><br><span class="line">    String name = Conventions.getVariableNameForParameter(parameter);</span><br><span class="line">    //创建数据绑定器</span><br><span class="line">    WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line">    if (arg != null) &#123;</span><br><span class="line">        //处理@Validated注解</span><br><span class="line">        validateIfApplicable(binder, parameter);</span><br><span class="line">        if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">            throw new MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加绑定结果</span><br><span class="line">    mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line">    return arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法"><a href="#8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法" class="headerlink" title="8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法"></a>8、接（四、2）ModelAttributeMethodProcessor的resolveArgument方法</h4><p>ServletModelAttributeMethodProcessor的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer,</span><br><span class="line">        NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123;</span><br><span class="line">    //获取参数名</span><br><span class="line">    String name = ModelFactory.getNameForParameter(parameter);</span><br><span class="line">    //获取参数值</span><br><span class="line">    Object attribute = (mavContainer.containsAttribute(name) ?</span><br><span class="line">            mavContainer.getModel().get(name) : createAttribute(name, parameter, binderFactory, webRequest));</span><br><span class="line">    //创建数据绑定器</span><br><span class="line">    WebDataBinder binder = binderFactory.createBinder(webRequest, attribute, name);</span><br><span class="line">    if (binder.getTarget() != null) &#123;</span><br><span class="line">        //将request的请求中的参数值，存入attribute对象中</span><br><span class="line">        bindRequestParameters(binder, webRequest);</span><br><span class="line">        //处理@Validated注解</span><br><span class="line">        validateIfApplicable(binder, parameter);</span><br><span class="line">        if (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">            throw new BindException(binder.getBindingResult());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Add resolved attribute and BindingResult at the end of the model</span><br><span class="line">    //获取绑定后的参数值对象</span><br><span class="line">    Map&lt;String, Object&gt; bindingResultModel = binder.getBindingResult().getModel();</span><br><span class="line">    //清空model</span><br><span class="line">    mavContainer.removeAttributes(bindingResultModel);</span><br><span class="line">    //对象加入model中</span><br><span class="line">    mavContainer.addAllAttributes(bindingResultModel);</span><br><span class="line">    //对象类型转换为参数所需类型</span><br><span class="line">    return binder.convertIfNecessary(binder.getTarget(), parameter.getParameterType(), parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="五、返回值解析器"><a href="#五、返回值解析器" class="headerlink" title="五、返回值解析器"></a>五、返回值解析器</h3><h4 id="1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法"><a href="#1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法" class="headerlink" title="1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法"></a>1、接（二、15）RequestMappingHandlerAdapter的getDefaultReturnValueHandlers方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;HandlerMethodReturnValueHandler&gt; getDefaultReturnValueHandlers() &#123;</span><br><span class="line">    List&lt;HandlerMethodReturnValueHandler&gt; handlers = new ArrayList&lt;HandlerMethodReturnValueHandler&gt;();</span><br><span class="line"></span><br><span class="line">    // Single-purpose return value types</span><br><span class="line">    //处理ModelAndView类型的返回值</span><br><span class="line">    handlers.add(new ModelAndViewMethodReturnValueHandler());</span><br><span class="line">    //处理Model类型的返回值</span><br><span class="line">    handlers.add(new ModelMethodProcessor());</span><br><span class="line">    //处理View类型的返回值</span><br><span class="line">    handlers.add(new ViewMethodReturnValueHandler());</span><br><span class="line">    //处理HttpEntity类型且不是RequestEntity类型的返回值</span><br><span class="line">    handlers.add(new HttpEntityMethodProcessor(</span><br><span class="line">            getMessageConverters(), this.contentNegotiationManager, this.responseBodyAdvice));</span><br><span class="line">    //处理HttpEntity类型的返回值</span><br><span class="line">    handlers.add(new HttpHeadersReturnValueHandler());</span><br><span class="line">    //处理Callable类型的返回值</span><br><span class="line">    handlers.add(new CallableMethodReturnValueHandler());</span><br><span class="line">    //处理DeferredResult类型的返回值</span><br><span class="line">    handlers.add(new DeferredResultMethodReturnValueHandler());</span><br><span class="line">    //处理WebAsyncTask类型的返回值</span><br><span class="line">    handlers.add(new AsyncTaskMethodReturnValueHandler(this.beanFactory));</span><br><span class="line">    //处理ListenableFuture类型的返回值</span><br><span class="line">    handlers.add(new ListenableFutureReturnValueHandler());</span><br><span class="line"></span><br><span class="line">    // Annotation-based return value types</span><br><span class="line">    //处理注解了@ModelAttribute方法的返回值</span><br><span class="line">    handlers.add(new ModelAttributeMethodProcessor(false));</span><br><span class="line">    //处理注解了@ResponseBody方法或注解了@ResponseBody类的方法的返回值</span><br><span class="line">    handlers.add(new RequestResponseBodyMethodProcessor(</span><br><span class="line">            getMessageConverters(), this.contentNegotiationManager, this.responseBodyAdvice));</span><br><span class="line"></span><br><span class="line">    // Multi-purpose return value types</span><br><span class="line">    //处理void及string类型的返回值</span><br><span class="line">    handlers.add(new ViewNameMethodReturnValueHandler());</span><br><span class="line">    //处理Map类型的返回值</span><br><span class="line">    handlers.add(new MapMethodProcessor());</span><br><span class="line"></span><br><span class="line">    // Custom return value types</span><br><span class="line">    //添加自定义处理器</span><br><span class="line">    if (getCustomReturnValueHandlers() != null) &#123;</span><br><span class="line">        handlers.addAll(getCustomReturnValueHandlers());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Catch-all</span><br><span class="line">    if (!CollectionUtils.isEmpty(getModelAndViewResolvers())) &#123;</span><br><span class="line">        handlers.add(new ModelAndViewResolverMethodReturnValueHandler(getModelAndViewResolvers()));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        //处理不是以下类型的返回值，如基本数据类型及包装类、枚举类、CharSequence、Number、Date、</span><br><span class="line">        //URI、URL、Locale、Class</span><br><span class="line">        handlers.add(new ModelAttributeMethodProcessor(true));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return handlers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法"><a href="#2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法" class="headerlink" title="2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法"></a>2、接（三、22）HandlerMethodReturnValueHandlerComposite的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    //获取处理器</span><br><span class="line">    HandlerMethodReturnValueHandler handler = getReturnValueHandler(returnType);</span><br><span class="line">    Assert.notNull(handler, &quot;Unknown return value type [&quot; + returnType.getParameterType().getName() + &quot;]&quot;);</span><br><span class="line">    //处理返回值</span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、ModelAttributeMethodProcessor的handleReturnValue方法"><a href="#3、ModelAttributeMethodProcessor的handleReturnValue方法" class="headerlink" title="3、ModelAttributeMethodProcessor的handleReturnValue方法"></a>3、ModelAttributeMethodProcessor的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    if (returnValue != null) &#123;</span><br><span class="line">        //从@ModelAttribute注解中获取参数名，注解中没有则从类中获取</span><br><span class="line">        String name = ModelFactory.getNameForReturnValue(returnValue, returnType);</span><br><span class="line">        //返回值添加到model中</span><br><span class="line">        mavContainer.addAttribute(name, returnValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法"><a href="#4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法" class="headerlink" title="4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法"></a>4、ModelAndViewMethodReturnValueHandler的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line">    //无返回值，设置处理完成</span><br><span class="line">    if (returnValue == null) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ModelAndView mav = (ModelAndView) returnValue;</span><br><span class="line">    //view为String,view为视图名</span><br><span class="line">    if (mav.isReference()) &#123;</span><br><span class="line">        String viewName = mav.getViewName();</span><br><span class="line">        //添加返回的视图</span><br><span class="line">        mavContainer.setViewName(viewName);</span><br><span class="line">        //是否是重定向</span><br><span class="line">        if (viewName != null &amp;&amp; isRedirectViewName(viewName)) &#123;</span><br><span class="line">            mavContainer.setRedirectModelScenario(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        View view = mav.getView();</span><br><span class="line">        //添加返回的视图</span><br><span class="line">        mavContainer.setView(view);</span><br><span class="line">        //是否是重定向</span><br><span class="line">        if (view instanceof SmartView) &#123;</span><br><span class="line">            if (((SmartView) view).isRedirectView()) &#123;</span><br><span class="line">                mavContainer.setRedirectModelScenario(true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加返回的model</span><br><span class="line">    mavContainer.addAllAttributes(mav.getModel());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、RequestResponseBodyMethodProcessor的handleReturnValue方法"><a href="#5、RequestResponseBodyMethodProcessor的handleReturnValue方法" class="headerlink" title="5、RequestResponseBodyMethodProcessor的handleReturnValue方法"></a>5、RequestResponseBodyMethodProcessor的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span><br><span class="line">        throws IOException, HttpMediaTypeNotAcceptableException &#123;</span><br><span class="line">    //设置处理完成</span><br><span class="line">    mavContainer.setRequestHandled(true);</span><br><span class="line"></span><br><span class="line">    // Try even with null return value. ResponseBodyAdvice could get involved.</span><br><span class="line">    //调用消息转换器，将返回值写入webRequest</span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, webRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="六、处理异常"><a href="#六、处理异常" class="headerlink" title="六、处理异常"></a>六、处理异常</h3><h4 id="1、接（三、25）DispatcherServlet的processHandlerException方法"><a href="#1、接（三、25）DispatcherServlet的processHandlerException方法" class="headerlink" title="1、接（三、25）DispatcherServlet的processHandlerException方法"></a>1、接（三、25）DispatcherServlet的processHandlerException方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected ModelAndView processHandlerException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    // Check registered HandlerExceptionResolvers...</span><br><span class="line">    ModelAndView exMv = null;</span><br><span class="line">    //异常处理器为ExceptionHandlerExceptionResolver、ResponseStatusExceptionResolver、DefaultHandlerExceptionResolver</span><br><span class="line">    for (HandlerExceptionResolver handlerExceptionResolver : this.handlerExceptionResolvers) &#123;</span><br><span class="line">        //处理异常</span><br><span class="line">        exMv = handlerExceptionResolver.resolveException(request, response, handler, ex);</span><br><span class="line">        if (exMv != null) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (exMv != null) &#123;</span><br><span class="line">        //异常处理返回结果为空</span><br><span class="line">        if (exMv.isEmpty()) &#123;</span><br><span class="line">            //直接将异常信息添加到request中</span><br><span class="line">            request.setAttribute(EXCEPTION_ATTRIBUTE, ex);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        // We might still need view name translation for a plain error model...</span><br><span class="line">        //设置默认的view</span><br><span class="line">        if (!exMv.hasView()) &#123;</span><br><span class="line">            exMv.setViewName(getDefaultViewName(request));</span><br><span class="line">        &#125;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Handler execution resulted in exception - forwarding to resolved error view: &quot; + exMv, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        //将异常相关信息添加到request</span><br><span class="line">        WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());</span><br><span class="line">        return exMv;</span><br><span class="line">    &#125;</span><br><span class="line">    throw ex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、AbstractHandlerExceptionResolver的resolveException方法"><a href="#2、AbstractHandlerExceptionResolver的resolveException方法" class="headerlink" title="2、AbstractHandlerExceptionResolver的resolveException方法"></a>2、AbstractHandlerExceptionResolver的resolveException方法</h4><p>ExceptionHandlerExceptionResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line">    //处理器是否使用于该handler</span><br><span class="line">    if (shouldApplyTo(request, handler)) &#123;</span><br><span class="line">        // Log exception, both at debug log level and at warn level, if desired.</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Resolving exception from handler [&quot; + handler + &quot;]: &quot; + ex);</span><br><span class="line">        &#125;</span><br><span class="line">        //打印异常信息</span><br><span class="line">        logException(ex, request);</span><br><span class="line">        //处理response缓存</span><br><span class="line">        prepareResponse(ex, response);</span><br><span class="line">        //处理异常</span><br><span class="line">        return doResolveException(request, response, handler, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、AbstractHandlerMethodExceptionResolver的doResolveException方法"><a href="#3、AbstractHandlerMethodExceptionResolver的doResolveException方法" class="headerlink" title="3、AbstractHandlerMethodExceptionResolver的doResolveException方法"></a>3、AbstractHandlerMethodExceptionResolver的doResolveException方法</h4><p>ExceptionHandlerExceptionResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final ModelAndView doResolveException(</span><br><span class="line">        HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line"></span><br><span class="line">    return doResolveHandlerMethodException(request, response, (HandlerMethod) handler, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法"><a href="#4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法" class="headerlink" title="4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法"></a>4、ExceptionHandlerExceptionResolver的doResolveHandlerMethodException方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView doResolveHandlerMethodException(HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, HandlerMethod handlerMethod, Exception exception) &#123;</span><br><span class="line">    //获取处理异常的方法</span><br><span class="line">    ServletInvocableHandlerMethod exceptionHandlerMethod = getExceptionHandlerMethod(handlerMethod, exception);</span><br><span class="line">    if (exceptionHandlerMethod == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //设置参数解析器</span><br><span class="line">    exceptionHandlerMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);</span><br><span class="line">    //设置返回值解析器</span><br><span class="line">    exceptionHandlerMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers);</span><br><span class="line">    //创建请求</span><br><span class="line">    ServletWebRequest webRequest = new ServletWebRequest(request, response);</span><br><span class="line">    //ModelAndView容器</span><br><span class="line">    ModelAndViewContainer mavContainer = new ModelAndViewContainer();</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Invoking @ExceptionHandler method: &quot; + exceptionHandlerMethod);</span><br><span class="line">        &#125;</span><br><span class="line">        //执行异常处理方法</span><br><span class="line">        exceptionHandlerMethod.invokeAndHandle(webRequest, mavContainer, exception);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception invocationEx) &#123;</span><br><span class="line">        if (logger.isErrorEnabled()) &#123;</span><br><span class="line">            logger.error(&quot;Failed to invoke @ExceptionHandler method: &quot; + exceptionHandlerMethod, invocationEx);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //已处理完成，返回空ModelAndView</span><br><span class="line">    if (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        return new ModelAndView();</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        ModelAndView mav = new ModelAndView().addAllObjects(mavContainer.getModel());</span><br><span class="line">        mav.setViewName(mavContainer.getViewName());</span><br><span class="line">        if (!mavContainer.isViewReference()) &#123;</span><br><span class="line">            mav.setView((View) mavContainer.getView());</span><br><span class="line">        &#125;</span><br><span class="line">        //返回处理后的ModelAndView</span><br><span class="line">        return mav;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、ResponseStatusExceptionResolver的doResolveException方法"><a href="#5、ResponseStatusExceptionResolver的doResolveException方法" class="headerlink" title="5、ResponseStatusExceptionResolver的doResolveException方法"></a>5、ResponseStatusExceptionResolver的doResolveException方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line">    //获取异常类上的@ResponseStatus注解</span><br><span class="line">    ResponseStatus responseStatus = AnnotationUtils.findAnnotation(ex.getClass(), ResponseStatus.class);</span><br><span class="line">    if (responseStatus != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return resolveResponseStatus(responseStatus, request, response, handler, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception resolveEx) &#123;</span><br><span class="line">            logger.warn(&quot;Handling of @ResponseStatus resulted in Exception&quot;, resolveEx);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、ResponseStatusExceptionResolver的resolveResponseStatus方法"><a href="#6、ResponseStatusExceptionResolver的resolveResponseStatus方法" class="headerlink" title="6、ResponseStatusExceptionResolver的resolveResponseStatus方法"></a>6、ResponseStatusExceptionResolver的resolveResponseStatus方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected ModelAndView resolveResponseStatus(ResponseStatus responseStatus, HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;</span><br><span class="line">    //获取http状态码</span><br><span class="line">    int statusCode = responseStatus.value().value();</span><br><span class="line">    //获取reason</span><br><span class="line">    String reason = responseStatus.reason();</span><br><span class="line">    if (this.messageSource != null) &#123;</span><br><span class="line">        reason = this.messageSource.getMessage(reason, null, reason, LocaleContextHolder.getLocale());</span><br><span class="line">    &#125;</span><br><span class="line">    //信息添加到response中</span><br><span class="line">    if (!StringUtils.hasLength(reason)) &#123;</span><br><span class="line">        response.sendError(statusCode);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        response.sendError(statusCode, reason);</span><br><span class="line">    &#125;</span><br><span class="line">    //返回空ModelAndView</span><br><span class="line">    return new ModelAndView();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、DefaultHandlerExceptionResolver的resolveResponseStatus方法"><a href="#7、DefaultHandlerExceptionResolver的resolveResponseStatus方法" class="headerlink" title="7、DefaultHandlerExceptionResolver的resolveResponseStatus方法"></a>7、DefaultHandlerExceptionResolver的resolveResponseStatus方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected ModelAndView doResolveException(HttpServletRequest request, HttpServletResponse response,</span><br><span class="line">        Object handler, Exception ex) &#123;</span><br><span class="line">    //异常信息存入request、response中</span><br><span class="line">    try &#123;</span><br><span class="line">        if (ex instanceof NoSuchRequestHandlingMethodException) &#123;</span><br><span class="line">            return handleNoSuchRequestHandlingMethod((NoSuchRequestHandlingMethodException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpRequestMethodNotSupportedException) &#123;</span><br><span class="line">            return handleHttpRequestMethodNotSupported((HttpRequestMethodNotSupportedException) ex, request,</span><br><span class="line">                    response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMediaTypeNotSupportedException) &#123;</span><br><span class="line">            return handleHttpMediaTypeNotSupported((HttpMediaTypeNotSupportedException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMediaTypeNotAcceptableException) &#123;</span><br><span class="line">            return handleHttpMediaTypeNotAcceptable((HttpMediaTypeNotAcceptableException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof MissingServletRequestParameterException) &#123;</span><br><span class="line">            return handleMissingServletRequestParameter((MissingServletRequestParameterException) ex, request,</span><br><span class="line">                    response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof ServletRequestBindingException) &#123;</span><br><span class="line">            return handleServletRequestBindingException((ServletRequestBindingException) ex, request, response,</span><br><span class="line">                    handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof ConversionNotSupportedException) &#123;</span><br><span class="line">            return handleConversionNotSupported((ConversionNotSupportedException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof TypeMismatchException) &#123;</span><br><span class="line">            return handleTypeMismatch((TypeMismatchException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMessageNotReadableException) &#123;</span><br><span class="line">            return handleHttpMessageNotReadable((HttpMessageNotReadableException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof HttpMessageNotWritableException) &#123;</span><br><span class="line">            return handleHttpMessageNotWritable((HttpMessageNotWritableException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof MethodArgumentNotValidException) &#123;</span><br><span class="line">            return handleMethodArgumentNotValidException((MethodArgumentNotValidException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof MissingServletRequestPartException) &#123;</span><br><span class="line">            return handleMissingServletRequestPartException((MissingServletRequestPartException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof BindException) &#123;</span><br><span class="line">            return handleBindException((BindException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        else if (ex instanceof NoHandlerFoundException) &#123;</span><br><span class="line">            return handleNoHandlerFoundException((NoHandlerFoundException) ex, request, response, handler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception handlerException) &#123;</span><br><span class="line">        logger.warn(&quot;Handling of [&quot; + ex.getClass().getName() + &quot;] resulted in Exception&quot;, handlerException);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="七、视图渲染"><a href="#七、视图渲染" class="headerlink" title="七、视图渲染"></a>七、视图渲染</h3><h4 id="1、接（三、25）DispatcherServlet的render方法"><a href="#1、接（三、25）DispatcherServlet的render方法" class="headerlink" title="1、接（三、25）DispatcherServlet的render方法"></a>1、接（三、25）DispatcherServlet的render方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">protected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    // Determine locale for request and apply it to the response.</span><br><span class="line">    //获取locale</span><br><span class="line">    Locale locale = this.localeResolver.resolveLocale(request);</span><br><span class="line">    response.setLocale(locale);</span><br><span class="line"></span><br><span class="line">    View view;</span><br><span class="line">    if (mv.isReference()) &#123;</span><br><span class="line">        // We need to resolve the view name.</span><br><span class="line">        //根据视图名创建视图</span><br><span class="line">        view = resolveViewName(mv.getViewName(), mv.getModelInternal(), locale, request);</span><br><span class="line">        if (view == null) &#123;</span><br><span class="line">            throw new ServletException(&quot;Could not resolve view with name &apos;&quot; + mv.getViewName() +</span><br><span class="line">                    &quot;&apos; in servlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        // No need to lookup: the ModelAndView object contains the actual View object.</span><br><span class="line">        view = mv.getView();</span><br><span class="line">        if (view == null) &#123;</span><br><span class="line">            throw new ServletException(&quot;ModelAndView [&quot; + mv + &quot;] neither contains a view name nor a &quot; +</span><br><span class="line">                    &quot;View object in servlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Delegate to the View object for rendering.</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Rendering view [&quot; + view + &quot;] in DispatcherServlet with name &apos;&quot; + getServletName() + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        //渲染视图</span><br><span class="line">        view.render(mv.getModelInternal(), request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Error rendering view [&quot; + view + &quot;] in DispatcherServlet with name &apos;&quot; +</span><br><span class="line">                    getServletName() + &quot;&apos;&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、DispatcherServlet的render方法"><a href="#2、DispatcherServlet的render方法" class="headerlink" title="2、DispatcherServlet的render方法"></a>2、DispatcherServlet的render方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected View resolveViewName(String viewName, Map&lt;String, Object&gt; model, Locale locale,</span><br><span class="line">        HttpServletRequest request) throws Exception &#123;</span><br><span class="line">    //配置的视图解析器InternalResourceViewResolver</span><br><span class="line">    for (ViewResolver viewResolver : this.viewResolvers) &#123;</span><br><span class="line">        //解析视图</span><br><span class="line">        View view = viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">        if (view != null) &#123;</span><br><span class="line">            return view;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AbstractCachingViewResolver的resolveViewName方法"><a href="#3、AbstractCachingViewResolver的resolveViewName方法" class="headerlink" title="3、AbstractCachingViewResolver的resolveViewName方法"></a>3、AbstractCachingViewResolver的resolveViewName方法</h4><p>InternalResourceViewResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public View resolveViewName(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    //没有缓存</span><br><span class="line">    if (!isCache()) &#123;</span><br><span class="line">        //创建视图</span><br><span class="line">        return createView(viewName, locale);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Object cacheKey = getCacheKey(viewName, locale);</span><br><span class="line">        View view = this.viewAccessCache.get(cacheKey);</span><br><span class="line">        if (view == null) &#123;</span><br><span class="line">            synchronized (this.viewCreationCache) &#123;</span><br><span class="line">                view = this.viewCreationCache.get(cacheKey);</span><br><span class="line">                if (view == null) &#123;</span><br><span class="line">                    // Ask the subclass to create the View object.</span><br><span class="line">                    view = createView(viewName, locale);</span><br><span class="line">                    if (view == null &amp;&amp; this.cacheUnresolved) &#123;</span><br><span class="line">                        view = UNRESOLVED_VIEW;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (view != null) &#123;</span><br><span class="line">                        this.viewAccessCache.put(cacheKey, view);</span><br><span class="line">                        this.viewCreationCache.put(cacheKey, view);</span><br><span class="line">                        if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                            logger.trace(&quot;Cached view [&quot; + cacheKey + &quot;]&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return (view != UNRESOLVED_VIEW ? view : null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4、UrlBasedViewResolver的createView方法"><a href="#4、UrlBasedViewResolver的createView方法" class="headerlink" title="4、UrlBasedViewResolver的createView方法"></a>4、UrlBasedViewResolver的createView方法</h4><p>InternalResourceViewResolver的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected View createView(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    // If this resolver is not supposed to handle the given view,</span><br><span class="line">    // return null to pass on to the next resolver in the chain.</span><br><span class="line">    //是否查找到该视图</span><br><span class="line">    if (!canHandle(viewName, locale)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // Check for special &quot;redirect:&quot; prefix.</span><br><span class="line">    //请求重定向</span><br><span class="line">    if (viewName.startsWith(REDIRECT_URL_PREFIX)) &#123;</span><br><span class="line">        //获取重定向地址</span><br><span class="line">        String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length());</span><br><span class="line">        //创建重定向视图</span><br><span class="line">        RedirectView view = new RedirectView(redirectUrl, isRedirectContextRelative(), isRedirectHttp10Compatible());</span><br><span class="line">        //使用容器初始化该视图，并返回</span><br><span class="line">        return applyLifecycleMethods(viewName, view);</span><br><span class="line">    &#125;</span><br><span class="line">    // Check for special &quot;forward:&quot; prefix.</span><br><span class="line">    //请求转发</span><br><span class="line">    if (viewName.startsWith(FORWARD_URL_PREFIX)) &#123;</span><br><span class="line">        String forwardUrl = viewName.substring(FORWARD_URL_PREFIX.length());</span><br><span class="line">        //创建转发视图</span><br><span class="line">        return new InternalResourceView(forwardUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    // Else fall back to superclass implementation: calling loadView.</span><br><span class="line">    return super.createView(viewName, locale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5、AbstractCachingViewResolver的createView方法"><a href="#5、AbstractCachingViewResolver的createView方法" class="headerlink" title="5、AbstractCachingViewResolver的createView方法"></a>5、AbstractCachingViewResolver的createView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected View createView(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    return loadView(viewName, locale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、UrlBasedViewResolver的loadView方法"><a href="#6、UrlBasedViewResolver的loadView方法" class="headerlink" title="6、UrlBasedViewResolver的loadView方法"></a>6、UrlBasedViewResolver的loadView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected View loadView(String viewName, Locale locale) throws Exception &#123;</span><br><span class="line">    //创建视图</span><br><span class="line">    AbstractUrlBasedView view = buildView(viewName);</span><br><span class="line">    //使用容器初始化视图</span><br><span class="line">    View result = applyLifecycleMethods(viewName, view);</span><br><span class="line">    return (view.checkResource(locale) ? result : null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、InternalResourceViewResolver的buildView方法"><a href="#7、InternalResourceViewResolver的buildView方法" class="headerlink" title="7、InternalResourceViewResolver的buildView方法"></a>7、InternalResourceViewResolver的buildView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected AbstractUrlBasedView buildView(String viewName) throws Exception &#123;</span><br><span class="line">    InternalResourceView view = (InternalResourceView) super.buildView(viewName);</span><br><span class="line">    //该属性为true，则一致以include方式获取资源</span><br><span class="line">    if (this.alwaysInclude != null) &#123;</span><br><span class="line">        view.setAlwaysInclude(this.alwaysInclude);</span><br><span class="line">    &#125;</span><br><span class="line">    //不允许循环转发</span><br><span class="line">    view.setPreventDispatchLoop(true);</span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、UrlBasedViewResolver的buildView方法"><a href="#8、UrlBasedViewResolver的buildView方法" class="headerlink" title="8、UrlBasedViewResolver的buildView方法"></a>8、UrlBasedViewResolver的buildView方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected AbstractUrlBasedView buildView(String viewName) throws Exception &#123;</span><br><span class="line">    //创建InternalResourceView对象</span><br><span class="line">    AbstractUrlBasedView view = (AbstractUrlBasedView) BeanUtils.instantiateClass(getViewClass());</span><br><span class="line">    //设置视图的路径</span><br><span class="line">    view.setUrl(getPrefix() + viewName + getSuffix());</span><br><span class="line"></span><br><span class="line">    String contentType = getContentType();</span><br><span class="line">    if (contentType != null) &#123;</span><br><span class="line">        view.setContentType(contentType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    view.setRequestContextAttribute(getRequestContextAttribute());</span><br><span class="line">    view.setAttributesMap(getAttributesMap());</span><br><span class="line"></span><br><span class="line">    Boolean exposePathVariables = getExposePathVariables();</span><br><span class="line">    if (exposePathVariables != null) &#123;</span><br><span class="line">        view.setExposePathVariables(exposePathVariables);</span><br><span class="line">    &#125;</span><br><span class="line">    Boolean exposeContextBeansAsAttributes = getExposeContextBeansAsAttributes();</span><br><span class="line">    if (exposeContextBeansAsAttributes != null) &#123;</span><br><span class="line">        view.setExposeContextBeansAsAttributes(exposeContextBeansAsAttributes);</span><br><span class="line">    &#125;</span><br><span class="line">    String[] exposedContextBeanNames = getExposedContextBeanNames();</span><br><span class="line">    if (exposedContextBeanNames != null) &#123;</span><br><span class="line">        view.setExposedContextBeanNames(exposedContextBeanNames);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（七、1）AbstractView的render方法"><a href="#9、接（七、1）AbstractView的render方法" class="headerlink" title="9、接（七、1）AbstractView的render方法"></a>9、接（七、1）AbstractView的render方法</h4><p>InternalResourceView、RedirectView的父类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void render(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        logger.trace(&quot;Rendering view with name &apos;&quot; + this.beanName + &quot;&apos; with model &quot; + model +</span><br><span class="line">            &quot; and static attributes &quot; + this.staticAttributes);</span><br><span class="line">    &#125;</span><br><span class="line">    //合并exposePathVariables、staticAttributes以及model</span><br><span class="line">    Map&lt;String, Object&gt; mergedModel = createMergedOutputModel(model, request, response);</span><br><span class="line">    //设置response头,解决IE bug</span><br><span class="line">    prepareResponse(request, response);</span><br><span class="line">    //</span><br><span class="line">    renderMergedOutputModel(mergedModel, getRequestToExpose(request), response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="10、InternalResourceView的renderMergedOutputModel方法"><a href="#10、InternalResourceView的renderMergedOutputModel方法" class="headerlink" title="10、InternalResourceView的renderMergedOutputModel方法"></a>10、InternalResourceView的renderMergedOutputModel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void renderMergedOutputModel(</span><br><span class="line">        Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    // Expose the model object as request attributes.</span><br><span class="line">    //将model的值添加到request中</span><br><span class="line">    exposeModelAsRequestAttributes(model, request);</span><br><span class="line"></span><br><span class="line">    // Expose helpers as request attributes, if any.</span><br><span class="line">    //空方法待子类实现</span><br><span class="line">    exposeHelpers(request);</span><br><span class="line"></span><br><span class="line">    // Determine the path for the request dispatcher.</span><br><span class="line">    //获取视图的url</span><br><span class="line">    String dispatcherPath = prepareForRendering(request, response);</span><br><span class="line"></span><br><span class="line">    // Obtain a RequestDispatcher for the target resource (typically a JSP).</span><br><span class="line">    //获取请求调度器</span><br><span class="line">    RequestDispatcher rd = getRequestDispatcher(request, dispatcherPath);</span><br><span class="line">    if (rd == null) &#123;</span><br><span class="line">        throw new ServletException(&quot;Could not get RequestDispatcher for [&quot; + getUrl() +</span><br><span class="line">                &quot;]: Check that the corresponding file exists within your web application archive!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If already included or response already committed, perform include, else forward.</span><br><span class="line">    if (useInclude(request, response)) &#123;</span><br><span class="line">        //设置视图的ContentType默认&quot;text/html;charset=ISO-8859-1&quot;</span><br><span class="line">        response.setContentType(getContentType());</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Including resource [&quot; + getUrl() + &quot;] in InternalResourceView &apos;&quot; + getBeanName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //获取包含资源</span><br><span class="line">        rd.include(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else &#123;</span><br><span class="line">        // Note: The forwarded resource is supposed to determine the content type itself.</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(&quot;Forwarding to resource [&quot; + getUrl() + &quot;] in InternalResourceView &apos;&quot; + getBeanName() + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //转发请求</span><br><span class="line">        rd.forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、RedirectView的renderMergedOutputModel方法"><a href="#11、RedirectView的renderMergedOutputModel方法" class="headerlink" title="11、RedirectView的renderMergedOutputModel方法"></a>11、RedirectView的renderMergedOutputModel方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void renderMergedOutputModel(Map&lt;String, Object&gt; model, HttpServletRequest request,</span><br><span class="line">        HttpServletResponse response) throws IOException &#123;</span><br><span class="line">    //获取转发url及参数</span><br><span class="line">    String targetUrl = createTargetUrl(model, request);</span><br><span class="line">    //处理路径中的参数</span><br><span class="line">    targetUrl = updateTargetUrl(targetUrl, model, request, response);</span><br><span class="line">    //获取request中的重定向的参数，即flashAttributes</span><br><span class="line">    FlashMap flashMap = RequestContextUtils.getOutputFlashMap(request);</span><br><span class="line">    if (!CollectionUtils.isEmpty(flashMap)) &#123;</span><br><span class="line">        UriComponents uriComponents = UriComponentsBuilder.fromUriString(targetUrl).build();</span><br><span class="line">        //设置重定向url</span><br><span class="line">        flashMap.setTargetRequestPath(uriComponents.getPath());</span><br><span class="line">        //设置url中的参数</span><br><span class="line">        flashMap.addTargetRequestParams(uriComponents.getQueryParams());</span><br><span class="line">        FlashMapManager flashMapManager = RequestContextUtils.getFlashMapManager(request);</span><br><span class="line">        if (flashMapManager == null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;FlashMapManager not found despite output FlashMap having been set&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        //默认flashMap存入session中</span><br><span class="line">        flashMapManager.saveOutputFlashMap(flashMap, request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    //发送重定向请求</span><br><span class="line">    sendRedirect(request, response, targetUrl, this.http10Compatible);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="八、异步任务"><a href="#八、异步任务" class="headerlink" title="八、异步任务"></a>八、异步任务</h3><h4 id="1、接（三、20）WebAsyncManager的setAsyncWebRequest方法"><a href="#1、接（三、20）WebAsyncManager的setAsyncWebRequest方法" class="headerlink" title="1、接（三、20）WebAsyncManager的setAsyncWebRequest方法"></a>1、接（三、20）WebAsyncManager的setAsyncWebRequest方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void setAsyncWebRequest(final AsyncWebRequest asyncWebRequest) &#123;</span><br><span class="line">    Assert.notNull(asyncWebRequest, &quot;AsyncWebRequest must not be null&quot;);</span><br><span class="line">    Assert.state(!isConcurrentHandlingStarted(), &quot;Can&apos;t set AsyncWebRequest with concurrent handling in progress&quot;);</span><br><span class="line">    this.asyncWebRequest = asyncWebRequest;</span><br><span class="line">    //请求处理完成回调函数，移除request中WebAsyncManager</span><br><span class="line">    this.asyncWebRequest.addCompletionHandler(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            asyncWebRequest.removeAttribute(WebAsyncUtils.WEB_ASYNC_MANAGER_ATTRIBUTE, RequestAttributes.SCOPE_REQUEST);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、接（三-、22）CallableMethodReturnValueHandler的handleReturnValue方法"><a href="#2、接（三-、22）CallableMethodReturnValueHandler的handleReturnValue方法" class="headerlink" title="2、接（三 、22）CallableMethodReturnValueHandler的handleReturnValue方法"></a>2、接（三 、22）CallableMethodReturnValueHandler的handleReturnValue方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void handleReturnValue(Object returnValue, MethodParameter returnType,</span><br><span class="line">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">    if (returnValue == null) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(true);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Callable&lt;?&gt; callable = (Callable&lt;?&gt;) returnValue;</span><br><span class="line">    //处理异步任务</span><br><span class="line">    WebAsyncUtils.getAsyncManager(webRequest).startCallableProcessing(callable, mavContainer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、WebAsyncManager的startCallableProcessing方法"><a href="#3、WebAsyncManager的startCallableProcessing方法" class="headerlink" title="3、WebAsyncManager的startCallableProcessing方法"></a>3、WebAsyncManager的startCallableProcessing方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span><br><span class="line">public void startCallableProcessing(Callable&lt;?&gt; callable, Object... processingContext) throws Exception &#123;</span><br><span class="line">    Assert.notNull(callable, &quot;Callable must not be null&quot;);</span><br><span class="line">    //处理异步任务</span><br><span class="line">    startCallableProcessing(new WebAsyncTask(callable), processingContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public void startCallableProcessing(final WebAsyncTask&lt;?&gt; webAsyncTask, Object... processingContext) throws Exception &#123;</span><br><span class="line">    Assert.notNull(webAsyncTask, &quot;WebAsyncTask must not be null&quot;);</span><br><span class="line">    Assert.state(this.asyncWebRequest != null, &quot;AsyncWebRequest must not be null&quot;);</span><br><span class="line">    //设置超时时间</span><br><span class="line">    Long timeout = webAsyncTask.getTimeout();</span><br><span class="line">    if (timeout != null) &#123;</span><br><span class="line">        this.asyncWebRequest.setTimeout(timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取异步处理线程池</span><br><span class="line">    AsyncTaskExecutor executor = webAsyncTask.getExecutor();</span><br><span class="line">    if (executor != null) &#123;</span><br><span class="line">        this.taskExecutor = executor;</span><br><span class="line">    &#125;</span><br><span class="line">    //添加拦截器</span><br><span class="line">    List&lt;CallableProcessingInterceptor&gt; interceptors = new ArrayList&lt;CallableProcessingInterceptor&gt;();</span><br><span class="line">    interceptors.add(webAsyncTask.getInterceptor());</span><br><span class="line">    interceptors.addAll(this.callableInterceptors.values());</span><br><span class="line">    interceptors.add(timeoutCallableInterceptor);</span><br><span class="line"></span><br><span class="line">    final Callable&lt;?&gt; callable = webAsyncTask.getCallable();</span><br><span class="line">    //创建拦截器链</span><br><span class="line">    final CallableInterceptorChain interceptorChain = new CallableInterceptorChain(interceptors);</span><br><span class="line">    //添加超时回调函数</span><br><span class="line">    this.asyncWebRequest.addTimeoutHandler(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            logger.debug(&quot;Processing timeout&quot;);</span><br><span class="line">            Object result = interceptorChain.triggerAfterTimeout(asyncWebRequest, callable);</span><br><span class="line">            if (result != CallableProcessingInterceptor.RESULT_NONE) &#123;</span><br><span class="line">                setConcurrentResultAndDispatch(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //添加请求处理完成回调函数</span><br><span class="line">    this.asyncWebRequest.addCompletionHandler(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            interceptorChain.triggerAfterCompletion(asyncWebRequest, callable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //执行拦截器的beforeConcurrentHandling方法</span><br><span class="line">    interceptorChain.applyBeforeConcurrentHandling(this.asyncWebRequest, callable);</span><br><span class="line">    //设置开始处理异步任务标识</span><br><span class="line">    startAsyncProcessing(processingContext);</span><br><span class="line"></span><br><span class="line">    this.taskExecutor.submit(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            Object result = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                //执行拦截器preProcess方法</span><br><span class="line">                //如RequestBindingInterceptor，将request的Locale及requestAttributes绑定到当前线程</span><br><span class="line">                interceptorChain.applyPreProcess(asyncWebRequest, callable);</span><br><span class="line">                //执行异步任务</span><br><span class="line">                result = callable.call();</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                result = ex;</span><br><span class="line">            &#125;</span><br><span class="line">            finally &#123;</span><br><span class="line">                //执行拦截器postProcess方法</span><br><span class="line">                //如RequestBindingInterceptor，从当前线程将移除request的Locale及requestAttributes</span><br><span class="line">                result = interceptorChain.applyPostProcess(asyncWebRequest, callable, result);</span><br><span class="line">            &#125;</span><br><span class="line">            //设置处理结果</span><br><span class="line">            setConcurrentResultAndDispatch(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、WebAsyncManager的startCallableProcessing方法"><a href="#4、WebAsyncManager的startCallableProcessing方法" class="headerlink" title="4、WebAsyncManager的startCallableProcessing方法"></a>4、WebAsyncManager的startCallableProcessing方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void startAsyncProcessing(Object[] processingContext) &#123;</span><br><span class="line">    //清除处理结果</span><br><span class="line">    clearConcurrentResult();</span><br><span class="line">    this.concurrentResultContext = processingContext;</span><br><span class="line">    //设置开始处理异步任务标识</span><br><span class="line">    this.asyncWebRequest.startAsync();</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        HttpServletRequest request = this.asyncWebRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">        String requestUri = urlPathHelper.getRequestUri(request);</span><br><span class="line">        logger.debug(&quot;Concurrent handling starting for &quot; + request.getMethod() + &quot; [&quot; + requestUri + &quot;]&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、StandardServletAsyncWebRequest的startAsync方法"><a href="#5、StandardServletAsyncWebRequest的startAsync方法" class="headerlink" title="5、StandardServletAsyncWebRequest的startAsync方法"></a>5、StandardServletAsyncWebRequest的startAsync方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void startAsync() &#123;</span><br><span class="line">    Assert.state(getRequest().isAsyncSupported(),</span><br><span class="line">            &quot;Async support must be enabled on a servlet and for all filters involved &quot; +</span><br><span class="line">            &quot;in async request processing. This is done in Java code using the Servlet API &quot; +</span><br><span class="line">            &quot;or by adding \&quot;&lt;async-supported&gt;true&lt;/async-supported&gt;\&quot; to servlet and &quot; +</span><br><span class="line">            &quot;filter declarations in web.xml.&quot;);</span><br><span class="line">    Assert.state(!isAsyncComplete(), &quot;Async processing has already completed&quot;);</span><br><span class="line"></span><br><span class="line">    if (isAsyncStarted()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建AsyncContextImpl</span><br><span class="line">    this.asyncContext = getRequest().startAsync(getRequest(), getResponse());</span><br><span class="line">    //将StandardServletAsyncWebRequest自身注册为监听器</span><br><span class="line">    this.asyncContext.addListener(this);</span><br><span class="line">    if (this.timeout != null) &#123;</span><br><span class="line">        this.asyncContext.setTimeout(this.timeout);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、WebAsyncManager的setConcurrentResultAndDispatch方法"><a href="#6、WebAsyncManager的setConcurrentResultAndDispatch方法" class="headerlink" title="6、WebAsyncManager的setConcurrentResultAndDispatch方法"></a>6、WebAsyncManager的setConcurrentResultAndDispatch方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private void setConcurrentResultAndDispatch(Object result) &#123;</span><br><span class="line">    synchronized (WebAsyncManager.this) &#123;</span><br><span class="line">        //已处理完成</span><br><span class="line">        if (hasConcurrentResult()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置处理结果</span><br><span class="line">        this.concurrentResult = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.asyncWebRequest.isAsyncComplete()) &#123;</span><br><span class="line">        logger.error(&quot;Could not complete async processing due to timeout or network error&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Concurrent result value [&quot; + this.concurrentResult +</span><br><span class="line">                &quot;] - dispatching request to resume processing&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //再次发起该请求</span><br><span class="line">    this.asyncWebRequest.dispatch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法"><a href="#7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法" class="headerlink" title="7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法"></a>7、接（三、20）ServletInvocableHandlerMethod的wrapConcurrentResult方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ServletInvocableHandlerMethod wrapConcurrentResult(Object result) &#123;</span><br><span class="line">    return new ConcurrentResultHandlerMethod(result, new ConcurrentResultMethodParameter(result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、实例化ConcurrentResultHandlerMethod"><a href="#8、实例化ConcurrentResultHandlerMethod" class="headerlink" title="8、实例化ConcurrentResultHandlerMethod"></a>8、实例化ConcurrentResultHandlerMethod</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public ConcurrentResultHandlerMethod(final Object result, ConcurrentResultMethodParameter returnType) &#123;</span><br><span class="line">    //父类构造器</span><br><span class="line">    super(new Callable&lt;Object&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public Object call() throws Exception &#123;</span><br><span class="line">            if (result instanceof Exception) &#123;</span><br><span class="line">                throw (Exception) result;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (result instanceof Throwable) &#123;</span><br><span class="line">                throw new NestedServletException(&quot;Async processing failed&quot;, (Throwable) result);</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, CALLABLE_METHOD);</span><br><span class="line">    //设置返回值处理器</span><br><span class="line">    setHandlerMethodReturnValueHandlers(ServletInvocableHandlerMethod.this.returnValueHandlers);</span><br><span class="line">    this.returnType = returnType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public ServletInvocableHandlerMethod(Object handler, Method method) &#123;</span><br><span class="line">    //父类构造器</span><br><span class="line">    super(handler, method);</span><br><span class="line">    //获取method的@ResponseStatus注解</span><br><span class="line">    initResponseStatus();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后的invokeAndHandle方法调用的是call()方法</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/chinamhr/chinamhr.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 小远<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>