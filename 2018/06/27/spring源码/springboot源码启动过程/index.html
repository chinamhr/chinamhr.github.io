<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>springboot源码启动过程 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="springboot源码启动过程###demo123456@SpringBootApplicationpublic class Application &amp;#123;    public static void main(String[] args) &amp;#123;        SpringApplication.run(Application.class, args);    &amp;#125;&amp;#12">
<meta property="og:type" content="article">
<meta property="og:title" content="springboot源码启动过程">
<meta property="og:url" content="http://yoursite.com/2018/06/27/spring源码/springboot源码启动过程/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="springboot源码启动过程###demo123456@SpringBootApplicationpublic class Application &amp;#123;    public static void main(String[] args) &amp;#123;        SpringApplication.run(Application.class, args);    &amp;#125;&amp;#12">
<meta property="og:updated_time" content="2018-06-10T12:39:14.567Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="springboot源码启动过程">
<meta name="twitter:description" content="springboot源码启动过程###demo123456@SpringBootApplicationpublic class Application &amp;#123;    public static void main(String[] args) &amp;#123;        SpringApplication.run(Application.class, args);    &amp;#125;&amp;#12">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-spring源码/springboot源码启动过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/27/spring源码/springboot源码启动过程/" class="article-date">
  <time datetime="2018-06-27T13:10:29.012Z" itemprop="datePublished">2018-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      springboot源码启动过程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="springboot源码启动过程"><a href="#springboot源码启动过程" class="headerlink" title="springboot源码启动过程"></a>springboot源码启动过程</h2><p>###demo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class Application &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="一、springboot启动过程"><a href="#一、springboot启动过程" class="headerlink" title="一、springboot启动过程"></a>一、springboot启动过程</h3><h4 id="1、SpringApplication的run方法"><a href="#1、SpringApplication的run方法" class="headerlink" title="1、SpringApplication的run方法"></a>1、SpringApplication的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static ConfigurableApplicationContext run(Class&lt;?&gt; primarySource,</span><br><span class="line">        String... args) &#123;</span><br><span class="line">    return run(new Class&lt;?&gt;[] &#123; primarySource &#125;, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static ConfigurableApplicationContext run(Class&lt;?&gt;[] primarySources,</span><br><span class="line">        String[] args) &#123;</span><br><span class="line">    return new SpringApplication(primarySources).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、实例化SpringApplication"><a href="#2、实例化SpringApplication" class="headerlink" title="2、实例化SpringApplication"></a>2、实例化SpringApplication</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SpringApplication(Class&lt;?&gt;... primarySources) &#123;</span><br><span class="line">    this(null, primarySources);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span><br><span class="line">public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) &#123;</span><br><span class="line">    this.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, &quot;PrimarySources must not be null&quot;);</span><br><span class="line">    //Application类</span><br><span class="line">    this.primarySources = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    //判断应用类型是Standard还是Web</span><br><span class="line">    this.webApplicationType = deduceWebApplicationType();</span><br><span class="line">    //设置初始化器Initializer,从META-INF/spring.factories中获取配置的ApplicationContextInitializer类</span><br><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(</span><br><span class="line">            ApplicationContextInitializer.class));</span><br><span class="line">    //设置监听器Listener,从META-INF/spring.factories中获取配置的ApplicationListener类</span><br><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    //获取应用入口类</span><br><span class="line">    this.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认META-INF/spring.factories<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Application Context Initializers</span><br><span class="line">org.springframework.context.ApplicationContextInitializer=\</span><br><span class="line">org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line">org.springframework.boot.ClearCachesApplicationListener,\</span><br><span class="line">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</span><br><span class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.ConfigFileApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.LoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener</span><br></pre></td></tr></table></figure>
<h4 id="3、SpringApplication的deduceWebApplicationType方法"><a href="#3、SpringApplication的deduceWebApplicationType方法" class="headerlink" title="3、SpringApplication的deduceWebApplicationType方法"></a>3、SpringApplication的deduceWebApplicationType方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private WebApplicationType deduceWebApplicationType() &#123;</span><br><span class="line">    //有org.springframework.web.reactive.DispatcherHandler类</span><br><span class="line">    //且无org.springframework.web.servlet.DispatcherServlet类，则认为是reactive web application</span><br><span class="line">    if (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, null)</span><br><span class="line">            &amp;&amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, null)) &#123;</span><br><span class="line">        return WebApplicationType.REACTIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有javax.servlet.Servlet和org.springframework.web.context.ConfigurableWebApplicationContext类</span><br><span class="line">    //则认为不是web项目   </span><br><span class="line">    for (String className : WEB_ENVIRONMENT_CLASSES) &#123;</span><br><span class="line">        if (!ClassUtils.isPresent(className, null)) &#123;</span><br><span class="line">            return WebApplicationType.NONE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //servlet-based web application</span><br><span class="line">    return WebApplicationType.SERVLET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、接（一、2）SpringApplication的deduceWebApplicationType方法"><a href="#4、接（一、2）SpringApplication的deduceWebApplicationType方法" class="headerlink" title="4、接（一、2）SpringApplication的deduceWebApplicationType方法"></a>4、接（一、2）SpringApplication的deduceWebApplicationType方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void setInitializers(</span><br><span class="line">        Collection&lt;? extends ApplicationContextInitializer&lt;?&gt;&gt; initializers) &#123;</span><br><span class="line">    this.initializers = new ArrayList&lt;&gt;();</span><br><span class="line">    this.initializers.addAll(initializers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、接（一、2）SpringApplication的getSpringFactoriesInstances方法"><a href="#5、接（一、2）SpringApplication的getSpringFactoriesInstances方法" class="headerlink" title="5、接（一、2）SpringApplication的getSpringFactoriesInstances方法"></a>5、接（一、2）SpringApplication的getSpringFactoriesInstances方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private &lt;T&gt; Collection&lt;T&gt; getSpringFactoriesInstances(Class&lt;T&gt; type) &#123;</span><br><span class="line">    //从META-INF/spring.factories中获取配置的type类</span><br><span class="line">    return getSpringFactoriesInstances(type, new Class&lt;?&gt;[] &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private &lt;T&gt; Collection&lt;T&gt; getSpringFactoriesInstances(Class&lt;T&gt; type,</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes, Object... args) &#123;</span><br><span class="line">    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    // Use names and ensure unique to protect against duplicates</span><br><span class="line">    //加载并获取该类</span><br><span class="line">    Set&lt;String&gt; names = new LinkedHashSet&lt;&gt;(</span><br><span class="line">            SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    //实例化names的类</span><br><span class="line">    List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes,</span><br><span class="line">            classLoader, args, names);</span><br><span class="line">    //排序</span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    return instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、接（一、2）SpringApplication的deduceMainApplicationClass方法"><a href="#6、接（一、2）SpringApplication的deduceMainApplicationClass方法" class="headerlink" title="6、接（一、2）SpringApplication的deduceMainApplicationClass方法"></a>6、接（一、2）SpringApplication的deduceMainApplicationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private Class&lt;?&gt; deduceMainApplicationClass() &#123;</span><br><span class="line">    //构造一个运行时异常，通过异常栈中方法名为main的栈帧来得到入口类的名字</span><br><span class="line">    try &#123;</span><br><span class="line">        StackTraceElement[] stackTrace = new RuntimeException().getStackTrace();</span><br><span class="line">        for (StackTraceElement stackTraceElement : stackTrace) &#123;</span><br><span class="line">            if (&quot;main&quot;.equals(stackTraceElement.getMethodName())) &#123;</span><br><span class="line">                return Class.forName(stackTraceElement.getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        // Swallow and continue</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、接（一、1）SpringApplication的run方法"><a href="#7、接（一、1）SpringApplication的run方法" class="headerlink" title="7、接（一、1）SpringApplication的run方法"></a>7、接（一、1）SpringApplication的run方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">    //计时工具</span><br><span class="line">    StopWatch stopWatch = new StopWatch();</span><br><span class="line">    //启动计时器，设置开始时间</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    //容器</span><br><span class="line">    ConfigurableApplicationContext context = null;</span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList&lt;&gt;();</span><br><span class="line">    //设置java.awt.headless系统属性为true - 没有图形化界面</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    //获取SpringApplicationRunListeners</span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    // 广播开始启动事件</span><br><span class="line">    listeners.starting();</span><br><span class="line">    try &#123;</span><br><span class="line">        // 构造一个应用程序参数持有类</span><br><span class="line">        ApplicationArguments applicationArguments = new DefaultApplicationArguments(</span><br><span class="line">                args);</span><br><span class="line">        //根据SpringApplicationRunListeners以及参数来准备环境</span><br><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">                applicationArguments);</span><br><span class="line">        //设置是否跳过搜索BeanInfo类，默认true</span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line">        //准备Banner打印器 - 就是启动Spring Boot的时候打印在console上的ASCII艺术字体</span><br><span class="line">        Banner printedBanner = printBanner(environment);</span><br><span class="line">        //创建Spring容器</span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        //准备异常报告器</span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(</span><br><span class="line">                SpringBootExceptionReporter.class,</span><br><span class="line">                new Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        //Spring容器上下文前置处理</span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">                printedBanner);</span><br><span class="line">        //Spring容器上下文刷新</span><br><span class="line">        refreshContext(context);</span><br><span class="line">        //Spring容器上下文后置处理,默认为空</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        //停止计时器,设置结束时机</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        if (this.logStartupInfo) &#123;</span><br><span class="line">            new StartupInfoLogger(this.mainApplicationClass)</span><br><span class="line">                    .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line">        //广播启动完成事件</span><br><span class="line">        listeners.started(context);</span><br><span class="line">        // 调用Spring容器中的ApplicationRunner和CommandLineRunner接口的实现类</span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">        throw new IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        listeners.running(context);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, null);</span><br><span class="line">        throw new IllegalStateException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    return context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>异常报告器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Error Reporters</span><br><span class="line">org.springframework.boot.SpringBootExceptionReporter=\</span><br><span class="line">org.springframework.boot.diagnostics.FailureAnalyzers</span><br></pre></td></tr></table></figure></p>
<h4 id="8、SpringApplication的getRunListeners方法"><a href="#8、SpringApplication的getRunListeners方法" class="headerlink" title="8、SpringApplication的getRunListeners方法"></a>8、SpringApplication的getRunListeners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private SpringApplicationRunListeners getRunListeners(String[] args) &#123;</span><br><span class="line">    Class&lt;?&gt;[] types = new Class&lt;?&gt;[] &#123; SpringApplication.class, String[].class &#125;;</span><br><span class="line">    //从META-INF/spring.factories中获取配置的SpringApplicationRunListener类,构造SpringApplicationRunListeners</span><br><span class="line">    return new SpringApplicationRunListeners(logger, getSpringFactoriesInstances(</span><br><span class="line">            SpringApplicationRunListener.class, types, this, args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br></pre></td></tr></table></figure>
<h4 id="9、实例化EventPublishingRunListener"><a href="#9、实例化EventPublishingRunListener" class="headerlink" title="9、实例化EventPublishingRunListener"></a>9、实例化EventPublishingRunListener</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public EventPublishingRunListener(SpringApplication application, String[] args) &#123;</span><br><span class="line">    this.application = application;</span><br><span class="line">    this.args = args;</span><br><span class="line">    //事件转发器</span><br><span class="line">    this.initialMulticaster = new SimpleApplicationEventMulticaster();</span><br><span class="line">    //添加监听器</span><br><span class="line">    for (ApplicationListener&lt;?&gt; listener : application.getListeners()) &#123;</span><br><span class="line">        this.initialMulticaster.addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、接（一、7）SpringApplication的getRunListeners方法"><a href="#10、接（一、7）SpringApplication的getRunListeners方法" class="headerlink" title="10、接（一、7）SpringApplication的getRunListeners方法"></a>10、接（一、7）SpringApplication的getRunListeners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void starting() &#123;</span><br><span class="line">    for (SpringApplicationRunListener listener : this.listeners) &#123;</span><br><span class="line">        //默认只有EventPublishingRunListener监听器</span><br><span class="line">        listener.starting();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、EventPublishingRunListener的starting方法"><a href="#11、EventPublishingRunListener的starting方法" class="headerlink" title="11、EventPublishingRunListener的starting方法"></a>11、EventPublishingRunListener的starting方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void starting() &#123;</span><br><span class="line">    //事件转发给相应的监听器</span><br><span class="line">    this.initialMulticaster.multicastEvent(</span><br><span class="line">            new ApplicationStartingEvent(this.application, this.args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、接（一、7）SpringApplication的prepareEnvironment方法"><a href="#12、接（一、7）SpringApplication的prepareEnvironment方法" class="headerlink" title="12、接（一、7）SpringApplication的prepareEnvironment方法"></a>12、接（一、7）SpringApplication的prepareEnvironment方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private ConfigurableEnvironment prepareEnvironment(</span><br><span class="line">        SpringApplicationRunListeners listeners,</span><br><span class="line">        ApplicationArguments applicationArguments) &#123;</span><br><span class="line">    // Create and configure the environment</span><br><span class="line">    ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br><span class="line">    //设置环境</span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    //广播一个准备环境事件</span><br><span class="line">    listeners.environmentPrepared(environment);</span><br><span class="line">    //环境绑定到SpringApplication</span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    if (this.webApplicationType == WebApplicationType.NONE) &#123;</span><br><span class="line">        environment = new EnvironmentConverter(getClassLoader())</span><br><span class="line">                .convertToStandardEnvironmentIfNecessary(environment);</span><br><span class="line">    &#125;</span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    return environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、SpringApplication的getOrCreateEnvironment方法"><a href="#13、SpringApplication的getOrCreateEnvironment方法" class="headerlink" title="13、SpringApplication的getOrCreateEnvironment方法"></a>13、SpringApplication的getOrCreateEnvironment方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private ConfigurableEnvironment getOrCreateEnvironment() &#123;</span><br><span class="line">    if (this.environment != null) &#123;</span><br><span class="line">        return this.environment;</span><br><span class="line">    &#125;</span><br><span class="line">    //SERVLET的环境参数</span><br><span class="line">    if (this.webApplicationType == WebApplicationType.SERVLET) &#123;</span><br><span class="line">        return new StandardServletEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line">    //标准环境参数</span><br><span class="line">    return new StandardEnvironment();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（一、7）SpringApplication的createApplicationContext方法"><a href="#14、接（一、7）SpringApplication的createApplicationContext方法" class="headerlink" title="14、接（一、7）SpringApplication的createApplicationContext方法"></a>14、接（一、7）SpringApplication的createApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableApplicationContext createApplicationContext() &#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = this.applicationContextClass;</span><br><span class="line">    if (contextClass == null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            switch (this.webApplicationType) &#123;</span><br><span class="line">            //用该spring容器AnnotationConfigServletWebServerApplicationContext</span><br><span class="line">            case SERVLET:</span><br><span class="line">                contextClass = Class.forName(DEFAULT_WEB_CONTEXT_CLASS);</span><br><span class="line">                break;</span><br><span class="line">            //用该spring容器AnnotationConfigReactiveWebServerApplicationContext</span><br><span class="line">            case REACTIVE:</span><br><span class="line">                contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">                break;</span><br><span class="line">            //标准spring容器AnnotationConfigApplicationContext</span><br><span class="line">            default:</span><br><span class="line">                contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (ClassNotFoundException ex) &#123;</span><br><span class="line">            throw new IllegalStateException(</span><br><span class="line">                    &quot;Unable create a default ApplicationContext, &quot;</span><br><span class="line">                            + &quot;please specify an ApplicationContextClass&quot;,</span><br><span class="line">                    ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //创建容器对象</span><br><span class="line">    return (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、接（一、7）SpringApplication的prepareContext方法"><a href="#15、接（一、7）SpringApplication的prepareContext方法" class="headerlink" title="15、接（一、7）SpringApplication的prepareContext方法"></a>15、接（一、7）SpringApplication的prepareContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private void prepareContext(ConfigurableApplicationContext context,</span><br><span class="line">        ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span><br><span class="line">        ApplicationArguments applicationArguments, Banner printedBanner) &#123;</span><br><span class="line">    //往容器中设置环境</span><br><span class="line">    context.setEnvironment(environment);</span><br><span class="line">    //配置Bean生成器以及资源加载器</span><br><span class="line">    postProcessApplicationContext(context);</span><br><span class="line">    //应用初始化器</span><br><span class="line">    applyInitializers(context);</span><br><span class="line">    //广播Spring Boot启动过程的contextPrepared事件</span><br><span class="line">    listeners.contextPrepared(context);</span><br><span class="line">    //打印启动信息</span><br><span class="line">    if (this.logStartupInfo) &#123;</span><br><span class="line">        logStartupInfo(context.getParent() == null);</span><br><span class="line">        logStartupProfileInfo(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Add boot specific singleton beans</span><br><span class="line">    // 添加两个Spring Boot中的特殊单例Beans - springApplicationArguments以及springBootBanner</span><br><span class="line">    context.getBeanFactory().registerSingleton(&quot;springApplicationArguments&quot;,</span><br><span class="line">            applicationArguments);</span><br><span class="line">    if (printedBanner != null) &#123;</span><br><span class="line">        context.getBeanFactory().registerSingleton(&quot;springBootBanner&quot;, printedBanner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Load the sources</span><br><span class="line">    // 加载sources 本例中为Application.class</span><br><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">    Assert.notEmpty(sources, &quot;Sources must not be empty&quot;);</span><br><span class="line">    //加载sources中的类，Application.class被解析为AnnotatedGenericBeanDefinition注册到容器中</span><br><span class="line">    load(context, sources.toArray(new Object[0]));</span><br><span class="line">    //广播Spring Boot启动过程的contextLoaded事件</span><br><span class="line">    listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、SpringApplicationRunListeners的postProcessApplicationContext方法"><a href="#16、SpringApplicationRunListeners的postProcessApplicationContext方法" class="headerlink" title="16、SpringApplicationRunListeners的postProcessApplicationContext方法"></a>16、SpringApplicationRunListeners的postProcessApplicationContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">protected void postProcessApplicationContext(ConfigurableApplicationContext context) &#123;</span><br><span class="line">    //注册beanName生成器</span><br><span class="line">    if (this.beanNameGenerator != null) &#123;</span><br><span class="line">        context.getBeanFactory().registerSingleton(</span><br><span class="line">                AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR,</span><br><span class="line">                this.beanNameGenerator);</span><br><span class="line">    &#125;</span><br><span class="line">    //将ApplicationContext中的资源加载器放入容器中</span><br><span class="line">    if (this.resourceLoader != null) &#123;</span><br><span class="line">        if (context instanceof GenericApplicationContext) &#123;</span><br><span class="line">            ((GenericApplicationContext) context)</span><br><span class="line">                    .setResourceLoader(this.resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        if (context instanceof DefaultResourceLoader) &#123;</span><br><span class="line">            ((DefaultResourceLoader) context)</span><br><span class="line">                    .setClassLoader(this.resourceLoader.getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、接（一、7）SpringApplication的refreshContext方法"><a href="#17、接（一、7）SpringApplication的refreshContext方法" class="headerlink" title="17、接（一、7）SpringApplication的refreshContext方法"></a>17、接（一、7）SpringApplication的refreshContext方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private void refreshContext(ConfigurableApplicationContext context) &#123;</span><br><span class="line">    //刷新容器</span><br><span class="line">    refresh(context);</span><br><span class="line">    if (this.registerShutdownHook) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 注册一个关闭容器时的钩子函数</span><br><span class="line">            context.registerShutdownHook();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (AccessControlException ex) &#123;</span><br><span class="line">            // Not allowed in some environments.</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、接（一、7）SpringApplication的callRunners方法"><a href="#18、接（一、7）SpringApplication的callRunners方法" class="headerlink" title="18、接（一、7）SpringApplication的callRunners方法"></a>18、接（一、7）SpringApplication的callRunners方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void callRunners(ApplicationContext context, ApplicationArguments args) &#123;</span><br><span class="line">    List&lt;Object&gt; runners = new ArrayList&lt;&gt;();</span><br><span class="line">    // 找出Spring容器中ApplicationRunner接口的实现类</span><br><span class="line">    runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());</span><br><span class="line">    // 找出Spring容器中CommandLineRunner接口的实现类</span><br><span class="line">    runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());</span><br><span class="line">    // 对runners进行排序</span><br><span class="line">    AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">    // 遍历runners依次执行</span><br><span class="line">    for (Object runner : new LinkedHashSet&lt;&gt;(runners)) &#123;</span><br><span class="line">        if (runner instanceof ApplicationRunner) &#123;</span><br><span class="line">            callRunner((ApplicationRunner) runner, args);</span><br><span class="line">        &#125;</span><br><span class="line">        if (runner instanceof CommandLineRunner) &#123;</span><br><span class="line">            callRunner((CommandLineRunner) runner, args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、AnnotationConfigApplicationContext容器"><a href="#二、AnnotationConfigApplicationContext容器" class="headerlink" title="二、AnnotationConfigApplicationContext容器"></a>二、AnnotationConfigApplicationContext容器</h3><h4 id="1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法"><a href="#1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法" class="headerlink" title="1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法"></a>1、ConfigurationClassPostProcessor的postProcessBeanDefinitionRegistry方法</h4><p>AnnotationConfigApplicationContext容器，上篇（三、3）中注册了配置类处理器ConfigurationClassPostProcessor<br>该处理器实现了BeanDefinitionRegistryPostProcessor，在invokeBeanFactoryPostProcessors方法中会调用该类的<br>postProcessBeanDefinitionRegistry方法和postProcessBeanFactory方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    int registryId = System.identityHashCode(registry);</span><br><span class="line">    if (this.registriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot; + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    if (this.factoriesPostProcessed.contains(registryId)) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;postProcessBeanFactory already called on this post-processor against &quot; + registry);</span><br><span class="line">    &#125;</span><br><span class="line">    this.registriesPostProcessed.add(registryId);</span><br><span class="line">    //处理配置类</span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法"><a href="#2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法" class="headerlink" title="2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法"></a>2、ConfigurationClassPostProcessor的processConfigBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = new ArrayList&lt;&gt;();</span><br><span class="line">    //获取已有的beanName，Application也作为BeanDefinition注册到了容器中</span><br><span class="line">    String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">    for (String beanName : candidateNames) &#123;</span><br><span class="line">        BeanDefinition beanDef = registry.getBeanDefinition(beanName);</span><br><span class="line">        //BeanDefinition 中的configurationClass 属性为full 或者lite ,则意味着已经处理</span><br><span class="line">        if (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||</span><br><span class="line">                ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Bean definition has already been processed as a configuration class: &quot; + beanDef);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //如果类存在@Configuration、@Component、@ComponentScan、@Import、@ImportResource</span><br><span class="line">        //或者存在被@bean注解的方法，则加入configCandidates</span><br><span class="line">        else if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) &#123;</span><br><span class="line">            configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Return immediately if no @Configuration classes were found</span><br><span class="line">    if (configCandidates.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Sort by previously determined @Order value, if applicable</span><br><span class="line">    //对configCandidates排序,按照@Order配置的值进行排序</span><br><span class="line">    configCandidates.sort((bd1, bd2) -&gt; &#123;</span><br><span class="line">        int i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());</span><br><span class="line">        int i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());</span><br><span class="line">        return Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // Detect any custom bean name generation strategy supplied through the enclosing application context</span><br><span class="line">    SingletonBeanRegistry sbr = null;</span><br><span class="line">    //DefaultListableBeanFactory是SingletonBeanRegistry的子类</span><br><span class="line">    if (registry instanceof SingletonBeanRegistry) &#123;</span><br><span class="line">        sbr = (SingletonBeanRegistry) registry;</span><br><span class="line">        if (!this.localBeanNameGeneratorSet) &#123;</span><br><span class="line">            BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);</span><br><span class="line">            if (generator != null) &#123;</span><br><span class="line">                this.componentScanBeanNameGenerator = generator;</span><br><span class="line">                this.importBeanNameGenerator = generator;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.environment == null) &#123;</span><br><span class="line">        this.environment = new StandardEnvironment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Parse each @Configuration class</span><br><span class="line">    //实例化ConfigurationClassParser解析配置类</span><br><span class="line">    ConfigurationClassParser parser = new ConfigurationClassParser(</span><br><span class="line">            this.metadataReaderFactory, this.problemReporter, this.environment,</span><br><span class="line">            this.resourceLoader, this.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = new LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line">    Set&lt;ConfigurationClass&gt; alreadyParsed = new HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line">    do &#123;</span><br><span class="line">        //解析配置类</span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">        //校验，配置类不能为final，@Bean注解的方法如不是static的则必须能被覆盖</span><br><span class="line">        parser.validate();</span><br><span class="line">        //解析完的配置类，除重，除去已加载的配置类</span><br><span class="line">        Set&lt;ConfigurationClass&gt; configClasses = new LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">        configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">        // Read the model and create bean definitions based on its content</span><br><span class="line">        if (this.reader == null) &#123;</span><br><span class="line">            this.reader = new ConfigurationClassBeanDefinitionReader(</span><br><span class="line">                    registry, this.sourceExtractor, this.resourceLoader, this.environment,</span><br><span class="line">                    this.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">        &#125;</span><br><span class="line">        //加载资源</span><br><span class="line">        this.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        //该配置类已处理</span><br><span class="line">        alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">        candidates.clear();</span><br><span class="line">        //获取注册的bean的BeanDefinition</span><br><span class="line">        if (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">            String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">            Set&lt;String&gt; oldCandidateNames = new HashSet&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line">            Set&lt;String&gt; alreadyParsedClasses = new HashSet&lt;&gt;();</span><br><span class="line">            for (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">                alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">            &#125;</span><br><span class="line">            for (String candidateName : newCandidateNames) &#123;</span><br><span class="line">                if (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">                    BeanDefinition bd = registry.getBeanDefinition(candidateName);</span><br><span class="line">                    //新加载的BeanDefinition中的配置类</span><br><span class="line">                    if (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory) &amp;&amp;</span><br><span class="line">                            !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">                        candidates.add(new BeanDefinitionHolder(bd, candidateName));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            candidateNames = newCandidateNames;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //处理新加载的BeanDefinition中的配置类</span><br><span class="line">    while (!candidates.isEmpty());</span><br><span class="line"></span><br><span class="line">    // Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span><br><span class="line">    if (sbr != null &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;</span><br><span class="line">        //注册一个ImportRegistry(ImportStack),</span><br><span class="line">        sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    //清除缓存</span><br><span class="line">    if (this.metadataReaderFactory instanceof CachingMetadataReaderFactory) &#123;</span><br><span class="line">        // Clear cache in externally provided MetadataReaderFactory; this is a no-op</span><br><span class="line">        // for a shared cache since it&apos;ll be cleared by the ApplicationContext.</span><br><span class="line">        ((CachingMetadataReaderFactory) this.metadataReaderFactory).clearCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、ConfigurationClassUtils的checkConfigurationClassCandidate方法"><a href="#3、ConfigurationClassUtils的checkConfigurationClassCandidate方法" class="headerlink" title="3、ConfigurationClassUtils的checkConfigurationClassCandidate方法"></a>3、ConfigurationClassUtils的checkConfigurationClassCandidate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public static boolean checkConfigurationClassCandidate(BeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory) &#123;</span><br><span class="line">    //获取类名</span><br><span class="line">    String className = beanDef.getBeanClassName();</span><br><span class="line">    if (className == null || beanDef.getFactoryMethodName() != null) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    //获得AnnotationMetadata</span><br><span class="line">    AnnotationMetadata metadata;</span><br><span class="line">    if (beanDef instanceof AnnotatedBeanDefinition &amp;&amp;</span><br><span class="line">            className.equals(((AnnotatedBeanDefinition) beanDef).getMetadata().getClassName())) &#123;</span><br><span class="line">        // Can reuse the pre-parsed metadata from the given BeanDefinition...</span><br><span class="line">        //直接从BeanDefinition获得Metadata</span><br><span class="line">        metadata = ((AnnotatedBeanDefinition) beanDef).getMetadata();</span><br><span class="line">    &#125;</span><br><span class="line">    else if (beanDef instanceof AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) beanDef).hasBeanClass()) &#123;</span><br><span class="line">        // Check already loaded Class if present...</span><br><span class="line">        // since we possibly can&apos;t even load the class file for this Class.</span><br><span class="line">        Class&lt;?&gt; beanClass = ((AbstractBeanDefinition) beanDef).getBeanClass();</span><br><span class="line">        //实例化StandardAnnotationMetadata</span><br><span class="line">        metadata = new StandardAnnotationMetadata(beanClass, true);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //通过MetadataReaderFactory中的MetadataReader进行读取</span><br><span class="line">            MetadataReader metadataReader = metadataReaderFactory.getMetadataReader(className);</span><br><span class="line">            metadata = metadataReader.getAnnotationMetadata();</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IOException ex) &#123;</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Could not find class file for introspecting configuration annotations: &quot; + className, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //存在Configuration注解,则为BeanDefinition 设置configurationClass属性为full</span><br><span class="line">    if (isFullConfigurationCandidate(metadata)) &#123;</span><br><span class="line">        beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL);</span><br><span class="line">    &#125;</span><br><span class="line">    //存在Component,ComponentScan,Import,ImportResource注解中的任意一个,或者存在被@bean注解的方法</span><br><span class="line">    //则设置configurationClass属性为lite</span><br><span class="line">    else if (isLiteConfigurationCandidate(metadata)) &#123;</span><br><span class="line">        beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // It&apos;s a full or lite configuration candidate... Let&apos;s determine the order value, if any.</span><br><span class="line">    //如果该类被@Order所注解,则设置order属性为@Order的值</span><br><span class="line">    Integer order = getOrder(metadata);</span><br><span class="line">    if (order != null) &#123;</span><br><span class="line">        beanDef.setAttribute(ORDER_ATTRIBUTE, order);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、ConfigurationClassUtils的isFullConfigurationCandidate方法"><a href="#4、ConfigurationClassUtils的isFullConfigurationCandidate方法" class="headerlink" title="4、ConfigurationClassUtils的isFullConfigurationCandidate方法"></a>4、ConfigurationClassUtils的isFullConfigurationCandidate方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isFullConfigurationCandidate(AnnotationMetadata metadata) &#123;</span><br><span class="line">    //是否存在Configuration注解</span><br><span class="line">    return metadata.isAnnotated(Configuration.class.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、StandardAnnotationMetadata的isAnnotated方法"><a href="#5、StandardAnnotationMetadata的isAnnotated方法" class="headerlink" title="5、StandardAnnotationMetadata的isAnnotated方法"></a>5、StandardAnnotationMetadata的isAnnotated方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean isAnnotated(String annotationName) &#123;</span><br><span class="line">    //是否存在annotationName注解</span><br><span class="line">    return (this.annotations.length &gt; 0 &amp;&amp;</span><br><span class="line">            AnnotatedElementUtils.isAnnotated(getIntrospectedClass(), annotationName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、AnnotatedElementUtils的isAnnotated方法"><a href="#6、AnnotatedElementUtils的isAnnotated方法" class="headerlink" title="6、AnnotatedElementUtils的isAnnotated方法"></a>6、AnnotatedElementUtils的isAnnotated方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static boolean isAnnotated(AnnotatedElement element, String annotationName) &#123;</span><br><span class="line">    //是否存在annotationName注解</span><br><span class="line">    return Boolean.TRUE.equals(searchWithGetSemantics(element, null, annotationName, alwaysTrueAnnotationProcessor));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7、AnnotatedElementUtils的searchWithGetSemantics方法"><a href="#7、AnnotatedElementUtils的searchWithGetSemantics方法" class="headerlink" title="7、AnnotatedElementUtils的searchWithGetSemantics方法"></a>7、AnnotatedElementUtils的searchWithGetSemantics方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemantics(AnnotatedElement element,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; annotationType,</span><br><span class="line">        @Nullable String annotationName, Processor&lt;T&gt; processor) &#123;</span><br><span class="line">    //查找并处理annotationName注解</span><br><span class="line">    return searchWithGetSemantics(element, annotationType, annotationName, null, processor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemantics(AnnotatedElement element,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; annotationType, @Nullable String annotationName,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; containerType, Processor&lt;T&gt; processor) &#123;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        //查找并处理annotationName注解</span><br><span class="line">        return searchWithGetSemantics(element, annotationType, annotationName, containerType, processor,</span><br><span class="line">                new HashSet&lt;&gt;(), 0);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Throwable ex) &#123;</span><br><span class="line">        AnnotationUtils.rethrowAnnotationConfigurationException(ex);</span><br><span class="line">        throw new IllegalStateException(&quot;Failed to introspect annotations on &quot; + element, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemantics(AnnotatedElement element,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; annotationType, @Nullable String annotationName,</span><br><span class="line">        @Nullable Class&lt;? extends Annotation&gt; containerType, Processor&lt;T&gt; processor,</span><br><span class="line">        Set&lt;AnnotatedElement&gt; visited, int metaDepth) &#123;</span><br><span class="line">    //该配置类加入已处理的集合</span><br><span class="line">    if (visited.add(element)) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // Start searching within locally declared annotations</span><br><span class="line">            //获取该类的直接注解</span><br><span class="line">            List&lt;Annotation&gt; declaredAnnotations = Arrays.asList(element.getDeclaredAnnotations());</span><br><span class="line">            //查找并处理annotationName注解</span><br><span class="line">            T result = searchWithGetSemanticsInAnnotations(element, declaredAnnotations,</span><br><span class="line">                    annotationType, annotationName, containerType, processor, visited, metaDepth);</span><br><span class="line">            if (result != null) &#123;</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (element instanceof Class) &#123; // otherwise getAnnotations doesn&apos;t return anything new</span><br><span class="line">                List&lt;Annotation&gt; inheritedAnnotations = new ArrayList&lt;&gt;();</span><br><span class="line">                //获取该类的继承而来的注解</span><br><span class="line">                for (Annotation annotation : element.getAnnotations()) &#123;</span><br><span class="line">                    if (!declaredAnnotations.contains(annotation)) &#123;</span><br><span class="line">                        inheritedAnnotations.add(annotation);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Continue searching within inherited annotations</span><br><span class="line">                result = searchWithGetSemanticsInAnnotations(element, inheritedAnnotations,</span><br><span class="line">                        annotationType, annotationName, containerType, processor, visited, metaDepth);</span><br><span class="line">                if (result != null) &#123;</span><br><span class="line">                    return result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            AnnotationUtils.handleIntrospectionFailure(element, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法"><a href="#8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法" class="headerlink" title="8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法"></a>8、AnnotatedElementUtils的searchWithGetSemanticsInAnnotations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">private static &lt;T&gt; T searchWithGetSemanticsInAnnotations(@Nullable AnnotatedElement element,</span><br><span class="line">        List&lt;Annotation&gt; annotations, @Nullable Class&lt;? extends Annotation&gt; annotationType,</span><br><span class="line">        @Nullable String annotationName, @Nullable Class&lt;? extends Annotation&gt; containerType,</span><br><span class="line">        Processor&lt;T&gt; processor, Set&lt;AnnotatedElement&gt; visited, int metaDepth) &#123;</span><br><span class="line"></span><br><span class="line">    // Search in annotations</span><br><span class="line">    //循环该类注解</span><br><span class="line">    for (Annotation annotation : annotations) &#123;</span><br><span class="line">        Class&lt;? extends Annotation&gt; currentAnnotationType = annotation.annotationType();</span><br><span class="line">        if (!AnnotationUtils.isInJavaLangAnnotationPackage(currentAnnotationType)) &#123;</span><br><span class="line">            //查找并处理annotationName注解</span><br><span class="line">            if (currentAnnotationType == annotationType ||</span><br><span class="line">                    currentAnnotationType.getName().equals(annotationName) ||</span><br><span class="line">                    processor.alwaysProcesses()) &#123;</span><br><span class="line">                T result = processor.process(element, annotation, metaDepth);</span><br><span class="line">                if (result != null) &#123;</span><br><span class="line">                    if (processor.aggregates() &amp;&amp; metaDepth == 0) &#123;</span><br><span class="line">                        processor.getAggregatedResults().add(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        return result;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // Repeatable annotations in container?</span><br><span class="line">            else if (currentAnnotationType == containerType) &#123;</span><br><span class="line">                for (Annotation contained : getRawAnnotationsFromContainer(element, annotation)) &#123;</span><br><span class="line">                    T result = processor.process(element, contained, metaDepth);</span><br><span class="line">                    if (result != null) &#123;</span><br><span class="line">                        // No need to post-process since repeatable annotations within a</span><br><span class="line">                        // container cannot be composed annotations.</span><br><span class="line">                        processor.getAggregatedResults().add(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Recursively search in meta-annotations</span><br><span class="line">    //循环该类注解</span><br><span class="line">    for (Annotation annotation : annotations) &#123;</span><br><span class="line">        //获取注解类型</span><br><span class="line">        Class&lt;? extends Annotation&gt; currentAnnotationType = annotation.annotationType();</span><br><span class="line">        if (hasSearchableMetaAnnotations(currentAnnotationType, annotationType, annotationName)) &#123;</span><br><span class="line">            //查找并处理annotationName注解</span><br><span class="line">            T result = searchWithGetSemantics(currentAnnotationType, annotationType,</span><br><span class="line">                    annotationName, containerType, processor, visited, metaDepth + 1);</span><br><span class="line">            if (result != null) &#123;</span><br><span class="line">                processor.postProcess(element, annotation, result);</span><br><span class="line">                if (processor.aggregates() &amp;&amp; metaDepth == 0) &#123;</span><br><span class="line">                    processor.getAggregatedResults().add(result);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    return result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9、接（二、2）ConfigurationClassParser的parse方法"><a href="#9、接（二、2）ConfigurationClassParser的parse方法" class="headerlink" title="9、接（二、2）ConfigurationClassParser的parse方法"></a>9、接（二、2）ConfigurationClassParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public void parse(Set&lt;BeanDefinitionHolder&gt; configCandidates) &#123;</span><br><span class="line">    this.deferredImportSelectors = new LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    for (BeanDefinitionHolder holder : configCandidates) &#123;</span><br><span class="line">        BeanDefinition bd = holder.getBeanDefinition();</span><br><span class="line">        try &#123;</span><br><span class="line">            //解析配置类</span><br><span class="line">            if (bd instanceof AnnotatedBeanDefinition) &#123;</span><br><span class="line">                parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            else if (bd instanceof AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) bd).hasBeanClass()) &#123;</span><br><span class="line">                parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                parse(bd.getBeanClassName(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(</span><br><span class="line">                    &quot;Failed to parse configuration class [&quot; + bd.getBeanClassName() + &quot;]&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    processDeferredImportSelectors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected final void parse(AnnotationMetadata metadata, String beanName) throws IOException &#123;</span><br><span class="line">    //解析配置类</span><br><span class="line">    processConfigurationClass(new ConfigurationClass(metadata, beanName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="10、ConfigurationClassParser的processConfigurationClass方法"><a href="#10、ConfigurationClassParser的processConfigurationClass方法" class="headerlink" title="10、ConfigurationClassParser的processConfigurationClass方法"></a>10、ConfigurationClassParser的processConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">protected void processConfigurationClass(ConfigurationClass configClass) throws IOException &#123;</span><br><span class="line">    //该类有条件注解，且不匹配，不处理</span><br><span class="line">    if (this.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConfigurationClass existingClass = this.configurationClasses.get(configClass);</span><br><span class="line">    if (existingClass != null) &#123;</span><br><span class="line">        //该类已解析，且为import的类，合并导入信息，不处理该类</span><br><span class="line">        if (configClass.isImported()) &#123;</span><br><span class="line">            if (existingClass.isImported()) &#123;</span><br><span class="line">                existingClass.mergeImportedBy(configClass);</span><br><span class="line">            &#125;</span><br><span class="line">            // Otherwise ignore new imported config class; existing non-imported class overrides it.</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //删除旧配置类，重新解析</span><br><span class="line">        else &#123;</span><br><span class="line">            // Explicit bean definition found, probably replacing an import.</span><br><span class="line">            // Let&apos;s remove the old one and go with the new one.</span><br><span class="line">            this.configurationClasses.remove(configClass);</span><br><span class="line">            this.knownSuperclasses.values().removeIf(configClass::equals);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Recursively process the configuration class and its superclass hierarchy.</span><br><span class="line">    //配置类</span><br><span class="line">    SourceClass sourceClass = asSourceClass(configClass);</span><br><span class="line">    do &#123;</span><br><span class="line">        //解析配置类</span><br><span class="line">        sourceClass = doProcessConfigurationClass(configClass, sourceClass);</span><br><span class="line">    &#125;</span><br><span class="line">    while (sourceClass != null);</span><br><span class="line"></span><br><span class="line">    this.configurationClasses.put(configClass, configClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="11、ConfigurationClassParser的doProcessConfigurationClass方法"><a href="#11、ConfigurationClassParser的doProcessConfigurationClass方法" class="headerlink" title="11、ConfigurationClassParser的doProcessConfigurationClass方法"></a>11、ConfigurationClassParser的doProcessConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@Nullable</span><br><span class="line">protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass)</span><br><span class="line">        throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    // Recursively process any member (nested) classes first</span><br><span class="line">    //处理内部类</span><br><span class="line">    processMemberClasses(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">    // Process any @PropertySource annotations</span><br><span class="line">    //处理配置类、配置类父类、配置类注解类的@PropertySource注解</span><br><span class="line">    for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">            org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">        if (this.environment instanceof ConfigurableEnvironment) &#123;</span><br><span class="line">            processPropertySource(propertySource);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            logger.warn(&quot;Ignoring @PropertySource annotation on [&quot; + sourceClass.getMetadata().getClassName() +</span><br><span class="line">                    &quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process any @ComponentScan annotations</span><br><span class="line">    //获取配置类、配置类父类、配置类注解类的@ComponentScan注解</span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    if (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">            !this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        for (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">            // The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span><br><span class="line">            //解析注解，并扫描</span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">                    this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">            // Check the set of scanned definitions for any further config classes and parse recursively if needed</span><br><span class="line">            for (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">                BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">                if (bdCand == null) &#123;</span><br><span class="line">                    bdCand = holder.getBeanDefinition();</span><br><span class="line">                &#125;</span><br><span class="line">                //继续解析扫描获取到的配置类</span><br><span class="line">                if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) &#123;</span><br><span class="line">                    parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process any @Import annotations</span><br><span class="line">    //处理配置类、配置类父类、配置类注解类的@Import注解</span><br><span class="line">    //将注解的值注册到容器中</span><br><span class="line">    processImports(configClass, sourceClass, getImports(sourceClass), true);</span><br><span class="line"></span><br><span class="line">    // Process any @ImportResource annotations</span><br><span class="line">    //处理配置类、配置类父类、配置类注解类的@ImportResource注解的值</span><br><span class="line">    AnnotationAttributes importResource =</span><br><span class="line">            AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">    if (importResource != null) &#123;</span><br><span class="line">        //获取资源</span><br><span class="line">        String[] resources = importResource.getStringArray(&quot;locations&quot;);</span><br><span class="line">        Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(&quot;reader&quot;);</span><br><span class="line">        //遍历资源,加入到configClass中</span><br><span class="line">        for (String resource : resources) &#123;</span><br><span class="line">            String resolvedResource = this.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">            configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process individual @Bean methods</span><br><span class="line">    //配置类的@Bean注解的方法,添加到configClass</span><br><span class="line">    Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">    for (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">        configClass.addBeanMethod(new BeanMethod(methodMetadata, configClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Process default methods on interfaces</span><br><span class="line">    //配置类接口的方法,添加到configClass</span><br><span class="line">    processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">    // Process superclass, if any</span><br><span class="line">    //配置类有父类则继续处理</span><br><span class="line">    if (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">        String superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">        if (superclass != null &amp;&amp; !superclass.startsWith(&quot;java&quot;) &amp;&amp;</span><br><span class="line">                !this.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">            this.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">            // Superclass found, return its annotation metadata and recurse</span><br><span class="line">            return sourceClass.getSuperClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // No superclass -&gt; processing is complete</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12、ConfigurationClassParser的processMemberClasses方法"><a href="#12、ConfigurationClassParser的processMemberClasses方法" class="headerlink" title="12、ConfigurationClassParser的processMemberClasses方法"></a>12、ConfigurationClassParser的processMemberClasses方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">private void processMemberClasses(ConfigurationClass configClass, SourceClass sourceClass) throws IOException &#123;</span><br><span class="line">    //获取内部类</span><br><span class="line">    Collection&lt;SourceClass&gt; memberClasses = sourceClass.getMemberClasses();</span><br><span class="line">    if (!memberClasses.isEmpty()) &#123;</span><br><span class="line">        List&lt;SourceClass&gt; candidates = new ArrayList&lt;&gt;(memberClasses.size());</span><br><span class="line">        //遍历class中的内部类,将配置类加入candidates</span><br><span class="line">        for (SourceClass memberClass : memberClasses) &#123;</span><br><span class="line">            if (ConfigurationClassUtils.isConfigurationCandidate(memberClass.getMetadata()) &amp;&amp;</span><br><span class="line">                    !memberClass.getMetadata().getClassName().equals(configClass.getMetadata().getClassName())) &#123;</span><br><span class="line">                candidates.add(memberClass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //排序</span><br><span class="line">        OrderComparator.sort(candidates);</span><br><span class="line">        //遍历candidates</span><br><span class="line">        for (SourceClass candidate : candidates) &#123;</span><br><span class="line">            //importStack包含该configClass的类,说明发生了循环依赖</span><br><span class="line">            if (this.importStack.contains(configClass)) &#123;</span><br><span class="line">                this.problemReporter.error(new CircularImportProblem(configClass, this.importStack));</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                this.importStack.push(configClass);</span><br><span class="line">                try &#123;</span><br><span class="line">                    //解析该配置类</span><br><span class="line">                    processConfigurationClass(candidate.asConfigClass(configClass));</span><br><span class="line">                &#125;</span><br><span class="line">                finally &#123;</span><br><span class="line">                    this.importStack.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13、接（二、11）ConfigurationClassParser的processPropertySource方法"><a href="#13、接（二、11）ConfigurationClassParser的processPropertySource方法" class="headerlink" title="13、接（二、11）ConfigurationClassParser的processPropertySource方法"></a>13、接（二、11）ConfigurationClassParser的processPropertySource方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">private void processPropertySource(AnnotationAttributes propertySource) throws IOException &#123;</span><br><span class="line">    String name = propertySource.getString(&quot;name&quot;);</span><br><span class="line">    if (!StringUtils.hasLength(name)) &#123;</span><br><span class="line">        name = null;</span><br><span class="line">    &#125;</span><br><span class="line">    String encoding = propertySource.getString(&quot;encoding&quot;);</span><br><span class="line">    if (!StringUtils.hasLength(encoding)) &#123;</span><br><span class="line">        encoding = null;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取资源地址</span><br><span class="line">    String[] locations = propertySource.getStringArray(&quot;value&quot;);</span><br><span class="line">    Assert.isTrue(locations.length &gt; 0, &quot;At least one @PropertySource(value) location is required&quot;);</span><br><span class="line">    //是否忽略未发现资源</span><br><span class="line">    boolean ignoreResourceNotFound = propertySource.getBoolean(&quot;ignoreResourceNotFound&quot;);</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends PropertySourceFactory&gt; factoryClass = propertySource.getClass(&quot;factory&quot;);</span><br><span class="line">    //默认DefaultPropertySourceFactory</span><br><span class="line">    PropertySourceFactory factory = (factoryClass == PropertySourceFactory.class ?</span><br><span class="line">            DEFAULT_PROPERTY_SOURCE_FACTORY : BeanUtils.instantiateClass(factoryClass));</span><br><span class="line"></span><br><span class="line">    for (String location : locations) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //对location进行SPEL表达式的解析。比如$&#123;app&#125;</span><br><span class="line">            String resolvedLocation = this.environment.resolveRequiredPlaceholders(location);</span><br><span class="line">            Resource resource = this.resourceLoader.getResource(resolvedLocation);</span><br><span class="line">            //将指定的资源处理之后，添加到当前springboot运行的环境中</span><br><span class="line">            addPropertySource(factory.createPropertySource(name, new EncodedResource(resource, encoding)));</span><br><span class="line">        &#125;</span><br><span class="line">        catch (IllegalArgumentException | FileNotFoundException | UnknownHostException ex) &#123;</span><br><span class="line">            // Placeholders not resolvable or resource not found when trying to open it</span><br><span class="line">            if (ignoreResourceNotFound) &#123;</span><br><span class="line">                if (logger.isInfoEnabled()) &#123;</span><br><span class="line">                    logger.info(&quot;Properties location [&quot; + location + &quot;] not resolvable: &quot; + ex.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（二、11）ComponentScanAnnotationParser的parse方法"><a href="#14、接（二、11）ComponentScanAnnotationParser的parse方法" class="headerlink" title="14、接（二、11）ComponentScanAnnotationParser的parse方法"></a>14、接（二、11）ComponentScanAnnotationParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">public Set&lt;BeanDefinitionHolder&gt; parse(AnnotationAttributes componentScan, final String declaringClass) &#123;</span><br><span class="line">    //扫描器</span><br><span class="line">    ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(this.registry,</span><br><span class="line">            componentScan.getBoolean(&quot;useDefaultFilters&quot;), this.environment, this.resourceLoader);</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; generatorClass = componentScan.getClass(&quot;nameGenerator&quot;);</span><br><span class="line">    boolean useInheritedGenerator = (BeanNameGenerator.class == generatorClass);</span><br><span class="line">    //设置beanName生成器</span><br><span class="line">    scanner.setBeanNameGenerator(useInheritedGenerator ? this.beanNameGenerator :</span><br><span class="line">            BeanUtils.instantiateClass(generatorClass));</span><br><span class="line">    //代理，解决向大作用域bean注入小作用域bean的问题</span><br><span class="line">    ScopedProxyMode scopedProxyMode = componentScan.getEnum(&quot;scopedProxy&quot;);</span><br><span class="line">    if (scopedProxyMode != ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">        scanner.setScopedProxyMode(scopedProxyMode);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        Class&lt;? extends ScopeMetadataResolver&gt; resolverClass = componentScan.getClass(&quot;scopeResolver&quot;);</span><br><span class="line">        scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));</span><br><span class="line">    &#125;</span><br><span class="line">    //对资源进行筛选的正则表达式</span><br><span class="line">    scanner.setResourcePattern(componentScan.getString(&quot;resourcePattern&quot;));</span><br><span class="line">    //过滤器，指定扫描资源</span><br><span class="line">    for (AnnotationAttributes filter : componentScan.getAnnotationArray(&quot;includeFilters&quot;)) &#123;</span><br><span class="line">        for (TypeFilter typeFilter : typeFiltersFor(filter)) &#123;</span><br><span class="line">            scanner.addIncludeFilter(typeFilter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //过滤器，排除不扫描资源</span><br><span class="line">    for (AnnotationAttributes filter : componentScan.getAnnotationArray(&quot;excludeFilters&quot;)) &#123;</span><br><span class="line">        for (TypeFilter typeFilter : typeFiltersFor(filter)) &#123;</span><br><span class="line">            scanner.addExcludeFilter(typeFilter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //是否延迟加载</span><br><span class="line">    boolean lazyInit = componentScan.getBoolean(&quot;lazyInit&quot;);</span><br><span class="line">    if (lazyInit) &#123;</span><br><span class="line">        scanner.getBeanDefinitionDefaults().setLazyInit(true);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取扫描资源的包路径</span><br><span class="line">    Set&lt;String&gt; basePackages = new LinkedHashSet&lt;&gt;();</span><br><span class="line">    //获取配置的包路径</span><br><span class="line">    String[] basePackagesArray = componentScan.getStringArray(&quot;basePackages&quot;);</span><br><span class="line">    for (String pkg : basePackagesArray) &#123;</span><br><span class="line">        String[] tokenized = StringUtils.tokenizeToStringArray(this.environment.resolvePlaceholders(pkg),</span><br><span class="line">                ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">        Collections.addAll(basePackages, tokenized);</span><br><span class="line">    &#125;</span><br><span class="line">    for (Class&lt;?&gt; clazz : componentScan.getClassArray(&quot;basePackageClasses&quot;)) &#123;</span><br><span class="line">        basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">    &#125;</span><br><span class="line">    //默认扫描配置类的包</span><br><span class="line">    if (basePackages.isEmpty()) &#123;</span><br><span class="line">        basePackages.add(ClassUtils.getPackageName(declaringClass));</span><br><span class="line">    &#125;</span><br><span class="line">    //排除自己</span><br><span class="line">    scanner.addExcludeFilter(new AbstractTypeHierarchyTraversingFilter(false, false) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected boolean matchClassName(String className) &#123;</span><br><span class="line">            return declaringClass.equals(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    //扫描加载资源，在上篇已有解析</span><br><span class="line">    return scanner.doScan(StringUtils.toStringArray(basePackages));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="14、接（二、11）ComponentScanAnnotationParser的processImports方法"><a href="#14、接（二、11）ComponentScanAnnotationParser的processImports方法" class="headerlink" title="14、接（二、11）ComponentScanAnnotationParser的processImports方法"></a>14、接（二、11）ComponentScanAnnotationParser的processImports方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">private void processImports(ConfigurationClass configClass, SourceClass currentSourceClass,</span><br><span class="line">        Collection&lt;SourceClass&gt; importCandidates, boolean checkForCircularImports) &#123;</span><br><span class="line">    //import的类为空</span><br><span class="line">    if (importCandidates.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //检查循环依赖</span><br><span class="line">    if (checkForCircularImports &amp;&amp; isChainedImportOnStack(configClass)) &#123;</span><br><span class="line">        this.problemReporter.error(new CircularImportProblem(configClass, this.importStack));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        this.importStack.push(configClass);</span><br><span class="line">        try &#123;</span><br><span class="line">            //遍历处理</span><br><span class="line">            for (SourceClass candidate : importCandidates) &#123;</span><br><span class="line">                //ImportSelector的子类</span><br><span class="line">                if (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">                    // Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br><span class="line">                    Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">                    //实例化该类</span><br><span class="line">                    ImportSelector selector = BeanUtils.instantiateClass(candidateClass, ImportSelector.class);</span><br><span class="line">                    //给实现特定接口的类设置资源</span><br><span class="line">                    ParserStrategyUtils.invokeAwareMethods(</span><br><span class="line">                            selector, this.environment, this.resourceLoader, this.registry);</span><br><span class="line">                    //DeferredImportSelector的实现,加入到deferredImportSelectors</span><br><span class="line">                    if (this.deferredImportSelectors != null &amp;&amp; selector instanceof DeferredImportSelector) &#123;</span><br><span class="line">                        this.deferredImportSelectors.add(</span><br><span class="line">                                new DeferredImportSelectorHolder(configClass, (DeferredImportSelector) selector));</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        //获取该类中定义的需要import的类</span><br><span class="line">                        String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">                        Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames);</span><br><span class="line">                        //循环调用该方法，处理importSourceClasses</span><br><span class="line">                        processImports(configClass, currentSourceClass, importSourceClasses, false);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                //ImportBeanDefinitionRegistrar的子类</span><br><span class="line">                else if (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">                    // Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span><br><span class="line">                    // delegate to it to register additional bean definitions</span><br><span class="line">                    Class&lt;?&gt; candidateClass = candidate.loadClass();</span><br><span class="line">                    ImportBeanDefinitionRegistrar registrar =</span><br><span class="line">                            BeanUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class);</span><br><span class="line">                    ParserStrategyUtils.invokeAwareMethods(</span><br><span class="line">                            registrar, this.environment, this.resourceLoader, this.registry);</span><br><span class="line">                    //添加到configClass中</span><br><span class="line">                    configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    // Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span><br><span class="line">                    // process it as an @Configuration class</span><br><span class="line">                    this.importStack.registerImport(</span><br><span class="line">                            currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());</span><br><span class="line">                    //调用processConfigurationClass进行处理,当成普通配置类</span><br><span class="line">                    processConfigurationClass(candidate.asConfigClass(configClass));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Throwable ex) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(</span><br><span class="line">                    &quot;Failed to process import candidates for configuration class [&quot; +</span><br><span class="line">                    configClass.getMetadata().getClassName() + &quot;]&quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            this.importStack.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15、接（二、9）ConfigurationClassParser的parse方法"><a href="#15、接（二、9）ConfigurationClassParser的parse方法" class="headerlink" title="15、接（二、9）ConfigurationClassParser的parse方法"></a>15、接（二、9）ConfigurationClassParser的parse方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    private void processDeferredImportSelectors() &#123;</span><br><span class="line">    //import进来的DeferredImportSelector</span><br><span class="line">    List&lt;DeferredImportSelectorHolder&gt; deferredImports = this.deferredImportSelectors;</span><br><span class="line">    this.deferredImportSelectors = null;</span><br><span class="line">    if (deferredImports == null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //排序</span><br><span class="line">    deferredImports.sort(DEFERRED_IMPORT_COMPARATOR);</span><br><span class="line">    Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = new LinkedHashMap&lt;&gt;();</span><br><span class="line">    Map&lt;AnnotationMetadata, ConfigurationClass&gt; configurationClasses = new HashMap&lt;&gt;();</span><br><span class="line">    //DeferredImportSelector分组</span><br><span class="line">    for (DeferredImportSelectorHolder deferredImport : deferredImports) &#123;</span><br><span class="line">        Class&lt;? extends Group&gt; group = deferredImport.getImportSelector().getImportGroup();</span><br><span class="line">        DeferredImportSelectorGrouping grouping = groupings.computeIfAbsent(</span><br><span class="line">                (group == null ? deferredImport : group),</span><br><span class="line">                (key) -&gt; new DeferredImportSelectorGrouping(createGroup(group)));</span><br><span class="line">        grouping.add(deferredImport);</span><br><span class="line">        configurationClasses.put(deferredImport.getConfigurationClass().getMetadata(),</span><br><span class="line">                deferredImport.getConfigurationClass());</span><br><span class="line">    &#125;</span><br><span class="line">    for (DeferredImportSelectorGrouping grouping : groupings.values()) &#123;</span><br><span class="line">        //获取、排序、遍历DeferredImportSelector中要导入的类</span><br><span class="line">        grouping.getImports().forEach((entry) -&gt; &#123;</span><br><span class="line">            ConfigurationClass configurationClass = configurationClasses.get(</span><br><span class="line">                    entry.getMetadata());</span><br><span class="line">            try &#123;</span><br><span class="line">                //导入、解析并注册到容器中</span><br><span class="line">                processImports(configurationClass, asSourceClass(configurationClass),</span><br><span class="line">                        asSourceClasses(entry.getImportClassName()), false);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                throw new BeanDefinitionStoreException(</span><br><span class="line">                        &quot;Failed to process import candidates for configuration class [&quot; +</span><br><span class="line">                                configurationClass.getMetadata().getClassName() + &quot;]&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="16、AutoConfigurationGroup的sortAutoConfigurations方法"><a href="#16、AutoConfigurationGroup的sortAutoConfigurations方法" class="headerlink" title="16、AutoConfigurationGroup的sortAutoConfigurations方法"></a>16、AutoConfigurationGroup的sortAutoConfigurations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;String&gt; sortAutoConfigurations() &#123;</span><br><span class="line">    List&lt;String&gt; autoConfigurations = new ArrayList&lt;&gt;(this.entries.keySet());</span><br><span class="line">    if (this.entries.size() &lt;= 1) &#123;</span><br><span class="line">        return autoConfigurations;</span><br><span class="line">    &#125;</span><br><span class="line">    AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">            .loadMetadata(this.beanClassLoader);</span><br><span class="line">    //对即将导入的类排序</span><br><span class="line">    return new AutoConfigurationSorter(getMetadataReaderFactory(),</span><br><span class="line">            autoConfigurationMetadata).getInPriorityOrder(autoConfigurations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="17、AutoConfigurationSorter的sortAutoConfigurations方法"><a href="#17、AutoConfigurationSorter的sortAutoConfigurations方法" class="headerlink" title="17、AutoConfigurationSorter的sortAutoConfigurations方法"></a>17、AutoConfigurationSorter的sortAutoConfigurations方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;String&gt; getInPriorityOrder(Collection&lt;String&gt; classNames) &#123;</span><br><span class="line">    AutoConfigurationClasses classes = new AutoConfigurationClasses(</span><br><span class="line">            this.metadataReaderFactory, this.autoConfigurationMetadata, classNames);</span><br><span class="line">    List&lt;String&gt; orderedClassNames = new ArrayList&lt;&gt;(classNames);</span><br><span class="line">    // Initially sort alphabetically</span><br><span class="line">    //按照名称字母排序</span><br><span class="line">    Collections.sort(orderedClassNames);</span><br><span class="line">    // Then sort by order</span><br><span class="line">    //按照@AutoConfigureOrder值排序</span><br><span class="line">    orderedClassNames.sort((o1, o2) -&gt; &#123;</span><br><span class="line">        int i1 = classes.get(o1).getOrder();</span><br><span class="line">        int i2 = classes.get(o2).getOrder();</span><br><span class="line">        return Integer.compare(i1, i2);</span><br><span class="line">    &#125;);</span><br><span class="line">    // Then respect @AutoConfigureBefore @AutoConfigureAfter</span><br><span class="line">    //检查@AutoConfigureBefore @AutoConfigureAfter规定的顺序是否满足</span><br><span class="line">    orderedClassNames = sortByAnnotation(classes, orderedClassNames);</span><br><span class="line">    return orderedClassNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法"><a href="#18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法" class="headerlink" title="18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法"></a>18、接（二、2）ConfigurationClassBeanDefinitionReader的loadBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void loadBeanDefinitions(Set&lt;ConfigurationClass&gt; configurationModel) &#123;</span><br><span class="line">    //条件注解处理器</span><br><span class="line">    TrackedConditionEvaluator trackedConditionEvaluator = new TrackedConditionEvaluator();</span><br><span class="line">    //遍历处理配置类</span><br><span class="line">    for (ConfigurationClass configClass : configurationModel) &#123;</span><br><span class="line">        loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法"><a href="#19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法" class="headerlink" title="19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法"></a>19、ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsForConfigurationClass(</span><br><span class="line">        ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) &#123;</span><br><span class="line">    //使用条件注解判断是否需要跳过这个配置类</span><br><span class="line">    if (trackedConditionEvaluator.shouldSkip(configClass)) &#123;</span><br><span class="line">        //跳过配置类则移除Spring容器中bean的注册</span><br><span class="line">        String beanName = configClass.getBeanName();</span><br><span class="line">        if (StringUtils.hasLength(beanName) &amp;&amp; this.registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">            this.registry.removeBeanDefinition(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        //从importRegistry进行删除</span><br><span class="line">        this.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //配置类是被@Import注释所import的，注册自己</span><br><span class="line">    if (configClass.isImported()) &#123;</span><br><span class="line">        registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line">    &#125;</span><br><span class="line">    //遍历BeanMethods,依次对其进行注册</span><br><span class="line">    for (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;</span><br><span class="line">        loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    //注册@ImportResource注解注释的资源文件中的bean</span><br><span class="line">    loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line">    //注册@Import注解中的ImportBeanDefinitionRegistrar接口的registerBeanDefinitions</span><br><span class="line">    loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法"><a href="#20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法" class="headerlink" title="20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法"></a>20、ConfigurationClassBeanDefinitionReader的registerBeanDefinitionForImportedConfigurationClass方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void registerBeanDefinitionForImportedConfigurationClass(ConfigurationClass configClass) &#123;</span><br><span class="line">    //根据configClass中配置的AnnotationMetadata 实例化AnnotatedGenericBeanDefinition</span><br><span class="line">    AnnotationMetadata metadata = configClass.getMetadata();</span><br><span class="line">    AnnotatedGenericBeanDefinition configBeanDef = new AnnotatedGenericBeanDefinition(metadata);</span><br><span class="line">    //解析并设置该configClass的Scope</span><br><span class="line">    ScopeMetadata scopeMetadata = scopeMetadataResolver.resolveScopeMetadata(configBeanDef);</span><br><span class="line">    configBeanDef.setScope(scopeMetadata.getScopeName());</span><br><span class="line">    //生成bean的id</span><br><span class="line">    String configBeanName = this.importBeanNameGenerator.generateBeanName(configBeanDef, this.registry);</span><br><span class="line">    //设置bean的一些属性,如LazyInit,Primary,DependsOn等</span><br><span class="line">    AnnotationConfigUtils.processCommonDefinitionAnnotations(configBeanDef, metadata);</span><br><span class="line">    //生成BeanDefinitionHolder,并对其尝试进行代理,最后向registry进行注册</span><br><span class="line">    BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(configBeanDef, configBeanName);</span><br><span class="line">    definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);</span><br><span class="line">    this.registry.registerBeanDefinition(definitionHolder.getBeanName(), definitionHolder.getBeanDefinition());</span><br><span class="line">    configClass.setBeanName(configBeanName);</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;Registered bean definition for imported class &apos;&quot; + configBeanName + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法"><a href="#21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法" class="headerlink" title="21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法"></a>21、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsForBeanMethod方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsForBeanMethod(BeanMethod beanMethod) &#123;</span><br><span class="line">    //获得声明该BeanMethod的ConfigurationClass</span><br><span class="line">    ConfigurationClass configClass = beanMethod.getConfigurationClass();</span><br><span class="line">    //获得BeanMethod的MethodMetadata和methodName</span><br><span class="line">    MethodMetadata metadata = beanMethod.getMetadata();</span><br><span class="line">    String methodName = metadata.getMethodName();</span><br><span class="line"></span><br><span class="line">    // Do we need to mark the bean as skipped by its condition?</span><br><span class="line">    //更具condition判断是否该跳过</span><br><span class="line">    if (this.conditionEvaluator.shouldSkip(metadata, ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        configClass.skippedBeanMethods.add(methodName);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    if (configClass.skippedBeanMethods.contains(methodName)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    //从@Bean中获得配置的names,如果names不为空的话,则第一个为bean的id,否则该方法名字作为bean的id</span><br><span class="line">    AnnotationAttributes bean = AnnotationConfigUtils.attributesFor(metadata, Bean.class);</span><br><span class="line">    Assert.state(bean != null, &quot;No @Bean annotation attributes&quot;);</span><br><span class="line"></span><br><span class="line">    // Consider name and any aliases</span><br><span class="line">    List&lt;String&gt; names = new ArrayList&lt;&gt;(Arrays.asList(bean.getStringArray(&quot;name&quot;)));</span><br><span class="line">    String beanName = (!names.isEmpty() ? names.remove(0) : methodName);</span><br><span class="line"></span><br><span class="line">    // Register aliases even when overridden</span><br><span class="line">    for (String alias : names) &#123;</span><br><span class="line">        this.registry.registerAlias(beanName, alias);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Has this effectively been overridden before (e.g. via XML)?</span><br><span class="line">    //重复定义,直接return</span><br><span class="line">    if (isOverriddenByExistingDefinition(beanMethod, beanName)) &#123;</span><br><span class="line">        if (beanName.equals(beanMethod.getConfigurationClass().getBeanName())) &#123;</span><br><span class="line">            throw new BeanDefinitionStoreException(beanMethod.getConfigurationClass().getResource().getDescription(),</span><br><span class="line">                    beanName, &quot;Bean name derived from @Bean method &apos;&quot; + beanMethod.getMetadata().getMethodName() +</span><br><span class="line">                    &quot;&apos; clashes with bean name for containing configuration class; please make those names unique!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConfigurationClassBeanDefinition beanDef = new ConfigurationClassBeanDefinition(configClass, metadata);</span><br><span class="line">    beanDef.setResource(configClass.getResource());</span><br><span class="line">    beanDef.setSource(this.sourceExtractor.extractSource(metadata, configClass.getResource()));</span><br><span class="line">    //该方法是静态的,则将methodName设置为工厂方法</span><br><span class="line">    if (metadata.isStatic()) &#123;</span><br><span class="line">        // static @Bean method</span><br><span class="line">        beanDef.setBeanClassName(configClass.getMetadata().getClassName());</span><br><span class="line">        beanDef.setFactoryMethodName(methodName);</span><br><span class="line">    &#125;</span><br><span class="line">    //实例方法,则将configClass的BeanName设置为FactoryBeanName,methodName设置为UniqueFactoryMethodName</span><br><span class="line">    else &#123;</span><br><span class="line">        // instance @Bean method</span><br><span class="line">        beanDef.setFactoryBeanName(configClass.getBeanName());</span><br><span class="line">        beanDef.setUniqueFactoryMethodName(methodName);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置AutowireMode为构造器注入</span><br><span class="line">    beanDef.setAutowireMode(RootBeanDefinition.AUTOWIRE_CONSTRUCTOR);</span><br><span class="line">    //设置skipRequiredCheck属性为true</span><br><span class="line">    beanDef.setAttribute(RequiredAnnotationBeanPostProcessor.SKIP_REQUIRED_CHECK_ATTRIBUTE, Boolean.TRUE);</span><br><span class="line">    //设置属性</span><br><span class="line">    AnnotationConfigUtils.processCommonDefinitionAnnotations(beanDef, metadata);</span><br><span class="line"></span><br><span class="line">    Autowire autowire = bean.getEnum(&quot;autowire&quot;);</span><br><span class="line">    if (autowire.isAutowire()) &#123;</span><br><span class="line">        beanDef.setAutowireMode(autowire.value());</span><br><span class="line">    &#125;</span><br><span class="line">    //设置InitMethod</span><br><span class="line">    String initMethodName = bean.getString(&quot;initMethod&quot;);</span><br><span class="line">    if (StringUtils.hasText(initMethodName)) &#123;</span><br><span class="line">        beanDef.setInitMethodName(initMethodName);</span><br><span class="line">    &#125;</span><br><span class="line">    //设置DestroyMethod</span><br><span class="line">    String destroyMethodName = bean.getString(&quot;destroyMethod&quot;);</span><br><span class="line">    beanDef.setDestroyMethodName(destroyMethodName);</span><br><span class="line"></span><br><span class="line">    // Consider scoping</span><br><span class="line">    //设置ScopedProxyMode</span><br><span class="line">    ScopedProxyMode proxyMode = ScopedProxyMode.NO;</span><br><span class="line">    AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(metadata, Scope.class);</span><br><span class="line">    if (attributes != null) &#123;</span><br><span class="line">        beanDef.setScope(attributes.getString(&quot;value&quot;));</span><br><span class="line">        proxyMode = attributes.getEnum(&quot;proxyMode&quot;);</span><br><span class="line">        if (proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">            proxyMode = ScopedProxyMode.NO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Replace the original bean definition with the target one, if necessary</span><br><span class="line">    //ScopedProxyMode不等于NO,则生成代理</span><br><span class="line">    BeanDefinition beanDefToRegister = beanDef;</span><br><span class="line">    if (proxyMode != ScopedProxyMode.NO) &#123;</span><br><span class="line">        BeanDefinitionHolder proxyDef = ScopedProxyCreator.createScopedProxy(</span><br><span class="line">                new BeanDefinitionHolder(beanDef, beanName), this.registry,</span><br><span class="line">                proxyMode == ScopedProxyMode.TARGET_CLASS);</span><br><span class="line">        beanDefToRegister = new ConfigurationClassBeanDefinition(</span><br><span class="line">                (RootBeanDefinition) proxyDef.getBeanDefinition(), configClass, metadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(String.format(&quot;Registering bean definition for @Bean method %s.%s()&quot;,</span><br><span class="line">                configClass.getMetadata().getClassName(), beanName));</span><br><span class="line">    &#125;</span><br><span class="line">    //进行注册</span><br><span class="line">    this.registry.registerBeanDefinition(beanName, beanDefToRegister);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法"><a href="#18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法" class="headerlink" title="18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法"></a>18、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromImportedResources方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsFromImportedResources(</span><br><span class="line">        Map&lt;String, Class&lt;? extends BeanDefinitionReader&gt;&gt; importedResources) &#123;</span><br><span class="line"></span><br><span class="line">    Map&lt;Class&lt;?&gt;, BeanDefinitionReader&gt; readerInstanceCache = new HashMap&lt;&gt;();</span><br><span class="line">    //遍历importedResources</span><br><span class="line">    importedResources.forEach((resource, readerClass) -&gt; &#123;</span><br><span class="line">        // Default reader selection necessary?</span><br><span class="line">        //选择BeanDefinitionReader</span><br><span class="line">        if (BeanDefinitionReader.class == readerClass) &#123;</span><br><span class="line">            //如果是.groovy,则使用GroovyBeanDefinitionReader</span><br><span class="line">            if (StringUtils.endsWithIgnoreCase(resource, &quot;.groovy&quot;)) &#123;</span><br><span class="line">                // When clearly asking for Groovy, that&apos;s what they&apos;ll get...</span><br><span class="line">                readerClass = GroovyBeanDefinitionReader.class;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                // Primarily &quot;.xml&quot; files but for any other extension as well</span><br><span class="line">                //否则为XmlBeanDefinitionReader,一般都是XmlBeanDefinitionReader</span><br><span class="line">                readerClass = XmlBeanDefinitionReader.class;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //从缓存里获取</span><br><span class="line">        BeanDefinitionReader reader = readerInstanceCache.get(readerClass);</span><br><span class="line">        //实例化一个reader</span><br><span class="line">        if (reader == null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // Instantiate the specified BeanDefinitionReader</span><br><span class="line">                reader = readerClass.getConstructor(BeanDefinitionRegistry.class).newInstance(this.registry);</span><br><span class="line">                // Delegate the current ResourceLoader to it if possible</span><br><span class="line">                if (reader instanceof AbstractBeanDefinitionReader) &#123;</span><br><span class="line">                    AbstractBeanDefinitionReader abdr = ((AbstractBeanDefinitionReader) reader);</span><br><span class="line">                    abdr.setResourceLoader(this.resourceLoader);</span><br><span class="line">                    abdr.setEnvironment(this.environment);</span><br><span class="line">                &#125;</span><br><span class="line">                readerInstanceCache.put(readerClass, reader);</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                throw new IllegalStateException(</span><br><span class="line">                        &quot;Could not instantiate BeanDefinitionReader class [&quot; + readerClass.getName() + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // TODO SPR-6310: qualify relative path locations as done in AbstractContextLoader.modifyLocations</span><br><span class="line">        //读取配置文件，与前文XmlBeanFactory中一样</span><br><span class="line">        reader.loadBeanDefinitions(resource);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法"><a href="#19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法" class="headerlink" title="19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法"></a>19、接（二、19）ConfigurationClassBeanDefinitionReader的loadBeanDefinitionsFromRegistrars方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private void loadBeanDefinitionsFromRegistrars(Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; registrars) &#123;</span><br><span class="line">    //将被注解的配置类的相关信息，注册到@Import的ImportBeanDefinitionRegistrar中</span><br><span class="line">    registrars.forEach((registrar, metadata) -&gt;</span><br><span class="line">            registrar.registerBeanDefinitions(metadata, this.registry));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里配置类解析就结束了，获取bean在前文AnnotationConfigApplicationContext中</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/27/spring源码/springboot源码启动过程/" data-id="cjix67neu001bb0uezzsusv61" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/06/27/spring源码/springboot源码默认注解/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          springboot源码@SpringBootApplication
        
      </div>
    </a>
  
  
    <a href="/2018/05/06/JUC源码/JUC集合(3)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">JUC集合(3)</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java-util-concurrent/">java.util.concurrent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis3/">mybatis3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码整合MyBatis/">spring源码整合MyBatis</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(2) /">spring源码XmlBeanFactory(2)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(1)/">spring源码XmlBeanFactory(1)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码Transaction/">spring源码Transaction</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码SpringMVC/">spring源码SpringMVC</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>