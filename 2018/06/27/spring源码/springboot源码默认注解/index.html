<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>springboot源码@SpringBootApplication | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="springboot源码@SpringBootApplication123456789101112@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@SpringBootConfiguration@EnableAutoConfiguration@ComponentScan(exclude">
<meta property="og:type" content="article">
<meta property="og:title" content="springboot源码@SpringBootApplication">
<meta property="og:url" content="http://yoursite.com/2018/06/27/spring源码/springboot源码默认注解/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="springboot源码@SpringBootApplication123456789101112@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@SpringBootConfiguration@EnableAutoConfiguration@ComponentScan(exclude">
<meta property="og:updated_time" content="2018-06-27T13:00:31.399Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="springboot源码@SpringBootApplication">
<meta name="twitter:description" content="springboot源码@SpringBootApplication123456789101112@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@SpringBootConfiguration@EnableAutoConfiguration@ComponentScan(exclude">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-spring源码/springboot源码默认注解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/27/spring源码/springboot源码默认注解/" class="article-date">
  <time datetime="2018-06-27T13:10:29.014Z" itemprop="datePublished">2018-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/spring/">spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      springboot源码@SpringBootApplication
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="springboot源码-SpringBootApplication"><a href="#springboot源码-SpringBootApplication" class="headerlink" title="springboot源码@SpringBootApplication"></a>springboot源码@SpringBootApplication</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@SpringBootConfiguration</span><br><span class="line">@EnableAutoConfiguration</span><br><span class="line">@ComponentScan(excludeFilters = &#123;</span><br><span class="line">        @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="line">public @interface SpringBootApplication &#123;</span><br><span class="line">    。。。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一、-SpringBootConfiguration注解"><a href="#一、-SpringBootConfiguration注解" class="headerlink" title="一、@SpringBootConfiguration注解"></a>一、@SpringBootConfiguration注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//ElementType.TYPE表示SpringBootConfiguration注解作用于接口、类、枚举类</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">//RetentionPolicy.RUNTIME表示SpringBootConfiguration注解信息保留至运行时</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">//表示@SpringBootConfiguration注解会被javadoc工具提取成文档</span><br><span class="line">@Documented</span><br><span class="line">//被本注解或组合注解，注解的类是springboot的配置类</span><br><span class="line">@Configuration</span><br><span class="line">public @interface SpringBootConfiguration &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1、-Target注解"><a href="#1、-Target注解" class="headerlink" title="1、@Target注解"></a>1、@Target注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">//ElementType.ANNOTATION_TYPE表示Target只能作用于注解类</span><br><span class="line">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="line">public @interface Target &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Returns an array of the kinds of elements an annotation type</span><br><span class="line">     * can be applied to.</span><br><span class="line">     * @return an array of the kinds of elements an annotation type</span><br><span class="line">     * can be applied to</span><br><span class="line">     */</span><br><span class="line">    ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、-Retention注解"><a href="#2、-Retention注解" class="headerlink" title="2、@Retention注解"></a>2、@Retention注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Documented</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.ANNOTATION_TYPE)</span><br><span class="line">public @interface Retention &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Returns the retention policy.</span><br><span class="line">     * @return the retention policy</span><br><span class="line">     */</span><br><span class="line">    RetentionPolicy value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、-Configuration注解"><a href="#3、-Configuration注解" class="headerlink" title="3、@Configuration注解"></a>3、@Configuration注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//被本注解或组合注解，注解的类能被过滤器获取</span><br><span class="line">@Component</span><br><span class="line">public @interface Configuration &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Explicitly specify the name of the Spring bean definition associated</span><br><span class="line">     * with this Configuration class. If left unspecified (the common case),</span><br><span class="line">     * a bean name will be automatically generated.</span><br><span class="line">     * &lt;p&gt;The custom name applies only if the Configuration class is picked up via</span><br><span class="line">     * component scanning or supplied directly to a &#123;@link AnnotationConfigApplicationContext&#125;.</span><br><span class="line">     * If the Configuration class is registered as a traditional XML bean definition,</span><br><span class="line">     * the name/id of the bean element will take precedence.</span><br><span class="line">     * @return the suggested component name, if any (or empty String otherwise)</span><br><span class="line">     * @see org.springframework.beans.factory.support.DefaultBeanNameGenerator</span><br><span class="line">     */</span><br><span class="line">    @AliasFor(annotation = Component.class)</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、-EnableAutoConfiguration注解"><a href="#二、-EnableAutoConfiguration注解" class="headerlink" title="二、@EnableAutoConfiguration注解"></a>二、@EnableAutoConfiguration注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//EnableAutoConfiguration作用于一个class，则被用于该class的子类</span><br><span class="line">@Inherited</span><br><span class="line">//</span><br><span class="line">@AutoConfigurationPackage</span><br><span class="line">//</span><br><span class="line">@Import(AutoConfigurationImportSelector.class)</span><br><span class="line">public @interface EnableAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Exclude specific auto-configuration classes such that they will never be applied.</span><br><span class="line">     * @return the classes to exclude</span><br><span class="line">     */</span><br><span class="line">    Class&lt;?&gt;[] exclude() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Exclude specific auto-configuration class names such that they will never be</span><br><span class="line">     * applied.</span><br><span class="line">     * @return the class names to exclude</span><br><span class="line">     * @since 1.3.0</span><br><span class="line">     */</span><br><span class="line">    String[] excludeName() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1、-AutoConfigurationPackage注解"><a href="#1、-AutoConfigurationPackage注解" class="headerlink" title="1、@AutoConfigurationPackage注解"></a>1、@AutoConfigurationPackage注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@Import(AutoConfigurationPackages.Registrar.class)</span><br><span class="line">public @interface AutoConfigurationPackage &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法"><a href="#2、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法" class="headerlink" title="2、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法"></a>2、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata metadata,</span><br><span class="line">        BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    //注册配置类的包名</span><br><span class="line">    register(registry, new PackageImport(metadata).getPackageName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法"><a href="#3、AutoConfigurationPackages-Registrar的registerBeanDefinitions方法" class="headerlink" title="3、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法"></a>3、AutoConfigurationPackages.Registrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static void register(BeanDefinitionRegistry registry, String... packageNames) &#123;</span><br><span class="line">    if (registry.containsBeanDefinition(BEAN)) &#123;</span><br><span class="line">        BeanDefinition beanDefinition = registry.getBeanDefinition(BEAN);</span><br><span class="line">        ConstructorArgumentValues constructorArguments = beanDefinition</span><br><span class="line">                .getConstructorArgumentValues();</span><br><span class="line">        constructorArguments.addIndexedArgumentValue(0,</span><br><span class="line">                addBasePackages(constructorArguments, packageNames));</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        GenericBeanDefinition beanDefinition = new GenericBeanDefinition();</span><br><span class="line">        beanDefinition.setBeanClass(BasePackages.class);</span><br><span class="line">        beanDefinition.getConstructorArgumentValues().addIndexedArgumentValue(0,</span><br><span class="line">                packageNames);</span><br><span class="line">        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">        //配置类的包，注册为基础包</span><br><span class="line">        registry.registerBeanDefinition(BEAN, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、AutoConfigurationImportSelector的selectImports方法"><a href="#4、AutoConfigurationImportSelector的selectImports方法" class="headerlink" title="4、AutoConfigurationImportSelector的selectImports方法"></a>4、AutoConfigurationImportSelector的selectImports方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">    if (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        return NO_IMPORTS;</span><br><span class="line">    &#125;</span><br><span class="line">    //从配置文件&quot;META-INF/spring-autoconfigure-metadata.properties&quot;中加载配置</span><br><span class="line">    AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">            .loadMetadata(this.beanClassLoader);</span><br><span class="line">    //获取注解的EnableAutoConfiguration注解值信息</span><br><span class="line">    AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">    //从&quot;META-INF\spring.factories&quot;中获取自动配类</span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,</span><br><span class="line">            attributes);</span><br><span class="line">    //去重</span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    //获取EnableAutoConfiguration中的或配置中要去除的自动配置类</span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    //检查是否有无效的排除类</span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    //删除排除的配置类</span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    //应用过滤器</span><br><span class="line">    configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">    //广播事件 AutoConfigurationImportEvent</span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    return StringUtils.toStringArray(configurations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>META-INF\spring.factories<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.cloud.CloudAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.elasticsearch.jest.JestAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.reactor.core.ReactorCoreAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration</span><br></pre></td></tr></table></figure></p>
<h4 id="5、AutoConfigurationImportSelector的filter方法"><a href="#5、AutoConfigurationImportSelector的filter方法" class="headerlink" title="5、AutoConfigurationImportSelector的filter方法"></a>5、AutoConfigurationImportSelector的filter方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">private List&lt;String&gt; filter(List&lt;String&gt; configurations,</span><br><span class="line">        AutoConfigurationMetadata autoConfigurationMetadata) &#123;</span><br><span class="line">    long startTime = System.nanoTime();</span><br><span class="line">    String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">    boolean[] skip = new boolean[candidates.length];</span><br><span class="line">    boolean skipped = false;</span><br><span class="line">    //从配置&quot;META-INF\spring.factories&quot;中获取过滤器OnClassCondition</span><br><span class="line">    for (AutoConfigurationImportFilter filter : getAutoConfigurationImportFilters()) &#123;</span><br><span class="line">        //设置相应的资源</span><br><span class="line">        invokeAwareMethods(filter);</span><br><span class="line">        //是否匹配</span><br><span class="line">        boolean[] match = filter.match(candidates, autoConfigurationMetadata);</span><br><span class="line">        //不匹配须过滤</span><br><span class="line">        for (int i = 0; i &lt; match.length; i++) &#123;</span><br><span class="line">            if (!match[i]) &#123;</span><br><span class="line">                skip[i] = true;</span><br><span class="line">                skipped = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //全部匹配</span><br><span class="line">    if (!skipped) &#123;</span><br><span class="line">        return configurations;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; result = new ArrayList&lt;&gt;(candidates.length);</span><br><span class="line">    for (int i = 0; i &lt; candidates.length; i++) &#123;</span><br><span class="line">        //判断是否跳过</span><br><span class="line">        if (!skip[i]) &#123;</span><br><span class="line">            result.add(candidates[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">        int numberFiltered = configurations.size() - result.size();</span><br><span class="line">        logger.trace(&quot;Filtered &quot; + numberFiltered + &quot; auto configuration class in &quot;</span><br><span class="line">                + TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTime)</span><br><span class="line">                + &quot; ms&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return new ArrayList&lt;&gt;(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>META-INF\spring.factories<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configuration Import Filters</span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter=\</span><br><span class="line">org.springframework.boot.autoconfigure.condition.OnClassCondition</span><br></pre></td></tr></table></figure></p>
<h4 id="6、OnClassCondition的match方法"><a href="#6、OnClassCondition的match方法" class="headerlink" title="6、OnClassCondition的match方法"></a>6、OnClassCondition的match方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean[] match(String[] autoConfigurationClasses,</span><br><span class="line">        AutoConfigurationMetadata autoConfigurationMetadata) &#123;</span><br><span class="line">    ConditionEvaluationReport report = getConditionEvaluationReport();</span><br><span class="line">    //查看配置&quot;META-INF/spring-autoconfigure-metadata.properties&quot;中，配置的ConditionalOnClass，在依赖中是否存在</span><br><span class="line">    ConditionOutcome[] outcomes = getOutcomes(autoConfigurationClasses,</span><br><span class="line">            autoConfigurationMetadata);</span><br><span class="line">    boolean[] match = new boolean[outcomes.length];</span><br><span class="line">    for (int i = 0; i &lt; outcomes.length; i++) &#123;</span><br><span class="line">        //匹配结果</span><br><span class="line">        match[i] = (outcomes[i] == null || outcomes[i].isMatch());</span><br><span class="line">        if (!match[i] &amp;&amp; outcomes[i] != null) &#123;</span><br><span class="line">            logOutcome(autoConfigurationClasses[i], outcomes[i]);</span><br><span class="line">            if (report != null) &#123;</span><br><span class="line">                report.recordConditionEvaluation(autoConfigurationClasses[i], this,</span><br><span class="line">                        outcomes[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return match;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="三、-ComponentScan注解"><a href="#三、-ComponentScan注解" class="headerlink" title="三、@ComponentScan注解"></a>三、@ComponentScan注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Documented</span><br><span class="line">//ComponentScan注解可重复注解</span><br><span class="line">@Repeatable(ComponentScans.class)</span><br><span class="line">public @interface ComponentScan &#123;</span><br><span class="line">    。。。</span><br><span class="line">    /**</span><br><span class="line">     * Specifies which types are eligible for component scanning.</span><br><span class="line">     * &lt;p&gt;Further narrows the set of candidate components from everything in &#123;@link #basePackages&#125;</span><br><span class="line">     * to everything in the base packages that matches the given filter or filters.</span><br><span class="line">     * &lt;p&gt;Note that these filters will be applied in addition to the default filters, if specified.</span><br><span class="line">     * Any type under the specified base packages which matches a given filter will be included,</span><br><span class="line">     * even if it does not match the default filters (i.e. is not annotated with &#123;@code @Component&#125;).</span><br><span class="line">     * @see #resourcePattern()</span><br><span class="line">     * @see #useDefaultFilters()</span><br><span class="line">     */</span><br><span class="line">    //过滤器</span><br><span class="line">    Filter[] includeFilters() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies which types are not eligible for component scanning.</span><br><span class="line">     * @see #resourcePattern</span><br><span class="line">     */</span><br><span class="line">    //过滤器</span><br><span class="line">    Filter[] excludeFilters() default &#123;&#125;;</span><br><span class="line">    。。。</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<h4 id="1、TypeExcludeFilter的match方法"><a href="#1、TypeExcludeFilter的match方法" class="headerlink" title="1、TypeExcludeFilter的match方法"></a>1、TypeExcludeFilter的match方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean match(MetadataReader metadataReader,</span><br><span class="line">        MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">    if (this.beanFactory instanceof ListableBeanFactory</span><br><span class="line">            &amp;&amp; getClass() == TypeExcludeFilter.class) &#123;</span><br><span class="line">        //获取容器中的TypeExcludeFilter</span><br><span class="line">        Collection&lt;TypeExcludeFilter&gt; delegates = ((ListableBeanFactory) this.beanFactory)</span><br><span class="line">                .getBeansOfType(TypeExcludeFilter.class).values();</span><br><span class="line">        //有一个能能匹配则反回true</span><br><span class="line">        for (TypeExcludeFilter delegate : delegates) &#123;</span><br><span class="line">            if (delegate.match(metadataReader, metadataReaderFactory)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、AutoConfigurationExcludeFilter的match方法"><a href="#2、AutoConfigurationExcludeFilter的match方法" class="headerlink" title="2、AutoConfigurationExcludeFilter的match方法"></a>2、AutoConfigurationExcludeFilter的match方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean match(MetadataReader metadataReader,</span><br><span class="line">        MetadataReaderFactory metadataReaderFactory) throws IOException &#123;</span><br><span class="line">    //是配置类,并且是自动配置类，返回ture，即不扫描自动配置类</span><br><span class="line">    return isConfiguration(metadataReader) &amp;&amp; isAutoConfiguration(metadataReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、AopAutoConfiguration自动配置类"><a href="#四、AopAutoConfiguration自动配置类" class="headerlink" title="四、AopAutoConfiguration自动配置类"></a>四、AopAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">//条件注解，EnableAspectJAutoProxy、Aspect、Advice类存在，才能解析此配置类</span><br><span class="line">@ConditionalOnClass(&#123; EnableAspectJAutoProxy.class, Aspect.class, Advice.class,</span><br><span class="line">     AnnotatedElement.class &#125;)</span><br><span class="line">//配置文件中存在&quot;spring.aop.auto=true&quot;才能解析此配置类</span><br><span class="line">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">public class AopAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //创建AnnotationAwareAspectJAutoProxyCreator，采用Jdk动态代理</span><br><span class="line">    @EnableAspectJAutoProxy(proxyTargetClass = false)</span><br><span class="line">    //配置文件中存在&quot;spring.aop.proxy-target-class=false&quot;才能解析此配置类</span><br><span class="line">    @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;, matchIfMissing = false)</span><br><span class="line">    public static class JdkDynamicAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //创建AnnotationAwareAspectJAutoProxyCreator，采用Cglib动态代理</span><br><span class="line">    @EnableAspectJAutoProxy(proxyTargetClass = true)</span><br><span class="line">    //配置文件中存在&quot;spring.aop.proxy-target-class=true&quot;才能解析此配置类</span><br><span class="line">    @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">    public static class CglibAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1、-ConditionalOnClass注解"><a href="#1、-ConditionalOnClass注解" class="headerlink" title="1、@ConditionalOnClass注解"></a>1、@ConditionalOnClass注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//条件注解</span><br><span class="line">@Conditional(OnClassCondition.class)</span><br><span class="line">public @interface ConditionalOnClass &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The classes that must be present. Since this annotation is parsed by loading class</span><br><span class="line">     * bytecode, it is safe to specify classes here that may ultimately not be on the</span><br><span class="line">     * classpath, only if this annotation is directly on the affected component and</span><br><span class="line">     * &lt;b&gt;not&lt;/b&gt; if this annotation is used as a composed, meta-annotation. In order to</span><br><span class="line">     * use this annotation as a meta-annotation, only use the &#123;@link #name&#125; attribute.</span><br><span class="line">     * @return the classes that must be present</span><br><span class="line">     */</span><br><span class="line">    Class&lt;?&gt;[] value() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The classes names that must be present.</span><br><span class="line">     * @return the class names that must be present.</span><br><span class="line">     */</span><br><span class="line">    String[] name() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、SpringBootCondition的matches方法"><a href="#2、SpringBootCondition的matches方法" class="headerlink" title="2、SpringBootCondition的matches方法"></a>2、SpringBootCondition的matches方法</h4><p>OnClassCondition的父类，返回true则表示满足条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final boolean matches(ConditionContext context,</span><br><span class="line">        AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">    String classOrMethodName = getClassOrMethodName(metadata);</span><br><span class="line">    try &#123;</span><br><span class="line">        //获取条件是否满足</span><br><span class="line">        ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br><span class="line">        logOutcome(classOrMethodName, outcome);</span><br><span class="line">        recordEvaluation(context, classOrMethodName, outcome);</span><br><span class="line">        return outcome.isMatch();</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoClassDefFoundError ex) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;Could not evaluate condition on &quot; + classOrMethodName + &quot; due to &quot;</span><br><span class="line">                        + ex.getMessage() + &quot; not &quot;</span><br><span class="line">                        + &quot;found. Make sure your own configuration does not rely on &quot;</span><br><span class="line">                        + &quot;that class. This can also happen if you are &quot;</span><br><span class="line">                        + &quot;@ComponentScanning a springframework package (e.g. if you &quot;</span><br><span class="line">                        + &quot;put a @ComponentScan in the default package by mistake)&quot;,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (RuntimeException ex) &#123;</span><br><span class="line">        throw new IllegalStateException(</span><br><span class="line">                &quot;Error processing condition on &quot; + getName(metadata), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、OnClassCondition的getMatchOutcome方法"><a href="#3、OnClassCondition的getMatchOutcome方法" class="headerlink" title="3、OnClassCondition的getMatchOutcome方法"></a>3、OnClassCondition的getMatchOutcome方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ConditionOutcome getMatchOutcome(ConditionContext context,</span><br><span class="line">        AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">    ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">    ConditionMessage matchMessage = ConditionMessage.empty();</span><br><span class="line">    //获取需要存在的类</span><br><span class="line">    List&lt;String&gt; onClasses = getCandidates(metadata, ConditionalOnClass.class);</span><br><span class="line">    if (onClasses != null) &#123;</span><br><span class="line">        //获取需要存在但不存在的类</span><br><span class="line">        List&lt;String&gt; missing = getMatches(onClasses, MatchType.MISSING, classLoader);</span><br><span class="line">        if (!missing.isEmpty()) &#123;</span><br><span class="line">            //条件不满足</span><br><span class="line">            return ConditionOutcome</span><br><span class="line">                    .noMatch(ConditionMessage.forCondition(ConditionalOnClass.class)</span><br><span class="line">                            .didNotFind(&quot;required class&quot;, &quot;required classes&quot;)</span><br><span class="line">                            .items(Style.QUOTE, missing));</span><br><span class="line">        &#125;</span><br><span class="line">        matchMessage = matchMessage.andCondition(ConditionalOnClass.class)</span><br><span class="line">                .found(&quot;required class&quot;, &quot;required classes&quot;).items(Style.QUOTE,</span><br><span class="line">                        getMatches(onClasses, MatchType.PRESENT, classLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    //获取需要不存在的类</span><br><span class="line">    List&lt;String&gt; onMissingClasses = getCandidates(metadata,</span><br><span class="line">            ConditionalOnMissingClass.class);</span><br><span class="line">    if (onMissingClasses != null) &#123;</span><br><span class="line">        List&lt;String&gt; present = getMatches(onMissingClasses, MatchType.PRESENT,</span><br><span class="line">                classLoader);</span><br><span class="line">        if (!present.isEmpty()) &#123;</span><br><span class="line">            return ConditionOutcome.noMatch(</span><br><span class="line">                    ConditionMessage.forCondition(ConditionalOnMissingClass.class)</span><br><span class="line">                            .found(&quot;unwanted class&quot;, &quot;unwanted classes&quot;)</span><br><span class="line">                            .items(Style.QUOTE, present));</span><br><span class="line">        &#125;</span><br><span class="line">        matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class)</span><br><span class="line">                .didNotFind(&quot;unwanted class&quot;, &quot;unwanted classes&quot;).items(Style.QUOTE,</span><br><span class="line">                        getMatches(onMissingClasses, MatchType.MISSING, classLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    //满足条件</span><br><span class="line">    return ConditionOutcome.match(matchMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、-EnableAspectJAutoProxy注解"><a href="#4、-EnableAspectJAutoProxy注解" class="headerlink" title="4、@EnableAspectJAutoProxy注解"></a>4、@EnableAspectJAutoProxy注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(AspectJAutoProxyRegistrar.class)</span><br><span class="line">public @interface EnableAspectJAutoProxy &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed</span><br><span class="line">     * to standard Java interface-based proxies. The default is &#123;@code false&#125;.</span><br><span class="line">     */</span><br><span class="line">    boolean proxyTargetClass() default false;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Indicate that the proxy should be exposed by the AOP framework as a &#123;@code ThreadLocal&#125;</span><br><span class="line">     * for retrieval via the &#123;@link org.springframework.aop.framework.AopContext&#125; class.</span><br><span class="line">     * Off by default, i.e. no guarantees that &#123;@code AopContext&#125; access will work.</span><br><span class="line">     * @since 4.3.1</span><br><span class="line">     */</span><br><span class="line">    boolean exposeProxy() default false;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法"><a href="#5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法" class="headerlink" title="5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法"></a>5、AspectJAutoProxyRegistrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(</span><br><span class="line">        AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    //注册AnnotationAwareAspectJAutoProxyCreator</span><br><span class="line">    AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span><br><span class="line">    //获取EnableAspectJAutoProxy注解的值</span><br><span class="line">    AnnotationAttributes enableAspectJAutoProxy =</span><br><span class="line">            AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);</span><br><span class="line">    //设置proxyTargetClass和exposeProxy属性</span><br><span class="line">    if (enableAspectJAutoProxy != null) &#123;</span><br><span class="line">        if (enableAspectJAutoProxy.getBoolean(&quot;proxyTargetClass&quot;)) &#123;</span><br><span class="line">            AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">        &#125;</span><br><span class="line">        if (enableAspectJAutoProxy.getBoolean(&quot;exposeProxy&quot;)) &#123;</span><br><span class="line">            AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="五、DataSourceAutoConfiguration自动配置类"><a href="#五、DataSourceAutoConfiguration自动配置类" class="headerlink" title="五、DataSourceAutoConfiguration自动配置类"></a>五、DataSourceAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">//条件注解，须存在DataSource、EmbeddedDatabaseType类,才解析该配置类</span><br><span class="line">@ConditionalOnClass(&#123; DataSource.class, EmbeddedDatabaseType.class &#125;)</span><br><span class="line">//自动配置数据源属性</span><br><span class="line">@EnableConfigurationProperties(DataSourceProperties.class)</span><br><span class="line">//注入配置类</span><br><span class="line">//DataSourcePoolMetadataProvidersConfiguration创建DataSourcePoolMetadata，如TomcatDataSourcePoolMetadata</span><br><span class="line">//DataSourceInitializationConfiguration注册DataSourceInitializerPostProcessor处理器</span><br><span class="line">@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class,</span><br><span class="line">        DataSourceInitializationConfiguration.class &#125;)</span><br><span class="line">public class DataSourceAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //条件注解，须存在内置数据库连接EmbeddedDatabaseConnection类,才解析该配置类</span><br><span class="line">    @Conditional(EmbeddedDatabaseCondition.class)</span><br><span class="line">    //条件注解，不存在DataSource、XADataSource对象,才解析该配置类</span><br><span class="line">    @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span><br><span class="line">    //注入配置类，该配置类创建内置数据源EmbeddedDatabase</span><br><span class="line">    @Import(EmbeddedDataSourceConfiguration.class)</span><br><span class="line">    protected static class EmbeddedDatabaseConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //条件注解，须存在&quot;com.zaxxer.hikari.HikariDataSource&quot;或</span><br><span class="line">    //&quot;org.apache.tomcat.jdbc.pool.DataSource&quot;或</span><br><span class="line">    //&quot;org.apache.commons.dbcp2.BasicDataSource&quot;类,才解析该配置类</span><br><span class="line">    @Conditional(PooledDataSourceCondition.class)</span><br><span class="line">    //条件注解，不存在DataSource、XADataSource对象,才解析该配置类</span><br><span class="line">    @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span><br><span class="line">    //注入配置类</span><br><span class="line">    //如DataSourceConfiguration.Tomcat.class，创建org.apache.tomcat.jdbc.pool.DataSource数据源</span><br><span class="line">    @Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span><br><span class="line">            DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.Generic.class,</span><br><span class="line">            DataSourceJmxConfiguration.class &#125;)</span><br><span class="line">    protected static class PooledDataSourceConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    。。。</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<h4 id="1、-EnableConfigurationProperties注解"><a href="#1、-EnableConfigurationProperties注解" class="headerlink" title="1、@EnableConfigurationProperties注解"></a>1、@EnableConfigurationProperties注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">//注入ConfigurationPropertiesBeanRegistrar、ConfigurationPropertiesBindingPostProcessorRegistrar</span><br><span class="line">//ConfigurationPropertiesBeanRegistrar注册DataSourceProperties的bean</span><br><span class="line">//ConfigurationPropertiesBindingPostProcessorRegistrar注册ConfigurationPropertiesBindingPostProcessor属性绑定处理器</span><br><span class="line">@Import(EnableConfigurationPropertiesImportSelector.class)</span><br><span class="line">public @interface EnableConfigurationProperties &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Convenient way to quickly register &#123;@link ConfigurationProperties&#125; annotated beans</span><br><span class="line">     * with Spring. Standard Spring Beans will also be scanned regardless of this value.</span><br><span class="line">     * @return &#123;@link ConfigurationProperties&#125; annotated beans to register</span><br><span class="line">     */</span><br><span class="line">    Class&lt;?&gt;[] value() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法"><a href="#2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法" class="headerlink" title="2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法"></a>2、ConfigurationPropertiesBindingPostProcessor的postProcessBeforeInitialization方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object postProcessBeforeInitialization(Object bean, String beanName)</span><br><span class="line">        throws BeansException &#123;</span><br><span class="line">    //获取bean的ConfigurationProperties注解</span><br><span class="line">    ConfigurationProperties annotation = getAnnotation(bean, beanName,</span><br><span class="line">            ConfigurationProperties.class);</span><br><span class="line">    //存在该注解</span><br><span class="line">    if (annotation != null) &#123;</span><br><span class="line">        //绑定属性</span><br><span class="line">        bind(bean, beanName, annotation);</span><br><span class="line">    &#125;</span><br><span class="line">    return bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、ConfigurationPropertiesBindingPostProcessor的bind方法"><a href="#3、ConfigurationPropertiesBindingPostProcessor的bind方法" class="headerlink" title="3、ConfigurationPropertiesBindingPostProcessor的bind方法"></a>3、ConfigurationPropertiesBindingPostProcessor的bind方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private void bind(Object bean, String beanName, ConfigurationProperties annotation) &#123;</span><br><span class="line">    //获取bean的类型</span><br><span class="line">    ResolvableType type = getBeanType(bean, beanName);</span><br><span class="line">    //获取类的@Validated</span><br><span class="line">    Validated validated = getAnnotation(bean, beanName, Validated.class);</span><br><span class="line">    Annotation[] annotations = (validated != null</span><br><span class="line">            ? new Annotation[] &#123; annotation, validated &#125;</span><br><span class="line">            : new Annotation[] &#123; annotation &#125;);</span><br><span class="line">    //绑定属性的对象</span><br><span class="line">    Bindable&lt;?&gt; target = Bindable.of(type).withExistingValue(bean)</span><br><span class="line">            .withAnnotations(annotations);</span><br><span class="line">    try &#123;</span><br><span class="line">        //绑定属性</span><br><span class="line">        this.configurationPropertiesBinder.bind(target);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex) &#123;</span><br><span class="line">        throw new ConfigurationPropertiesBindException(beanName, bean, annotation,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、DataSourceProperties连接池属性"><a href="#4、DataSourceProperties连接池属性" class="headerlink" title="4、DataSourceProperties连接池属性"></a>4、DataSourceProperties连接池属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//属性前缀</span><br><span class="line">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span><br><span class="line">public class DataSourceProperties implements BeanClassLoaderAware, InitializingBean &#123;</span><br><span class="line">    ...</span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">        //获取内置数据库连接</span><br><span class="line">        this.embeddedDatabaseConnection = EmbeddedDatabaseConnection</span><br><span class="line">            .get(this.classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //创建数据库连接池</span><br><span class="line">    public DataSourceBuilder&lt;?&gt; initializeDataSourceBuilder() &#123;</span><br><span class="line">        return DataSourceBuilder.create(getClassLoader()).type(getType())</span><br><span class="line">                .driverClassName(determineDriverClassName()).url(determineUrl())</span><br><span class="line">                .username(determineUsername()).password(determinePassword());</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<h4 id="5、DataSourceConfiguration-Tomcat-class"><a href="#5、DataSourceConfiguration-Tomcat-class" class="headerlink" title="5、DataSourceConfiguration.Tomcat.class"></a>5、DataSourceConfiguration.Tomcat.class</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//条件注解</span><br><span class="line">@ConditionalOnClass(org.apache.tomcat.jdbc.pool.DataSource.class)</span><br><span class="line">//条件注解</span><br><span class="line">@ConditionalOnProperty(name = &quot;spring.datasource.type&quot;, havingValue = &quot;org.apache.tomcat.jdbc.pool.DataSource&quot;, matchIfMissing = true)</span><br><span class="line">static class Tomcat extends DataSourceConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource.tomcat&quot;)</span><br><span class="line">    //创建数据源</span><br><span class="line">    public org.apache.tomcat.jdbc.pool.DataSource dataSource(</span><br><span class="line">            DataSourceProperties properties) &#123;</span><br><span class="line">        //创建连接池</span><br><span class="line">        org.apache.tomcat.jdbc.pool.DataSource dataSource = createDataSource(</span><br><span class="line">                properties, org.apache.tomcat.jdbc.pool.DataSource.class);</span><br><span class="line">        //获取数据库驱动</span><br><span class="line">        DatabaseDriver databaseDriver = DatabaseDriver</span><br><span class="line">                .fromJdbcUrl(properties.determineUrl());</span><br><span class="line">        String validationQuery = databaseDriver.getValidationQuery();</span><br><span class="line">        if (validationQuery != null) &#123;</span><br><span class="line">            dataSource.setTestOnBorrow(true);</span><br><span class="line">            dataSource.setValidationQuery(validationQuery);</span><br><span class="line">        &#125;</span><br><span class="line">        return dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="六、DataSourceTransactionManagerAutoConfiguration自动配置类"><a href="#六、DataSourceTransactionManagerAutoConfiguration自动配置类" class="headerlink" title="六、DataSourceTransactionManagerAutoConfiguration自动配置类"></a>六、DataSourceTransactionManagerAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">//条件注解</span><br><span class="line">@ConditionalOnClass(&#123; JdbcTemplate.class, PlatformTransactionManager.class &#125;)</span><br><span class="line">//自动配置优先级</span><br><span class="line">@AutoConfigureOrder(Ordered.LOWEST_PRECEDENCE)</span><br><span class="line">//自动配置数据源属性</span><br><span class="line">@EnableConfigurationProperties(DataSourceProperties.class)</span><br><span class="line">public class DataSourceTransactionManagerAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    //条件注解，只有一个数据源</span><br><span class="line">    @ConditionalOnSingleCandidate(DataSource.class)</span><br><span class="line">    static class DataSourceTransactionManagerConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        private final DataSource dataSource;</span><br><span class="line"></span><br><span class="line">        private final TransactionManagerCustomizers transactionManagerCustomizers;</span><br><span class="line"></span><br><span class="line">        DataSourceTransactionManagerConfiguration(DataSource dataSource,</span><br><span class="line">                ObjectProvider&lt;TransactionManagerCustomizers&gt; transactionManagerCustomizers) &#123;</span><br><span class="line">            this.dataSource = dataSource;</span><br><span class="line">            this.transactionManagerCustomizers = transactionManagerCustomizers</span><br><span class="line">                    .getIfAvailable();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Bean</span><br><span class="line">        //条件注解</span><br><span class="line">        @ConditionalOnMissingBean(PlatformTransactionManager.class)</span><br><span class="line">        //创建数据源事务管理器</span><br><span class="line">        public DataSourceTransactionManager transactionManager(</span><br><span class="line">                DataSourceProperties properties) &#123;</span><br><span class="line">            DataSourceTransactionManager transactionManager = new DataSourceTransactionManager(</span><br><span class="line">                    this.dataSource);</span><br><span class="line">            if (this.transactionManagerCustomizers != null) &#123;</span><br><span class="line">                this.transactionManagerCustomizers.customize(transactionManager);</span><br><span class="line">            &#125;</span><br><span class="line">            return transactionManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="七、DataSourceTransactionManagerAutoConfiguration自动配置类"><a href="#七、DataSourceTransactionManagerAutoConfiguration自动配置类" class="headerlink" title="七、DataSourceTransactionManagerAutoConfiguration自动配置类"></a>七、DataSourceTransactionManagerAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(PlatformTransactionManager.class)</span><br><span class="line">//检查解析配置类顺序</span><br><span class="line">@AutoConfigureAfter(&#123; JtaAutoConfiguration.class, HibernateJpaAutoConfiguration.class,</span><br><span class="line">        DataSourceTransactionManagerAutoConfiguration.class,</span><br><span class="line">        Neo4jDataAutoConfiguration.class &#125;)</span><br><span class="line">//自动配置事务属性</span><br><span class="line">@EnableConfigurationProperties(TransactionProperties.class)</span><br><span class="line">public class TransactionAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    //创建初始化器</span><br><span class="line">    public TransactionManagerCustomizers platformTransactionManagerCustomizers(</span><br><span class="line">            ObjectProvider&lt;List&lt;PlatformTransactionManagerCustomizer&lt;?&gt;&gt;&gt; customizers) &#123;</span><br><span class="line">        return new TransactionManagerCustomizers(customizers.getIfAvailable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    @ConditionalOnSingleCandidate(PlatformTransactionManager.class)</span><br><span class="line">    public static class TransactionTemplateConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        private final PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">        public TransactionTemplateConfiguration(</span><br><span class="line">                PlatformTransactionManager transactionManager) &#123;</span><br><span class="line">            this.transactionManager = transactionManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Bean</span><br><span class="line">        @ConditionalOnMissingBean</span><br><span class="line">        //编程式事务</span><br><span class="line">        public TransactionTemplate transactionTemplate() &#123;</span><br><span class="line">            return new TransactionTemplate(this.transactionManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Configuration</span><br><span class="line">    @ConditionalOnBean(PlatformTransactionManager.class)</span><br><span class="line">    //不存在该bean，说明未解析事务配置类</span><br><span class="line">    @ConditionalOnMissingBean(AbstractTransactionManagementConfiguration.class)</span><br><span class="line">    public static class EnableTransactionManagementConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        @Configuration</span><br><span class="line">        @EnableTransactionManagement(proxyTargetClass = false)</span><br><span class="line">        @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;false&quot;, matchIfMissing = false)</span><br><span class="line">        //Jdk动态代理的方式实现事务</span><br><span class="line">        public static class JdkDynamicAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Configuration</span><br><span class="line">        @EnableTransactionManagement(proxyTargetClass = true)</span><br><span class="line">        @ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;proxy-target-class&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="line">        //Cglib动态代理方式实现事务</span><br><span class="line">        public static class CglibAutoProxyConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1、-EnableTransactionManagement注解"><a href="#1、-EnableTransactionManagement注解" class="headerlink" title="1、@EnableTransactionManagement注解"></a>1、@EnableTransactionManagement注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(TransactionManagementConfigurationSelector.class)</span><br><span class="line">public @interface EnableTransactionManagement &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2、TransactionManagementConfigurationSelector的selectImports方法"><a href="#2、TransactionManagementConfigurationSelector的selectImports方法" class="headerlink" title="2、TransactionManagementConfigurationSelector的selectImports方法"></a>2、TransactionManagementConfigurationSelector的selectImports方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected String[] selectImports(AdviceMode adviceMode) &#123;</span><br><span class="line">    switch (adviceMode) &#123;</span><br><span class="line">        //动态代理方式实现事务</span><br><span class="line">        case PROXY:</span><br><span class="line">            return new String[] &#123;AutoProxyRegistrar.class.getName(), ProxyTransactionManagementConfiguration.class.getName()&#125;;</span><br><span class="line">        //ASPECTJ方式实现事务</span><br><span class="line">        case ASPECTJ:</span><br><span class="line">            return new String[] &#123;TransactionManagementConfigUtils.TRANSACTION_ASPECT_CONFIGURATION_CLASS_NAME&#125;;</span><br><span class="line">        default:</span><br><span class="line">            return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、AutoProxyRegistrar的registerBeanDefinitions方法"><a href="#3、AutoProxyRegistrar的registerBeanDefinitions方法" class="headerlink" title="3、AutoProxyRegistrar的registerBeanDefinitions方法"></a>3、AutoProxyRegistrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">    boolean candidateFound = false;</span><br><span class="line">    Set&lt;String&gt; annoTypes = importingClassMetadata.getAnnotationTypes();</span><br><span class="line">    for (String annoType : annoTypes) &#123;</span><br><span class="line">        //获取注解信息</span><br><span class="line">        AnnotationAttributes candidate = AnnotationConfigUtils.attributesFor(importingClassMetadata, annoType);</span><br><span class="line">        if (candidate == null) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        Object mode = candidate.get(&quot;mode&quot;);</span><br><span class="line">        Object proxyTargetClass = candidate.get(&quot;proxyTargetClass&quot;);</span><br><span class="line">        if (mode != null &amp;&amp; proxyTargetClass != null &amp;&amp; AdviceMode.class == mode.getClass() &amp;&amp;</span><br><span class="line">                Boolean.class == proxyTargetClass.getClass()) &#123;</span><br><span class="line">            candidateFound = true;</span><br><span class="line">            //AOP代理方式实现事务</span><br><span class="line">            if (mode == AdviceMode.PROXY) &#123;</span><br><span class="line">                //注册InfrastructureAdvisorAutoProxyCreator</span><br><span class="line">                AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry);</span><br><span class="line">                if ((Boolean) proxyTargetClass) &#123;</span><br><span class="line">                    //设置&quot;proxyTargetClass&quot;属性</span><br><span class="line">                    AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!candidateFound) &#123;</span><br><span class="line">        String name = getClass().getSimpleName();</span><br><span class="line">        logger.warn(String.format(&quot;%s was imported but no annotations were found &quot; +</span><br><span class="line">                &quot;having both &apos;mode&apos; and &apos;proxyTargetClass&apos; attributes of type &quot; +</span><br><span class="line">                &quot;AdviceMode and boolean respectively. This means that auto proxy &quot; +</span><br><span class="line">                &quot;creator registration and configuration may not have occurred as &quot; +</span><br><span class="line">                &quot;intended, and components may not be proxied as expected. Check to &quot; +</span><br><span class="line">                &quot;ensure that %s has been @Import&apos;ed on the same class where these &quot; +</span><br><span class="line">                &quot;annotations are declared; otherwise remove the import of %s &quot; +</span><br><span class="line">                &quot;altogether.&quot;, name, name, name));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、-ProxyTransactionManagementConfiguration注解"><a href="#4、-ProxyTransactionManagementConfiguration注解" class="headerlink" title="4、@ProxyTransactionManagementConfiguration注解"></a>4、@ProxyTransactionManagementConfiguration注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ProxyTransactionManagementConfiguration extends AbstractTransactionManagementConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)</span><br><span class="line">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">    //注册通知器</span><br><span class="line">    public BeanFactoryTransactionAttributeSourceAdvisor transactionAdvisor() &#123;</span><br><span class="line">        BeanFactoryTransactionAttributeSourceAdvisor advisor = new BeanFactoryTransactionAttributeSourceAdvisor();</span><br><span class="line">        advisor.setTransactionAttributeSource(transactionAttributeSource());</span><br><span class="line">        advisor.setAdvice(transactionInterceptor());</span><br><span class="line">        if (this.enableTx != null) &#123;</span><br><span class="line">            advisor.setOrder(this.enableTx.&lt;Integer&gt;getNumber(&quot;order&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        return advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">    //注册TransactionAttributeSource</span><br><span class="line">    public TransactionAttributeSource transactionAttributeSource() &#123;</span><br><span class="line">        return new AnnotationTransactionAttributeSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">    //注册TransactionInterceptor事务增强器</span><br><span class="line">    public TransactionInterceptor transactionInterceptor() &#123;</span><br><span class="line">        TransactionInterceptor interceptor = new TransactionInterceptor();</span><br><span class="line">        interceptor.setTransactionAttributeSource(transactionAttributeSource());</span><br><span class="line">        if (this.txManager != null) &#123;</span><br><span class="line">            interceptor.setTransactionManager(this.txManager);</span><br><span class="line">        &#125;</span><br><span class="line">        return interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="八、DataSourceTransactionManagerAutoConfiguration自动配置类"><a href="#八、DataSourceTransactionManagerAutoConfiguration自动配置类" class="headerlink" title="八、DataSourceTransactionManagerAutoConfiguration自动配置类"></a>八、DataSourceTransactionManagerAutoConfiguration自动配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@org.springframework.context.annotation.Configuration</span><br><span class="line">@ConditionalOnClass(&#123; SqlSessionFactory.class, SqlSessionFactoryBean.class &#125;)</span><br><span class="line">@ConditionalOnBean(DataSource.class)</span><br><span class="line">//自动处理属性注解</span><br><span class="line">@EnableConfigurationProperties(MybatisProperties.class)</span><br><span class="line">@AutoConfigureAfter(DataSourceAutoConfiguration.class)</span><br><span class="line">public class MybatisAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    //创建SqlSessionFactory</span><br><span class="line">    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">        SqlSessionFactoryBean factory = new SqlSessionFactoryBean();</span><br><span class="line">        factory.setDataSource(dataSource);</span><br><span class="line">        factory.setVfs(SpringBootVFS.class);</span><br><span class="line">        //设置配置文件地址</span><br><span class="line">        if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">            factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">        &#125;</span><br><span class="line">        Configuration configuration = this.properties.getConfiguration();</span><br><span class="line">        if (configuration == null &amp;&amp; !StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">            //创建configuration</span><br><span class="line">            configuration = new Configuration();</span><br><span class="line">        &#125;</span><br><span class="line">        if (configuration != null &amp;&amp; !CollectionUtils.isEmpty(this.configurationCustomizers)) &#123;</span><br><span class="line">            for (ConfigurationCustomizer customizer : this.configurationCustomizers) &#123;</span><br><span class="line">                customizer.customize(configuration);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置configuration</span><br><span class="line">        factory.setConfiguration(configuration);</span><br><span class="line">        if (this.properties.getConfigurationProperties() != null) &#123;</span><br><span class="line">            factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">        &#125;</span><br><span class="line">        //设置拦截器</span><br><span class="line">        if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">            factory.setPlugins(this.interceptors);</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.databaseIdProvider != null) &#123;</span><br><span class="line">            factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">        &#125;</span><br><span class="line">        //设置注册别名的包</span><br><span class="line">        if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">            factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">        &#125;</span><br><span class="line">        if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">            factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">        &#125;</span><br><span class="line">        //mapper文件地址</span><br><span class="line">        if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">            factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return factory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean</span><br><span class="line">    //创建SqlSessionTemplate</span><br><span class="line">    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">        ExecutorType executorType = this.properties.getExecutorType();</span><br><span class="line">        if (executorType != null) &#123;</span><br><span class="line">            return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * &#123;@link org.mybatis.spring.annotation.MapperScan&#125; ultimately ends up</span><br><span class="line">     * creating instances of &#123;@link MapperFactoryBean&#125;. If</span><br><span class="line">     * &#123;@link org.mybatis.spring.annotation.MapperScan&#125; is used then this</span><br><span class="line">     * auto-configuration is not needed. If it is _not_ used, however, then this</span><br><span class="line">     * will bring in a bean registrar and automatically register components based</span><br><span class="line">     * on the same component-scanning path as Spring Boot itself.</span><br><span class="line">     */</span><br><span class="line">    @org.springframework.context.annotation.Configuration</span><br><span class="line">    //执行AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions</span><br><span class="line">    @Import(&#123; AutoConfiguredMapperScannerRegistrar.class &#125;)</span><br><span class="line">    @ConditionalOnMissingBean(MapperFactoryBean.class)</span><br><span class="line">    public static class MapperScannerRegistrarNotFoundConfiguration &#123;</span><br><span class="line"></span><br><span class="line">        @PostConstruct</span><br><span class="line">        public void afterPropertiesSet() &#123;</span><br><span class="line">            logger.debug(&quot;No &#123;&#125; found.&quot;, MapperFactoryBean.class.getName());</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法"><a href="#1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法" class="headerlink" title="1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法"></a>1、AutoConfiguredMapperScannerRegistrar的registerBeanDefinitions方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line"></span><br><span class="line">    logger.debug(&quot;Searching for mappers annotated with @Mapper&quot;);</span><br><span class="line">    //扫描器</span><br><span class="line">    ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        if (this.resourceLoader != null) &#123;</span><br><span class="line">            scanner.setResourceLoader(this.resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        //从IOC容器中，获取包路径</span><br><span class="line">        List&lt;String&gt; packages = AutoConfigurationPackages.get(this.beanFactory);</span><br><span class="line">        if (logger.isDebugEnabled()) &#123;</span><br><span class="line">            for (String pkg : packages) &#123;</span><br><span class="line">                logger.debug(&quot;Using auto-configuration base package &apos;&#123;&#125;&apos;&quot;, pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //设置扫描的注解</span><br><span class="line">        scanner.setAnnotationClass(Mapper.class);</span><br><span class="line">        //设置过滤器</span><br><span class="line">        scanner.registerFilters();</span><br><span class="line">        //扫描包</span><br><span class="line">        scanner.doScan(StringUtils.toStringArray(packages));</span><br><span class="line">    &#125; catch (IllegalStateException ex) &#123;</span><br><span class="line">        logger.debug(&quot;Could not determine auto-configuration package, automatic mapper scanning disabled.&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/27/spring源码/springboot源码默认注解/" data-id="cjix615fb000gosuebsqi2wtf" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/06/27/spring源码/spring源码AOP/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          spring源码AOP
        
      </div>
    </a>
  
  
    <a href="/2018/06/27/spring源码/springboot源码启动过程/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">springboot源码启动过程</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java-util-concurrent/">java.util.concurrent</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mybatis3/">mybatis3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/zookeeper/">zookeeper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码整合MyBatis/">spring源码整合MyBatis</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(2) /">spring源码XmlBeanFactory(2)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码XmlBeanFactory(1)/">spring源码XmlBeanFactory(1)</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码Transaction/">spring源码Transaction</a>
          </li>
        
          <li>
            <a href="/2018/06/27/spring源码/spring源码SpringMVC/">spring源码SpringMVC</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>